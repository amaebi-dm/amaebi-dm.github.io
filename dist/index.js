let e=class{constructor(e,t,s){this.owner=void 0,this.name=void 0,this.fn=void 0,this.owner=e,this.name=t,this.fn=s}unbind(){this.owner&&(this.owner.unbind(this.name,this.fn),this.owner=null,this.name=null,this.fn=null)}call(){this.fn&&this.fn.call(this.owner,arguments[0],arguments[1],arguments[2],arguments[3],arguments[4],arguments[5],arguments[6],arguments[7])}on(e,t){return this.owner.on(e,t)}};class t{constructor(){this._suspendEvents=!1,this._additionalEmitters=[],Object.defineProperty(this,"_events",{enumerable:!1,configurable:!1,writable:!0,value:{}})}set suspendEvents(e){this._suspendEvents=!!e}get suspendEvents(){return this._suspendEvents}on(t,s){const i=this._events[t];return void 0===i?this._events[t]=[s]:-1===i.indexOf(s)&&i.push(s),new e(this,t,s)}once(e,t){const s=this.on(e,((e,i,n,r,a,o,l,h)=>{t.call(this,e,i,n,r,a,o,l,h),s.unbind()}));return s}emit(e,t,s,i,n,r,a,o,l){if(this._suspendEvents)return this;let h=this._events[e];if(h&&h.length){h=h.slice(0);for(let c=0;c<h.length;c++)if(h[c])try{h[c].call(this,t,s,i,n,r,a,o,l)}catch(t){console.info("%c%s %c(event error)","color: #06f",e,"color: #f00"),console.log(t.stack)}}if(this._additionalEmitters.length){this._additionalEmitters.slice().forEach((h=>{h.emit(e,t,s,i,n,r,a,o,l)}))}return this}unbind(e,t){if(e){const s=this._events[e];if(!s)return this;if(t){const i=s.indexOf(t);-1!==i&&(1===s.length?delete this._events[e]:s.splice(i,1))}else delete this._events[e]}else this._events={};return this}addEmitter(e){this._additionalEmitters.includes(e)||this._additionalEmitters.push(e)}removeEmitter(e){const t=this._additionalEmitters.indexOf(e);-1!==t&&this._additionalEmitters.splice(t,1)}}const s=(e,t)=>{if(!e||!t)return!1;const i=e.length;if(i!==t.length)return!1;for(let n=0;n<i;n++)if(e[n]instanceof Array&&t[n]instanceof Array){if(!s(e[n],t[n]))return!1}else if(e[n]!==t[n])return!1;return!0};class i extends t{constructor(e,t={}){if(super(),this._destroyed=!1,this._path="",this._keys=[],this._data={},this._pathsWithDuplicates=null,t.pathsWithDuplicates){this._pathsWithDuplicates={};for(let e=0;e<t.pathsWithDuplicates.length;e++)this._pathsWithDuplicates[t.pathsWithDuplicates[e]]=!0}this.patch(e),this._parent=t.parent||null,this._parentPath=t.parentPath||"",this._parentField=t.parentField||null,this._parentKey=t.parentKey||null,this._latestFn=t.latestFn||null,this._silent=!1;const s=function(e){return function(t,s,i,n){if(!this._parent)return;let r,a=this._parentKey;!a&&this._parentField instanceof Array&&(a=this._parentField.indexOf(this),-1===a)||(t=this._parentPath+"."+a+"."+t,this._silent&&(r=this._parent.silence()),this._parent.emit(t+":"+e,s,i,n),this._parent.emit("*:"+e,t,s,i,n),this._silent&&this._parent.silenceRestore(r))}};this.on("*:set",s("set")),this.on("*:unset",s("unset")),this.on("*:insert",s("insert")),this.on("*:remove",s("remove")),this.on("*:move",s("move"))}static _splitPath(e){const t=i._splitPathsCache;let s=t[e];return s?s=s.slice():(s=e.split("."),t[e]=s),s}silence(){this._silent=!0;const e=this.history&&this.history.enabled;e&&(this.history.enabled=!1);const t=this.sync&&this.sync.enabled;return t&&(this.sync.enabled=!1),[e,t]}silenceRestore(e){this._silent=!1,e[0]&&(this.history.enabled=!0),e[1]&&(this.sync.enabled=!0)}_prepare(e,t,s,n,r){let a,o;const l=(e._path?e._path+".":"")+t,h=typeof s;if(e._keys.push(t),"object"===h&&s instanceof Array){for(e._data[t]=s.slice(0),a=0;a<e._data[t].length;a++)"object"==typeof e._data[t][a]&&null!==e._data[t][a]?e._data[t][a]instanceof Array?e._data[t][a].slice(0):e._data[t][a]=new i(e._data[t][a],{parent:this,parentPath:l,parentField:e._data[t],parentKey:null}):(o=this.silence(),this.emit(l+"."+a+":set",e._data[t][a],null,r),this.emit("*:set",l+"."+a,e._data[t][a],null,r),this.silenceRestore(o));n&&(o=this.silence()),this.emit(l+":set",e._data[t],null,r),this.emit("*:set",l,e._data[t],null,r),n&&this.silenceRestore(o)}else if("object"===h&&s instanceof Object){for(a in"object"!=typeof e._data[t]&&(e._data[t]={_path:l,_keys:[],_data:{}}),s)"object"==typeof s[a]?this._prepare(e._data[t],a,s[a],!0,r):(o=this.silence(),e._data[t]._data[a]=s[a],e._data[t]._keys.push(a),this.emit(l+"."+a+":set",s[a],null,r),this.emit("*:set",l+"."+a,s[a],null,r),this.silenceRestore(o));n&&(o=this.silence()),this.emit(l+":set",s,void 0,r),this.emit("*:set",l,s,void 0,r),n&&this.silenceRestore(o)}else n&&(o=this.silence()),e._data[t]=s,this.emit(l+":set",s,void 0,r),this.emit("*:set",l,s,void 0,r),n&&this.silenceRestore(o);return!0}set(e,t,n,r,a){let o,l,h=i._splitPath(e);const c=h.length,d=h[c-1];let u,p,f=this,m="",g=this;for(o=0;o<c-1;o++)f instanceof Array?(f=f[h[o]],f instanceof i&&(e=h.slice(o+1).join("."),g=f)):(o<c&&"object"!=typeof f._data[h[o]]&&(f._data[h[o]]&&g.unset((f.__path?f.__path+".":"")+h[o]),f._data[h[o]]={_path:e,_keys:[],_data:{}},f._keys.push(h[o])),o===c-1&&f.__path&&(m=f.__path+"."+h[o]),f=f._data[h[o]]);if(f instanceof Array){const s=parseInt(d,10);return!(f[s]===t&&!a)&&(l=f[s],l=l instanceof i?l.json():g.json(l),f[s]=t,t instanceof i&&(t._parent=g,t._parentPath=m,t._parentField=f,t._parentKey=null),n&&(u=g.silence()),g.emit(e+":set",t,l,r),g.emit("*:set",e,t,l,r),n&&g.silenceRestore(u),!0)}if(f._data&&!f._data.hasOwnProperty(d))return"object"==typeof t?g._prepare(f,d,t,!1,r):(f._data[d]=t,f._keys.push(d),n&&(u=g.silence()),g.emit(e+":set",t,null,r),g.emit("*:set",e,t,null,r),n&&g.silenceRestore(u),!0);if("object"==typeof t&&t instanceof Array){if(s(t,f._data[d])&&!a)return!1;if(l=f._data[d],l instanceof i||(l=g.json(l)),f._data[d]&&f._data[d].length===t.length){for(u=g.silence(),0===t.length&&(f._data[d]=t),o=0;o<f._data[d].length;o++)f._data[d][o]instanceof i?f._data[d][o].patch(t[o],!0):f._data[d][o]!==t[o]&&(f._data[d][o]=t[o],g.emit(e+"."+o+":set",f._data[d][o],l&&l[o]||null,r),g.emit("*:set",e+"."+o,f._data[d][o],l&&l[o]||null,r));g.silenceRestore(u)}else{for(f._data[d]=[],t.forEach((e=>{this._doInsert(f,d,e,void 0,!0)})),u=g.silence(),o=0;o<f._data[d].length;o++)g.emit(e+"."+o+":set",f._data[d][o],l&&l[o]||null,r),g.emit("*:set",e+"."+o,f._data[d][o],l&&l[o]||null,r);g.silenceRestore(u)}return n&&(u=g.silence()),g.emit(e+":set",t,l,r),g.emit("*:set",e,t,l,r),n&&g.silenceRestore(u),!0}if("object"==typeof t&&t instanceof Object){let s,a=!1;l=f._data[d],l instanceof i||(l=g.json(l)),h=Object.keys(t),f._data[d]&&f._data[d]._data||(f._data[d]?g.unset((f.__path?f.__path+".":"")+d):a=!0,f._data[d]={_path:e,_keys:[],_data:{}});for(const i in f._data[d]._data)t.hasOwnProperty(i)?f._data[d]._data.hasOwnProperty(i)?g._equals(f._data[d]._data[i],t[i])||(s=g.set(e+"."+i,t[i],!0),s&&(a=!0)):(s=g._prepare(f._data[d],i,t[i],!0,r),s&&(a=!0)):(s=g.unset(e+"."+i,!0),s&&(a=!0));for(o=0;o<h.length;o++)void 0===t[h[o]]&&f._data[d]._data.hasOwnProperty(h[o])?(s=g.unset(e+"."+h[o],!0),s&&(a=!0)):"object"==typeof t[h[o]]?f._data[d]._data.hasOwnProperty(h[o])?(s=g.set(e+"."+h[o],t[h[o]],!0),s&&(a=!0)):(s=g._prepare(f._data[d],h[o],t[h[o]],!0,r),s&&(a=!0)):g._equals(f._data[d]._data[h[o]],t[h[o]])||("object"==typeof t[h[o]]?(s=g.set(f._data[d]._path+"."+h[o],t[h[o]],!0),s&&(a=!0)):f._data[d]._data[h[o]]!==t[h[o]]&&(a=!0,-1===f._data[d]._keys.indexOf(h[o])&&f._data[d]._keys.push(h[o]),f._data[d]._data[h[o]]=t[h[o]],u=g.silence(),g.emit(f._data[d]._path+"."+h[o]+":set",f._data[d]._data[h[o]],null,r),g.emit("*:set",f._data[d]._path+"."+h[o],f._data[d]._data[h[o]],null,r),g.silenceRestore(u)));if(a){n&&(u=g.silence());const e=g.json(f._data[d]);return g.emit(f._data[d]._path+":set",e,l,r),g.emit("*:set",f._data[d]._path,e,l,r),n&&g.silenceRestore(u),!0}return!1}return p=!f.hasOwnProperty("_data")&&f.hasOwnProperty(d)?f:f._data,!(p[d]===t&&!a)&&(n&&(u=g.silence()),l=p[d],l instanceof i||(l=g.json(l)),p[d]=t,g.emit(e+":set",t,l,r),g.emit("*:set",e,t,l,r),n&&g.silenceRestore(u),!0)}has(e){const t=i._splitPath(e);let s=this;for(let e=0,i=t.length;e<i;e++){if(null==s)return;s=s._data?s._data[t[e]]:s[t[e]]}return void 0!==s}get(e,t){const s=i._splitPath(e);let n=this;for(let e=0;e<s.length;e++){if(null==n)return;n=n._data?n._data[s[e]]:n[s[e]]}return t?n:null==n?null:this.json(n)}getRaw(e){return this.get(e,!0)}_equals(e,t){return e===t||!!(e instanceof Array&&t instanceof Array&&s(e,t))}unset(e,t,s){let n;const r=i._splitPath(e),a=r[r.length-1];let o=this,l=this;for(n=0;n<r.length-1;n++)o instanceof Array?(o=o[r[n]],o instanceof i&&(e=r.slice(n+1).join("."),l=o)):o=o._data[r[n]];if(!o._data||!o._data.hasOwnProperty(a))return!1;let h,c=o._data[a];if(c instanceof i||(c=l.json(c)),o._data[a]&&o._data[a]._data)for(n=o._data[a]._keys.length-1;n>=0;n--)l.unset(e+"."+o._data[a]._keys[n],!0);return o._keys.splice(o._keys.indexOf(a),1),delete o._data[a],t&&(h=l.silence()),l.emit(e+":unset",c,s),l.emit("*:unset",e,c,s),t&&l.silenceRestore(h),!0}remove(e,t,s,n){const r=i._splitPath(e),a=r[r.length-1];let o=this,l=this;for(let t=0;t<r.length-1;t++)if(o instanceof Array)o=o[parseInt(r[t],10)],o instanceof i&&(e=r.slice(t+1).join("."),l=o);else{if(!o._data||!o._data.hasOwnProperty(r[t]))return!1;o=o._data[r[t]]}if(!(o._data&&o._data.hasOwnProperty(a)&&o._data[a]instanceof Array))return!1;const h=o._data[a];if(h.length<t)return!1;let c,d=h[t];return d instanceof i?d._parent=null:d=l.json(d),h.splice(t,1),s&&(c=l.silence()),l.emit(e+":remove",d,t,n),l.emit("*:remove",e,d,t,n),s&&l.silenceRestore(c),!0}removeValue(e,t,s,n){const r=i._splitPath(e),a=r[r.length-1];let o=this,l=this;for(let t=0;t<r.length-1;t++)if(o instanceof Array)o=o[parseInt(r[t],10)],o instanceof i&&(e=r.slice(t+1).join("."),l=o);else{if(!o._data||!o._data.hasOwnProperty(r[t]))return;o=o._data[r[t]]}if(!(o._data&&o._data.hasOwnProperty(a)&&o._data[a]instanceof Array))return;const h=o._data[a],c=h.indexOf(t);if(-1===c)return;if(h.length<c)return;let d;return(t=h[c])instanceof i?t._parent=null:t=l.json(t),h.splice(c,1),s&&(d=l.silence()),l.emit(e+":remove",t,c,n),l.emit("*:remove",e,t,c,n),s&&l.silenceRestore(d),!0}insert(e,t,s,n,r){const a=i._splitPath(e),o=a[a.length-1];let l=this,h=this;for(let t=0;t<a.length-1;t++)if(l instanceof Array)l=l[parseInt(a[t],10)],l instanceof i&&(e=a.slice(t+1).join("."),h=l);else{if(!l._data||!l._data.hasOwnProperty(a[t]))return;l=l._data[a[t]]}if(!(l._data&&l._data.hasOwnProperty(o)&&l._data[o]instanceof Array))return;const c=l._data[o];let d;return t=h._doInsert(l,o,t,s),void 0===s&&(s=c.length-1),n&&(d=h.silence()),h.emit(e+":insert",t,s,r),h.emit("*:insert",e,t,s,r),n&&h.silenceRestore(d),!0}_doInsert(e,t,s,n,r){const a=e._data[t];"object"!=typeof s||s instanceof i||null===s||(s=s instanceof Array?s.slice(0):new i(s));const o=e._path?`${e._path}.${t}`:t;if(null===s||r||this._pathsWithDuplicates&&this._pathsWithDuplicates[o]||-1===a.indexOf(s))return void 0===n?a.push(s):a.splice(n,0,s),s instanceof i?(s._parent=this,s._parentPath=o,s._parentField=a,s._parentKey=null):s=this.json(s),s}move(e,t,s,n,r){const a=i._splitPath(e),o=a[a.length-1];let l=this,h=this;for(let t=0;t<a.length-1;t++)if(l instanceof Array)l=l[parseInt(a[t],10)],l instanceof i&&(e=a.slice(t+1).join("."),h=l);else{if(!l._data||!l._data.hasOwnProperty(a[t]))return;l=l._data[a[t]]}if(!(l._data&&l._data.hasOwnProperty(o)&&l._data[o]instanceof Array))return;const c=l._data[o];if(c.length<t||c.length<s||t===s)return;let d,u=c[t];return c.splice(t,1),-1===s&&(s=c.length),c.splice(s,0,u),u instanceof i||(u=h.json(u)),n&&(d=h.silence()),h.emit(e+":move",u,s,t,r),h.emit("*:move",e,u,s,t,r),n&&h.silenceRestore(d),!0}patch(e,t){if("object"==typeof e){for(const t in e)"object"!=typeof e[t]||this._data.hasOwnProperty(t)?this._data[t]!==e[t]&&this.set(t,e[t]):this._prepare(this,t,e[t]);if(t)for(const t in this._data)e.hasOwnProperty(t)||this.unset(t)}}json(e){let t,s,i={};const n=void 0===e?this:e;let r,a;if(n instanceof Object&&n._keys){r=n._keys.length;for(let e=0;e<r;e++){t=n._keys[e];const r=n._data[t],o=typeof r;if("object"===o&&r instanceof Array)for(i[t]=r.slice(0),a=i[t].length,s=0;s<a;s++)"object"==typeof i[t][s]&&(i[t][s]=this.json(i[t][s]));else i[t]="object"===o&&r instanceof Object?this.json(r):r}}else{if(null===n)return null;if("object"==typeof n&&n instanceof Array)for(i=n.slice(0),r=i.length,s=0;s<r;s++)i[s]=this.json(i[s]);else if("object"==typeof n)for(t in n)n.hasOwnProperty(t)&&(i[t]=n[t]);else i=n}return i}forEach(e,t,s=""){const i=t||this;for(let t=0;t<i._keys.length;t++){const n=i._keys[t],r=i._data[n],a=this.schema&&this.schema.has(s+n)&&this.schema.get(s+n).type.name.toLowerCase()||typeof r;"object"===a&&r instanceof Array?e(s+n,"array",r,n):"object"===a&&r instanceof Object?(e(s+n,"object",r,n),this.forEach(e,r,s+n+".")):e(s+n,a,r,n)}}latest(){return this._latestFn?this._latestFn():this}destroy(){this._destroyed||(this._destroyed=!0,this.emit("destroy"),this.unbind())}set latestFn(e){this._latestFn=e}get latestFn(){return this._latestFn}}function n(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}i._splitPathsCache={};var r,a,o={exports:{}},l={};function h(){if(r)return l;r=1;var e=Symbol.for("react.element"),t=Symbol.for("react.portal"),s=Symbol.for("react.fragment"),i=Symbol.for("react.strict_mode"),n=Symbol.for("react.profiler"),a=Symbol.for("react.provider"),o=Symbol.for("react.context"),h=Symbol.for("react.forward_ref"),c=Symbol.for("react.suspense"),d=Symbol.for("react.memo"),u=Symbol.for("react.lazy"),p=Symbol.iterator;var f={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},m=Object.assign,g={};function _(e,t,s){this.props=e,this.context=t,this.refs=g,this.updater=s||f}function v(){}function b(e,t,s){this.props=e,this.context=t,this.refs=g,this.updater=s||f}_.prototype.isReactComponent={},_.prototype.setState=function(e,t){if("object"!=typeof e&&"function"!=typeof e&&null!=e)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,e,t,"setState")},_.prototype.forceUpdate=function(e){this.updater.enqueueForceUpdate(this,e,"forceUpdate")},v.prototype=_.prototype;var y=b.prototype=new v;y.constructor=b,m(y,_.prototype),y.isPureReactComponent=!0;var x=Array.isArray,w=Object.prototype.hasOwnProperty,S={current:null},C={key:!0,ref:!0,__self:!0,__source:!0};function T(t,s,i){var n,r={},a=null,o=null;if(null!=s)for(n in void 0!==s.ref&&(o=s.ref),void 0!==s.key&&(a=""+s.key),s)w.call(s,n)&&!C.hasOwnProperty(n)&&(r[n]=s[n]);var l=arguments.length-2;if(1===l)r.children=i;else if(1<l){for(var h=Array(l),c=0;c<l;c++)h[c]=arguments[c+2];r.children=h}if(t&&t.defaultProps)for(n in l=t.defaultProps)void 0===r[n]&&(r[n]=l[n]);return{$$typeof:e,type:t,key:a,ref:o,props:r,_owner:S.current}}function E(t){return"object"==typeof t&&null!==t&&t.$$typeof===e}var P=/\/+/g;function k(e,t){return"object"==typeof e&&null!==e&&null!=e.key?function(e){var t={"=":"=0",":":"=2"};return"$"+e.replace(/[=:]/g,(function(e){return t[e]}))}(""+e.key):t.toString(36)}function A(s,i,n,r,a){var o=typeof s;"undefined"!==o&&"boolean"!==o||(s=null);var l=!1;if(null===s)l=!0;else switch(o){case"string":case"number":l=!0;break;case"object":switch(s.$$typeof){case e:case t:l=!0}}if(l)return a=a(l=s),s=""===r?"."+k(l,0):r,x(a)?(n="",null!=s&&(n=s.replace(P,"$&/")+"/"),A(a,i,n,"",(function(e){return e}))):null!=a&&(E(a)&&(a=function(t,s){return{$$typeof:e,type:t.type,key:s,ref:t.ref,props:t.props,_owner:t._owner}}(a,n+(!a.key||l&&l.key===a.key?"":(""+a.key).replace(P,"$&/")+"/")+s)),i.push(a)),1;if(l=0,r=""===r?".":r+":",x(s))for(var h=0;h<s.length;h++){var c=r+k(o=s[h],h);l+=A(o,i,n,c,a)}else if(c=function(e){return null===e||"object"!=typeof e?null:"function"==typeof(e=p&&e[p]||e["@@iterator"])?e:null}(s),"function"==typeof c)for(s=c.call(s),h=0;!(o=s.next()).done;)l+=A(o=o.value,i,n,c=r+k(o,h++),a);else if("object"===o)throw i=String(s),Error("Objects are not valid as a React child (found: "+("[object Object]"===i?"object with keys {"+Object.keys(s).join(", ")+"}":i)+"). If you meant to render a collection of children, use an array instead.");return l}function M(e,t,s){if(null==e)return e;var i=[],n=0;return A(e,i,"","",(function(e){return t.call(s,e,n++)})),i}function D(e){if(-1===e._status){var t=e._result;(t=t()).then((function(t){0!==e._status&&-1!==e._status||(e._status=1,e._result=t)}),(function(t){0!==e._status&&-1!==e._status||(e._status=2,e._result=t)})),-1===e._status&&(e._status=0,e._result=t)}if(1===e._status)return e._result.default;throw e._result}var R={current:null},L={transition:null},I={ReactCurrentDispatcher:R,ReactCurrentBatchConfig:L,ReactCurrentOwner:S};function F(){throw Error("act(...) is not supported in production builds of React.")}return l.Children={map:M,forEach:function(e,t,s){M(e,(function(){t.apply(this,arguments)}),s)},count:function(e){var t=0;return M(e,(function(){t++})),t},toArray:function(e){return M(e,(function(e){return e}))||[]},only:function(e){if(!E(e))throw Error("React.Children.only expected to receive a single React element child.");return e}},l.Component=_,l.Fragment=s,l.Profiler=n,l.PureComponent=b,l.StrictMode=i,l.Suspense=c,l.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=I,l.act=F,l.cloneElement=function(t,s,i){if(null==t)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+t+".");var n=m({},t.props),r=t.key,a=t.ref,o=t._owner;if(null!=s){if(void 0!==s.ref&&(a=s.ref,o=S.current),void 0!==s.key&&(r=""+s.key),t.type&&t.type.defaultProps)var l=t.type.defaultProps;for(h in s)w.call(s,h)&&!C.hasOwnProperty(h)&&(n[h]=void 0===s[h]&&void 0!==l?l[h]:s[h])}var h=arguments.length-2;if(1===h)n.children=i;else if(1<h){l=Array(h);for(var c=0;c<h;c++)l[c]=arguments[c+2];n.children=l}return{$$typeof:e,type:t.type,key:r,ref:a,props:n,_owner:o}},l.createContext=function(e){return(e={$$typeof:o,_currentValue:e,_currentValue2:e,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null}).Provider={$$typeof:a,_context:e},e.Consumer=e},l.createElement=T,l.createFactory=function(e){var t=T.bind(null,e);return t.type=e,t},l.createRef=function(){return{current:null}},l.forwardRef=function(e){return{$$typeof:h,render:e}},l.isValidElement=E,l.lazy=function(e){return{$$typeof:u,_payload:{_status:-1,_result:e},_init:D}},l.memo=function(e,t){return{$$typeof:d,type:e,compare:void 0===t?null:t}},l.startTransition=function(e){var t=L.transition;L.transition={};try{e()}finally{L.transition=t}},l.unstable_act=F,l.useCallback=function(e,t){return R.current.useCallback(e,t)},l.useContext=function(e){return R.current.useContext(e)},l.useDebugValue=function(){},l.useDeferredValue=function(e){return R.current.useDeferredValue(e)},l.useEffect=function(e,t){return R.current.useEffect(e,t)},l.useId=function(){return R.current.useId()},l.useImperativeHandle=function(e,t,s){return R.current.useImperativeHandle(e,t,s)},l.useInsertionEffect=function(e,t){return R.current.useInsertionEffect(e,t)},l.useLayoutEffect=function(e,t){return R.current.useLayoutEffect(e,t)},l.useMemo=function(e,t){return R.current.useMemo(e,t)},l.useReducer=function(e,t,s){return R.current.useReducer(e,t,s)},l.useRef=function(e){return R.current.useRef(e)},l.useState=function(e){return R.current.useState(e)},l.useSyncExternalStore=function(e,t,s){return R.current.useSyncExternalStore(e,t,s)},l.useTransition=function(){return R.current.useTransition()},l.version="18.3.1",l}function c(){return a||(a=1,o.exports=h()),o.exports}var d=c(),u=n(d);const p="pcui-collapsed",f="pcui-collapsible",m="pcui-disabled",g="pcui-error",_="flash",v="pcui-flex",b="pcui-focus",y="font-regular",x="font-bold",w="pcui-grid",S="pcui-hidden",C="pcui-multiple-values",T="pcui-not-flexible",E="pcui-readonly",P="pcui-resizable",k="pcui-scrollable",A=["flexDirection","flexGrow","flexBasis","flexShrink","flexWrap","alignItems","alignSelf","justifyContent","justifySelf"];let M=class e extends t{constructor(e={}){var t,s,i,n;if(super(),this._destroyed=!1,this._parent=null,this._eventsParent=[],this._flashTimeout=null,this._suppressChange=!1,this._onMouseOver=e=>{this.emit("hover",e)},this._onMouseOut=e=>{this.emit("hoverend",e)},"string"==typeof e.dom?this._dom=document.createElement(e.dom):e.dom instanceof Node?this._dom=e.dom:this._dom=document.createElement("div"),void 0!==e.id&&(this._dom.id=e.id),this._dom.ui=this,this._onClickEvt=this._onClick.bind(this),this._dom.addEventListener("click",this._onClickEvt),this._dom.addEventListener("mouseover",this._onMouseOver),this._dom.addEventListener("mouseout",this._onMouseOut),this._dom.classList.add("pcui-element",y),e.class){const t=Array.isArray(e.class)?e.class:[e.class];for(const e of t)this._dom.classList.add(e)}this.enabled=null===(t=e.enabled)||void 0===t||t,this._hiddenParents=!e.isRoot,this.hidden=null!==(s=e.hidden)&&void 0!==s&&s,this.readOnly=null!==(i=e.readOnly)&&void 0!==i&&i,this.ignoreParent=null!==(n=e.ignoreParent)&&void 0!==n&&n,void 0!==e.width&&(this.width=e.width),void 0!==e.height&&(this.height=e.height),void 0!==e.tabIndex&&(this.tabIndex=e.tabIndex);for(const t in e)void 0!==e[t]&&-1!==A.indexOf(t)&&(this[t]=e[t]);e.binding&&(this.binding=e.binding)}destroy(){if(this._destroyed)return;if(this._destroyed=!0,this.binding?this.binding=null:this.unlink(),this.parent){const e=this.parent;for(const e of this._eventsParent)e.unbind();this._eventsParent.length=0,e.remove&&!e._destroyed&&e.remove(this),this._parent=null,!e._destroyed&&this._dom&&this._dom.parentElement&&this._dom.parentElement.removeChild(this._dom)}const e=this._dom;e&&(e.removeEventListener("click",this._onClickEvt),e.removeEventListener("mouseover",this._onMouseOver),e.removeEventListener("mouseout",this._onMouseOut),delete e.ui,this._dom=null),this._flashTimeout&&window.clearTimeout(this._flashTimeout),this.emit("destroy",e,this),this.unbind()}link(e,t){this._binding&&this._binding.link(e,t)}unlink(){this._binding&&this._binding.unlink()}flash(){this._flashTimeout||(this.class.add(_),this._flashTimeout=window.setTimeout((()=>{this._flashTimeout=null,this.class.remove(_)}),200))}_onClick(e){this.enabled&&this.emit("click",e)}_onHiddenToRootChange(e){this.emit(e?"hideToRoot":"showToRoot")}_onEnabledChange(e){e?this.class.remove(m):this.class.add(m),this.emit(e?"enable":"disable")}_onParentDestroy(){this.destroy()}_onParentDisable(){this._ignoreParent||this._enabled&&this._onEnabledChange(!1)}_onParentEnable(){this._ignoreParent||this._enabled&&this._onEnabledChange(!0)}_onParentShowToRoot(){const e=this.hiddenToRoot;this._hiddenParents=!1,e!==this.hiddenToRoot&&this._onHiddenToRootChange(this.hiddenToRoot)}_onParentHideToRoot(){const e=this.hiddenToRoot;this._hiddenParents=!0,e!==this.hiddenToRoot&&this._onHiddenToRootChange(this.hiddenToRoot)}_onReadOnlyChange(e){e?this.class.add(E):this.class.remove(E),this.emit("readOnly",e)}_onParentReadOnlyChange(e){this._ignoreParent||(e?this._readOnly||this._onReadOnlyChange(!0):this._readOnly||this._onReadOnlyChange(!1))}unbind(e,t){return super.unbind(e,t)}static register(t,s,i){e.registry.set(t,{cls:s,defaultArguments:i})}static unregister(t){e.registry.delete(t)}static create(t,s){const i=e.registry.get(t);if(!i)return void console.error("Invalid type passed to Element.create:",t);return new(0,i.cls)(Object.assign(Object.assign({},i.defaultArguments),s))}set enabled(e){if(this._enabled===e)return;const t=this.enabled;this._enabled=e,t!==e&&this._onEnabledChange(e)}get enabled(){return this._ignoreParent?this._enabled:this._enabled&&(!this._parent||this._parent.enabled)}set ignoreParent(e){this._ignoreParent=e,this._onEnabledChange(this.enabled),this._onReadOnlyChange(this.readOnly)}get ignoreParent(){return this._ignoreParent}get dom(){return this._dom}set parent(e){if(e===this._parent)return;const t=this.enabled,s=this.readOnly,i=this.hiddenToRoot;if(this._parent){for(let e=0;e<this._eventsParent.length;e++)this._eventsParent[e].unbind();this._eventsParent.length=0}this._parent=e,this._parent?(this._eventsParent.push(this._parent.once("destroy",this._onParentDestroy.bind(this))),this._eventsParent.push(this._parent.on("disable",this._onParentDisable.bind(this))),this._eventsParent.push(this._parent.on("enable",this._onParentEnable.bind(this))),this._eventsParent.push(this._parent.on("readOnly",this._onParentReadOnlyChange.bind(this))),this._eventsParent.push(this._parent.on("showToRoot",this._onParentShowToRoot.bind(this))),this._eventsParent.push(this._parent.on("hideToRoot",this._onParentHideToRoot.bind(this))),this._hiddenParents=this._parent.hiddenToRoot):this._hiddenParents=!0,this.emit("parent",this._parent);const n=this.enabled;n!==t&&this._onEnabledChange(n);const r=this.readOnly;r!==s&&this._onReadOnlyChange(r);const a=this.hiddenToRoot;a!==i&&this._onHiddenToRootChange(a)}get parent(){return this._parent}set hidden(e){if(e===this._hidden)return;const t=this.hiddenToRoot;this._hidden=e,e?this.class.add(S):this.class.remove(S),this.emit(e?"hide":"show"),this.hiddenToRoot!==t&&this._onHiddenToRootChange(this.hiddenToRoot)}get hidden(){return this._hidden}get hiddenToRoot(){return this._hidden||this._hiddenParents}set readOnly(e){this._readOnly!==e&&(this._readOnly=e,this._onReadOnlyChange(e))}get readOnly(){return this._ignoreParent?this._readOnly:this._readOnly||!(!this._parent||!this._parent.readOnly)}set error(e){this._hasError!==e&&(this._hasError=e,e?this.class.add(g):this.class.remove(g))}get error(){return this._hasError}get style(){return this._dom.style}get class(){return this._dom.classList}set width(e){this.style.width="number"==typeof e?`${e}px`:e}get width(){return this._dom.clientWidth}set height(e){this.style.height="number"==typeof e?`${e}px`:e}get height(){return this._dom.clientHeight}set tabIndex(e){this._dom.tabIndex=e}get tabIndex(){return this._dom.tabIndex}set binding(e){if(this._binding===e)return;let t,s;this._binding&&(t=this._binding.observers,s=this._binding.paths,this.unlink(),this._binding.element=null,this._binding=null),this._binding=e,this._binding&&(this._binding.element=this,t&&s&&this.link(t,s))}get binding(){return this._binding}get destroyed(){return this._destroyed}set flexDirection(e){this.style.flexDirection=e}get flexDirection(){return this.style.flexDirection}set flexGrow(e){this.style.flexGrow=e}get flexGrow(){return this.style.flexGrow}set flexBasis(e){this.style.flexBasis=e}get flexBasis(){return this.style.flexBasis}set flexShrink(e){this.style.flexShrink=e}get flexShrink(){return this.style.flexShrink}set flexWrap(e){this.style.flexWrap=e}get flexWrap(){return this.style.flexWrap}set alignItems(e){this.style.alignItems=e}get alignItems(){return this.style.alignItems}set alignSelf(e){this.style.alignSelf=e}get alignSelf(){return this.style.alignSelf}set justifyContent(e){this.style.justifyContent=e}get justifyContent(){return this.style.justifyContent}set justifySelf(e){this.style.justifySelf=e}get justifySelf(){return this.style.justifySelf}set disabled(e){this.enabled=!e}get disabled(){return!this.enabled}set element(e){this._dom=e}get element(){return this.dom}set innerElement(e){this._domContent=e}get innerElement(){return this._domContent}};M.EVENT_ENABLE="enable",M.EVENT_DISABLE="disable",M.EVENT_HIDE="hide",M.EVENT_HIDE_TO_ROOT="hideToRoot",M.EVENT_SHOW="show",M.EVENT_SHOW_TO_ROOT="showToRoot",M.EVENT_READ_ONLY="readOnly",M.EVENT_PARENT="parent",M.EVENT_CLICK="click",M.EVENT_HOVER="hover",M.EVENT_HOVER_END="hoverend",M.EVENT_DESTROY="destroy",M.registry=new Map;class D extends d.Component{constructor(e){super(e),this.attachElement=(e,t)=>{if(!e)return;this.element=new this.elementClass(Object.assign(Object.assign({},this.props),{dom:e,content:t,parent:void 0}));const s=this.props.class;this.class=new Set(s?Array.isArray(s)?s.slice():[s]:void 0),this.onClick&&this.element.on("click",this.onClick),this.onRemove&&this.element.on("click:remove",this.onRemove),this.onChange&&this.element.on("change",this.onChange),this.props.parent&&(this.element.parent=this.props.parent),this.onAttach&&this.onAttach()},this.getPropertyDescriptor=(e,t)=>{let s;do{s=Object.getOwnPropertyDescriptor(e,t)}while(!s&&(e=Object.getPrototypeOf(e)));return s},this.elementClass=M,e.onClick&&(this.onClick=e.onClick),e.onRemove&&(this.onRemove=e.onRemove),e.onChange&&(this.onChange=e.onChange),e.link&&(this.link=e.link)}componentDidMount(){this.link&&this.element.link(this.link.observer,this.link.path)}componentDidUpdate(e){Object.keys(this.props).forEach((e=>{const t=this.getPropertyDescriptor(this.element,e);if(t&&t.set)"value"===e?(this.element._suppressChange=!0,this.element[e]=this.props[e],this.element._suppressChange=!1):this.element[e]=this.props[e];else if("class"===e){const t=this.props[e],s=new Set(t?Array.isArray(t)?t.slice():[t]:void 0);s.forEach((e=>{this.class.has(e)||(this.element.class.add(e),this.class.add(e))})),this.class.forEach((e=>{s.has(e)||(this.element.class.remove(e),this.class.delete(e))}))}})),e.link!==this.props.link&&this.props.link&&this.element.link(this.props.link.observer,this.props.link.path)}render(){return d.createElement("div",{ref:this.attachElement})}}let R=class extends M{constructor(e={}){super(Object.assign({dom:"button"},e)),this._onKeyDown=e=>{"Escape"===e.key?this.blur():"Enter"===e.key&&this._onClick(e)},this.class.add("pcui-button"),this._unsafe=e.unsafe,this.text=e.text,this.size=e.size,this.icon=e.icon,this.dom.addEventListener("keydown",this._onKeyDown)}destroy(){this._destroyed||(this.dom.removeEventListener("keydown",this._onKeyDown),super.destroy())}_onClick(e){this.blur(),this.readOnly||super._onClick(e)}focus(){this.dom.focus()}blur(){this.dom.blur()}set text(e){this._text!==e&&(this._text=e,this._unsafe?this.dom.innerHTML=e:this.dom.textContent=e)}get text(){return this._text}set icon(e){this._icon!==e&&e.match(/^E\d{0,4}$/)&&(this._icon=e,e?this.dom.setAttribute("data-icon",String.fromCodePoint(parseInt(e,16))):this.dom.removeAttribute("data-icon"))}get icon(){return this._icon}set size(e){this._size!==e&&(this._size&&(this.class.remove(`pcui-${this._size}`),this._size=null),this._size=e,this._size&&this.class.add(`pcui-${this._size}`))}get size(){return this._size}};M.register("button",R);const L=[null,"top","right","bottom","left"],I=`${P}-resizing`,F="pcui-container",O=`${F}-dragged`,B=`${O}-child`;let z=class extends M{constructor(e={}){var t;super(e),this._scrollable=!1,this._flex=!1,this._grid=!1,this._domResizeHandle=null,this._resizePointerId=null,this._resizeData=null,this._resizeHorizontally=!0,this._resizeMin=100,this._resizeMax=300,this._draggedStartIndex=-1,this._onScroll=e=>{this.emit("scroll",e)},this._onResizeStart=e=>{null===this._resizePointerId&&(e.preventDefault(),e.stopPropagation(),this._domResizeHandle.setPointerCapture(e.pointerId),this._resizePointerId=e.pointerId,this._resizeStart())},this._onResizeMove=e=>{this._resizePointerId===e.pointerId&&(e.preventDefault(),e.stopPropagation(),this._resizeMove(e.clientX,e.clientY))},this._onResizeEnd=e=>{this._resizePointerId===e.pointerId&&(e.preventDefault(),e.stopPropagation(),this._resizeEnd(),this._domResizeHandle.releasePointerCapture(e.pointerId),this._resizePointerId=null)},this.class.add(F),this.domContent=this._dom,e.scrollable&&(this.scrollable=!0),this.flex=!!e.flex;let s=!!e.grid;s&&this.flex&&(console.error('Invalid Container arguments: "grid" and "flex" cannot both be true.'),s=!1),this.grid=s,this.resizable=null!==(t=e.resizable)&&void 0!==t?t:null,void 0!==e.resizeMin&&(this.resizeMin=e.resizeMin),void 0!==e.resizeMax&&(this.resizeMax=e.resizeMax)}destroy(){this._destroyed||(this.domContent=null,this._domResizeHandle&&(this._domResizeHandle.removeEventListener("pointerdown",this._onResizeStart),this._domResizeHandle.removeEventListener("pointermove",this._onResizeMove),this._domResizeHandle.removeEventListener("pointerup",this._onResizeEnd)),super.destroy())}append(e){const t=this._getDomFromElement(e);this._domContent.appendChild(t),this._onAppendChild(e)}appendBefore(e,t){const s=this._getDomFromElement(e);this._domContent.appendChild(s);const i=t&&this._getDomFromElement(t);this._domContent.insertBefore(s,i),this._onAppendChild(e)}appendAfter(e,t){const s=this._getDomFromElement(e),i=t&&this._getDomFromElement(t),n=i?i.nextSibling:null;n?this._domContent.insertBefore(s,n):this._domContent.appendChild(s),this._onAppendChild(e)}prepend(e){const t=this._getDomFromElement(e),s=this._domContent.firstChild;s?this._domContent.insertBefore(t,s):this._domContent.appendChild(t),this._onAppendChild(e)}remove(e){if(e.parent!==this)return;const t=this._getDomFromElement(e);this._domContent.removeChild(t),this._onRemoveChild(e)}move(e,t){const s=Array.prototype.indexOf.call(this.dom.childNodes,e.dom);-1===s?this.appendBefore(e,this.dom.childNodes[t]):t!==s&&(this.remove(e),t<s?this.appendBefore(e,this.dom.childNodes[t]):this.appendAfter(e,this.dom.childNodes[t-1]))}clear(){let e=this._domContent.childNodes.length;for(;e--;){const t=this._domContent.childNodes[e];t.ui&&t.ui!==this&&t.ui.destroy()}this._domResizeHandle&&(this._domResizeHandle.removeEventListener("pointerdown",this._onResizeStart),this._domResizeHandle.removeEventListener("pointermove",this._onResizeMove),this._domResizeHandle.removeEventListener("pointerup",this._onResizeEnd),this._domResizeHandle=null),this._domContent.innerHTML="",this.resizable&&(this._createResizeHandle(),this._dom.appendChild(this._domResizeHandle))}_getDomFromElement(e){return e.dom?e.dom:e.element?e.element:e}_onAppendChild(e){e.parent=this,this.emit("append",e)}_onRemoveChild(e){e.parent=null,this.emit("remove",e)}_createResizeHandle(){const e=document.createElement("div");e.classList.add("pcui-resizable-handle"),e.ui=this,e.addEventListener("pointerdown",this._onResizeStart),e.addEventListener("pointermove",this._onResizeMove),e.addEventListener("pointerup",this._onResizeEnd),this._domResizeHandle=e}_resizeStart(){this.class.add(I)}_resizeMove(e,t){if(this._resizeData){if(this._resizeHorizontally){let t=this._resizeData.x-e;"right"===this._resizable&&(t=-t),this.width=4+Math.max(this._resizeMin,Math.min(this._resizeMax,this._resizeData.width+t))}else{let e=this._resizeData.y-t;"bottom"===this._resizable&&(e=-e),this.height=Math.max(this._resizeMin,Math.min(this._resizeMax,this._resizeData.height+e))}this.emit("resize")}else this._resizeData={x:e,y:t,width:this.dom.clientWidth,height:this.dom.clientHeight}}_resizeEnd(){this._resizeData=null,this.class.remove(I)}resize(e=0,t=0){this._resizeStart(),this._resizeMove(0,0),this._resizeMove(4-e,-t),this._resizeEnd()}_getDraggedChildIndex(e){for(let t=0;t<this.dom.childNodes.length;t++)if(this.dom.childNodes[t].ui===e)return t;return-1}_onChildDragStart(e,t){this.class.add(B),this._draggedStartIndex=this._getDraggedChildIndex(t),t.class.add(O),this.emit("child:dragstart",t,this._draggedStartIndex)}_onChildDragMove(e,t){const s=this.dom.getBoundingClientRect(),i=e.clientX<s.left||e.clientX>s.right||e.clientY<s.top||e.clientY>s.bottom,n=this._getDraggedChildIndex(t);if(i)return t.class.remove(O),void(this._draggedStartIndex!==n&&(this.remove(t),this._draggedStartIndex<n?this.appendBefore(t,this.dom.childNodes[this._draggedStartIndex]):this.appendAfter(t,this.dom.childNodes[this._draggedStartIndex-1])));t.class.add(O);const r=e.clientY-s.top;let a=null;for(let e=0;e<this.dom.childNodes.length;e++){const s=this.dom.childNodes[e].ui,i=s.dom.offsetTop;if(e<n){if(r<=i+s.header.height){a=e;break}}else if(e>n&&r+t.height>=i+s.height){a=e;break}}null!==a&&n!==a&&(this.remove(t),a<n?this.appendBefore(t,this.dom.childNodes[a]):this.appendAfter(t,this.dom.childNodes[a-1]))}_onChildDragEnd(e,t){this.class.remove(B),t.class.remove(O);const s=this._getDraggedChildIndex(t);this.emit("child:dragend",t,s,this._draggedStartIndex),this._draggedStartIndex=-1}forEachChild(e){for(let t=0;t<this.dom.childNodes.length;t++){const s=this.dom.childNodes[t].ui;if(s){if(!1===e(s,t))break}}}_buildDomNode(e){const t=Object.keys(e);let s;return t.includes("root")?(s=this._buildDomNode(e.root),e.children.forEach((e=>{const t=this._buildDomNode(e);null!==t&&s.append(t)}))):(s=e[t[0]],this[`_${t[0]}`]=s),s}buildDom(e){e.forEach((e=>{const t=this._buildDomNode(e);this.append(t)}))}set flex(e){e!==this._flex&&(this._flex=e,e?this.class.add(v):this.class.remove(v))}get flex(){return this._flex}set grid(e){e!==this._grid&&(this._grid=e,e?this.class.add(w):this.class.remove(w))}get grid(){return this._grid}set scrollable(e){this._scrollable!==e&&(this._scrollable=e,e?this.class.add(k):this.class.remove(k))}get scrollable(){return this._scrollable}set resizable(e){e!==this._resizable&&(-1!==L.indexOf(e)?(this._resizable&&this.class.remove(`${P}-${this._resizable}`),this._resizable=e,this._resizeHorizontally="right"===e||"left"===e,e?(this.class.add(P),this.class.add(`${P}-${e}`),this._domResizeHandle||this._createResizeHandle(),this._dom.appendChild(this._domResizeHandle)):(this.class.remove(P),this._domResizeHandle&&this._dom.removeChild(this._domResizeHandle))):console.error(`Invalid resizable value: must be one of ${L.join(",")}`))}get resizable(){return this._resizable}set resizeMin(e){this._resizeMin=Math.max(0,Math.min(e,this._resizeMax))}get resizeMin(){return this._resizeMin}set resizeMax(e){this._resizeMax=Math.max(this._resizeMin,e)}get resizeMax(){return this._resizeMax}set domContent(e){this._domContent!==e&&(this._domContent&&this._domContent.removeEventListener("scroll",this._onScroll),this._domContent=e,this._domContent&&this._domContent.addEventListener("scroll",this._onScroll))}get domContent(){return this._domContent}};z.EVENT_APPEND="append",z.EVENT_REMOVE="remove",z.EVENT_SCROLL="scroll",z.EVENT_RESIZE="resize",M.register("container",z);class N extends M{constructor(e={}){var t,s,i,n,r;super(e),this.blurOnEnter=!0,this.blurOnEscape=!0,this._onInputFocus=e=>{this.class.add(b),this.emit("focus",e),this._prevValue=this._domInput.value},this._onInputBlur=e=>{this.class.remove(b),this.emit("blur",e)},this._onInputKeyUp=e=>{"Escape"!==e.key&&this._onInputChange(e),this.emit("keyup",e)},this._onInputCtxMenu=e=>{this._domInput.select()},this._updateInputReadOnly=()=>{!this.enabled||this.readOnly?this._domInput.setAttribute("readonly","true"):this._domInput.removeAttribute("readonly")},this.class.add("pcui-input-element");let a=e.input;a||(a=document.createElement("input"),a.type="text"),a.ui=this,a.tabIndex=0,a.autocomplete="off",this._onInputKeyDownEvt=this._onInputKeyDown.bind(this),this._onInputChangeEvt=this._onInputChange.bind(this),a.addEventListener("change",this._onInputChangeEvt),a.addEventListener("keydown",this._onInputKeyDownEvt),a.addEventListener("focus",this._onInputFocus),a.addEventListener("blur",this._onInputBlur),a.addEventListener("contextmenu",this._onInputCtxMenu,!1),this.dom.appendChild(a),this._domInput=a,this._suspendInputChangeEvt=!1,void 0!==e.value&&(this._domInput.value=e.value),this.placeholder=null!==(t=e.placeholder)&&void 0!==t?t:"",this.renderChanges=null!==(s=e.renderChanges)&&void 0!==s&&s,this.blurOnEnter=null===(i=e.blurOnEnter)||void 0===i||i,this.blurOnEscape=null===(n=e.blurOnEscape)||void 0===n||n,this.keyChange=null!==(r=e.keyChange)&&void 0!==r&&r,this._prevValue=null,this.on("change",(()=>{this.renderChanges&&this.flash()})),this.on("disable",this._updateInputReadOnly),this.on("enable",this._updateInputReadOnly),this.on("readOnly",this._updateInputReadOnly),this._updateInputReadOnly()}destroy(){if(this._destroyed)return;const e=this._domInput;e.removeEventListener("change",this._onInputChangeEvt),e.removeEventListener("keydown",this._onInputKeyDownEvt),e.removeEventListener("focus",this._onInputFocus),e.removeEventListener("blur",this._onInputBlur),e.removeEventListener("keyup",this._onInputKeyUp),e.removeEventListener("contextmenu",this._onInputCtxMenu),super.destroy()}_onInputKeyDown(e){if("Enter"===e.key&&this.blurOnEnter)this._suspendInputChangeEvt=this.keyChange,this._domInput.blur(),this._suspendInputChangeEvt=!1;else if("Escape"===e.key){this._suspendInputChangeEvt=!0;const t=this._domInput.value;this._domInput.value=this._prevValue,this._suspendInputChangeEvt=!1,this.keyChange&&t!==this._prevValue&&this._onInputChange(e),this.blurOnEscape&&this._domInput.blur()}this.emit("keydown",e)}_onInputChange(e){}focus(e){this._domInput.focus(),e&&this._domInput.select()}blur(){this._domInput.blur()}set placeholder(e){e?this.dom.setAttribute("placeholder",e):this.dom.removeAttribute("placeholder")}get placeholder(){var e;return null!==(e=this.dom.getAttribute("placeholder"))&&void 0!==e?e:""}set keyChange(e){this._keyChange!==e&&(this._keyChange=e,e?this._domInput.addEventListener("keyup",this._onInputKeyUp):this._domInput.removeEventListener("keyup",this._onInputKeyUp))}get keyChange(){return this._keyChange}get input(){return this._domInput}set renderChanges(e){this._renderChanges=e}get renderChanges(){return this._renderChanges}}const U="pcui-numeric-input",V=`${U}-slider-control`,G=`${V}-active`,H=`${V}-hidden`,j=/,/g;let W=class extends N{constructor(e={}){var t,s,i,n;const r=Object.assign({},e);delete r.value,delete r.renderChanges,super(r),this._sliderUsed=!1,this._onSliderMouseWheel=e=>{this._updatePosition(e.deltaY,e.shiftKey)},this._onSliderMouseMove=e=>{this._updatePosition(e.movementX,e.shiftKey)},this._onSliderMouseDown=e=>{this._sliderControl.dom.requestPointerLock(),this._sliderMovement=0,this._sliderPrevValue=this.value,this._sliderUsed=!0,this.binding&&(this._historyCombine=this.binding.historyCombine,this._historyPostfix=this.binding.historyPostfix,this.binding.historyCombine=!0,this.binding.historyPostfix=`(${Date.now()})`),this.emit("slider:mousedown",e)},this._onSliderMouseUp=()=>{document.exitPointerLock(),this._sliderUsed&&(this._sliderUsed=!1,this.value=this._sliderPrevValue+this._sliderMovement,this.binding&&(this.binding.historyCombine=this._historyCombine,this.binding.historyPostfix=this._historyPostfix,this._historyCombine=!1,this._historyPostfix=null),this.focus(),this.emit("slider:mouseup"))},this._onPointerLockChange=()=>{this._isScrolling()?(this._sliderControl.dom.addEventListener("mousemove",this._onSliderMouseMove,!1),this._sliderControl.dom.addEventListener("wheel",this._onSliderMouseWheel,{passive:!0}),this._sliderControl.class.add(G)):(this._sliderControl.dom.removeEventListener("mousemove",this._onSliderMouseMove,!1),this._sliderControl.dom.removeEventListener("wheel",this._onSliderMouseWheel),this._sliderControl.class.remove(G))},this.class.add(U),this._min=null!==(t=e.min)&&void 0!==t?t:null,this._max=null!==(s=e.max)&&void 0!==s?s:null,this._allowNull=null!==(i=e.allowNull)&&void 0!==i&&i,this._precision=null!==(n=e.precision)&&void 0!==n?n:7,Number.isFinite(e.step)?this._step=e.step:e.precision?this._step=10/Math.pow(10,e.precision):this._step=1,Number.isFinite(e.stepPrecision)?this._stepPrecision=e.stepPrecision:this._stepPrecision=.1*this._step,this._oldValue=void 0,Number.isFinite(e.value)?this.value=e.value:this._allowNull||(this.value=0),this._historyCombine=!1,this._historyPostfix=null,this._sliderPrevValue=0,this.renderChanges=e.renderChanges,e.hideSlider||(this._sliderControl=new M,this._sliderControl.class.add(V),this.dom.append(this._sliderControl.dom),this._sliderControl.dom.addEventListener("mousedown",this._onSliderMouseDown),this._sliderControl.dom.addEventListener("mouseup",this._onSliderMouseUp),document.addEventListener("pointerlockchange",this._onPointerLockChange,!1))}destroy(){this.destroyed||(this._sliderControl&&(this._sliderControl.dom.removeEventListener("mousedown",this._onSliderMouseDown),this._sliderControl.dom.removeEventListener("mouseup",this._onSliderMouseUp),this._sliderControl.dom.removeEventListener("mousemove",this._onSliderMouseMove,!1),this._sliderControl.dom.removeEventListener("wheel",this._onSliderMouseWheel),document.removeEventListener("pointerlockchange",this._onPointerLockChange,!1)),super.destroy())}_updatePosition(e,t){this._sliderMovement+=e/100*(t?this._stepPrecision:this._step),this.value=this._sliderPrevValue+this._sliderMovement}_onInputChange(e){this.value=this._normalizeValue(this._domInput.value)}_onInputKeyDown(e){if(this.enabled&&!this.readOnly){if("ArrowUp"===e.key||"ArrowDown"===e.key){const t="ArrowDown"===e.key?-1:1;this.value+=(e.shiftKey?this._stepPrecision:this._step)*t}super._onInputKeyDown(e)}}_getPointerLockElementByShadowRoot(e){const t=e.shadowRoot;if(t){const e=t.pointerLockElement;return this._getPointerLockElementByShadowRoot(e)}return e===this._sliderControl.dom}_isScrolling(){return!!this._sliderControl&&(document.pointerLockElement&&document.pointerLockElement.shadowRoot?this._getPointerLockElementByShadowRoot(document.pointerLockElement):document.pointerLockElement===this._sliderControl.dom)}_normalizeValue(e){try{if("string"==typeof e){if("0"===e)return 0;if(null!==(e=(e=(e=e.replace(j,".")).replace(/\s/g,"")).match(/^[*/+\-0-9().]+$/))&&e[0].length<20){let t=e[0];["+","-","/","*"].forEach((e=>{const s=t.split(e);s.forEach(((e,t)=>{s[t]=s[t].replace(/^0+/,"")})),t=s.join(e)})),e=Function(`"use strict";return (${t})`)()}}if(null==e||""===e){if(this._allowNull)return null;e=0}if(e=Number(e),isNaN(e)){if(this._allowNull)return null;e=0}return null!==this.min&&e<this.min&&(e=this.min),null!==this.max&&e>this.max&&(e=this.max),null!==this.precision&&(e=parseFloat(Number(e).toFixed(this.precision))),e}catch(e){return this._allowNull?null:0}}_updateValue(e,t){const s=e!==this._oldValue||t;return this._oldValue=e,this._domInput.value=null===e?"":String(e),this.class.remove(C),s&&this.emit("change",e),s}set value(e){e=this._normalizeValue(e);const t=this.class.contains(C)&&null===e&&this._allowNull;this._updateValue(e,t)&&this.binding&&this.binding.setValue(e),this._sliderControl&&this._sliderControl.class.remove(H)}get value(){const e=this._domInput.value;return""!==e?parseFloat(e):null}set values(e){const t=e.map((e=>this._normalizeValue(e)));t.some((e=>e!==t[0]))?(this._updateValue(null),this.class.add(C),this._sliderControl&&this._sliderControl.class.add(H)):(this._updateValue(t[0]),this._sliderControl&&this._sliderControl.class.remove(H))}set min(e){this._min!==e&&(this._min=e,null!==this._min&&(this.value=this.value))}get min(){return this._min}set max(e){this._max!==e&&(this._max=e,null!==this._max&&(this.value=this.value))}get max(){return this._max}set precision(e){this._precision!==e&&(this._precision=e,null!==this._precision&&(this.value=this.value))}get precision(){return this._precision}set step(e){this._step=e}get step(){return this._step}};M.register("number",W,{renderChanges:!0});let $=class extends M{constructor(e={}){var t,s,i;super(Object.assign({dom:"span"},e)),this.class.add("pcui-label"),this._unsafe=null!==(t=e.unsafe)&&void 0!==t&&t,this.text=null!==(i=null!==(s=e.text)&&void 0!==s?s:e.value)&&void 0!==i?i:"",e.allowTextSelection&&this.class.add("pcui-default-mousedown"),e.nativeTooltip&&(this.dom.title=this.text),this.placeholder=e.placeholder,this.renderChanges=e.renderChanges,this.on("change",(()=>{this.renderChanges&&this.flash()}))}_updateText(e){return this.class.remove(C),this._text!==e&&(this._text=e,this._unsafe?this._dom.innerHTML=e:this._dom.textContent=e,this.emit("change",e),!0)}set text(e){null==e&&(e="");this._updateText(e)&&this._binding&&this._binding.setValue(e)}get text(){return this._text}set value(e){this.text=e}get value(){return this.text}set values(e){e.some((t=>t!==e[0]))?(this._updateText(""),this.class.add(C)):this._updateText(e[0])}set placeholder(e){e?this.dom.setAttribute("placeholder",e):this.dom.removeAttribute("placeholder")}get placeholder(){return this.dom.getAttribute("placeholder")}set renderChanges(e){this._renderChanges=e}get renderChanges(){return this._renderChanges}};M.register("label",$);const q="pcui-panel",X=`${q}-header`,K=`${X}-title`,Y=`${q}-content`,Q=`${q}-horizontal`,J=`${q}-sortable-icon`,Z=`${q}-remove`;let ee=class extends z{constructor(e={}){var t,s,i,n,r;const a=Object.assign(Object.assign({},e),{flex:!0});delete a.grid,delete a.flexDirection,delete a.scrollable,super(a),this._reflowTimeout=null,this._widthBeforeCollapse=null,this._heightBeforeCollapse=null,this._iconSort=null,this._btnRemove=null,this._onHeaderClick=e=>{this._collapsible&&(e.target!==this.header.dom&&e.target!==this._labelTitle.dom||(this.collapsed=!this.collapsed))},this._onDragStart=e=>{this.enabled&&!this.readOnly&&(e.stopPropagation(),e.preventDefault(),window.addEventListener("mouseup",this._onDragEndEvt),window.addEventListener("mouseleave",this._onDragEndEvt),window.addEventListener("mousemove",this._onDragMove),this.emit("dragstart"),this.parent&&this.parent._onChildDragStart&&this.parent._onChildDragStart(e,this))},this._onDragMove=e=>{this.emit("dragmove"),this.parent&&this.parent._onChildDragStart&&this.parent._onChildDragMove(e,this)},this.class.add(q),e.panelType&&this.class.add(`${q}-${e.panelType}`),this._suspendReflow=!0,this._initializeHeader(e),this._initializeContent(e),this.headerSize=null!==(t=e.headerSize)&&void 0!==t?t:32,this.collapsible=null!==(s=e.collapsible)&&void 0!==s&&s,this.collapsed=null!==(i=e.collapsed)&&void 0!==i&&i,this.collapseHorizontally=null!==(n=e.collapseHorizontally)&&void 0!==n&&n,this.sortable=null!==(r=e.sortable)&&void 0!==r&&r,this.removable=e.removable||!!e.onRemove||!1,this.domContent=this._containerContent.dom,this._suspendReflow=!1,this._reflow(),this._onDragEndEvt=this._onDragEnd.bind(this)}destroy(){this._destroyed||(this._reflowTimeout&&(cancelAnimationFrame(this._reflowTimeout),this._reflowTimeout=null),window.removeEventListener("mouseup",this._onDragEndEvt),window.removeEventListener("mouseleave",this._onDragEndEvt),window.removeEventListener("mousemove",this._onDragMove),super.destroy())}_initializeHeader(e){this._containerHeader=new z({flex:!0,flexDirection:"row",class:[X,x]}),this._labelTitle=new $({text:e.headerText,class:[K,x]}),this._containerHeader.append(this._labelTitle),this._containerHeader.dom.addEventListener("click",this._onHeaderClick),this.append(this._containerHeader)}_onClickRemove(e){e.preventDefault(),e.stopPropagation(),this.emit("click:remove")}_initializeContent(e){this._containerContent=new z({class:Y,grid:e.grid,flex:e.flex,flexDirection:e.flexDirection,scrollable:e.scrollable,dom:e.content}),this.append(this._containerContent)}_reflow(){this._suspendReflow||(this._reflowTimeout&&(cancelAnimationFrame(this._reflowTimeout),this._reflowTimeout=null),!this.hidden&&this.collapsible&&(this.collapsed&&this.collapseHorizontally?this._containerHeader.style.top=-this.headerSize+"px":this._containerHeader.style.top="",this._reflowTimeout=requestAnimationFrame((()=>{this._reflowTimeout=null,this.collapsed?(this._widthBeforeCollapse||(this._widthBeforeCollapse=this.style.width),this._heightBeforeCollapse||(this._heightBeforeCollapse=this.style.height),this._collapseHorizontally?(this.height="",this.width=this.headerSize):this.height=this.headerSize,this.class.add(p)):(this.class.remove(p),this._collapseHorizontally?(this.height="",null!==this._widthBeforeCollapse&&(this.width=this._widthBeforeCollapse)):null!==this._heightBeforeCollapse&&(this.height=this._heightBeforeCollapse),this._widthBeforeCollapse=null,this._heightBeforeCollapse=null)}))))}_onDragEnd(e){window.removeEventListener("mouseup",this._onDragEndEvt),window.removeEventListener("mouseleave",this._onDragEndEvt),window.removeEventListener("mousemove",this._onDragMove),this._draggedChild===this&&(this._draggedChild=null),this.emit("dragend"),this.parent&&this.parent._onChildDragStart&&this.parent._onChildDragEnd(e,this)}set collapsible(e){e!==this._collapsible&&(this._collapsible=e,e?this.class.add(f):this.class.remove(f),this._reflow(),this.collapsed&&this.emit(e?"collapse":"expand"))}get collapsible(){return this._collapsible}set collapsed(e){this._collapsed!==e&&(this._collapsed=e,this._reflow(),this.collapsible&&this.emit(e?"collapse":"expand"))}get collapsed(){return this._collapsed}set sortable(e){this._sortable!==e&&(this._sortable=e,e?(this._iconSort=new $({class:J}),this._iconSort.dom.addEventListener("mousedown",this._onDragStart),this.header.prepend(this._iconSort)):this._iconSort&&(this._iconSort.destroy(),this._iconSort=null))}get sortable(){return this._sortable}set removable(e){this.removable!==e&&(e?(this._btnRemove=new R({icon:"E289",class:Z}),this._btnRemove.on("click",this._onClickRemove.bind(this)),this.header.append(this._btnRemove)):(this._btnRemove.destroy(),this._btnRemove=null))}get removable(){return!!this._btnRemove}set collapseHorizontally(e){this._collapseHorizontally!==e&&(this._collapseHorizontally=e,e?this.class.add(Q):this.class.remove(Q),this._reflow())}get collapseHorizontally(){return this._collapseHorizontally}get content(){return this._containerContent}get header(){return this._containerHeader}set headerText(e){this._labelTitle.text=e}get headerText(){return this._labelTitle.text}set headerSize(e){this._headerSize=e;const t=this._containerHeader.dom.style;t.height=`${Math.max(0,e)}px`,t.lineHeight=t.height,this._reflow()}get headerSize(){return this._headerSize}};ee.EVENT_COLLAPSE="collapse",ee.EVENT_EXPAND="expand",M.register("panel",ee);const te="pcui-boolean-input",se=`${te}-ticked`,ie=`${te}-toggle`;let ne=class extends M{constructor(e={}){var t;super(Object.assign({tabIndex:0},e)),this._onKeyDown=e=>{"Escape"!==e.key?this.enabled&&!this.readOnly&&" "===e.key&&(e.stopPropagation(),e.preventDefault(),this.value=!this.value):this.blur()},this._onFocus=()=>{this.emit("focus")},this._onBlur=()=>{this.emit("blur")},"toggle"===e.type?this.class.add(ie):this.class.add(te),this.class.add(T),this.dom.addEventListener("keydown",this._onKeyDown),this.dom.addEventListener("focus",this._onFocus),this.dom.addEventListener("blur",this._onBlur),this._value=null,void 0!==e.value&&(this.value=e.value),this.renderChanges=null!==(t=e.renderChanges)&&void 0!==t&&t}destroy(){this._destroyed||(this.dom.removeEventListener("keydown",this._onKeyDown),this.dom.removeEventListener("focus",this._onFocus),this.dom.removeEventListener("blur",this._onBlur),super.destroy())}_onClick(e){return this.enabled&&this.focus(),this.enabled&&!this.readOnly&&(this.value=!this.value),super._onClick(e)}_updateValue(e){return this.class.remove(C),e!==this.value&&(this._value=e,e?this.class.add(se):this.class.remove(se),this.renderChanges&&this.flash(),this.emit("change",e),!0)}focus(){this.dom.focus()}blur(){this.dom.blur()}set value(e){this._updateValue(e)&&this._binding&&this._binding.setValue(e)}get value(){return this._value}set values(e){e.some((t=>t!==e[0]))?(this._updateValue(null),this.class.add(C)):this._updateValue(e[0])}set renderChanges(e){this._renderChanges=e}get renderChanges(){return this._renderChanges}};M.register("boolean",ne,{renderChanges:!0});class re extends D{constructor(e={}){super(e),this.elementClass=ne}render(){return super.render()}}re.ctor=ne;class ae extends D{constructor(e={}){super(e),this.elementClass=R}render(){return d.createElement("button",{ref:this.attachElement})}}function oe(e){const t=e[0]/255,s=e[1]/255,i=e[2]/255;let n,r;const a=Math.max(t,s,i),o=a-Math.min(t,s,i),l=e=>(a-e)/6/o+.5;if(0===o)return n=r=0,[n,r,a];r=o/a;const h=l(t),c=l(s),d=l(i);return t===a?n=d-c:s===a?n=1/3+h-d:i===a&&(n=2/3+c-h),n<0?n+=1:n>1&&(n-=1),[n,r,a]}function le(e){const t=e[0],s=e[1],i=e[2];let n,r,a;const o=Math.floor(6*t),l=6*t-o,h=i*(1-s),c=i*(1-l*s),d=i*(1-(1-l)*s);switch(o%6){case 0:n=i,r=d,a=h;break;case 1:n=c,r=i,a=h;break;case 2:n=h,r=i,a=d;break;case 3:n=h,r=c,a=i;break;case 4:n=d,r=h,a=i;break;case 5:n=i,r=h,a=c}return[Math.round(255*n),Math.round(255*r),Math.round(255*a)]}ae.ctor=R;const he="pcui-overlay",ce=`${he}-inner`,de=`${he}-clickable`,ue=`${he}-transparent`,pe=`${he}-content`;let fe=class extends z{constructor(e={}){var t,s;super(e),this._onPointerDown=e=>{this.clickable&&!this.domContent.contains(e.target)&&(document.body.blur(),requestAnimationFrame((()=>{this.hidden=!0})),e.preventDefault(),e.stopPropagation())},this.class.add(he),this._domClickableOverlay=document.createElement("div"),this._domClickableOverlay.ui=this,this._domClickableOverlay.classList.add(ce),this.dom.appendChild(this._domClickableOverlay),this.on("show",(()=>{document.body.addEventListener("pointerdown",this._onPointerDown,!0)})),this.on("hide",(()=>{document.body.removeEventListener("pointerdown",this._onPointerDown,!0)})),this.domContent=document.createElement("div"),this.domContent.ui=this,this.domContent.classList.add(pe),this.dom.appendChild(this.domContent),this.clickable=null!==(t=e.clickable)&&void 0!==t&&t,this.transparent=null!==(s=e.transparent)&&void 0!==s&&s}destroy(){this._destroyed||super.destroy()}position(e,t){const s=this._domClickableOverlay.getBoundingClientRect(),i=this.domContent.getBoundingClientRect();e=Math.max(0,Math.min(s.width-i.width,e)),t=Math.max(0,Math.min(s.height-i.height,t)),this.domContent.style.position="absolute",this.domContent.style.left=`${e}px`,this.domContent.style.top=`${t}px`}set clickable(e){e?this.class.add(de):this.class.remove(de)}get clickable(){return this.class.contains(de)}set transparent(e){e?this.class.add(ue):this.class.remove(ue)}get transparent(){return this.class.contains(ue)}};M.register("overlay",fe);let me=class extends N{constructor(e={}){super(e),this.class.add("pcui-text-input"),e.onValidate&&(this.onValidate=e.onValidate)}_onInputChange(e){if(!this._suspendInputChangeEvt){if(this.onValidate){const e=!this.onValidate(this.value);if(this.error=e,e)return}else this.error=!1;this.emit("change",this.value),this._binding&&this._binding.setValue(this.value)}}_updateValue(e){if(this.class.remove(C),e&&"object"==typeof e)if(Array.isArray(e)){let t=!1;for(let s=0;s<e.length;s++)if(e[s]&&"object"==typeof e[s]){t=!0;break}e=t?"[Not available]":e.map((e=>null===e?"null":e)).join(",")}else e="[Not available]";return e!==this.value&&(this._suspendInputChangeEvt=!0,this._domInput.value=null==e?"":String(e),this._suspendInputChangeEvt=!1,this.emit("change",e),!0)}set value(e){const t=this._updateValue(e);t&&(this.error=!1),t&&this._binding&&this._binding.setValue(e)}get value(){return this._domInput.value}set values(e){e.some((t=>t!==e[0]))?(this._updateValue(null),this.class.add(C)):this._updateValue(e[0])}};M.register("string",me,{renderChanges:!0});let ge=class extends M{constructor(e={}){var t,s,i;super(e),this._historyCombine=!1,this._historyPostfix=null,this._size=144,this._directInput=!0,this._colorHSV=[0,0,0],this._pickerChannels=[],this._channelsNumber=4,this._changing=!1,this._dragging=!1,this._callingCallback=!1,this._pickRectPointerId=null,this._pickHuePointerId=null,this._pickOpacityPointerId=null,this._evtColorPick=null,this._evtColorToPicker=null,this._evtColorPickStart=null,this._evtColorPickEnd=null,this._onKeyDown=e=>{"Escape"===e.key&&this.blur(),"Enter"===e.key&&this.enabled&&!this.readOnly&&(e.stopPropagation(),e.preventDefault())},this._onFocus=e=>{this.emit("focus")},this._onBlur=e=>{this.emit("blur")},this._pickRectPointerDown=e=>{null===this._pickRectPointerId&&(this._pickRect.setPointerCapture(e.pointerId),this._pickRectPointerId=e.pointerId,e.preventDefault(),e.stopPropagation(),this.emit("picker:color:start"),this._pickRectPointerMove(e))},this._pickRectPointerMove=e=>{if(this._pickRectPointerId!==e.pointerId)return;this._changing=!0;const t=this._pickRect.getBoundingClientRect(),s=Math.max(0,Math.min(this._size,Math.floor(e.clientX-t.left))),i=Math.max(0,Math.min(this._size,Math.floor(e.clientY-t.top)));this._colorHSV[1]=s/this._size,this._colorHSV[2]=1-i/this._size,this._directInput=!1;const n=le(this._colorHSV);for(let e=0;e<3;e++)this._pickerChannels[e].value=n[e];this._fieldHex.value=this._getHex(),this._directInput=!0,this._pickRectHandle.style.left=`${Math.max(4,Math.min(this._size-4,s))}px`,this._pickRectHandle.style.top=`${Math.max(4,Math.min(this._size-4,i))}px`,this._changing=!1},this._pickRectPointerUp=e=>{this._pickRectPointerId===e.pointerId&&(this.emit("picker:color:end"),this._pickRect.releasePointerCapture(e.pointerId),this._pickRectPointerId=null)},this._pickHuePointerDown=e=>{null===this._pickHuePointerId&&(this._pickHue.setPointerCapture(e.pointerId),this._pickHuePointerId=e.pointerId,e.preventDefault(),e.stopPropagation(),this.emit("picker:color:start"),this._pickHuePointerMove(e))},this._pickHuePointerMove=e=>{if(this._pickHuePointerId!==e.pointerId)return;this._changing=!0;const t=this._pickHue.getBoundingClientRect(),s=Math.max(0,Math.min(this._size,Math.floor(e.clientY-t.top)))/this._size,i=le([s,this._colorHSV[1],this._colorHSV[2]]);this._colorHSV[0]=s,this._directInput=!1;for(let e=0;e<3;e++)this._pickerChannels[e].value=i[e];this._fieldHex.value=this._getHex(),this._onChangeRgb(),this._directInput=!0,this._changing=!1},this._pickHuePointerUp=e=>{this._pickHuePointerId===e.pointerId&&(this.emit("picker:color:end"),this._pickHue.releasePointerCapture(e.pointerId),this._pickHuePointerId=null)},this._pickOpacityPointerDown=e=>{null===this._pickOpacityPointerId&&(this._pickOpacity.setPointerCapture(e.pointerId),this._pickOpacityPointerId=e.pointerId,e.preventDefault(),e.stopPropagation(),this.emit("picker:color:start"),this._pickOpacityPointerMove(e))},this._pickOpacityPointerMove=e=>{if(this._pickOpacityPointerId!==e.pointerId)return;this._changing=!0;const t=this._pickOpacity.getBoundingClientRect(),s=1-Math.max(0,Math.min(this._size,Math.floor(e.clientY-t.top)))/this._size;this._directInput=!1,this._pickerChannels[3].value=Math.max(0,Math.min(255,Math.round(255*s))),this._fieldHex.value=this._getHex(),this._directInput=!0,this._changing=!1},this._pickOpacityPointerUp=e=>{this._pickOpacityPointerId===e.pointerId&&(this.emit("picker:color:end"),this._pickOpacity.releasePointerCapture(e.pointerId),this._pickOpacityPointerId=null)},this.class.add("pcui-color-input",T),this._domColor=document.createElement("div"),this.dom.appendChild(this._domColor),this.dom.addEventListener("keydown",this._onKeyDown),this.dom.addEventListener("focus",this._onFocus),this.dom.addEventListener("blur",this._onBlur),this.dom.addEventListener("pointerdown",(e=>{this.enabled&&!this.readOnly&&this._overlay.hidden&&(this._openColorPicker(),e.stopPropagation(),e.preventDefault())})),this._value=null!==(t=e.value)&&void 0!==t?t:[0,0,255,1],this._channels=null!==(s=e.channels)&&void 0!==s?s:3,this._setValue(this._value),this.renderChanges=null!==(i=e.renderChanges)&&void 0!==i&&i,this.on("change",(()=>{this.renderChanges&&this.flash()})),this._overlay=new fe({class:"picker-color",clickable:!0,hidden:!0,transparent:!0}),this.dom.appendChild(this._overlay.dom),this._pickRect=document.createElement("div"),this._pickRect.classList.add("pick-rect"),this._overlay.append(this._pickRect),this._pickRect.addEventListener("pointerdown",this._pickRectPointerDown),this._pickRect.addEventListener("pointermove",this._pickRectPointerMove),this._pickRect.addEventListener("pointerup",this._pickRectPointerUp),this._pickRectWhite=document.createElement("div"),this._pickRectWhite.classList.add("white"),this._pickRect.appendChild(this._pickRectWhite),this._pickRectBlack=document.createElement("div"),this._pickRectBlack.classList.add("black"),this._pickRect.appendChild(this._pickRectBlack),this._pickRectHandle=document.createElement("div"),this._pickRectHandle.classList.add("handle"),this._pickRect.appendChild(this._pickRectHandle),this._pickHue=document.createElement("div"),this._pickHue.classList.add("pick-hue"),this._overlay.append(this._pickHue),this._pickHue.addEventListener("pointerdown",this._pickHuePointerDown),this._pickHue.addEventListener("pointermove",this._pickHuePointerMove),this._pickHue.addEventListener("pointerup",this._pickHuePointerUp),this._pickHueHandle=document.createElement("div"),this._pickHueHandle.classList.add("handle"),this._pickHue.appendChild(this._pickHueHandle),this._pickOpacity=document.createElement("div"),this._pickOpacity.classList.add("pick-opacity"),this._overlay.append(this._pickOpacity),this._pickOpacity.addEventListener("pointerdown",this._pickOpacityPointerDown),this._pickOpacity.addEventListener("pointermove",this._pickOpacityPointerMove),this._pickOpacity.addEventListener("pointerup",this._pickOpacityPointerUp),this._pickOpacityHandle=document.createElement("div"),this._pickOpacityHandle.classList.add("handle"),this._pickOpacity.appendChild(this._pickOpacityHandle),this._panelFields=document.createElement("div"),this._panelFields.classList.add("fields"),this._overlay.append(this._panelFields),this._overlay.on("hide",(()=>{this._evtColorPick.unbind(),this._evtColorPick=null,this._evtColorToPicker.unbind(),this._evtColorToPicker=null,this._evtColorPickStart.unbind(),this._evtColorPickStart=null,this._evtColorPickEnd.unbind(),this._evtColorPickEnd=null}));const n=e=>new W({class:["field",`field-${e}`],precision:0,step:1,min:0,max:255,placeholder:e}),r=n("r");r.on("change",(()=>{this._onChangeRgb()})),this._pickerChannels.push(r),this._panelFields.appendChild(r.dom);const a=n("g");a.on("change",(()=>{this._onChangeRgb()})),this._pickerChannels.push(a),this._panelFields.appendChild(a.dom);const o=n("b");o.on("change",(()=>{this._onChangeRgb()})),this._pickerChannels.push(o),this._panelFields.appendChild(o.dom);const l=n("a");l.on("change",(e=>{this._onChangeAlpha(e)})),this._pickerChannels.push(l),this._panelFields.appendChild(l.dom),this._fieldHex=new me({class:["field","field-hex"],placeholder:"#"}),this._fieldHex.on("change",(()=>{this._onChangeHex()})),this._panelFields.appendChild(this._fieldHex.dom)}destroy(){this._destroyed||(this.dom.removeEventListener("keydown",this._onKeyDown),this.dom.removeEventListener("focus",this._onFocus),this.dom.removeEventListener("blur",this._onBlur),this._pickRect.removeEventListener("pointerdown",this._pickRectPointerDown),this._pickRect.removeEventListener("pointermove",this._pickRectPointerMove),this._pickRect.removeEventListener("pointerup",this._pickRectPointerUp),this._pickHue.removeEventListener("pointerdown",this._pickHuePointerDown),this._pickHue.removeEventListener("pointermove",this._pickHuePointerMove),this._pickHue.removeEventListener("pointerup",this._pickHuePointerUp),this._pickOpacity.removeEventListener("pointerdown",this._pickOpacityPointerDown),this._pickOpacity.removeEventListener("pointermove",this._pickOpacityPointerMove),this._pickOpacity.removeEventListener("pointerup",this._pickOpacityPointerUp),super.destroy())}focus(){this.dom.focus()}blur(){this.dom.blur()}_setColorPickerPosition(e,t){this._overlay.position(e,t)}_setPickerColor(e){if(!this._changing&&!this._dragging){if(this._channelsNumber>=3){const t=oe(e);this._colorHSV[0]=t[0],this._colorHSV[1]=t[1],this._colorHSV[2]=t[2]}this._directInput=!1;for(let t=0;t<e.length;t++)this._pickerChannels[t].value=e[t];this._fieldHex.value=this._getHex(),this._directInput=!0}}_openColorPicker(){this._callPicker(this.value.map((e=>Math.floor(255*e)))),this._evtColorPick=this.on("picker:color",(e=>{this.value=e.map((e=>e/255))})),this._evtColorPickStart=this.on("picker:color:start",(()=>{this.binding?(this._historyCombine=this.binding.historyCombine,this._historyPostfix=this.binding.historyPostfix,this.binding.historyCombine=!0,this._binding.historyPostfix=`(${Date.now()})`):(this._historyCombine=!1,this._historyPostfix=null)})),this._evtColorPickEnd=this.on("picker:color:end",(()=>{this.binding&&(this.binding.historyCombine=this._historyCombine,this.binding.historyPostfix=this._historyPostfix)}));const e=this._overlay.dom.getBoundingClientRect(),t=this.dom.getBoundingClientRect();this._setColorPickerPosition(t.left-e.left,t.bottom-e.top+1),this._evtColorToPicker=this.on("change",(()=>{this._setPickerColor(this.value.map((e=>Math.floor(255*e))))}))}_callPicker(e){for(let t=0;t<4;t++)e.length-1<t?this._overlay.class.remove(`c-${t+1}`):this._overlay.class.add(`c-${t+1}`);if(this._channelsNumber=e.length,this._channelsNumber>=3){const t=oe(e);this._colorHSV[0]=t[0],this._colorHSV[1]=t[1],this._colorHSV[2]=t[2]}this._directInput=!1;for(let t=0;t<e.length;t++)this._pickerChannels[t].value=e[t];this._fieldHex.value=this._getHex(),this._directInput=!0,this._overlay.hidden=!1,this._fieldHex.dom.focus(),window.setTimeout((()=>{this._fieldHex.dom.focus()}),100)}_valueToColor(e){return e=Math.floor(255*e),Math.max(0,Math.min(e,255))}_setValue(e){const t=this._valueToColor(e[0]),s=this._valueToColor(e[1]),i=this._valueToColor(e[2]),n=e[3];1===this._channels?this._domColor.style.backgroundColor=`rgb(${t}, ${t}, ${t})`:3===this._channels?this._domColor.style.backgroundColor=`rgb(${t}, ${s}, ${i})`:4===this._channels&&(this._domColor.style.backgroundColor=`rgba(${t}, ${s}, ${i}, ${n})`)}_updateValue(e){let t=!1;for(let s=0;s<e.length;s++)this._value[s]!==e[s]&&(t=!0,this._value[s]=e[s]);return this.class.remove(C),t&&(this._setValue(e),this.emit("change",e)),t}_getHex(){let e="";for(let t=0;t<this._channelsNumber;t++)e+=`00${this._pickerChannels[t].value.toString(16)}`.slice(-2).toUpperCase();return e}_onChangeHex(){if(!this._directInput)return;this._changing=!0;const e=this._fieldHex.value.trim().toLowerCase();if(/^([0-9a-f]{2}){3,4}$/.test(e))for(let t=0;t<this._channelsNumber;t++)this._pickerChannels[t].value=parseInt(e.slice(2*t,2*t+2),16);this._changing=!1}_onChangeRgb(){const e=this._pickerChannels.map((e=>e.value||0)).slice(0,this._channelsNumber),t=oe(e);if(this._directInput){const s=e[0]+e[1]+e[2];765!==s&&0!==s&&(this._colorHSV[0]=t[0]),this._colorHSV[1]=t[1],this._colorHSV[2]=t[2],this._dragging=!0,this.emit("picker:color:start")}if(this._pickHueHandle.style.top=`${Math.floor(this._size*this._colorHSV[0])}px`,this._pickRectHandle.style.left=`${Math.max(4,Math.min(this._size-4,this._size*this._colorHSV[1]))}px`,this._pickRectHandle.style.top=`${Math.max(4,Math.min(this._size-4,this._size*(1-this._colorHSV[2])))}px`,this._channelsNumber>=3){const t=le([this._colorHSV[0],1,1]).join(",");this._pickRect.style.backgroundColor=`rgb(${t})`,this._pickRectHandle.style.backgroundColor=`rgb(${e.slice(0,3).join(",")})`,this._pickHueHandle.style.backgroundColor=`rgb(${t})`}this.callCallback()}_onChangeAlpha(e){4===this._channelsNumber&&(this._pickOpacityHandle.style.top=`${Math.floor(this._size*(1-Math.max(0,Math.min(255,e))/255))}px`,this._pickOpacityHandle.style.backgroundColor=`rgb(${e}, ${e}, ${e})`,this.callCallback())}callbackHandle(){this._callingCallback=!1,this.emit("picker:color",this._pickerChannels.map((e=>e.value||0)).slice(0,this._channelsNumber))}callCallback(){this._callingCallback||(this._callingCallback=!0,window.setTimeout((()=>{this.callbackHandle()}),1e3/60))}set value(e){e=e||[0,0,0,0];this._updateValue(e)&&this._binding&&this._binding.setValue(e)}get value(){return this._value.slice(0,this._channels)}set values(e){let t=!1;const s=e[0];for(let i=1;i<e.length;i++)if(Array.isArray(s)){if(!s.equals(e[i])){t=!0;break}}else if(s!==e[i]){t=!0;break}t?(this.value=null,this.class.add(C)):this.value=e[0]}set channels(e){this._channels!==e&&(this._channels=Math.max(0,Math.min(e,4)),this._setValue(this.value))}get channels(){return this._channels}set renderChanges(e){this._renderChanges=e}get renderChanges(){return this._renderChanges}};M.register("rgb",ge),M.register("rgba",ge,{channels:4});class _e extends D{constructor(e){super(e),this.elementClass=ge}render(){return d.createElement("div",{ref:this.attachElement})}}_e.ctor=ge;class ve extends D{constructor(e={}){super(e),this.getParent=()=>this,this.elementClass=z}componentDidMount(){this.props.onResize&&this.element.on("resize",this.props.onResize)}render(){const e=Array.from(d.Children.toArray(this.props.children));let t;return 1===e.length?t=d.cloneElement(e[0],{parent:this.element}):e.length>0&&(t=e.map((e=>d.cloneElement(e,{parent:this.element})))),d.createElement("div",{ref:this.attachElement},t)}}ve.ctor=z;const be=(e,t)=>{if(0===e.length)return t.length;if(0===t.length)return e.length;if(e===t)return 0;const s=[];for(let e=0;e<=t.length;e++)s[e]=[e];for(let t=0;t<=e.length;t++)s[0][t]=t;for(let i=1;i<=t.length;i++)for(let n=1;n<=e.length;n++)t.charAt(i-1)===e.charAt(n-1)?s[i][n]=s[i-1][n-1]:s[i][n]=Math.min(s[i-1][n-1]+1,Math.min(s[i][n-1]+1,s[i-1][n]+1));return s[t.length][e.length]},ye=(e,t)=>{if(e===t)return e.length;let s=0;const i=new Set;for(let e=0;e<t.length;e++)i.add(t.charAt(e));for(let t=0;t<e.length;t++)i.has(e.charAt(t))&&s++;return s},xe=e=>{const t=[],s=e.replace(/([^A-Z])([A-Z][^A-Z])/g,"$1 $2").replace(/([A-Z0-9]{2,})/g," $1").split(/([\s\-_])/);for(let e=0;e<s.length;e++)s[e]=s[e].toLowerCase().trim(),s[e]&&"-"!==s[e]&&"_"!==s[e]&&t.push(s[e]);return t},we=(e,t,s)=>{const i=[];for(const n of e){if(n.subFull!==1/0){i.push(n),n.edits===1/0&&(n.edits=0),n.sub===1/0&&(n.sub=n.subFull);continue}if(n.name===t||0===n.name.indexOf(t)){i.push(n),n.edits===1/0&&(n.edits=0),n.sub===1/0&&(n.sub=0);continue}if(ye(t,n.name)/t.length<s.containsCharsTolerance)continue;let e=1/0,r=1/0;for(let i=0;i<n.tokens.length;i++){if(n.tokens[i]===t){e=0,r=i;break}const a=be(t,n.tokens[i]);(r===1/0||a<e)&&-1!==n.tokens[i].indexOf(t)?(r=i,e=a):r===1/0&&a<e&&a/Math.max(t.length,n.tokens[i].length)<=s.editsDistanceTolerance&&(e=a)}e!==1/0&&(i.push(n),n.edits=n.edits===1/0?e:n.edits+e,n.sub=n.sub===1/0?r:n.sub+r)}return i},Se=(e,t,s="",i={})=>{var n,r;if(!(s=s.toLowerCase().trim()))return[];const a=xe(s);if(!a.length)return[];i.containsCharsTolerance=null!==(n=i.containsCharsTolerance)&&void 0!==n?n:.5,i.editsDistanceTolerance=null!==(r=i.editsDistanceTolerance)&&void 0!==r?r:.5;let o=e.map((e=>{const i=e[t].toLowerCase().trim().indexOf(s);return{name:e[t],item:e,tokens:xe(e[t]),edits:1/0,subFull:-1!==i?i:1/0,sub:1/0}}));for(let e=0;e<a.length;e++)o=we(o,a[e],i);o.sort(((e,t)=>e.subFull!==t.subFull?e.subFull-t.subFull:e.sub!==t.sub?e.sub-t.sub:e.edits!==t.edits?e.edits-t.edits:e.name.length-t.name.length));let l=o.map((e=>e.item));return i.hasOwnProperty("limitResults")&&l.length>i.limitResults&&(l=l.slice(0,i.limitResults)),l},Ce="pcui-select-input",Te=`${Ce}-container-value`,Ee=`${Ce}-multi`,Pe=`${Ce}-disabled-value`,ke=`${Ce}-has-disabled-value`,Ae=`${Ce}-value`,Me=`${Ce}-icon`,De=`${Ce}-textinput`,Re=`${Ce}-list`,Le=`${Ce}-tags`,Ie=`${Ce}-tags-empty`,Fe=`${Ce}-tag`,Oe=`${Ce}-tag-not-everywhere`,Be=`${Ce}-shadow`,ze=`${Ce}-fit-height`,Ne="pcui-selected",Ue=`${Ce}-label-highlighted`,Ve=`${Ce}-create-new`,Ge="pcui-open";let He=class extends M{constructor(e={}){var t,s,i,n;const r=new z({dom:e.dom});super(Object.assign(Object.assign({},e),{dom:r.dom})),this._timeoutLabelValueTabIndex=null,this._valueToText={},this._valueToLabel={},this._labelToValue=new Map,this._labelHighlighted=null,this._disabledOptions={},this._prefix="",this._onInputChange=e=>{this._suspendInputChange||this._lastInputValue!==e&&(this.open(),this._lastInputValue=e,this._filterOptions(e))},this._onInputKeyDown=e=>{if("Enter"===e.key&&this.enabled&&!this.readOnly){let t;if(e.stopPropagation(),e.preventDefault(),t=this._labelHighlighted&&this._labelToValue.has(this._labelHighlighted)?this._labelToValue.get(this._labelHighlighted):this._input.value,void 0!==t)return this.focus(),this.close(),void(this._valueToText[t]?this._onSelectValue(t):this._allowCreate&&(this._createFn?this._createFn(t):this._onSelectValue(t)))}this._onKeyDown(e)},this._onDocumentPointerDown=e=>{this.dom.contains(e.composedPath()[0])||this.close()},this._onKeyDown=e=>{if("Escape"!==e.key)if("Tab"!==e.key){if(this.enabled&&!this.readOnly)if("Enter"!==e.key||this._allowInput){if("ArrowUp"===e.key||"ArrowDown"===e.key)if(e.stopPropagation(),e.preventDefault(),(this._allowInput||this.multiSelect)&&this._containerOptions.hidden)this.open();else if(this._containerOptions.hidden){if(!this._options.length)return;let t=-1;for(let e=0;e<this._options.length;e++)if(this._options[e].v===this.value){t=e;break}"ArrowUp"===e.key?t--:"ArrowDown"===e.key&&t++,t>=0&&t<this._options.length&&this._onSelectValue(this._options[t].v)}else{if(!this._containerOptions.dom.childNodes.length)return;if(this._labelHighlighted){let t=this._labelHighlighted.dom;do{"ArrowUp"===e.key?t=t.previousSibling:"ArrowDown"===e.key&&(t=t.nextSibling)}while(t&&t.ui.hidden);t&&this._highlightLabel(t.ui)}else this._highlightLabel(this._containerOptions.dom.childNodes[0].ui)}}else this._labelHighlighted&&this._labelToValue.has(this._labelHighlighted)&&(this._onSelectValue(this._labelToValue.get(this._labelHighlighted)),this.close())}else this.close();else this.close()},this._onPointerDown=()=>{this._allowInput||this.focus()},this._onFocus=()=>{this.class.add(b),this.emit("focus"),this._input.hidden||this.open()},this._onBlur=()=>{this.class.remove(b),this.emit("blur")},this._onWheel=e=>{e.stopPropagation()},this._container=r,this._container.parent=this,this.class.add(Ce),this._containerValue=new z({class:Te}),this._container.append(this._containerValue),this._domShadow=document.createElement("div"),this._domShadow.classList.add(Be),this._containerValue.append(this._domShadow),this._allowInput=e.allowInput,this._allowInput&&this.class.add("pcui-select-input-allow-input"),this._allowCreate=e.allowCreate,this._createFn=e.createFn,this._createLabelText=e.createLabelText,this._labelValue=new $({class:Ae,tabIndex:0}),this._labelValue.on("click",(()=>{this.enabled&&!this.readOnly&&this.toggle()})),this._containerValue.append(this._labelValue),this._labelIcon=new $({class:Me,hidden:e.allowInput&&e.multiSelect}),this._containerValue.append(this._labelIcon),this._input=new me({class:De,blurOnEnter:!1,keyChange:!0}),this._containerValue.append(this._input),this._lastInputValue="",this._suspendInputChange=!1,this._input.on("change",this._onInputChange),this._input.on("keydown",this._onInputKeyDown),this._input.on("focus",this._onFocus),this._input.on("blur",this._onBlur),e.placeholder&&(this.placeholder=e.placeholder),this._containerOptions=new z({class:Re,hidden:!0}),this._containerValue.append(this._containerOptions),this._containerTags=new z({class:Le,flex:!0,flexDirection:"row",hidden:!0}),this._container.append(this._containerTags),e.multiSelect&&(this.class.add(Ee),this._containerTags.hidden=!1),this._labelValue.dom.addEventListener("keydown",this._onKeyDown),this._labelValue.dom.addEventListener("focus",this._onFocus),this._labelValue.dom.addEventListener("blur",this._onBlur),this._labelValue.dom.addEventListener("pointerdown",this._onPointerDown),this._containerOptions.dom.addEventListener("wheel",this._onWheel,{passive:!0}),this.on("hide",(()=>{this.close()})),this._type=null!==(t=e.type)&&void 0!==t?t:"string",this.invalidOptions=null!==(s=e.invalidOptions)&&void 0!==s?s:[],this.options=null!==(i=e.options)&&void 0!==i?i:[],this._optionsFn=e.optionsFn,this._allowNull=e.allowNull,this._values=null,void 0!==e.value?this.value=e.value:e.defaultValue?this.value=e.defaultValue:this.value=null,this._renderChanges=e.renderChanges,this.on("change",(()=>{this._updateInputFieldsVisibility(),this.renderChanges&&!this.multiSelect&&this._labelValue.flash()})),this._updateInputFieldsVisibility(!1),this._onSelect=e.onSelect,this.fallbackOrder=e.fallbackOrder,this.disabledOptions=e.disabledOptions,this._prefix=null!==(n=e.prefix)&&void 0!==n?n:""}destroy(){this._destroyed||(this._labelValue.dom.removeEventListener("keydown",this._onKeyDown),this._labelValue.dom.removeEventListener("pointerdown",this._onPointerDown),this._labelValue.dom.removeEventListener("focus",this._onFocus),this._labelValue.dom.removeEventListener("blur",this._onBlur),this._containerOptions.dom.removeEventListener("wheel",this._onWheel),window.removeEventListener("keydown",this._onKeyDown),document.removeEventListener("pointerdown",this._onDocumentPointerDown),this._timeoutLabelValueTabIndex&&(cancelAnimationFrame(this._timeoutLabelValueTabIndex),this._timeoutLabelValueTabIndex=null),super.destroy())}_initializeCreateLabel(){const e=new z({class:Ve,flex:!0,flexDirection:"row"}),t=new $({text:this._input.value,tabIndex:-1});e.append(t);let s=this._input.on("change",(s=>{t.destroyed||(t.text=s,this.invalidOptions&&-1!==this.invalidOptions.indexOf(s)?e.hidden||(e.hidden=!0,this._resizeShadow()):e.hidden&&(e.hidden=!1,this._resizeShadow()))}));e.on("click",(e=>{e.stopPropagation();const s=t.text;this.focus(),this.close(),this._createFn?this._createFn(s):s&&this._onSelectValue(s)})),t.on("destroy",(()=>{s.unbind(),s=null}));const i=new $({text:this._createLabelText});return e.append(i),this._containerOptions.append(e),e}_convertSingleValue(e){if(null===e&&this._allowNull)return e;if("string"===this._type)e=e?e.toString():"";else if("number"===this._type)e=e?parseInt(e,10):0;else if("boolean"===this._type)return!!e;return e}_convertValue(e){return null===e&&this._allowNull?e:this.multiSelect?Array.isArray(e)?e.map((e=>this._convertSingleValue(e))):e:this._convertSingleValue(e)}_onSelectValue(e){if(e=this._convertSingleValue(e),this.multiSelect)if(this._values){let t=!1;this._values.forEach((s=>{s?-1===s.indexOf(e)&&(s.push(e),t=!0):(s=[e],t=!0)})),t&&(this._onMultipleValuesChange(this._values),this.emit("change",this.value),this._binding&&this._binding.addValues([e]))}else this._value&&Array.isArray(this._value)?-1===this._value.indexOf(e)&&(this._value.push(e),this._addTag(e),this.emit("change",this.value),this._binding&&this._binding.addValues([e])):this.value=[e];else this.value=e}_highlightLabel(e){if(this._labelHighlighted!==e&&(this._labelHighlighted&&this._labelHighlighted.class.remove(Ue),this._labelHighlighted=e,this._labelHighlighted)){this._labelHighlighted.class.add(Ue);const e=this._labelHighlighted.dom.offsetTop,t=this._containerOptions.dom.scrollTop;e<t?this._containerOptions.dom.scrollTop=e:e+this._labelHighlighted.height>this._containerOptions.height+t&&(this._containerOptions.dom.scrollTop=e+this._labelHighlighted.height-this._containerOptions.height)}}_onValueChange(e){if(this.multiSelect){if(this._labelValue.value="",this._containerTags.clear(),this._containerTags.class.add(Ie),e&&Array.isArray(e)){for(const t of e){this._addTag(t);const e=this._valueToLabel[String(t)];e&&e.class.add(Ne)}for(const t in this._valueToLabel){const s=this._valueToLabel[t];-1!==e.indexOf(this._convertSingleValue(t))?s.class.add(Ne):s.class.remove(Ne)}}}else{this._labelValue.value=this._prefix+(this._valueToText[String(e)]||""),e=String(e);for(const t in this._valueToLabel){const s=this._valueToLabel[t];t===e?s.class.add(Ne):s.class.remove(Ne)}}}_onMultipleValuesChange(e){this._labelValue.value="",this._containerTags.clear(),this._containerTags.class.add(Ie);const t={},s={};e.forEach((e=>{e&&e.forEach((e=>{t[e]?s[e]++:(t[e]=this._addTag(e),s[e]=1)}))}));for(const i in s)if(s[i]!==e.length){t[i].class.add(Oe);const e=this._valueToLabel[String(i)];e&&e.class.remove(Ne)}}_addTag(e){const t=new z({flex:!0,flexDirection:"row",class:Fe});t.append(new $({text:this._valueToText[String(e)]||e}));const s=new R({size:"small",icon:"E132",tabIndex:-1});t.append(s),s.on("click",(()=>this._removeTag(t,String(e)))),this._containerTags.append(t),this._containerTags.class.remove(Ie);const i=this._valueToLabel[String(e)];return i&&i.class.add(Ne),t.value=e,t}_removeTag(e,t){e.destroy();const s=this._valueToLabel[String(t)];if(s&&s.class.remove(Ne),this._values)this._values.forEach((e=>{if(!e)return;const s=e.indexOf(t);-1!==s&&e.splice(s,1)}));else if(this._value&&Array.isArray(this._value)){const e=this._value.indexOf(t);-1!==e&&this._value.splice(e,1)}this.emit("change",this.value),this._binding&&this._binding.removeValues([t])}_filterOptions(e){const t=this._containerOptions.dom;for(;t.firstChild;)t.removeChild(t.lastChild);if(e){Se(this._options,"t",e).forEach((e=>{const s=this._valueToLabel[String(e.v)];t.appendChild(s.dom)}))}else for(const e of this._options){const s=this._valueToLabel[String(e.v)];t.appendChild(s.dom)}this._createLabelContainer&&t.appendChild(this._createLabelContainer.dom),t.firstChild&&this._highlightLabel(t.firstChild.ui),this._resizeShadow()}_resizeShadow(){this._domShadow.style.height=`${this._containerValue.height+this._containerOptions.height}px`}_updateInputFieldsVisibility(e){let t=!1,s=!1;this._allowInput&&(e?(t=!0,s=!0):t=this.multiSelect||!this._valueToLabel[this.value]),this._labelValue.hidden=t,this._labelIcon.hidden=t,this._input.hidden=!t,s&&this._input.focus(),this._labelValue.hidden||(this._labelValue.tabIndex=-1,this._timeoutLabelValueTabIndex||(this._timeoutLabelValueTabIndex=requestAnimationFrame((()=>{this._timeoutLabelValueTabIndex=null,this._labelValue.tabIndex=0}))))}focus(){this._input.hidden?this._labelValue.dom.focus():this._input.focus()}blur(){this._allowInput?this._input.blur():this._labelValue.dom.blur()}open(){if(!this._containerOptions.hidden||!this.enabled||this.readOnly)return;if(this._updateInputFieldsVisibility(!0),this._optionsFn&&(this.options=this._optionsFn()),0===this._containerOptions.dom.childNodes.length)return;this._containerOptions.forEachChild((e=>{e.hidden=!1,this._labelToValue.get(e)===this.value&&this._highlightLabel(e)})),this._labelHighlighted||this._highlightLabel(this._containerOptions.dom.childNodes[0].ui),this._containerOptions.hidden=!1,this.class.add(Ge),window.addEventListener("keydown",this._onKeyDown),document.addEventListener("pointerdown",this._onDocumentPointerDown);const e=(this._allowInput?this._input.dom:this._labelValue.dom).getBoundingClientRect();let t=e.bottom+this._containerOptions.height+25>=window.innerHeight;t&&e.top-this._containerOptions.height<0&&(t=!1,this._containerOptions.style.maxHeight=window.innerHeight-e.bottom-25+"px"),t?this.class.add(ze):this.class.remove(ze),this._resizeShadow()}close(){this._containerOptions.style.maxHeight="",this._highlightLabel(null),this._updateInputFieldsVisibility(!1),this._suspendInputChange=!0,this._input.value="",this._lastInputValue&&(this._lastInputValue="",this._filterOptions(null)),this._suspendInputChange=!1,this._containerOptions.hidden||(this._containerOptions.hidden=!0,this._domShadow.style.height="",this.class.remove(Ge),window.removeEventListener("keydown",this._onKeyDown),document.removeEventListener("pointerdown",this._onDocumentPointerDown))}toggle(){this._containerOptions.hidden?this.open():this.close()}unlink(){super.unlink(),this._containerOptions.hidden||this.close()}_updateValue(e){e!==this._value&&(this._value=e,this._onValueChange(e),this._suppressChange||this.emit("change",e),this._binding&&this._binding.setValue(e))}_updateDisabledValue(e){const t={};this._containerOptions.forEachChild((e=>{t[e.dom.id]=e,this._disabledOptions[e.dom.id]?(e.enabled=!1,e.text=this._disabledOptions[e.dom.id]):(e.enabled=!0,e.text=this._valueToText[e.dom.id]),e.class.remove(Pe)}));const s=this._disabledOptions[e]?e:null;let i=null;if(s){if(this._fallbackOrder)for(let t=0;t<this._fallbackOrder.length;t++)if(this._fallbackOrder[t]!==e){i=this._fallbackOrder[t];break}this.disabledValue=s,t[s].class.add(Pe)}else this._disabledValue?(i=this._disabledValue,this.disabledValue=null):(i=e,this.disabledValue=null);return i}set options(e){if(!this._options||JSON.stringify(this._options)!==JSON.stringify(e)){this._containerOptions.clear(),this._labelHighlighted=null,this._valueToText={},this._valueToLabel={},this._options=e;for(const e of this._options){if(this._valueToText[String(e.v)]=e.t,""===e.v)return;const t=new $({text:e.t,tabIndex:-1,id:String(e.v)});this._labelToValue.set(t,e.v),this._valueToLabel[String(e.v)]=t,t.on("click",(t=>{t.stopPropagation(),this._onSelectValue(e.v),this.close(),this._onSelect&&this._onSelect(this.value)})),this._containerOptions.append(t)}this._createLabelContainer=null,this._createLabelText&&(this._createLabelContainer=this._initializeCreateLabel()),this.multiSelect&&this._values?this._onMultipleValuesChange(this._values):this._onValueChange(this.value),this._lastInputValue&&this._filterOptions(this._lastInputValue)}}get options(){return this._options.slice()}set invalidOptions(e){this._invalidOptions=e||null}get invalidOptions(){return this._invalidOptions}set disabledValue(e){this._disabledValue=e,null!==this._disabledValue?this.class.add(ke):this.class.remove(ke)}set disabledOptions(e){if(JSON.stringify(this._disabledOptions)===JSON.stringify(e))return;this._disabledOptions=e||{};const t=this._updateDisabledValue(this._value);this._updateValue(t)}set fallbackOrder(e){this._fallbackOrder=e||null}get multiSelect(){return this.class.contains(Ee)}set value(e){this._values=null,this._suspendInputChange=!0,this._input.value="",this._lastInputValue&&(this._lastInputValue="",this._filterOptions(null)),this._suspendInputChange=!1,this.class.remove(C),e=this._convertValue(e),(!(this._value===e||this.multiSelect&&this._value&&this._value.equals(e))||null===e&&this._allowNull&&this.class.contains(C))&&(this.disabledValue=null,this._updateValue(e))}get value(){if(!this.multiSelect)return this._value;const e=[];return this._containerTags.dom.childNodes.forEach((t=>{e.push(t.ui.value)})),e}set values(e){e=e.map((e=>this._convertValue(e)));let t=!1;const s=e[0],i=this.multiSelect;this._values=null;for(let n=1;n<e.length;n++)if(!(e[n]===s||i&&e[n]&&e[n].equals(s))){t=!0;break}t?(this._labelValue.values=e,i?(this._values=e,this._value=null,this._onMultipleValuesChange(this._values),this.emit("change",this.value)):null!==this._value&&(this._value=null,this.emit("change",null)),this.class.add(C)):this.value=e[0]}set placeholder(e){this._input.placeholder=e}get placeholder(){return this._input.placeholder}set renderChanges(e){this._renderChanges=e}get renderChanges(){return this._renderChanges}};M.register("select",He,{renderChanges:!0}),M.register("multiselect",He,{multiSelect:!0,renderChanges:!0}),M.register("tags",He,{allowInput:!0,allowCreate:!0,multiSelect:!0,renderChanges:!0});let je=class extends z{constructor(e={}){var t,s,i,n;super(e),this._titleElement=new M,this._textElement=new M,this.class.add("pcui-infobox"),this.append(this._titleElement),this.append(this._textElement),this._unsafe=null!==(t=e.unsafe)&&void 0!==t&&t,this.icon=null!==(s=e.icon)&&void 0!==s?s:"",this.title=null!==(i=e.title)&&void 0!==i?i:"",this.text=null!==(n=e.text)&&void 0!==n?n:""}set icon(e){this._icon!==e&&(this._icon=e,e?this.dom.setAttribute("data-icon",String.fromCodePoint(parseInt(e,16))):this.dom.removeAttribute("data-icon"))}get icon(){return this._icon}set title(e){this._title!==e&&(this._title=e,this._unsafe?this._titleElement.dom.innerHTML=e:this._titleElement.dom.textContent=e)}get title(){return this._title}set text(e){this._text!==e&&(this._text=e,this._unsafe?this._textElement.dom.innerHTML=e:this._textElement.dom.textContent=e)}get text(){return this._text}};M.register("infobox",je);class We extends D{constructor(e){super(e),this.elementClass=je}render(){return d.createElement("span",{ref:this.attachElement})}}We.ctor=je;class $e extends D{constructor(e={}){super(e),this.elementClass=$}render(){return d.createElement("span",{ref:this.attachElement})}}$e.ctor=$;class qe extends D{constructor(e){super(e),this.elementClass=W}render(){return super.render()}}qe.ctor=W;class Xe extends D{constructor(e={}){super(e),this.elementClass=ee}componentDidMount(){this.attachElement(this.nodeElement,this.containerElement)}render(){let e=d.Children.toArray(this.props.children);return 1===e.length?e=d.cloneElement(e[0],{parent:this.element}):e.length>0&&(e=e.map((e=>d.cloneElement(e,{parent:this.element})))),d.createElement("div",{ref:e=>{this.nodeElement=e}},d.createElement("div",{ref:e=>{this.containerElement=e}},e))}}Xe.ctor=ee;class Ke extends D{constructor(e){super(e),this.elementClass=He,this.onSelect=e.onSelect,this.onAttach=this.onAttachFn.bind(this)}onAttachFn(){this.props.onSelect&&this.element.on("select",this.onSelect)}render(){return super.render()}}var Ye;Ke.ctor=He;const Qe="pcui-slider",Je=`${Qe}-container`,Ze=`${Qe}-bar`,et=`${Qe}-handle`,tt=`${Qe}-active`,st=/Chrome\//.test(null===(Ye=globalThis.navigator)||void 0===Ye?void 0:Ye.userAgent);let it=class extends M{constructor(e={}){var t,s,i,n,r;super(e),this._historyCombine=!1,this._historyPostfix=null,this._cursorHandleOffset=0,this._pointerId=null,this._onPointerDown=e=>{"mouse"===e.pointerType&&0!==e.button||!this.enabled||this.readOnly||null!==this._pointerId||(e.stopPropagation(),this._domSlider.setPointerCapture(e.pointerId),this._pointerId=e.pointerId,this._onSlideStart(e.pageX))},this._onPointerMove=e=>{e.pointerId===this._pointerId&&(e.stopPropagation(),e.preventDefault(),this._onSlideMove(e.pageX))},this._onPointerUp=e=>{e.pointerId===this._pointerId&&null!==this._pointerId&&(e.stopPropagation(),this._domSlider.releasePointerCapture(e.pointerId),this._onSlideEnd(e.pageX),this._pointerId=null)},this._onKeyDown=e=>{if("Escape"===e.key)return void this.blur();if(!this.enabled||this.readOnly)return;if("ArrowLeft"!==e.key&&"ArrowRight"!==e.key)return;e.stopPropagation(),e.preventDefault();let t="ArrowLeft"===e.key?-1:1;e.shiftKey&&(t*=10),this.value+=t*this.step},this.class.add(Qe);const a=new W({allowNull:e.allowNull,hideSlider:!0,min:e.min,max:e.max,keyChange:e.keyChange,placeholder:e.placeholder,precision:null!==(t=e.precision)&&void 0!==t?t:2,renderChanges:e.renderChanges,step:e.step});a.on("change",(e=>{this._onValueChange(e)})),a.on("focus",(()=>{this.emit("focus")})),a.on("blur",(()=>{this.emit("blur")})),a.parent=this,this.dom.appendChild(a.dom),this._numericInput=a,this._sliderMin=null!==(i=null!==(s=e.sliderMin)&&void 0!==s?s:e.min)&&void 0!==i?i:0,this._sliderMax=null!==(r=null!==(n=e.sliderMax)&&void 0!==n?n:e.max)&&void 0!==r?r:1,this._domSlider=document.createElement("div"),this._domSlider.classList.add(Je),this.dom.appendChild(this._domSlider),this._domBar=document.createElement("div"),this._domBar.classList.add(Ze),this._domBar.ui=this,this._domSlider.appendChild(this._domBar),this._domHandle=document.createElement("div"),this._domHandle.ui=this,this._domHandle.tabIndex=0,this._domHandle.classList.add(et),this._domBar.appendChild(this._domHandle),this._domSlider.addEventListener("pointerdown",this._onPointerDown),this._domHandle.addEventListener("keydown",this._onKeyDown),void 0!==e.value&&(this.value=e.value),void 0!==e.values&&(this.values=e.values),0===this.value&&this._updateHandle(0)}destroy(){this._destroyed||(this._domSlider.removeEventListener("pointerdown",this._onPointerDown),this._domHandle.removeEventListener("keydown",this._onKeyDown),super.destroy())}_updateHandle(e){const t=100*Math.max(0,Math.min(1,((e||0)-this._sliderMin)/(this._sliderMax-this._sliderMin))),s=this._domHandle.getBoundingClientRect().width;this._domHandle.style.left=`calc(${t}% + ${s/2}px)`}_onValueChange(e){this._updateHandle(e),this._suppressChange||this.emit("change",e),this._binding&&this._binding.setValue(e)}_calculateCursorHandleOffset(e){const t=st?2:0,s=this._domHandle.getBoundingClientRect(),i=s.left-t,n=s.right;return this._cursorHandleOffset=e>=i&&e<=n?e-(i+(n-i)/2):0,this._cursorHandleOffset}_onSlideStart(e){this._domHandle.focus(),this._domSlider.addEventListener("pointermove",this._onPointerMove),this._domSlider.addEventListener("pointerup",this._onPointerUp),this.class.add(tt),this._calculateCursorHandleOffset(e)||this._onSlideMove(e),this.binding&&(this._historyCombine=this.binding.historyCombine,this._historyPostfix=this.binding.historyPostfix,this.binding.historyCombine=!0,this.binding.historyPostfix=`(${Date.now()})`)}_onSlideMove(e){const t=this._domBar.getBoundingClientRect();e-=this._cursorHandleOffset;let s=Math.max(0,Math.min(1,(e-t.left)/t.width))*(this._sliderMax-this._sliderMin)+this._sliderMin;s=parseFloat(s.toFixed(this.precision)),this.value=s}_onSlideEnd(e){this._calculateCursorHandleOffset(e)||this._onSlideMove(e),this.class.remove(tt),this._domSlider.removeEventListener("pointermove",this._onPointerMove),this._domSlider.removeEventListener("pointerup",this._onPointerUp),this.binding&&(this.binding.historyCombine=this._historyCombine,this.binding.historyPostfix=this._historyPostfix,this._historyCombine=!1,this._historyPostfix=null)}focus(){this._numericInput.focus()}blur(){this._domHandle.blur(),this._numericInput.blur()}set sliderMin(e){this._sliderMin!==e&&(this._sliderMin=e,this._updateHandle(this.value))}get sliderMin(){return this._sliderMin}set sliderMax(e){this._sliderMax!==e&&(this._sliderMax=e,this._updateHandle(this.value))}get sliderMax(){return this._sliderMax}set value(e){this._numericInput.value=e,this._numericInput.class.contains(C)?this.class.add(C):this.class.remove(C)}get value(){return this._numericInput.value}set values(e){this._numericInput.values=e,this._numericInput.class.contains(C)?this.class.add(C):this.class.remove(C)}set renderChanges(e){this._numericInput.renderChanges=e}get renderChanges(){return this._numericInput.renderChanges}set min(e){this._numericInput.min=e}get min(){return this._numericInput.min}set max(e){this._numericInput.max=e}get max(){return this._numericInput.max}set step(e){this._numericInput.step=e}get step(){return this._numericInput.step}set precision(e){this._numericInput.precision=e}get precision(){return this._numericInput.precision}set keyChange(e){this._numericInput.keyChange=e}get keyChange(){return this._numericInput.keyChange}set placeholder(e){this._numericInput.placeholder=e}get placeholder(){return this._numericInput.placeholder}};M.register("slider",it,{renderChanges:!0});class nt extends D{constructor(e){super(e),this.elementClass=it}render(){return super.render()}}nt.ctor=it;let rt=class e extends M{constructor(t={}){var s,i;if((null!==(s=t.type)&&void 0!==s?s:"small-thick")===e.TYPE_SMALL_THICK){const e=function(e,t){const s=t||document.createElementNS("http://www.w3.org/2000/svg","svg");return s.classList.add("spin"),s.setAttribute("width",e),s.setAttribute("height",e),s.setAttribute("viewBox","0 0 14 14"),s.setAttribute("fill","none"),s.innerHTML='<path d="M7 14C3.13871 14 0 10.8613 0 7C0 3.13871 3.13871 0 7 0C10.8613 0 14 3.13871 14 7C14 10.8613 10.8613 14 7 14ZM7 2.25806C4.38064 2.25806 2.25806 4.38064 2.25806 7C2.25806 9.61935 4.38064 11.7419 7 11.7419C9.61935 11.7419 11.7419 9.61935 11.7419 7C11.7419 4.38064 9.61935 2.25806 7 2.25806Z" fill="#773417"/><path class="pcui-spinner-highlight" d="M7 14V11.7419C9.61935 11.7419 11.7419 9.61935 11.7419 7H14C14 10.8613 10.8613 14 7 14Z" fill="#FF6600"/>',s}(null!==(i=t.size)&&void 0!==i?i:12,t.dom);t=Object.assign(Object.assign({},t),{dom:e})}super(t),this.class.add("pcui-spinner")}};rt.TYPE_SMALL_THICK="small-thick";class at extends D{constructor(e){super(e),this.elementClass=rt}render(){return d.createElement("svg",{ref:this.attachElement})}}at.ctor=rt;class ot extends D{constructor(e={}){super(e),this.elementClass=me,e.onValidate&&(this.onValidate=e.onValidate),this.onAttach=this.onAttachFn.bind(this)}onAttachFn(){this.onValidate&&(this.element.onValidate=this.onValidate)}render(){return super.render()}}ot.ctor=me;const lt="pcui-treeview-item",ht=`${lt}-icon`,ct=`${lt}-text`,dt=`${lt}-selected`,ut=`${lt}-open`,pt=`${lt}-contents`,ft=`${lt}-empty`,mt=`${lt}-rename`;let gt=class e extends z{constructor(e={}){var t,s,i,n,r;super(e),this.allowDrop=!0,this.allowDrag=!0,this.allowSelect=!0,this._numChildren=0,this._open=!1,this._onContentKeyDown=e=>{"INPUT"!==e.target.tagName&&this.allowSelect&&this._treeView&&this._treeView._onChildKeyDown(e,this)},this._onContentMouseDown=e=>{this._treeView&&this._treeView.allowDrag&&this.allowDrag&&(this._treeView._updateModifierKeys(e),e.stopPropagation())},this._onContentMouseUp=e=>{e.stopPropagation(),e.preventDefault(),window.removeEventListener("mouseup",this._onContentMouseUp),this._treeView&&this._treeView._onChildDragEnd(e,this)},this._onContentMouseOver=e=>{e.stopPropagation(),this._treeView&&this._treeView._onChildDragOver(e,this),this.emit("hover",e)},this._onContentDragStart=e=>{e.stopPropagation(),e.preventDefault(),this._treeView&&this._treeView.allowDrag&&(this.class.contains(mt)||(this._treeView._onChildDragStart(e,this),window.addEventListener("mouseup",this._onContentMouseUp)))},this._onContentClick=e=>{if(!this.allowSelect||0!==e.button)return;if("INPUT"===e.target.tagName)return;e.stopPropagation();const t=this._containerContents.dom.getBoundingClientRect();this._numChildren>0&&e.clientX-t.left<0?(this.open=!this.open,e.altKey&&this._dfs((e=>{e.open=this.open})),this.focus()):this._treeView&&this._treeView._onChildClick(e,this)},this._onContentDblClick=e=>{if(!this._treeView||!this._treeView.allowRenaming||0!==e.button)return;if("INPUT"===e.target.tagName)return;e.stopPropagation();const t=this._containerContents.dom.getBoundingClientRect();this.numChildren&&e.clientX-t.left<0||(this.allowSelect&&(this._treeView.deselect(),this._treeView._onChildClick(e,this)),this.rename())},this._onContentContextMenu=e=>{this._treeView&&this._treeView._onContextMenu&&this._treeView._onContextMenu(e,this)},this._onContentFocus=e=>{this.emit("focus")},this._onContentBlur=e=>{this.emit("blur")},this.class.add(lt,ft),this._containerContents=new z({class:pt,flex:!0,flexDirection:"row",tabIndex:0}),this.append(this._containerContents),this._containerContents.dom.draggable=!0,this._labelIcon=new $({class:ht}),this._containerContents.append(this._labelIcon),this.icon=null!==(t=e.icon)&&void 0!==t?t:"E360",this._labelText=new $({class:ct}),this._containerContents.append(this._labelText),this.allowSelect=null===(s=e.allowSelect)||void 0===s||s,this.allowDrop=null===(i=e.allowDrop)||void 0===i||i,this.allowDrag=null===(n=e.allowDrag)||void 0===n||n,e.text&&(this.text=e.text),e.selected&&(this.selected=e.selected),this._open=null!==(r=e.open)&&void 0!==r&&r;const a=this._containerContents.dom;a.addEventListener("focus",this._onContentFocus),a.addEventListener("blur",this._onContentBlur),a.addEventListener("keydown",this._onContentKeyDown),a.addEventListener("dragstart",this._onContentDragStart),a.addEventListener("mousedown",this._onContentMouseDown),a.addEventListener("mouseover",this._onContentMouseOver),a.addEventListener("click",this._onContentClick),a.addEventListener("dblclick",this._onContentDblClick),a.addEventListener("contextmenu",this._onContentContextMenu)}destroy(){if(this._destroyed)return;const e=this._containerContents.dom;e.removeEventListener("focus",this._onContentFocus),e.removeEventListener("blur",this._onContentBlur),e.removeEventListener("keydown",this._onContentKeyDown),e.removeEventListener("dragstart",this._onContentDragStart),e.removeEventListener("mousedown",this._onContentMouseDown),e.removeEventListener("mouseover",this._onContentMouseOver),e.removeEventListener("click",this._onContentClick),e.removeEventListener("dblclick",this._onContentDblClick),e.removeEventListener("contextmenu",this._onContentContextMenu),window.removeEventListener("mouseup",this._onContentMouseUp),super.destroy()}_onAppendChild(t){super._onAppendChild(t),t instanceof e&&(this._numChildren++,this.class.remove(ft),this._open&&this.class.add(ut),this._treeView&&this._treeView._onAppendTreeViewItem(t))}_onRemoveChild(t){t instanceof e&&(this._numChildren--,0===this._numChildren&&this.class.add(ft),this._treeView&&this._treeView._onRemoveTreeViewItem(t)),super._onRemoveChild(t)}_dfs(e){e(this);let t=this.firstChild;for(;t;)t._dfs(e),t=t.nextSibling}rename(){this.class.add(mt);const e=new me({renderChanges:!1,value:this.text,class:y});e.on("blur",(()=>{e.destroy()})),e.on("destroy",(()=>{this.class.remove(mt),this.focus()})),e.on("change",(t=>{(t=t.trim())&&(this.text=t,e.destroy())})),e.on("disable",(()=>{e.input.removeAttribute("readonly")})),this._containerContents.append(e),e.focus(!0)}focus(){this._containerContents.dom.focus()}blur(){this._containerContents.dom.blur()}set selected(e){e!==this.selected?e?(this._containerContents.class.add(dt),this.emit("select",this),this._treeView&&this._treeView._onChildSelected(this),this.focus()):(this._containerContents.class.remove(dt),this.blur(),this.emit("deselect",this),this._treeView&&this._treeView._onChildDeselected(this)):e&&this.focus()}get selected(){return this._containerContents.class.contains(dt)}set text(e){this._labelText.value!==e&&(this._labelText.value=e,this._treeView&&this._treeView._onChildRename(this,e))}get text(){return this._labelText.value}get textLabel(){return this._labelText}get iconLabel(){return this._labelIcon}set open(e){if(this._open!==e)if(this._open=e,e){if(!this.numChildren)return;this.class.add(ut),this.emit("open",this)}else this.class.remove(ut),this.emit("close",this)}get open(){return this._open}set parentsOpen(t){let s=this.parent;for(;s&&s instanceof e;)s.open=t,s=s.parent}get parentsOpen(){let t=this.parent;for(;t&&t instanceof e;){if(!t.open)return!1;t=t.parent}return!0}set treeView(e){this._treeView=e}get treeView(){return this._treeView}get numChildren(){return this._numChildren}get firstChild(){if(this._numChildren)for(const t of this.dom.childNodes)if(t.ui instanceof e)return t.ui;return null}get lastChild(){if(this._numChildren)for(let t=this.dom.childNodes.length-1;t>=0;t--)if(this.dom.childNodes[t].ui instanceof e)return this.dom.childNodes[t].ui;return null}get nextSibling(){let t=this.dom.nextSibling;for(;t&&!(t.ui instanceof e);)t=t.nextSibling;return t&&t.ui}get previousSibling(){let t=this.dom.previousSibling;for(;t&&!(t.ui instanceof e);)t=t.previousSibling;return t&&t.ui}set icon(e){this._icon!==e&&e.match(/^E\d{0,4}$/)&&(this._icon=e,e?this._labelIcon.dom.setAttribute("data-icon",String.fromCodePoint(parseInt(e,16))):this._labelIcon.dom.removeAttribute("data-icon"))}get icon(){return this._icon}};gt.EVENT_SELECT="select",gt.EVENT_DESELECT="deselect",gt.EVENT_OPEN="open",gt.EVENT_CLOSE="close";const _t="pcui-treeview",vt=`${_t}-item-dragged`,bt=`${_t}-drag-handle`,yt=`${_t}-filtering`,xt=`${yt}-result`,wt="inside",St="before",Ct="after";let Tt=class extends z{constructor(e={}){var t,s,i,n;super(e),this.allowReordering=!0,this.allowRenaming=!1,this._selectedItems=[],this._dragItems=[],this._dragging=!1,this._dragOverItem=null,this._dragArea=wt,this._dragScroll=0,this._dragScrollInterval=null,this._pressedCtrl=!1,this._pressedShift=!1,this._filter=null,this._filterResults=[],this._updateModifierKeys=e=>{this._pressedCtrl=e.ctrlKey||e.metaKey,this._pressedShift=e.shiftKey},this._onMouseLeave=e=>{this._allowDrag&&this._dragging&&(this._dragOverItem=null,this._updateDragHandle())},this._onMouseMove=e=>{if(!this._dragging)return;const t=this.dom.getBoundingClientRect();this._dragScroll=0;let s=t.top,i=t.bottom;if(this._dragScrollElement!==this){const e=this._dragScrollElement.dom.getBoundingClientRect();s=Math.max(s+this._dragScrollElement.dom.scrollTop,e.top),i=Math.min(i+this._dragScrollElement.dom.scrollTop,e.bottom)}s=Math.max(0,s),i=Math.min(i,document.body.clientHeight),e.pageY<s+32&&this._dragScrollElement.dom.scrollTop>0?this._dragScroll=-1:e.pageY>i-32&&this._dragScrollElement.dom.scrollHeight>this._dragScrollElement.height+this._dragScrollElement.dom.scrollTop&&(this._dragScroll=1)},this._onDragMove=e=>{if(e.preventDefault(),e.stopPropagation(),!this._allowDrag||!this._dragOverItem)return;const t=this._dragHandle.dom.getBoundingClientRect(),s=Math.floor((e.clientY-t.top)/t.height*5),i=this._dragArea,n=this._dragOverItem;if(this._dragOverItem.parent===this){let e=!1;for(let t=0;t<this._dragItems.length;t++)if(this._dragItems[t].parent===this._dragOverItem){e=!0,this._dragOverItem=null;break}e||(this._dragArea=wt)}else{let e=!1;for(let t=0;t<this._dragItems.length;t++)if(this._dragItems[t].dom.contains(this._dragOverItem.dom)){e=!0;break}if(e)this._dragOverItem=null;else if(this.allowReordering&&s<=1&&-1===this._dragItems.indexOf(this._dragOverItem.previousSibling))this._dragArea=St;else if(this.allowReordering&&s>=4&&-1===this._dragItems.indexOf(this._dragOverItem.nextSibling)&&(0===this._dragOverItem.numChildren||!this._dragOverItem.open))this._dragArea=Ct;else{let e=!1;if(this.allowReordering&&this._dragOverItem.open)for(let t=0;t<this._dragItems.length;t++)if(this._dragItems[t].parent===this._dragOverItem){e=!0,this._dragArea=St;break}e||(this._dragArea=wt)}}i===this._dragArea&&n===this._dragOverItem||this._updateDragHandle()},this.class.add(_t),this._allowDrag=null===(t=e.allowDrag)||void 0===t||t,this.allowReordering=null===(s=e.allowReordering)||void 0===s||s,this.allowRenaming=null!==(i=e.allowRenaming)&&void 0!==i&&i,this._dragHandle=new M({class:bt,hidden:!0}),this._dragScrollElement=null!==(n=e.dragScrollElement)&&void 0!==n?n:this,this.append(this._dragHandle),this._onContextMenu=e.onContextMenu,this._onReparentFn=e.onReparent,this._wasDraggingAllowedBeforeFiltering=this._allowDrag,window.addEventListener("keydown",this._updateModifierKeys),window.addEventListener("keyup",this._updateModifierKeys),window.addEventListener("mousedown",this._updateModifierKeys),this.dom.addEventListener("mouseleave",this._onMouseLeave),this._dragHandle.dom.addEventListener("mousemove",this._onDragMove),this._dragHandle.on("destroy",(e=>{e.removeEventListener("mousemove",this._onDragMove)}))}destroy(){this._destroyed||(window.removeEventListener("keydown",this._updateModifierKeys),window.removeEventListener("keyup",this._updateModifierKeys),window.removeEventListener("mousedown",this._updateModifierKeys),window.removeEventListener("mousemove",this._onMouseMove),this.dom.removeEventListener("mouseleave",this._onMouseLeave),this._dragScrollInterval&&(window.clearInterval(this._dragScrollInterval),this._dragScrollInterval=null),super.destroy())}_findNextVisibleTreeItem(e){if(e.numChildren>0&&e.open)return e.firstChild;const t=e.nextSibling;if(t)return t;let s=e.parent;if(!(s instanceof gt))return null;let i=s.nextSibling;for(;!i&&(s=s.parent,s instanceof gt);)i=s.nextSibling;return i}_findLastVisibleChildTreeItem(e){if(!e.numChildren||!e.open)return null;let t=e.lastChild;for(;t&&t.numChildren&&t.open;)t=t.lastChild;return t}_findPreviousVisibleTreeItem(e){const t=e.previousSibling;if(t)return t.numChildren>0&&t.open?this._findLastVisibleChildTreeItem(t):t;const s=e.parent;return s instanceof gt?s:null}_getChildrenRange(e,t){const s=[];if(this._filterResults.length){const i=this.dom.querySelectorAll(`.${_t}-item.${xt}`);let n=-1,r=-1;for(let a=0;a<i.length;a++){const o=i[a].ui;if(o===e?n=a:o===t&&(r=a),-1!==n&&-1!==r){const e=n<r?r:n;for(let t=n<r?n:r;t<=e;t++)s.push(i[t].ui);break}}}else{let i=e;const n=e.dom.getBoundingClientRect(),r=t.dom.getBoundingClientRect();if(n.top<r.top)for(;i&&i!==t;)i=this._findNextVisibleTreeItem(i),i&&i!==t&&s.push(i);else for(;i&&i!==t;)i=this._findPreviousVisibleTreeItem(i),i&&i!==t&&s.push(i);s.push(t)}return s}_onAppendChild(e){super._onAppendChild(e),e instanceof gt&&this._onAppendTreeViewItem(e)}_onRemoveChild(e){e instanceof gt&&this._onRemoveTreeViewItem(e),super._onRemoveChild(e)}_onAppendTreeViewItem(e){e.treeView=this,this._filter&&this._searchItems([e],this._filter),e.forEachChild((e=>{e instanceof gt&&this._onAppendTreeViewItem(e)}))}_onRemoveTreeViewItem(e){e.selected=!1,e.forEachChild((e=>{e instanceof gt&&this._onRemoveTreeViewItem(e)}))}_onChildKeyDown(e,t){if(-1!==["Tab","ArrowLeft","ArrowRight","ArrowUp","ArrowDown"].indexOf(e.key))switch(e.preventDefault(),e.stopPropagation(),e.key){case"ArrowLeft":if(t.numChildren>0&&t.open)t.open=!1;else{const e=t.parent;e instanceof gt&&this._selectSingleItem(e)}break;case"ArrowRight":if(t.numChildren>0)if(t.open){const e=t.firstChild;e instanceof gt&&this._selectSingleItem(e)}else t.open=!0;break;case"ArrowDown":if(this._selectedItems.length){const e=this._findNextVisibleTreeItem(t);e&&(this._pressedShift||this._pressedCtrl?e.selected=!0:this._selectSingleItem(e))}break;case"ArrowUp":if(this._selectedItems.length){const e=this._findPreviousVisibleTreeItem(t);e&&(this._pressedShift||this._pressedCtrl?e.selected=!0:this._selectSingleItem(e))}}}_onChildClick(e,t){if(0===e.button&&t.allowSelect)if(this._pressedCtrl)t.selected=!t.selected;else if(this._pressedShift){if(!this._selectedItems.length||1===this._selectedItems.length&&this._selectedItems[0]===t)return void(t.selected=!0);const e=this._selectedItems[this._selectedItems.length-1];this._openHierarchy(e);this._getChildrenRange(e,t).forEach((e=>{e.allowSelect&&(e.selected=!0)}))}else this._selectSingleItem(t)}_traverseDepthFirst(e){function t(s){if(s&&s instanceof gt&&(e(s),s.numChildren))for(const e of s.dom.childNodes)t(e.ui)}for(const e of this.dom.childNodes)t(e.ui)}_getTreeOrder(){const e=new Map;let t=0;return this._traverseDepthFirst((s=>{e.set(s,t++)})),e}_getChildIndex(e,t){return Array.prototype.indexOf.call(t.dom.childNodes,e.dom)-1}_onChildDragStart(e,t){if(this.allowDrag&&!this._dragging){if(this._dragItems=[],-1!==this._selectedItems.indexOf(t)){const e=[];let t=-1;for(let s=0;s<this._selectedItems.length;s++){let i=this._selectedItems[s].parent,n=0,r=!1;for(;i&&i instanceof gt;){if(-1!==this._selectedItems.indexOf(i)){r=!0;break}n++,i=i.parent}if(!r){if(-1===t)t=n;else if(t!==n)return;e.push(this._selectedItems[s])}}this._dragItems=e}else t.class.add(vt),this._dragItems.push(t);this._dragItems.length&&(this._dragItems.forEach((e=>{e.class.add(vt)})),this.isDragging=!0,this.emit("dragstart",this._dragItems.slice()))}}_onChildDragEnd(e,t){if(!this.allowDrag||!this._dragging)return;this._dragItems.forEach((e=>e.class.remove(vt)));let s=!1;for(let e=0;e<this._dragItems.length;e++)if(this._dragItems[e].parent===this){s=!0;break}if(!s&&this._dragOverItem){if(this._dragItems.length>1){const e=this._getTreeOrder();this._dragItems.sort(((t,s)=>e.get(t)-e.get(s)))}if(this._dragItems.length){const e=[];if(this._onReparentFn){const t=[],s=e=>{let s=t.findIndex((t=>t.parent===e));return-1===s&&(t.push({parent:e,children:[...e.dom.childNodes]}),s=t.length-1),t[s].children};this._dragItems.forEach((t=>{if(t.parent===this._dragOverItem&&this._dragArea===wt)return;e.push({item:t,oldParent:t.parent});const i=s(t.parent),n=i.indexOf(t.dom);i.splice(n,1)})),e.forEach(((t,i)=>{if(this._dragArea===St){t.newParent=this._dragOverItem.parent;const e=s(this._dragOverItem.parent),i=e.indexOf(this._dragOverItem.dom);e.splice(i,0,t.item.dom),t.newChildIndex=i}else if(this._dragArea===wt){t.newParent=this._dragOverItem;const e=s(this._dragOverItem);e.push(t.item.dom),t.newChildIndex=e.length-1}else if(this._dragArea===Ct){t.newParent=this._dragOverItem.parent;const n=s(this._dragOverItem.parent),r=i>0?e[i-1].item:this._dragOverItem,a=n.indexOf(r.dom);n.splice(a+1,0,t.item.dom),t.newChildIndex=a+1}t.newChildIndex--}))}else this._dragItems.forEach((t=>{t.parent===this._dragOverItem&&this._dragArea===wt||(e.push({item:t,oldParent:t.parent}),t.parent.remove(t))})),e.forEach(((t,s)=>{this._dragArea===St?(t.newParent=this._dragOverItem.parent,t.newParent.appendBefore(t.item,this._dragOverItem),t.newChildIndex=this._getChildIndex(t.item,t.newParent)):this._dragArea===wt?(t.newParent=this._dragOverItem,t.newParent.append(t.item),t.newParent.open=!0,t.newChildIndex=this._getChildIndex(t.item,t.newParent)):this._dragArea===Ct&&(t.newParent=this._dragOverItem.parent,t.newParent.appendAfter(t.item,s>0?e[s-1].item:this._dragOverItem),t.newChildIndex=this._getChildIndex(t.item,t.newParent))}));e.length&&(this._onReparentFn&&this._onReparentFn(e),this.emit("reparent",e))}}this._dragItems=[],this.isDragging=!1,this.emit("dragend")}_onChildDragOver(e,t){this._allowDrag&&this._dragging&&(t.allowDrop&&-1===this._dragItems.indexOf(t)?this._dragOverItem=t:this._dragOverItem=null,this._updateDragHandle(),this._onDragMove(e))}_scrollWhileDragging(){this._dragging&&0!==this._dragScroll&&(this._dragScrollElement.dom.scrollTop+=8*this._dragScroll,this._dragOverItem=null,this._updateDragHandle())}_updateDragHandle(e,t){if(t||this._allowDrag&&this._dragging)if(e||(e=this._dragOverItem),e&&!e.hidden&&e.parentsOpen){const t=e._containerContents.dom.getBoundingClientRect();this._dragHandle.hidden=!1,this._dragHandle.class.remove(Ct,St,wt),this._dragHandle.class.add(this._dragArea);const s=t.top;let i=t.left,n=t.width;if(this.dom.parentElement){const e=this.dom.parentElement.getBoundingClientRect();i=Math.max(i,e.left),n=Math.min(n,this.dom.parentElement.clientWidth-i+e.left)}this._dragHandle.style.top=`${s}px`,this._dragHandle.style.left=`${i}px`,this._dragHandle.style.width=n-7+"px"}else this._dragHandle.hidden=!0}_openHierarchy(e){e.parentsOpen=!0}_selectSingleItem(e){let t=this._selectedItems.length,s=!1;for(;t--;)this._selectedItems[t]&&this._selectedItems[t]!==e&&(this._selectedItems[t].selected=!1,s=!0);e.selected=!!s||!e.selected}_onChildSelected(e){this._selectedItems.push(e),this._openHierarchy(e),this.emit("select",e)}_onChildDeselected(e){const t=this._selectedItems.indexOf(e);-1!==t&&(this._selectedItems.splice(t,1),this.emit("deselect",e))}_onChildRename(e,t){if(this._filter){e.class.remove(xt);const t=this._filterResults.indexOf(e);-1!==t&&this._filterResults.splice(t,1),this._searchItems([e],this._filter)}this.emit("rename",e,t)}_searchItems(e,t){const s=Se(e,"text",t);s.length&&s.forEach((e=>{this._filterResults.push(e),e.class.add(xt)}))}_applyFilter(e){this._clearFilter(),this._wasDraggingAllowedBeforeFiltering=this._allowDrag,this._allowDrag=!1,this.class.add(yt);const t=[];this._traverseDepthFirst((e=>{t.push(e)})),this._searchItems(t,e)}_clearFilter(){this._filterResults.forEach((e=>{e.destroyed||e.class.remove(xt)})),this._filterResults.length=0,this.class.remove(yt),this._allowDrag=this._wasDraggingAllowedBeforeFiltering}showDragHandle(e){this._updateDragHandle(e,!0)}deselect(){let e=this._selectedItems.length;for(;e--;)this._selectedItems[e]&&(this._selectedItems[e].selected=!1)}clearTreeItems(){let e=this.dom.childNodes.length;for(;e--;){const t=this.dom.childNodes[e];if(!t)continue;const s=t.ui;s instanceof gt&&s.destroy()}this._selectedItems=[],this._dragItems=[],this._allowDrag=this._wasDraggingAllowedBeforeFiltering}set allowDrag(e){this._allowDrag=e,this._filter&&(this._wasDraggingAllowedBeforeFiltering=e)}get allowDrag(){return this._allowDrag}set isDragging(e){this._dragging!==e&&(e?(this._dragging=!0,this._updateDragHandle(),(this.scrollable||this._dragScrollElement!==this)&&(window.removeEventListener("mousemove",this._onMouseMove),window.addEventListener("mousemove",this._onMouseMove),this._dragScrollInterval||(this._dragScrollInterval=window.setInterval((()=>{this._scrollWhileDragging()}),1e3/60)))):(this._dragOverItem=null,this._updateDragHandle(),this._dragging=!1,window.removeEventListener("mousemove",this._onMouseMove),this._dragScrollInterval&&(window.clearInterval(this._dragScrollInterval),this._dragScrollInterval=null)))}get isDragging(){return this._dragging}get selected(){return this._selectedItems.slice()}set filter(e){this._filter!==e&&(this._filter=e,e?this._applyFilter(e):this._clearFilter())}get filter(){return this._filter}get pressedCtrl(){return this._pressedCtrl}get pressedShift(){return this._pressedShift}};Tt.EVENT_DRAGSTART="dragstart",Tt.EVENT_DRAGEND="dragend",Tt.EVENT_REPARENT="reparent",Tt.EVENT_SELECT="select",Tt.EVENT_DESELECT="deselect",Tt.EVENT_RENAME="rename";class Et extends D{constructor(e){super(e),this.element=new Tt(Object.assign({},e)),this.loadChildren(this.props.children,this.element)}loadChildren(e,t){e&&(Array.isArray(e)||(e=[e]),e.forEach((e=>{const s=new gt({text:e.props.text,icon:e.props.icon,open:!1});e.props.onSelect&&s.on("select",e.props.onSelect),e.props.onDeselect&&s.on("deselect",e.props.onDeselect),t.append(s),this.loadChildren(e.props.children,s)})))}componentDidUpdate(){this.parentElement.removeChild(this.element.dom),this.element=new Tt(Object.assign({},this.props)),this.loadChildren(this.props.children,this.element),this.parentElement.appendChild(this.element.dom)}parentElementRendered(e){e&&(this.parentElement=e,this.parentElement.appendChild(this.element.dom))}render(){return d.createElement("div",{ref:this.parentElementRendered.bind(this)})}}Et.ctor=Tt;class Pt extends D{constructor(e){super(e),this.elementClass=gt,this.onSelect=()=>{e.onSelect&&e.onSelect((()=>{this.element.selected=!1}))},e.onDeselect&&(this.onDeselect=e.onDeselect),this.onAttach=this.onAttachFn.bind(this)}onAttachFn(){this.props.onSelect&&this.element.on("select",this.onSelect),this.props.onDeselect&&this.element.on("deselect",this.onDeselect)}render(){return super.render()}}Pt.ctor=gt;let kt=class extends M{constructor(e={}){var t,s,i;const n=Object.assign({},e);delete n.binding,super(n),this._inputs=[],this._applyingChange=!1,this._bindAllInputs=!1,this.class.add("pcui-vector-input");const r=Math.max(2,Math.min(4,null!==(t=e.dimensions)&&void 0!==t?t:3));for(let t=0;t<r;t++){const n=new W({min:e.min,max:e.max,precision:null!==(s=e.precision)&&void 0!==s?s:7,step:null!==(i=e.step)&&void 0!==i?i:1,stepPrecision:e.stepPrecision,renderChanges:e.renderChanges,placeholder:e.placeholder?Array.isArray(e.placeholder)?e.placeholder[t]:e.placeholder:null});n.on("slider:mousedown",(e=>{if(this._bindAllInputs=!!e.altKey,this._bindAllInputs){n.focus();for(let e=0;e<this._inputs.length;e++)this._inputs[e].class.add(b);this.binding&&(this.binding.historyCombine=!0)}})),n.on("slider:mouseup",(()=>{this._onInputChange(n),this._bindAllInputs=!1;for(let e=0;e<this._inputs.length;e++)this._inputs[e].class.remove(b);n.blur(),this.binding&&(this.binding.historyCombine=!1)})),n.on("change",(()=>{this._onInputChange(n)})),n.on("focus",(()=>{this.emit("focus")})),n.on("blur",(()=>{this.emit("blur")})),this.dom.appendChild(n.dom),n.parent=this,this._inputs.push(n)}e.binding&&(this.binding=e.binding),void 0!==e.value&&(this.value=e.value)}_onInputChange(e){if(this._applyingChange)return;const t=this._inputs.some((e=>e.class.contains(C)));if(t?this.class.add(C):this.class.remove(C),this._bindAllInputs){const t=Array(this._inputs.length).fill(e.value);this._updateValue(t)&&this._binding&&this._binding.setValue(t)}else this.emit("change",this.value)}_updateValue(e){return this.class.remove(C),JSON.stringify(this.value)!==JSON.stringify(e)&&(this._applyingChange=!0,this._inputs.forEach(((t,s)=>{const i=t.binding;let n=!1;i&&(n=i.applyingChange,i.applyingChange=!0),t.value=e&&void 0!==e[s]?e[s]:null,i&&(i.applyingChange=n)})),this.emit("change",this.value),this._applyingChange=!1,!0)}link(e,t){super.link(e,t),e=Array.isArray(e)?e:[e];if(1===(t=Array.isArray(t)?t:[t]).length||e.length!==t.length)for(let s=0;s<this._inputs.length;s++)this._inputs[s].link(e,`${t[0]}.${s}`);else for(let s=0;s<this._inputs.length;s++)this._inputs[s].link(e,t.map((e=>`${e}.${s}`)))}unlink(){super.unlink();for(const e of this._inputs)e.unlink()}focus(){this._inputs[0].focus()}blur(){for(const e of this._inputs)e.blur()}set value(e){if("string"==typeof e)try{if(e=JSON.parse(e),Array.isArray(e)&&e.some((e=>!Number.isFinite(e))))throw new Error("VectorInput value set to string which doesn't contain an array of numbers")}catch(t){console.error(t),e=[]}Array.isArray(e)||(e=[]);this._updateValue(e)&&this._binding&&this._binding.setValue(e)}get value(){return this._inputs.map((e=>e.value))}set values(e){e=this._inputs.map(((t,s)=>e.map((e=>e?e[s]:void 0)))),this._inputs.forEach(((t,s)=>{t.values=e[s]}))}set binding(e){super.binding=e;for(const t of this._inputs)t.binding=e?e.clone():null}get binding(){return super.binding}set placeholder(e){for(let t=0;t<this._inputs.length;t++)this._inputs[t].placeholder=e[t]||e||null}get placeholder(){return this._inputs.map((e=>e.placeholder))}get inputs(){return this._inputs.slice()}set renderChanges(e){for(const t of this._inputs)t.renderChanges=e}get renderChanges(){return this._inputs[0].renderChanges}set min(e){for(const t of this._inputs)t.min=e}get min(){return this._inputs[0].min}set max(e){for(const t of this._inputs)t.max=e}get max(){return this._inputs[0].max}set precision(e){for(const t of this._inputs)t.precision=e}get precision(){return this._inputs[0].precision}set step(e){for(const t of this._inputs)t.step=e}get step(){return this._inputs[0].step}};M.register("vec2",kt,{dimensions:2,renderChanges:!0}),M.register("vec3",kt,{dimensions:3,renderChanges:!0}),M.register("vec4",kt,{dimensions:4,renderChanges:!0});class At extends D{constructor(e){super(e),this.elementClass=kt}render(){return super.render()}}At.ctor=kt;const Mt="2.3.3",Dt="eb1a80f";function Rt(e,t){for(const s in t){const i=t[s];Array.isArray(i)?e[s]=Rt([],i):e[s]=i&&"object"==typeof i?Rt({},i):i}return e}const Lt={create:()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))},It={delimiter:"/",join(...e){let t=e[0];for(let s=0;s<e.length-1;s++){const i=e[s],n=e[s+1];n[0]!==It.delimiter?i&&n&&i[i.length-1]!==It.delimiter&&n[0]!==It.delimiter?t+=It.delimiter+n:t+=n:t=n}return t},normalize(e){const t=e.startsWith(It.delimiter),s=e.endsWith(It.delimiter),i=e.split("/");let n="",r=[];for(let e=0;e<i.length;e++)""!==i[e]&&"."!==i[e]&&(".."===i[e]&&r.length>0?r=r.slice(0,r.length-2):(e>0&&r.push(It.delimiter),r.push(i[e])));return n=r.join(""),t||n[0]!==It.delimiter||(n=n.slice(1)),s&&n[n.length-1]!==It.delimiter&&(n+=It.delimiter),n},split(e){const t=e.lastIndexOf(It.delimiter);return-1!==t?[e.substring(0,t),e.substring(t+1)]:["",e]},getBasename:e=>It.split(e)[1],getDirectory:e=>It.split(e)[0],getExtension(e){const t=e.split("?")[0].split(".").pop();return t!==e?`.${t}`:""},isRelativePath:e=>"/"!==e.charAt(0)&&null===e.match(/:\/\//),extractPath(e){let t="";const s=e.split("/");let i=0;if(s.length>1)if(It.isRelativePath(e))if("."===s[0])for(i=0;i<s.length-1;++i)t+=0===i?s[i]:`/${s[i]}`;else if(".."===s[0])for(i=0;i<s.length-1;++i)t+=0===i?s[i]:`/${s[i]}`;else for(t=".",i=0;i<s.length-1;++i)t+=`/${s[i]}`;else for(i=0;i<s.length-1;++i)t+=0===i?s[i]:`/${s[i]}`;return t}};var Ft,Ot,Bt;const zt="undefined"!=typeof navigator?navigator.userAgent:"",Nt="undefined"!=typeof window?"browser":"undefined"!=typeof global?"node":"worker",Ut=/android/i.test(zt)?"android":/ip(?:[ao]d|hone)/i.test(zt)?"ios":/windows/i.test(zt)?"windows":/mac os/i.test(zt)?"osx":/linux/i.test(zt)?"linux":/cros/i.test(zt)?"cros":null,Vt="browser"!==Nt?null:/Chrome\/|Chromium\/|Edg.*\//.test(zt)?"chrome":/Safari\//.test(zt)?"safari":/Firefox\//.test(zt)?"firefox":"other",Gt=/xbox/i.test(zt),Ht="browser"===Nt&&("ontouchstart"in window||"maxTouchPoints"in navigator&&navigator.maxTouchPoints>0),jt=!("browser"!==Nt||!navigator.getGamepads&&!navigator.webkitGetGamepads),Wt="undefined"!=typeof Worker,$t=(()=>{let e=!1;try{const t=Object.defineProperty({},"passive",{get:function(){return e=!0,!1}});window.addEventListener("testpassive",null,t),window.removeEventListener("testpassive",null,t)}catch(e){}return e})(),qt={name:Ut,environment:Nt,global:null!=(Ft=null!=(Ot=null!=(Bt="undefined"!=typeof globalThis&&globalThis)?Bt:"browser"===Nt&&window)?Ot:"node"===Nt&&global)?Ft:"worker"===Nt&&self,browser:"browser"===Nt,worker:"worker"===Nt,desktop:["windows","osx","linux","cros"].includes(Ut),mobile:["android","ios"].includes(Ut),ios:"ios"===Ut,android:"android"===Ut,xbox:Gt,gamepads:jt,touch:Ht,workers:Wt,passiveEvents:$t,browserName:Vt};class Xt{constructor(e,t,s,i,n=!1){this.handler=void 0,this.name=void 0,this.callback=void 0,this.scope=void 0,this._once=void 0,this._removed=!1,this.handler=e,this.name=t,this.callback=s,this.scope=i,this._once=n}off(){this._removed||this.handler.offByHandle(this)}on(e,t,s=this){return this.handler._addCallback(e,t,s,!1)}once(e,t,s=this){return this.handler._addCallback(e,t,s,!0)}set removed(e){e&&(this._removed=!0)}get removed(){return this._removed}}class Kt{constructor(){this._callbacks=new Map,this._callbackActive=new Map}initEventHandler(){this._callbacks=new Map,this._callbackActive=new Map}_addCallback(e,t,s,i){if(this._callbacks.has(e)||this._callbacks.set(e,[]),this._callbackActive.has(e)){const t=this._callbackActive.get(e);t&&t===this._callbacks.get(e)&&this._callbackActive.set(e,t.slice())}const n=new Xt(this,e,t,s,i);return this._callbacks.get(e).push(n),n}on(e,t,s=this){return this._addCallback(e,t,s,!1)}once(e,t,s=this){return this._addCallback(e,t,s,!0)}off(e,t,s){if(e)this._callbackActive.has(e)&&this._callbackActive.get(e)===this._callbacks.get(e)&&this._callbackActive.set(e,this._callbackActive.get(e).slice());else for(const[e,t]of this._callbackActive)this._callbacks.has(e)&&this._callbacks.get(e)===t&&this._callbackActive.set(e,t.slice());if(e)if(t){const i=this._callbacks.get(e);if(!i)return this;for(let e=0;e<i.length;e++)i[e].callback===t&&(s&&i[e].scope!==s||(i[e].removed=!0,i.splice(e,1),e--));0===i.length&&this._callbacks.delete(e)}else{const t=this._callbacks.get(e);if(t){for(let e=0;e<t.length;e++)t[e].removed=!0;this._callbacks.delete(e)}}else{for(const e of this._callbacks.values())for(let t=0;t<e.length;t++)e[t].removed=!0;this._callbacks.clear()}return this}offByHandle(e){const t=e.name;e.removed=!0,this._callbackActive.has(t)&&this._callbackActive.get(t)===this._callbacks.get(t)&&this._callbackActive.set(t,this._callbackActive.get(t).slice());const s=this._callbacks.get(t);if(!s)return this;const i=s.indexOf(e);return-1!==i&&(s.splice(i,1),0===s.length&&this._callbacks.delete(t)),this}fire(e,t,s,i,n,r,a,o,l){if(!e)return this;const h=this._callbacks.get(e);if(!h)return this;let c;this._callbackActive.has(e)?this._callbackActive.get(e)!==h&&(c=h.slice()):this._callbackActive.set(e,h);for(let h=0;(c||this._callbackActive.get(e))&&h<(c||this._callbackActive.get(e)).length;h++){const d=(c||this._callbackActive.get(e))[h];if(d.callback&&(d.callback.call(d.scope,t,s,i,n,r,a,o,l),d._once)){const t=this._callbacks.get(e),s=t?t.indexOf(d):-1;if(-1!==s){this._callbackActive.get(e)===t&&this._callbackActive.set(e,this._callbackActive.get(e).slice());const i=this._callbacks.get(e);if(!i)continue;i[s].removed=!0,i.splice(s,1),0===i.length&&this._callbacks.delete(e)}}}return c||this._callbackActive.delete(e),this}hasEvent(e){var t;return!(null==(t=this._callbacks.get(e))||!t.length)}}class Yt{static loadScript(e,t){const s=document.createElement("script");s.setAttribute("src",e),s.onload=()=>{t(null)},s.onerror=()=>{t(`Failed to load script='${e}'`)},document.body.appendChild(s)}static loadWasm(e,t,s){const i=Yt.wasmSupported()&&t.glueUrl&&t.wasmUrl?t.glueUrl:t.fallbackUrl;i?Yt.loadScript(i,(i=>{if(i)s(i,null);else{const i=window[e];window[e]=void 0,i({locateFile:()=>t.wasmUrl,onAbort:()=>{s("wasm module aborted.")}}).then((e=>{s(null,e)}))}})):s("No supported wasm modules found.",null)}static getModule(e){return Yt.modules.hasOwnProperty(e)||(Yt.modules[e]={config:null,initializing:!1,instance:null,callbacks:[]}),Yt.modules[e]}static initialize(e,t){if(t.initializing)return;const s=t.config;(s.glueUrl||s.wasmUrl||s.fallbackUrl)&&(t.initializing=!0,Yt.loadWasm(e,s,((i,n)=>{i?s.errorHandler?s.errorHandler(i):console.error(`failed to initialize module=${e} error=${i}`):(t.instance=n,t.callbacks.forEach((e=>{e(n)})))})))}}Yt.modules={},Yt.wasmSupported=(e=>{const t={};let s=t;return()=>(s===t&&(s=e()),s)})((()=>{try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){const e=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(e instanceof WebAssembly.Module)return new WebAssembly.Instance(e)instanceof WebAssembly.Instance}}catch(e){}return!1}));class Qt{static setConfig(e,t){const s=Yt.getModule(e);s.config=t,s.callbacks.length>0&&Yt.initialize(e,s)}static getConfig(e){var t;return null==(t=Yt.modules)||null==(t=t[e])?void 0:t.config}static getInstance(e,t){const s=Yt.getModule(e);s.instance?t(s.instance):(s.callbacks.push(t),s.config&&Yt.initialize(e,s))}}class Jt{constructor(e){this.arraybuffer=void 0,this.dataView=void 0,this.offset=0,this.arraybuffer=e,this.dataView=new DataView(e)}get remainingBytes(){return this.dataView.byteLength-this.offset}reset(e=0){this.offset=e}skip(e){this.offset+=e}align(e){this.offset=this.offset+e-1&~(e-1)}_inc(e){return this.offset+=e,this.offset-e}readChar(){return String.fromCharCode(this.dataView.getUint8(this.offset++))}readChars(e){let t="";for(let s=0;s<e;++s)t+=this.readChar();return t}readU8(){return this.dataView.getUint8(this.offset++)}readU16(){return this.dataView.getUint16(this._inc(2),!0)}readU32(){return this.dataView.getUint32(this._inc(4),!0)}readU64(){return this.readU32()+2**32*this.readU32()}readU32be(){return this.dataView.getUint32(this._inc(4),!1)}readArray(e){for(let t=0;t<e.length;++t)e[t]=this.readU8()}readLine(){const e=this.dataView;let t="";for(;!(this.offset>=e.byteLength);){const e=String.fromCharCode(this.readU8());if("\n"===e)break;t+=e}return t}}class Zt{constructor(e){this.items=[],this.length=0,this.loopIndex=-1,this._sortBy=void 0,this._sortHandler=void 0,this._sortBy=e.sortBy,this._sortHandler=this._doSort.bind(this)}_binarySearch(e){let t=0,s=this.items.length-1;const i=e[this._sortBy];let n,r;for(;t<=s;)n=Math.floor((t+s)/2),r=this.items[n][this._sortBy],r<=i?t=n+1:r>i&&(s=n-1);return t}_doSort(e,t){const s=this._sortBy;return e[s]-t[s]}insert(e){const t=this._binarySearch(e);this.items.splice(t,0,e),this.length++,this.loopIndex>=t&&this.loopIndex++}append(e){this.items.push(e),this.length++}remove(e){const t=this.items.indexOf(e);t<0||(this.items.splice(t,1),this.length--,this.loopIndex>=t&&this.loopIndex--)}sort(){const e=this.loopIndex>=0?this.items[this.loopIndex]:null;this.items.sort(this._sortHandler),null!==e&&(this.loopIndex=this.items.indexOf(e))}}class es extends Kt{constructor(e){super(),this._index={},this._list=[],this._parent=e}add(...e){let t=!1;const s=this._processArguments(e,!0);if(!s.length)return t;for(let e=0;e<s.length;e++)this._index[s[e]]||(t=!0,this._index[s[e]]=!0,this._list.push(s[e]),this.fire("add",s[e],this._parent));return t&&this.fire("change",this._parent),t}remove(...e){let t=!1;if(!this._list.length)return t;const s=this._processArguments(e,!0);if(!s.length)return t;for(let e=0;e<s.length;e++)this._index[s[e]]&&(t=!0,delete this._index[s[e]],this._list.splice(this._list.indexOf(s[e]),1),this.fire("remove",s[e],this._parent));return t&&this.fire("change",this._parent),t}clear(){if(!this._list.length)return;const e=this._list.slice(0);this._list=[],this._index={};for(let t=0;t<e.length;t++)this.fire("remove",e[t],this._parent);this.fire("change",this._parent)}has(...e){return!!this._list.length&&this._has(this._processArguments(e))}_has(e){if(!this._list.length||!e.length)return!1;for(let t=0;t<e.length;t++)if(1===e[t].length){if(this._index[e[t][0]])return!0}else{let s=!0;for(let i=0;i<e[t].length;i++)if(!this._index[e[t][i]]){s=!1;break}if(s)return!0}return!1}list(){return this._list.slice(0)}_processArguments(e,t){const s=[];let i=[];if(!e||!e.length)return s;for(let n=0;n<e.length;n++)if(e[n]instanceof Array){t||(i=[]);for(let r=0;r<e[n].length;r++)"string"==typeof e[n][r]&&(t?s.push(e[n][r]):i.push(e[n][r]));!t&&i.length&&s.push(i)}else"string"==typeof e[n]&&(t?s.push(e[n]):s.push([e[n]]));return s}get size(){return this._list.length}}es.EVENT_ADD="add",es.EVENT_REMOVE="remove",es.EVENT_CHANGE="change";const ts="undefined"!=typeof window&&window.performance&&window.performance.now?performance.now.bind(performance):Date.now,ss=/^(([^:/?#]+):)?(\/\/([^/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/;class is{constructor(e){this.scheme=void 0,this.authority=void 0,this.path=void 0,this.query=void 0,this.fragment=void 0;const t=e.match(ss);this.scheme=t[2],this.authority=t[4],this.path=t[5],this.query=t[7],this.fragment=t[9]}toString(){let e="";return this.scheme&&(e+=`${this.scheme}:`),this.authority&&(e+=`//${this.authority}`),e+=this.path,this.query&&(e+=`?${this.query}`),this.fragment&&(e+=`#${this.fragment}`),e}getQuery(){const e={};if(this.query){const t=decodeURIComponent(this.query).split("&");for(const s of t){const t=s.split("=");e[t[0]]=t[1]}}return e}setQuery(e){let t="";for(const s in e)e.hasOwnProperty(s)&&(""!==t&&(t+="&"),t+=`${encodeURIComponent(s)}=${encodeURIComponent(e[s])}`);this.query=t}}class ns{static set(e,t=!0){}static get(e){return ns._traceChannels.has(e)}}ns._traceChannels=new Set,ns.stack=!1;const rs={DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,clamp:(e,t,s)=>e>=s?s:e<=t?t:e,intToBytes24:e=>[e>>16&255,e>>8&255,255&e],intToBytes32:e=>[e>>24&255,e>>16&255,e>>8&255,255&e],bytesToInt24:(e,t,s)=>(e.length&&(s=e[2],t=e[1],e=e[0]),e<<16|t<<8|s),bytesToInt32:(e,t,s,i)=>(e.length&&(i=e[3],s=e[2],t=e[1],e=e[0]),(e<<24|t<<16|s<<8|i)>>>0),lerp:(e,t,s)=>e+(t-e)*rs.clamp(s,0,1),lerpAngle:(e,t,s)=>(t-e>180&&(t-=360),t-e<-180&&(t+=360),rs.lerp(e,t,rs.clamp(s,0,1))),powerOfTwo:e=>0!==e&&!(e&e-1),nextPowerOfTwo:e=>(e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e),nearestPowerOfTwo:e=>Math.pow(2,Math.round(Math.log(e)/Math.log(2))),random(e,t){const s=t-e;return Math.random()*s+e},smoothstep:(e,t,s)=>s<=e?0:s>=t?1:(s=(s-e)/(t-e))*s*(3-2*s),smootherstep:(e,t,s)=>s<=e?0:s>=t?1:(s=(s-e)/(t-e))*s*s*(s*(6*s-15)+10),roundUp:(e,t)=>0===t?e:Math.ceil(e/t)*t,between(e,t,s,i){const n=Math.min(t,s),r=Math.max(t,s);return i?e>=n&&e<=r:e>n&&e<r}};var as;class os{constructor(e=0,t=0,s=0,i=1){this.r=void 0,this.g=void 0,this.b=void 0,this.a=void 0;const n=e.length;var r;3===n||4===n?(this.r=e[0],this.g=e[1],this.b=e[2],this.a=null!=(r=e[3])?r:1):(this.r=e,this.g=t,this.b=s,this.a=i)}clone(){return new(0,this.constructor)(this.r,this.g,this.b,this.a)}copy(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this}equals(e){return this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a}set(e,t,s,i=1){return this.r=e,this.g=t,this.b=s,this.a=i,this}lerp(e,t,s){return this.r=e.r+s*(t.r-e.r),this.g=e.g+s*(t.g-e.g),this.b=e.b+s*(t.b-e.b),this.a=e.a+s*(t.a-e.a),this}linear(e=this){return this.r=Math.pow(e.r,2.2),this.g=Math.pow(e.g,2.2),this.b=Math.pow(e.b,2.2),this.a=e.a,this}gamma(e=this){return this.r=Math.pow(e.r,1/2.2),this.g=Math.pow(e.g,1/2.2),this.b=Math.pow(e.b,1/2.2),this.a=e.a,this}mulScalar(e){return this.r*=e,this.g*=e,this.b*=e,this}fromString(e){const t=parseInt(e.replace("#","0x"),16);let s;return e.length>7?s=rs.intToBytes32(t):(s=rs.intToBytes24(t),s[3]=255),this.set(s[0]/255,s[1]/255,s[2]/255,s[3]/255),this}toString(e){let t=`#${((1<<24)+(Math.round(255*this.r)<<16)+(Math.round(255*this.g)<<8)+Math.round(255*this.b)).toString(16).slice(1)}`;if(!0===e){const e=Math.round(255*this.a).toString(16);this.a<16/255?t+=`0${e}`:t+=e}return t}}as=os,os.BLACK=Object.freeze(new as(0,0,0,1)),os.BLUE=Object.freeze(new as(0,0,1,1)),os.CYAN=Object.freeze(new as(0,1,1,1)),os.GRAY=Object.freeze(new as(.5,.5,.5,1)),os.GREEN=Object.freeze(new as(0,1,0,1)),os.MAGENTA=Object.freeze(new as(1,0,1,1)),os.RED=Object.freeze(new as(1,0,0,1)),os.WHITE=Object.freeze(new as(1,1,1,1)),os.YELLOW=Object.freeze(new as(1,1,0,1));class ls{constructor(e,t=0){this._curve=void 0,this._left=-1/0,this._right=1/0,this._recip=0,this._p0=0,this._p1=0,this._m0=0,this._m1=0,this._curve=e,this._reset(t)}evaluate(e,t=!1){let s;(t||e<this._left||e>=this._right)&&this._reset(e);const i=this._curve.type;if(5===i)s=this._p0;else{const t=0===this._recip?0:(e-this._left)*this._recip;s=0===i?rs.lerp(this._p0,this._p1,t):1===i?rs.lerp(this._p0,this._p1,t*t*(3-2*t)):this._evaluateHermite(this._p0,this._p1,this._m0,this._m1,t)}return s}_reset(e){const t=this._curve.keys,s=t.length;if(s)if(e<t[0][0])this._left=-1/0,this._right=t[0][0],this._recip=0,this._p0=this._p1=t[0][1],this._m0=this._m1=0;else if(e>=t[s-1][0])this._left=t[s-1][0],this._right=1/0,this._recip=0,this._p0=this._p1=t[s-1][1],this._m0=this._m1=0;else{let s=0;for(;e>=t[s+1][0];)s++;this._left=t[s][0],this._right=t[s+1][0];const i=1/(this._right-this._left);this._recip=isFinite(i)?i:0,this._p0=t[s][1],this._p1=t[s+1][1],4===this._curve.type&&this._calcTangents(t,s)}else this._left=-1/0,this._right=1/0,this._recip=0,this._p0=this._p1=this._m0=this._m1=0}_calcTangents(e,t){let s;const i=e[t],n=e[t+1];let r;if(s=0===t?[e[0][0]+(e[0][0]-e[1][0]),e[0][1]+(e[0][1]-e[1][1])]:e[t-1],r=t===e.length-2?[e[t+1][0]+(e[t+1][0]-e[t][0]),e[t+1][1]+(e[t+1][1]-e[t][1])]:e[t+2],4===this._curve.type){const e=2*(n[0]-i[0])/(n[0]-s[0]),t=2*(n[0]-i[0])/(r[0]-i[0]);this._m0=this._curve.tension*(isFinite(e)?e:0)*(n[1]-s[1]),this._m1=this._curve.tension*(isFinite(t)?t:0)*(r[1]-i[1])}else{const e=(n[0]-i[0])/(i[0]-s[0]),t=(n[0]-i[0])/(r[0]-n[0]),a=i[1]+(s[1]-i[1])*(isFinite(e)?e:0),o=n[1]+(r[1]-n[1])*(isFinite(t)?t:0),l=this._curve.tension;this._m0=l*(n[1]-a),this._m1=l*(o-i[1])}}_evaluateHermite(e,t,s,i,n){const r=n*n,a=n+n,o=1-n,l=o*o;return e*((1+a)*l)+s*(n*l)+t*(r*(3-a))+i*(r*(n-1))}}class hs{constructor(e){if(this.keys=[],this.type=1,this.tension=.5,this._eval=new ls(this),e)for(let t=0;t<e.length-1;t+=2)this.keys.push([e[t],e[t+1]]);this.sort()}get length(){return this.keys.length}add(e,t){const s=this.keys,i=s.length;let n=0;for(;n<i&&!(s[n][0]>e);n++);const r=[e,t];return this.keys.splice(n,0,r),r}get(e){return this.keys[e]}sort(){this.keys.sort(((e,t)=>e[0]-t[0]))}value(e){return this._eval.evaluate(e,!0)}closest(e){const t=this.keys,s=t.length;let i=2,n=null;for(let r=0;r<s;r++){const s=Math.abs(e-t[r][0]);if(!(i>=s))break;i=s,n=t[r]}return n}clone(){const e=new this.constructor;return e.keys=this.keys.map((e=>[...e])),e.type=this.type,e.tension=this.tension,e}quantize(e){e=Math.max(e,2);const t=new Float32Array(e),s=1/(e-1);t[0]=this._eval.evaluate(0,!0);for(let i=1;i<e;i++)t[i]=this._eval.evaluate(s*i);return t}quantizeClamped(e,t,s){const i=this.quantize(e);for(let e=0;e<i.length;++e)i[e]=Math.min(s,Math.max(t,i[e]));return i}}class cs{constructor(){if(this.curves=[],this._type=1,arguments.length>1)for(let e=0;e<arguments.length;e++)this.curves.push(new hs(arguments[e]));else if(0===arguments.length)this.curves.push(new hs);else{const e=arguments[0];if("number"==typeof e)for(let t=0;t<e;t++)this.curves.push(new hs);else for(let t=0;t<e.length;t++)this.curves.push(new hs(e[t]))}}get length(){return this.curves.length}set type(e){this._type=e;for(let t=0;t<this.curves.length;t++)this.curves[t].type=e}get type(){return this._type}get(e){return this.curves[e]}value(e,t=[]){const s=this.curves.length;t.length=s;for(let i=0;i<s;i++)t[i]=this.curves[i].value(e);return t}clone(){const e=new this.constructor;e.curves=[];for(let t=0;t<this.curves.length;t++)e.curves.push(this.curves[t].clone());return e._type=this._type,e}quantize(e){e=Math.max(e,2);const t=this.curves.length,s=new Float32Array(e*t),i=1/(e-1);for(let n=0;n<t;n++){const r=new ls(this.curves[n]);for(let a=0;a<e;a++)s[a*t+n]=r.evaluate(i*a)}return s}quantizeClamped(e,t,s){const i=this.quantize(e);for(let e=0;e<i.length;++e)i[e]=Math.min(s,Math.max(t,i[e]));return i}}const ds=1/255,us=new Float32Array(1),ps=new Int32Array(us.buffer);class fs{static float2Half(e){us[0]=e;const t=ps[0];let s=t>>16&32768,i=t>>12&2047;const n=t>>23&255;return n<103?s:n>142?(s|=31744,s|=(255===n?0:1)&&8388607&t,s):n<113?(i|=2048,s|=(i>>114-n)+(i>>113-n&1),s):(s|=n-112<<10|i>>1,s+=1&i,s)}static float2Bytes(e,t,s,i){const n=255*e%1;if(t[s+0]=Math.round(255*(e%1-ds*n)),i>1){const r=65025*e%1;if(t[s+1]=Math.round(255*(n-ds*r)),i>2){const n=16581375*e%1;t[s+2]=Math.round(255*(r-ds*n)),i>3&&(t[s+3]=Math.round(255*n))}}}static float2BytesRange(e,t,s,i,n,r){e=rs.clamp((e-i)/(n-i),0,1),fs.float2Bytes(e,t,s,r)}}var ms,gs,_s,vs,bs;class ys{constructor(e=0,t=0,s=0){this.x=void 0,this.y=void 0,this.z=void 0,3===e.length?(this.x=e[0],this.y=e[1],this.z=e[2]):(this.x=e,this.y=t,this.z=s)}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}add2(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this}addScaled(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this}clone(){return new(0,this.constructor)(this.x,this.y,this.z)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}cross(e,t){const s=e.x,i=e.y,n=e.z,r=t.x,a=t.y,o=t.z;return this.x=i*o-a*n,this.y=n*r-o*s,this.z=s*a-r*i,this}distance(e){const t=this.x-e.x,s=this.y-e.y,i=this.z-e.z;return Math.sqrt(t*t+s*s+i*i)}div(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}div2(e,t){return this.x=e.x/t.x,this.y=e.y/t.y,this.z=e.z/t.z,this}divScalar(e){return this.x/=e,this.y/=e,this.z/=e,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}equals(e){return this.x===e.x&&this.y===e.y&&this.z===e.z}equalsApprox(e,t=1e-6){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}lerp(e,t,s){return this.x=e.x+s*(t.x-e.x),this.y=e.y+s*(t.y-e.y),this.z=e.z+s*(t.z-e.z),this}mul(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}mul2(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this}mulScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}normalize(e=this){const t=e.x*e.x+e.y*e.y+e.z*e.z;if(t>0){const s=1/Math.sqrt(t);this.x=e.x*s,this.y=e.y*s,this.z=e.z*s}return this}floor(e=this){return this.x=Math.floor(e.x),this.y=Math.floor(e.y),this.z=Math.floor(e.z),this}ceil(e=this){return this.x=Math.ceil(e.x),this.y=Math.ceil(e.y),this.z=Math.ceil(e.z),this}round(e=this){return this.x=Math.round(e.x),this.y=Math.round(e.y),this.z=Math.round(e.z),this}min(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z),this}max(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z),this}project(e){const t=(this.x*e.x+this.y*e.y+this.z*e.z)/(e.x*e.x+e.y*e.y+e.z*e.z);return this.x=e.x*t,this.y=e.y*t,this.z=e.z*t,this}set(e,t,s){return this.x=e,this.y=t,this.z=s,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}sub2(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this}toString(){return`[${this.x}, ${this.y}, ${this.z}]`}}ms=ys,ys.ZERO=Object.freeze(new ms(0,0,0)),ys.HALF=Object.freeze(new ms(.5,.5,.5)),ys.ONE=Object.freeze(new ms(1,1,1)),ys.UP=Object.freeze(new ms(0,1,0)),ys.DOWN=Object.freeze(new ms(0,-1,0)),ys.RIGHT=Object.freeze(new ms(1,0,0)),ys.LEFT=Object.freeze(new ms(-1,0,0)),ys.FORWARD=Object.freeze(new ms(0,0,-1)),ys.BACK=Object.freeze(new ms(0,0,1));class xs{constructor(){this.data=new Float32Array(9),this.data[0]=this.data[4]=this.data[8]=1}clone(){return(new(0,this.constructor)).copy(this)}copy(e){const t=e.data,s=this.data;return s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3],s[4]=t[4],s[5]=t[5],s[6]=t[6],s[7]=t[7],s[8]=t[8],this}set(e){const t=this.data;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],this}getX(e=new ys){return e.set(this.data[0],this.data[1],this.data[2])}getY(e=new ys){return e.set(this.data[3],this.data[4],this.data[5])}getZ(e=new ys){return e.set(this.data[6],this.data[7],this.data[8])}equals(e){const t=this.data,s=e.data;return t[0]===s[0]&&t[1]===s[1]&&t[2]===s[2]&&t[3]===s[3]&&t[4]===s[4]&&t[5]===s[5]&&t[6]===s[6]&&t[7]===s[7]&&t[8]===s[8]}isIdentity(){const e=this.data;return 1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&1===e[4]&&0===e[5]&&0===e[6]&&0===e[7]&&1===e[8]}setIdentity(){const e=this.data;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,this}toString(){return`[${this.data.join(", ")}]`}transpose(e=this){const t=e.data,s=this.data;if(t===s){let e;e=t[1],s[1]=t[3],s[3]=e,e=t[2],s[2]=t[6],s[6]=e,e=t[5],s[5]=t[7],s[7]=e}else s[0]=t[0],s[1]=t[3],s[2]=t[6],s[3]=t[1],s[4]=t[4],s[5]=t[7],s[6]=t[2],s[7]=t[5],s[8]=t[8];return this}setFromMat4(e){const t=e.data,s=this.data;return s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[4],s[4]=t[5],s[5]=t[6],s[6]=t[8],s[7]=t[9],s[8]=t[10],this}setFromQuat(e){const t=e.x,s=e.y,i=e.z,n=e.w,r=t+t,a=s+s,o=i+i,l=t*r,h=t*a,c=t*o,d=s*a,u=s*o,p=i*o,f=n*r,m=n*a,g=n*o,_=this.data;return _[0]=1-(d+p),_[1]=h+g,_[2]=c-m,_[3]=h-g,_[4]=1-(l+p),_[5]=u+f,_[6]=c+m,_[7]=u-f,_[8]=1-(l+d),this}invertMat4(e){const t=e.data,s=t[0],i=t[1],n=t[2],r=t[4],a=t[5],o=t[6],l=t[8],h=t[9],c=t[10],d=c*a-o*h,u=-c*i+n*h,p=o*i-n*a,f=-c*r+o*l,m=c*s-n*l,g=-o*s+n*r,_=h*r-a*l,v=-h*s+i*l,b=a*s-i*r,y=s*d+i*f+n*_;if(0===y)this.setIdentity();else{const e=1/y,t=this.data;t[0]=d*e,t[1]=u*e,t[2]=p*e,t[3]=f*e,t[4]=m*e,t[5]=g*e,t[6]=_*e,t[7]=v*e,t[8]=b*e}return this}transformVector(e,t=new ys){const s=this.data,{x:i,y:n,z:r}=e;return t.x=i*s[0]+n*s[3]+r*s[6],t.y=i*s[1]+n*s[4]+r*s[7],t.z=i*s[2]+n*s[5]+r*s[8],t}}gs=xs,xs.IDENTITY=Object.freeze(new gs),xs.ZERO=Object.freeze((new gs).set([0,0,0,0,0,0,0,0,0]));class ws{constructor(e=0,t=0){this.x=void 0,this.y=void 0,2===e.length?(this.x=e[0],this.y=e[1]):(this.x=e,this.y=t)}add(e){return this.x+=e.x,this.y+=e.y,this}add2(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this}addScalar(e){return this.x+=e,this.y+=e,this}addScaled(e,t){return this.x+=e.x*t,this.y+=e.y*t,this}clone(){return new(0,this.constructor)(this.x,this.y)}copy(e){return this.x=e.x,this.y=e.y,this}cross(e){return this.x*e.y-this.y*e.x}distance(e){const t=this.x-e.x,s=this.y-e.y;return Math.sqrt(t*t+s*s)}div(e){return this.x/=e.x,this.y/=e.y,this}div2(e,t){return this.x=e.x/t.x,this.y=e.y/t.y,this}divScalar(e){return this.x/=e,this.y/=e,this}dot(e){return this.x*e.x+this.y*e.y}equals(e){return this.x===e.x&&this.y===e.y}equalsApprox(e,t=1e-6){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSq(){return this.x*this.x+this.y*this.y}lerp(e,t,s){return this.x=e.x+s*(t.x-e.x),this.y=e.y+s*(t.y-e.y),this}mul(e){return this.x*=e.x,this.y*=e.y,this}mul2(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this}mulScalar(e){return this.x*=e,this.y*=e,this}normalize(e=this){const t=e.x*e.x+e.y*e.y;if(t>0){const s=1/Math.sqrt(t);this.x=e.x*s,this.y=e.y*s}return this}rotate(e){const t=Math.atan2(this.x,this.y)+e*rs.DEG_TO_RAD,s=Math.sqrt(this.x*this.x+this.y*this.y);return this.x=Math.sin(t)*s,this.y=Math.cos(t)*s,this}angle(){return Math.atan2(this.x,this.y)*rs.RAD_TO_DEG}angleTo(e){return Math.atan2(this.x*e.y+this.y*e.x,this.x*e.x+this.y*e.y)*rs.RAD_TO_DEG}floor(e=this){return this.x=Math.floor(e.x),this.y=Math.floor(e.y),this}ceil(e=this){return this.x=Math.ceil(e.x),this.y=Math.ceil(e.y),this}round(e=this){return this.x=Math.round(e.x),this.y=Math.round(e.y),this}min(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),this}max(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),this}set(e,t){return this.x=e,this.y=t,this}sub(e){return this.x-=e.x,this.y-=e.y,this}sub2(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this}subScalar(e){return this.x-=e,this.y-=e,this}toString(){return`[${this.x}, ${this.y}]`}static angleRad(e,t){return Math.atan2(e.x*t.y-e.y*t.x,e.x*t.x+e.y*t.y)}}_s=ws,ws.ZERO=Object.freeze(new _s(0,0)),ws.HALF=Object.freeze(new _s(.5,.5)),ws.ONE=Object.freeze(new _s(1,1)),ws.UP=Object.freeze(new _s(0,1)),ws.DOWN=Object.freeze(new _s(0,-1)),ws.RIGHT=Object.freeze(new _s(1,0)),ws.LEFT=Object.freeze(new _s(-1,0));class Ss{constructor(e=0,t=0,s=0,i=0){this.x=void 0,this.y=void 0,this.z=void 0,this.w=void 0,4===e.length?(this.x=e[0],this.y=e[1],this.z=e[2],this.w=e[3]):(this.x=e,this.y=t,this.z=s,this.w=i)}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}add2(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this}addScaled(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this.w+=e.w*t,this}clone(){return new(0,this.constructor)(this.x,this.y,this.z,this.w)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}div(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this.w/=e.w,this}div2(e,t){return this.x=e.x/t.x,this.y=e.y/t.y,this.z=e.z/t.z,this.w=e.w/t.w,this}divScalar(e){return this.x/=e,this.y/=e,this.z/=e,this.w/=e,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}equals(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}equalsApprox(e,t=1e-6){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t&&Math.abs(this.w-e.w)<t}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}lerp(e,t,s){return this.x=e.x+s*(t.x-e.x),this.y=e.y+s*(t.y-e.y),this.z=e.z+s*(t.z-e.z),this.w=e.w+s*(t.w-e.w),this}mul(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}mul2(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this.w=e.w*t.w,this}mulScalar(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}normalize(e=this){const t=e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w;if(t>0){const s=1/Math.sqrt(t);this.x=e.x*s,this.y=e.y*s,this.z=e.z*s,this.w=e.w*s}return this}floor(e=this){return this.x=Math.floor(e.x),this.y=Math.floor(e.y),this.z=Math.floor(e.z),this.w=Math.floor(e.w),this}ceil(e=this){return this.x=Math.ceil(e.x),this.y=Math.ceil(e.y),this.z=Math.ceil(e.z),this.w=Math.ceil(e.w),this}round(e=this){return this.x=Math.round(e.x),this.y=Math.round(e.y),this.z=Math.round(e.z),this.w=Math.round(e.w),this}min(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z),e.w<this.w&&(this.w=e.w),this}max(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z),e.w>this.w&&(this.w=e.w),this}set(e,t,s,i){return this.x=e,this.y=t,this.z=s,this.w=i,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}sub2(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this}toString(){return`[${this.x}, ${this.y}, ${this.z}, ${this.w}]`}}vs=Ss,Ss.ZERO=Object.freeze(new vs(0,0,0,0)),Ss.HALF=Object.freeze(new vs(.5,.5,.5,.5)),Ss.ONE=Object.freeze(new vs(1,1,1,1));const Cs=new ws,Ts=new ys,Es=new ys,Ps=new ys,ks=new ys;class As{constructor(){this.data=new Float32Array(16),this.data[0]=this.data[5]=this.data[10]=this.data[15]=1}static _getPerspectiveHalfSize(e,t,s,i,n){n?(e.x=i*Math.tan(t*Math.PI/360),e.y=e.x/s):(e.y=i*Math.tan(t*Math.PI/360),e.x=e.y*s)}add2(e,t){const s=e.data,i=t.data,n=this.data;return n[0]=s[0]+i[0],n[1]=s[1]+i[1],n[2]=s[2]+i[2],n[3]=s[3]+i[3],n[4]=s[4]+i[4],n[5]=s[5]+i[5],n[6]=s[6]+i[6],n[7]=s[7]+i[7],n[8]=s[8]+i[8],n[9]=s[9]+i[9],n[10]=s[10]+i[10],n[11]=s[11]+i[11],n[12]=s[12]+i[12],n[13]=s[13]+i[13],n[14]=s[14]+i[14],n[15]=s[15]+i[15],this}add(e){return this.add2(this,e)}clone(){return(new(0,this.constructor)).copy(this)}copy(e){const t=e.data,s=this.data;return s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3],s[4]=t[4],s[5]=t[5],s[6]=t[6],s[7]=t[7],s[8]=t[8],s[9]=t[9],s[10]=t[10],s[11]=t[11],s[12]=t[12],s[13]=t[13],s[14]=t[14],s[15]=t[15],this}equals(e){const t=this.data,s=e.data;return t[0]===s[0]&&t[1]===s[1]&&t[2]===s[2]&&t[3]===s[3]&&t[4]===s[4]&&t[5]===s[5]&&t[6]===s[6]&&t[7]===s[7]&&t[8]===s[8]&&t[9]===s[9]&&t[10]===s[10]&&t[11]===s[11]&&t[12]===s[12]&&t[13]===s[13]&&t[14]===s[14]&&t[15]===s[15]}isIdentity(){const e=this.data;return 1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&0===e[4]&&1===e[5]&&0===e[6]&&0===e[7]&&0===e[8]&&0===e[9]&&1===e[10]&&0===e[11]&&0===e[12]&&0===e[13]&&0===e[14]&&1===e[15]}mul2(e,t){const s=e.data,i=t.data,n=this.data,r=s[0],a=s[1],o=s[2],l=s[3],h=s[4],c=s[5],d=s[6],u=s[7],p=s[8],f=s[9],m=s[10],g=s[11],_=s[12],v=s[13],b=s[14],y=s[15];let x,w,S,C;return x=i[0],w=i[1],S=i[2],C=i[3],n[0]=r*x+h*w+p*S+_*C,n[1]=a*x+c*w+f*S+v*C,n[2]=o*x+d*w+m*S+b*C,n[3]=l*x+u*w+g*S+y*C,x=i[4],w=i[5],S=i[6],C=i[7],n[4]=r*x+h*w+p*S+_*C,n[5]=a*x+c*w+f*S+v*C,n[6]=o*x+d*w+m*S+b*C,n[7]=l*x+u*w+g*S+y*C,x=i[8],w=i[9],S=i[10],C=i[11],n[8]=r*x+h*w+p*S+_*C,n[9]=a*x+c*w+f*S+v*C,n[10]=o*x+d*w+m*S+b*C,n[11]=l*x+u*w+g*S+y*C,x=i[12],w=i[13],S=i[14],C=i[15],n[12]=r*x+h*w+p*S+_*C,n[13]=a*x+c*w+f*S+v*C,n[14]=o*x+d*w+m*S+b*C,n[15]=l*x+u*w+g*S+y*C,this}mulAffine2(e,t){const s=e.data,i=t.data,n=this.data,r=s[0],a=s[1],o=s[2],l=s[4],h=s[5],c=s[6],d=s[8],u=s[9],p=s[10],f=s[12],m=s[13],g=s[14];let _,v,b;return _=i[0],v=i[1],b=i[2],n[0]=r*_+l*v+d*b,n[1]=a*_+h*v+u*b,n[2]=o*_+c*v+p*b,n[3]=0,_=i[4],v=i[5],b=i[6],n[4]=r*_+l*v+d*b,n[5]=a*_+h*v+u*b,n[6]=o*_+c*v+p*b,n[7]=0,_=i[8],v=i[9],b=i[10],n[8]=r*_+l*v+d*b,n[9]=a*_+h*v+u*b,n[10]=o*_+c*v+p*b,n[11]=0,_=i[12],v=i[13],b=i[14],n[12]=r*_+l*v+d*b+f,n[13]=a*_+h*v+u*b+m,n[14]=o*_+c*v+p*b+g,n[15]=1,this}mul(e){return this.mul2(this,e)}transformPoint(e,t=new ys){const s=this.data,{x:i,y:n,z:r}=e;return t.x=i*s[0]+n*s[4]+r*s[8]+s[12],t.y=i*s[1]+n*s[5]+r*s[9]+s[13],t.z=i*s[2]+n*s[6]+r*s[10]+s[14],t}transformVector(e,t=new ys){const s=this.data,{x:i,y:n,z:r}=e;return t.x=i*s[0]+n*s[4]+r*s[8],t.y=i*s[1]+n*s[5]+r*s[9],t.z=i*s[2]+n*s[6]+r*s[10],t}transformVec4(e,t=new Ss){const s=this.data,{x:i,y:n,z:r,w:a}=e;return t.x=i*s[0]+n*s[4]+r*s[8]+a*s[12],t.y=i*s[1]+n*s[5]+r*s[9]+a*s[13],t.z=i*s[2]+n*s[6]+r*s[10]+a*s[14],t.w=i*s[3]+n*s[7]+r*s[11]+a*s[15],t}setLookAt(e,t,s){Ps.sub2(e,t).normalize(),Es.copy(s).normalize(),Ts.cross(Es,Ps).normalize(),Es.cross(Ps,Ts);const i=this.data;return i[0]=Ts.x,i[1]=Ts.y,i[2]=Ts.z,i[3]=0,i[4]=Es.x,i[5]=Es.y,i[6]=Es.z,i[7]=0,i[8]=Ps.x,i[9]=Ps.y,i[10]=Ps.z,i[11]=0,i[12]=e.x,i[13]=e.y,i[14]=e.z,i[15]=1,this}setFrustum(e,t,s,i,n,r){const a=2*n,o=t-e,l=i-s,h=r-n,c=this.data;return c[0]=a/o,c[1]=0,c[2]=0,c[3]=0,c[4]=0,c[5]=a/l,c[6]=0,c[7]=0,c[8]=(t+e)/o,c[9]=(i+s)/l,c[10]=(-r-n)/h,c[11]=-1,c[12]=0,c[13]=0,c[14]=-a*r/h,c[15]=0,this}setPerspective(e,t,s,i,n){return As._getPerspectiveHalfSize(Cs,e,t,s,n),this.setFrustum(-Cs.x,Cs.x,-Cs.y,Cs.y,s,i)}setOrtho(e,t,s,i,n,r){const a=this.data;return a[0]=2/(t-e),a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2/(i-s),a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=-2/(r-n),a[11]=0,a[12]=-(t+e)/(t-e),a[13]=-(i+s)/(i-s),a[14]=-(r+n)/(r-n),a[15]=1,this}setFromAxisAngle(e,t){t*=rs.DEG_TO_RAD;const{x:s,y:i,z:n}=e,r=Math.cos(t),a=Math.sin(t),o=1-r,l=o*s,h=o*i,c=this.data;return c[0]=l*s+r,c[1]=l*i+a*n,c[2]=l*n-a*i,c[3]=0,c[4]=l*i-a*n,c[5]=h*i+r,c[6]=h*n+a*s,c[7]=0,c[8]=l*n+a*i,c[9]=h*n-s*a,c[10]=o*n*n+r,c[11]=0,c[12]=0,c[13]=0,c[14]=0,c[15]=1,this}setTranslate(e,t,s){const i=this.data;return i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=e,i[13]=t,i[14]=s,i[15]=1,this}setScale(e,t,s){const i=this.data;return i[0]=e,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=t,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=s,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,this}setViewport(e,t,s,i){const n=this.data;return n[0]=.5*s,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=.5*i,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=.5,n[11]=0,n[12]=e+.5*s,n[13]=t+.5*i,n[14]=.5,n[15]=1,this}setReflection(e,t){const s=e.x,i=e.y,n=e.z,r=this.data;return r[0]=1-2*s*s,r[1]=-2*s*i,r[2]=-2*s*n,r[3]=0,r[4]=-2*s*i,r[5]=1-2*i*i,r[6]=-2*i*n,r[7]=0,r[8]=-2*s*n,r[9]=-2*i*n,r[10]=1-2*n*n,r[11]=0,r[12]=-2*s*t,r[13]=-2*i*t,r[14]=-2*n*t,r[15]=1,this}invert(e=this){const t=e.data,s=t[0],i=t[1],n=t[2],r=t[3],a=t[4],o=t[5],l=t[6],h=t[7],c=t[8],d=t[9],u=t[10],p=t[11],f=t[12],m=t[13],g=t[14],_=t[15],v=s*o-i*a,b=s*l-n*a,y=s*h-r*a,x=i*l-n*o,w=i*h-r*o,S=n*h-r*l,C=c*m-d*f,T=c*g-u*f,E=c*_-p*f,P=d*g-u*m,k=d*_-p*m,A=u*_-p*g,M=v*A-b*k+y*P+x*E-w*T+S*C;if(0===M)this.setIdentity();else{const e=1/M,t=this.data;t[0]=(o*A-l*k+h*P)*e,t[1]=(-i*A+n*k-r*P)*e,t[2]=(m*S-g*w+_*x)*e,t[3]=(-d*S+u*w-p*x)*e,t[4]=(-a*A+l*E-h*T)*e,t[5]=(s*A-n*E+r*T)*e,t[6]=(-f*S+g*y-_*b)*e,t[7]=(c*S-u*y+p*b)*e,t[8]=(a*k-o*E+h*C)*e,t[9]=(-s*k+i*E-r*C)*e,t[10]=(f*w-m*y+_*v)*e,t[11]=(-c*w+d*y-p*v)*e,t[12]=(-a*P+o*T-l*C)*e,t[13]=(s*P-i*T+n*C)*e,t[14]=(-f*x+m*b-g*v)*e,t[15]=(c*x-d*b+u*v)*e}return this}set(e){const t=this.data;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],this}setIdentity(){const e=this.data;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}setTRS(e,t,s){const i=t.x,n=t.y,r=t.z,a=t.w,o=s.x,l=s.y,h=s.z,c=i+i,d=n+n,u=r+r,p=i*c,f=i*d,m=i*u,g=n*d,_=n*u,v=r*u,b=a*c,y=a*d,x=a*u,w=this.data;return w[0]=(1-(g+v))*o,w[1]=(f+x)*o,w[2]=(m-y)*o,w[3]=0,w[4]=(f-x)*l,w[5]=(1-(p+v))*l,w[6]=(_+b)*l,w[7]=0,w[8]=(m+y)*h,w[9]=(_-b)*h,w[10]=(1-(p+g))*h,w[11]=0,w[12]=e.x,w[13]=e.y,w[14]=e.z,w[15]=1,this}transpose(e=this){const t=e.data,s=this.data;if(t===s){let e;e=t[1],s[1]=t[4],s[4]=e,e=t[2],s[2]=t[8],s[8]=e,e=t[3],s[3]=t[12],s[12]=e,e=t[6],s[6]=t[9],s[9]=e,e=t[7],s[7]=t[13],s[13]=e,e=t[11],s[11]=t[14],s[14]=e}else s[0]=t[0],s[1]=t[4],s[2]=t[8],s[3]=t[12],s[4]=t[1],s[5]=t[5],s[6]=t[9],s[7]=t[13],s[8]=t[2],s[9]=t[6],s[10]=t[10],s[11]=t[14],s[12]=t[3],s[13]=t[7],s[14]=t[11],s[15]=t[15];return this}getTranslation(e=new ys){return e.set(this.data[12],this.data[13],this.data[14])}getX(e=new ys){return e.set(this.data[0],this.data[1],this.data[2])}getY(e=new ys){return e.set(this.data[4],this.data[5],this.data[6])}getZ(e=new ys){return e.set(this.data[8],this.data[9],this.data[10])}getScale(e=new ys){return this.getX(Ts),this.getY(Es),this.getZ(Ps),e.set(Ts.length(),Es.length(),Ps.length()),e}get scaleSign(){return this.getX(Ts),this.getY(Es),this.getZ(Ps),Ts.cross(Ts,Es),Ts.dot(Ps)<0?-1:1}setFromEulerAngles(e,t,s){e*=rs.DEG_TO_RAD,t*=rs.DEG_TO_RAD,s*=rs.DEG_TO_RAD;const i=Math.sin(-e),n=Math.cos(-e),r=Math.sin(-t),a=Math.cos(-t),o=Math.sin(-s),l=Math.cos(-s),h=this.data;return h[0]=a*l,h[1]=-a*o,h[2]=r,h[3]=0,h[4]=n*o+l*i*r,h[5]=n*l-i*r*o,h[6]=-a*i,h[7]=0,h[8]=i*o-n*l*r,h[9]=l*i+n*r*o,h[10]=n*a,h[11]=0,h[12]=0,h[13]=0,h[14]=0,h[15]=1,this}getEulerAngles(e=new ys){this.getScale(ks);const t=ks.x,s=ks.y,i=ks.z;if(0===t||0===s||0===i)return e.set(0,0,0);const n=this.data,r=Math.asin(-n[2]/t),a=.5*Math.PI;let o,l;return r<a?r>-a?(o=Math.atan2(n[6]/s,n[10]/i),l=Math.atan2(n[1]/t,n[0]/t)):(l=0,o=-Math.atan2(n[4]/s,n[5]/s)):(l=0,o=Math.atan2(n[4]/s,n[5]/s)),e.set(o,r,l).mulScalar(rs.RAD_TO_DEG)}toString(){return`[${this.data.join(", ")}]`}}var Ms;bs=As,As.IDENTITY=Object.freeze(new bs),As.ZERO=Object.freeze((new bs).set([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]));class Ds{constructor(e=0,t=0,s=0,i=1){this.x=void 0,this.y=void 0,this.z=void 0,this.w=void 0,4===e.length?(this.x=e[0],this.y=e[1],this.z=e[2],this.w=e[3]):(this.x=e,this.y=t,this.z=s,this.w=i)}clone(){return new(0,this.constructor)(this.x,this.y,this.z,this.w)}conjugate(e=this){return this.x=-1*e.x,this.y=-1*e.y,this.z=-1*e.z,this.w=e.w,this}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}equals(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}equalsApprox(e,t=1e-6){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t&&Math.abs(this.w-e.w)<t}getAxisAngle(e){let t=2*Math.acos(this.w);const s=Math.sin(t/2);return 0!==s?(e.x=this.x/s,e.y=this.y/s,e.z=this.z/s,(e.x<0||e.y<0||e.z<0)&&(e.x*=-1,e.y*=-1,e.z*=-1,t*=-1)):(e.x=1,e.y=0,e.z=0),t*rs.RAD_TO_DEG}getEulerAngles(e=new ys){let t,s,i;const n=this.x,r=this.y,a=this.z,o=this.w,l=2*(o*r-n*a);return l<=-.99999?(t=2*Math.atan2(n,o),s=-Math.PI/2,i=0):l>=.99999?(t=2*Math.atan2(n,o),s=Math.PI/2,i=0):(t=Math.atan2(2*(o*n+r*a),1-2*(n*n+r*r)),s=Math.asin(l),i=Math.atan2(2*(o*a+n*r),1-2*(r*r+a*a))),e.set(t,s,i).mulScalar(rs.RAD_TO_DEG)}invert(e=this){return this.conjugate(e).normalize()}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}mul(e){const t=this.x,s=this.y,i=this.z,n=this.w,r=e.x,a=e.y,o=e.z,l=e.w;return this.x=n*r+t*l+s*o-i*a,this.y=n*a+s*l+i*r-t*o,this.z=n*o+i*l+t*a-s*r,this.w=n*l-t*r-s*a-i*o,this}mulScalar(e,t=this){return this.x=t.x*e,this.y=t.y*e,this.z=t.z*e,this.w=t.w*e,this}mul2(e,t){const s=e.x,i=e.y,n=e.z,r=e.w,a=t.x,o=t.y,l=t.z,h=t.w;return this.x=r*a+s*h+i*l-n*o,this.y=r*o+i*h+n*a-s*l,this.z=r*l+n*h+s*o-i*a,this.w=r*h-s*a-i*o-n*l,this}normalize(e=this){let t=e.length();return 0===t?(this.x=this.y=this.z=0,this.w=1):(t=1/t,this.x=e.x*t,this.y=e.y*t,this.z=e.z*t,this.w=e.w*t),this}set(e,t,s,i){return this.x=e,this.y=t,this.z=s,this.w=i,this}setFromAxisAngle(e,t){t*=.5*rs.DEG_TO_RAD;const s=Math.sin(t),i=Math.cos(t);return this.x=s*e.x,this.y=s*e.y,this.z=s*e.z,this.w=i,this}setFromEulerAngles(e,t,s){if(e instanceof ys){const i=e;e=i.x,t=i.y,s=i.z}const i=.5*rs.DEG_TO_RAD;e*=i,t*=i,s*=i;const n=Math.sin(e),r=Math.cos(e),a=Math.sin(t),o=Math.cos(t),l=Math.sin(s),h=Math.cos(s);return this.x=n*o*h-r*a*l,this.y=r*a*h+n*o*l,this.z=r*o*l-n*a*h,this.w=r*o*h+n*a*l,this}setFromMat4(e){const t=e.data;let s,i=t[0],n=t[1],r=t[2],a=t[4],o=t[5],l=t[6],h=t[8],c=t[9],d=t[10];return s=i*i+n*n+r*r,0===s?this.set(0,0,0,1):(s=1/Math.sqrt(s),i*=s,n*=s,r*=s,s=a*a+o*o+l*l,0===s?this.set(0,0,0,1):(s=1/Math.sqrt(s),a*=s,o*=s,l*=s,s=h*h+c*c+d*d,0===s?this.set(0,0,0,1):(s=1/Math.sqrt(s),h*=s,c*=s,d*=s,d<0?i>o?this.set(1+i-o-d,n+a,h+r,l-c):this.set(n+a,1-i+o-d,l+c,h-r):i<-o?this.set(h+r,l+c,1-i-o+d,n-a):this.set(l-c,h-r,n-a,1+i+o+d),this.mulScalar(1/this.length()))))}setFromDirections(e,t){const s=1+e.dot(t);return s<Number.EPSILON?Math.abs(e.x)>Math.abs(e.y)?(this.x=-e.z,this.y=0,this.z=e.x,this.w=0):(this.x=0,this.y=-e.z,this.z=e.y,this.w=0):(this.x=e.y*t.z-e.z*t.y,this.y=e.z*t.x-e.x*t.z,this.z=e.x*t.y-e.y*t.x,this.w=s),this.normalize()}slerp(e,t,s){const i=e.x,n=e.y,r=e.z,a=e.w;let o=t.x,l=t.y,h=t.z,c=t.w,d=a*c+i*o+n*l+r*h;if(d<0&&(c=-c,o=-o,l=-l,h=-h,d=-d),Math.abs(d)>=1)return this.w=a,this.x=i,this.y=n,this.z=r,this;const u=Math.acos(d),p=Math.sqrt(1-d*d);if(Math.abs(p)<.001)return this.w=.5*a+.5*c,this.x=.5*i+.5*o,this.y=.5*n+.5*l,this.z=.5*r+.5*h,this;const f=Math.sin((1-s)*u)/p,m=Math.sin(s*u)/p;return this.w=a*f+c*m,this.x=i*f+o*m,this.y=n*f+l*m,this.z=r*f+h*m,this}transformVector(e,t=new ys){const s=e.x,i=e.y,n=e.z,r=this.x,a=this.y,o=this.z,l=this.w,h=l*s+a*n-o*i,c=l*i+o*s-r*n,d=l*n+r*i-a*s,u=-r*s-a*i-o*n;return t.x=h*l+u*-r+c*-o-d*-a,t.y=c*l+u*-a+d*-r-h*-o,t.z=d*l+u*-o+h*-a-c*-r,t}toString(){return`[${this.x}, ${this.y}, ${this.z}, ${this.w}]`}}Ms=Ds,Ds.IDENTITY=Object.freeze(new Ms(0,0,0,1)),Ds.ZERO=Object.freeze(new Ms(0,0,0,0));const Rs=new ys,Ls=new ys,Is=new ys,Fs=new ys,Os=new ys;class Bs{constructor(e,t){this.center=new ys,this.halfExtents=new ys(.5,.5,.5),this._min=new ys,this._max=new ys,e&&this.center.copy(e),t&&this.halfExtents.copy(t)}add(e){const t=this.center,s=t.x,i=t.y,n=t.z,r=this.halfExtents,a=r.x,o=r.y,l=r.z;let h=s-a,c=s+a,d=i-o,u=i+o,p=n-l,f=n+l;const m=e.center,g=m.x,_=m.y,v=m.z,b=e.halfExtents,y=b.x,x=b.y,w=b.z,S=g-y,C=g+y,T=_-x,E=_+x,P=v-w,k=v+w;S<h&&(h=S),C>c&&(c=C),T<d&&(d=T),E>u&&(u=E),P<p&&(p=P),k>f&&(f=k),t.x=.5*(h+c),t.y=.5*(d+u),t.z=.5*(p+f),r.x=.5*(c-h),r.y=.5*(u-d),r.z=.5*(f-p)}copy(e){this.center.copy(e.center),this.halfExtents.copy(e.halfExtents)}clone(){return new Bs(this.center,this.halfExtents)}intersects(e){const t=this.getMax(),s=this.getMin(),i=e.getMax(),n=e.getMin();return s.x<=i.x&&t.x>=n.x&&s.y<=i.y&&t.y>=n.y&&s.z<=i.z&&t.z>=n.z}_intersectsRay(e,t){const s=Rs.copy(this.getMin()).sub(e.origin),i=Ls.copy(this.getMax()).sub(e.origin),n=e.direction;0===n.x?(s.x=s.x<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.x=i.x<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.x/=n.x,i.x/=n.x),0===n.y?(s.y=s.y<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.y=i.y<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.y/=n.y,i.y/=n.y),0===n.z?(s.z=s.z<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.z=i.z<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.z/=n.z,i.z/=n.z);const r=Is.set(Math.min(s.x,i.x),Math.min(s.y,i.y),Math.min(s.z,i.z)),a=Fs.set(Math.max(s.x,i.x),Math.max(s.y,i.y),Math.max(s.z,i.z)),o=Math.min(Math.min(a.x,a.y),a.z),l=Math.max(Math.max(r.x,r.y),r.z),h=o>=l&&l>=0;return h&&t.copy(e.direction).mulScalar(l).add(e.origin),h}_fastIntersectsRay(e){const t=Rs,s=Ls,i=Is,n=Fs,r=Os,a=e.direction;return t.sub2(e.origin,this.center),n.set(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z)),i.mul2(t,a),!(n.x>this.halfExtents.x&&i.x>=0)&&(!(n.y>this.halfExtents.y&&i.y>=0)&&(!(n.z>this.halfExtents.z&&i.z>=0)&&(r.set(Math.abs(a.x),Math.abs(a.y),Math.abs(a.z)),s.cross(a,t),s.set(Math.abs(s.x),Math.abs(s.y),Math.abs(s.z)),!(s.x>this.halfExtents.y*r.z+this.halfExtents.z*r.y)&&(!(s.y>this.halfExtents.x*r.z+this.halfExtents.z*r.x)&&!(s.z>this.halfExtents.x*r.y+this.halfExtents.y*r.x)))))}intersectsRay(e,t){return t?this._intersectsRay(e,t):this._fastIntersectsRay(e)}setMinMax(e,t){this.center.add2(t,e).mulScalar(.5),this.halfExtents.sub2(t,e).mulScalar(.5)}getMin(){return this._min.copy(this.center).sub(this.halfExtents)}getMax(){return this._max.copy(this.center).add(this.halfExtents)}containsPoint(e){const t=this.getMin(),s=this.getMax();return!(e.x<t.x||e.x>s.x||e.y<t.y||e.y>s.y||e.z<t.z||e.z>s.z)}setFromTransformedAabb(e,t,s=!1){const i=e.center,n=e.halfExtents,r=t.data;let a=r[0],o=r[4],l=r[8],h=r[1],c=r[5],d=r[9],u=r[2],p=r[6],f=r[10];if(s){let e=a*a+o*o+l*l;if(e>0){const t=1/Math.sqrt(e);a*=t,o*=t,l*=t}if(e=h*h+c*c+d*d,e>0){const t=1/Math.sqrt(e);h*=t,c*=t,d*=t}if(e=u*u+p*p+f*f,e>0){const t=1/Math.sqrt(e);u*=t,p*=t,f*=t}}this.center.set(r[12]+a*i.x+o*i.y+l*i.z,r[13]+h*i.x+c*i.y+d*i.z,r[14]+u*i.x+p*i.y+f*i.z),this.halfExtents.set(Math.abs(a)*n.x+Math.abs(o)*n.y+Math.abs(l)*n.z,Math.abs(h)*n.x+Math.abs(c)*n.y+Math.abs(d)*n.z,Math.abs(u)*n.x+Math.abs(p)*n.y+Math.abs(f)*n.z)}static computeMinMax(e,t,s,i=e.length/3){if(i>0){let n=e[0],r=e[1],a=e[2],o=n,l=r,h=a;const c=3*i;for(let t=3;t<c;t+=3){const s=e[t],i=e[t+1],c=e[t+2];s<n&&(n=s),i<r&&(r=i),c<a&&(a=c),s>o&&(o=s),i>l&&(l=i),c>h&&(h=c)}t.set(n,r,a),s.set(o,l,h)}}compute(e,t){Bs.computeMinMax(e,Rs,Ls,t),this.setMinMax(Rs,Ls)}intersectsBoundingSphere(e){return this._distanceToBoundingSphereSq(e)<=e.radius*e.radius}_distanceToBoundingSphereSq(e){const t=this.getMin(),s=this.getMax();let i=0;const n=["x","y","z"];for(let r=0;r<3;++r){let a=0;const o=e.center[n[r]],l=t[n[r]],h=s[n[r]];let c=0;o<l&&(c=l-o,a+=c*c),o>h&&(c=o-h,a+=c*c),i+=a}return i}_expand(e,t){Rs.add2(this.getMin(),e),Ls.add2(this.getMax(),t),this.setMinMax(Rs,Ls)}}const zs=new ys,Ns=new ys;class Us{constructor(e=new ys,t=.5){this.center=void 0,this.radius=void 0,this.center=e,this.radius=t}containsPoint(e){const t=zs.sub2(e,this.center).lengthSq(),s=this.radius;return t<s*s}intersectsRay(e,t){const s=zs.copy(e.origin).sub(this.center),i=s.dot(Ns.copy(e.direction).normalize()),n=s.dot(s)-this.radius*this.radius;if(n>0&&i>0)return!1;const r=i*i-n;if(r<0)return!1;const a=Math.abs(-i-Math.sqrt(r));return t&&t.copy(e.direction).mulScalar(a).add(e.origin),!0}intersectsBoundingSphere(e){zs.sub2(e.center,this.center);const t=e.radius+this.radius;return zs.lengthSq()<=t*t}}class Vs{constructor(e=ys.UP,t=0){this.normal=new ys,this.distance=void 0,this.normal.copy(e),this.distance=t}clone(){return(new(0,this.constructor)).copy(this)}copy(e){return this.normal.copy(e.normal),this.distance=e.distance,this}intersectsLine(e,t,s){const i=this.distance,n=this.normal.dot(e)+i,r=n/(n-(this.normal.dot(t)+i)),a=r>=0&&r<=1;return a&&s&&s.lerp(e,t,r),a}intersectsRay(e,t){const s=this.normal.dot(e.direction);if(0===s)return!1;const i=-(this.normal.dot(e.origin)+this.distance)/s;return i>=0&&t&&t.copy(e.direction).mulScalar(i).add(e.origin),i>=0}normalize(){const e=1/this.normal.length();return this.normal.mulScalar(e),this.distance*=e,this}set(e,t,s,i){return this.normal.set(e,t,s),this.distance=i,this}setFromPointNormal(e,t){return this.normal.copy(t),this.distance=-this.normal.dot(e),this}}class Gs{constructor(){this.planes=[];for(let e=0;e<6;e++)this.planes[e]=new Vs}clone(){return(new(0,this.constructor)).copy(this)}copy(e){for(let t=0;t<6;t++)this.planes[t].copy(e.planes[t]);return this}setFromMat4(e){const[t,s,i,n,r,a,o,l,h,c,d,u,p,f,m,g]=e.data,_=this.planes;_[0].set(n-t,l-r,u-h,g-p).normalize(),_[1].set(n+t,l+r,u+h,g+p).normalize(),_[2].set(n+s,l+a,u+c,g+f).normalize(),_[3].set(n-s,l-a,u-c,g-f).normalize(),_[4].set(n-i,l-o,u-d,g-m).normalize(),_[5].set(n+i,l+o,u+d,g+m).normalize()}containsPoint(e){for(let t=0;t<6;t++){const{normal:s,distance:i}=this.planes[t];if(s.dot(e)+i<=0)return!1}return!0}containsSphere(e){const{center:t,radius:s}=e;let i=0;for(let e=0;e<6;e++){const{normal:n,distance:r}=this.planes[e],a=n.dot(t)+r;if(a<=-s)return 0;a>s&&i++}return 6===i?2:1}}class Hs{constructor(e,t){this.origin=new ys,this.direction=ys.FORWARD.clone(),e&&this.origin.copy(e),t&&this.direction.copy(t)}set(e,t){return this.origin.copy(e),this.direction.copy(t),this}copy(e){return this.set(e.origin,e.direction)}clone(){return new this.constructor(this.origin,this.direction)}}const js=10,Ws=12,$s=14,qs=15,Xs=16,Ks=17,Ys=18,Qs=20,Js=24,Zs=25,ei=49,ti=69,si=new Map([[0,{name:"A8",size:1,ldr:!0}],[52,{name:"R8",size:1,ldr:!0}],[1,{name:"L8",size:1,ldr:!0}],[2,{name:"LA8",size:2,ldr:!0}],[53,{name:"RG8",size:2,ldr:!0}],[3,{name:"RGB565",size:2,ldr:!0}],[4,{name:"RGBA5551",size:2,ldr:!0}],[5,{name:"RGBA4",size:2,ldr:!0}],[6,{name:"RGB8",size:4,ldr:!0}],[7,{name:"RGBA8",size:4,ldr:!0,srgbFormat:Qs}],[50,{name:"R16F",size:2}],[51,{name:"RG16F",size:4}],[11,{name:"RGB16F",size:8}],[Ws,{name:"RGBA16F",size:8}],[13,{name:"RGB32F",size:16}],[$s,{name:"RGBA32F",size:16}],[qs,{name:"R32F",size:4}],[Xs,{name:"DEPTH",size:4}],[ti,{name:"DEPTH16",size:2}],[Ks,{name:"DEPTHSTENCIL",size:4}],[Ys,{name:"111110F",size:4}],[19,{name:"SRGB8",size:4,ldr:!0,srgb:!0}],[Qs,{name:"SRGBA8",size:4,ldr:!0,srgb:!0}],[31,{name:"BGRA8",size:4,ldr:!0}],[64,{name:"SBGRA8",size:4,ldr:!0,srgb:!0}],[8,{name:"DXT1",blockSize:8,ldr:!0,srgbFormat:54}],[9,{name:"DXT3",blockSize:16,ldr:!0,srgbFormat:55}],[js,{name:"DXT5",blockSize:16,ldr:!0,srgbFormat:56}],[21,{name:"ETC1",blockSize:8,ldr:!0}],[22,{name:"ETC2_RGB",blockSize:8,ldr:!0,srgbFormat:61}],[23,{name:"ETC2_RGBA",blockSize:16,ldr:!0,srgbFormat:62}],[Js,{name:"PVRTC_2BPP_RGB_1",ldr:!0,blockSize:8,srgbFormat:57}],[Zs,{name:"PVRTC_2BPP_RGBA_1",ldr:!0,blockSize:8,srgbFormat:58}],[26,{name:"PVRTC_4BPP_RGB_1",ldr:!0,blockSize:8,srgbFormat:59}],[27,{name:"PVRTC_4BPP_RGBA_1",ldr:!0,blockSize:8,srgbFormat:60}],[28,{name:"ASTC_4x4",blockSize:16,ldr:!0,srgbFormat:63}],[29,{name:"ATC_RGB",blockSize:8,ldr:!0}],[30,{name:"ATC_RGBA",blockSize:16,ldr:!0}],[65,{name:"BC6H_RGBF",blockSize:16}],[66,{name:"BC6H_RGBUF",blockSize:16}],[67,{name:"BC7_RGBA",blockSize:16,ldr:!0,srgbFormat:68}],[54,{name:"DXT1_SRGB",blockSize:8,ldr:!0,srgb:!0}],[55,{name:"DXT3_SRGBA",blockSize:16,ldr:!0,srgb:!0}],[56,{name:"DXT5_SRGBA",blockSize:16,ldr:!0,srgb:!0}],[57,{name:"PVRTC_2BPP_SRGB_1",blockSize:8,ldr:!0,srgb:!0}],[58,{name:"PVRTC_2BPP_SRGBA_1",blockSize:8,ldr:!0,srgb:!0}],[59,{name:"PVRTC_4BPP_SRGB_1",blockSize:8,ldr:!0,srgb:!0}],[60,{name:"PVRTC_4BPP_SRGBA_1",blockSize:8,ldr:!0,srgb:!0}],[61,{name:"ETC2_SRGB",blockSize:8,ldr:!0,srgb:!0}],[62,{name:"ETC2_SRGBA",blockSize:16,ldr:!0,srgb:!0}],[63,{name:"ASTC_4x4_SRGB",blockSize:16,ldr:!0,srgb:!0}],[68,{name:"BC7_SRGBA",blockSize:16,ldr:!0,srgb:!0}],[32,{name:"R8I",size:1,isInt:!0}],[33,{name:"R8U",size:1,isInt:!0}],[34,{name:"R16I",size:2,isInt:!0}],[35,{name:"R16U",size:2,isInt:!0}],[36,{name:"R32I",size:4,isInt:!0}],[37,{name:"R32U",size:4,isInt:!0}],[38,{name:"RG8I",size:2,isInt:!0}],[39,{name:"RG8U",size:2,isInt:!0}],[40,{name:"RG16I",size:4,isInt:!0}],[41,{name:"RG16U",size:4,isInt:!0}],[42,{name:"RG32I",size:8,isInt:!0}],[43,{name:"RG32U",size:8,isInt:!0}],[44,{name:"RGBA8I",size:4,isInt:!0}],[45,{name:"RGBA8U",size:4,isInt:!0}],[46,{name:"RGBA16I",size:8,isInt:!0}],[47,{name:"RGBA16U",size:8,isInt:!0}],[48,{name:"RGBA32I",size:16,isInt:!0}],[ei,{name:"RGBA32U",size:16,isInt:!0}]]),ii=e=>{var t;return void 0!==(null==(t=si.get(e))?void 0:t.blockSize)},ni=e=>{var t;return!0===(null==(t=si.get(e))?void 0:t.srgb)},ri=e=>{var t;return!0===(null==(t=si.get(e))?void 0:t.isInt)},ai=e=>{var t;return(null==(t=si.get(e))?void 0:t.srgbFormat)||e},oi=e=>{switch(e){case qs:case 13:case $s:return Float32Array;case 36:case 42:case 48:return Int32Array;case 37:case 43:case ei:return Uint32Array;case 34:case 40:case 46:return Int16Array;case 53:case 35:case 41:case 47:case 3:case 4:case 5:case 50:case 51:case 11:case Ws:return Uint16Array;case 32:case 38:case 44:return Int8Array;default:return Uint8Array}},li="POSITION",hi="NORMAL",ci="TANGENT",di="BLENDWEIGHT",ui="BLENDINDICES",pi="COLOR",fi="TEXCOORD",mi="TEXCOORD0",gi="TEXCOORD1",_i="TEXCOORD2",vi="TEXCOORD3",bi="TEXCOORD4",yi="TEXCOORD5",xi="TEXCOORD6",wi="TEXCOORD7",Si="ATTR8",Ci="ATTR9",Ti="ATTR12",Ei="ATTR13",Pi="ATTR14",ki="ATTR15",Ai="default",Mi="rgbm",Di="rgbe",Ri="rgbp",Li="swizzleGGGR",Ii="2d",Fi="2d-array",Oi="cube",Bi="3d",zi="cube",Ni="equirect",Ui="wgsl",Vi=14,Gi=26,Hi=27,ji=28,Wi=29,$i=30,qi=33,Xi=36,Ki=["bool","int","float","vec2","vec3","vec4","ivec2","ivec3","ivec4","bvec2","bvec3","bvec4","mat2","mat3","mat4","sampler2D","samplerCube","","sampler2DShadow","samplerCubeShadow","sampler3D","","","","","sampler2DArray","uint","uvec2","uvec3","uvec4","","","","","","","","","","","","","isampler2D","usampler2D","isamplerCube","usamplerCube","isampler3D","usampler3D","isampler2DArray","usampler2DArray"],Yi="webgl2",Qi="webgpu",Ji="null",Zi="ldr_srgb",en=["view","mesh","mesh_ub"],tn="default",sn=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Uint16Array],nn=[1,1,2,2,4,4,4,2],rn=[Uint8Array,Uint16Array,Uint32Array],an=[1,2,4],on={};on[li]=0,on[hi]=1,on[di]=2,on[ui]=3,on[pi]=4,on[mi]=5,on[gi]=6,on[_i]=7,on[vi]=8,on[bi]=9,on[yi]=10,on[xi]=11,on[wi]=12,on[ci]=13,on.ATTR0=0,on.ATTR1=1,on.ATTR2=2,on.ATTR3=3,on.ATTR4=4,on.ATTR5=5,on.ATTR6=6,on.ATTR7=7,on[Si]=8,on[Ci]=9,on.ATTR10=10,on.ATTR11=11,on[Ti]=12,on[Ei]=13,on[Pi]=14,on[ki]=15;const ln="1.65";let hn=0;const cn={[Ii]:"texture2D",[Oi]:"textureCube",[Bi]:"texture3D",[Fi]:"texture2DArray"};class dn{constructor(e,t){this.slot=-1,this.scopeId=null,this.name=e,this.visibility=t}}class un extends dn{}class pn extends dn{constructor(e,t,s=!1){super(e,t),this.readOnly=s}}class fn extends dn{constructor(e,t,s=Ii,i=0,n=!0){super(e,t),this.textureDimension=s,this.sampleType=i,this.hasSampler=n}}class mn extends dn{constructor(e,t=7,s=Ii,i=!0,n=!1){super(e,4),this.format=t,this.textureDimension=s,this.write=i,this.read=n}}class gn{constructor(e,t){this.uniformBufferFormats=[],this.textureFormats=[],this.storageTextureFormats=[],this.storageBufferFormats=[],this.id=hn++;let s=0;t.forEach((e=>{e.slot=s++,e instanceof fn&&e.hasSampler&&s++,e instanceof un?this.uniformBufferFormats.push(e):e instanceof fn?this.textureFormats.push(e):e instanceof mn?this.storageTextureFormats.push(e):e instanceof pn&&this.storageBufferFormats.push(e)})),this.device=e;const i=e.scope;this.bufferFormatsMap=new Map,this.uniformBufferFormats.forEach(((e,t)=>this.bufferFormatsMap.set(e.name,t))),this.textureFormatsMap=new Map,this.textureFormats.forEach(((e,t)=>{this.textureFormatsMap.set(e.name,t),e.scopeId=i.resolve(e.name)})),this.storageTextureFormatsMap=new Map,this.storageTextureFormats.forEach(((e,t)=>{this.storageTextureFormatsMap.set(e.name,t),e.scopeId=i.resolve(e.name)})),this.storageBufferFormatsMap=new Map,this.storageBufferFormats.forEach(((e,t)=>{this.storageBufferFormatsMap.set(e.name,t),e.scopeId=i.resolve(e.name)})),this.impl=e.createBindGroupFormatImpl(this)}destroy(){this.impl.destroy()}getTexture(e){const t=this.textureFormatsMap.get(e);return void 0!==t?this.textureFormats[t]:null}getStorageTexture(e){const t=this.storageTextureFormatsMap.get(e);return void 0!==t?this.storageTextureFormats[t]:null}getShaderDeclarationTextures(e){let t="";return this.textureFormats.forEach((s=>{let i=cn[s.textureDimension];const n="texture2DArray"===i,r=4===s.sampleType?"u":3===s.sampleType?"i":"";i=`${r}${i}`;let a="",o="";n&&(a="_texture",o=`#define ${s.name} ${r}sampler2DArray(${s.name}${a}, ${s.name}_sampler)\n`),t+=`layout(set = ${e}, binding = ${s.slot}) uniform ${i} ${s.name}${a};\n`,s.hasSampler&&(t+=`layout(set = ${e}, binding = ${s.slot+1}) uniform sampler ${s.name}_sampler;\n`),t+=o})),t}loseContext(){}}class _n{constructor(){this._cache=new Map}get(e,t){return this._cache.has(e)||(this._cache.set(e,t()),e.on("destroy",(()=>{this.remove(e)})),e.on("devicelost",(()=>{var t;null==(t=this._cache.get(e))||null==t.loseContext||t.loseContext(e)}))),this._cache.get(e)}remove(e){var t;null==(t=this._cache.get(e))||null==t.destroy||t.destroy(e),this._cache.delete(e)}}class vn{static calcLevelDimension(e,t){return Math.max(e>>t,1)}static calcMipLevelsCount(e,t,s=1){return 1+Math.floor(Math.log2(Math.max(e,t,s)))}static calcLevelGpuSize(e,t,s,i){var n,r,a;const o=si.get(i),l=null!=(n=null==(r=si.get(i))?void 0:r.size)?n:0;if(l>0)return e*t*s*l;const h=null!=(a=o.blockSize)?a:0;let c=Math.floor((e+3)/4);const d=Math.floor((t+3)/4),u=Math.floor((s+3)/4);return i!==Js&&i!==Zs||(c=Math.max(Math.floor(c/2),1)),c*d*u*h}static calcGpuSize(e,t,s,i,n,r){let a=0;for(;a+=vn.calcLevelGpuSize(e,t,s,i),n&&(1!==e||1!==t||1!==s);)e=Math.max(e>>1,1),t=Math.max(t>>1,1),s=Math.max(s>>1,1);return a*(r?6:1)}}let bn=0;class yn{constructor(e,t={}){var s,i,n,r,a,o,l,h,c,d,u,p,f,m,g,_,v,b,y,x;this.name=void 0,this._gpuSize=0,this.id=bn++,this._invalid=!1,this._lockedLevel=-1,this._lockedMode=0,this.renderVersionDirty=0,this._storage=!1,this._numLevels=0,this._numLevelsRequested=void 0,this.device=e,this.name=null!=(s=t.name)?s:"",this._width=Math.floor(null!=(i=t.width)?i:4),this._height=Math.floor(null!=(n=t.height)?n:4),this._format=null!=(r=t.format)?r:7,this._compressed=ii(this._format),this._integerFormat=ri(this._format),this._integerFormat&&(t.minFilter=0,t.magFilter=0),this._volume=null!=(a=t.volume)&&a,this._depth=Math.floor(null!=(o=t.depth)?o:1),this._arrayLength=Math.floor(null!=(l=t.arrayLength)?l:0),this._storage=null!=(h=t.storage)&&h,this._cubemap=null!=(c=t.cubemap)&&c,this._flipY=null!=(d=t.flipY)&&d,this._premultiplyAlpha=null!=(u=t.premultiplyAlpha)&&u,this._mipmaps=null==(p=t.mipmaps)||p,this._numLevelsRequested=t.numLevels,void 0!==t.numLevels&&(this._numLevels=t.numLevels),this._updateNumLevel(),this._minFilter=null!=(f=t.minFilter)?f:5,this._magFilter=null!=(m=t.magFilter)?m:1,this._anisotropy=null!=(g=t.anisotropy)?g:1,this._addressU=null!=(_=t.addressU)?_:0,this._addressV=null!=(v=t.addressV)?v:0,this._addressW=null!=(b=t.addressW)?b:0,this._compareOnRead=null!=(y=t.compareOnRead)&&y,this._compareFunc=null!=(x=t.compareFunc)?x:1,this.type=t.hasOwnProperty("type")?t.type:Ai,this.projection="none",this._cubemap?this.projection=zi:t.projection&&t.projection!==zi&&(this.projection=t.projection),this.impl=e.createTextureImpl(this),this.dirtyAll(),this._levels=t.levels,this._levels?this.upload():this._levels=this._cubemap?[[null,null,null,null,null,null]]:[null],e.textures.push(this)}destroy(){const e=this.device;if(e){const t=e.textures.indexOf(this);-1!==t&&e.textures.splice(t,1),e.scope.removeValue(this),this.impl.destroy(e),this.adjustVramSizeTracking(e._vram,-this._gpuSize),this._levels=null,this.device=null}}resize(e,t,s=1){const i=this.device;this.adjustVramSizeTracking(i._vram,-this._gpuSize),this.impl.destroy(i),this._width=Math.floor(e),this._height=Math.floor(t),this._depth=Math.floor(s),this._updateNumLevel(),this.impl=i.createTextureImpl(this),this.dirtyAll()}loseContext(){this.impl.loseContext(),this.dirtyAll()}adjustVramSizeTracking(e,t){e.tex+=t}propertyChanged(e){this.impl.propertyChanged(e),this.renderVersionDirty=this.device.renderVersion}_updateNumLevel(){const e=this.mipmaps?vn.calcMipLevelsCount(this.width,this.height):1,t=this._numLevelsRequested;this._numLevels=Math.min(null!=t?t:e,e),this._mipmaps=this._numLevels>1}get lockedMode(){return this._lockedMode}set minFilter(e){this._minFilter!==e&&(ri(this._format)||(this._minFilter=e,this.propertyChanged(1)))}get minFilter(){return this._minFilter}set magFilter(e){this._magFilter!==e&&(ri(this._format)||(this._magFilter=e,this.propertyChanged(2)))}get magFilter(){return this._magFilter}set addressU(e){this._addressU!==e&&(this._addressU=e,this.propertyChanged(4))}get addressU(){return this._addressU}set addressV(e){this._addressV!==e&&(this._addressV=e,this.propertyChanged(8))}get addressV(){return this._addressV}set addressW(e){this._volume&&e!==this._addressW&&(this._addressW=e,this.propertyChanged(16))}get addressW(){return this._addressW}set compareOnRead(e){this._compareOnRead!==e&&(this._compareOnRead=e,this.propertyChanged(32))}get compareOnRead(){return this._compareOnRead}set compareFunc(e){this._compareFunc!==e&&(this._compareFunc=e,this.propertyChanged(64))}get compareFunc(){return this._compareFunc}set anisotropy(e){this._anisotropy!==e&&(this._anisotropy=e,this.propertyChanged(128))}get anisotropy(){return this._anisotropy}set mipmaps(e){this._mipmaps!==e&&(this.device.isWebGPU||ri(this._format)||(this._mipmaps=e),e&&(this._needsMipmapsUpload=!0))}get mipmaps(){return this._mipmaps}get numLevels(){return this._numLevels}get storage(){return this._storage}get width(){return this._width}get height(){return this._height}get depth(){return this._depth}get format(){return this._format}get cubemap(){return this._cubemap}get gpuSize(){const e=this.pot&&this._mipmaps&&!(this._compressed&&1===this._levels.length);return vn.calcGpuSize(this._width,this._height,this._depth,this._format,e,this._cubemap)}get array(){return this._arrayLength>0}get arrayLength(){return this._arrayLength}get volume(){return this._volume}set flipY(e){this._flipY!==e&&(this._flipY=e,this._needsUpload=!0)}get flipY(){return this._flipY}set premultiplyAlpha(e){this._premultiplyAlpha!==e&&(this._premultiplyAlpha=e,this._needsUpload=!0)}get premultiplyAlpha(){return this._premultiplyAlpha}get pot(){return rs.powerOfTwo(this._width)&&rs.powerOfTwo(this._height)}get encoding(){switch(this.type){case Mi:return"rgbm";case Di:return"rgbe";case Ri:return"rgbp"}return(e=>{const t=si.get(e);return!(null==t||!t.ldr||null!=t&&t.srgb)})(this.format)?"srgb":"linear"}dirtyAll(){this._levelsUpdated=this._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0],this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps,this._mipmapsUploaded=!1,this.propertyChanged(255)}lock(e={}){null!=e.level||(e.level=0),null!=e.face||(e.face=0),null!=e.mode||(e.mode=2),this._lockedMode=e.mode,this._lockedLevel=e.level;const t=this.cubemap?this._levels[e.face]:this._levels;if(null===t[e.level]){const s=Math.max(1,this._width>>e.level),i=Math.max(1,this._height>>e.level),n=Math.max(1,this._depth>>e.level),r=new ArrayBuffer(vn.calcLevelGpuSize(s,i,n,this._format));t[e.level]=new(oi(this._format))(r)}return t[e.level]}setSource(e,t=0){let s,i,n=!1;if(this._cubemap){if(e[0]){s=e[0].width||0,i=e[0].height||0;for(let t=0;t<6;t++){const r=e[t];if(!r||r.width!==s||r.height!==i||!this.device._isBrowserInterface(r)){n=!0;break}}}else n=!0;if(!n)for(let s=0;s<6;s++)this._levels[t][s]!==e[s]&&(this._levelsUpdated[t][s]=!0)}else this.device._isBrowserInterface(e)||(n=!0),n||(e!==this._levels[t]&&(this._levelsUpdated[t]=!0),s=e.width,i=e.height);if(n)if(this._width=4,this._height=4,this._cubemap)for(let e=0;e<6;e++)this._levels[t][e]=null,this._levelsUpdated[t][e]=!0;else this._levels[t]=null,this._levelsUpdated[t]=!0;else 0===t&&(this._width=s,this._height=i),this._levels[t]=e;this._invalid===n&&n||(this._invalid=n,this.upload())}getSource(e=0){return this._levels[e]}unlock(){2===this._lockedMode&&this.upload(),this._lockedLevel=-1,this._lockedMode=0}upload(){var e,t;this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps,null==(e=(t=this.impl).uploadImmediate)||e.call(t,this.device,this)}read(e,t,s,i,n={}){var r,a;return null==(r=(a=this.impl).read)?void 0:r.call(a,e,t,s,i,n)}}const xn={white:[255,255,255,255],gray:[128,128,128,255],black:[0,0,0,255],normal:[128,128,255,255],pink:[255,128,255,255]};class wn{constructor(){this.map=new Map}destroy(){this.map.forEach((e=>{e.destroy()}))}}const Sn=new _n,Cn=(e,t)=>{const s=Sn.get(e,(()=>new wn));if(!s.map.has(t)){const i=new yn(e,{name:`built-in-texture-${t}`,width:1,height:1,format:7}),n=i.lock(),r=xn[t];n.set(r),i.unlock(),s.map.set(t,i)}return s.map.get(t)};let Tn=0;class En{constructor(){this.bindGroup=void 0,this.offsets=[]}}class Pn{constructor(e,t,s){this.renderVersionUpdated=-1,this.uniformBuffers=void 0,this.uniformBufferOffsets=[],this.id=Tn++,this.device=e,this.format=t,this.dirty=!0,this.impl=e.createBindGroupImpl(this),this.textures=[],this.storageTextures=[],this.storageBuffers=[],this.uniformBuffers=[],this.defaultUniformBuffer=s,s&&this.setUniformBuffer(tn,s)}destroy(){this.impl.destroy(),this.impl=null,this.format=null,this.defaultUniformBuffer=null}setUniformBuffer(e,t){const s=this.format.bufferFormatsMap.get(e);this.uniformBuffers[s]!==t&&(this.uniformBuffers[s]=t,this.dirty=!0)}setStorageBuffer(e,t){const s=this.format.storageBufferFormatsMap.get(e);this.storageBuffers[s]!==t&&(this.storageBuffers[s]=t,this.dirty=!0)}setTexture(e,t){const s=this.format.textureFormatsMap.get(e);this.textures[s]!==t?(this.textures[s]=t,this.dirty=!0):this.renderVersionUpdated<t.renderVersionDirty&&(this.dirty=!0)}setStorageTexture(e,t){const s=this.format.storageTextureFormatsMap.get(e);this.storageTextures[s]!==t?(this.storageTextures[s]=t,this.dirty=!0):this.renderVersionUpdated<t.renderVersionDirty&&(this.dirty=!0)}updateUniformBuffers(){for(let e=0;e<this.uniformBuffers.length;e++)this.uniformBuffers[e].update()}update(){const{textureFormats:e,storageTextureFormats:t,storageBufferFormats:s}=this.format;for(let t=0;t<e.length;t++){const s=e[t];let i=s.scopeId.value;i||("uSceneDepthMap"===s.name&&(i=Cn(this.device,"white")),"uSceneColorMap"===s.name&&(i=Cn(this.device,"pink")),i||(i=Cn(this.device,"pink"))),this.setTexture(s.name,i)}for(let e=0;e<t.length;e++){const s=t[e],i=s.scopeId.value;this.setStorageTexture(s.name,i)}for(let e=0;e<s.length;e++){const t=s[e],i=t.scopeId.value;this.setStorageBuffer(t.name,i)}this.uniformBufferOffsets.length=this.uniformBuffers.length;for(let e=0;e<this.uniformBuffers.length;e++){const t=this.uniformBuffers[e];this.uniformBufferOffsets[e]=t.offset,this.renderVersionUpdated<t.renderVersionDirty&&(this.dirty=!0)}this.dirty&&(this.dirty=!1,this.renderVersionUpdated=this.device.renderVersion,this.impl.update(this))}}function kn(){return kn=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var i in s)({}).hasOwnProperty.call(s,i)&&(e[i]=s[i])}return e},kn.apply(null,arguments)}const An={set:(e,t,s,i=1)=>e&~(i<<s)|t<<s,get:(e,t,s=1)=>e>>t&s,all(e,t,s=1){const i=s<<t;return(e&i)===i},any:(e,t,s=1)=>!!(e&s<<t)};var Mn;const Dn=15;class Rn{constructor(e=!1,t=0,s=1,i=0,n,r,a,o=!0,l=!0,h=!0,c=!0){this.target0=0,this.setColorBlend(t,s,i),this.setAlphaBlend(null!=n?n:t,null!=r?r:s,null!=a?a:i),this.setColorWrite(o,l,h,c),this.blend=e}set blend(e){this.target0=An.set(this.target0,e?1:0,26)}get blend(){return An.all(this.target0,26)}setColorBlend(e,t,s){this.target0=An.set(this.target0,e,0,7),this.target0=An.set(this.target0,t,3,Dn),this.target0=An.set(this.target0,s,7,Dn)}setAlphaBlend(e,t,s){this.target0=An.set(this.target0,e,11,7),this.target0=An.set(this.target0,t,14,Dn),this.target0=An.set(this.target0,s,18,Dn)}setColorWrite(e,t,s,i){this.redWrite=e,this.greenWrite=t,this.blueWrite=s,this.alphaWrite=i}get colorOp(){return An.get(this.target0,0,7)}get colorSrcFactor(){return An.get(this.target0,3,Dn)}get colorDstFactor(){return An.get(this.target0,7,Dn)}get alphaOp(){return An.get(this.target0,11,7)}get alphaSrcFactor(){return An.get(this.target0,14,Dn)}get alphaDstFactor(){return An.get(this.target0,18,Dn)}set redWrite(e){this.target0=An.set(this.target0,e?1:0,22)}get redWrite(){return An.all(this.target0,22)}set greenWrite(e){this.target0=An.set(this.target0,e?1:0,23)}get greenWrite(){return An.all(this.target0,23)}set blueWrite(e){this.target0=An.set(this.target0,e?1:0,24)}get blueWrite(){return An.all(this.target0,24)}set alphaWrite(e){this.target0=An.set(this.target0,e?1:0,25)}get alphaWrite(){return An.all(this.target0,25)}get allWrite(){return An.get(this.target0,22,15)}copy(e){return this.target0=e.target0,this}clone(){return(new this.constructor).copy(this)}get key(){return this.target0}equals(e){return this.target0===e.target0}}Mn=Rn,Rn.NOBLEND=Object.freeze(new Mn),Rn.NOWRITE=Object.freeze(new Mn(void 0,void 0,void 0,void 0,void 0,void 0,void 0,!1,!1,!1,!1)),Rn.ALPHABLEND=Object.freeze(new Mn(!0,0,6,8)),Rn.ADDBLEND=Object.freeze(new Mn(!0,0,1,1));class Ln{constructor(){this.map=new Map,this.id=0}get(e){let t=this.map.get(e);return void 0===t&&(t=this.id++,this.map.set(e,t)),t}}var In;const Fn=new Ln;class On{constructor(e=3,t=!0){this.data=0,this._depthBias=0,this._depthBiasSlope=0,this.key=0,this.func=e,this.write=t}set test(e){this.func=e?3:7,this.updateKey()}get test(){return 7!==this.func}set write(e){this.data=An.set(this.data,e?1:0,3),this.updateKey()}get write(){return An.all(this.data,3)}set func(e){this.data=An.set(this.data,e,0,7),this.updateKey()}get func(){return An.get(this.data,0,7)}set depthBias(e){this._depthBias=e,this.updateKey()}get depthBias(){return this._depthBias}set depthBiasSlope(e){this._depthBiasSlope=e,this.updateKey()}get depthBiasSlope(){return this._depthBiasSlope}copy(e){return this.data=e.data,this._depthBias=e._depthBias,this._depthBiasSlope=e._depthBiasSlope,this.key=e.key,this}clone(){return(new this.constructor).copy(this)}updateKey(){const{data:e,_depthBias:t,_depthBiasSlope:s}=this,i=`${e}-${t}-${s}`;this.key=Fn.get(i)}equals(e){return this.key===e.key}}In=On,On.DEFAULT=Object.freeze(new In),On.NODEPTH=Object.freeze(new In(7,!1)),On.WRITEDEPTH=Object.freeze(new In(7,!0));class Bn{constructor(){this.globalId=0,this.revision=0}equals(e){return this.globalId===e.globalId&&this.revision===e.revision}copy(e){this.globalId=e.globalId,this.revision=e.revision}reset(){this.globalId=0,this.revision=0}}let zn=0;class Nn{constructor(){zn++,this.version=new Bn,this.version.globalId=zn}increment(){this.version.revision++}}class Un{constructor(e){this.name=e,this.value=null,this.versionObject=new Nn}toJSON(e){}setValue(e){this.value=e,this.versionObject.increment()}getValue(){return this.value}}class Vn{constructor(e){this.name=e,this.variables=new Map}resolve(e){return this.variables.has(e)||this.variables.set(e,new Un(e)),this.variables.get(e)}removeValue(e){for(const t in this.variables){const s=this.variables[t];s.value===e&&(s.value=null)}}}let Gn=0;class Hn{constructor(e,t,s,i){var n;this.usage=0,this.usage=null!=(n=null==i?void 0:i.usage)?n:0,this.device=e,this.format=t,this.numVertices=s,this.id=Gn++,this.impl=e.createVertexBufferImpl(this,t,i),this.numBytes=t.verticesByteSize?t.verticesByteSize:t.size*s,this.adjustVramSizeTracking(e._vram,this.numBytes);const r=null==i?void 0:i.data;r?this.setData(r):this.storage=new ArrayBuffer(this.numBytes),this.device.buffers.push(this)}destroy(){const e=this.device,t=e.buffers.indexOf(this);-1!==t&&e.buffers.splice(t,1),this.impl.initialized&&(this.impl.destroy(e),this.adjustVramSizeTracking(e._vram,-this.storage.byteLength))}adjustVramSizeTracking(e,t){e.vb+=t}loseContext(){this.impl.loseContext()}getFormat(){return this.format}getUsage(){return this.usage}getNumVertices(){return this.numVertices}lock(){return this.storage}unlock(){this.impl.unlock(this)}setData(e){return e.byteLength===this.numBytes&&(this.storage=e,this.unlock(),!0)}}function jn(e){if(null==e)return 0;let t=0;for(let s=0,i=e.length;s<i;s++)t=(t<<5)-t+e.charCodeAt(s),t|=0;return t}function Wn(e){let t=2166136261;for(let s=0;s<e.length;s++)t^=e[s],t*=16777619;return t>>>0}const $n=new Ln,qn=[2,4,8,12,16],Xn=new _n;class Kn{constructor(e,t,s){this.device=e,this._elements=[],this.hasUv0=!1,this.hasUv1=!1,this.hasColor=!1,this.hasTangents=!1,this.verticesByteSize=0,this.vertexCount=s,this.interleaved=void 0===s,this.instancing=!1,this.size=t.reduce(((e,t)=>e+4*Math.ceil(t.components*nn[t.type]/4)),0);let i,n=0;for(let e=0,o=t.length;e<o;e++){var r,a;const o=t[e];i=o.components*nn[o.type],s&&(n=rs.roundUp(n,i));const l=null!=(r=o.asInt)&&r,h=!l&&(null!=(a=o.normalize)&&a),c={name:o.semantic,offset:s?n:o.hasOwnProperty("offset")?o.offset:n,stride:s?i:o.hasOwnProperty("stride")?o.stride:this.size,dataType:o.type,numComponents:o.components,normalize:h,size:i,asInt:l};this._elements.push(c),n+=s?i*s:4*Math.ceil(i/4),o.semantic===mi?this.hasUv0=!0:o.semantic===gi?this.hasUv1=!0:o.semantic===pi?this.hasColor=!0:o.semantic===ci&&(this.hasTangents=!0)}s&&(this.verticesByteSize=n),this._evaluateHash()}get elements(){return this._elements}static getDefaultInstancingFormat(e){return Xn.get(e,(()=>new Kn(e,[{semantic:Ti,components:4,type:6},{semantic:Ei,components:4,type:6},{semantic:Pi,components:4,type:6},{semantic:ki,components:4,type:6}])))}static isElementValid(e,t){const s=t.components*nn[t.type];return!(e.isWebGPU&&!qn.includes(s))}update(){this._evaluateHash()}_evaluateHash(){const e=[],t=[],s=this._elements.length;for(let i=0;i<s;i++){const{name:s,dataType:n,numComponents:r,normalize:a,offset:o,stride:l,size:h,asInt:c}=this._elements[i],d=s+n+r+a+c;e.push(d);const u=d+o+l+h;t.push(u)}e.sort();const i=e.join();this.batchingHash=jn(i),this.shaderProcessingHashString=i,this.renderingHashString=t.join("_"),this.renderingHash=$n.get(this.renderingHashString)}}var Yn;const Qn=new Ln;class Jn{set func(e){this._func=e,this._dirty=!0}get func(){return this._func}set ref(e){this._ref=e,this._dirty=!0}get ref(){return this._ref}set fail(e){this._fail=e,this._dirty=!0}get fail(){return this._fail}set zfail(e){this._zfail=e,this._dirty=!0}get zfail(){return this._zfail}set zpass(e){this._zpass=e,this._dirty=!0}get zpass(){return this._zpass}set readMask(e){this._readMask=e,this._dirty=!0}get readMask(){return this._readMask}set writeMask(e){this._writeMask=e,this._dirty=!0}get writeMask(){return this._writeMask}constructor(e={}){var t,s,i,n,r,a,o;this._func=void 0,this._ref=void 0,this._fail=void 0,this._zfail=void 0,this._zpass=void 0,this._readMask=void 0,this._writeMask=void 0,this._dirty=!0,this._key=void 0,this._func=null!=(t=e.func)?t:7,this._ref=null!=(s=e.ref)?s:0,this._readMask=null!=(i=e.readMask)?i:255,this._writeMask=null!=(n=e.writeMask)?n:255,this._fail=null!=(r=e.fail)?r:0,this._zfail=null!=(a=e.zfail)?a:0,this._zpass=null!=(o=e.zpass)?o:0,this._evalKey()}_evalKey(){const{_func:e,_ref:t,_fail:s,_zfail:i,_zpass:n,_readMask:r,_writeMask:a}=this,o=`${e},${t},${s},${i},${n},${r},${a}`;this._key=Qn.get(o),this._dirty=!1}get key(){return this._dirty&&this._evalKey(),this._key}copy(e){return this._func=e._func,this._ref=e._ref,this._readMask=e._readMask,this._writeMask=e._writeMask,this._fail=e._fail,this._zfail=e._zfail,this._zpass=e._zpass,this._dirty=e._dirty,this._key=e._key,this}clone(){return(new this.constructor).copy(this)}}Yn=Jn,Jn.DEFAULT=Object.freeze(new Yn);class Zn extends Kt{constructor(e,t){var s,i,n,r,a,o;super(),this.canvas=void 0,this.backBuffer=null,this.backBufferSize=new ws,this.backBufferFormat=void 0,this.backBufferAntialias=!1,this.isWebGPU=!1,this.isWebGL2=!1,this.isHdr=!1,this.scope=void 0,this.maxAnisotropy=void 0,this.maxCubeMapSize=void 0,this.maxTextureSize=void 0,this.maxVolumeSize=void 0,this.maxColorAttachments=1,this.precision=void 0,this.samples=void 0,this.maxSamples=1,this.supportsStencil=void 0,this.supportsCompute=!1,this.supportsStorageTextureRead=!1,this.renderTarget=null,this.shaders=[],this.textures=[],this.targets=new Set,this.renderVersion=0,this.renderPassIndex=void 0,this.insideRenderPass=!1,this.supportsUniformBuffers=!1,this.supportsClipDistances=!1,this.textureFloatRenderable=void 0,this.textureHalfFloatRenderable=void 0,this.textureRG11B10Renderable=!1,this.textureFloatFilterable=!1,this.quadVertexBuffer=void 0,this.blendState=new Rn,this.depthState=new On,this.stencilEnabled=!1,this.stencilFront=new Jn,this.stencilBack=new Jn,this.dynamicBuffers=void 0,this.gpuProfiler=void 0,this.defaultClearOptions={color:[0,0,0,1],depth:1,stencil:0,flags:3},this.clientRect={width:0,height:0},this.canvas=e,this.initOptions=kn({},t),null!=(s=this.initOptions).alpha||(s.alpha=!0),null!=(i=this.initOptions).depth||(i.depth=!0),null!=(n=this.initOptions).stencil||(n.stencil=!0),null!=(r=this.initOptions).antialias||(r.antialias=!0),null!=(a=this.initOptions).powerPreference||(a.powerPreference="high-performance"),null!=(o=this.initOptions).displayFormat||(o.displayFormat="ldr"),this._maxPixelRatio=qt.browser?Math.min(1,window.devicePixelRatio):1,this.buffers=[],this._vram={tex:0,vb:0,ib:0,ub:0,sb:0},this._shaderStats={vsCompiled:0,fsCompiled:0,linked:0,materialShaders:0,compileTime:0},this.initializeContextCaches(),this._drawCallsPerFrame=0,this._shaderSwitchesPerFrame=0,this._primsPerFrame=[];for(let e=0;e<=6;e++)this._primsPerFrame[e]=0;this._renderTargetCreationTime=0,this.scope=new Vn("Device"),this.textureBias=this.scope.resolve("textureBias"),this.textureBias.setValue(0)}postInit(){const e=new Kn(this,[{semantic:li,components:2,type:6}]),t=new Float32Array([-1,-1,1,-1,-1,1,1,1]);this.quadVertexBuffer=new Hn(this,e,4,{data:t})}destroy(){var e,t,s;this.fire("destroy"),null==(e=this.quadVertexBuffer)||e.destroy(),this.quadVertexBuffer=null,null==(t=this.dynamicBuffers)||t.destroy(),this.dynamicBuffers=null,null==(s=this.gpuProfiler)||s.destroy(),this.gpuProfiler=null}onDestroyShader(e){this.fire("destroy:shader",e);const t=this.shaders.indexOf(e);-1!==t&&this.shaders.splice(t,1)}postDestroy(){this.scope=null,this.canvas=null}loseContext(){var e;this.contextLost=!0,this.backBufferSize.set(-1,-1);for(const e of this.textures)e.loseContext();for(const e of this.buffers)e.loseContext();for(const e of this.targets)e.loseContext();null==(e=this.gpuProfiler)||e.loseContext()}restoreContext(){var e;this.contextLost=!1,this.initializeRenderState(),this.initializeContextCaches();for(const e of this.buffers)e.unlock();null==(e=this.gpuProfiler)||null==e.restoreContext||e.restoreContext()}toJSON(e){}initializeContextCaches(){this.indexBuffer=null,this.vertexBuffers=[],this.shader=null,this.shaderValid=void 0,this.shaderAsyncCompile=!1,this.renderTarget=null}initializeRenderState(){this.blendState=new Rn,this.depthState=new On,this.cullMode=1,this.vx=this.vy=this.vw=this.vh=0,this.sx=this.sy=this.sw=this.sh=0,this.blendColor=new os(0,0,0,0)}setStencilState(e,t){}setBlendState(e){}setBlendColor(e,t,s,i){}setDepthState(e){}setCullMode(e){}setRenderTarget(e){this.renderTarget=e}setIndexBuffer(e){this.indexBuffer=e}setVertexBuffer(e){e&&this.vertexBuffers.push(e)}clearVertexBuffer(){this.vertexBuffers.length=0}getRenderTarget(){return this.renderTarget}initRenderTarget(e){e.initialized||(e.init(),this.targets.add(e))}_isBrowserInterface(e){return this._isImageBrowserInterface(e)||this._isImageCanvasInterface(e)||this._isImageVideoInterface(e)}_isImageBrowserInterface(e){return"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement}_isImageCanvasInterface(e){return"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement}_isImageVideoInterface(e){return"undefined"!=typeof HTMLVideoElement&&e instanceof HTMLVideoElement}resizeCanvas(e,t){const s=Math.min(this._maxPixelRatio,qt.browser?window.devicePixelRatio:1),i=Math.floor(e*s),n=Math.floor(t*s);i===this.canvas.width&&n===this.canvas.height||this.setResolution(i,n)}setResolution(e,t){this.canvas.width=e,this.canvas.height=t,this.fire(Zn.EVENT_RESIZE,e,t)}updateClientRect(){if(qt.worker)this.clientRect.width=this.canvas.width,this.clientRect.height=this.canvas.height;else{const e=this.canvas.getBoundingClientRect();this.clientRect.width=e.width,this.clientRect.height=e.height}}get width(){return this.canvas.width}get height(){return this.canvas.height}set fullscreen(e){}get fullscreen(){return!1}set maxPixelRatio(e){this._maxPixelRatio=e}get maxPixelRatio(){return this._maxPixelRatio}get deviceType(){return this._deviceType}startRenderPass(e){}endRenderPass(e){}startComputePass(e){}endComputePass(){}frameStart(){this.renderPassIndex=0,this.renderVersion++}frameEnd(){}computeDispatch(e,t="Unnamed"){}getRenderableHdrFormat(e=[Ys,Ws,$s],t=!0,s=1){for(let i=0;i<e.length;i++){const n=e[i];switch(n){case Ys:if(this.textureRG11B10Renderable)return n;break;case Ws:if(this.textureHalfFloatRenderable)return n;break;case $s:if(this.isWebGPU&&s>1)continue;if(this.textureFloatRenderable&&(!t||this.textureFloatFilterable))return n}}}}Zn.EVENT_RESIZE="resizecanvas";let er=0;class tr{constructor(e={}){var t,s,i,n,r,a,o,l,h,c,d;this.name=void 0,this._device=void 0,this._colorBuffer=void 0,this._colorBuffers=void 0,this._depthBuffer=void 0,this._depth=void 0,this._stencil=void 0,this._samples=void 0,this.autoResolve=void 0,this._face=void 0,this._mipLevel=void 0,this._mipmaps=void 0,this.flipY=void 0,this.id=er++;const u=null!=(t=null!=(s=null!=(i=null==(n=e.colorBuffer)?void 0:n.device)?i:null==(r=e.colorBuffers)?void 0:r[0].device)?s:null==(a=e.depthBuffer)?void 0:a.device)?t:e.graphicsDevice;this._device=u;const{maxSamples:p}=this._device;if(this._samples=Math.min(null!=(o=e.samples)?o:1,p),u.isWebGPU&&(this._samples=this._samples>1?p:1),this._colorBuffer=e.colorBuffer,e.colorBuffer&&(this._colorBuffers=[e.colorBuffer]),this._depthBuffer=e.depthBuffer,this._face=null!=(l=e.face)?l:0,this._depthBuffer){const e=this._depthBuffer._format;e===Xs||e===ti?(this._depth=!0,this._stencil=!1):e===Ks?(this._depth=!0,this._stencil=!0):e===qs&&this._depthBuffer.device.isWebGPU&&this._samples>1?(this._depth=!0,this._stencil=!1):(this._depth=!1,this._stencil=!1)}else{var f,m;this._depth=null==(f=e.depth)||f,this._stencil=null!=(m=e.stencil)&&m}var g,_;(e.colorBuffers&&(this._colorBuffers||(this._colorBuffers=[...e.colorBuffers],this._colorBuffer=e.colorBuffers[0])),this.autoResolve=null==(h=e.autoResolve)||h,this.name=e.name,this.name)||(this.name=null==(g=this._colorBuffer)?void 0:g.name);this.name||(this.name=null==(_=this._depthBuffer)?void 0:_.name);this.name||(this.name="Untitled"),this.flipY=null!=(c=e.flipY)&&c,this._mipLevel=null!=(d=e.mipLevel)?d:0,this._mipLevel>0&&this._depth&&(this._mipLevel=0),this._mipmaps=void 0===e.mipLevel,this.validateMrt(),this.impl=u.createRenderTargetImpl(this)}destroy(){const e=this._device;e&&(e.targets.delete(this),e.renderTarget===this&&e.setRenderTarget(null),this.destroyFrameBuffers())}destroyFrameBuffers(){const e=this._device;e&&this.impl.destroy(e)}destroyTextureBuffers(){var e,t;null==(e=this._depthBuffer)||e.destroy(),this._depthBuffer=null,null==(t=this._colorBuffers)||t.forEach((e=>{e.destroy()})),this._colorBuffers=null,this._colorBuffer=null}resize(e,t){if(this.width!==e||this.height!==t){var s,i;if(this.mipLevel>0)return;const n=this._device;this.destroyFrameBuffers(),n.renderTarget===this&&n.setRenderTarget(null),null==(s=this._depthBuffer)||s.resize(e,t),null==(i=this._colorBuffers)||i.forEach((s=>{s.resize(e,t)})),this.validateMrt(),this.impl=n.createRenderTargetImpl(this)}}validateMrt(){}init(){this.impl.init(this._device,this)}get initialized(){return this.impl.initialized}get device(){return this._device}loseContext(){this.impl.loseContext()}resolve(e=!0,t=!!this._depthBuffer){this._device&&this._samples>1&&this.impl.resolve(this._device,this,e,t)}copy(e,t,s){if(!this._device){if(!e._device)return!1;this._device=e._device}return this._device.copyRenderTarget(e,this,t,s)}get samples(){return this._samples}get depth(){return this._depth}get stencil(){return this._stencil}get colorBuffer(){return this._colorBuffer}getColorBuffer(e){var t;return null==(t=this._colorBuffers)?void 0:t[e]}get depthBuffer(){return this._depthBuffer}get face(){return this._face}get mipLevel(){return this._mipLevel}get mipmaps(){return this._mipmaps}get width(){var e,t;let s=(null==(e=this._colorBuffer)?void 0:e.width)||(null==(t=this._depthBuffer)?void 0:t.width)||this._device.width;return this._mipLevel>0&&(s=vn.calcLevelDimension(s,this._mipLevel)),s}get height(){var e,t;let s=(null==(e=this._colorBuffer)?void 0:e.height)||(null==(t=this._depthBuffer)?void 0:t.height)||this._device.height;return this._mipLevel>0&&(s=vn.calcLevelDimension(s,this._mipLevel)),s}isColorBufferSrgb(e=0){if(this.device.backBuffer===this)return ni(this.device.backBufferFormat);const t=this.getColorBuffer(e);return!!t&&ni(t.format)}}class sr{constructor(){this.bindGroup=void 0}update(e){this.destroy();const t=e.device,s=this.createDescriptor(t,e);this.bindGroup=t.wgpu.createBindGroup(s)}destroy(){this.bindGroup=null}createDescriptor(e,t){const s=[],i=t.format,n=t.format.uniformBufferFormats;t.uniformBuffers.forEach(((e,t)=>{const i=n[t].slot,r=e.persistent?e.impl.buffer:e.allocation.gpuBuffer.buffer;s.push({binding:i,resource:{buffer:r,offset:0,size:e.format.byteSize}})}));const r=t.format.textureFormats;t.textures.forEach(((t,n)=>{const a=t.impl,o=i.textureFormats[n],l=r[n].slot,h=a.getView(e);if(s.push({binding:l,resource:h}),o.hasSampler){const t=a.getSampler(e,o.sampleType);s.push({binding:l+1,resource:t})}}));const a=t.format.storageTextureFormats;t.storageTextures.forEach(((t,i)=>{const n=t.impl,r=a[i].slot,o=n.getView(e);s.push({binding:r,resource:o})}));const o=t.format.storageBufferFormats;t.storageBuffers.forEach(((e,t)=>{const i=e.impl.buffer,n=o[t].slot;s.push({binding:n,resource:{buffer:i}})}));return{layout:t.format.impl.bindGroupLayout,entries:s}}}class ir{static shaderStage(e){let t=0;return 1&e&&(t|=GPUShaderStage.VERTEX),2&e&&(t|=GPUShaderStage.FRAGMENT),4&e&&(t|=GPUShaderStage.COMPUTE),t}}const nr=[];nr[0]="",nr[1]="",nr[2]="",nr[52]="r8unorm",nr[53]="rg8unorm",nr[3]="",nr[4]="",nr[5]="",nr[6]="rgba8unorm",nr[7]="rgba8unorm",nr[8]="bc1-rgba-unorm",nr[9]="bc2-rgba-unorm",nr[10]="bc3-rgba-unorm",nr[11]="",nr[12]="rgba16float",nr[50]="r16float",nr[51]="rg16float",nr[13]="",nr[14]="rgba32float",nr[15]="r32float",nr[16]="depth32float",nr[69]="depth16unorm",nr[17]="depth24plus-stencil8",nr[18]="rg11b10ufloat",nr[19]="",nr[20]="rgba8unorm-srgb",nr[21]="",nr[22]="etc2-rgb8unorm",nr[23]="etc2-rgba8unorm",nr[24]="",nr[25]="",nr[26]="",nr[27]="",nr[28]="astc-4x4-unorm",nr[29]="",nr[30]="",nr[31]="bgra8unorm",nr[64]="bgra8unorm-srgb",nr[32]="r8sint",nr[33]="r8uint",nr[34]="r16sint",nr[35]="r16uint",nr[36]="r32sint",nr[37]="r32uint",nr[38]="rg8sint",nr[39]="rg8uint",nr[40]="rg16sint",nr[41]="rg16uint",nr[42]="rg32sint",nr[43]="rg32uint",nr[44]="rgba8sint",nr[45]="rgba8uint",nr[46]="rgba16sint",nr[47]="rgba16uint",nr[48]="rgba32sint",nr[49]="rgba32uint",nr[65]="bc6h-rgb-float",nr[66]="bc6h-rgb-ufloat",nr[67]="bc7-rgba-unorm",nr[54]="bc1-rgba-unorm-srgb",nr[55]="bc2-rgba-unorm-srgb",nr[56]="bc3-rgba-unorm-srgb",nr[57]="",nr[58]="",nr[59]="",nr[60]="",nr[61]="etc2-rgb8unorm-srgb",nr[62]="etc2-rgba8unorm-srgb",nr[68]="bc7-rgba-unorm-srgb",nr[63]="astc-4x4-unorm-srgb";const rr=[];rr[0]="filtering",rr[1]="non-filtering",rr[2]="comparison",rr[3]="comparison",rr[4]="comparison";const ar=[];ar[0]="float",ar[1]="unfilterable-float",ar[2]="depth",ar[3]="sint",ar[4]="uint";const or=new Ln;class lr{constructor(e){const t=e.device,{key:s,desc:i}=this.createDescriptor(e);this.key=or.get(s),this.bindGroupLayout=t.wgpu.createBindGroupLayout(i)}destroy(){this.bindGroupLayout=null}loseContext(){}createDescriptor(e){const t=[];let s="";e.uniformBufferFormats.forEach((e=>{const i=ir.shaderStage(e.visibility);s+=`#${e.slot}U:${i}`,t.push({binding:e.slot,visibility:i,buffer:{type:"uniform",hasDynamicOffset:!0}})})),e.textureFormats.forEach((e=>{const i=ir.shaderStage(e.visibility),n=e.sampleType,r=e.textureDimension,a=!1,o=ar[n];if(s+=`#${e.slot}T:${i}-${o}-${r}-false`,t.push({binding:e.slot,visibility:i,texture:{sampleType:o,viewDimension:r,multisampled:a}}),e.hasSampler){const r=rr[n];s+=`#${e.slot+1}S:${i}-${r}`,t.push({binding:e.slot+1,visibility:i,sampler:{type:r}})}})),e.storageTextureFormats.forEach((e=>{const{format:i,textureDimension:n}=e,{read:r,write:a}=e;s+=`#${e.slot}ST:${i}-${n}-${r?"r1":"r0"}-${a?"w1":"w0"}`,t.push({binding:e.slot,visibility:GPUShaderStage.COMPUTE,storageTexture:{access:r?a?"read-write":"read-only":"write-only",format:nr[i],viewDimension:n}})})),e.storageBufferFormats.forEach((e=>{const i=e.readOnly,n=ir.shaderStage(e.visibility);s+=`#${e.slot}SB:${n}-${i?"ro":"rw"}`,t.push({binding:e.slot,visibility:n,buffer:{type:i?"read-only-storage":"storage"}})}));return{key:s,desc:{entries:t}}}}class hr{constructor(e=0){this.buffer=null,this.usageFlags=0,this.usageFlags=e}destroy(e){this.buffer&&(this.buffer.destroy(),this.buffer=null)}get initialized(){return!!this.buffer}loseContext(){}allocate(e,t){this.buffer=e.wgpu.createBuffer({size:t,usage:this.usageFlags})}unlock(e,t){var s,i;const n=e.wgpu;if(!this.buffer){const s=t.byteLength+3&-4;this.usageFlags|=GPUBufferUsage.COPY_DST,this.allocate(e,s)}const r=null!=(s=t.byteOffset)?s:0,a=new Uint8Array(null!=(i=t.buffer)?i:t,r,t.byteLength),o=new Uint8Array(this.buffer.size);o.set(a),n.queue.writeBuffer(this.buffer,0,o,0,o.length)}read(e,t,s,i){return e.readStorageBuffer(this,t,s,i)}write(e,t,s,i,n){e.writeStorageBuffer(this,t,s,i,n)}clear(e,t,s){e.clearStorageBuffer(this,t,s)}}class cr extends hr{constructor(e,t){super(16|(null!=t&&t.storage?128:0)),this.format=null,this.format=1===e.format?"uint16":"uint32"}unlock(e){const t=e.device;super.unlock(t,e.storage)}}const dr={equals(e,t){if(e.length!==t.length)return!1;for(let s=0;s<e.length;s++)if(e[s]!==t[s])return!1;return!0}},ur=[];ur[0]="sint8",ur[1]="uint8",ur[2]="sint16",ur[3]="uint16",ur[4]="sint32",ur[5]="uint32",ur[6]="float32",ur[7]="float16";const pr=[];pr[0]="snorm8",pr[1]="unorm8",pr[2]="snorm16",pr[3]="unorm16",pr[4]="sint32",pr[5]="uint32",pr[6]="float32",pr[7]="float16";class fr{constructor(){this.cache=new Map}get(e,t=null){const s=this.getKey(e,t);let i=this.cache.get(s);return i||(i=this.create(e,t),this.cache.set(s,i)),i}getKey(e,t=null){return`${null==e?void 0:e.renderingHashString}-${null==t?void 0:t.renderingHashString}`}create(e,t){const s=[],i=e=>{const t=e.interleaved,i=e.instancing?"instance":"vertex";let n=[];const r=e.elements.length;for(let a=0;a<r;a++){const o=e.elements[a],l=on[o.name],h=o.normalize?pr:ur;n.push({shaderLocation:l,offset:t?o.offset:0,format:`${h[o.dataType]}${o.numComponents>1?`x${o.numComponents}`:""}`}),t&&a!==r-1||(s.push({attributes:n,arrayStride:o.stride,stepMode:i}),n=[])}};return e&&i(e),t&&i(t),s}}class mr{constructor(e){this.device=e}getPipelineLayout(e){const t=[];e.forEach((e=>{t.push(e.bindGroupLayout)}));const s={bindGroupLayouts:t};return this.device.wgpu.createPipelineLayout(s)}}const gr=["point-list","line-list",void 0,"line-strip","triangle-list","triangle-strip",void 0],_r=["add","subtract","reverse-subtract","min","max"],vr=["zero","one","src","one-minus-src","dst","one-minus-dst","src-alpha","src-alpha-saturated","one-minus-src-alpha","dst-alpha","one-minus-dst-alpha","constant","one-minus-constant"],br=["never","less","equal","less-equal","greater","not-equal","greater-equal","always"],yr=["none","back","front"],xr=["keep","zero","replace","increment-clamp","increment-wrap","decrement-clamp","decrement-wrap","invert"];class wr{constructor(){this.pipeline=void 0,this.hashes=void 0}}class Sr extends mr{constructor(e){super(e),this.lookupHashes=new Uint32Array(13),this.vertexBufferLayout=new fr,this.cache=new Map}get(e,t,s,i,n,r,a,o,l,h,c,d){var u,p,f,m,g,_,v,b;const y=this.lookupHashes;y[0]=e.type,y[1]=i.id,y[2]=l,y[3]=o.key,y[4]=a.key,y[5]=null!=(u=null==t?void 0:t.renderingHash)?u:0,y[6]=null!=(p=null==s?void 0:s.renderingHash)?p:0,y[7]=n.impl.key,y[8]=null!=(f=null==(m=r[0])?void 0:m.key)?f:0,y[9]=null!=(g=null==(_=r[1])?void 0:_.key)?g:0,y[10]=null!=(v=null==(b=r[2])?void 0:b.key)?v:0,y[11]=h?c.key:0,y[12]=h?d.key:0;const x=Wn(y);let w=this.cache.get(x);if(w)for(let e=0;e<w.length;e++){const t=w[e];if(dr.equals(t.hashes,y))return t.pipeline}const S=gr[e.type],C=this.getPipelineLayout(r),T=this.vertexBufferLayout.get(t,s),E=new wr;return E.hashes=new Uint32Array(y),E.pipeline=this.create(S,i,n,C,a,o,T,l,h,c,d),w?w.push(E):w=[E],this.cache.set(x,w),E.pipeline}getBlend(e){let t;return e.blend&&(t={color:{operation:_r[e.colorOp],srcFactor:vr[e.colorSrcFactor],dstFactor:vr[e.colorDstFactor]},alpha:{operation:_r[e.alphaOp],srcFactor:vr[e.alphaSrcFactor],dstFactor:vr[e.alphaDstFactor]}}),t}getDepthStencil(e,t,s,i,n){let r;const{depth:a,stencil:o}=t;return(a||o)&&(r={format:t.impl.depthAttachment.format},a?(r.depthWriteEnabled=e.write,r.depthCompare=br[e.func],r.depthBias=e.depthBias,r.depthBiasSlopeScale=e.depthBiasSlope):(r.depthWriteEnabled=!1,r.depthCompare="always"),o&&s&&(r.stencilReadMas=i.readMask,r.stencilWriteMask=i.writeMask,r.stencilFront={compare:br[i.func],failOp:xr[i.fail],passOp:xr[i.zpass],depthFailOp:xr[i.zfail]},r.stencilBack={compare:br[n.func],failOp:xr[n.fail],passOp:xr[n.zpass],depthFailOp:xr[n.zfail]})),r}create(e,t,s,i,n,r,a,o,l,h,c){const d=this.device.wgpu,u=t.impl,p={vertex:{module:u.getVertexShaderModule(),entryPoint:u.vertexEntryPoint,buffers:a},primitive:{topology:e,frontFace:"ccw",cullMode:yr[o]},depthStencil:this.getDepthStencil(r,s,l,h,c),multisample:{count:s.samples},layout:i};p.fragment={module:u.getFragmentShaderModule(),entryPoint:u.fragmentEntryPoint,targets:[]};const f=s.impl.colorAttachments;if(f.length>0){let e=0;n.redWrite&&(e|=GPUColorWrite.RED),n.greenWrite&&(e|=GPUColorWrite.GREEN),n.blueWrite&&(e|=GPUColorWrite.BLUE),n.alphaWrite&&(e|=GPUColorWrite.ALPHA);const t=this.getBlend(n);f.forEach((s=>{p.fragment.targets.push({format:s.format,writeMask:e,blend:t})}))}return d.createRenderPipeline(p)}}class Cr extends mr{get(e,t){const s=this.getPipelineLayout([t.impl]);return this.create(e,s)}create(e,t){const s=this.device.wgpu,i=e.impl,n={compute:{module:i.getComputeShaderModule(),entryPoint:i.computeEntryPoint},layout:t};return s.createComputePipeline(n)}}class Tr{constructor(){this._refCount=0}incRefCount(){this._refCount++}decRefCount(){this._refCount--}get refCount(){return this._refCount}}class Er extends Tr{constructor(e){super(),this.object=void 0,this.object=e,this.incRefCount()}}class Pr{constructor(){this.cache=new Map}destroy(){this.cache.forEach((e=>{var t;null==(t=e.object)||t.destroy()})),this.cache.clear()}clear(){this.cache.clear()}get(e){const t=this.cache.get(e);return t?(t.incRefCount(),t.object):null}set(e,t){this.cache.set(e,new Er(t))}release(e){const t=this.cache.get(e);var s;t&&(t.decRefCount(),0===t.refCount&&(this.cache.delete(e),null==(s=t.object)||s.destroy()))}}class kr extends Pr{loseContext(e){this.clear()}}const Ar=new _n,Mr=e=>Ar.get(e,(()=>new kr)),Dr=new Ln;class Rr{constructor(){this.format=void 0,this.multisampledBuffer=void 0}destroy(){var e;null==(e=this.multisampledBuffer)||e.destroy(),this.multisampledBuffer=null}}class Lr{constructor(e){this.format=void 0,this.hasStencil=void 0,this.depthTexture=null,this.depthTextureInternal=!1,this.multisampledDepthBuffer=null,this.multisampledDepthBufferKey=void 0,this.format=e,this.hasStencil="depth24plus-stencil8"===e}destroy(e){var t;this.depthTextureInternal&&(null==(t=this.depthTexture)||t.destroy(),this.depthTexture=null);this.multisampledDepthBuffer&&(this.multisampledDepthBuffer=null,Mr(e).release(this.multisampledDepthBufferKey))}}class Ir{constructor(e){this.initialized=!1,this.key=void 0,this.colorAttachments=[],this.depthAttachment=null,this.assignedColorTexture=null,this.renderPassDescriptor={},this.isBackbuffer=!1,this.renderTarget=e}destroy(e){var t;this.initialized=!1,this.assignedColorTexture=null,this.colorAttachments.forEach((e=>{e.destroy()})),this.colorAttachments.length=0,null==(t=this.depthAttachment)||t.destroy(e),this.depthAttachment=null}updateKey(){let e=`${this.renderTarget.samples}:${this.depthAttachment?this.depthAttachment.format:"nodepth"}`;this.colorAttachments.forEach((t=>{e+=`:${t.format}`})),this.key=Dr.get(e)}assignColorTexture(e,t){this.assignedColorTexture=t;const s=t.createView({format:e.backBufferViewFormat}),i=this.renderPassDescriptor.colorAttachments[0];this.renderTarget.samples>1?i.resolveTarget=s:i.view=s,this.setColorAttachment(0,void 0,e.backBufferViewFormat),this.updateKey()}setColorAttachment(e,t,s){this.colorAttachments[e]||(this.colorAttachments[e]=new Rr),t&&(this.colorAttachments[e].multisampledBuffer=t),s&&(this.colorAttachments[e].format=s)}init(e,t){var s,i;const n=e.wgpu;this.initDepthStencil(e,n,t),t._colorBuffers&&t._colorBuffers.forEach(((e,t)=>{this.setColorAttachment(t,void 0,e.impl.format)})),this.renderPassDescriptor.colorAttachments=[];const r=this.isBackbuffer?1:null!=(s=null==(i=t._colorBuffers)?void 0:i.length)?s:0;for(let s=0;s<r;++s){var a;const i=this.initColor(e,n,t,s),r=0===s&&(null==(a=this.colorAttachments[0])?void 0:a.format);(i.view||r)&&this.renderPassDescriptor.colorAttachments.push(i)}this.updateKey(),this.initialized=!0}initDepthStencil(e,t,s){const{samples:i,width:n,height:r,depth:a,depthBuffer:o}=s;if(a||o){let s;if(o)if(this.depthAttachment=new Lr(o.impl.format),i>1){const a="depth24plus-stencil8";this.depthAttachment.format=a,this.depthAttachment.hasStencil="depth24plus-stencil8"===a;const l=`${o.id}:${n}:${r}:${i}:${a}`,h=Mr(e);let c=h.get(l);if(!c){const e={size:[n,r,1],dimension:"2d",sampleCount:i,format:a,usage:GPUTextureUsage.RENDER_ATTACHMENT|(a!==o.impl.format?GPUTextureUsage.TEXTURE_BINDING:0)};c=t.createTexture(e),h.set(l,c)}this.depthAttachment.multisampledDepthBuffer=c,this.depthAttachment.multisampledDepthBufferKey=l,s=c.createView()}else{const e=o.impl.gpuTexture;this.depthAttachment.depthTexture=e,s=e.createView()}else{this.depthAttachment=new Lr("depth24plus-stencil8");const e={size:[n,r,1],dimension:"2d",sampleCount:i,format:this.depthAttachment.format,usage:GPUTextureUsage.RENDER_ATTACHMENT};e.usage|=i>1?GPUTextureUsage.TEXTURE_BINDING:GPUTextureUsage.COPY_SRC;const a=t.createTexture(e);this.depthAttachment.depthTexture=a,this.depthAttachment.depthTextureInternal=!0,s=a.createView()}this.renderPassDescriptor.depthStencilAttachment={view:s}}}initColor(e,t,s,i){const n={},{samples:r,width:a,height:o,mipLevel:l}=s,h=s.getColorBuffer(i);let c=null;if(h){const e=1;c=h.cubemap?h.impl.createView({dimension:"2d",baseArrayLayer:s.face,arrayLayerCount:1,mipLevelCount:e,baseMipLevel:l}):h.impl.createView({mipLevelCount:e,baseMipLevel:l})}if(r>1){const s={size:[a,o,1],dimension:"2d",sampleCount:r,format:this.isBackbuffer?e.backBufferViewFormat:h.impl.format,usage:GPUTextureUsage.RENDER_ATTACHMENT},l=t.createTexture(s);this.setColorAttachment(i,l,s.format),n.view=l.createView(),n.resolveTarget=c}else n.view=c;return n}setupForRenderPass(e,t){var s,i;const n=null!=(s=null==(i=this.renderPassDescriptor.colorAttachments)?void 0:i.length)?s:0;for(let s=0;s<n;++s){const i=this.renderPassDescriptor.colorAttachments[s],n=e.colorArrayOps[s],r=t.isColorBufferSrgb(s);i.clearValue=r?n.clearValueLinear:n.clearValue,i.loadOp=n.clear?"clear":"load",i.storeOp=n.store?"store":"discard"}const r=this.renderPassDescriptor.depthStencilAttachment;r&&(r.depthClearValue=e.depthStencilOps.clearDepthValue,r.depthLoadOp=e.depthStencilOps.clearDepth?"clear":"load",r.depthStoreOp=e.depthStencilOps.storeDepth?"store":"discard",r.depthReadOnly=!1,this.depthAttachment.hasStencil&&(r.stencilClearValue=e.depthStencilOps.clearStencilValue,r.stencilLoadOp=e.depthStencilOps.clearStencil?"clear":"load",r.stencilStoreOp=e.depthStencilOps.storeStencil?"store":"discard",r.stencilReadOnly=!1))}loseContext(){this.initialized=!1}resolve(e,t,s,i){}}const Fr=[];Fr[2]=1,Fr[3]=2,Fr[4]=3,Fr[5]=4,Fr[1]=1,Fr[6]=2,Fr[7]=3,Fr[8]=4,Fr[0]=1,Fr[9]=2,Fr[10]=3,Fr[11]=4,Fr[12]=8,Fr[13]=12,Fr[14]=16,Fr[26]=1,Fr[27]=2,Fr[28]=3,Fr[29]=4;class Or{get isArrayType(){return this.count>0}constructor(e,t,s=0){if(this.name=void 0,this.type=void 0,this.byteSize=void 0,this.offset=void 0,this.scopeId=void 0,this.count=void 0,this.numComponents=void 0,this.shortName=e,this.name=s?`${e}[0]`:e,this.type=t,this.numComponents=Fr[t],this.updateType=t,s>0)switch(t){case 2:this.updateType=17;break;case 1:this.updateType=$i;break;case Gi:this.updateType=31;break;case 0:this.updateType=32;break;case 3:this.updateType=21;break;case 6:this.updateType=qi;break;case Hi:this.updateType=34;break;case 9:this.updateType=35;break;case 4:this.updateType=22;break;case 7:this.updateType=Xi;break;case ji:this.updateType=37;break;case 10:this.updateType=38;break;case 5:this.updateType=23;break;case 8:this.updateType=39;break;case Wi:this.updateType=40;break;case 11:this.updateType=41;break;case Vi:this.updateType=24}this.count=s;let i=this.numComponents;s&&(i=rs.roundUp(i,4)),this.byteSize=4*i,s&&(this.byteSize*=s)}calculateOffset(e){let t=this.byteSize<=8?this.byteSize:16;this.count&&(t=16),e=rs.roundUp(e,t),this.offset=e/4}}class Br{constructor(e,t){this.byteSize=0,this.map=new Map,this.scope=e.scope,this.uniforms=t;let s=0;for(let e=0;e<t.length;e++){const i=t[e];i.calculateOffset(s),s=4*i.offset+i.byteSize,i.scopeId=this.scope.resolve(i.name),this.map.set(i.name,i)}this.byteSize=rs.roundUp(s,16)}get(e){return this.map.get(e)}getShaderDeclaration(e,t){let s=`layout(set = ${e}, binding = ${t}, std140) uniform ub_${en[e]} {\n`;return this.uniforms.forEach((e=>{const t=Ki[e.type];s+=`    ${t} ${e.shortName}${e.count?`[${e.count}]`:""};\n`})),`${s}};\n`}}const zr=/[ \t]*(\battribute\b|\bvarying\b|\buniform\b)/g,Nr=/(\battribute\b|\bvarying\b|\bout\b|\buniform\b)[ \t]*([^;]+)(;+)/g,Ur="@@@",Vr=/([\w-]+)\[(.*?)\]/,Gr=new Set(["highp","mediump","lowp"]),Hr=new Set(["sampler2DShadow","samplerCubeShadow","sampler2DArrayShadow"]),jr={sampler2D:Ii,sampler3D:Bi,samplerCube:Oi,samplerCubeShadow:Oi,sampler2DShadow:Ii,sampler2DArray:Fi,sampler2DArrayShadow:Fi,isampler2D:Ii,usampler2D:Ii,isampler3D:Bi,usampler3D:Bi,isamplerCube:Oi,usamplerCube:Oi,isampler2DArray:Fi,usampler2DArray:Fi};class Wr{constructor(e,t){this.line=e;const s=e.trim().split(/\s+/);if(Gr.has(s[0])&&(this.precision=s.shift()),this.type=s.shift(),e.includes(","),e.includes("[")){const e=s.join(" "),i=Vr.exec(e);this.name=i[1],this.arraySize=Number(i[2]),isNaN(this.arraySize)&&(t.failed=!0)}else this.name=s.shift(),this.arraySize=0;this.isSampler=-1!==this.type.indexOf("sampler"),this.isSignedInt=-1!==this.type.indexOf("isampler"),this.isUnsignedInt=-1!==this.type.indexOf("usampler")}}class $r{static run(e,t,s){const i=new Map,n=$r.extract(t.vshader),r=$r.extract(t.fshader),a=$r.processAttributes(n.attributes,t.attributes,t.processingOptions),o=$r.processVaryings(n.varyings,i,!0),l=$r.processVaryings(r.varyings,i,!1),h=$r.processOuts(r.outs),c=n.uniforms.concat(r.uniforms),d=Array.from(new Set(c)).map((e=>new Wr(e,s))),u=$r.processUniforms(e,d,t.processingOptions,s),p=`${a}\n${o}\n${u.code}`,f=n.src.replace(Ur,p),m=`${l}\n${h}\n${u.code}`;return{vshader:f,fshader:r.src.replace(Ur,m),meshUniformBufferFormat:u.meshUniformBufferFormat,meshBindGroupFormat:u.meshBindGroupFormat}}static extract(e){const t=[],s=[],i=[],n=[];let r,a=`${Ur}\n`;for(;null!==(r=zr.exec(e));){const o=r[1];switch(o){case"attribute":case"varying":case"uniform":case"out":{Nr.lastIndex=r.index;const l=Nr.exec(e);"attribute"===o?t.push(l[2]):"varying"===o?s.push(l[2]):"out"===o?i.push(l[2]):"uniform"===o&&n.push(l[2]),e=$r.cutOut(e,r.index,Nr.lastIndex,a),zr.lastIndex=r.index+a.length,a="";break}}}return{src:e,attributes:t,varyings:s,outs:i,uniforms:n}}static processUniforms(e,t,s,i){const n=[],r=[];t.forEach((e=>{e.isSampler?n.push(e):r.push(e)}));const a=[];r.forEach((e=>{if(!s.hasUniform(e.name)){const t=Ki.indexOf(e.type),s=new Or(e.name,t,e.arraySize);a.push(s)}}));const o=a.length?new Br(e,a):null,l=[];n.forEach((e=>{if(!s.hasTexture(e.name)){let t=0;e.isSignedInt?t=3:e.isUnsignedInt?t=4:("highp"===e.precision&&(t=1),Hr.has(e.type)&&(t=2));const s=jr[e.type];l.push(new fn(e.name,3,s,t))}}));const h=new gn(e,l);let c="";return s.uniformFormats.forEach(((e,t)=>{e&&(c+=e.getShaderDeclaration(t,0))})),o&&(c+=o.getShaderDeclaration(2,0)),s.bindGroupFormats.forEach(((e,t)=>{e&&(c+=e.getShaderDeclarationTextures(t))})),c+=h.getShaderDeclarationTextures(1),{code:c,meshUniformBufferFormat:o,meshBindGroupFormat:h}}static processVaryings(e,t,s){let i="";const n=s?"out":"in";return e.forEach(((e,r)=>{const a=$r.splitToWords(e),o=a.slice(0,-1).join(" "),l=a[a.length-1];s?t.set(l,r):r=t.get(l),i+=`layout(location = ${r}) ${n} ${o} ${l};\n`})),i}static processOuts(e){let t="";return e.forEach(((e,s)=>{t+=`layout(location = ${s}) out ${e};\n`})),t}static getTypeCount(e){const t=e.substring(e.length-1),s=parseInt(t,10);return isNaN(s)?1:s}static processAttributes(e,t,s){let i="";return e.forEach((e=>{const n=$r.splitToWords(e);let r=n[0],a=n[1];if(t.hasOwnProperty(a)){const e=t[a],n=on[e];let o;const l=s.getVertexElement(e);if(l){const e=l.dataType;if(6!==e&&7!==e&&!l.normalize&&!l.asInt){const t=$r.getTypeCount(r),s=`_private_${a}`;o=`vec${t} ${a} = vec${t}(${s});\n`,a=s;const i=0===e||2===e||4===e;r=1===t?i?"int":"uint":i?`ivec${t}`:`uvec${t}`}}i+=`layout(location = ${n}) in ${r} ${a};\n`,o&&(i+=o)}})),i}static splitToWords(e){return(e=e.replace(/\s+/g," ").trim()).split(" ")}static cutOut(e,t,s,i){return e.substring(0,t)+i+e.substring(s)}}class qr{constructor(e){this._vertexCode=null,this._fragmentCode=null,this._computeCode=null,this.vertexEntryPoint="main",this.fragmentEntryPoint="main",this.computeEntryPoint="main",this.shader=e;const t=e.definition;var s,i,n;t.shaderLanguage===Ui?(this._vertexCode=null!=(s=t.vshader)?s:null,this._fragmentCode=null!=(i=t.fshader)?i:null,this._computeCode=null!=(n=t.cshader)?n:null,e.meshUniformBufferFormat=t.meshUniformBufferFormat,e.meshBindGroupFormat=t.meshBindGroupFormat,this.computeUniformBufferFormats=t.computeUniformBufferFormats,this.computeBindGroupFormat=t.computeBindGroupFormat,this.vertexEntryPoint="vertexMain",this.fragmentEntryPoint="fragmentMain",e.ready=!0):t.processingOptions&&this.process()}destroy(e){this._vertexCode=null,this._fragmentCode=null}createShaderModule(e,t){return this.shader.device.wgpu.createShaderModule({code:e})}getVertexShaderModule(){return this.createShaderModule(this._vertexCode,"Vertex")}getFragmentShaderModule(){return this.createShaderModule(this._fragmentCode,"Fragment")}getComputeShaderModule(){return this.createShaderModule(this._computeCode,"Compute")}process(){const e=this.shader,t=$r.run(e.device,e.definition,e);this._vertexCode=this.transpile(t.vshader,"vertex",e.definition.vshader),this._fragmentCode=this.transpile(t.fshader,"fragment",e.definition.fshader),this._vertexCode&&this._fragmentCode?e.ready=!0:e.failed=!0,e.meshUniformBufferFormat=t.meshUniformBufferFormat,e.meshBindGroupFormat=t.meshBindGroupFormat}transpile(e,t,s){try{const s=this.shader.device.glslang.compileGLSL(e,t);return this.shader.device.twgsl.convertSpirV2WGSL(s)}catch(i){console.error(`Failed to transpile webgl ${t} shader [${this.shader.label}] to WebGPU while rendering undefined, error:\n [${i.stack}]`,{processed:e,original:s,shader:this.shader,error:i,stack:i.stack})}}get vertexCode(){return this._vertexCode}get fragmentCode(){return this._fragmentCode}loseContext(){}restoreContext(e,t){}}const Xr=[];Xr[0]="repeat",Xr[1]="clamp-to-edge",Xr[2]="mirror-repeat";const Kr=[];Kr[0]={level:"nearest",mip:"nearest"},Kr[1]={level:"linear",mip:"nearest"},Kr[2]={level:"nearest",mip:"nearest"},Kr[3]={level:"nearest",mip:"linear"},Kr[4]={level:"linear",mip:"nearest"},Kr[5]={level:"linear",mip:"linear"};class Yr{constructor(e){this.gpuTexture=void 0,this.view=void 0,this.samplers=[],this.desc=void 0,this.format=void 0,this.texture=e,this.format=nr[e.format],this.create(e.device)}create(e){const t=this.texture,s=e.wgpu,i=t.numLevels;let n;this.desc={size:{width:t.width,height:t.height,depthOrArrayLayers:t.cubemap?6:t.array?t.arrayLength:1},format:this.format,mipLevelCount:i,sampleCount:1,dimension:t.volume?"3d":"2d",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.COPY_SRC|(ii(t.format)?0:GPUTextureUsage.RENDER_ATTACHMENT)|(t.storage?GPUTextureUsage.STORAGE_BINDING:0)},this.gpuTexture=s.createTexture(this.desc),this.texture.format===Ks&&(n={format:"depth24plus",aspect:"depth-only"}),this.view=this.createView(n)}destroy(e){}propertyChanged(e){this.samplers.length=0}getView(e){return this.uploadImmediate(e,this.texture),this.view}createView(e){var t,s,i,n,r,a,o;const l=null!=e?e:{},h=this.desc,c=this.texture,d={format:null!=(t=l.format)?t:h.format,dimension:null!=(s=l.dimension)?s:c.cubemap?"cube":c.volume?"3d":c.array?"2d-array":"2d",aspect:null!=(i=l.aspect)?i:"all",baseMipLevel:null!=(n=l.baseMipLevel)?n:0,mipLevelCount:null!=(r=l.mipLevelCount)?r:h.mipLevelCount,baseArrayLayer:null!=(a=l.baseArrayLayer)?a:0,arrayLayerCount:null!=(o=l.arrayLayerCount)?o:h.depthOrArrayLayers};return this.gpuTexture.createView(d)}getSampler(e,t){let s=this.samplers[t];if(!s){const i=this.texture,n={addressModeU:Xr[i.addressU],addressModeV:Xr[i.addressV],addressModeW:Xr[i.addressW]};if(!t&&i.compareOnRead&&(t=2),2===t||3===t||4===t)n.compare="less",n.magFilter="linear",n.minFilter="linear";else if(1===t)n.magFilter="nearest",n.minFilter="nearest",n.mipmapFilter="nearest";else{!e.textureFloatFilterable&&(i.format===$s||i.format===Ws)||this.texture.format===Ks||ri(this.texture.format)?(n.magFilter="nearest",n.minFilter="nearest",n.mipmapFilter="nearest"):(n.magFilter=Kr[i.magFilter].level,n.minFilter=Kr[i.minFilter].level,n.mipmapFilter=Kr[i.minFilter].mip)}const r="linear"===n.minFilter&&"linear"===n.magFilter&&"linear"===n.mipmapFilter;n.maxAnisotropy=r?rs.clamp(Math.round(i._anisotropy),1,e.maxTextureAnisotropy):1,s=e.wgpu.createSampler(n),this.samplers[t]=s}return s}loseContext(){}uploadImmediate(e,t){(t._needsUpload||t._needsMipmapsUpload)&&(this.uploadData(e),t._needsUpload=!1,t._needsMipmapsUpload=!1)}uploadData(e){const t=this.texture;if(t._levels){let s=!1,i=!1;const n=t.numLevels;for(let r=0;r<n;r++){const n=t._levels[r];if(n)if(t.cubemap)for(let t=0;t<6;t++){const a=n[t];a?this.isExternalImage(a)?(this.uploadExternalImage(e,a,r,t),s=!0):ArrayBuffer.isView(a)&&(this.uploadTypedArrayData(e,a,r,t),s=!0):i=!0}else if(t._volume);else if(t.array)if(t.arrayLength===n.length)for(let i=0;i<t._arrayLength;i++){const t=n[i];this.isExternalImage(t)?(this.uploadExternalImage(e,t,r,i),s=!0):ArrayBuffer.isView(t)&&(this.uploadTypedArrayData(e,t,r,i),s=!0)}else i=!0;else this.isExternalImage(n)?(this.uploadExternalImage(e,n,r,0),s=!0):ArrayBuffer.isView(n)&&(this.uploadTypedArrayData(e,n,r,0),s=!0);else i=!0}s&&i&&t.mipmaps&&!ii(t.format)&&!ri(t.format)&&e.mipmapRenderer.generate(this),t._gpuSize&&t.adjustVramSizeTracking(e._vram,-t._gpuSize),t._gpuSize=t.gpuSize,t.adjustVramSizeTracking(e._vram,t._gpuSize)}}isExternalImage(e){return e instanceof ImageBitmap||e instanceof HTMLVideoElement||e instanceof HTMLCanvasElement||e instanceof OffscreenCanvas}uploadExternalImage(e,t,s,i){const n={source:t,origin:[0,0],flipY:!1},r={texture:this.gpuTexture,mipLevel:s,origin:[0,0,i],aspect:"all"},a={width:this.desc.size.width,height:this.desc.size.height,depthOrArrayLayers:1};e.submit(),t instanceof HTMLCanvasElement&&t.getContext("2d"),e.wgpu.queue.copyExternalImageToTexture(n,r,a)}uploadTypedArrayData(e,t,s,i){const n=this.texture,r=e.wgpu,a={texture:this.gpuTexture,origin:[0,0,i],mipLevel:s},o=vn.calcLevelDimension(n.width,s),l=vn.calcLevelDimension(n.height,s);vn.calcLevelGpuSize(o,l,1,n.format);const h=si.get(n.format);let c,d;if(h.size)c={offset:0,bytesPerRow:h.size*o,rowsPerImage:l},d={width:o,height:l};else if(h.blockSize){const e=e=>Math.floor((e+3)/4);c={offset:0,bytesPerRow:h.blockSize*e(o),rowsPerImage:e(l)},d={width:Math.max(4,o),height:Math.max(4,l)}}e.submit(),r.queue.writeTexture(a,t,c,d)}read(e,t,s,i,n){var r,a,o,l;const h=null!=(r=n.mipLevel)?r:0,c=null!=(a=n.face)?a:0;let d=null!=(o=n.data)?o:null;const u=null!=(l=n.immediate)&&l,p=this.texture,f=s*si.get(p.format).size,m=rs.roundUp(f,256),g=m*i,_=p.device,v=_.createBufferImpl(9);v.allocate(_,g);const b={texture:this.gpuTexture,mipLevel:h,origin:[e,t,c]},y={buffer:v.buffer,offset:0,bytesPerRow:m},x={width:s,height:i,depthOrArrayLayers:1};return _.getCommandEncoder().copyTextureToBuffer(b,y,x),_.readBuffer(v,g,null,u).then((e=>{null!=d||(d=new Uint8Array(i*f));for(let t=0;t<i;t++){const s=t*m,i=t*f,n=e.subarray(s,s+f);d.set(n,i)}return d}))}}class Qr extends hr{constructor(e){super(64)}unlock(e){const t=e.device;super.unlock(t,e.storageInt32.buffer)}}class Jr extends hr{constructor(e,t,s){super(32|(null!=s&&s.storage?128:0))}unlock(e){const t=e.device;super.unlock(t,e.storage)}}const Zr=/[ \t]*#(ifn?def|if|endif|else|elif|define|undef|extension|include)/g,ea=/define[ \t]+([^\n]+)\r?(?:\n|$)/g,ta=/extension[ \t]+([\w-]+)[ \t]*:[ \t]*(enable|require)/g,sa=/undef[ \t]+([^\n]+)\r?(?:\n|$)/g,ia=/(ifdef|ifndef|if)[ \t]*([^\r\n]+)\r?\n/g,na=/(endif|else|elif)([ \t][^\r\n]+)?\r?(?:\n|$)/g,ra=/([\w-]+)/,aa=/(!|\s)?defined\(([\w-]+)\)/,oa=/([a-z_]\w*)\s*(==|!=|<|<=|>|>=)\s*([\w"']+)/i,la=/[|&+-]/g,ha=/include[ \t]+"([\w-]+)"\r?(?:\n|$)/g;class ca{static run(e,t=new Map,s=!1){e=(e=this.stripComments(e)).split(/\r?\n/).map((e=>e.trimEnd())).join("\n");const i=new Map;if(s){const t=new Map,s=/(pcFragColor[1-8])\b/g,n=e.match(s);null==n||n.forEach((e=>{var s;const i=parseInt(e.charAt(e.length-1),10);t.set(i,(null!=(s=t.get(i))?s:0)+1)})),t.forEach(((e,t)=>{1===e&&i.set(`REMOVE_COLOR_ATTACHMENT_${t}`,"")}))}e=this._preprocess(e,i,t);const n=new Map;return i.forEach(((e,t)=>{Number.isInteger(parseFloat(e))&&!e.includes(".")&&n.set(t,e)})),e=this.stripComments(e),e=this.RemoveEmptyLines(e),e=this.processArraySize(e,n)}static stripComments(e){return e.replace(/\/\*[\s\S]*?\*\/|([^\\:]|^)\/\/.*$/gm,"$1")}static processArraySize(e,t){return null!==e&&t.forEach(((t,s)=>{e=e.replace(new RegExp(`\\[${s}\\]`,"g"),`[${t}]`)})),e}static RemoveEmptyLines(e){return null!==e&&(e=(e=e.split(/\r?\n/).map((e=>""===e.trim()?"":e)).join("\n")).replace(/(\n\n){3,}/g,"\n\n")),e}static _preprocess(e,t=new Map,s){const i=e,n=[];let r,a=!1;for(;null!==(r=Zr.exec(e));){const o=r[1];switch(o){case"define":{ea.lastIndex=r.index;const s=ea.exec(e);a||(a=null===s);const i=s[1];ra.lastIndex=s.index;const o=ra.exec(i)[1];let l=i.substring(o.length).trim();""===l&&(l="true");ca._keep(n)&&t.set(o,l),Zr.lastIndex=s.index+s[0].length;break}case"undef":{sa.lastIndex=r.index;const s=sa.exec(e),i=s[1].trim();ca._keep(n)&&t.delete(i),Zr.lastIndex=s.index+s[0].length;break}case"extension":{ta.lastIndex=r.index;const s=ta.exec(e);if(a||(a=null===s),s){const e=s[1];ca._keep(n)&&t.set(e,"true")}Zr.lastIndex=s.index+s[0].length;break}case"ifdef":case"ifndef":case"if":{ia.lastIndex=r.index;const s=ia.exec(e),i=s[2],l=ca.evaluate(i,t);a||(a=l.error);let h=l.result;"ifndef"===o&&(h=!h),n.push({anyKeep:h,keep:h,start:r.index,end:ia.lastIndex}),Zr.lastIndex=s.index+s[0].length;break}case"endif":case"else":case"elif":{na.lastIndex=r.index;const s=na.exec(e),i=n.pop(),o=i.keep?e.substring(i.end,r.index):"";e=e.substring(0,i.start)+o+e.substring(na.lastIndex),Zr.lastIndex=i.start+o.length;const l=s[1];if("else"===l||"elif"===l){let e=!1;if(!i.anyKeep)if("else"===l)e=!i.keep;else{const i=ca.evaluate(s[2],t);e=i.result,a||(a=i.error)}n.push({anyKeep:i.anyKeep||e,keep:e,start:Zr.lastIndex,end:Zr.lastIndex})}break}case"include":{ha.lastIndex=r.index;const t=ha.exec(e);a||(a=null===t);const o=t[1].trim();if(ca._keep(n)){const n=null==s?void 0:s.get(o);void 0!==n?(e=e.substring(0,t.index-1)+n+e.substring(ha.lastIndex),Zr.lastIndex=t.index):(console.error(`Include "${o}" not resolved while preprocessing a shader`,{source:i}),a=!0)}break}}}return a?(console.warn("Failed to preprocess shader: ",{source:i}),i):e}static _keep(e){for(let t=0;t<e.length;t++)if(!e[t].keep)return!1;return!0}static evaluate(e,t){const s=null===la.exec(e);let i=!1;const n=aa.exec(e);n&&(i="!"===n[1],e=n[2]);const r=oa.exec(e);if(r){var a,o;const e=null!=(a=t.get(r[1]))?a:r[1],i=null!=(o=t.get(r[3]))?o:r[3];let n=!1;switch(r[2]){case"==":n=e===i;break;case"!=":n=e!==i;break;case"<":n=e<i;break;case"<=":n=e<=i;break;case">":n=e>i;break;case">=":n=e>=i}return{result:n,error:!s}}e=e.trim();let l=t.has(e);return i&&(l=!l),{result:l,error:!s}}}var da="\n#ifndef outType_0\n#define outType_0 vec4\n#endif\nlayout(location = 0) out highp outType_0 pc_fragColor;\n#ifndef REMOVE_COLOR_ATTACHMENT_1\n#if COLOR_ATTACHMENT_1\nlayout(location = 1) out highp outType_1 pc_fragColor1;\n#endif\n#endif\n#ifndef REMOVE_COLOR_ATTACHMENT_2\n#if COLOR_ATTACHMENT_2\nlayout(location = 2) out highp outType_2 pc_fragColor2;\n#endif\n#endif\n#ifndef REMOVE_COLOR_ATTACHMENT_3\n#if COLOR_ATTACHMENT_3\nlayout(location = 3) out highp outType_3 pc_fragColor3;\n#endif\n#endif\n#ifndef REMOVE_COLOR_ATTACHMENT_4\n#if COLOR_ATTACHMENT_4\nlayout(location = 4) out highp outType_4 pc_fragColor4;\n#endif\n#endif\n#ifndef REMOVE_COLOR_ATTACHMENT_5\n#if COLOR_ATTACHMENT_5\nlayout(location = 5) out highp outType_5 pc_fragColor5;\n#endif\n#endif\n#ifndef REMOVE_COLOR_ATTACHMENT_6\n#if COLOR_ATTACHMENT_6\nlayout(location = 6) out highp outType_6 pc_fragColor6;\n#endif\n#endif\n#ifndef REMOVE_COLOR_ATTACHMENT_7\n#if COLOR_ATTACHMENT_7\nlayout(location = 7) out highp outType_7 pc_fragColor7;\n#endif\n#endif\n#define gl_FragColor pc_fragColor\n#define pcFragColor0 pc_fragColor\n#define pcFragColor1 pc_fragColor1\n#define pcFragColor2 pc_fragColor2\n#define pcFragColor3 pc_fragColor3\n#define pcFragColor4 pc_fragColor4\n#define pcFragColor5 pc_fragColor5\n#define pcFragColor6 pc_fragColor6\n#define pcFragColor7 pc_fragColor7\n#define varying in\n#define texture2D texture\n#define texture2DBias texture\n#define textureCube texture\n#define texture2DProj textureProj\n#define texture2DLodEXT textureLod\n#define texture2DProjLodEXT textureProjLod\n#define textureCubeLodEXT textureLod\n#define texture2DGradEXT textureGrad\n#define texture2DProjGradEXT textureProjGrad\n#define textureCubeGradEXT textureGrad\n#define utexture2D texture\n#define itexture2D texture\n#define textureShadow(res, uv) textureGrad(res, uv, vec2(1, 1), vec2(1, 1))\n#define SHADOWMAP_PASS(name) name\n#define SHADOWMAP_ACCEPT(name) sampler2DShadow name\n#define TEXTURE_PASS(name) name\n#define TEXTURE_ACCEPT(name) sampler2D name\n#define TEXTURE_ACCEPT_HIGHP(name) highp sampler2D name\n#define GL2\n",ua="\n#define attribute in\n#define varying out\n#define texture2D texture\n#define utexture2D texture\n#define itexture2D texture\n#define GL2\n#define VERTEXSHADER\n#define TEXTURE_PASS(name) name\n#define TEXTURE_ACCEPT(name) sampler2D name\n#define TEXTURE_ACCEPT_HIGHP(name) highp sampler2D name\n",pa="\n#extension GL_EXT_samplerless_texture_functions : require\n#ifndef outType_0\n#define outType_0 vec4\n#endif\n#ifndef outType_1\n#define outType_1 vec4\n#endif\n#ifndef outType_2\n#define outType_2 vec4\n#endif\n#ifndef outType_3\n#define outType_3 vec4\n#endif\n#ifndef outType_4\n#define outType_4 vec4\n#endif\n#ifndef outType_5\n#define outType_5 vec4\n#endif\n#ifndef outType_6\n#define outType_6 vec4\n#endif\n#ifndef outType_7\n#define outType_7 vec4\n#endif\nlayout(location = 0) out highp outType_0 pc_fragColor;\nlayout(location = 1) out highp outType_1 pc_fragColor1;\nlayout(location = 2) out highp outType_2 pc_fragColor2;\nlayout(location = 3) out highp outType_3 pc_fragColor3;\nlayout(location = 4) out highp outType_4 pc_fragColor4;\nlayout(location = 5) out highp outType_5 pc_fragColor5;\nlayout(location = 6) out highp outType_6 pc_fragColor6;\nlayout(location = 7) out highp outType_7 pc_fragColor7;\n#define gl_FragColor pc_fragColor\n#define pcFragColor0 pc_fragColor\n#define pcFragColor1 pc_fragColor1\n#define pcFragColor2 pc_fragColor2\n#define pcFragColor3 pc_fragColor3\n#define pcFragColor4 pc_fragColor4\n#define pcFragColor5 pc_fragColor5\n#define pcFragColor6 pc_fragColor6\n#define pcFragColor7 pc_fragColor7\n#define texture2D(res, uv) texture(sampler2D(res, res ## _sampler), uv)\n#define texture2DBias(res, uv, bias) texture(sampler2D(res, res ## _sampler), uv, bias)\n#define texture2DLodEXT(res, uv, lod) textureLod(sampler2D(res, res ## _sampler), uv, lod)\n#define textureCube(res, uv) texture(samplerCube(res, res ## _sampler), uv)\n#define textureCubeLodEXT(res, uv, lod) textureLod(samplerCube(res, res ## _sampler), uv, lod)\n#define textureShadow(res, uv) textureLod(sampler2DShadow(res, res ## _sampler), uv, 0.0)\n#define itexture2D(res, uv) texture(isampler2D(res, res ## _sampler), uv)\n#define utexture2D(res, uv) texture(usampler2D(res, res ## _sampler), uv)\n#define SHADOWMAP_PASS(name) name, name ## _sampler\n#define SHADOWMAP_ACCEPT(name) texture2D name, sampler name ## _sampler\n#define TEXTURE_PASS(name) name, name ## _sampler\n#define TEXTURE_ACCEPT(name) texture2D name, sampler name ## _sampler\n#define TEXTURE_ACCEPT_HIGHP TEXTURE_ACCEPT\n#define GL2\n#define WEBGPU\n",fa="\n#extension GL_EXT_samplerless_texture_functions : require\n#define texture2D(res, uv) texture(sampler2D(res, res ## _sampler), uv)\n#define itexture2D(res, uv) texture(isampler2D(res, res ## _sampler), uv)\n#define utexture2D(res, uv) texture(usampler2D(res, res ## _sampler), uv)\n#define TEXTURE_PASS(name) name, name ## _sampler\n#define TEXTURE_ACCEPT(name) texture2D name, sampler name ## _sampler\n#define TEXTURE_ACCEPT_HIGHP TEXTURE_ACCEPT\n#define GL2\n#define WEBGPU\n#define VERTEXSHADER\n#define gl_VertexID gl_VertexIndex\n#define gl_InstanceID gl_InstanceIndex\n",ma="\nvec2 getGrabScreenPos(vec4 clipPos) {\n\tvec2 uv = (clipPos.xy / clipPos.w) * 0.5 + 0.5;\n\t#ifdef WEBGPU\n\t\tuv.y = 1.0 - uv.y;\n\t#endif\n\treturn uv;\n}\nvec2 getImageEffectUV(vec2 uv) {\n\t#ifdef WEBGPU\n\t\tuv.y = 1.0 - uv.y;\n\t#endif\n\treturn uv;\n}\n";const ga={vertex_position:li,vertex_normal:hi,vertex_tangent:ci,vertex_texCoord0:mi,vertex_texCoord1:gi,vertex_texCoord2:_i,vertex_texCoord3:vi,vertex_texCoord4:bi,vertex_texCoord5:yi,vertex_texCoord6:xi,vertex_texCoord7:wi,vertex_color:pi,vertex_boneIndices:ui,vertex_boneWeights:di};class _a{static createDefinition(e,t){var s;const i=(t,s,i,n)=>{const r=e.isWebGPU?t:s;let a="";if(!i){var o;let t=null!=(o=n.fragmentOutputTypes)?o:"vec4";Array.isArray(t)||(t=[t]);for(let s=0;s<e.maxColorAttachments;s++){var l;a+=`#define COLOR_ATTACHMENT_${s}\n`;a+=`#define outType_${s} ${null!=(l=t[s])?l:"vec4"}\n`}}return a+r},n=null!=(s=t.name)?s:"Untitled";let r,a;return t.shaderLanguage===Ui?(r=t.vertexCode,a=t.fragmentCode):(r=`${_a.versionCode(e)+i(fa,ua,!0,t)+_a.getDefinesCode(t.vertexDefines)+_a.precisionCode(e)}\n${ma}${_a.getShaderNameCode(n)}${t.vertexCode}`,a=`${(t.fragmentPreamble||"")+_a.versionCode(e)+i(pa,da,!1,t)+_a.getDefinesCode(t.fragmentDefines)+_a.precisionCode(e)}\n${ma}${_a.getShaderNameCode(n)}${t.fragmentCode||_a.dummyFragmentCode()}`),{name:n,shaderLanguage:t.shaderLanguage,attributes:t.attributes,vshader:r,vincludes:t.vertexIncludes,fincludes:t.fragmentIncludes,fshader:a,useTransformFeedback:t.useTransformFeedback,meshUniformBufferFormat:t.meshUniformBufferFormat,meshBindGroupFormat:t.meshBindGroupFormat}}static getDefinesCode(e){let t="";return null==e||e.forEach(((e,s)=>{t+=`#define ${s} ${e}\n`})),t}static getShaderNameCode(e){return`#define SHADER_NAME ${e}\n`}static dummyFragmentCode(){return"void main(void) {gl_FragColor = vec4(0.0);}"}static versionCode(e){return e.isWebGPU?"#version 450\n":"#version 300 es\n"}static precisionCode(e,t){t&&"highp"!==t&&"mediump"!==t&&"lowp"!==t&&(t=null),t&&("highp"===t&&"highp"!==e.maxPrecision&&(t="mediump"),"mediump"===t&&"lowp"===e.maxPrecision&&(t="lowp"));const s=t||e.precision;return`\n\t\t\t\t\t\tprecision ${s} float;\n\t\t\t\t\t\tprecision ${s} int;\n\t\t\t\t\t\tprecision ${s} usampler2D;\n\t\t\t\t\t\tprecision ${s} isampler2D;\n\t\t\t\t\t\tprecision ${s} sampler2DShadow;\n\t\t\t\t\t\tprecision ${s} samplerCubeShadow;\n\t\t\t\t\t\tprecision ${s} sampler2DArray;\n\t\t\t\t`}static collectAttributes(e){const t={};let s=0,i=e.indexOf("attribute");for(;i>=0&&!(i>0&&"/"===e[i-1]);){let n=!1;if(i>0){let t=e.lastIndexOf("\n",i);t=-1!==t?t+1:0;e.substring(t,i).includes("#")&&(n=!0)}if(!n){const n=e.indexOf(";",i),r=e.lastIndexOf(" ",n),a=e.substring(r+1,n);if(t[a]);else{const e=ga[a];void 0!==e?t[a]=e:(t[a]=`ATTR${s}`,s++)}}i=e.indexOf("attribute",i+1)}return t}}let va=0;class ba{constructor(e,t){if(this.meshUniformBufferFormat=void 0,this.meshBindGroupFormat=void 0,this.id=va++,this.device=e,this.definition=t,this.name=t.name||"Untitled",this.init(),t.cshader);else{t.vshader=ca.run(t.vshader,t.vincludes),null!=t.attributes||(t.attributes=_a.collectAttributes(t.vshader));const s=e.isWebGL2&&("osx"===qt.name||"ios"===qt.name);t.fshader=ca.run(t.fshader,t.fincludes,s)}this.impl=e.createShaderImpl(this)}init(){this.ready=!1,this.failed=!1}get label(){return`Shader Id ${this.id} ${this.name}`}destroy(){this.device.onDestroyShader(this),this.impl.destroy(this)}loseContext(){this.init(),this.impl.loseContext()}restoreContext(){this.impl.restoreContext(this.device,this)}}class ya{constructor(){this.gpuBuffer=void 0,this.stagingBuffer=void 0,this.offset=void 0,this.size=void 0}}class xa{constructor(){this.storage=void 0,this.gpuBuffer=void 0,this.offset=void 0}}class wa{constructor(e,t,s){this.bufferSize=void 0,this.gpuBuffers=[],this.stagingBuffers=[],this.usedBuffers=[],this.activeBuffer=null,this.device=e,this.bufferSize=t,this.bufferAlignment=s}destroy(){this.gpuBuffers.forEach((e=>{e.destroy(this.device)})),this.gpuBuffers=null,this.stagingBuffers.forEach((e=>{e.destroy(this.device)})),this.stagingBuffers=null,this.usedBuffers=null,this.activeBuffer=null}alloc(e,t){if(this.activeBuffer){const e=rs.roundUp(this.activeBuffer.size,this.bufferAlignment);this.bufferSize-e<t&&this.scheduleSubmit()}if(!this.activeBuffer){let e=this.gpuBuffers.pop();e||(e=this.createBuffer(this.device,this.bufferSize,!1));let t=this.stagingBuffers.pop();t||(t=this.createBuffer(this.device,this.bufferSize,!0)),this.activeBuffer=new ya,this.activeBuffer.stagingBuffer=t,this.activeBuffer.gpuBuffer=e,this.activeBuffer.offset=0,this.activeBuffer.size=0}const s=this.activeBuffer,i=rs.roundUp(s.size,this.bufferAlignment);e.gpuBuffer=s.gpuBuffer,e.offset=i,e.storage=s.stagingBuffer.alloc(i,t),s.size=i+t}scheduleSubmit(){this.activeBuffer&&(this.usedBuffers.push(this.activeBuffer),this.activeBuffer=null)}submit(){this.scheduleSubmit()}}const Sa=[];Sa[2]=function(e,t,s){e.storageFloat32[s]=t},Sa[3]=(e,t,s)=>{const i=e.storageFloat32;i[s]=t[0],i[s+1]=t[1]},Sa[4]=(e,t,s)=>{const i=e.storageFloat32;i[s]=t[0],i[s+1]=t[1],i[s+2]=t[2]},Sa[5]=(e,t,s)=>{const i=e.storageFloat32;i[s]=t[0],i[s+1]=t[1],i[s+2]=t[2],i[s+3]=t[3]},Sa[1]=function(e,t,s){e.storageInt32[s]=t},Sa[6]=function(e,t,s){const i=e.storageInt32;i[s]=t[0],i[s+1]=t[1]},Sa[7]=function(e,t,s){const i=e.storageInt32;i[s]=t[0],i[s+1]=t[1],i[s+2]=t[2]},Sa[8]=function(e,t,s){const i=e.storageInt32;i[s]=t[0],i[s+1]=t[1],i[s+2]=t[2],i[s+3]=t[3]},Sa[12]=(e,t,s)=>{const i=e.storageFloat32;i[s]=t[0],i[s+1]=t[1],i[s+4]=t[2],i[s+5]=t[3],i[s+8]=t[4],i[s+9]=t[5]},Sa[13]=(e,t,s)=>{const i=e.storageFloat32;i[s]=t[0],i[s+1]=t[1],i[s+2]=t[2],i[s+4]=t[3],i[s+5]=t[4],i[s+6]=t[5],i[s+8]=t[6],i[s+9]=t[7],i[s+10]=t[8]},Sa[17]=function(e,t,s,i){const n=e.storageFloat32;for(let e=0;e<i;e++)n[s+4*e]=t[e]},Sa[21]=(e,t,s,i)=>{const n=e.storageFloat32;for(let e=0;e<i;e++)n[s+4*e]=t[2*e],n[s+4*e+1]=t[2*e+1]},Sa[22]=(e,t,s,i)=>{const n=e.storageFloat32;for(let e=0;e<i;e++)n[s+4*e]=t[3*e],n[s+4*e+1]=t[3*e+1],n[s+4*e+2]=t[3*e+2]},Sa[26]=(e,t,s,i)=>{e.storageUint32[s]=t},Sa[27]=(e,t,s,i)=>{const n=e.storageUint32;n[s]=t[0],n[s+1]=t[1]},Sa[28]=(e,t,s,i)=>{const n=e.storageUint32;n[s]=t[0],n[s+1]=t[1],n[s+2]=t[2]},Sa[29]=(e,t,s,i)=>{const n=e.storageUint32;n[s]=t[0],n[s+1]=t[1],n[s+2]=t[2],n[s+3]=t[3]},Sa[30]=function(e,t,s,i){const n=e.storageInt32;for(let e=0;e<i;e++)n[s+4*e]=t[e]},Sa[32]=Sa[30],Sa[31]=function(e,t,s,i){const n=e.storageUint32;for(let e=0;e<i;e++)n[s+4*e]=t[e]},Sa[33]=(e,t,s,i)=>{const n=e.storageInt32;for(let e=0;e<i;e++)n[s+4*e]=t[2*e],n[s+4*e+1]=t[2*e+1]},Sa[35]=Sa[33],Sa[34]=(e,t,s,i)=>{const n=e.storageUint32;for(let e=0;e<i;e++)n[s+4*e]=t[2*e],n[s+4*e+1]=t[2*e+1]},Sa[36]=(e,t,s,i)=>{const n=e.storageInt32;for(let e=0;e<i;e++)n[s+4*e]=t[3*e],n[s+4*e+1]=t[3*e+1],n[s+4*e+2]=t[3*e+2]},Sa[38]=Sa[36],Sa[37]=(e,t,s,i)=>{const n=e.storageUint32;for(let e=0;e<i;e++)n[s+4*e]=t[3*e],n[s+4*e+1]=t[3*e+1],n[s+4*e+2]=t[3*e+2]};class Ca{constructor(e,t,s=!0){if(this.device=void 0,this.persistent=void 0,this.allocation=void 0,this.storageFloat32=void 0,this.storageInt32=void 0,this.storageUint32=void 0,this.renderVersionDirty=0,this.device=e,this.format=t,this.persistent=s,s){this.impl=e.createUniformBufferImpl(this);const s=new ArrayBuffer(t.byteSize);this.assignStorage(new Int32Array(s)),e._vram.ub+=this.format.byteSize}else this.allocation=new xa}destroy(){if(this.persistent){const e=this.device;this.impl.destroy(e),e._vram.ub-=this.format.byteSize}}get offset(){return this.persistent?0:this.allocation.offset}assignStorage(e){this.storageInt32=e,this.storageUint32=new Uint32Array(e.buffer,e.byteOffset,e.byteLength/4),this.storageFloat32=new Float32Array(e.buffer,e.byteOffset,e.byteLength/4)}loseContext(){var e;null==(e=this.impl)||e.loseContext()}setUniform(e,t){const s=e.offset;if(null!=t){const i=Sa[e.updateType];i?i(this,t,s,e.count):this.storageFloat32.set(t,s)}}set(e,t){const s=this.format.map.get(e);s&&this.setUniform(s,t)}startUpdate(e){if(!this.persistent){const t=this.allocation,s=t.gpuBuffer;this.device.dynamicBuffers.alloc(t,this.format.byteSize),this.assignStorage(t.storage),e&&(e.bindGroup=t.gpuBuffer.getBindGroup(this),e.offsets[0]=t.offset),s!==t.gpuBuffer&&(this.renderVersionDirty=this.device.renderVersion)}}endUpdate(){this.persistent?this.impl.unlock(this):(this.storageFloat32=null,this.storageInt32=null)}update(e){this.startUpdate(e);const t=this.format.uniforms;for(let e=0;e<t.length;e++){const s=t[e].scopeId.value;this.setUniform(t[e],s)}this.endUpdate()}}const Ta={type:5,base:0,count:4,indexed:!1};class Ea{constructor(e){const t="\n\n\t\t\t\t\t\tstruct ub_mesh {\n\t\t\t\t\t\t\t\tcolor : vec4f,\n\t\t\t\t\t\t\t\tdepth: f32\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t@group(2) @binding(0) var<uniform> ubMesh : ub_mesh;\n\n\t\t\t\t\t\tvar<private> pos : array<vec2f, 4> = array<vec2f, 4>(\n\t\t\t\t\t\t\t\tvec2(-1.0, 1.0), vec2(1.0, 1.0),\n\t\t\t\t\t\t\t\tvec2(-1.0, -1.0), vec2(1.0, -1.0)\n\t\t\t\t\t\t);\n\n\t\t\t\t\t\tstruct VertexOutput {\n\t\t\t\t\t\t\t\t@builtin(position) position : vec4f\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t@vertex\n\t\t\t\t\t\tfn vertexMain(@builtin(vertex_index) vertexIndex : u32) -> VertexOutput {\n\t\t\t\t\t\t\t\tvar output : VertexOutput;\n\t\t\t\t\t\t\t\toutput.position = vec4(pos[vertexIndex], ubMesh.depth, 1.0);\n\t\t\t\t\t\t\t\treturn output;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t@fragment\n\t\t\t\t\t\tfn fragmentMain() -> @location(0) vec4f {\n\t\t\t\t\t\t\t\treturn ubMesh.color;\n\t\t\t\t\t\t}\n\t\t\t\t";this.shader=new ba(e,{name:"WebGPUClearRendererShader",shaderLanguage:Ui,vshader:t,fshader:t}),this.uniformBuffer=new Ca(e,new Br(e,[new Or("color",5),new Or("depth",2)]),!1),this.dynamicBindGroup=new En,this.colorData=new Float32Array(4)}destroy(){this.shader.destroy(),this.shader=null,this.uniformBuffer.destroy(),this.uniformBuffer=null}clear(e,t,s,i){var n;const r=null!=(n=(s=s||i).flags)?n:i.flags;if(0!==r){const{uniformBuffer:n,dynamicBindGroup:l}=this;if(n.startUpdate(l),e.setBindGroup(2,l.bindGroup,l.offsets),e.setBindGroup(1,e.emptyBindGroup),1&r&&(t.colorBuffer||t.impl.assignedColorTexture)){var a;const t=null!=(a=s.color)?a:i.color;this.colorData.set(t),e.setBlendState(Rn.NOBLEND)}else e.setBlendState(Rn.NOWRITE);if(n.set("color",this.colorData),2&r&&t.depth){var o;const t=null!=(o=s.depth)?o:i.depth;n.set("depth",t),e.setDepthState(On.WRITEDEPTH)}else n.set("depth",1),e.setDepthState(On.NODEPTH);n.endUpdate(),e.setCullMode(0),e.setShader(this.shader),e.draw(Ta)}}}class Pa{constructor(e){this.device=void 0,this.device=e;const t="\n \n\t\t\t\t\t\tvar<private> pos : array<vec2f, 4> = array<vec2f, 4>(\n\t\t\t\t\t\t\t\tvec2(-1.0, 1.0), vec2(1.0, 1.0),\n\t\t\t\t\t\t\t\tvec2(-1.0, -1.0), vec2(1.0, -1.0)\n\t\t\t\t\t\t);\n\n\t\t\t\t\t\tstruct VertexOutput {\n\t\t\t\t\t\t\t\t@builtin(position) position : vec4f,\n\t\t\t\t\t\t\t\t@location(0) texCoord : vec2f\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\t@vertex\n\t\t\t\t\t\tfn vertexMain(@builtin(vertex_index) vertexIndex : u32) -> VertexOutput {\n\t\t\t\t\t\t\tvar output : VertexOutput;\n\t\t\t\t\t\t\toutput.texCoord = pos[vertexIndex] * vec2f(0.5, -0.5) + vec2f(0.5);\n\t\t\t\t\t\t\toutput.position = vec4f(pos[vertexIndex], 0, 1);\n\t\t\t\t\t\t\treturn output;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t@group(0) @binding(0) var imgSampler : sampler;\n\t\t\t\t\t\t@group(0) @binding(1) var img : texture_2d<f32>;\n\n\t\t\t\t\t\t@fragment\n\t\t\t\t\t\tfn fragmentMain(@location(0) texCoord : vec2f) -> @location(0) vec4f {\n\t\t\t\t\t\t\treturn textureSample(img, imgSampler, texCoord);\n\t\t\t\t\t\t}\n\t\t\t\t";this.shader=new ba(e,{name:"WebGPUMipmapRendererShader",shaderLanguage:Ui,vshader:t,fshader:t}),this.minSampler=e.wgpu.createSampler({minFilter:"linear"})}destroy(){this.shader.destroy(),this.shader=null}generate(e){const t=e.desc;if(t.mipLevelCount<=1)return;if(e.texture.volume)return;const s=this.device,i=s.wgpu,n=this.shader.impl,r=i.createRenderPipeline({layout:"auto",vertex:{module:n.getVertexShaderModule(),entryPoint:n.vertexEntryPoint},fragment:{module:n.getFragmentShaderModule(),entryPoint:n.fragmentEntryPoint,targets:[{format:t.format}]},primitive:{topology:"triangle-strip"}}),a=e.texture,o=a.cubemap?6:a.array?a.arrayLength:1,l=[];for(let t=0;t<o;t++)l.push(e.createView({dimension:"2d",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:t}));const h=s.getCommandEncoder();for(let s=1;s<t.mipLevelCount;s++)for(let t=0;t<o;t++){const n=e.createView({dimension:"2d",baseMipLevel:s,mipLevelCount:1,baseArrayLayer:t}),a=h.beginRenderPass({colorAttachments:[{view:n,loadOp:"clear",storeOp:"store"}]}),o=i.createBindGroup({layout:r.getBindGroupLayout(0),entries:[{binding:0,resource:this.minSampler},{binding:1,resource:l[t]}]});a.setPipeline(r),a.setBindGroup(0,o),a.draw(4),a.end(),l[t]=n}s.pipeline=null}}class ka{constructor(e){this.device=void 0,this.bindGroupCache=new Map,this.device=e,this.bindGroupFormat=new gn(this.device,[new un(tn,3)])}getBindGroup(e){const t=e.format.byteSize;let s=this.bindGroupCache.get(t);return s||(s=new Pn(this.device,this.bindGroupFormat,e),s.update(),this.bindGroupCache.set(t,s)),s}}class Aa extends ka{constructor(e,t,s){super(e),this.buffer=null,this.mappedRange=null,this.buffer=e.wgpu.createBuffer({size:t,usage:s?GPUBufferUsage.MAP_WRITE|GPUBufferUsage.COPY_SRC:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,mappedAtCreation:s}),s&&this.onAvailable(),e._vram.ub+=t}destroy(e){e._vram.ub-=this.buffer.size,this.buffer.destroy(),this.buffer=null}onAvailable(){this.mappedRange=this.buffer.getMappedRange()}alloc(e,t){return new Int32Array(this.mappedRange,e,t/4)}}class Ma extends wa{constructor(...e){super(...e),this.pendingStagingBuffers=[]}createBuffer(e,t,s){return new Aa(e,t,s)}submit(){super.submit();const e=this.usedBuffers.length;if(e){const t=this.device,s=this.gpuBuffers,i=t.wgpu.createCommandEncoder();for(let t=e-1;t>=0;t--){const e=this.usedBuffers[t],{stagingBuffer:n,gpuBuffer:r,offset:a,size:o}=e,l=n.buffer;l.unmap(),i.copyBufferToBuffer(l,a,r.buffer,a,o),s.push(r)}const n=i.finish();t.addCommandBuffer(n,!0);for(let t=0;t<e;t++){const e=this.usedBuffers[t].stagingBuffer;this.pendingStagingBuffers.push(e)}this.usedBuffers.length=0}}onCommandBuffersSubmitted(){const e=this.pendingStagingBuffers.length;if(e){for(let t=0;t<e;t++){const e=this.pendingStagingBuffers[t];e.buffer.mapAsync(GPUMapMode.WRITE).then((()=>{this.stagingBuffers&&(e.onAvailable(),this.stagingBuffers.push(e))}))}this.pendingStagingBuffers.length=0}}}class Da{constructor(){this.frameAllocations=[],this.pastFrameAllocations=new Map,this._enabled=!1,this._enableRequest=!1,this._frameTime=0}loseContext(){this.pastFrameAllocations.clear()}set enabled(e){this._enableRequest=e}get enabled(){return this._enableRequest}processEnableRequest(){this._enableRequest!==this._enabled&&(this._enabled=this._enableRequest,this._enabled||(this._frameTime=0))}request(e){this.pastFrameAllocations.set(e,this.frameAllocations),this.frameAllocations=[]}report(e,t){t&&(this.pastFrameAllocations.get(e),t.length>0&&(this._frameTime=t[0]),ns.get("GpuTimings")),this.pastFrameAllocations.delete(e)}getSlot(e){const t=this.frameAllocations.length;return this.frameAllocations.push(e),t}get slotCount(){return this.frameAllocations.length}}class Ra{constructor(e,t,s){this.querySet=void 0,this.stagingBuffers=[],this.activeStagingBuffer=null,this.bytesPerSlot=void 0,this.device=e,this.capacity=s,this.bytesPerSlot=t?8:4;const i=e.wgpu;this.querySet=i.createQuerySet({type:t?"timestamp":"occlusion",count:s}),this.queryBuffer=i.createBuffer({size:this.bytesPerSlot*s,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST})}destroy(){var e,t;null==(e=this.querySet)||e.destroy(),this.querySet=null,null==(t=this.queryBuffer)||t.destroy(),this.queryBuffer=null,this.activeStagingBuffer=null,this.stagingBuffers.forEach((e=>{e.destroy()})),this.stagingBuffers=null}getStagingBuffer(){let e=this.stagingBuffers.pop();return e||(e=this.device.wgpu.createBuffer({size:this.queryBuffer.size,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ})),e}resolve(e){const t=this.device.getCommandEncoder();t.resolveQuerySet(this.querySet,0,e,this.queryBuffer,0);const s=this.getStagingBuffer();this.activeStagingBuffer=s,t.copyBufferToBuffer(this.queryBuffer,0,s,0,this.bytesPerSlot*e)}request(e,t){const s=this.activeStagingBuffer;return this.activeStagingBuffer=null,s.mapAsync(GPUMapMode.READ).then((()=>{var i;const n=new BigInt64Array(s.getMappedRange()),r=[];for(let t=0;t<e;t++)r.push(1e-6*Number(n[2*t+1]-n[2*t]));return s.unmap(),null==(i=this.stagingBuffers)||i.push(s),{renderVersion:t,timings:r}}))}}class La extends Da{constructor(e){super(),this.device=void 0,this.frameGPUMarkerSlot=void 0,this.device=e,this.timestampQueriesSet=e.supportsTimestampQuery?new Ra(e,!0,512):null}destroy(){var e;null==(e=this.timestampQueriesSet)||e.destroy(),this.timestampQueriesSet=null}frameStart(){this.processEnableRequest()}frameEnd(){var e;this._enabled&&(null==(e=this.timestampQueriesSet)||e.resolve(2*this.slotCount))}request(){if(this._enabled){var e;const t=this.device.renderVersion;null==(e=this.timestampQueriesSet)||e.request(this.slotCount,t).then((e=>{this.report(e.renderVersion,e.timings)})),super.request(t)}}}class Ia{constructor(e){this.device=void 0,this.pipelineCache=new Map,this.device=e;const t="\n \n\t\t\t\t\t\tvar<private> pos : array<vec2f, 4> = array<vec2f, 4>(\n\t\t\t\t\t\t\t\tvec2(-1.0, 1.0), vec2(1.0, 1.0), vec2(-1.0, -1.0), vec2(1.0, -1.0)\n\t\t\t\t\t\t);\n\n\t\t\t\t\t\tstruct VertexOutput {\n\t\t\t\t\t\t\t\t@builtin(position) position : vec4f,\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\t@vertex\n\t\t\t\t\t\tfn vertexMain(@builtin(vertex_index) vertexIndex : u32) -> VertexOutput {\n\t\t\t\t\t\t\tvar output : VertexOutput;\n\t\t\t\t\t\t\toutput.position = vec4f(pos[vertexIndex], 0, 1);\n\t\t\t\t\t\t\treturn output;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t@group(0) @binding(0) var img : texture_depth_multisampled_2d;\n\n\t\t\t\t\t\t@fragment\n\t\t\t\t\t\tfn fragmentMain(@builtin(position) fragColor: vec4f) -> @location(0) vec4f {\n\t\t\t\t\t\t\t\t// load th depth value from sample index 0\n\t\t\t\t\t\t\t\tvar depth = textureLoad(img, vec2i(fragColor.xy), 0u);\n\t\t\t\t\t\t\t\treturn vec4<f32>(depth, 0.0, 0.0, 0.0);\n\t\t\t\t\t\t}\n\t\t\t\t";this.shader=new ba(e,{name:"WebGPUResolverDepthShader",shaderLanguage:Ui,vshader:t,fshader:t})}destroy(){this.shader.destroy(),this.shader=null,this.pipelineCache=null}getPipeline(e){let t=this.pipelineCache.get(e);return t||(t=this.createPipeline(e),this.pipelineCache.set(e,t)),t}createPipeline(e){const t=this.shader.impl;return this.device.wgpu.createRenderPipeline({layout:"auto",vertex:{module:t.getVertexShaderModule(),entryPoint:t.vertexEntryPoint},fragment:{module:t.getFragmentShaderModule(),entryPoint:t.fragmentEntryPoint,targets:[{format:e}]},primitive:{topology:"triangle-strip"}})}resolveDepth(e,t,s){const i=this.device,n=i.wgpu,r=this.getPipeline(s.format),a=t.depthOrArrayLayers;for(let i=0;i<a;i++){const a=t.createView({dimension:"2d",aspect:"depth-only",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:i}),o=s.createView({dimension:"2d",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:i}),l=e.beginRenderPass({colorAttachments:[{view:o,loadOp:"clear",storeOp:"store"}]}),h=n.createBindGroup({layout:r.getBindGroupLayout(0),entries:[{binding:0,resource:a}]});l.setPipeline(r),l.setBindGroup(0,h),l.draw(4),l.end()}i.pipeline=null}}class Fa{constructor(e){this.uniformBuffers=[],this.bindGroup=null,this.compute=e;const{device:t,shader:s}=e,{computeBindGroupFormat:i,computeUniformBufferFormats:n}=s.impl;if(this.bindGroup=new Pn(t,i),n)for(const e in n)if(n.hasOwnProperty(e)){const s=new Ca(t,n[e],!0);this.uniformBuffers.push(s),this.bindGroup.setUniformBuffer(e,s)}this.pipeline=t.computePipeline.get(s,i)}destroy(){this.uniformBuffers.forEach((e=>e.destroy())),this.uniformBuffers.length=0,this.bindGroup.destroy(),this.bindGroup=null}updateBindGroup(){const{bindGroup:e}=this;e.updateUniformBuffers(),e.update()}dispatch(e,t,s){const i=this.compute.device;i.setBindGroup(0,this.bindGroup);const n=i.passEncoder;n.setPipeline(this.pipeline),n.dispatchWorkgroups(e,t,s)}}const Oa=new Map;class Ba extends Zn{constructor(e,t={}){var s,i;super(e,t),this.renderPipeline=new Sr(this),this.computePipeline=new Cr(this),this.clearRenderer=void 0,this.mipmapRenderer=void 0,this.pipeline=void 0,this.bindGroupFormats=[],this.emptyBindGroup=void 0,this.commandEncoder=null,this.commandBuffers=[],this.limits=void 0,(t=this.initOptions).alpha=null==(s=t.alpha)||s,this.backBufferAntialias=null!=(i=t.antialias)&&i,this.isWebGPU=!0,this._deviceType=Qi}destroy(){this.clearRenderer.destroy(),this.clearRenderer=null,this.mipmapRenderer.destroy(),this.mipmapRenderer=null,this.resolver.destroy(),this.resolver=null,super.destroy()}initDeviceCaps(){var e;const t=null==(e=this.wgpu)?void 0:e.limits;this.limits=t,this.precision="highp",this.maxPrecision="highp",this.maxSamples=4,this.maxTextures=16,this.maxTextureSize=t.maxTextureDimension2D,this.maxCubeMapSize=t.maxTextureDimension2D,this.maxVolumeSize=t.maxTextureDimension3D,this.maxColorAttachments=t.maxColorAttachments,this.maxPixelRatio=1,this.maxAnisotropy=16,this.fragmentUniformsCount=t.maxUniformBufferBindingSize/16,this.vertexUniformsCount=t.maxUniformBufferBindingSize/16,this.supportsUniformBuffers=!0,this.supportsAreaLights=!0,this.supportsGpuParticles=!0,this.supportsCompute=!0,this.textureFloatRenderable=!0,this.textureHalfFloatRenderable=!0,this.supportsImageBitmap=!0,this.samples=this.backBufferAntialias?4:1;const s=navigator.gpu.wgslLanguageFeatures;this.supportsStorageTextureRead=null==s?void 0:s.has("readonly_and_readwrite_storage_textures")}async initWebGpu(e,t){if(!window.navigator.gpu)throw new Error("Unable to retrieve GPU. Ensure you are using a browser that supports WebGPU rendering.");const s=e=>new URL(e,window.location.href).toString(),i=await Promise.all([import(`${s(t)}`).then((e=>twgsl(t.replace(".js",".wasm")))),import(`${s(e)}`).then((e=>e.default()))]);return this.twgsl=i[0],this.glslang=i[1],this.createDevice()}async createDevice(){var e,t;const s={powerPreference:"default"!==this.initOptions.powerPreference?this.initOptions.powerPreference:void 0};this.gpuAdapter=await window.navigator.gpu.requestAdapter(s);const i=[],n=e=>{const t=this.gpuAdapter.features.has(e);return t&&i.push(e),t};this.textureFloatFilterable=n("float32-filterable"),this.extCompressedTextureS3TC=n("texture-compression-bc"),this.extCompressedTextureETC=n("texture-compression-etc2"),this.extCompressedTextureASTC=n("texture-compression-astc"),this.supportsTimestampQuery=n("timestamp-query"),this.supportsDepthClip=n("depth-clip-control"),this.supportsDepth32Stencil=n("depth32float-stencil8"),this.supportsIndirectFirstInstance=n("indirect-first-instance"),this.supportsShaderF16=n("shader-f16"),this.supportsStorageRGBA8=n("bgra8unorm-storage"),this.textureRG11B10Renderable=n("rg11b10ufloat-renderable"),this.supportsClipDistances=n("clip-distances");const r=null==(e=this.gpuAdapter)?void 0:e.limits,a={};if(r)for(const e in r)"minSubgroupSize"!==e&&"maxSubgroupSize"!==e&&(a[e]=r[e]);const o={requiredFeatures:i,requiredLimits:a,defaultQueue:{label:"Default Queue"}};this.wgpu=await this.gpuAdapter.requestDevice(o),null==(t=this.wgpu.lost)||t.then(this.handleDeviceLost.bind(this)),this.initDeviceCaps(),this.gpuContext=this.canvas.getContext("webgpu");let l="standard",h=navigator.gpu.getPreferredCanvasFormat();const c=this.initOptions.displayFormat;if(this.backBufferFormat="rgba8unorm"===h?c===Zi?Qs:7:c===Zi?64:31,this.backBufferViewFormat=c===Zi?`${h}-srgb`:h,"hdr"===c&&this.textureFloatFilterable){const e=window.matchMedia("(dynamic-range: high)");null!=e&&e.matches&&(this.backBufferFormat=Ws,this.backBufferViewFormat="rgba16float",h="rgba16float",this.isHdr=!0,l="extended")}return this.canvasConfig={device:this.wgpu,colorSpace:"srgb",alphaMode:this.initOptions.alpha?"premultiplied":"opaque",format:h,toneMapping:{mode:l},usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC|GPUTextureUsage.COPY_DST,viewFormats:c===Zi?[this.backBufferViewFormat]:[]},this.gpuContext.configure(this.canvasConfig),this.createBackbuffer(),this.clearRenderer=new Ea(this),this.mipmapRenderer=new Pa(this),this.resolver=new Ia(this),this.postInit(),this}async handleDeviceLost(e){"destroyed"!==e.reason&&(super.loseContext(),await this.createDevice(),super.restoreContext())}postInit(){super.postInit(),this.initializeRenderState(),this.setupPassEncoderDefaults(),this.gpuProfiler=new La(this),this.dynamicBuffers=new Ma(this,102400,this.limits.minUniformBufferOffsetAlignment),this.emptyBindGroup=new Pn(this,new gn(this,[])),this.emptyBindGroup.update()}createBackbuffer(){this.supportsStencil=this.initOptions.stencil,this.backBuffer=new tr({name:"WebgpuFramebuffer",graphicsDevice:this,depth:this.initOptions.depth,stencil:this.supportsStencil,samples:this.samples}),this.backBuffer.impl.isBackbuffer=!0}frameStart(){super.frameStart(),this.gpuProfiler.frameStart(),this.submit();const e=this.gpuContext.getCurrentTexture();this.backBufferSize.x===e.width&&this.backBufferSize.y===e.height||(this.backBufferSize.set(e.width,e.height),this.backBuffer.destroy(),this.backBuffer=null,this.createBackbuffer());const t=this.backBuffer,s=t.impl;s.setColorAttachment(0,void 0,this.backBufferViewFormat),this.initRenderTarget(t),s.assignColorTexture(this,e)}frameEnd(){super.frameEnd(),this.gpuProfiler.frameEnd(),this.submit(),this.contextLost||this.gpuProfiler.request()}createBufferImpl(e){return new hr(e)}createUniformBufferImpl(e){return new Qr(e)}createVertexBufferImpl(e,t,s){return new Jr(e,t,s)}createIndexBufferImpl(e,t){return new cr(e,t)}createShaderImpl(e){return new qr(e)}createTextureImpl(e){return new Yr(e)}createRenderTargetImpl(e){return new Ir(e)}createBindGroupFormatImpl(e){return new lr(e)}createBindGroupImpl(e){return new sr}createComputeImpl(e){return new Fa(e)}setBindGroup(e,t,s){this.passEncoder&&(this.passEncoder.setBindGroup(e,t.impl.bindGroup,null!=s?s:t.uniformBufferOffsets),this.bindGroupFormats[e]=t.format.impl)}submitVertexBuffer(e,t){const s=e.format,{interleaved:i,elements:n}=s,r=n.length,a=e.impl.buffer;if(i)return this.passEncoder.setVertexBuffer(t,a),1;for(let e=0;e<r;e++)this.passEncoder.setVertexBuffer(t+e,a,n[e].offset);return r}validateVBLocations(e,t){const s=e=>{const{elements:t}=e.format;for(let e=0;e<t.length;e++){const s=t[e].name,i=on[s];Oa.has(i),Oa.set(i,s)}};s(e),s(t),Oa.clear()}draw(e,t=1,s){if(this.shader.ready&&!this.shader.failed){const s=this.passEncoder,i=this.vertexBuffers[0],n=this.vertexBuffers[1];if(this.vertexBuffers.length=0,i){const e=this.submitVertexBuffer(i,0);n&&this.submitVertexBuffer(n,e)}const r=this.renderPipeline.get(e,null==i?void 0:i.format,null==n?void 0:n.format,this.shader,this.renderTarget,this.bindGroupFormats,this.blendState,this.depthState,this.cullMode,this.stencilEnabled,this.stencilFront,this.stencilBack);this.pipeline!==r&&(this.pipeline=r,s.setPipeline(r));const a=this.indexBuffer;a?(this.indexBuffer=null,s.setIndexBuffer(a.impl.buffer,a.impl.format),s.drawIndexed(e.count,t,e.base,0,0)):s.draw(e.count,t,e.base,0)}}setShader(e,t=!1){e!==this.shader&&(this.shader=e)}setBlendState(e){this.blendState.copy(e)}setDepthState(e){this.depthState.copy(e)}setStencilState(e,t){if(e||t){this.stencilEnabled=!0,this.stencilFront.copy(null!=e?e:Jn.DEFAULT),this.stencilBack.copy(null!=t?t:Jn.DEFAULT);const s=this.stencilFront.ref;this.stencilRef!==s&&(this.stencilRef=s,this.passEncoder.setStencilReference(s))}else this.stencilEnabled=!1}setBlendColor(e,t,s,i){const n=this.blendColor;e===n.r&&t===n.g&&s===n.b&&i===n.a||(n.set(e,t,s,i),this.passEncoder.setBlendConstant(n))}setCullMode(e){this.cullMode=e}setAlphaToCoverage(e){}initializeContextCaches(){super.initializeContextCaches()}setupPassEncoderDefaults(){this.pipeline=null,this.stencilRef=0,this.blendColor.set(0,0,0,0)}_uploadDirtyTextures(){this.textures.forEach((e=>{(e._needsUpload||e._needsMipmaps)&&e.upload()}))}setupTimeStampWrites(e,t){if(this.gpuProfiler._enabled&&this.gpuProfiler.timestampQueriesSet){var s;const i=this.gpuProfiler.getSlot(t);(e=null!=(s=e)?s:{}).timestampWrites={querySet:this.gpuProfiler.timestampQueriesSet.querySet,beginningOfPassWriteIndex:2*i,endOfPassWriteIndex:2*i+1}}return e}startRenderPass(e){this._uploadDirtyTextures();const t=e.renderTarget||this.backBuffer;this.renderTarget=t;const s=t.impl;t!==this.backBuffer&&this.initRenderTarget(t),s.setupForRenderPass(e,t);const i=s.renderPassDescriptor;this.setupTimeStampWrites(i,e.name);const n=this.getCommandEncoder();this.passEncoder=n.beginRenderPass(i),this.passEncoder.label=`${e.name}-PassEncoder RT:${t.name}`,this.setupPassEncoderDefaults();const{width:r,height:a}=t;this.setViewport(0,0,r,a),this.setScissor(0,0,r,a),this.insideRenderPass=!0}endRenderPass(e){this.passEncoder.end(),this.passEncoder=null,this.insideRenderPass=!1,this.bindGroupFormats.length=0;const t=this.renderTarget;if(t&&t.depthBuffer&&e.depthStencilOps.resolveDepth&&e.samples>1&&t.autoResolve){const e=t.impl.depthAttachment,s=t.depthBuffer.impl.gpuTexture;e&&s&&this.resolver.resolveDepth(this.commandEncoder,e.multisampledDepthBuffer,s)}for(let t=0;t<e.colorArrayOps.length;t++){e.colorArrayOps[t].genMipmaps&&this.mipmapRenderer.generate(e.renderTarget._colorBuffers[t].impl)}}startComputePass(e){this.pipeline=null;const t=this.setupTimeStampWrites(void 0,e),s=this.getCommandEncoder();this.passEncoder=s.beginComputePass(t),this.insideRenderPass=!0}endComputePass(){this.passEncoder.end(),this.passEncoder=null,this.insideRenderPass=!1,this.bindGroupFormats.length=0}computeDispatch(e,t="Unnamed"){this.startComputePass(t);for(let t=0;t<e.length;t++){const s=e[t];s.applyParameters(),s.impl.updateBindGroup()}for(let t=0;t<e.length;t++){const s=e[t];s.impl.dispatch(s.countX,s.countY,s.countZ)}this.endComputePass()}getCommandEncoder(){let e=this.commandEncoder;return e||(e=this.wgpu.createCommandEncoder(),this.commandEncoder=e),e}endCommandEncoder(){const{commandEncoder:e}=this;if(e){const t=e.finish();this.addCommandBuffer(t),this.commandEncoder=null}}addCommandBuffer(e,t=!1){t?this.commandBuffers.unshift(e):this.commandBuffers.push(e)}submit(){this.endCommandEncoder(),this.commandBuffers.length>0&&(this.dynamicBuffers.submit(),this.wgpu.queue.submit(this.commandBuffers),this.commandBuffers.length=0,this.dynamicBuffers.onCommandBuffersSubmitted())}clear(e){e.flags&&this.clearRenderer.clear(this,this.renderTarget,e,this.defaultClearOptions)}setViewport(e,t,s,i){this.passEncoder&&(this.renderTarget.flipY||(t=this.renderTarget.height-t-i),this.vx=e,this.vy=t,this.vw=s,this.vh=i,this.passEncoder.setViewport(e,t,s,i,0,1))}setScissor(e,t,s,i){this.passEncoder&&(this.renderTarget.flipY||(t=this.renderTarget.height-t-i),this.sx=e,this.sy=t,this.sw=s,this.sh=i,this.passEncoder.setScissorRect(e,t,s,i))}clearStorageBuffer(e,t=0,s=e.byteSize){this.getCommandEncoder().clearBuffer(e.buffer,t,s)}readStorageBuffer(e,t=0,s=e.byteSize-t,i=null,n=!1){const r=this.createBufferImpl(9);r.allocate(this,s);const a=r.buffer;return this.getCommandEncoder().copyBufferToBuffer(e.buffer,t,a,0,s),this.readBuffer(r,s,i,n)}readBuffer(e,t,s=null,i=!1){const n=e.buffer;return new Promise(((r,a)=>{const o=()=>{null==n||n.mapAsync(GPUMapMode.READ).then((()=>{null!=s||(s=new Uint8Array(t));const i=n.getMappedRange(0,t),a=s.constructor;s.set(new a(i)),n.unmap(),e.destroy(this),r(s)}))};i?(this.submit(),o()):setTimeout((()=>{o()}))}))}writeStorageBuffer(e,t=0,s,i=0,n){this.wgpu.queue.writeBuffer(e.buffer,t,s,i,n)}copyRenderTarget(e,t,s,i){const n={width:e?e.width:t.width,height:e?e.height:t.height,depthOrArrayLayers:1},r=this.getCommandEncoder();if(s){const s={texture:e?e.colorBuffer.impl.gpuTexture:this.backBuffer.impl.assignedColorTexture,mipLevel:0},i={texture:t?t.colorBuffer.impl.gpuTexture:this.backBuffer.impl.assignedColorTexture,mipLevel:0};r.copyTextureToTexture(s,i,n)}if(i){const s=(e||this.renderTarget).impl.depthAttachment.depthTexture;if(e.samples>1){const e=t.colorBuffer.impl.gpuTexture;this.resolver.resolveDepth(r,s,e)}else{const e={texture:s,mipLevel:0},i={texture:t?t.depthBuffer.impl.gpuTexture:this.renderTarget.impl.depthAttachment.depthTexture,mipLevel:0};r.copyTextureToTexture(e,i,n)}}return!0}}class za{constructor(){this.bufferId=null}destroy(e){this.bufferId&&(e.gl.deleteBuffer(this.bufferId),this.bufferId=null)}get initialized(){return!!this.bufferId}loseContext(){this.bufferId=null}unlock(e,t,s,i){const n=e.gl;if(this.bufferId)n.bindBuffer(s,this.bufferId),n.bufferSubData(s,0,i);else{let e;switch(t){case 0:e=n.STATIC_DRAW;break;case 1:e=n.DYNAMIC_DRAW;break;case 2:e=n.STREAM_DRAW;break;case 3:e=n.DYNAMIC_COPY}this.bufferId=n.createBuffer(),n.bindBuffer(s,this.bufferId),n.bufferData(s,i,e)}}}class Na extends za{constructor(...e){super(...e),this.vao=null}destroy(e){super.destroy(e),e.unbindVertexArray()}loseContext(){super.loseContext(),this.vao=null}unlock(e){const t=e.device;super.unlock(t,e.usage,t.gl.ARRAY_BUFFER,e.storage)}}class Ua extends za{constructor(e){super();const t=e.device.gl,s=e.format;0===s?this.glFormat=t.UNSIGNED_BYTE:1===s?this.glFormat=t.UNSIGNED_SHORT:2===s&&(this.glFormat=t.UNSIGNED_INT)}unlock(e){const t=e.device;super.unlock(t,e.usage,t.gl.ELEMENT_ARRAY_BUFFER,e.storage)}}class Va{constructor(e,t,s,i){if(this.locationId=i,this.scopeId=e.scope.resolve(t),this.version=new Bn,"[0]"===t.substring(t.length-3))switch(s){case 2:s=17;break;case 1:s=$i;break;case Gi:s=31;break;case 0:s=32;break;case 3:s=21;break;case 6:s=qi;break;case Hi:s=34;break;case 9:s=35;break;case 4:s=22;break;case 7:s=Xi;break;case ji:s=37;break;case 10:s=38;break;case 5:s=23;break;case 8:s=39;break;case Wi:s=40;break;case 11:s=41}this.dataType=s,this.value=[null,null,null,null],this.array=[]}}const Ga=new Set(["gl_VertexID","gl_InstanceID","gl_DrawID","gl_BaseVertex","gl_BaseInstance"]);class Ha{constructor(){this.map=new Map}destroy(e){this.map.forEach((t=>{e.gl.deleteShader(t)}))}loseContext(e){this.map.clear()}}const ja=new _n,Wa=new _n;class $a{constructor(e){this.compileDuration=0,this.init(),this.compile(e.device,e),this.link(e.device,e),e.device.shaders.push(e)}destroy(e){this.glProgram&&(e.device.gl.deleteProgram(this.glProgram),this.glProgram=null)}init(){this.uniforms=[],this.samplers=[],this.attributes=[],this.glProgram=null,this.glVertexShader=null,this.glFragmentShader=null}loseContext(){this.init()}restoreContext(e,t){this.compile(e,t),this.link(e,t)}compile(e,t){const s=t.definition;this.glVertexShader=this._compileShaderSource(e,s.vshader,!0),this.glFragmentShader=this._compileShaderSource(e,s.fshader,!1)}link(e,t){if(this.glProgram)return;const s=e.gl;if(s.isContextLost())return;const i=s.createProgram();this.glProgram=i,s.attachShader(i,this.glVertexShader),s.attachShader(i,this.glFragmentShader);const n=t.definition,r=n.attributes;if(n.useTransformFeedback){const e=[];for(const t in r)r.hasOwnProperty(t)&&e.push(`out_${t}`);s.transformFeedbackVaryings(i,e,s.INTERLEAVED_ATTRIBS)}for(const e in r)if(r.hasOwnProperty(e)){const t=r[e],n=on[t];s.bindAttribLocation(i,n,e)}s.linkProgram(i)}_compileShaderSource(e,t,s){const i=e.gl;if(i.isContextLost())return null;const n=(s?ja:Wa).get(e,(()=>new Ha));let r=n.map.get(t);return r||(r=i.createShader(s?i.VERTEX_SHADER:i.FRAGMENT_SHADER),i.shaderSource(r,t),i.compileShader(r),n.map.set(t,r)),r}finalize(e,t){const s=e.gl;if(s.isContextLost())return!0;const i=this.glProgram,n=t.definition;if(!s.getProgramParameter(i,s.LINK_STATUS)){if(!this._isCompiled(e,t,this.glVertexShader,n.vshader,"vertex"))return!1;if(!this._isCompiled(e,t,this.glFragmentShader,n.fshader,"fragment"))return!1;const r=`Failed to link shader program. Error: ${s.getProgramInfoLog(i)}`;return console.error(r),!1}const r=s.getProgramParameter(i,s.ACTIVE_ATTRIBUTES);for(let a=0;a<r;a++){const r=s.getActiveAttrib(i,a),o=s.getAttribLocation(i,r.name);if(!Ga.has(r.name))if(void 0===n.attributes[r.name])console.error(`Vertex shader attribute "${r.name}" is not mapped to a semantic in shader definition, shader [${t.label}]`,t),t.failed=!0;else{const t=new Va(e,n.attributes[r.name],e.pcUniformType[r.type],o);this.attributes.push(t)}}const a=e._samplerTypes,o=s.getProgramParameter(i,s.ACTIVE_UNIFORMS);for(let t=0;t<o;t++){const n=s.getActiveUniform(i,t),r=s.getUniformLocation(i,n.name),o=new Va(e,n.name,e.pcUniformType[n.type],r);a.has(n.type)?this.samplers.push(o):this.uniforms.push(o)}return t.ready=!0,!0}_isCompiled(e,t,s,i,n){const r=e.gl;if(!r.getShaderParameter(s,r.COMPILE_STATUS)){const e=r.getShaderInfoLog(s),[t,a]=this._processError(i,e),o=`Failed to compile ${n} shader:\n\n${e}\n${t} while rendering undefined`;return console.error(o),!1}return!0}isLinked(e){const{extParallelShaderCompile:t}=e;return!t||e.gl.getProgramParameter(this.glProgram,t.COMPLETION_STATUS_KHR)}_processError(e,t){const s={};let i="";if(e){const n=e.split("\n");let r=0,a=n.length;if(t&&t.startsWith("ERROR:")){const e=t.match(/^ERROR:\s(\d+):(\d+):\s*(.+)/);e&&(s.message=e[3],s.line=parseInt(e[2],10),r=Math.max(0,s.line-6),a=Math.min(n.length,s.line+5))}for(let e=r;e<a;e++)i+=`${e+1}:\t${n[e]}\n`;s.source=e}return[i,s]}}function qa(e,t){const s=e.width,i=e.height;if(s>t||i>t){const n=t/Math.max(s,i),r=Math.floor(s*n),a=Math.floor(i*n),o=document.createElement("canvas");o.width=r,o.height=a;return o.getContext("2d").drawImage(e,0,0,s,i,0,0,r,a),o}return e}class Xa{constructor(e){this._glTexture=null,this._glTarget=void 0,this._glFormat=void 0,this._glInternalFormat=void 0,this._glPixelType=void 0,this._glCreated=void 0,this.dirtyParameterFlags=0,this.texture=e}destroy(e){if(this._glTexture){for(let t=0;t<e.textureUnits.length;t++){const s=e.textureUnits[t];for(let e=0;e<s.length;e++)s[e]===this._glTexture&&(s[e]=null)}e.gl.deleteTexture(this._glTexture),this._glTexture=null}}loseContext(){this._glTexture=null}propertyChanged(e){this.dirtyParameterFlags|=e}initialize(e,t){const s=e.gl;switch(this._glTexture=s.createTexture(),this._glTarget=t._cubemap?s.TEXTURE_CUBE_MAP:t._volume?s.TEXTURE_3D:t.array?s.TEXTURE_2D_ARRAY:s.TEXTURE_2D,t._format){case 0:this._glFormat=s.ALPHA,this._glInternalFormat=s.ALPHA,this._glPixelType=s.UNSIGNED_BYTE;break;case 1:this._glFormat=s.LUMINANCE,this._glInternalFormat=s.LUMINANCE,this._glPixelType=s.UNSIGNED_BYTE;break;case 2:this._glFormat=s.LUMINANCE_ALPHA,this._glInternalFormat=s.LUMINANCE_ALPHA,this._glPixelType=s.UNSIGNED_BYTE;break;case 52:this._glFormat=s.RED,this._glInternalFormat=s.R8,this._glPixelType=s.UNSIGNED_BYTE;break;case 53:this._glFormat=s.RG,this._glInternalFormat=s.RG8,this._glPixelType=s.UNSIGNED_BYTE;break;case 3:this._glFormat=s.RGB,this._glInternalFormat=s.RGB,this._glPixelType=s.UNSIGNED_SHORT_5_6_5;break;case 4:this._glFormat=s.RGBA,this._glInternalFormat=s.RGBA,this._glPixelType=s.UNSIGNED_SHORT_5_5_5_1;break;case 5:this._glFormat=s.RGBA,this._glInternalFormat=s.RGBA,this._glPixelType=s.UNSIGNED_SHORT_4_4_4_4;break;case 6:this._glFormat=s.RGB,this._glInternalFormat=s.RGB8,this._glPixelType=s.UNSIGNED_BYTE;break;case 7:this._glFormat=s.RGBA,this._glInternalFormat=s.RGBA8,this._glPixelType=s.UNSIGNED_BYTE;break;case 31:case 64:break;case 8:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTextureS3TC.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case 9:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case js:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case 21:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTextureETC1.COMPRESSED_RGB_ETC1_WEBGL;break;case Js:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;break;case Zs:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;break;case 26:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;break;case 27:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;break;case 22:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTextureETC.COMPRESSED_RGB8_ETC2;break;case 23:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTextureETC.COMPRESSED_RGBA8_ETC2_EAC;break;case 28:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTextureASTC.COMPRESSED_RGBA_ASTC_4x4_KHR;break;case 29:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTextureATC.COMPRESSED_RGB_ATC_WEBGL;break;case 30:this._glFormat=s.RGBA,this._glInternalFormat=e.extCompressedTextureATC.COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL;break;case 65:this._glFormat=s.RGB,this._glInternalFormat=e.extTextureCompressionBPTC.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT;break;case 66:this._glFormat=s.RGB,this._glInternalFormat=e.extTextureCompressionBPTC.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT;break;case 67:this._glFormat=s.RGBA,this._glInternalFormat=e.extTextureCompressionBPTC.COMPRESSED_RGBA_BPTC_UNORM_EXT;break;case 54:this._glFormat=s.SRGB,this._glInternalFormat=e.extCompressedTextureS3TC_SRGB.COMPRESSED_SRGB_S3TC_DXT1_EXT;break;case 55:this._glFormat=s.SRGB_ALPHA,this._glInternalFormat=e.extCompressedTextureS3TC_SRGB.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;break;case 56:this._glFormat=s.SRGB_ALPHA,this._glInternalFormat=e.extCompressedTextureS3TC_SRGB.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;break;case 57:this._glFormat=s.SRGB,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_SRGB_PVRTC_2BPPV1_EXT;break;case 58:this._glFormat=s.SRGB_ALPHA,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_SRGB_ALPHA_PVRTC_2BPPV1_EXT;break;case 59:this._glFormat=s.SRGB,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_SRGB_PVRTC_4BPPV1_EXT;break;case 60:this._glFormat=s.SRGB_ALPHA,this._glInternalFormat=e.extCompressedTexturePVRTC.COMPRESSED_SRGB_ALPHA_PVRTC_4BPPV1_EXT;break;case 61:this._glFormat=s.RGB,this._glInternalFormat=e.extCompressedTextureETC.COMPRESSED_RGB8_ETC2;break;case 62:this._glFormat=s.SRGB_ALPHA,this._glInternalFormat=e.extCompressedTextureETC.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;break;case 63:this._glFormat=s.SRGB_ALPHA,this._glInternalFormat=e.extCompressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 68:this._glFormat=s.RGBA,this._glInternalFormat=e.extTextureCompressionBPTC.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 50:this._glFormat=s.RED,this._glInternalFormat=s.R16F,this._glPixelType=s.HALF_FLOAT;break;case 51:this._glFormat=s.RG,this._glInternalFormat=s.RG16F,this._glPixelType=s.HALF_FLOAT;break;case 11:this._glFormat=s.RGB,this._glInternalFormat=s.RGB16F,this._glPixelType=s.HALF_FLOAT;break;case Ws:this._glFormat=s.RGBA,this._glInternalFormat=s.RGBA16F,this._glPixelType=s.HALF_FLOAT;break;case 13:this._glFormat=s.RGB,this._glInternalFormat=s.RGB32F,this._glPixelType=s.FLOAT;break;case $s:this._glFormat=s.RGBA,this._glInternalFormat=s.RGBA32F,this._glPixelType=s.FLOAT;break;case qs:this._glFormat=s.RED,this._glInternalFormat=s.R32F,this._glPixelType=s.FLOAT;break;case Xs:this._glFormat=s.DEPTH_COMPONENT,this._glInternalFormat=s.DEPTH_COMPONENT32F,this._glPixelType=s.FLOAT;break;case ti:this._glFormat=s.DEPTH_COMPONENT,this._glInternalFormat=s.DEPTH_COMPONENT16,this._glPixelType=s.UNSIGNED_SHORT;break;case Ks:this._glFormat=s.DEPTH_STENCIL,this._glInternalFormat=s.DEPTH24_STENCIL8,this._glPixelType=s.UNSIGNED_INT_24_8;break;case Ys:this._glFormat=s.RGB,this._glInternalFormat=s.R11F_G11F_B10F,this._glPixelType=s.UNSIGNED_INT_10F_11F_11F_REV;break;case 19:this._glFormat=s.RGB,this._glInternalFormat=s.SRGB8,this._glPixelType=s.UNSIGNED_BYTE;break;case Qs:this._glFormat=s.RGBA,this._glInternalFormat=s.SRGB8_ALPHA8,this._glPixelType=s.UNSIGNED_BYTE;break;case 32:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R8I,this._glPixelType=s.BYTE;break;case 33:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R8UI,this._glPixelType=s.UNSIGNED_BYTE;break;case 34:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R16I,this._glPixelType=s.SHORT;break;case 35:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R16UI,this._glPixelType=s.UNSIGNED_SHORT;break;case 36:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R32I,this._glPixelType=s.INT;break;case 37:this._glFormat=s.RED_INTEGER,this._glInternalFormat=s.R32UI,this._glPixelType=s.UNSIGNED_INT;break;case 38:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG8I,this._glPixelType=s.BYTE;break;case 39:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG8UI,this._glPixelType=s.UNSIGNED_BYTE;break;case 40:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG16I,this._glPixelType=s.SHORT;break;case 41:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG16UI,this._glPixelType=s.UNSIGNED_SHORT;break;case 42:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG32I,this._glPixelType=s.INT;break;case 43:this._glFormat=s.RG_INTEGER,this._glInternalFormat=s.RG32UI,this._glPixelType=s.UNSIGNED_INT;break;case 44:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA8I,this._glPixelType=s.BYTE;break;case 45:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA8UI,this._glPixelType=s.UNSIGNED_BYTE;break;case 46:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA16I,this._glPixelType=s.SHORT;break;case 47:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA16UI,this._glPixelType=s.UNSIGNED_SHORT;break;case 48:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA32I,this._glPixelType=s.INT;break;case ei:this._glFormat=s.RGBA_INTEGER,this._glInternalFormat=s.RGBA32UI,this._glPixelType=s.UNSIGNED_INT}this._glCreated=!1}upload(e,t){const s=e.gl;if(!t._needsUpload&&(t._needsMipmapsUpload&&t._mipmapsUploaded||!t.pot))return;let i,n,r=0;const a=t.numLevels;for(t.array&&s.texStorage3D(s.TEXTURE_2D_ARRAY,a,this._glInternalFormat,t._width,t._height,t._arrayLength);t._levels[r]||0===r;)if(t._needsUpload||0!==r){if(r&&(!t._needsMipmapsUpload||!t._mipmaps))break;if(i=t._levels[r],n=1/Math.pow(2,r),1===r&&!t._compressed&&!t._integerFormat&&t._levels.length<a&&(s.generateMipmap(this._glTarget),t._mipmapsUploaded=!0),t._cubemap){let a;if(e._isBrowserInterface(i[0]))for(a=0;a<6;a++){if(!t._levelsUpdated[0][a])continue;let n=i[a];e._isImageBrowserInterface(n)&&(n.width>e.maxCubeMapSize||n.height>e.maxCubeMapSize)&&(n=qa(n,e.maxCubeMapSize),0===r&&(t._width=n.width,t._height=n.height)),e.setUnpackFlipY(!1),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),this._glCreated?s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+a,r,0,0,this._glFormat,this._glPixelType,n):s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+a,r,this._glInternalFormat,this._glFormat,this._glPixelType,n)}else for(n=1/Math.pow(2,r),a=0;a<6;a++){if(!t._levelsUpdated[0][a])continue;const o=i[a];t._compressed?this._glCreated&&o?s.compressedTexSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+a,r,0,0,Math.max(t._width*n,1),Math.max(t._height*n,1),this._glInternalFormat,o):s.compressedTexImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+a,r,this._glInternalFormat,Math.max(t._width*n,1),Math.max(t._height*n,1),0,o):(e.setUnpackFlipY(!1),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),this._glCreated&&o?s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+a,r,0,0,Math.max(t._width*n,1),Math.max(t._height*n,1),this._glFormat,this._glPixelType,o):s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+a,r,this._glInternalFormat,Math.max(t._width*n,1),Math.max(t._height*n,1),0,this._glFormat,this._glPixelType,o))}}else if(t._volume)t._compressed?s.compressedTexImage3D(s.TEXTURE_3D,r,this._glInternalFormat,Math.max(t._width*n,1),Math.max(t._height*n,1),Math.max(t._depth*n,1),0,i):(e.setUnpackFlipY(!1),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),s.texImage3D(s.TEXTURE_3D,r,this._glInternalFormat,Math.max(t._width*n,1),Math.max(t._height*n,1),Math.max(t._depth*n,1),0,this._glFormat,this._glPixelType,i));else if(t.array&&"object"==typeof i){if(t._arrayLength===i.length)if(t._compressed)for(let e=0;e<t._arrayLength;e++)s.compressedTexSubImage3D(s.TEXTURE_2D_ARRAY,r,0,0,e,Math.max(Math.floor(t._width*n),1),Math.max(Math.floor(t._height*n),1),1,this._glFormat,i[e]);else for(let e=0;e<t._arrayLength;e++)s.texSubImage3D(s.TEXTURE_2D_ARRAY,r,0,0,e,Math.max(Math.floor(t._width*n),1),Math.max(Math.floor(t._height*n),1),1,this._glFormat,this._glPixelType,i[e])}else{if(e._isBrowserInterface(i)){e._isImageBrowserInterface(i)&&(i.width>e.maxTextureSize||i.height>e.maxTextureSize)&&(i=qa(i,e.maxTextureSize),0===r&&(t._width=i.width,t._height=i.height));const n=i.width||i.videoWidth,a=i.height||i.videoHeight;e.setUnpackFlipY(t._flipY),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),this._glCreated&&t._width===n&&t._height===a&&!e._isImageVideoInterface(i)?s.texSubImage2D(s.TEXTURE_2D,r,0,0,this._glFormat,this._glPixelType,i):(s.texImage2D(s.TEXTURE_2D,r,this._glInternalFormat,this._glFormat,this._glPixelType,i),0===r&&(t._width=n,t._height=a))}else n=1/Math.pow(2,r),t._compressed?this._glCreated&&i?s.compressedTexSubImage2D(s.TEXTURE_2D,r,0,0,Math.max(Math.floor(t._width*n),1),Math.max(Math.floor(t._height*n),1),this._glInternalFormat,i):s.compressedTexImage2D(s.TEXTURE_2D,r,this._glInternalFormat,Math.max(Math.floor(t._width*n),1),Math.max(Math.floor(t._height*n),1),0,i):(e.setUnpackFlipY(!1),e.setUnpackPremultiplyAlpha(t._premultiplyAlpha),this._glCreated&&i?s.texSubImage2D(s.TEXTURE_2D,r,0,0,Math.max(t._width*n,1),Math.max(t._height*n,1),this._glFormat,this._glPixelType,i):s.texImage2D(s.TEXTURE_2D,r,this._glInternalFormat,Math.max(t._width*n,1),Math.max(t._height*n,1),0,this._glFormat,this._glPixelType,i));t._mipmapsUploaded=0!==r}r++}else r++;if(t._needsUpload)if(t._cubemap)for(let e=0;e<6;e++)t._levelsUpdated[0][e]=!1;else t._levelsUpdated[0]=!1;!t._compressed&&!t._integerFormat&&t._mipmaps&&t._needsMipmapsUpload&&1===t._levels.length&&(s.generateMipmap(this._glTarget),t._mipmapsUploaded=!0),t._gpuSize&&t.adjustVramSizeTracking(e._vram,-t._gpuSize),t._gpuSize=t.gpuSize,t.adjustVramSizeTracking(e._vram,t._gpuSize),this._glCreated=!0}read(e,t,s,i,n){const r=this.texture;return r.device.readTextureAsync(r,e,t,s,i,n)}}class Ka{constructor(e,t){this.msaaFB=void 0,this.resolveFB=void 0,this.msaaFB=e,this.resolveFB=t}destroy(e){this.msaaFB&&(e.deleteRenderbuffer(this.msaaFB),this.msaaFB=null),this.resolveFB&&(e.deleteRenderbuffer(this.resolveFB),this.resolveFB=null)}}class Ya{constructor(){this._glFrameBuffer=null,this._glDepthBuffer=null,this._glResolveFrameBuffer=null,this.colorMrtFramebuffers=null,this._glMsaaColorBuffers=[],this._glMsaaDepthBuffer=null,this.msaaDepthBufferKey=void 0,this.suppliedColorFramebuffer=void 0,this._isInitialized=!1}destroy(e){var t;const s=e.gl;this._isInitialized=!1,this._glFrameBuffer&&(this._glFrameBuffer!==this.suppliedColorFramebuffer&&s.deleteFramebuffer(this._glFrameBuffer),this._glFrameBuffer=null),this._glDepthBuffer&&(s.deleteRenderbuffer(this._glDepthBuffer),this._glDepthBuffer=null),this._glResolveFrameBuffer&&(this._glResolveFrameBuffer!==this.suppliedColorFramebuffer&&s.deleteFramebuffer(this._glResolveFrameBuffer),this._glResolveFrameBuffer=null),this._glMsaaColorBuffers.forEach((e=>{s.deleteRenderbuffer(e)})),this._glMsaaColorBuffers.length=0,null==(t=this.colorMrtFramebuffers)||t.forEach((e=>{e.destroy(s)})),this.colorMrtFramebuffers=null,this._glMsaaDepthBuffer&&(this._glMsaaDepthBuffer=null,this.msaaDepthBufferKey&&Mr(e).release(this.msaaDepthBufferKey)),this.suppliedColorFramebuffer=void 0}get initialized(){return this._isInitialized}init(e,t){const s=e.gl;this._isInitialized=!0;const i=[];if(void 0!==this.suppliedColorFramebuffer)this._glFrameBuffer=this.suppliedColorFramebuffer;else{var n,r;this._glFrameBuffer=s.createFramebuffer(),e.setFramebuffer(this._glFrameBuffer);const a=null!=(n=null==(r=t._colorBuffers)?void 0:r.length)?n:0,o=s.COLOR_ATTACHMENT0;for(let n=0;n<a;++n){const r=t.getColorBuffer(n);r&&(r.impl._glTexture||(r._width=Math.min(r.width,e.maxRenderBufferSize),r._height=Math.min(r.height,e.maxRenderBufferSize),e.setTexture(r,0)),s.framebufferTexture2D(s.FRAMEBUFFER,o+n,r._cubemap?s.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:s.TEXTURE_2D,r.impl._glTexture,t.mipLevel),i.push(o+n))}s.drawBuffers(i);const l=t._depthBuffer;if(l||t._depth){const i=t._stencil?s.DEPTH_STENCIL_ATTACHMENT:s.DEPTH_ATTACHMENT;if(l)l.impl._glTexture||(l._width=Math.min(l.width,e.maxRenderBufferSize),l._height=Math.min(l.height,e.maxRenderBufferSize),e.setTexture(l,0)),s.framebufferTexture2D(s.FRAMEBUFFER,i,l._cubemap?s.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:s.TEXTURE_2D,t._depthBuffer.impl._glTexture,t.mipLevel);else{if(!(t._samples>1)){this._glDepthBuffer||(this._glDepthBuffer=s.createRenderbuffer());const e=t._stencil?s.DEPTH24_STENCIL8:s.DEPTH_COMPONENT32F;s.bindRenderbuffer(s.RENDERBUFFER,this._glDepthBuffer),s.renderbufferStorage(s.RENDERBUFFER,e,t.width,t.height),s.framebufferRenderbuffer(s.FRAMEBUFFER,i,s.RENDERBUFFER,this._glDepthBuffer),s.bindRenderbuffer(s.RENDERBUFFER,null)}}}}if(t._samples>1){var a,o;this._glResolveFrameBuffer=this._glFrameBuffer,this._glFrameBuffer=s.createFramebuffer(),e.setFramebuffer(this._glFrameBuffer);const n=null!=(a=null==(o=t._colorBuffers)?void 0:o.length)?a:0;if(void 0!==this.suppliedColorFramebuffer){const i=s.createRenderbuffer();this._glMsaaColorBuffers.push(i);const n=7===e.backBufferFormat?s.RGBA8:s.RGB8;s.bindRenderbuffer(s.RENDERBUFFER,i),s.renderbufferStorageMultisample(s.RENDERBUFFER,t._samples,n,t.width,t.height),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.RENDERBUFFER,i)}else for(let e=0;e<n;++e){const i=t.getColorBuffer(e);if(i){const n=s.createRenderbuffer();this._glMsaaColorBuffers.push(n),s.bindRenderbuffer(s.RENDERBUFFER,n),s.renderbufferStorageMultisample(s.RENDERBUFFER,t._samples,i.impl._glInternalFormat,t.width,t.height),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0+e,s.RENDERBUFFER,n)}}if(t._depth){const i=t._stencil?s.DEPTH24_STENCIL8:s.DEPTH_COMPONENT32F,n=t._stencil?s.DEPTH_STENCIL_ATTACHMENT:s.DEPTH_ATTACHMENT;let r;const a=t._depthBuffer;a&&(r=`${a.id}:${t.width}:${t.height}:${t._samples}:${i}:${n}`,this._glMsaaDepthBuffer=Mr(e).get(r)),this._glMsaaDepthBuffer||(this._glMsaaDepthBuffer=s.createRenderbuffer(),s.bindRenderbuffer(s.RENDERBUFFER,this._glMsaaDepthBuffer),s.renderbufferStorageMultisample(s.RENDERBUFFER,t._samples,i,t.width,t.height),this._glMsaaDepthBuffer.destroy=function(){s.deleteRenderbuffer(this)},a&&Mr(e).set(r,this._glMsaaDepthBuffer)),this.msaaDepthBufferKey=r,s.framebufferRenderbuffer(s.FRAMEBUFFER,n,s.RENDERBUFFER,this._glMsaaDepthBuffer)}n>1&&(this._createMsaaMrtFramebuffers(e,t,n),e.setFramebuffer(this._glFrameBuffer),s.drawBuffers(i))}}_createMsaaMrtFramebuffers(e,t,s){const i=e.gl;this.colorMrtFramebuffers=[];for(let n=0;n<s;++n){const s=t.getColorBuffer(n),r=i.createFramebuffer();e.setFramebuffer(r);const a=this._glMsaaColorBuffers[n];i.bindRenderbuffer(i.RENDERBUFFER,a),i.renderbufferStorageMultisample(i.RENDERBUFFER,t._samples,s.impl._glInternalFormat,t.width,t.height),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.RENDERBUFFER,a),i.drawBuffers([i.COLOR_ATTACHMENT0]);const o=i.createFramebuffer();e.setFramebuffer(o),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,s._cubemap?i.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:i.TEXTURE_2D,s.impl._glTexture,0),this.colorMrtFramebuffers[n]=new Ka(r,o)}}_checkFbo(e,t,s=""){const i=e.gl;i.checkFramebufferStatus(i.FRAMEBUFFER)}loseContext(){this._glFrameBuffer=null,this._glDepthBuffer=null,this._glResolveFrameBuffer=null,this._glMsaaColorBuffers.length=0,this._glMsaaDepthBuffer=null,this.msaaDepthBufferKey=void 0,this.colorMrtFramebuffers=null,this.suppliedColorFramebuffer=void 0,this._isInitialized=!1}internalResolve(e,t,s,i,n){e.setScissor(0,0,i.width,i.height);const r=e.gl;r.bindFramebuffer(r.READ_FRAMEBUFFER,t),r.bindFramebuffer(r.DRAW_FRAMEBUFFER,s),r.blitFramebuffer(0,0,i.width,i.height,0,0,i.width,i.height,n,r.NEAREST)}resolve(e,t,s,i){const n=e.gl;if(this.colorMrtFramebuffers){if(s)for(let s=0;s<this.colorMrtFramebuffers.length;s++){const i=this.colorMrtFramebuffers[s];this.internalResolve(e,i.msaaFB,i.resolveFB,t,n.COLOR_BUFFER_BIT)}i&&this.internalResolve(e,this._glFrameBuffer,this._glResolveFrameBuffer,t,n.DEPTH_BUFFER_BIT)}else this.internalResolve(e,this._glFrameBuffer,this._glResolveFrameBuffer,t,(s?n.COLOR_BUFFER_BIT:0)|(i?n.DEPTH_BUFFER_BIT:0));n.bindFramebuffer(n.FRAMEBUFFER,this._glFrameBuffer)}}class Qa{constructor(){this.renderVersion=void 0,this.queries=[]}destroy(e){this.queries.forEach((t=>e.deleteQuery(t))),this.queries=null}}class Ja extends Da{constructor(e){super(),this.device=void 0,this.freeQueries=[],this.frameQueries=[],this.previousFrameQueries=[],this.timings=[],this.device=e,this.ext=e.extDisjointTimerQuery}destroy(){this.freeQueries.forEach((e=>this.device.gl.deleteQuery(e))),this.frameQueries.forEach((e=>this.device.gl.deleteQuery(e))),this.previousFrameQueries.forEach((e=>e.destroy(this.device.gl))),this.freeQueries=null,this.frameQueries=null,this.previousFrameQueries=null}loseContext(){super.loseContext(),this.freeQueries=[],this.frameQueries=[],this.previousFrameQueries=[]}restoreContext(){this.ext=this.device.extDisjointTimerQuery}getQuery(){var e;return null!=(e=this.freeQueries.pop())?e:this.device.gl.createQuery()}start(e){if(this.ext){const t=this.getSlot(e),s=this.getQuery();return this.frameQueries[t]=s,this.device.gl.beginQuery(this.ext.TIME_ELAPSED_EXT,s),t}}end(e){void 0!==e&&this.device.gl.endQuery(this.ext.TIME_ELAPSED_EXT)}frameStart(){this.processEnableRequest(),this._enabled&&(this.frameGPUMarkerSlot=this.start("GpuFrame"))}frameEnd(){this._enabled&&this.end(this.frameGPUMarkerSlot)}request(){if(this._enabled){const e=this.ext,t=this.device.gl,s=this.device.renderVersion,i=this.frameQueries;if(i.length>0){this.frameQueries=[];const e=new Qa;e.queries=i,e.renderVersion=s,this.previousFrameQueries.push(e)}if(this.previousFrameQueries.length>0){const s=this.previousFrameQueries[0],i=s.queries,n=i[i.length-1],r=t.getQueryParameter(n,t.QUERY_RESULT_AVAILABLE),a=t.getParameter(e.GPU_DISJOINT_EXT);if(r&&!a){this.previousFrameQueries.shift();const e=this.timings;e.length=0;for(let s=0;s<i.length;s++){const n=i[s],r=t.getQueryParameter(n,t.QUERY_RESULT);e[s]=1e-6*r,this.freeQueries.push(n)}this.report(s.renderVersion,e)}a&&(this.previousFrameQueries.forEach((e=>{this.report(e.renderVersion,null),e.destroy(t)})),this.previousFrameQueries.length=0)}super.request(s)}}}const Za=[];class eo extends Zn{constructor(e,t={}){var s,i;super(e,t),this.gl=void 0,this._defaultFramebuffer=null,this._defaultFramebufferChanged=!1,t=this.initOptions,this.updateClientRect(),this.initTextureUnits(),this.contextLost=!1,this._contextLostHandler=e=>{e.preventDefault(),this.loseContext(),this.fire("devicelost")},this._contextRestoredHandler=()=>{this.restoreContext(),this.fire("devicerestored")};const n="undefined"!=typeof navigator&&navigator.userAgent;if(this.forceDisableMultisampling=n&&n.includes("AppleWebKit")&&(n.includes("15.4")||n.includes("15_4")),this.forceDisableMultisampling&&(t.antialias=!1),"firefox"===qt.browserName){const e=("undefined"!=typeof navigator?navigator.userAgent:"").match(/Firefox\/(\d+(\.\d+)*)/),s=e?e[1]:null;if(s){const e=parseFloat(s);("windows"===qt.name&&(e>=120||115===e)||"android"===qt.name&&e>=132)&&(t.antialias=!1)}}this.backBufferAntialias=null!=(s=t.antialias)&&s,t.antialias=!1;const r=null!=(i=t.gl)?i:e.getContext("webgl2",t);if(!r)throw new Error("WebGL not supported");this.gl=r,this.isWebGL2=!0,this._deviceType=Yi,this.updateBackbufferFormat(null);const a="chrome"===qt.browserName,o="safari"===qt.browserName,l=qt.browser&&-1!==navigator.appVersion.indexOf("Mac");let h,c,d,u,p;this._tempEnableSafariTextureUnitWorkaround=o,this._tempMacChromeBlitFramebufferWorkaround=l&&a&&!t.alpha,e.addEventListener("webglcontextlost",this._contextLostHandler,!1),e.addEventListener("webglcontextrestored",this._contextRestoredHandler,!1),this.initializeExtensions(),this.initializeCapabilities(),this.initializeRenderState(),this.initializeContextCaches(),this.createBackbuffer(null),this.supportsImageBitmap=!o&&"undefined"!=typeof ImageBitmap,this._samplerTypes=new Set([r.SAMPLER_2D,r.SAMPLER_CUBE,r.UNSIGNED_INT_SAMPLER_2D,r.INT_SAMPLER_2D,r.SAMPLER_2D_SHADOW,r.SAMPLER_CUBE_SHADOW,r.SAMPLER_3D,r.INT_SAMPLER_3D,r.UNSIGNED_INT_SAMPLER_3D,r.SAMPLER_2D_ARRAY,r.INT_SAMPLER_2D_ARRAY,r.UNSIGNED_INT_SAMPLER_2D_ARRAY]),this.glAddress=[r.REPEAT,r.CLAMP_TO_EDGE,r.MIRRORED_REPEAT],this.glBlendEquation=[r.FUNC_ADD,r.FUNC_SUBTRACT,r.FUNC_REVERSE_SUBTRACT,r.MIN,r.MAX],this.glBlendFunctionColor=[r.ZERO,r.ONE,r.SRC_COLOR,r.ONE_MINUS_SRC_COLOR,r.DST_COLOR,r.ONE_MINUS_DST_COLOR,r.SRC_ALPHA,r.SRC_ALPHA_SATURATE,r.ONE_MINUS_SRC_ALPHA,r.DST_ALPHA,r.ONE_MINUS_DST_ALPHA,r.CONSTANT_COLOR,r.ONE_MINUS_CONSTANT_COLOR],this.glBlendFunctionAlpha=[r.ZERO,r.ONE,r.SRC_COLOR,r.ONE_MINUS_SRC_COLOR,r.DST_COLOR,r.ONE_MINUS_DST_COLOR,r.SRC_ALPHA,r.SRC_ALPHA_SATURATE,r.ONE_MINUS_SRC_ALPHA,r.DST_ALPHA,r.ONE_MINUS_DST_ALPHA,r.CONSTANT_ALPHA,r.ONE_MINUS_CONSTANT_ALPHA],this.glComparison=[r.NEVER,r.LESS,r.EQUAL,r.LEQUAL,r.GREATER,r.NOTEQUAL,r.GEQUAL,r.ALWAYS],this.glStencilOp=[r.KEEP,r.ZERO,r.REPLACE,r.INCR,r.INCR_WRAP,r.DECR,r.DECR_WRAP,r.INVERT],this.glClearFlag=[0,r.COLOR_BUFFER_BIT,r.DEPTH_BUFFER_BIT,r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT,r.STENCIL_BUFFER_BIT,r.STENCIL_BUFFER_BIT|r.COLOR_BUFFER_BIT,r.STENCIL_BUFFER_BIT|r.DEPTH_BUFFER_BIT,r.STENCIL_BUFFER_BIT|r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT],this.glCull=[0,r.BACK,r.FRONT,r.FRONT_AND_BACK],this.glFilter=[r.NEAREST,r.LINEAR,r.NEAREST_MIPMAP_NEAREST,r.NEAREST_MIPMAP_LINEAR,r.LINEAR_MIPMAP_NEAREST,r.LINEAR_MIPMAP_LINEAR],this.glPrimitive=[r.POINTS,r.LINES,r.LINE_LOOP,r.LINE_STRIP,r.TRIANGLES,r.TRIANGLE_STRIP,r.TRIANGLE_FAN],this.glType=[r.BYTE,r.UNSIGNED_BYTE,r.SHORT,r.UNSIGNED_SHORT,r.INT,r.UNSIGNED_INT,r.FLOAT,r.HALF_FLOAT],this.pcUniformType={},this.pcUniformType[r.BOOL]=0,this.pcUniformType[r.INT]=1,this.pcUniformType[r.FLOAT]=2,this.pcUniformType[r.FLOAT_VEC2]=3,this.pcUniformType[r.FLOAT_VEC3]=4,this.pcUniformType[r.FLOAT_VEC4]=5,this.pcUniformType[r.INT_VEC2]=6,this.pcUniformType[r.INT_VEC3]=7,this.pcUniformType[r.INT_VEC4]=8,this.pcUniformType[r.BOOL_VEC2]=9,this.pcUniformType[r.BOOL_VEC3]=10,this.pcUniformType[r.BOOL_VEC4]=11,this.pcUniformType[r.FLOAT_MAT2]=12,this.pcUniformType[r.FLOAT_MAT3]=13,this.pcUniformType[r.FLOAT_MAT4]=Vi,this.pcUniformType[r.SAMPLER_2D]=15,this.pcUniformType[r.SAMPLER_CUBE]=16,this.pcUniformType[r.UNSIGNED_INT]=Gi,this.pcUniformType[r.UNSIGNED_INT_VEC2]=Hi,this.pcUniformType[r.UNSIGNED_INT_VEC3]=ji,this.pcUniformType[r.UNSIGNED_INT_VEC4]=Wi,this.pcUniformType[r.SAMPLER_2D_SHADOW]=18,this.pcUniformType[r.SAMPLER_CUBE_SHADOW]=19,this.pcUniformType[r.SAMPLER_2D_ARRAY]=25,this.pcUniformType[r.SAMPLER_3D]=20,this.pcUniformType[r.INT_SAMPLER_2D]=42,this.pcUniformType[r.UNSIGNED_INT_SAMPLER_2D]=43,this.pcUniformType[r.INT_SAMPLER_CUBE]=44,this.pcUniformType[r.UNSIGNED_INT_SAMPLER_2D]=45,this.pcUniformType[r.INT_SAMPLER_3D]=46,this.pcUniformType[r.UNSIGNED_INT_SAMPLER_3D]=47,this.pcUniformType[r.INT_SAMPLER_2D_ARRAY]=48,this.pcUniformType[r.UNSIGNED_INT_SAMPLER_2D_ARRAY]=49,this.targetToSlot={},this.targetToSlot[r.TEXTURE_2D]=0,this.targetToSlot[r.TEXTURE_CUBE_MAP]=1,this.targetToSlot[r.TEXTURE_3D]=2,this.commitFunction=[],this.commitFunction[0]=function(e,t){e.value!==t&&(r.uniform1i(e.locationId,t),e.value=t)},this.commitFunction[1]=this.commitFunction[0],this.commitFunction[2]=function(e,t){e.value!==t&&(r.uniform1f(e.locationId,t),e.value=t)},this.commitFunction[3]=function(e,t){p=e.value,h=t[0],c=t[1],p[0]===h&&p[1]===c||(r.uniform2fv(e.locationId,t),p[0]=h,p[1]=c)},this.commitFunction[4]=function(e,t){p=e.value,h=t[0],c=t[1],d=t[2],p[0]===h&&p[1]===c&&p[2]===d||(r.uniform3fv(e.locationId,t),p[0]=h,p[1]=c,p[2]=d)},this.commitFunction[5]=function(e,t){p=e.value,h=t[0],c=t[1],d=t[2],u=t[3],p[0]===h&&p[1]===c&&p[2]===d&&p[3]===u||(r.uniform4fv(e.locationId,t),p[0]=h,p[1]=c,p[2]=d,p[3]=u)},this.commitFunction[6]=function(e,t){p=e.value,h=t[0],c=t[1],p[0]===h&&p[1]===c||(r.uniform2iv(e.locationId,t),p[0]=h,p[1]=c)},this.commitFunction[9]=this.commitFunction[6],this.commitFunction[7]=function(e,t){p=e.value,h=t[0],c=t[1],d=t[2],p[0]===h&&p[1]===c&&p[2]===d||(r.uniform3iv(e.locationId,t),p[0]=h,p[1]=c,p[2]=d)},this.commitFunction[10]=this.commitFunction[7],this.commitFunction[8]=function(e,t){p=e.value,h=t[0],c=t[1],d=t[2],u=t[3],p[0]===h&&p[1]===c&&p[2]===d&&p[3]===u||(r.uniform4iv(e.locationId,t),p[0]=h,p[1]=c,p[2]=d,p[3]=u)},this.commitFunction[11]=this.commitFunction[8],this.commitFunction[12]=function(e,t){r.uniformMatrix2fv(e.locationId,!1,t)},this.commitFunction[13]=function(e,t){r.uniformMatrix3fv(e.locationId,!1,t)},this.commitFunction[14]=function(e,t){r.uniformMatrix4fv(e.locationId,!1,t)},this.commitFunction[17]=function(e,t){r.uniform1fv(e.locationId,t)},this.commitFunction[21]=function(e,t){r.uniform2fv(e.locationId,t)},this.commitFunction[22]=function(e,t){r.uniform3fv(e.locationId,t)},this.commitFunction[23]=function(e,t){r.uniform4fv(e.locationId,t)},this.commitFunction[26]=function(e,t){e.value!==t&&(r.uniform1ui(e.locationId,t),e.value=t)},this.commitFunction[27]=function(e,t){p=e.value,h=t[0],c=t[1],p[0]===h&&p[1]===c||(r.uniform2uiv(e.locationId,t),p[0]=h,p[1]=c)},this.commitFunction[28]=function(e,t){p=e.value,h=t[0],c=t[1],d=t[2],p[0]===h&&p[1]===c&&p[2]===d||(r.uniform3uiv(e.locationId,t),p[0]=h,p[1]=c,p[2]=d)},this.commitFunction[29]=function(e,t){p=e.value,h=t[0],c=t[1],d=t[2],u=t[3],p[0]===h&&p[1]===c&&p[2]===d&&p[3]===u||(r.uniform4uiv(e.locationId,t),p[0]=h,p[1]=c,p[2]=d,p[3]=u)},this.commitFunction[30]=function(e,t){r.uniform1iv(e.locationId,t)},this.commitFunction[31]=function(e,t){r.uniform1uiv(e.locationId,t)},this.commitFunction[32]=this.commitFunction[30],this.commitFunction[33]=function(e,t){r.uniform2iv(e.locationId,t)},this.commitFunction[34]=function(e,t){r.uniform2uiv(e.locationId,t)},this.commitFunction[35]=this.commitFunction[33],this.commitFunction[36]=function(e,t){r.uniform3iv(e.locationId,t)},this.commitFunction[37]=function(e,t){r.uniform3uiv(e.locationId,t)},this.commitFunction[38]=this.commitFunction[36],this.commitFunction[39]=function(e,t){r.uniform4iv(e.locationId,t)},this.commitFunction[40]=function(e,t){r.uniform4uiv(e.locationId,t)},this.commitFunction[41]=this.commitFunction[39],this.commitFunction[24]=function(e,t){r.uniformMatrix4fv(e.locationId,!1,t)},this.constantTexSource=this.scope.resolve("source"),this.textureFloatRenderable=!!this.extColorBufferFloat,this.textureHalfFloatRenderable=!!this.extColorBufferHalfFloat||!!this.extColorBufferFloat,this.postInit()}postInit(){super.postInit(),this.gpuProfiler=new Ja(this)}destroy(){super.destroy();const e=this.gl;this.feedback&&e.deleteTransformFeedback(this.feedback),this.clearVertexArrayObjectCache(),this.canvas.removeEventListener("webglcontextlost",this._contextLostHandler,!1),this.canvas.removeEventListener("webglcontextrestored",this._contextRestoredHandler,!1),this._contextLostHandler=null,this._contextRestoredHandler=null,this.gl=null,super.postDestroy()}createBackbuffer(e){this.supportsStencil=this.initOptions.stencil,this.backBuffer=new tr({name:"WebglFramebuffer",graphicsDevice:this,depth:this.initOptions.depth,stencil:this.supportsStencil,samples:this.samples}),this.backBuffer.impl.suppliedColorFramebuffer=e}updateBackbufferFormat(e){const t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,e);const s=this.gl.getParameter(this.gl.ALPHA_BITS);this.backBufferFormat=s?7:6}updateBackbuffer(){const e=this.canvas.width!==this.backBufferSize.x||this.canvas.height!==this.backBufferSize.y;(this._defaultFramebufferChanged||e)&&(this._defaultFramebufferChanged&&this.updateBackbufferFormat(this._defaultFramebuffer),this._defaultFramebufferChanged=!1,this.backBufferSize.set(this.canvas.width,this.canvas.height),this.backBuffer.destroy(),this.createBackbuffer(this._defaultFramebuffer))}createVertexBufferImpl(e,t){return new Na}createIndexBufferImpl(e){return new Ua(e)}createShaderImpl(e){return new $a(e)}createTextureImpl(e){return new Xa(e)}createRenderTargetImpl(e){return new Ya}getPrecision(){const e=this.gl;let t="highp";if(e.getShaderPrecisionFormat){const s=e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.HIGH_FLOAT),i=e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.MEDIUM_FLOAT),n=e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT),r=e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT);if(s&&i&&n&&r){const e=s.precision>0&&n.precision>0,a=i.precision>0&&r.precision>0;e||(t=a?"mediump":"lowp")}}return t}getExtension(){for(let e=0;e<arguments.length;e++)if(-1!==this.supportedExtensions.indexOf(arguments[e]))return this.gl.getExtension(arguments[e]);return null}get extDisjointTimerQuery(){return this._extDisjointTimerQuery||(this._extDisjointTimerQuery=this.getExtension("EXT_disjoint_timer_query_webgl2","EXT_disjoint_timer_query")),this._extDisjointTimerQuery}initializeExtensions(){var e;const t=this.gl;this.supportedExtensions=null!=(e=t.getSupportedExtensions())?e:[],this._extDisjointTimerQuery=null,this.textureRG11B10Renderable=!0,this.extColorBufferFloat=this.getExtension("EXT_color_buffer_float"),this.extDebugRendererInfo=this.getExtension("WEBGL_debug_renderer_info"),this.extTextureFloatLinear=this.getExtension("OES_texture_float_linear"),this.textureFloatFilterable=!!this.extTextureFloatLinear,this.extFloatBlend=this.getExtension("EXT_float_blend"),this.extTextureFilterAnisotropic=this.getExtension("EXT_texture_filter_anisotropic","WEBKIT_EXT_texture_filter_anisotropic"),this.extParallelShaderCompile=this.getExtension("KHR_parallel_shader_compile"),this.extCompressedTextureETC1=this.getExtension("WEBGL_compressed_texture_etc1"),this.extCompressedTextureETC=this.getExtension("WEBGL_compressed_texture_etc"),this.extCompressedTexturePVRTC=this.getExtension("WEBGL_compressed_texture_pvrtc","WEBKIT_WEBGL_compressed_texture_pvrtc"),this.extCompressedTextureS3TC=this.getExtension("WEBGL_compressed_texture_s3tc","WEBKIT_WEBGL_compressed_texture_s3tc"),this.extCompressedTextureS3TC_SRGB=this.getExtension("WEBGL_compressed_texture_s3tc_srgb"),this.extCompressedTextureATC=this.getExtension("WEBGL_compressed_texture_atc"),this.extCompressedTextureASTC=this.getExtension("WEBGL_compressed_texture_astc"),this.extTextureCompressionBPTC=this.getExtension("EXT_texture_compression_bptc"),this.extColorBufferHalfFloat=this.getExtension("EXT_color_buffer_half_float")}initializeCapabilities(){var e,t;const s=this.gl;let i;const n="undefined"!=typeof navigator?navigator.userAgent:"";this.maxPrecision=this.precision=this.getPrecision();const r=s.getContextAttributes();this.supportsMsaa=null!=(e=null==r?void 0:r.antialias)&&e,this.supportsStencil=null!=(t=null==r?void 0:r.stencil)&&t,this.maxTextureSize=s.getParameter(s.MAX_TEXTURE_SIZE),this.maxCubeMapSize=s.getParameter(s.MAX_CUBE_MAP_TEXTURE_SIZE),this.maxRenderBufferSize=s.getParameter(s.MAX_RENDERBUFFER_SIZE),this.maxTextures=s.getParameter(s.MAX_TEXTURE_IMAGE_UNITS),this.maxCombinedTextures=s.getParameter(s.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this.maxVertexTextures=s.getParameter(s.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this.vertexUniformsCount=s.getParameter(s.MAX_VERTEX_UNIFORM_VECTORS),this.fragmentUniformsCount=s.getParameter(s.MAX_FRAGMENT_UNIFORM_VECTORS),this.maxColorAttachments=s.getParameter(s.MAX_COLOR_ATTACHMENTS),this.maxVolumeSize=s.getParameter(s.MAX_3D_TEXTURE_SIZE),i=this.extDebugRendererInfo,this.unmaskedRenderer=i?s.getParameter(i.UNMASKED_RENDERER_WEBGL):"",this.unmaskedVendor=i?s.getParameter(i.UNMASKED_VENDOR_WEBGL):"";this.supportsGpuParticles=!("ARM"===this.unmaskedVendor&&n.match(/SM-[a-zA-Z0-9]+/)||this.unmaskedRenderer.match(/\bMali-G52+/)),i=this.extTextureFilterAnisotropic,this.maxAnisotropy=i?s.getParameter(i.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1;const a=!this.forceDisableMultisampling;this.maxSamples=a?s.getParameter(s.MAX_SAMPLES):1,this.maxSamples=Math.min(this.maxSamples,4),this.samples=a&&this.backBufferAntialias?this.maxSamples:1,this.supportsAreaLights=!qt.android,this.maxTextures<=8&&(this.supportsAreaLights=!1)}initializeRenderState(){super.initializeRenderState();const e=this.gl;e.disable(e.BLEND),e.blendFunc(e.ONE,e.ZERO),e.blendEquation(e.FUNC_ADD),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0),e.enable(e.CULL_FACE),this.cullFace=e.BACK,e.cullFace(e.BACK),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.depthMask(!0),this.stencil=!1,e.disable(e.STENCIL_TEST),this.stencilFuncFront=this.stencilFuncBack=7,this.stencilRefFront=this.stencilRefBack=0,this.stencilMaskFront=this.stencilMaskBack=255,e.stencilFunc(e.ALWAYS,0,255),this.stencilFailFront=this.stencilFailBack=0,this.stencilZfailFront=this.stencilZfailBack=0,this.stencilZpassFront=this.stencilZpassBack=0,this.stencilWriteMaskFront=255,this.stencilWriteMaskBack=255,e.stencilOp(e.KEEP,e.KEEP,e.KEEP),e.stencilMask(255),this.alphaToCoverage=!1,this.raster=!0,e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.RASTERIZER_DISCARD),this.depthBiasEnabled=!1,e.disable(e.POLYGON_OFFSET_FILL),this.clearDepth=1,e.clearDepth(1),this.clearColor=new os(0,0,0,0),e.clearColor(0,0,0,0),this.clearStencil=0,e.clearStencil(0),e.hint(e.FRAGMENT_SHADER_DERIVATIVE_HINT,e.NICEST),e.enable(e.SCISSOR_TEST),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,e.NONE),this.unpackFlipY=!1,e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),this.unpackPremultiplyAlpha=!1,e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),e.pixelStorei(e.UNPACK_ALIGNMENT,1)}initTextureUnits(e=16){this.textureUnits=[];for(let t=0;t<e;t++)this.textureUnits.push([null,null,null])}initializeContextCaches(){super.initializeContextCaches(),this._vaoMap=new Map,this.boundVao=null,this.activeFramebuffer=null,this.feedback=null,this.transformFeedbackBuffer=null,this.textureUnit=0,this.initTextureUnits(this.maxCombinedTextures)}loseContext(){super.loseContext();for(const e of this.shaders)e.loseContext()}restoreContext(){this.initializeExtensions(),this.initializeCapabilities(),super.restoreContext();for(const e of this.shaders)e.restoreContext()}setViewport(e,t,s,i){this.vx===e&&this.vy===t&&this.vw===s&&this.vh===i||(this.gl.viewport(e,t,s,i),this.vx=e,this.vy=t,this.vw=s,this.vh=i)}setScissor(e,t,s,i){this.sx===e&&this.sy===t&&this.sw===s&&this.sh===i||(this.gl.scissor(e,t,s,i),this.sx=e,this.sy=t,this.sw=s,this.sh=i)}setFramebuffer(e){if(this.activeFramebuffer!==e){const t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,e),this.activeFramebuffer=e}}copyRenderTarget(e,t,s,i){var n,r;const a=this.gl;if(e===this.backBuffer&&(e=null),s)if(t){if(e){if(!e._colorBuffer||!t._colorBuffer)return!1;if(e._colorBuffer._format!==t._colorBuffer._format)return!1}}else if(!e._colorBuffer)return!1;if(i&&e&&!e._depth){if(!e._depthBuffer||!t._depthBuffer)return!1;if(e._depthBuffer._format!==t._depthBuffer._format)return!1}const o=this.renderTarget;this.renderTarget=t,this.updateBegin();const l=e?e.impl._glFrameBuffer:null==(n=this.backBuffer)?void 0:n.impl._glFrameBuffer,h=t?t.impl._glFrameBuffer:null==(r=this.backBuffer)?void 0:r.impl._glFrameBuffer;a.bindFramebuffer(a.READ_FRAMEBUFFER,l),a.bindFramebuffer(a.DRAW_FRAMEBUFFER,h);const c=e?e.width:t?t.width:this.width,d=e?e.height:t?t.height:this.height;return a.blitFramebuffer(0,0,c,d,0,0,c,d,(s?a.COLOR_BUFFER_BIT:0)|(i?a.DEPTH_BUFFER_BIT:0),a.NEAREST),this.renderTarget=o,a.bindFramebuffer(a.FRAMEBUFFER,o?o.impl._glFrameBuffer:null),!0}frameStart(){super.frameStart(),this.updateBackbuffer(),this.gpuProfiler.frameStart()}frameEnd(){super.frameEnd(),this.gpuProfiler.frameEnd(),this.gpuProfiler.request()}startRenderPass(e){var t;const s=null!=(t=e.renderTarget)?t:this.backBuffer;this.renderTarget=s,this.updateBegin();const{width:i,height:n}=s;this.setViewport(0,0,i,n),this.setScissor(0,0,i,n);const r=e.colorOps,a=e.depthStencilOps;if(null!=r&&r.clear||a.clearDepth||a.clearStencil){let e=0;const t={};null!=r&&r.clear&&(e|=1,t.color=[r.clearValue.r,r.clearValue.g,r.clearValue.b,r.clearValue.a]),a.clearDepth&&(e|=2,t.depth=a.clearDepthValue),a.clearStencil&&(e|=4,t.stencil=a.clearStencilValue),t.flags=e,this.clear(t)}this.insideRenderPass=!0}endRenderPass(e){this.unbindVertexArray();const t=this.renderTarget,s=e.colorArrayOps.length;if(t){var i;Za.length=0;const n=this.gl;for(let t=0;t<s;t++){const s=e.colorArrayOps[t];s.store||s.resolve||Za.push(n.COLOR_ATTACHMENT0+t)}t!==this.backBuffer&&(e.depthStencilOps.storeDepth||Za.push(n.DEPTH_ATTACHMENT),e.depthStencilOps.storeStencil||Za.push(n.STENCIL_ATTACHMENT)),Za.length>0&&e.fullSizeClearRect&&n.invalidateFramebuffer(n.DRAW_FRAMEBUFFER,Za),s&&null!=(i=e.colorOps)&&i.resolve&&e.samples>1&&t.autoResolve&&t.resolve(!0,!1),t.depthBuffer&&e.depthStencilOps.resolveDepth&&e.samples>1&&t.autoResolve&&t.resolve(!1,!0);for(let i=0;i<s;i++){if(e.colorArrayOps[i].genMipmaps){const e=t._colorBuffers[i];e&&e.impl._glTexture&&e.mipmaps&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(e),this.gl.generateMipmap(e.impl._glTarget))}}}this.insideRenderPass=!1}set defaultFramebuffer(e){this._defaultFramebuffer!==e&&(this._defaultFramebuffer=e,this._defaultFramebufferChanged=!0)}get defaultFramebuffer(){return this._defaultFramebuffer}updateBegin(){var e;if(this.boundVao=null,this._tempEnableSafariTextureUnitWorkaround)for(let e=0;e<this.textureUnits.length;++e)for(let t=0;t<3;++t)this.textureUnits[e][t]=null;const t=null!=(e=this.renderTarget)?e:this.backBuffer,s=t.impl;s.initialized||this.initRenderTarget(t),this.setFramebuffer(s._glFrameBuffer)}updateEnd(){this.unbindVertexArray();const e=this.renderTarget;if(e&&e!==this.backBuffer){e._samples>1&&e.autoResolve&&e.resolve();const t=e._colorBuffer;t&&t.impl._glTexture&&t.mipmaps&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(t),this.gl.generateMipmap(t.impl._glTarget))}}setUnpackFlipY(e){if(this.unpackFlipY!==e){this.unpackFlipY=e;const t=this.gl;t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,e)}}setUnpackPremultiplyAlpha(e){if(this.unpackPremultiplyAlpha!==e){this.unpackPremultiplyAlpha=e;const t=this.gl;t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e)}}activeTexture(e){this.textureUnit!==e&&(this.gl.activeTexture(this.gl.TEXTURE0+e),this.textureUnit=e)}bindTexture(e){const t=e.impl,s=t._glTarget,i=t._glTexture,n=this.textureUnit,r=this.targetToSlot[s];this.textureUnits[n][r]!==i&&(this.gl.bindTexture(s,i),this.textureUnits[n][r]=i)}bindTextureOnUnit(e,t){const s=e.impl,i=s._glTarget,n=s._glTexture,r=this.targetToSlot[i];this.textureUnits[t][r]!==n&&(this.activeTexture(t),this.gl.bindTexture(i,n),this.textureUnits[t][r]=n)}setTextureParameters(e){const t=this.gl,s=e.impl.dirtyParameterFlags,i=e.impl._glTarget;if(1&s){let s=e._minFilter;(!e._mipmaps||e._compressed&&1===e._levels.length)&&(2===s||3===s?s=0:4!==s&&5!==s||(s=1)),t.texParameteri(i,t.TEXTURE_MIN_FILTER,this.glFilter[s])}if(2&s&&t.texParameteri(i,t.TEXTURE_MAG_FILTER,this.glFilter[e._magFilter]),4&s&&t.texParameteri(i,t.TEXTURE_WRAP_S,this.glAddress[e._addressU]),8&s&&t.texParameteri(i,t.TEXTURE_WRAP_T,this.glAddress[e._addressV]),16&s&&t.texParameteri(i,t.TEXTURE_WRAP_R,this.glAddress[e._addressW]),32&s&&t.texParameteri(i,t.TEXTURE_COMPARE_MODE,e._compareOnRead?t.COMPARE_REF_TO_TEXTURE:t.NONE),64&s&&t.texParameteri(i,t.TEXTURE_COMPARE_FUNC,this.glComparison[e._compareFunc]),128&s){const s=this.extTextureFilterAnisotropic;s&&t.texParameterf(i,s.TEXTURE_MAX_ANISOTROPY_EXT,rs.clamp(Math.round(e._anisotropy),1,this.maxAnisotropy))}}setTexture(e,t){const s=e.impl;s._glTexture||s.initialize(this,e),s.dirtyParameterFlags>0||e._needsUpload||e._needsMipmapsUpload?(this.activeTexture(t),this.bindTexture(e),s.dirtyParameterFlags&&(this.setTextureParameters(e),s.dirtyParameterFlags=0),(e._needsUpload||e._needsMipmapsUpload)&&(s.upload(this,e),e._needsUpload=!1,e._needsMipmapsUpload=!1)):this.bindTextureOnUnit(e,t)}createVertexArray(e){let t,s;const i=e.length>1;if(i){t="";for(let s=0;s<e.length;s++){const i=e[s];t+=i.id+i.format.renderingHash}s=this._vaoMap.get(t)}if(!s){const n=this.gl;s=n.createVertexArray(),n.bindVertexArray(s),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null);for(let t=0;t<e.length;t++){const s=e[t];n.bindBuffer(n.ARRAY_BUFFER,s.impl.bufferId);const i=s.format.elements;for(let e=0;e<i.length;e++){const t=i[e],r=on[t.name];t.asInt?n.vertexAttribIPointer(r,t.numComponents,this.glType[t.dataType],t.stride,t.offset):n.vertexAttribPointer(r,t.numComponents,this.glType[t.dataType],t.normalize,t.stride,t.offset),n.enableVertexAttribArray(r),s.format.instancing&&n.vertexAttribDivisor(r,1)}}n.bindVertexArray(null),n.bindBuffer(n.ARRAY_BUFFER,null),i&&this._vaoMap.set(t,s)}return s}unbindVertexArray(){this.boundVao&&(this.boundVao=null,this.gl.bindVertexArray(null))}setBuffers(){const e=this.gl;let t;if(1===this.vertexBuffers.length){const e=this.vertexBuffers[0];e.impl.vao||(e.impl.vao=this.createVertexArray(this.vertexBuffers)),t=e.impl.vao}else t=this.createVertexArray(this.vertexBuffers);this.boundVao!==t&&(this.boundVao=t,e.bindVertexArray(t)),this.clearVertexBuffer();const s=this.indexBuffer?this.indexBuffer.impl.bufferId:null;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,s)}draw(e,t,s){const i=this.gl;if(this.activateShader(this),!this.shaderValid)return;let n,r,a,o,l,h,c,d;const u=this.shader;if(!u)return;const p=u.impl.samplers,f=u.impl.uniforms;s||this.setBuffers();let m=0;for(let e=0,t=p.length;e<t;e++){if(n=p[e],r=n.scopeId.value,!r){const e=n.scopeId.name;"uSceneDepthMap"===e&&(r=Cn(this,"white")),"uSceneColorMap"===e&&(r=Cn(this,"pink")),r||(r=Cn(this,"pink"))}if(r instanceof yn)a=r,this.setTexture(a,m),n.slot!==m&&(i.uniform1i(n.locationId,m),n.slot=m),m++;else{n.array.length=0,o=r.length;for(let e=0;e<o;e++)a=r[e],this.setTexture(a,m),n.array[e]=m,m++;i.uniform1iv(n.locationId,n.array)}}for(let e=0,t=f.length;e<t;e++)l=f[e],h=l.scopeId,c=l.version,d=h.versionObject.version,c.globalId===d.globalId&&c.revision===d.revision||(c.globalId=d.globalId,c.revision=d.revision,null!==h.value&&this.commitFunction[l.dataType](l,h.value));this.transformFeedbackBuffer&&(i.bindBufferBase(i.TRANSFORM_FEEDBACK_BUFFER,0,this.transformFeedbackBuffer.impl.bufferId),i.beginTransformFeedback(i.POINTS));const g=this.glPrimitive[e.type],_=e.count;if(e.indexed){const s=this.indexBuffer,n=s.impl.glFormat,r=e.base*s.bytesPerIndex;t>0?i.drawElementsInstanced(g,_,n,r,t):i.drawElements(g,_,n,r)}else{const s=e.base;t>0?i.drawArraysInstanced(g,s,_,t):i.drawArrays(g,s,_)}this.transformFeedbackBuffer&&(i.endTransformFeedback(),i.bindBufferBase(i.TRANSFORM_FEEDBACK_BUFFER,0,null)),this._drawCallsPerFrame++}clear(e){var t;const s=this.defaultClearOptions,i=null!=(t=(e=e||s).flags)?t:s.flags;if(0!==i){const t=this.gl;if(1&i){var n;const t=null!=(n=e.color)?n:s.color,i=t[0],r=t[1],a=t[2],o=t[3],l=this.clearColor;i===l.r&&r===l.g&&a===l.b&&o===l.a||(this.gl.clearColor(i,r,a,o),this.clearColor.set(i,r,a,o)),this.setBlendState(Rn.NOBLEND)}if(2&i){var r;const t=null!=(r=e.depth)?r:s.depth;t!==this.clearDepth&&(this.gl.clearDepth(t),this.clearDepth=t),this.setDepthState(On.WRITEDEPTH)}if(4&i){var a;const i=null!=(a=e.stencil)?a:s.stencil;i!==this.clearStencil&&(this.gl.clearStencil(i),this.clearStencil=i),t.stencilMask(255),this.stencilWriteMaskFront=255,this.stencilWriteMaskBack=255}t.clear(this.glClearFlag[i])}}submit(){this.gl.flush()}readPixels(e,t,s,i,n){const r=this.gl;r.readPixels(e,t,s,i,r.RGBA,r.UNSIGNED_BYTE,n)}async readPixelsAsync(e,t,s,i,n){var r,a,o;const l=this.gl,h=null==(r=this.renderTarget.colorBuffer)?void 0:r.impl,c=null!=(a=null==h?void 0:h._glFormat)?a:l.RGBA,d=null!=(o=null==h?void 0:h._glPixelType)?o:l.UNSIGNED_BYTE,u=l.createBuffer();return l.bindBuffer(l.PIXEL_PACK_BUFFER,u),l.bufferData(l.PIXEL_PACK_BUFFER,n.byteLength,l.STREAM_READ),l.readPixels(e,t,s,i,c,d,0),l.bindBuffer(l.PIXEL_PACK_BUFFER,null),await((e,t)=>{const s=l.fenceSync(l.SYNC_GPU_COMMANDS_COMPLETE,0);return this.submit(),new Promise(((i,n)=>{!function r(){const a=l.clientWaitSync(s,e,0);a===l.WAIT_FAILED?(l.deleteSync(s),n(new Error("webgl clientWaitSync sync failed"))):a===l.TIMEOUT_EXPIRED?setTimeout(r,t):(l.deleteSync(s),i())}()}))})(0,20),l.bindBuffer(l.PIXEL_PACK_BUFFER,u),l.getBufferSubData(l.PIXEL_PACK_BUFFER,0,n),l.bindBuffer(l.PIXEL_PACK_BUFFER,null),l.deleteBuffer(u),n}readTextureAsync(e,t,s,i,n,r){var a,o,l;const h=null!=(a=r.face)?a:0,c=null!=(o=r.renderTarget)?o:new tr({colorBuffer:e,depth:!1,face:h}),d=new ArrayBuffer(vn.calcLevelGpuSize(i,n,1,e._format)),u=null!=(l=r.data)?l:new(oi(e._format))(d);return this.setRenderTarget(c),this.initRenderTarget(c),new Promise(((e,a)=>{this.readPixelsAsync(t,s,i,n,u).then((t=>{r.renderTarget||c.destroy(),e(t)})).catch(a)}))}setAlphaToCoverage(e){this.alphaToCoverage!==e&&(this.alphaToCoverage=e,e?this.gl.enable(this.gl.SAMPLE_ALPHA_TO_COVERAGE):this.gl.disable(this.gl.SAMPLE_ALPHA_TO_COVERAGE))}setTransformFeedbackBuffer(e){if(this.transformFeedbackBuffer!==e){this.transformFeedbackBuffer=e;const t=this.gl;e?(this.feedback||(this.feedback=t.createTransformFeedback()),t.bindTransformFeedback(t.TRANSFORM_FEEDBACK,this.feedback)):t.bindTransformFeedback(t.TRANSFORM_FEEDBACK,null)}}setRaster(e){this.raster!==e&&(this.raster=e,e?this.gl.disable(this.gl.RASTERIZER_DISCARD):this.gl.enable(this.gl.RASTERIZER_DISCARD))}setStencilTest(e){if(this.stencil!==e){const t=this.gl;e?t.enable(t.STENCIL_TEST):t.disable(t.STENCIL_TEST),this.stencil=e}}setStencilFunc(e,t,s){this.stencilFuncFront===e&&this.stencilRefFront===t&&this.stencilMaskFront===s&&this.stencilFuncBack===e&&this.stencilRefBack===t&&this.stencilMaskBack===s||(this.gl.stencilFunc(this.glComparison[e],t,s),this.stencilFuncFront=this.stencilFuncBack=e,this.stencilRefFront=this.stencilRefBack=t,this.stencilMaskFront=this.stencilMaskBack=s)}setStencilFuncFront(e,t,s){if(this.stencilFuncFront!==e||this.stencilRefFront!==t||this.stencilMaskFront!==s){const i=this.gl;i.stencilFuncSeparate(i.FRONT,this.glComparison[e],t,s),this.stencilFuncFront=e,this.stencilRefFront=t,this.stencilMaskFront=s}}setStencilFuncBack(e,t,s){if(this.stencilFuncBack!==e||this.stencilRefBack!==t||this.stencilMaskBack!==s){const i=this.gl;i.stencilFuncSeparate(i.BACK,this.glComparison[e],t,s),this.stencilFuncBack=e,this.stencilRefBack=t,this.stencilMaskBack=s}}setStencilOperation(e,t,s,i){this.stencilFailFront===e&&this.stencilZfailFront===t&&this.stencilZpassFront===s&&this.stencilFailBack===e&&this.stencilZfailBack===t&&this.stencilZpassBack===s||(this.gl.stencilOp(this.glStencilOp[e],this.glStencilOp[t],this.glStencilOp[s]),this.stencilFailFront=this.stencilFailBack=e,this.stencilZfailFront=this.stencilZfailBack=t,this.stencilZpassFront=this.stencilZpassBack=s),this.stencilWriteMaskFront===i&&this.stencilWriteMaskBack===i||(this.gl.stencilMask(i),this.stencilWriteMaskFront=i,this.stencilWriteMaskBack=i)}setStencilOperationFront(e,t,s,i){this.stencilFailFront===e&&this.stencilZfailFront===t&&this.stencilZpassFront===s||(this.gl.stencilOpSeparate(this.gl.FRONT,this.glStencilOp[e],this.glStencilOp[t],this.glStencilOp[s]),this.stencilFailFront=e,this.stencilZfailFront=t,this.stencilZpassFront=s),this.stencilWriteMaskFront!==i&&(this.gl.stencilMaskSeparate(this.gl.FRONT,i),this.stencilWriteMaskFront=i)}setStencilOperationBack(e,t,s,i){this.stencilFailBack===e&&this.stencilZfailBack===t&&this.stencilZpassBack===s||(this.gl.stencilOpSeparate(this.gl.BACK,this.glStencilOp[e],this.glStencilOp[t],this.glStencilOp[s]),this.stencilFailBack=e,this.stencilZfailBack=t,this.stencilZpassBack=s),this.stencilWriteMaskBack!==i&&(this.gl.stencilMaskSeparate(this.gl.BACK,i),this.stencilWriteMaskBack=i)}setBlendState(e){const t=this.blendState;if(!t.equals(e)){const s=this.gl,{blend:i,colorOp:n,alphaOp:r,colorSrcFactor:a,colorDstFactor:o,alphaSrcFactor:l,alphaDstFactor:h}=e;if(t.blend!==i&&(i?s.enable(s.BLEND):s.disable(s.BLEND)),t.colorOp!==n||t.alphaOp!==r){const e=this.glBlendEquation;s.blendEquationSeparate(e[n],e[r])}t.colorSrcFactor===a&&t.colorDstFactor===o&&t.alphaSrcFactor===l&&t.alphaDstFactor===h||s.blendFuncSeparate(this.glBlendFunctionColor[a],this.glBlendFunctionColor[o],this.glBlendFunctionAlpha[l],this.glBlendFunctionAlpha[h]),t.allWrite!==e.allWrite&&this.gl.colorMask(e.redWrite,e.greenWrite,e.blueWrite,e.alphaWrite),t.copy(e)}}setBlendColor(e,t,s,i){const n=this.blendColor;e===n.r&&t===n.g&&s===n.b&&i===n.a||(this.gl.blendColor(e,t,s,i),n.set(e,t,s,i))}setStencilState(e,t){e||t?(this.setStencilTest(!0),e===t?(this.setStencilFunc(e.func,e.ref,e.readMask),this.setStencilOperation(e.fail,e.zfail,e.zpass,e.writeMask)):(null!=e||(e=Jn.DEFAULT),this.setStencilFuncFront(e.func,e.ref,e.readMask),this.setStencilOperationFront(e.fail,e.zfail,e.zpass,e.writeMask),null!=t||(t=Jn.DEFAULT),this.setStencilFuncBack(t.func,t.ref,t.readMask),this.setStencilOperationBack(t.fail,t.zfail,t.zpass,t.writeMask))):this.setStencilTest(!1)}setDepthState(e){const t=this.depthState;if(!t.equals(e)){const s=this.gl,i=e.write;t.write!==i&&s.depthMask(i);let{func:n,test:r}=e;!r&&i&&(r=!0,n=7),t.func!==n&&s.depthFunc(this.glComparison[n]),t.test!==r&&(r?s.enable(s.DEPTH_TEST):s.disable(s.DEPTH_TEST));const{depthBias:a,depthBiasSlope:o}=e;a||o?(this.depthBiasEnabled||(this.depthBiasEnabled=!0,this.gl.enable(this.gl.POLYGON_OFFSET_FILL)),s.polygonOffset(o,a)):this.depthBiasEnabled&&(this.depthBiasEnabled=!1,this.gl.disable(this.gl.POLYGON_OFFSET_FILL)),t.copy(e)}}setCullMode(e){if(this.cullMode!==e){if(0===e)this.gl.disable(this.gl.CULL_FACE);else{0===this.cullMode&&this.gl.enable(this.gl.CULL_FACE);const t=this.glCull[e];this.cullFace!==t&&(this.gl.cullFace(t),this.cullFace=t)}this.cullMode=e}}setShader(e,t=!1){e!==this.shader&&(this.shader=e,this.shaderAsyncCompile=t,this.shaderValid=void 0)}activateShader(e){const{shader:t}=this,{impl:s}=t;void 0===this.shaderValid&&(t.failed?this.shaderValid=!1:t.ready||(this.shaderAsyncCompile?s.isLinked(e)?s.finalize(this,t)||(t.failed=!0,this.shaderValid=!1):this.shaderValid=!1:s.finalize(this,t)||(t.failed=!0,this.shaderValid=!1))),void 0===this.shaderValid&&(this.gl.useProgram(s.glProgram),this.shaderValid=!0)}clearVertexArrayObjectCache(){const e=this.gl;this._vaoMap.forEach(((t,s,i)=>{e.deleteVertexArray(t)})),this._vaoMap.clear()}set fullscreen(e){if(e){this.gl.canvas.requestFullscreen()}else document.exitFullscreen()}get fullscreen(){return!!document.fullscreenElement}}class to{unlock(e){}}class so{destroy(e){}init(e,t){}loseContext(){}resolve(e,t,s,i){}}class io{destroy(e){}loseContext(){}restoreContext(e,t){}}class no{destroy(e){}propertyChanged(e){}loseContext(){}}class ro{destroy(e){}unlock(e){}}class ao extends Zn{constructor(e,t={}){super(e,t),t=this.initOptions,this.isNull=!0,this._deviceType=Ji,this.samples=1}destroy(){super.destroy()}initDeviceCaps(){this.disableParticleSystem=!0,this.precision="highp",this.maxPrecision="highp",this.maxSamples=4,this.maxTextures=16,this.maxTextureSize=4096,this.maxCubeMapSize=4096,this.maxVolumeSize=4096,this.maxColorAttachments=8,this.maxPixelRatio=1,this.maxAnisotropy=16,this.supportsUniformBuffers=!1,this.supportsAreaLights=!0,this.supportsGpuParticles=!1,this.textureFloatRenderable=!0,this.textureHalfFloatRenderable=!0,this.supportsImageBitmap=!0}postInit(){super.postInit()}frameStart(){super.frameStart()}frameEnd(){super.frameEnd()}updateBegin(){}updateEnd(){}readPixels(e,t,s,i,n){}createVertexBufferImpl(e,t){return new ro(e,t)}createIndexBufferImpl(e){return new to(e)}createShaderImpl(e){return new io(e)}createTextureImpl(e){return new no(e)}createRenderTargetImpl(e){return new so(e)}draw(e,t=1,s){}setShader(e,t=!1){}setBlendState(e){}setDepthState(e){}setStencilState(e,t){}setBlendColor(e,t,s,i){}setCullMode(e){}setAlphaToCoverage(e){}initializeContextCaches(){super.initializeContextCaches()}clear(e){}setViewport(e,t,s,i){}setScissor(e,t,s,i){}copyRenderTarget(e,t,s,i){return!0}}let oo=0;class lo{constructor(e,t,s,i=0,n,r){this.device=e,this.format=t,this.numIndices=s,this.usage=i,this.id=oo++,this.impl=e.createIndexBufferImpl(this,r);const a=an[t];this.bytesPerIndex=a,this.numBytes=this.numIndices*a,n?this.setData(n):this.storage=new ArrayBuffer(this.numBytes),this.adjustVramSizeTracking(e._vram,this.numBytes),this.device.buffers.push(this)}destroy(){const e=this.device,t=e.buffers.indexOf(this);-1!==t&&e.buffers.splice(t,1),this.device.indexBuffer===this&&(this.device.indexBuffer=null),this.impl.initialized&&(this.impl.destroy(e),this.adjustVramSizeTracking(e._vram,-this.storage.byteLength))}adjustVramSizeTracking(e,t){e.ib+=t}loseContext(){this.impl.loseContext()}getFormat(){return this.format}getNumIndices(){return this.numIndices}lock(){return this.storage}unlock(){this.impl.unlock(this)}setData(e){return e.byteLength===this.numBytes&&(this.storage=e,this.unlock(),!0)}_lockTypedArray(){const e=this.lock();return 2===this.format?new Uint32Array(e):1===this.format?new Uint16Array(e):new Uint8Array(e)}writeData(e,t){const s=this._lockTypedArray();if(e.length>t)if(ArrayBuffer.isView(e))e=e.subarray(0,t),s.set(e);else for(let i=0;i<t;i++)s[i]=e[i];else s.set(e);this.unlock()}readData(e){const t=this._lockTypedArray(),s=this.numIndices;if(ArrayBuffer.isView(e))e.set(t);else{e.length=0;for(let i=0;i<s;i++)e[i]=t[i]}return s}}class ho{constructor(){this.clearValue=new os(0,0,0,1),this.clearValueLinear=new os(0,0,0,1),this.clear=!1,this.store=!1,this.resolve=!0,this.genMipmaps=!1}}class co{constructor(){this.clearDepthValue=1,this.clearStencilValue=0,this.clearDepth=!1,this.clearStencil=!1,this.storeDepth=!1,this.resolveDepth=!1,this.storeStencil=!1}}class uo{get colorOps(){return this.colorArrayOps[0]}constructor(e){this._name=void 0,this.device=void 0,this._enabled=!0,this._skipStart=!1,this._skipEnd=!1,this.executeEnabled=!0,this.renderTarget=void 0,this._options=void 0,this.samples=0,this.colorArrayOps=[],this.depthStencilOps=void 0,this.requiresCubemaps=!0,this.fullSizeClearRect=!0,this.beforePasses=[],this.afterPasses=[],this.device=e}set name(e){this._name=e}get name(){return this._name||(this._name=this.constructor.name),this._name}set options(e){var t,s;(this._options=e,e)&&(this._options.scaleX=null!=(t=this._options.scaleX)?t:1,this._options.scaleY=null!=(s=this._options.scaleY)?s:1)}get options(){return this._options}init(e=null,t){this.options=t,this.renderTarget=e,this.samples=Math.max(this.renderTarget?this.renderTarget.samples:this.device.samples,1),this.allocateAttachments(),this.postInit()}allocateAttachments(){var e,t;const s=this.renderTarget;this.depthStencilOps=new co,null!=s&&s.depthBuffer&&(this.depthStencilOps.storeDepth=!0);const i=s?null!=(e=null==(t=s._colorBuffers)?void 0:t.length)?e:0:1;this.colorArrayOps.length=0;for(let e=0;e<i;e++){var n,r;const t=new ho;this.colorArrayOps[e]=t,1===this.samples&&(t.store=!0,t.resolve=!1);const s=null==(n=this.renderTarget)||null==(n=n._colorBuffers)?void 0:n[e];if(null!=(r=this.renderTarget)&&r.mipmaps&&null!=s&&s.mipmaps){const e=ri(s._format);t.genMipmaps=!e}}}destroy(){}postInit(){}frameUpdate(){if(this._options&&this.renderTarget){var e;const t=null!=(e=this._options.resizeSource)?e:this.device.backBuffer,s=Math.floor(t.width*this._options.scaleX),i=Math.floor(t.height*this._options.scaleY);this.renderTarget.resize(s,i)}}before(){}execute(){}after(){}onEnable(){}onDisable(){}set enabled(e){this._enabled!==e&&(this._enabled=e,e?this.onEnable():this.onDisable())}get enabled(){return this._enabled}setClearColor(e){const t=this.colorArrayOps.length;for(let s=0;s<t;s++){const t=this.colorArrayOps[s];e&&(t.clearValue.copy(e),t.clearValueLinear.linear(e)),t.clear=!!e}}setClearDepth(e){e&&(this.depthStencilOps.clearDepthValue=e),this.depthStencilOps.clearDepth=void 0!==e}setClearStencil(e){e&&(this.depthStencilOps.clearStencilValue=e),this.depthStencilOps.clearStencil=void 0!==e}render(){if(this.enabled){const e=this.device,t=void 0!==this.renderTarget;this.before(),this.executeEnabled&&(t&&!this._skipStart&&e.startRenderPass(this),this.execute(),t&&!this._skipEnd&&e.endRenderPass(this)),this.after(),e.renderPassIndex++}}}function po(e){this.array[this.index]=e}function fo(e,t){this.array[this.index]=e,this.array[this.index+1]=t}function mo(e,t,s){this.array[this.index]=e,this.array[this.index+1]=t,this.array[this.index+2]=s}function go(e,t,s,i){this.array[this.index]=e,this.array[this.index+1]=t,this.array[this.index+2]=s,this.array[this.index+3]=i}function _o(e,t,s){this.array[e]=t[s]}function vo(e,t,s){this.array[e]=t[s],this.array[e+1]=t[s+1]}function bo(e,t,s){this.array[e]=t[s],this.array[e+1]=t[s+1],this.array[e+2]=t[s+2]}function yo(e,t,s){this.array[e]=t[s],this.array[e+1]=t[s+1],this.array[e+2]=t[s+2],this.array[e+3]=t[s+3]}function xo(e,t,s){t[s]=this.array[e]}function wo(e,t,s){t[s]=this.array[e],t[s+1]=this.array[e+1]}function So(e,t,s){t[s]=this.array[e],t[s+1]=this.array[e+1],t[s+2]=this.array[e+2]}function Co(e,t,s){t[s]=this.array[e],t[s+1]=this.array[e+1],t[s+2]=this.array[e+2],t[s+3]=this.array[e+3]}class To{constructor(e,t,s){switch(this.index=0,this.numComponents=t.numComponents,s.interleaved?this.array=new sn[t.dataType](e,t.offset):this.array=new sn[t.dataType](e,t.offset,s.vertexCount*t.numComponents),this.stride=t.stride/this.array.constructor.BYTES_PER_ELEMENT,t.numComponents){case 1:this.set=po,this.getToArray=xo,this.setFromArray=_o;break;case 2:this.set=fo,this.getToArray=wo,this.setFromArray=vo;break;case 3:this.set=mo,this.getToArray=So,this.setFromArray=bo;break;case 4:this.set=go,this.getToArray=Co,this.setFromArray=yo}}get(e){return this.array[this.index+e]}set(e,t,s,i){}getToArray(e,t,s){}setFromArray(e,t,s){}}class Eo{constructor(e){this.vertexBuffer=e,this.vertexFormatSize=e.getFormat().size,this.buffer=this.vertexBuffer.lock(),this.accessors=[],this.element={};const t=this.vertexBuffer.getFormat();for(let e=0;e<t.elements.length;e++){const s=t.elements[e];this.accessors[e]=new To(this.buffer,s,t),this.element[s.name]=this.accessors[e]}}next(e=1){let t=0;const s=this.accessors,i=this.accessors.length;for(;t<i;){const i=s[t++];i.index+=e*i.stride}}end(){this.vertexBuffer.unlock()}writeData(e,t,s){const i=this.element[e];if(i){s>this.vertexBuffer.numVertices&&(s=this.vertexBuffer.numVertices);const e=i.numComponents;if(this.vertexBuffer.getFormat().interleaved){let n=0;for(let r=0;r<s;r++)i.setFromArray(n,t,r*e),n+=i.stride}else if(t.length>s*e){const n=s*e;if(ArrayBuffer.isView(t))t=t.subarray(0,n),i.array.set(t);else for(let e=0;e<n;e++)i.array[e]=t[e]}else i.array.set(t)}}readData(e,t){const s=this.element[e];let i=0;if(s){let e;i=this.vertexBuffer.numVertices;const n=s.numComponents;if(this.vertexBuffer.getFormat().interleaved){Array.isArray(t)&&(t.length=0),s.index=0;let r=0;for(e=0;e<i;e++)s.getToArray(r,t,e*n),r+=s.stride}else if(ArrayBuffer.isView(t))t.set(s.array);else{t.length=0;const r=i*n;for(e=0;e<r;e++)t[e]=s.array[e]}}return i}}const Po="mousedown",ko="mousemove",Ao="mouseup",Mo="mousewheel";const Do=new class{constructor(e,t){this.key=null,this.element=null,this.event=null,t&&(this.key=t.keyCode,this.element=t.target,this.event=t)}};function Ro(e){return Do.key=e.keyCode,Do.element=e.target,Do.event=e,Do}function Lo(e){return"string"==typeof e?e.toUpperCase().charCodeAt(0):e}const Io={9:"Tab",13:"Enter",16:"Shift",17:"Control",18:"Alt",27:"Escape",37:"Left",38:"Up",39:"Right",40:"Down",46:"Delete",91:"Win"};class Fo extends Kt{constructor(e,t={}){super(),this._element=null,this._keymap={},this._lastmap={},this._keyDownHandler=this._handleKeyDown.bind(this),this._keyUpHandler=this._handleKeyUp.bind(this),this._keyPressHandler=this._handleKeyPress.bind(this),this._visibilityChangeHandler=this._handleVisibilityChange.bind(this),this._windowBlurHandler=this._handleWindowBlur.bind(this),e&&this.attach(e),this.preventDefault=t.preventDefault||!1,this.stopPropagation=t.stopPropagation||!1}attach(e){this._element&&this.detach(),this._element=e,this._element.addEventListener("keydown",this._keyDownHandler,!1),this._element.addEventListener("keypress",this._keyPressHandler,!1),this._element.addEventListener("keyup",this._keyUpHandler,!1),document.addEventListener("visibilitychange",this._visibilityChangeHandler,!1),window.addEventListener("blur",this._windowBlurHandler,!1)}detach(){this._element&&(this._element.removeEventListener("keydown",this._keyDownHandler),this._element.removeEventListener("keypress",this._keyPressHandler),this._element.removeEventListener("keyup",this._keyUpHandler),this._element=null,document.removeEventListener("visibilitychange",this._visibilityChangeHandler,!1),window.removeEventListener("blur",this._windowBlurHandler,!1))}toKeyIdentifier(e){e=Lo(e);const t=Io[e.toString()];if(t)return t;let s=e.toString(16).toUpperCase();const i=s.length;for(let e=0;e<4-i;e++)s=`0${s}`;return`U+${s}`}_handleKeyDown(e){const t=e.keyCode||e.charCode;if(void 0===t)return;const s=this.toKeyIdentifier(t);this._keymap[s]=!0,this.fire("keydown",Ro(e)),this.preventDefault&&e.preventDefault(),this.stopPropagation&&e.stopPropagation()}_handleKeyUp(e){const t=e.keyCode||e.charCode;if(void 0===t)return;const s=this.toKeyIdentifier(t);delete this._keymap[s],this.fire("keyup",Ro(e)),this.preventDefault&&e.preventDefault(),this.stopPropagation&&e.stopPropagation()}_handleKeyPress(e){this.fire("keypress",Ro(e)),this.preventDefault&&e.preventDefault(),this.stopPropagation&&e.stopPropagation()}_handleVisibilityChange(){"hidden"===document.visibilityState&&this._handleWindowBlur()}_handleWindowBlur(){this._keymap={},this._lastmap={}}update(){for(const e in this._lastmap)delete this._lastmap[e];for(const e in this._keymap)this._keymap.hasOwnProperty(e)&&(this._lastmap[e]=this._keymap[e])}isPressed(e){const t=Lo(e),s=this.toKeyIdentifier(t);return!!this._keymap[s]}wasPressed(e){const t=Lo(e),s=this.toKeyIdentifier(t);return!!this._keymap[s]&&!this._lastmap[s]}wasReleased(e){const t=Lo(e),s=this.toKeyIdentifier(t);return!this._keymap[s]&&!!this._lastmap[s]}}function Oo(){return!!(document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement)}Fo.EVENT_KEYDOWN="keydown",Fo.EVENT_KEYUP="keyup";class Bo{constructor(e,t){var s,i,n,r;this.x=0,this.y=0,this.dx=0,this.dy=0,this.button=-1,this.wheelDelta=0,this.element=void 0,this.ctrlKey=!1,this.altKey=!1,this.shiftKey=!1,this.metaKey=!1,this.event=void 0;let a={x:0,y:0};if(t){if(t instanceof Bo)throw Error("Expected MouseEvent");a=e._getTargetCoords(t)}else t={};if(a)this.x=a.x,this.y=a.y;else{if(!Oo())return;this.x=0,this.y=0}"wheel"===t.type&&(t.deltaY>0?this.wheelDelta=1:t.deltaY<0&&(this.wheelDelta=-1)),Oo()?(this.dx=t.movementX||t.webkitMovementX||t.mozMovementX||0,this.dy=t.movementY||t.webkitMovementY||t.mozMovementY||0):(this.dx=this.x-e._lastX,this.dy=this.y-e._lastY),"mousedown"!==t.type&&"mouseup"!==t.type||(this.button=t.button),this.buttons=e._buttons.slice(0),this.element=t.target,this.ctrlKey=null!=(s=t.ctrlKey)&&s,this.altKey=null!=(i=t.altKey)&&i,this.shiftKey=null!=(n=t.shiftKey)&&n,this.metaKey=null!=(r=t.metaKey)&&r,this.event=t}}class zo extends Kt{constructor(e){super(),this._lastX=0,this._lastY=0,this._buttons=[!1,!1,!1],this._lastbuttons=[!1,!1,!1],this._target=null,this._attached=!1,this._upHandler=this._handleUp.bind(this),this._downHandler=this._handleDown.bind(this),this._moveHandler=this._handleMove.bind(this),this._wheelHandler=this._handleWheel.bind(this),this._contextMenuHandler=e=>{e.preventDefault()},this.attach(e)}static isPointerLocked(){return Oo()}attach(e){if(this._target=e,this._attached)return;this._attached=!0;const t=!!qt.passiveEvents&&{passive:!1};window.addEventListener("mouseup",this._upHandler,t),window.addEventListener("mousedown",this._downHandler,t),window.addEventListener("mousemove",this._moveHandler,t),window.addEventListener("wheel",this._wheelHandler,t)}detach(){if(!this._attached)return;this._attached=!1,this._target=null;const e=!!qt.passiveEvents&&{passive:!1};window.removeEventListener("mouseup",this._upHandler,e),window.removeEventListener("mousedown",this._downHandler,e),window.removeEventListener("mousemove",this._moveHandler,e),window.removeEventListener("wheel",this._wheelHandler,e)}disableContextMenu(){this._target&&this._target.addEventListener("contextmenu",this._contextMenuHandler)}enableContextMenu(){this._target&&this._target.removeEventListener("contextmenu",this._contextMenuHandler)}enablePointerLock(e,t){if(!document.body.requestPointerLock)return void(t&&t());const s=()=>{e(),document.removeEventListener("pointerlockchange",s)},i=()=>{t(),document.removeEventListener("pointerlockerror",i)};e&&document.addEventListener("pointerlockchange",s,!1),t&&document.addEventListener("pointerlockerror",i,!1),document.body.requestPointerLock()}disablePointerLock(e){if(!document.exitPointerLock)return;const t=()=>{e(),document.removeEventListener("pointerlockchange",t)};e&&document.addEventListener("pointerlockchange",t,!1),document.exitPointerLock()}update(){this._lastbuttons[0]=this._buttons[0],this._lastbuttons[1]=this._buttons[1],this._lastbuttons[2]=this._buttons[2]}isPressed(e){return this._buttons[e]}wasPressed(e){return this._buttons[e]&&!this._lastbuttons[e]}wasReleased(e){return!this._buttons[e]&&this._lastbuttons[e]}_handleUp(e){this._buttons[e.button]=!1;const t=new Bo(this,e);t.event&&this.fire(Ao,t)}_handleDown(e){this._buttons[e.button]=!0;const t=new Bo(this,e);t.event&&this.fire(Po,t)}_handleMove(e){const t=new Bo(this,e);t.event&&(this.fire(ko,t),this._lastX=t.x,this._lastY=t.y)}_handleWheel(e){const t=new Bo(this,e);t.event&&this.fire(Mo,t)}_getTargetCoords(e){const t=this._target.getBoundingClientRect(),s=Math.floor(t.left),i=Math.floor(t.top);return e.clientX<s||e.clientX>=s+this._target.clientWidth||e.clientY<i||e.clientY>=i+this._target.clientHeight?null:{x:e.clientX-s,y:e.clientY-i}}}zo.EVENT_MOUSEMOVE=ko,zo.EVENT_MOUSEDOWN=Po,zo.EVENT_MOUSEUP=Ao,zo.EVENT_MOUSEWHEEL=Mo;class No{constructor(e){this.id=void 0,this.x=void 0,this.y=void 0,this.target=void 0,this.touch=void 0;const t=function(e){let t=0,s=0,i=e.target;for(;!(i instanceof HTMLElement)&&i;)i=i.parentNode;for(;i;)t+=i.offsetLeft-i.scrollLeft,s+=i.offsetTop-i.scrollTop,i=i.offsetParent;return{x:e.pageX-t,y:e.pageY-s}}(e);this.id=e.identifier,this.x=t.x,this.y=t.y,this.target=e.target,this.touch=e}}class Uo{constructor(e,t){this.element=void 0,this.event=void 0,this.touches=[],this.changedTouches=[],this.element=t.target,this.event=t,this.touches=Array.from(t.touches).map((e=>new No(e))),this.changedTouches=Array.from(t.changedTouches).map((e=>new No(e)))}getTouchById(e,t){return t.find((t=>t.id===e))||null}}class Vo extends Kt{constructor(e){super(),this._element=null,this._startHandler=this._handleTouchStart.bind(this),this._endHandler=this._handleTouchEnd.bind(this),this._moveHandler=this._handleTouchMove.bind(this),this._cancelHandler=this._handleTouchCancel.bind(this),this.attach(e)}attach(e){this._element&&this.detach(),this._element=e,this._element.addEventListener("touchstart",this._startHandler,!1),this._element.addEventListener("touchend",this._endHandler,!1),this._element.addEventListener("touchmove",this._moveHandler,!1),this._element.addEventListener("touchcancel",this._cancelHandler,!1)}detach(){this._element&&(this._element.removeEventListener("touchstart",this._startHandler,!1),this._element.removeEventListener("touchend",this._endHandler,!1),this._element.removeEventListener("touchmove",this._moveHandler,!1),this._element.removeEventListener("touchcancel",this._cancelHandler,!1)),this._element=null}_handleTouchStart(e){this.fire("touchstart",new Uo(this,e))}_handleTouchEnd(e){this.fire("touchend",new Uo(this,e))}_handleTouchMove(e){e.preventDefault(),this.fire("touchmove",new Uo(this,e))}_handleTouchCancel(e){this.fire("touchcancel",new Uo(this,e))}}class Go{get(e,t,s){return"function"==typeof t&&(s=t,t={}),this.request("GET",e,t,s)}post(e,t,s,i){return"function"==typeof s&&(i=s,s={}),s.postdata=t,this.request("POST",e,s,i)}put(e,t,s,i){return"function"==typeof s&&(i=s,s={}),s.postdata=t,this.request("PUT",e,s,i)}del(e,t,s){return"function"==typeof t&&(s=t,t={}),this.request("DELETE",e,t,s)}request(e,t,s,i){let n,r,a,o=!1;if("function"==typeof s&&(i=s,s={}),s.retry&&(s=Object.assign({retries:0,maxRetries:5},s)),s.callback=i,null==s.async&&(s.async=!0),null==s.headers&&(s.headers={}),null!=s.postdata)if(s.postdata instanceof Document)a=s.postdata;else if(s.postdata instanceof FormData)a=s.postdata;else if(s.postdata instanceof Object){let e=s.headers["Content-Type"];switch(void 0===e&&(s.headers["Content-Type"]=Go.ContentType.FORM_URLENCODED,e=s.headers["Content-Type"]),e){case Go.ContentType.FORM_URLENCODED:{a="";let e=!0;for(const t in s.postdata)if(s.postdata.hasOwnProperty(t)){e?e=!1:a+="&";a+=`${encodeURIComponent(t)}=${encodeURIComponent(s.postdata[t])}`}break}default:case Go.ContentType.JSON:null==e&&(s.headers["Content-Type"]=Go.ContentType.JSON),a=JSON.stringify(s.postdata)}}else a=s.postdata;if(!1===s.cache){const e=ts();n=new is(t),n.query?n.query=`${n.query}&ts=${e}`:n.query=`ts=${e}`,t=n.toString()}s.query&&(n=new is(t),r=Rt(n.getQuery(),s.query),n.setQuery(r),t=n.toString());const l=new XMLHttpRequest;l.open(e,t,s.async),l.withCredentials=void 0!==s.withCredentials&&s.withCredentials,l.responseType=s.responseType||this._guessResponseType(t);for(const e in s.headers)s.headers.hasOwnProperty(e)&&l.setRequestHeader(e,s.headers[e]);l.onreadystatechange=()=>{this._onReadyStateChange(e,t,s,l)},l.onerror=()=>{this._onError(e,t,s,l),o=!0};try{l.send(a)}catch(e){o||s.error(l.status,l,e)}return l}_guessResponseType(e){const t=new is(e),s=It.getExtension(t.path).toLowerCase();return Go.binaryExtensions.indexOf(s)>=0?Go.ResponseType.ARRAY_BUFFER:".json"===s?Go.ResponseType.JSON:".xml"===s?Go.ResponseType.DOCUMENT:Go.ResponseType.TEXT}_isBinaryContentType(e){return[Go.ContentType.BASIS,Go.ContentType.BIN,Go.ContentType.DDS,Go.ContentType.GLB,Go.ContentType.MP3,Go.ContentType.MP4,Go.ContentType.OGG,Go.ContentType.OPUS,Go.ContentType.WAV].indexOf(e)>=0}_isBinaryResponseType(e){return e===Go.ResponseType.ARRAY_BUFFER||e===Go.ResponseType.BLOB||e===Go.ResponseType.JSON}_onReadyStateChange(e,t,s,i){if(4===i.readyState)switch(i.status){case 0:i.responseURL&&i.responseURL.startsWith("file:///")?this._onSuccess(e,t,s,i):this._onError(e,t,s,i);break;case 200:case 201:case 206:case 304:this._onSuccess(e,t,s,i);break;default:this._onError(e,t,s,i)}}_onSuccess(e,t,s,i){let n,r;const a=i.getResponseHeader("Content-Type");if(a){r=a.split(";")[0].trim()}try{n=this._isBinaryContentType(r)||this._isBinaryResponseType(i.responseType)?i.response:r===Go.ContentType.JSON||t.split("?")[0].endsWith(".json")?JSON.parse(i.responseText):i.responseType===Go.ResponseType.DOCUMENT||r===Go.ContentType.XML?i.responseXML:i.responseText,s.callback(null,n)}catch(e){s.callback(e)}}_onError(e,t,s,i){if(!s.retrying)if(s.retry&&s.retries<s.maxRetries){s.retries++,s.retrying=!0;const n=rs.clamp(Math.pow(2,s.retries)*Go.retryDelay,0,s.maxRetryDelay||5e3);console.log(`${e}: ${t} - Error ${i.status}. Retrying in ${n} ms`),setTimeout((()=>{s.retrying=!1,this.request(e,t,s,s.callback)}),n)}else s.callback(0===i.status?"Network error":i.status,null)}}Go.ContentType={AAC:"audio/aac",BASIS:"image/basis",BIN:"application/octet-stream",DDS:"image/dds",FORM_URLENCODED:"application/x-www-form-urlencoded",GIF:"image/gif",GLB:"model/gltf-binary",JPEG:"image/jpeg",JSON:"application/json",MP3:"audio/mpeg",MP4:"audio/mp4",OGG:"audio/ogg",OPUS:'audio/ogg; codecs="opus"',PNG:"image/png",TEXT:"text/plain",WAV:"audio/x-wav",XML:"application/xml"},Go.ResponseType={TEXT:"text",ARRAY_BUFFER:"arraybuffer",BLOB:"blob",DOCUMENT:"document",JSON:"json"},Go.binaryExtensions=[".model",".wav",".ogg",".mp3",".mp4",".m4a",".aac",".dds",".basis",".glb",".opus"],Go.retryDelay=100;const Ho=new Go,jo="none",Wo=new Map([[5,{name:"PCF1_32F",format:Xs,pcf:!0}],[0,{name:"PCF3_32F",format:Xs,pcf:!0}],[4,{name:"PCF5_32F",format:Xs,pcf:!0}],[7,{name:"PCF1_16F",format:ti,pcf:!0}],[8,{name:"PCF3_16F",format:ti,pcf:!0}],[9,{name:"PCF5_16F",format:ti,pcf:!0}],[2,{name:"VSM_16F",format:Ws,vsm:!0}],[3,{name:"VSM_32F",format:$s,vsm:!0}],[6,{name:"PCSS_32F",format:qs}]]),$o=0,qo=1,Xo=["LINEAR","FILMIC","HEJL","ACES","ACES2","NEUTRAL","NONE"],Ko=256,Yo=1024,Qo=2048,Jo=4096,Zo=8192,el=16384,tl="infinite",sl="dome",il="none",nl="bayer8",rl="prerender",al="postrender";class ol{constructor(e,t,s){this.uniformFormats=[],this.bindGroupFormats=[],this.vertexFormat=void 0,this.uniformFormats[0]=e,this.bindGroupFormats[0]=t,this.vertexFormat=s}hasUniform(e){for(let t=0;t<this.uniformFormats.length;t++){const s=this.uniformFormats[t];if(null!=s&&s.get(e))return!0}return!1}hasTexture(e){for(let t=0;t<this.bindGroupFormats.length;t++){const s=this.bindGroupFormats[t];if(null!=s&&s.getTexture(e))return!0}return!1}getVertexElement(e){var t;return null==(t=this.vertexFormat)?void 0:t.elements.find((t=>t.name===e))}generateKey(e){let t=JSON.stringify(this.uniformFormats)+JSON.stringify(this.bindGroupFormats);var s;e.isWebGPU&&(t+=null==(s=this.vertexFormat)?void 0:s.shaderProcessingHashString);return t}}var ll="\nvec3 decodeLinear(vec4 raw) {\n\treturn raw.rgb;\n}\nfloat decodeGamma(float raw) {\n\treturn pow(raw, 2.2);\n}\nvec3 decodeGamma(vec3 raw) {\n\treturn pow(raw, vec3(2.2));\n}\nvec3 decodeGamma(vec4 raw) {\n\treturn pow(raw.xyz, vec3(2.2));\n}\nvec3 decodeRGBM(vec4 raw) {\n\tvec3 color = (8.0 * raw.a) * raw.rgb;\n\treturn color * color;\n}\nvec3 decodeRGBP(vec4 raw) {\n\tvec3 color = raw.rgb * (-raw.a * 7.0 + 8.0);\n\treturn color * color;\n}\nvec3 decodeRGBE(vec4 raw) {\n\tif (raw.a == 0.0) {\n\t\treturn vec3(0.0, 0.0, 0.0);\n\t} else {\n\t\treturn raw.xyz * pow(2.0, raw.w * 255.0 - 128.0);\n\t}\n}\nvec4 passThrough(vec4 raw) {\n\treturn raw;\n}\n",hl="\nvec4 encodeLinear(vec3 source) {\n\treturn vec4(source, 1.0);\n}\nvec4 encodeGamma(vec3 source) {\n\treturn vec4(pow(source + 0.0000001, vec3(1.0 / 2.2)), 1.0);\n}\nvec4 encodeRGBM(vec3 source) {\n\tvec4 result;\n\tresult.rgb = pow(source.rgb, vec3(0.5));\n\tresult.rgb *= 1.0 / 8.0;\n\tresult.a = saturate( max( max( result.r, result.g ), max( result.b, 1.0 / 255.0 ) ) );\n\tresult.a = ceil(result.a * 255.0) / 255.0;\n\tresult.rgb /= result.a;\n\treturn result;\n}\nvec4 encodeRGBP(vec3 source) {\n\tvec3 gamma = pow(source, vec3(0.5));\n\tfloat maxVal = min(8.0, max(1.0, max(gamma.x, max(gamma.y, gamma.z))));\n\tfloat v = 1.0 - ((maxVal - 1.0) / 7.0);\n\tv = ceil(v * 255.0) / 255.0;\n\treturn vec4(gamma / (-v * 7.0 + 8.0), v);\t\n}\nvec4 encodeRGBE(vec3 source) {\n\tfloat maxVal = max(source.x, max(source.y, source.z));\n\tif (maxVal < 1e-32) {\n\t\treturn vec4(0, 0, 0, 0);\n\t} else {\n\t\tfloat e = ceil(log2(maxVal));\n\t\treturn vec4(source / pow(2.0, e), (e + 128.0) / 255.0);\n\t}\n}\n";const cl={alphaTestPS:"\nuniform float alpha_ref;\nvoid alphaTest(float a) {\n\tif (a < alpha_ref) discard;\n}\n",ambientConstantPS:"\nvoid addAmbient(vec3 worldNormal) {\n\tdDiffuseLight += light_globalAmbient;\n}\n",ambientEnvPS:"\n#ifndef ENV_ATLAS\n#define ENV_ATLAS\nuniform sampler2D texture_envAtlas;\n#endif\nvoid addAmbient(vec3 worldNormal) {\n\tvec3 dir = normalize(cubeMapRotate(worldNormal) * vec3(-1.0, 1.0, 1.0));\n\tvec2 uv = mapUv(toSphericalUv(dir), vec4(128.0, 256.0 + 128.0, 64.0, 32.0) / atlasSize);\n\tvec4 raw = texture2D(texture_envAtlas, uv);\n\tvec3 linear = $DECODE(raw);\n\tdDiffuseLight += processEnvironment(linear);\n}\n",ambientSHPS:"\nuniform vec3 ambientSH[9];\nvoid addAmbient(vec3 worldNormal) {\n\tvec3 n = cubeMapRotate(worldNormal);\n\tvec3 color =\n\t\tambientSH[0] +\n\t\tambientSH[1] * n.x +\n\t\tambientSH[2] * n.y +\n\t\tambientSH[3] * n.z +\n\t\tambientSH[4] * n.x * n.z +\n\t\tambientSH[5] * n.z * n.y +\n\t\tambientSH[6] * n.y * n.x +\n\t\tambientSH[7] * (3.0 * n.z * n.z - 1.0) +\n\t\tambientSH[8] * (n.x * n.x - n.y * n.y);\n\tdDiffuseLight += processEnvironment(max(color, vec3(0.0)));\n}\n",aoPS:"\n#ifdef MAPTEXTURE\n\t#define AO_INTENSITY\n#endif\n#ifdef MAPVERTEX\n\t#define AO_INTENSITY\n#endif\n#ifdef AO_INTENSITY\n\tuniform float material_aoIntensity;\n#endif\nvoid getAO() {\n\tdAo = 1.0;\n\t#ifdef MAPTEXTURE\n\t\tfloat aoBase = texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\t\tdAo *= addAoDetail(aoBase);\n\t#endif\n\t#ifdef MAPVERTEX\n\t\tdAo *= saturate(vVertexColor.$VC);\n\t#endif\n\t#ifdef AO_INTENSITY\n\t\tdAo = mix(1.0, dAo, material_aoIntensity);\n\t#endif\n}\n",aoDetailMapPS:"\nfloat addAoDetail(float ao) {\n#ifdef MAPTEXTURE\n\tfloat aoDetail = texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\treturn detailMode_$DETAILMODE(vec3(ao), vec3(aoDetail)).r;\n#else\n\treturn ao;\n#endif\n}\n",aoDiffuseOccPS:"\nvoid occludeDiffuse(float ao) {\n\tdDiffuseLight *= ao;\n}\n",aoSpecOccPS:"\nuniform float material_occludeSpecularIntensity;\nvoid occludeSpecular(float gloss, float ao, vec3 worldNormal, vec3 viewDir) {\n\tfloat specPow = exp2(gloss * 11.0);\n\tfloat specOcc = saturate(pow(dot(worldNormal, viewDir) + ao, 0.01*specPow) - 1.0 + ao);\n\tspecOcc = mix(1.0, specOcc, material_occludeSpecularIntensity);\n\tdSpecularLight *= specOcc;\n\tdReflection *= specOcc;\n\t\n#ifdef LIT_SHEEN\n\tsSpecularLight *= specOcc;\n\tsReflection *= specOcc;\n#endif\n}\n",aoSpecOccConstPS:"\nvoid occludeSpecular(float gloss, float ao, vec3 worldNormal, vec3 viewDir) {\n\tfloat specPow = exp2(gloss * 11.0);\n\tfloat specOcc = saturate(pow(dot(worldNormal, viewDir) + ao, 0.01*specPow) - 1.0 + ao);\n\tdSpecularLight *= specOcc;\n\tdReflection *= specOcc;\n\t\n#ifdef LIT_SHEEN\n\tsSpecularLight *= specOcc;\n\tsReflection *= specOcc;\n#endif\n}\n",aoSpecOccConstSimplePS:"\nvoid occludeSpecular(float gloss, float ao, vec3 worldNormal, vec3 viewDir) {\n\tdSpecularLight *= ao;\n\tdReflection *= ao;\n#ifdef LIT_SHEEN\n\tsSpecularLight *= ao;\n\tsReflection *= ao;\n#endif\n}\n",aoSpecOccSimplePS:"\nuniform float material_occludeSpecularIntensity;\nvoid occludeSpecular(float gloss, float ao, vec3 worldNormal, vec3 viewDir) {\n\tfloat specOcc = mix(1.0, ao, material_occludeSpecularIntensity);\n\tdSpecularLight *= specOcc;\n\tdReflection *= specOcc;\n#ifdef LIT_SHEEN\n\tsSpecularLight *= specOcc;\n\tsReflection *= specOcc;\n#endif\n}\n",basePS:"\nuniform vec3 view_position;\nuniform vec3 light_globalAmbient;\nfloat square(float x) {\n\treturn x*x;\n}\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec3 saturate(vec3 x) {\n\treturn clamp(x, vec3(0.0), vec3(1.0));\n}\n",baseVS:'\nattribute vec4 vertex_tangent;\nattribute vec2 vertex_texCoord0;\nattribute vec2 vertex_texCoord1;\nattribute vec4 vertex_color;\nvec3 dPositionW;\nmat4 dModelMatrix;\n#include "transformCore"\n',baseNineSlicedPS:"\n#define NINESLICED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\nvec2 nineSlicedUv;\n",baseNineSlicedVS:"\n#define NINESLICED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\n",baseNineSlicedTiledPS:"\n#define NINESLICED\n#define NINESLICETILED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\nvec2 nineSlicedUv;\n",bayerPS:"\nfloat bayer2(vec2 p) {\n\treturn mod(2.0 * p.y + p.x + 1.0, 4.0);\n}\nfloat bayer4(vec2 p) {\n\tvec2 p1 = mod(p, 2.0);\n\tvec2 p2 = floor(0.5 * mod(p, 4.0));\n\treturn 4.0 * bayer2(p1) + bayer2(p2);\n}\nfloat bayer8(vec2 p) {\n\tvec2 p1 = mod(p, 2.0);\n\tvec2 p2 = floor(0.5 * mod(p, 4.0));\n\tvec2 p4 = floor(0.25 * mod(p, 8.0));\n\treturn 4.0 * (4.0 * bayer2(p1) + bayer2(p2)) + bayer2(p4);\n}\n",blurVSMPS:"\nvarying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\n#ifdef GAUSS\nuniform float weight[SAMPLES];\n#endif\nvoid main(void) {\n\tvec3 moments = vec3(0.0);\n\tvec2 uv = vUv0 - pixelOffset * (float(SAMPLES) * 0.5);\n\tfor (int i=0; i<SAMPLES; i++) {\n\t\tvec4 c = texture2D(source, uv + pixelOffset * float(i));\n\t\t#ifdef GAUSS\n\t\tmoments += c.xyz * weight[i];\n\t\t#else\n\t\tmoments += c.xyz;\n\t\t#endif\n\t}\n\t#ifndef GAUSS\n\tmoments /= float(SAMPLES);\n\t#endif\n\tgl_FragColor = vec4(moments.x, moments.y, moments.z, 1.0);\n}\n",clearCoatPS:"\n#ifdef MAPFLOAT\nuniform float material_clearCoat;\n#endif\nvoid getClearCoat() {\n\tccSpecularity = 1.0;\n\t#ifdef MAPFLOAT\n\tccSpecularity *= material_clearCoat;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tccSpecularity *= texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tccSpecularity *= saturate(vVertexColor.$VC);\n\t#endif\n}\n",clearCoatGlossPS:"\n#ifdef MAPFLOAT\nuniform float material_clearCoatGloss;\n#endif\nvoid getClearCoatGlossiness() {\n\tccGlossiness = 1.0;\n\t#ifdef MAPFLOAT\n\tccGlossiness *= material_clearCoatGloss;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tccGlossiness *= texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tccGlossiness *= saturate(vVertexColor.$VC);\n\t#endif\n\t#ifdef MAPINVERT\n\tccGlossiness = 1.0 - ccGlossiness;\n\t#endif\n\tccGlossiness += 0.0000001;\n}\n",clearCoatNormalPS:"\n#ifdef MAPTEXTURE\nuniform float material_clearCoatBumpiness;\n#endif\nvoid getClearCoatNormal() {\n#ifdef MAPTEXTURE\n\tvec3 normalMap = unpackNormal(texture2DBias($SAMPLER, $UV, textureBias));\n\tnormalMap = mix(vec3(0.0, 0.0, 1.0), normalMap, material_clearCoatBumpiness);\n\tccNormalW = normalize(dTBN * normalMap);\n#else\n\tccNormalW = dVertexNormalW;\n#endif\n}\n",clusteredLightCookiesPS:"\nvec3 _getCookieClustered(TEXTURE_ACCEPT(tex), vec2 uv, float intensity, bool isRgb, vec4 cookieChannel) {\n\tvec4 pixel = mix(vec4(1.0), texture2DLodEXT(tex, uv, 0.0), intensity);\n\treturn isRgb == true ? pixel.rgb : vec3(dot(pixel, cookieChannel));\n}\nvec3 getCookie2DClustered(TEXTURE_ACCEPT(tex), mat4 transform, vec3 worldPosition, float intensity, bool isRgb, vec4 cookieChannel) {\n\tvec4 projPos = transform * vec4(worldPosition, 1.0);\n\treturn _getCookieClustered(TEXTURE_PASS(tex), projPos.xy / projPos.w, intensity, isRgb, cookieChannel);\n}\nvec3 getCookieCubeClustered(TEXTURE_ACCEPT(tex), vec3 dir, float intensity, bool isRgb, vec4 cookieChannel, float shadowTextureResolution, float shadowEdgePixels, vec3 omniAtlasViewport) {\n\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);\n\treturn _getCookieClustered(TEXTURE_PASS(tex), uv, intensity, isRgb, cookieChannel);\n}\n",clusteredLightShadowsPS:"\nvoid _getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {\n\tvec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n\tprojPos.xyz /= projPos.w;\n\tdShadowCoord = projPos.xyz;\n}\nvoid getShadowCoordPerspZbufferNormalOffset(mat4 shadowMatrix, vec4 shadowParams, vec3 normal) {\n\tvec3 wPos = vPositionW + normal * shadowParams.y;\n\t_getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, wPos);\n}\nvec3 normalOffsetPointShadow(vec4 shadowParams, vec3 lightPos, inout vec3 lightDir, vec3 lightDirNorm, vec3 normal) {\n\tfloat distScale = length(lightDir);\n\tvec3 wPos = vPositionW + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;\n\tvec3 dir = wPos - lightPos;\n\treturn dir;\n}\n#if defined(CLUSTER_SHADOW_TYPE_PCF1)\nfloat getShadowOmniClusteredPCF1(SHADOWMAP_ACCEPT(shadowMap), vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {\n\tfloat shadowTextureResolution = shadowParams.x;\n\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);\n\tfloat shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;\n\treturn textureShadow(shadowMap, vec3(uv, shadowZ));\n}\n#endif\n#if defined(CLUSTER_SHADOW_TYPE_PCF3)\nfloat getShadowOmniClusteredPCF3(SHADOWMAP_ACCEPT(shadowMap), vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {\n\tfloat shadowTextureResolution = shadowParams.x;\n\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);\n\tfloat shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;\n\tvec3 shadowCoord = vec3(uv, shadowZ);\n\treturn getShadowPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);\n}\n#endif\n#if defined(CLUSTER_SHADOW_TYPE_PCF5)\nfloat getShadowOmniClusteredPCF5(SHADOWMAP_ACCEPT(shadowMap), vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {\n\tfloat shadowTextureResolution = shadowParams.x;\n\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);\n\tfloat shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;\n\tvec3 shadowCoord = vec3(uv, shadowZ);\n\treturn getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);\n}\n#endif\n#if defined(CLUSTER_SHADOW_TYPE_PCF1)\nfloat getShadowSpotClusteredPCF1(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn textureShadow(shadowMap, shadowCoord);\n}\n#endif\n#if defined(CLUSTER_SHADOW_TYPE_PCF3)\nfloat getShadowSpotClusteredPCF3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn getShadowSpotPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);\n}\n#endif\n#if defined(CLUSTER_SHADOW_TYPE_PCF5)\nfloat getShadowSpotClusteredPCF5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);\n}\n#endif\n",clusteredLightUtilsPS:"\nvec2 getCubemapFaceCoordinates(const vec3 dir, out float faceIndex, out vec2 tileOffset)\n{\n\tvec3 vAbs = abs(dir);\n\tfloat ma;\n\tvec2 uv;\n\tif (vAbs.z >= vAbs.x && vAbs.z >= vAbs.y) {\n\t\tfaceIndex = dir.z < 0.0 ? 5.0 : 4.0;\n\t\tma = 0.5 / vAbs.z;\n\t\tuv = vec2(dir.z < 0.0 ? -dir.x : dir.x, -dir.y);\n\t\ttileOffset.x = 2.0;\n\t\ttileOffset.y = dir.z < 0.0 ? 1.0 : 0.0;\n\t} else if(vAbs.y >= vAbs.x) {\n\t\tfaceIndex = dir.y < 0.0 ? 3.0 : 2.0;\n\t\tma = 0.5 / vAbs.y;\n\t\tuv = vec2(dir.x, dir.y < 0.0 ? -dir.z : dir.z);\n\t\ttileOffset.x = 1.0;\n\t\ttileOffset.y = dir.y < 0.0 ? 1.0 : 0.0;\n\t} else {\n\t\tfaceIndex = dir.x < 0.0 ? 1.0 : 0.0;\n\t\tma = 0.5 / vAbs.x;\n\t\tuv = vec2(dir.x < 0.0 ? dir.z : -dir.z, -dir.y);\n\t\ttileOffset.x = 0.0;\n\t\ttileOffset.y = dir.x < 0.0 ? 1.0 : 0.0;\n\t}\n\treturn uv * ma + 0.5;\n}\nvec2 getCubemapAtlasCoordinates(const vec3 omniAtlasViewport, float shadowEdgePixels, float shadowTextureResolution, const vec3 dir) {\n\tfloat faceIndex;\n\tvec2 tileOffset;\n\tvec2 uv = getCubemapFaceCoordinates(dir, faceIndex, tileOffset);\n\tfloat atlasFaceSize = omniAtlasViewport.z;\n\tfloat tileSize = shadowTextureResolution * atlasFaceSize;\n\tfloat offset = shadowEdgePixels / tileSize;\n\tuv = uv * vec2(1.0 - offset * 2.0) + vec2(offset * 1.0);\n\tuv *= atlasFaceSize;\n\tuv += tileOffset * atlasFaceSize;\n\tuv += omniAtlasViewport.xy;\n\treturn uv;\n}\n",clusteredLightPS:"\nuniform highp sampler2D clusterWorldTexture;\nuniform highp sampler2D lightsTexture8;\nuniform highp sampler2D lightsTextureFloat;\n#if defined(CLUSTER_COOKIES)\n\t#define CLUSTER_COOKIES_OR_SHADOWS\n#endif\n#if defined(CLUSTER_SHADOWS)\n\t#define CLUSTER_COOKIES_OR_SHADOWS\n#endif\n#ifdef CLUSTER_SHADOWS\n\tuniform sampler2DShadow shadowAtlasTexture;\n#endif\n#ifdef CLUSTER_COOKIES\n\tuniform sampler2D cookieAtlasTexture;\n#endif\nuniform int clusterMaxCells;\nuniform float clusterSkip;\nuniform vec3 clusterCellsCountByBoundsSize;\nuniform vec3 clusterTextureSize;\nuniform vec3 clusterBoundsMin;\nuniform vec3 clusterBoundsDelta;\nuniform vec3 clusterCellsDot;\nuniform vec3 clusterCellsMax;\nuniform vec2 clusterCompressionLimit0;\nuniform vec2 shadowAtlasParams;\nstruct ClusterLightData {\n\tvec3 halfWidth;\n\tfloat lightType;\n\tvec3 halfHeight;\n\tint lightIndex;\n\tvec3 position;\n\tfloat shape;\n\tvec3 direction;\n\tfloat falloffMode;\n\tvec3 color;\n\tfloat shadowIntensity;\n\tvec3 omniAtlasViewport;\n\tfloat range;\n\tvec4 cookieChannelMask;\n\tfloat shadowBias;\n\tfloat shadowNormalBias;\n\tfloat innerConeAngleCos;\n\tfloat outerConeAngleCos;\n\tfloat cookie;\n\tfloat cookieRgb;\n\tfloat cookieIntensity;\n\tfloat mask;\n};\nmat4 lightProjectionMatrix;\n#define isClusteredLightCastShadow(light) ( light.shadowIntensity > 0.0 )\n#define isClusteredLightCookie(light) (light.cookie > 0.5 )\n#define isClusteredLightCookieRgb(light) (light.cookieRgb > 0.5 )\n#define isClusteredLightSpot(light) ( light.lightType > 0.5 )\n#define isClusteredLightFalloffLinear(light) ( light.falloffMode < 0.5 )\n#define isClusteredLightArea(light) ( light.shape > 0.1 )\n#define isClusteredLightRect(light) ( light.shape < 0.3 )\n#define isClusteredLightDisk(light) ( light.shape < 0.6 )\n#ifdef CLUSTER_MESH_DYNAMIC_LIGHTS\n\t#define acceptLightMask(light) ( light.mask < 0.75)\n#else\n\t#define acceptLightMask(light) ( light.mask > 0.25)\n#endif\nvec4 decodeClusterLowRange4Vec4(vec4 d0, vec4 d1, vec4 d2, vec4 d3) {\n\treturn vec4(\n\t\tbytes2floatRange4(d0, -2.0, 2.0),\n\t\tbytes2floatRange4(d1, -2.0, 2.0),\n\t\tbytes2floatRange4(d2, -2.0, 2.0),\n\t\tbytes2floatRange4(d3, -2.0, 2.0)\n\t);\n}\nvec4 sampleLightsTexture8(const ClusterLightData clusterLightData, int index) {\n\treturn texelFetch(lightsTexture8, ivec2(index, clusterLightData.lightIndex), 0);\n}\nvec4 sampleLightTextureF(const ClusterLightData clusterLightData, int index) {\n\treturn texelFetch(lightsTextureFloat, ivec2(index, clusterLightData.lightIndex), 0);\n}\nvoid decodeClusterLightCore(inout ClusterLightData clusterLightData, float lightIndex) {\n\tclusterLightData.lightIndex = int(lightIndex);\n\tvec4 lightInfo = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_FLAGS);\n\tclusterLightData.lightType = lightInfo.x;\n\tclusterLightData.shape = lightInfo.y;\n\tclusterLightData.falloffMode = lightInfo.z;\n\tclusterLightData.shadowIntensity = lightInfo.w;\n\tvec4 colorA = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_COLOR_A);\n\tvec4 colorB = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_COLOR_B);\n\tclusterLightData.color = vec3(bytes2float2(colorA.xy), bytes2float2(colorA.zw), bytes2float2(colorB.xy)) * clusterCompressionLimit0.y;\n\tclusterLightData.cookie = colorB.z;\n\tclusterLightData.mask = colorB.w;\n\tvec4 lightPosRange = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_POSITION_RANGE);\n\tclusterLightData.position = lightPosRange.xyz;\n\tclusterLightData.range = lightPosRange.w;\n\tvec4 lightDir_Unused = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_SPOT_DIRECTION);\n\tclusterLightData.direction = lightDir_Unused.xyz;\n}\nvoid decodeClusterLightSpot(inout ClusterLightData clusterLightData) {\n\tvec4 coneAngle = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SPOT_ANGLES);\n\tclusterLightData.innerConeAngleCos = bytes2float2(coneAngle.xy) * 2.0 - 1.0;\n\tclusterLightData.outerConeAngleCos = bytes2float2(coneAngle.zw) * 2.0 - 1.0;\n}\nvoid decodeClusterLightOmniAtlasViewport(inout ClusterLightData clusterLightData) {\n\tclusterLightData.omniAtlasViewport = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_0).xyz;\n}\nvoid decodeClusterLightAreaData(inout ClusterLightData clusterLightData) {\n\tclusterLightData.halfWidth = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_AREA_DATA_WIDTH).xyz;\n\tclusterLightData.halfHeight = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_AREA_DATA_HEIGHT).xyz;\n}\nvoid decodeClusterLightProjectionMatrixData(inout ClusterLightData clusterLightData) {\n\t\n\tvec4 m0 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_0);\n\tvec4 m1 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_1);\n\tvec4 m2 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_2);\n\tvec4 m3 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_3);\n\tlightProjectionMatrix = mat4(m0, m1, m2, m3);\n}\nvoid decodeClusterLightShadowData(inout ClusterLightData clusterLightData) {\n\t\n\tvec4 biases = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SHADOW_BIAS);\n\tclusterLightData.shadowBias = bytes2floatRange2(biases.xy, -1.0, 20.0),\n\tclusterLightData.shadowNormalBias = bytes2float2(biases.zw);\n}\nvoid decodeClusterLightCookieData(inout ClusterLightData clusterLightData) {\n\tvec4 cookieA = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_COOKIE_A);\n\tclusterLightData.cookieIntensity = cookieA.x;\n\tclusterLightData.cookieRgb = cookieA.y;\n\tclusterLightData.cookieChannelMask = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_COOKIE_B);\n}\nvoid evaluateLight(\n\tClusterLightData light, \n\tvec3 worldNormal, \n\tvec3 viewDir, \n\tvec3 reflectionDir,\n#if defined(LIT_CLEARCOAT)\n\tvec3 clearcoatReflectionDir,\n#endif\n\tfloat gloss, \n\tvec3 specularity, \n\tvec3 geometricNormal, \n\tmat3 tbn, \n#if defined(LIT_IRIDESCENCE)\n\tvec3 iridescenceFresnel,\n#endif\n\tvec3 clearcoat_worldNormal,\n\tfloat clearcoat_gloss,\n\tfloat sheen_gloss,\n\tfloat iridescence_intensity\n) {\n\tvec3 cookieAttenuation = vec3(1.0);\n\tfloat diffuseAttenuation = 1.0;\n\tfloat falloffAttenuation = 1.0;\n\tgetLightDirPoint(light.position);\n\t#ifdef CLUSTER_AREALIGHTS\n\tif (isClusteredLightArea(light)) {\n\t\tdecodeClusterLightAreaData(light);\n\t\tif (isClusteredLightRect(light)) {\n\t\t\tcalcRectLightValues(light.position, light.halfWidth, light.halfHeight);\n\t\t} else if (isClusteredLightDisk(light)) {\n\t\t\tcalcDiskLightValues(light.position, light.halfWidth, light.halfHeight);\n\t\t} else {\n\t\t\tcalcSphereLightValues(light.position, light.halfWidth, light.halfHeight);\n\t\t}\n\t\tfalloffAttenuation = getFalloffWindow(light.range, dLightDirW);\n\t} else\n\t#endif\n\t{\n\t\tif (isClusteredLightFalloffLinear(light))\n\t\t\tfalloffAttenuation = getFalloffLinear(light.range, dLightDirW);\n\t\telse\n\t\t\tfalloffAttenuation = getFalloffInvSquared(light.range, dLightDirW);\n\t}\n\tif (falloffAttenuation > 0.00001) {\n\t\t#ifdef CLUSTER_AREALIGHTS\n\t\tif (isClusteredLightArea(light)) {\n\t\t\tif (isClusteredLightRect(light)) {\n\t\t\t\tdiffuseAttenuation = getRectLightDiffuse(worldNormal, viewDir, dLightDirW, dLightDirNormW) * 16.0;\n\t\t\t} else if (isClusteredLightDisk(light)) {\n\t\t\t\tdiffuseAttenuation = getDiskLightDiffuse(worldNormal, viewDir, dLightDirW, dLightDirNormW) * 16.0;\n\t\t\t} else {\n\t\t\t\tdiffuseAttenuation = getSphereLightDiffuse(worldNormal, viewDir, dLightDirW, dLightDirNormW) * 16.0;\n\t\t\t}\n\t\t} else\n\t\t#endif\n\t\t{\n\t\t\tfalloffAttenuation *= getLightDiffuse(worldNormal, viewDir, dLightDirW, dLightDirNormW); \n\t\t}\n\t\tif (isClusteredLightSpot(light)) {\n\t\t\tdecodeClusterLightSpot(light);\n\t\t\tfalloffAttenuation *= getSpotEffect(light.direction, light.innerConeAngleCos, light.outerConeAngleCos, dLightDirNormW);\n\t\t}\n\t\t#if defined(CLUSTER_COOKIES_OR_SHADOWS)\n\t\tif (falloffAttenuation > 0.00001) {\n\t\t\tif (isClusteredLightCastShadow(light) || isClusteredLightCookie(light)) {\n\t\t\t\tif (isClusteredLightSpot(light)) {\n\t\t\t\t\tdecodeClusterLightProjectionMatrixData(light);\n\t\t\t\t} else {\n\t\t\t\t\tdecodeClusterLightOmniAtlasViewport(light);\n\t\t\t\t}\n\t\t\t\tfloat shadowTextureResolution = shadowAtlasParams.x;\n\t\t\t\tfloat shadowEdgePixels = shadowAtlasParams.y;\n\t\t\t\t#ifdef CLUSTER_COOKIES\n\t\t\t\tif (isClusteredLightCookie(light)) {\n\t\t\t\t\tdecodeClusterLightCookieData(light);\n\t\t\t\t\tif (isClusteredLightSpot(light)) {\n\t\t\t\t\t\tcookieAttenuation = getCookie2DClustered(TEXTURE_PASS(cookieAtlasTexture), lightProjectionMatrix, vPositionW, light.cookieIntensity, isClusteredLightCookieRgb(light), light.cookieChannelMask);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tcookieAttenuation = getCookieCubeClustered(TEXTURE_PASS(cookieAtlasTexture), dLightDirW, light.cookieIntensity, isClusteredLightCookieRgb(light), light.cookieChannelMask, shadowTextureResolution, shadowEdgePixels, light.omniAtlasViewport);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t#endif\n\t\t\t\t#ifdef CLUSTER_SHADOWS\n\t\t\t\tif (isClusteredLightCastShadow(light)) {\n\t\t\t\t\tdecodeClusterLightShadowData(light);\n\t\t\t\t\tvec4 shadowParams = vec4(shadowTextureResolution, light.shadowNormalBias, light.shadowBias, 1.0 / light.range);\n\t\t\t\t\tif (isClusteredLightSpot(light)) {\n\t\t\t\t\t\tgetShadowCoordPerspZbufferNormalOffset(lightProjectionMatrix, shadowParams, geometricNormal);\n\t\t\t\t\t\t\n\t\t\t\t\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\t\t\t\t\t\t\tfloat shadow = getShadowSpotClusteredPCF1(SHADOWMAP_PASS(shadowAtlasTexture), dShadowCoord, shadowParams);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF3)\n\t\t\t\t\t\t\tfloat shadow = getShadowSpotClusteredPCF3(SHADOWMAP_PASS(shadowAtlasTexture), dShadowCoord, shadowParams);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF5)\n\t\t\t\t\t\t\tfloat shadow = getShadowSpotClusteredPCF5(SHADOWMAP_PASS(shadowAtlasTexture), dShadowCoord, shadowParams);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCSS)\n\t\t\t\t\t\t\tfloat shadow = getShadowSpotClusteredPCSS(SHADOWMAP_PASS(shadowAtlasTexture), dShadowCoord, shadowParams);\n\t\t\t\t\t\t#endif\n\t\t\t\t\t\tfalloffAttenuation *= mix(1.0, shadow, light.shadowIntensity);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tvec3 dir = normalOffsetPointShadow(shadowParams, dLightPosW, dLightDirW, dLightDirNormW, geometricNormal);\n\t\t\t\t\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\t\t\t\t\t\t\tfloat shadow = getShadowOmniClusteredPCF1(SHADOWMAP_PASS(shadowAtlasTexture), shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF3)\n\t\t\t\t\t\t\tfloat shadow = getShadowOmniClusteredPCF3(SHADOWMAP_PASS(shadowAtlasTexture), shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);\n\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF5)\n\t\t\t\t\t\t\tfloat shadow = getShadowOmniClusteredPCF5(SHADOWMAP_PASS(shadowAtlasTexture), shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);\n\t\t\t\t\t\t#endif\n\t\t\t\t\t\tfalloffAttenuation *= mix(1.0, shadow, light.shadowIntensity);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t#endif\n\t\t\t}\n\t\t}\n\t\t#endif\n\t\t#ifdef CLUSTER_AREALIGHTS\n\t\tif (isClusteredLightArea(light)) {\n\t\t\t{\n\t\t\t\tvec3 areaDiffuse = (diffuseAttenuation * falloffAttenuation) * light.color * cookieAttenuation;\n\t\t\t\t#if defined(LIT_SPECULAR)\n\t\t\t\t\tareaDiffuse = mix(areaDiffuse, vec3(0), dLTCSpecFres);\n\t\t\t\t#endif\n\t\t\t\tdDiffuseLight += areaDiffuse;\n\t\t\t}\n\t\t\t#ifdef LIT_SPECULAR\n\t\t\t\tfloat areaLightSpecular;\n\t\t\t\tif (isClusteredLightRect(light)) {\n\t\t\t\t\tareaLightSpecular = getRectLightSpecular(worldNormal, viewDir);\n\t\t\t\t} else if (isClusteredLightDisk(light)) {\n\t\t\t\t\tareaLightSpecular = getDiskLightSpecular(worldNormal, viewDir);\n\t\t\t\t} else {\n\t\t\t\t\tareaLightSpecular = getSphereLightSpecular(worldNormal, viewDir);\n\t\t\t\t}\n\t\t\t\tdSpecularLight += dLTCSpecFres * areaLightSpecular * falloffAttenuation * light.color * cookieAttenuation;\n\t\t\t\t#ifdef LIT_CLEARCOAT\n\t\t\t\t\tfloat areaLightSpecularCC;\n\t\t\t\t\tif (isClusteredLightRect(light)) {\n\t\t\t\t\t\tareaLightSpecularCC = getRectLightSpecular(clearcoat_worldNormal, viewDir);\n\t\t\t\t\t} else if (isClusteredLightDisk(light)) {\n\t\t\t\t\t\tareaLightSpecularCC = getDiskLightSpecular(clearcoat_worldNormal, viewDir);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tareaLightSpecularCC = getSphereLightSpecular(clearcoat_worldNormal, viewDir);\n\t\t\t\t\t}\n\t\t\t\t\tccSpecularLight += ccLTCSpecFres * areaLightSpecularCC * falloffAttenuation * light.color  * cookieAttenuation;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t} else\n\t\t#endif\n\t\t{\n\t\t\t{\n\t\t\t\tvec3 punctualDiffuse = falloffAttenuation * light.color * cookieAttenuation;\n\t\t\t\t#if defined(CLUSTER_AREALIGHTS)\n\t\t\t\t#if defined(LIT_SPECULAR)\n\t\t\t\t\tpunctualDiffuse = mix(punctualDiffuse, vec3(0), specularity);\n\t\t\t\t#endif\n\t\t\t\t#endif\n\t\t\t\tdDiffuseLight += punctualDiffuse;\n\t\t\t}\n\t \n\t\t\t#ifdef LIT_SPECULAR\n\t\t\t\tvec3 halfDir = normalize(-dLightDirNormW + viewDir);\n\t\t\t\t\n\t\t\t\t#ifdef LIT_SPECULAR_FRESNEL\n\t\t\t\t\tdSpecularLight += \n\t\t\t\t\t\tgetLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, dLightDirNormW, gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * \n\t\t\t\t\t\tgetFresnel(\n\t\t\t\t\t\t\tdot(viewDir, halfDir), \n\t\t\t\t\t\t\tgloss, \n\t\t\t\t\t\t\tspecularity\n\t\t\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t\t\t, iridescenceFresnel,\n\t\t\t\t\t\t\tiridescence_intensity\n\t\t\t\t\t\t#endif\n\t\t\t\t\t\t\t);\n\t\t\t\t#else\n\t\t\t\t\tdSpecularLight += getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, dLightDirNormW, gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * specularity;\n\t\t\t\t#endif\n\t\t\t\t#ifdef LIT_CLEARCOAT\n\t\t\t\t\t#ifdef LIT_SPECULAR_FRESNEL\n\t\t\t\t\t\tccSpecularLight += getLightSpecular(halfDir, clearcoatReflectionDir, clearcoat_worldNormal, viewDir, dLightDirNormW, clearcoat_gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * getFresnelCC(dot(viewDir, halfDir));\n\t\t\t\t\t#else\n\t\t\t\t\t\tccSpecularLight += getLightSpecular(halfDir, clearcoatReflectionDir, clearcoat_worldNormal, viewDir, dLightDirNormW, clearcoat_gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation; \n\t\t\t\t\t#endif\n\t\t\t\t#endif\n\t\t\t\t#ifdef LIT_SHEEN\n\t\t\t\t\tsSpecularLight += getLightSpecularSheen(halfDir, worldNormal, viewDir, dLightDirNormW, sheen_gloss) * falloffAttenuation * light.color * cookieAttenuation;\n\t\t\t\t#endif\n\t\t\t#endif\n\t\t}\n\t}\n\tdAtten = falloffAttenuation;\n\tdAttenD = diffuseAttenuation;\n\tdAtten3 = cookieAttenuation;\n}\nvoid evaluateClusterLight(\n\tfloat lightIndex, \n\tvec3 worldNormal, \n\tvec3 viewDir, \n\tvec3 reflectionDir, \n#if defined(LIT_CLEARCOAT)\n\tvec3 clearcoatReflectionDir,\n#endif\n\tfloat gloss, \n\tvec3 specularity, \n\tvec3 geometricNormal, \n\tmat3 tbn, \n#if defined(LIT_IRIDESCENCE)\n\tvec3 iridescenceFresnel,\n#endif\n\tvec3 clearcoat_worldNormal,\n\tfloat clearcoat_gloss,\n\tfloat sheen_gloss,\n\tfloat iridescence_intensity\n) {\n\tClusterLightData clusterLightData;\n\tdecodeClusterLightCore(clusterLightData, lightIndex);\n\tif (acceptLightMask(clusterLightData))\n\t\tevaluateLight(\n\t\t\tclusterLightData, \n\t\t\tworldNormal, \n\t\t\tviewDir, \n\t\t\treflectionDir, \n#if defined(LIT_CLEARCOAT)\n\t\t\tclearcoatReflectionDir, \n#endif\n\t\t\tgloss, \n\t\t\tspecularity, \n\t\t\tgeometricNormal, \n\t\t\ttbn, \n#if defined(LIT_IRIDESCENCE)\n\t\t\tiridescenceFresnel,\n#endif\n\t\t\tclearcoat_worldNormal,\n\t\t\tclearcoat_gloss,\n\t\t\tsheen_gloss,\n\t\t\tiridescence_intensity\n\t\t);\n}\nvoid addClusteredLights(\n\tvec3 worldNormal, \n\tvec3 viewDir, \n\tvec3 reflectionDir, \n#if defined(LIT_CLEARCOAT)\n\tvec3 clearcoatReflectionDir,\n#endif\n\tfloat gloss, \n\tvec3 specularity, \n\tvec3 geometricNormal, \n\tmat3 tbn, \n#if defined(LIT_IRIDESCENCE)\n\tvec3 iridescenceFresnel,\n#endif\n\tvec3 clearcoat_worldNormal,\n\tfloat clearcoat_gloss,\n\tfloat sheen_gloss,\n\tfloat iridescence_intensity\n) {\n\tif (clusterSkip > 0.5)\n\t\treturn;\n\tvec3 cellCoords = floor((vPositionW - clusterBoundsMin) * clusterCellsCountByBoundsSize);\n\tif (!(any(lessThan(cellCoords, vec3(0.0))) || any(greaterThanEqual(cellCoords, clusterCellsMax)))) {\n\t\tfloat cellIndex = dot(clusterCellsDot, cellCoords);\n\t\tfloat clusterV = floor(cellIndex * clusterTextureSize.y);\n\t\tfloat clusterU = cellIndex - (clusterV * clusterTextureSize.x);\n\t\tfor (int lightCellIndex = 0; lightCellIndex < clusterMaxCells; lightCellIndex++) {\n\t\t\tfloat lightIndex = texelFetch(clusterWorldTexture, ivec2(int(clusterU) + lightCellIndex, clusterV), 0).x;\n\t\t\tif (lightIndex <= 0.0)\n\t\t\t\t\treturn;\n\t\t\tevaluateClusterLight(\n\t\t\t\tlightIndex * 255.0, \n\t\t\t\tworldNormal, \n\t\t\t\tviewDir, \n\t\t\t\treflectionDir,\n#if defined(LIT_CLEARCOAT)\n\t\t\t\tclearcoatReflectionDir,\n#endif\n\t\t\t\tgloss, \n\t\t\t\tspecularity, \n\t\t\t\tgeometricNormal, \n\t\t\t\ttbn, \n#if defined(LIT_IRIDESCENCE)\n\t\t\t\tiridescenceFresnel,\n#endif\n\t\t\t\tclearcoat_worldNormal,\n\t\t\t\tclearcoat_gloss,\n\t\t\t\tsheen_gloss,\n\t\t\t\tiridescence_intensity\n\t\t\t); \n\t\t}\n\t}\n}\n",combinePS:"\nvec3 combineColor(vec3 albedo, vec3 sheenSpecularity, float clearcoatSpecularity) {\n\tvec3 ret = vec3(0);\n#ifdef LIT_OLD_AMBIENT\n\tret += (dDiffuseLight - light_globalAmbient) * albedo + material_ambient * light_globalAmbient;\n#else\n\tret += albedo * dDiffuseLight;\n#endif\n#ifdef LIT_SPECULAR\n\tret += dSpecularLight;\n#endif\n#ifdef LIT_REFLECTIONS\n\tret += dReflection.rgb * dReflection.a;\n#endif\n#ifdef LIT_SHEEN\n\tfloat sheenScaling = 1.0 - max(max(sheenSpecularity.r, sheenSpecularity.g), sheenSpecularity.b) * 0.157;\n\tret = ret * sheenScaling + (sSpecularLight + sReflection.rgb) * sheenSpecularity;\n#endif\n#ifdef LIT_CLEARCOAT\n\tfloat clearCoatScaling = 1.0 - ccFresnel * clearcoatSpecularity;\n\tret = ret * clearCoatScaling + (ccSpecularLight + ccReflection.rgb) * clearcoatSpecularity;\n#endif\n\treturn ret;\n}\n",cookiePS:"\nvec4 getCookie2D(sampler2D tex, mat4 transform, float intensity) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\treturn mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\nvec4 getCookie2DClip(sampler2D tex, mat4 transform, float intensity) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\tif (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n\treturn mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\nvec4 getCookie2DXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\tprojPos.xy += cookieOffset;\n\tvec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n\treturn mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\nvec4 getCookie2DClipXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\tprojPos.xy += cookieOffset;\n\tif (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n\tvec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n\treturn mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\nvec4 getCookieCube(samplerCube tex, mat4 transform, float intensity) {\n\treturn mix(vec4(1.0), textureCube(tex, dLightDirNormW * mat3(transform)), intensity);\n}\n",cubeMapProjectBoxPS:"\nuniform vec3 envBoxMin;\nuniform vec3 envBoxMax;\nvec3 cubeMapProject(vec3 nrdir) {\n\tnrdir = cubeMapRotate(nrdir);\n\tvec3 rbmax = (envBoxMax - vPositionW) / nrdir;\n\tvec3 rbmin = (envBoxMin - vPositionW) / nrdir;\n\tvec3 rbminmax;\n\trbminmax.x = nrdir.x>0.0? rbmax.x : rbmin.x;\n\trbminmax.y = nrdir.y>0.0? rbmax.y : rbmin.y;\n\trbminmax.z = nrdir.z>0.0? rbmax.z : rbmin.z;\n\tfloat fa = min(min(rbminmax.x, rbminmax.y), rbminmax.z);\n\tvec3 posonbox = vPositionW + nrdir * fa;\n\tvec3 envBoxPos = (envBoxMin + envBoxMax) * 0.5;\n\treturn normalize(posonbox - envBoxPos);\n}\n",cubeMapProjectNonePS:"\nvec3 cubeMapProject(vec3 dir) {\n\treturn cubeMapRotate(dir);\n}\n",cubeMapRotatePS:"\n#ifdef CUBEMAP_ROTATION\nuniform mat3 cubeMapRotationMatrix;\n#endif\nvec3 cubeMapRotate(vec3 refDir) {\n#ifdef CUBEMAP_ROTATION\n\treturn refDir * cubeMapRotationMatrix;\n#else\n\treturn refDir;\n#endif\n}\n",debugOutputPS:"\n#ifdef DEBUG_ALBEDO_PASS\ngl_FragColor = vec4(gammaCorrectOutput(dAlbedo), 1.0);\n#endif\n#ifdef DEBUG_UV0_PASS\ngl_FragColor = vec4(litArgs_albedo , 1.0);\n#endif\n#ifdef DEBUG_WORLD_NORMAL_PASS\ngl_FragColor = vec4(litArgs_worldNormal * 0.5 + 0.5, 1.0);\n#endif\n#ifdef DEBUG_OPACITY_PASS\ngl_FragColor = vec4(vec3(litArgs_opacity) , 1.0);\n#endif\n#ifdef DEBUG_SPECULARITY_PASS\ngl_FragColor = vec4(litArgs_specularity, 1.0);\n#endif\n#ifdef DEBUG_GLOSS_PASS\ngl_FragColor = vec4(vec3(litArgs_gloss) , 1.0);\n#endif\n#ifdef DEBUG_METALNESS_PASS\ngl_FragColor = vec4(vec3(litArgs_metalness) , 1.0);\n#endif\n#ifdef DEBUG_AO_PASS\ngl_FragColor = vec4(vec3(litArgs_ao) , 1.0);\n#endif\n#ifdef DEBUG_EMISSION_PASS\ngl_FragColor = vec4(gammaCorrectOutput(litArgs_emission), 1.0);\n#endif\n",debugProcessFrontendPS:"\n#ifdef DEBUG_LIGHTING_PASS\nlitArgs_albedo = vec3(0.5);\n#endif\n#ifdef DEBUG_UV0_PASS\n#ifdef VARYING_VUV0\nlitArgs_albedo = vec3(vUv0, 0);\n#else\nlitArgs_albedo = vec3(0);\n#endif\n#endif\n",detailModesPS:"\nvec3 detailMode_mul(vec3 c1, vec3 c2) {\n\treturn c1 * c2;\n}\nvec3 detailMode_add(vec3 c1, vec3 c2) {\n\treturn c1 + c2;\n}\nvec3 detailMode_screen(vec3 c1, vec3 c2) {\n\treturn 1.0 - (1.0 - c1)*(1.0 - c2);\n}\nvec3 detailMode_overlay(vec3 c1, vec3 c2) {\n\treturn mix(1.0 - 2.0*(1.0 - c1)*(1.0 - c2), 2.0*c1*c2, step(c1, vec3(0.5)));\n}\nvec3 detailMode_min(vec3 c1, vec3 c2) {\n\treturn min(c1, c2);\n}\nvec3 detailMode_max(vec3 c1, vec3 c2) {\n\treturn max(c1, c2);\n}\n",diffusePS:"\nuniform vec3 material_diffuse;\nvoid getAlbedo() {\n\tdAlbedo = material_diffuse.rgb;\n#ifdef MAPTEXTURE\n\tvec3 albedoBase = $DECODE(texture2DBias($SAMPLER, $UV, textureBias)).$CH;\n\tdAlbedo *= addAlbedoDetail(albedoBase);\n#endif\n#ifdef MAPVERTEX\n\tdAlbedo *= gammaCorrectInput(saturate(vVertexColor.$VC));\n#endif\n}\n",diffuseDetailMapPS:"\nvec3 addAlbedoDetail(vec3 albedo) {\n#ifdef MAPTEXTURE\n\tvec3 albedoDetail = $DECODE(texture2DBias($SAMPLER, $UV, textureBias)).$CH;\n\treturn detailMode_$DETAILMODE(albedo, albedoDetail);\n#else\n\treturn albedo;\n#endif\n}\n",decodePS:ll,emissivePS:"\nuniform vec3 material_emissive;\nuniform float material_emissiveIntensity;\nvoid getEmission() {\n\tdEmission = material_emissive * material_emissiveIntensity;\n\t#ifdef MAPTEXTURE\n\tdEmission *= $DECODE(texture2DBias($SAMPLER, $UV, textureBias)).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdEmission *= gammaCorrectInput(saturate(vVertexColor.$VC));\n\t#endif\n}\n",encodePS:hl,endPS:"\n\tgl_FragColor.rgb = combineColor(litArgs_albedo, litArgs_sheen_specularity, litArgs_clearcoat_specularity);\n\tgl_FragColor.rgb += litArgs_emission;\n\tgl_FragColor.rgb = addFog(gl_FragColor.rgb);\n\tgl_FragColor.rgb = toneMap(gl_FragColor.rgb);\n\tgl_FragColor.rgb = gammaCorrectOutput(gl_FragColor.rgb);\n",endVS:"\n",envAtlasPS:"\nconst float atlasSize = 512.0;\nconst float seamSize = 1.0 / atlasSize;\nvec2 mapUv(vec2 uv, vec4 rect) {\n\treturn vec2(mix(rect.x + seamSize, rect.x + rect.z - seamSize, uv.x),\n\t\t\t\tmix(rect.y + seamSize, rect.y + rect.w - seamSize, uv.y));\n}\nvec2 mapRoughnessUv(vec2 uv, float level) {\n\tfloat t = 1.0 / exp2(level);\n\treturn mapUv(uv, vec4(0, 1.0 - t, t, t * 0.5));\n}\nvec2 mapShinyUv(vec2 uv, float level) {\n\tfloat t = 1.0 / exp2(level);\n\treturn mapUv(uv, vec4(1.0 - t, 1.0 - t, t, t * 0.5));\n}\n",envConstPS:"\nvec3 processEnvironment(vec3 color) {\n\treturn color;\n}\n",envMultiplyPS:"\nuniform float skyboxIntensity;\nvec3 processEnvironment(vec3 color) {\n\treturn color * skyboxIntensity;\n}\n",falloffInvSquaredPS:"\nfloat getFalloffWindow(float lightRadius, vec3 lightDir) {\n\tfloat sqrDist = dot(lightDir, lightDir);\n\tfloat invRadius = 1.0 / lightRadius;\n\treturn square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );\n}\nfloat getFalloffInvSquared(float lightRadius, vec3 lightDir) {\n\tfloat sqrDist = dot(lightDir, lightDir);\n\tfloat falloff = 1.0 / (sqrDist + 1.0);\n\tfloat invRadius = 1.0 / lightRadius;\n\tfalloff *= 16.0;\n\tfalloff *= square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );\n\treturn falloff;\n}\n",falloffLinearPS:"\nfloat getFalloffLinear(float lightRadius, vec3 lightDir) {\n\tfloat d = length(lightDir);\n\treturn max(((lightRadius - d) / lightRadius), 0.0);\n}\n",floatUnpackingPS:"\nfloat bytes2float2(vec2 data) {\n\treturn dot(data, vec2(1.0, 1.0 / 255.0));\n}\nfloat bytes2float3(vec3 data) {\n\treturn dot(data, vec3(1.0, 1.0 / 255.0, 1.0 / 65025.0));\n}\nfloat bytes2float4(vec4 data) {\n\treturn dot(data, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\nfloat bytes2floatRange2(vec2 data, float min, float max) {\n\treturn mix(min, max, bytes2float2(data));\n}\nfloat bytes2floatRange3(vec3 data, float min, float max) {\n\treturn mix(min, max, bytes2float3(data));\n}\nfloat bytes2floatRange4(vec4 data, float min, float max) {\n\treturn mix(min, max, bytes2float4(data));\n}\nfloat mantissaExponent2Float(vec4 pack)\n{\n\tfloat value = bytes2floatRange3(pack.xyz, -1.0, 1.0);\n\tfloat exponent = floor(pack.w * 255.0 - 127.0);\n\treturn value * exp2(exponent);\n}\n",fogExpPS:"\nuniform vec3 fog_color;\nuniform float fog_density;\nfloat dBlendModeFogFactor = 1.0;\nvec3 addFog(vec3 color) {\n\tfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n\tfloat fogFactor = exp(-depth * fog_density);\n\tfogFactor = clamp(fogFactor, 0.0, 1.0);\n\treturn mix(fog_color * dBlendModeFogFactor, color, fogFactor);\n}\n",fogExp2PS:"\nuniform vec3 fog_color;\nuniform float fog_density;\nfloat dBlendModeFogFactor = 1.0;\nvec3 addFog(vec3 color) {\n\tfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n\tfloat fogFactor = exp(-depth * depth * fog_density * fog_density);\n\tfogFactor = clamp(fogFactor, 0.0, 1.0);\n\treturn mix(fog_color * dBlendModeFogFactor, color, fogFactor);\n}\n",fogLinearPS:"\nuniform vec3 fog_color;\nuniform float fog_start;\nuniform float fog_end;\nfloat dBlendModeFogFactor = 1.0;\nvec3 addFog(vec3 color) {\n\tfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n\tfloat fogFactor = (fog_end - depth) / (fog_end - fog_start);\n\tfogFactor = clamp(fogFactor, 0.0, 1.0);\n\treturn mix(fog_color * dBlendModeFogFactor, color, fogFactor);\n}\n",fogNonePS:"\nfloat dBlendModeFogFactor = 1.0;\nvec3 addFog(vec3 color) {\n\treturn color;\n}\n",fresnelSchlickPS:"\nvec3 getFresnel(\n\t\tfloat cosTheta, \n\t\tfloat gloss, \n\t\tvec3 specularity\n#if defined(LIT_IRIDESCENCE)\n\t\t, vec3 iridescenceFresnel, \n\t\tfloat iridescenceIntensity\n#endif\n\t) {\n\tfloat fresnel = pow(1.0 - max(cosTheta, 0.0), 5.0);\n\tfloat glossSq = gloss * gloss;\n\tvec3 ret = specularity + (max(vec3(glossSq), specularity) - specularity) * fresnel;\n#if defined(LIT_IRIDESCENCE)\n\treturn mix(ret, iridescenceFresnel, iridescenceIntensity);\n#else\n\treturn ret;\n#endif\t\n}\nfloat getFresnelCC(float cosTheta) {\n\tfloat fresnel = pow(1.0 - max(cosTheta, 0.0), 5.0);\n\treturn 0.04 + (1.0 - 0.04) * fresnel;\n}\n",fullscreenQuadPS:"\nvarying vec2 vUv0;\nuniform sampler2D source;\nvoid main(void) {\n\tgl_FragColor = texture2D(source, vUv0);\n}\n",fullscreenQuadVS:"\nattribute vec2 vertex_position;\nvarying vec2 vUv0;\nvoid main(void)\n{\n\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\tvUv0 = vertex_position.xy*0.5+0.5;\n}\n",gamma1_0PS:"\nfloat gammaCorrectInput(float color) {\n\treturn color;\n}\nvec3 gammaCorrectInput(vec3 color) {\n\treturn color;\n}\nvec4 gammaCorrectInput(vec4 color) {\n\treturn color;\n}\nvec3 gammaCorrectOutput(vec3 color) {\n\treturn color;\n}\n",gamma2_2PS:"\nfloat gammaCorrectInput(float color) {\n\treturn decodeGamma(color);\n}\nvec3 gammaCorrectInput(vec3 color) {\n\treturn decodeGamma(color);\n}\nvec4 gammaCorrectInput(vec4 color) {\n\treturn vec4(decodeGamma(color.xyz), color.w);\n}\nvec3 gammaCorrectOutput(vec3 color) {\n\treturn pow(color + 0.0000001, vec3(1.0 / 2.2));\n}\n",gles3PS:da,gles3VS:ua,glossPS:"\n#ifdef MAPFLOAT\nuniform float material_gloss;\n#endif\nvoid getGlossiness() {\n\tdGlossiness = 1.0;\n\t#ifdef MAPFLOAT\n\tdGlossiness *= material_gloss;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tdGlossiness *= texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdGlossiness *= saturate(vVertexColor.$VC);\n\t#endif\n\t#ifdef MAPINVERT\n\tdGlossiness = 1.0 - dGlossiness;\n\t#endif\n\tdGlossiness += 0.0000001;\n}\n",gsplatCenterVS:"\nuniform mat4 matrix_model;\nuniform mat4 matrix_view;\nuniform mat4 matrix_projection;\nbool initCenter(SplatSource source, vec3 modelCenter, out SplatCenter center) {\n\tmat4 modelView = matrix_view * matrix_model;\n\tvec4 centerView = modelView * vec4(modelCenter, 1.0);\n\tif (centerView.z > 0.0) {\n\t\treturn false;\n\t}\n\tvec4 centerProj = matrix_projection * centerView;\n\tcenterProj.z = clamp(centerProj.z, -abs(centerProj.w), abs(centerProj.w));\n\tcenter.view = centerView.xyz / centerView.w;\n\tcenter.proj = centerProj;\n\tcenter.projMat00 = matrix_projection[0][0];\n\tcenter.modelView = modelView;\n\treturn true;\n}\n",gsplatCornerVS:"\nuniform vec2 viewport;\nuniform vec4 camera_params;\nbool initCorner(SplatSource source, SplatCenter center, out SplatCorner corner) {\n\tvec3 covA, covB;\n\treadCovariance(source, covA, covB);\n\tmat3 Vrk = mat3(\n\t\tcovA.x, covA.y, covA.z, \n\t\tcovA.y, covB.x, covB.y,\n\t\tcovA.z, covB.y, covB.z\n\t);\n\tfloat focal = viewport.x * center.projMat00;\n\tvec3 v = camera_params.w == 1.0 ? vec3(0.0, 0.0, 1.0) : center.view.xyz;\n\tfloat J1 = focal / v.z;\n\tvec2 J2 = -J1 / v.z * v.xy;\n\tmat3 J = mat3(\n\t\tJ1, 0.0, J2.x, \n\t\t0.0, J1, J2.y, \n\t\t0.0, 0.0, 0.0\n\t);\n\tmat3 W = transpose(mat3(center.modelView));\n\tmat3 T = W * J;\n\tmat3 cov = transpose(T) * Vrk * T;\n\tfloat diagonal1 = cov[0][0] + 0.3;\n\tfloat offDiagonal = cov[0][1];\n\tfloat diagonal2 = cov[1][1] + 0.3;\n\tfloat mid = 0.5 * (diagonal1 + diagonal2);\n\tfloat radius = length(vec2((diagonal1 - diagonal2) / 2.0, offDiagonal));\n\tfloat lambda1 = mid + radius;\n\tfloat lambda2 = max(mid - radius, 0.1);\n\tfloat l1 = 2.0 * min(sqrt(2.0 * lambda1), 1024.0);\n\tfloat l2 = 2.0 * min(sqrt(2.0 * lambda2), 1024.0);\n\tif (l1 < 2.0 && l2 < 2.0) {\n\t\treturn false;\n\t}\n\tif (any(greaterThan(abs(center.proj.xy) - vec2(l1, l2) / viewport * center.proj.w, center.proj.ww))) {\n\t\treturn false;\n\t}\n\tvec2 diagonalVector = normalize(vec2(offDiagonal, lambda1 - diagonal1));\n\tvec2 v1 = l1 * diagonalVector;\n\tvec2 v2 = l2 * vec2(diagonalVector.y, -diagonalVector.x);\n\tcorner.offset = (source.cornerUV.x * v1 + source.cornerUV.y * v2) / viewport * center.proj.w;\n\tcorner.uv = source.cornerUV;\n\treturn true;\n}\n",gsplatColorVS:"\nuniform mediump sampler2D splatColor;\nvec4 readColor(in SplatSource source) {\n\treturn texelFetch(splatColor, source.uv, 0);\n}\n",gsplatCommonVS:'\nstruct SplatSource {\n\tuint order;\n\tuint id;\n\tivec2 uv;\n\tvec2 cornerUV;\n};\nstruct SplatCenter {\n\tvec3 view;\n\tvec4 proj;\n\tmat4 modelView;\n\tfloat projMat00;\n};\nstruct SplatCorner {\n\tvec2 offset;\n\tvec2 uv;\n};\n#if SH_BANDS > 0\n\t#if SH_BANDS == 1\n\t\t#define SH_COEFFS 3\n\t#elif SH_BANDS == 2\n\t\t#define SH_COEFFS 8\n\t#elif SH_BANDS == 3\n\t\t#define SH_COEFFS 15\n\t#endif\n#endif\n#if GSPLAT_COMPRESSED_DATA == true\n\t#include "gsplatCompressedDataVS"\n\t#include "gsplatCompressedSHVS"\n#else\n\t#include "gsplatDataVS"\n\t#include "gsplatColorVS"\n\t#include "gsplatSHVS"\n#endif\n#include "gsplatSourceVS"\n#include "gsplatCenterVS"\n#include "gsplatCornerVS"\n#include "gsplatOutputVS"\nvoid clipCorner(inout SplatCorner corner, float alpha) {\n\tfloat clip = min(1.0, sqrt(-log(1.0 / 255.0 / alpha)) / 2.0);\n\tcorner.offset *= clip;\n\tcorner.uv *= clip;\n}\n#if SH_BANDS > 0\n#define SH_C1 0.4886025119029199f\n#if SH_BANDS > 1\n\t#define SH_C2_0 1.0925484305920792f\n\t#define SH_C2_1 -1.0925484305920792f\n\t#define SH_C2_2 0.31539156525252005f\n\t#define SH_C2_3 -1.0925484305920792f\n\t#define SH_C2_4 0.5462742152960396f\n#endif\n#if SH_BANDS > 2\n\t#define SH_C3_0 -0.5900435899266435f\n\t#define SH_C3_1 2.890611442640554f\n\t#define SH_C3_2 -0.4570457994644658f\n\t#define SH_C3_3 0.3731763325901154f\n\t#define SH_C3_4 -0.4570457994644658f\n\t#define SH_C3_5 1.445305721320277f\n\t#define SH_C3_6 -0.5900435899266435f\n#endif\nvec3 evalSH(in SplatSource source, in vec3 dir) {\n\tvec3 sh[SH_COEFFS];\n\tfloat scale;\n\treadSHData(source, sh, scale);\n\tfloat x = dir.x;\n\tfloat y = dir.y;\n\tfloat z = dir.z;\n\tvec3 result = SH_C1 * (-sh[0] * y + sh[1] * z - sh[2] * x);\n#if SH_BANDS > 1\n\tfloat xx = x * x;\n\tfloat yy = y * y;\n\tfloat zz = z * z;\n\tfloat xy = x * y;\n\tfloat yz = y * z;\n\tfloat xz = x * z;\n\tresult +=\n\t\tsh[3] * (SH_C2_0 * xy) *  +\n\t\tsh[4] * (SH_C2_1 * yz) +\n\t\tsh[5] * (SH_C2_2 * (2.0 * zz - xx - yy)) +\n\t\tsh[6] * (SH_C2_3 * xz) +\n\t\tsh[7] * (SH_C2_4 * (xx - yy));\n#endif\n#if SH_BANDS > 2\n\tresult +=\n\t\tsh[8]  * (SH_C3_0 * y * (3.0 * xx - yy)) +\n\t\tsh[9]  * (SH_C3_1 * xy * z) +\n\t\tsh[10] * (SH_C3_2 * y * (4.0 * zz - xx - yy)) +\n\t\tsh[11] * (SH_C3_3 * z * (2.0 * zz - 3.0 * xx - 3.0 * yy)) +\n\t\tsh[12] * (SH_C3_4 * x * (4.0 * zz - xx - yy)) +\n\t\tsh[13] * (SH_C3_5 * z * (xx - yy)) +\n\t\tsh[14] * (SH_C3_6 * x * (xx - 3.0 * yy));\n#endif\n\treturn result * scale;\n}\n#endif\n',gsplatCompressedDataVS:"\nuniform highp usampler2D packedTexture;\nuniform highp sampler2D chunkTexture;\nvec4 chunkDataA;\nvec4 chunkDataB;\nvec4 chunkDataC;\nvec4 chunkDataD;\nvec4 chunkDataE;\nuvec4 packedData;\nvec3 unpack111011(uint bits) {\n\treturn vec3(\n\t\tfloat(bits >> 21u) / 2047.0,\n\t\tfloat((bits >> 11u) & 0x3ffu) / 1023.0,\n\t\tfloat(bits & 0x7ffu) / 2047.0\n\t);\n}\nvec4 unpack8888(uint bits) {\n\treturn vec4(\n\t\tfloat(bits >> 24u) / 255.0,\n\t\tfloat((bits >> 16u) & 0xffu) / 255.0,\n\t\tfloat((bits >> 8u) & 0xffu) / 255.0,\n\t\tfloat(bits & 0xffu) / 255.0\n\t);\n}\nconst float norm = 1.0 / (sqrt(2.0) * 0.5);\nvec4 unpackRotation(uint bits) {\n\tfloat a = (float((bits >> 20u) & 0x3ffu) / 1023.0 - 0.5) * norm;\n\tfloat b = (float((bits >> 10u) & 0x3ffu) / 1023.0 - 0.5) * norm;\n\tfloat c = (float(bits & 0x3ffu) / 1023.0 - 0.5) * norm;\n\tfloat m = sqrt(1.0 - (a * a + b * b + c * c));\n\tuint mode = bits >> 30u;\n\tif (mode == 0u) return vec4(m, a, b, c);\n\tif (mode == 1u) return vec4(a, m, b, c);\n\tif (mode == 2u) return vec4(a, b, m, c);\n\treturn vec4(a, b, c, m);\n}\nmat3 quatToMat3(vec4 R) {\n\tfloat x = R.x;\n\tfloat y = R.y;\n\tfloat z = R.z;\n\tfloat w = R.w;\n\treturn mat3(\n\t\t1.0 - 2.0 * (z * z + w * w),\n\t\t\t  2.0 * (y * z + x * w),\n\t\t\t  2.0 * (y * w - x * z),\n\t\t\t  2.0 * (y * z - x * w),\n\t\t1.0 - 2.0 * (y * y + w * w),\n\t\t\t  2.0 * (z * w + x * y),\n\t\t\t  2.0 * (y * w + x * z),\n\t\t\t  2.0 * (z * w - x * y),\n\t\t1.0 - 2.0 * (y * y + z * z)\n\t);\n}\nvec3 readCenter(SplatSource source) {\n\tuint w = uint(textureSize(chunkTexture, 0).x) / 5u;\n\tuint chunkId = source.id / 256u;\n\tivec2 chunkUV = ivec2((chunkId % w) * 5u, chunkId / w);\n\tchunkDataA = texelFetch(chunkTexture, chunkUV, 0);\n\tchunkDataB = texelFetch(chunkTexture, chunkUV + ivec2(1, 0), 0);\n\tchunkDataC = texelFetch(chunkTexture, chunkUV + ivec2(2, 0), 0);\n\tchunkDataD = texelFetch(chunkTexture, chunkUV + ivec2(3, 0), 0);\n\tchunkDataE = texelFetch(chunkTexture, chunkUV + ivec2(4, 0), 0);\n\tpackedData = texelFetch(packedTexture, source.uv, 0);\n\treturn mix(chunkDataA.xyz, vec3(chunkDataA.w, chunkDataB.xy), unpack111011(packedData.x));\n}\nvec4 readColor(in SplatSource source) {\n\tvec4 r = unpack8888(packedData.w);\n\treturn vec4(mix(chunkDataD.xyz, vec3(chunkDataD.w, chunkDataE.xy), r.rgb), r.w);\n}\nvec4 getRotation() {\n\treturn unpackRotation(packedData.y);\n}\nvec3 getScale() {\n\treturn exp(mix(vec3(chunkDataB.zw, chunkDataC.x), chunkDataC.yzw, unpack111011(packedData.z)));\n}\nvoid readCovariance(in SplatSource source, out vec3 covA, out vec3 covB) {\n\tmat3 rot = quatToMat3(getRotation());\n\tvec3 scale = getScale();\n\tmat3 M = transpose(mat3(\n\t\tscale.x * rot[0],\n\t\tscale.y * rot[1],\n\t\tscale.z * rot[2]\n\t));\n\tcovA = vec3(dot(M[0], M[0]), dot(M[0], M[1]), dot(M[0], M[2]));\n\tcovB = vec3(dot(M[1], M[1]), dot(M[1], M[2]), dot(M[2], M[2]));\n}\n",gsplatCompressedSHVS:"\n#if SH_BANDS > 0\nuniform highp usampler2D shTexture0;\nuniform highp usampler2D shTexture1;\nuniform highp usampler2D shTexture2;\nvec4 unpack8888s(in uint bits) {\n\treturn vec4((uvec4(bits) >> uvec4(0u, 8u, 16u, 24u)) & 0xffu) * (8.0 / 255.0) - 4.0;\n}\nvoid readSHData(in SplatSource source, out vec3 sh[15], out float scale) {\n\tuvec4 shData0 = texelFetch(shTexture0, source.uv, 0);\n\tuvec4 shData1 = texelFetch(shTexture1, source.uv, 0);\n\tuvec4 shData2 = texelFetch(shTexture2, source.uv, 0);\n\tvec4 r0 = unpack8888s(shData0.x);\n\tvec4 r1 = unpack8888s(shData0.y);\n\tvec4 r2 = unpack8888s(shData0.z);\n\tvec4 r3 = unpack8888s(shData0.w);\n\tvec4 g0 = unpack8888s(shData1.x);\n\tvec4 g1 = unpack8888s(shData1.y);\n\tvec4 g2 = unpack8888s(shData1.z);\n\tvec4 g3 = unpack8888s(shData1.w);\n\tvec4 b0 = unpack8888s(shData2.x);\n\tvec4 b1 = unpack8888s(shData2.y);\n\tvec4 b2 = unpack8888s(shData2.z);\n\tvec4 b3 = unpack8888s(shData2.w);\n\tsh[0] =  vec3(r0.x, g0.x, b0.x);\n\tsh[1] =  vec3(r0.y, g0.y, b0.y);\n\tsh[2] =  vec3(r0.z, g0.z, b0.z);\n\tsh[3] =  vec3(r0.w, g0.w, b0.w);\n\tsh[4] =  vec3(r1.x, g1.x, b1.x);\n\tsh[5] =  vec3(r1.y, g1.y, b1.y);\n\tsh[6] =  vec3(r1.z, g1.z, b1.z);\n\tsh[7] =  vec3(r1.w, g1.w, b1.w);\n\tsh[8] =  vec3(r2.x, g2.x, b2.x);\n\tsh[9] =  vec3(r2.y, g2.y, b2.y);\n\tsh[10] = vec3(r2.z, g2.z, b2.z);\n\tsh[11] = vec3(r2.w, g2.w, b2.w);\n\tsh[12] = vec3(r3.x, g3.x, b3.x);\n\tsh[13] = vec3(r3.y, g3.y, b3.y);\n\tsh[14] = vec3(r3.z, g3.z, b3.z);\n\tscale = 1.0;\n}\n#endif\n",gsplatDataVS:"\nuniform highp usampler2D transformA;\nuniform highp sampler2D transformB;\nuint tAw;\nvec3 readCenter(SplatSource source) {\n\tuvec4 tA = texelFetch(transformA, source.uv, 0);\n\ttAw = tA.w;\n\treturn uintBitsToFloat(tA.xyz);\n}\nvoid readCovariance(in SplatSource source, out vec3 covA, out vec3 covB) {\n\tvec4 tB = texelFetch(transformB, source.uv, 0);\n\tvec2 tC = unpackHalf2x16(tAw);\n\tcovA = tB.xyz;\n\tcovB = vec3(tC.x, tC.y, tB.w);\n}\n",gsplatOutputVS:'\n#include "tonemappingPS"\n#if TONEMAP != NONE\n\t#if GAMMA == SRGB\n\t\t#include "decodePS"\n\t\t#include "gamma2_2PS"\n\t#else\n\t\t#include "gamma1_0PS"\n\t#endif\n#endif\nvec3 prepareOutputFromGamma(vec3 gammaColor) {\n\t#if TONEMAP == NONE\n\t\t#if GAMMA == NONE\n\t\t\treturn decodeGamma(gammaColor);\n\t\t#else\n\t\t\treturn gammaColor;\n\t\t#endif\n\t#else\n\t\treturn gammaCorrectOutput(toneMap(decodeGamma(gammaColor)));\n\t#endif\n}\n',gsplatPS:'\n#ifndef DITHER_NONE\n\t#include "bayerPS"\n\t#include "opacityDitherPS"\n\tvarying float id;\n#endif\n#ifdef PICK_PASS\n\tuniform vec4 uColor;\n#endif\nvarying mediump vec2 gaussianUV;\nvarying mediump vec4 gaussianColor;\nvoid main(void) {\n\tmediump float A = dot(gaussianUV, gaussianUV);\n\tif (A > 1.0) {\n\t\tdiscard;\n\t}\n\tmediump float alpha = exp(-A * 4.0) * gaussianColor.a;\n\t#ifdef PICK_PASS\n\t\tif (alpha < 0.3) {\n\t\t\tdiscard;\n\t\t}\n\t\tgl_FragColor = uColor;\n\t#else\n\t\tif (alpha < 1.0 / 255.0) {\n\t\t\tdiscard;\n\t\t}\n\t\t#ifndef DITHER_NONE\n\t\t\topacityDither(alpha, id * 0.013);\n\t\t#endif\n\t\tgl_FragColor = vec4(gaussianColor.xyz, alpha);\n\t#endif\n}\n',gsplatSHVS:"\n#if SH_BANDS > 0\nvec3 unpack111011s(uint bits) {\n\treturn vec3((uvec3(bits) >> uvec3(21u, 11u, 0u)) & uvec3(0x7ffu, 0x3ffu, 0x7ffu)) / vec3(2047.0, 1023.0, 2047.0) * 2.0 - 1.0;\n}\nvoid fetchScale(in uvec4 t, out float scale, out vec3 a, out vec3 b, out vec3 c) {\n\tscale = uintBitsToFloat(t.x);\n\ta = unpack111011s(t.y);\n\tb = unpack111011s(t.z);\n\tc = unpack111011s(t.w);\n}\nvoid fetch(in uvec4 t, out vec3 a, out vec3 b, out vec3 c, out vec3 d) {\n\ta = unpack111011s(t.x);\n\tb = unpack111011s(t.y);\n\tc = unpack111011s(t.z);\n\td = unpack111011s(t.w);\n}\nvoid fetch(in uint t, out vec3 a) {\n\ta = unpack111011s(t);\n}\n#if SH_BANDS == 1\n\tuniform highp usampler2D splatSH_1to3;\n\tvoid readSHData(in SplatSource source, out vec3 sh[3], out float scale) {\n\t\tfetchScale(texelFetch(splatSH_1to3, source.uv, 0), scale, sh[0], sh[1], sh[2]);\n\t}\n#elif SH_BANDS == 2\n\tuniform highp usampler2D splatSH_1to3;\n\tuniform highp usampler2D splatSH_4to7;\n\tuniform highp usampler2D splatSH_8to11;\n\tvoid readSHData(in SplatSource source, out vec3 sh[8], out float scale) {\n\t\tfetchScale(texelFetch(splatSH_1to3, source.uv, 0), scale, sh[0], sh[1], sh[2]);\n\t\tfetch(texelFetch(splatSH_4to7, source.uv, 0), sh[3], sh[4], sh[5], sh[6]);\n\t\tfetch(texelFetch(splatSH_8to11, source.uv, 0).x, sh[7]);\n\t}\n#else\n\tuniform highp usampler2D splatSH_1to3;\n\tuniform highp usampler2D splatSH_4to7;\n\tuniform highp usampler2D splatSH_8to11;\n\tuniform highp usampler2D splatSH_12to15;\n\tvoid readSHData(in SplatSource source, out vec3 sh[15], out float scale) {\n\t\tfetchScale(texelFetch(splatSH_1to3, source.uv, 0), scale, sh[0], sh[1], sh[2]);\n\t\tfetch(texelFetch(splatSH_4to7, source.uv, 0), sh[3], sh[4], sh[5], sh[6]);\n\t\tfetch(texelFetch(splatSH_8to11, source.uv, 0), sh[7], sh[8], sh[9], sh[10]);\n\t\tfetch(texelFetch(splatSH_12to15, source.uv, 0), sh[11], sh[12], sh[13], sh[14]);\n\t}\n#endif\n#endif\n",gsplatSourceVS:"\nattribute vec3 vertex_position;\nattribute uint vertex_id_attrib;\nuniform uint numSplats;\nuniform highp usampler2D splatOrder;\nbool initSource(out SplatSource source) {\n\tuint w = uint(textureSize(splatOrder, 0).x);\n\tsource.order = vertex_id_attrib + uint(vertex_position.z);\n\tif (source.order >= numSplats) {\n\t\treturn false;\n\t}\n\tivec2 orderUV = ivec2(source.order % w, source.order / w);\n\tsource.id = texelFetch(splatOrder, orderUV, 0).r;\n\tsource.uv = ivec2(source.id % w, source.id / w);\n\tsource.cornerUV = vertex_position.xy;\n\treturn true;\n}\n",gsplatVS:'\n#include "gsplatCommonVS"\nvarying mediump vec2 gaussianUV;\nvarying mediump vec4 gaussianColor;\n#ifndef DITHER_NONE\n\tvarying float id;\n#endif\nmediump vec4 discardVec = vec4(0.0, 0.0, 2.0, 1.0);\nvoid main(void) {\n\tSplatSource source;\n\tif (!initSource(source)) {\n\t\tgl_Position = discardVec;\n\t\treturn;\n\t}\n\tvec3 modelCenter = readCenter(source);\n\tSplatCenter center;\n\tinitCenter(source, modelCenter, center);\n\tSplatCorner corner;\n\tif (!initCorner(source, center, corner)) {\n\t\tgl_Position = discardVec;\n\t\treturn;\n\t}\n\tvec4 clr = readColor(source);\n\t#if SH_BANDS > 0\n\t\tvec3 dir = normalize(center.view * mat3(center.modelView));\n\t\tclr.xyz += evalSH(source, dir);\n\t#endif\n\tclipCorner(corner, clr.w);\n\tgl_Position = center.proj + vec4(corner.offset, 0, 0);\n\tgaussianUV = corner.uv;\n\tgaussianColor = vec4(prepareOutputFromGamma(max(clr.xyz, 0.0)), clr.w);\n\t#ifndef DITHER_NONE\n\t\tid = float(source.id);\n\t#endif\n}\n',iridescenceDiffractionPS:"\nuniform float material_iridescenceRefractionIndex;\n#ifndef PI\n#define PI 3.14159265\n#endif\nfloat iridescence_iorToFresnel(float transmittedIor, float incidentIor) {\n\treturn pow((transmittedIor - incidentIor) / (transmittedIor + incidentIor), 2.0);\n}\nvec3 iridescence_iorToFresnel(vec3 transmittedIor, float incidentIor) {\n\treturn pow((transmittedIor - vec3(incidentIor)) / (transmittedIor + vec3(incidentIor)), vec3(2.0));\n}\nvec3 iridescence_fresnelToIor(vec3 f0) {\n\tvec3 sqrtF0 = sqrt(f0);\n\treturn (vec3(1.0) + sqrtF0) / (vec3(1.0) - sqrtF0);\n}\nvec3 iridescence_sensitivity(float opd, vec3 shift) {\n\tfloat phase = 2.0 * PI * opd * 1.0e-9;\n\tconst vec3 val = vec3(5.4856e-13, 4.4201e-13, 5.2481e-13);\n\tconst vec3 pos = vec3(1.6810e+06, 1.7953e+06, 2.2084e+06);\n\tconst vec3 var = vec3(4.3278e+09, 9.3046e+09, 6.6121e+09);\n\tvec3 xyz = val * sqrt(2.0 * PI * var) * cos(pos * phase + shift) * exp(-pow(phase, 2.0) * var);\n\txyz.x += 9.7470e-14 * sqrt(2.0 * PI * 4.5282e+09) * cos(2.2399e+06 * phase + shift[0]) * exp(-4.5282e+09 * pow(phase, 2.0));\n\txyz /= vec3(1.0685e-07);\n\tconst mat3 XYZ_TO_REC709 = mat3(\n\t\t3.2404542, -0.9692660,  0.0556434,\n\t   -1.5371385,  1.8760108, -0.2040259,\n\t   -0.4985314,  0.0415560,  1.0572252\n\t);\n\treturn XYZ_TO_REC709 * xyz;\n}\nfloat iridescence_fresnel(float cosTheta, float f0) {\n\tfloat x = clamp(1.0 - cosTheta, 0.0, 1.0);\n\tfloat x2 = x * x;\n\tfloat x5 = x * x2 * x2;\n\treturn f0 + (1.0 - f0) * x5;\n} \nvec3 iridescence_fresnel(float cosTheta, vec3 f0) {\n\tfloat x = clamp(1.0 - cosTheta, 0.0, 1.0);\n\tfloat x2 = x * x;\n\tfloat x5 = x * x2 * x2; \n\treturn f0 + (vec3(1.0) - f0) * x5;\n}\nvec3 calcIridescence(float outsideIor, float cosTheta, vec3 base_f0, float iridescenceThickness) {\n\tfloat iridescenceIor = mix(outsideIor, material_iridescenceRefractionIndex, smoothstep(0.0, 0.03, iridescenceThickness));\n\tfloat sinTheta2Sq = pow(outsideIor / iridescenceIor, 2.0) * (1.0 - pow(cosTheta, 2.0));\n\tfloat cosTheta2Sq = 1.0 - sinTheta2Sq;\n\tif (cosTheta2Sq < 0.0) {\n\t\treturn vec3(1.0);\n\t}\n\tfloat cosTheta2 = sqrt(cosTheta2Sq);\n\tfloat r0 = iridescence_iorToFresnel(iridescenceIor, outsideIor);\n\tfloat r12 = iridescence_fresnel(cosTheta, r0);\n\tfloat r21 = r12;\n\tfloat t121 = 1.0 - r12;\n\tfloat phi12 = iridescenceIor < outsideIor ? PI : 0.0;\n\tfloat phi21 = PI - phi12;\n\tvec3 baseIor = iridescence_fresnelToIor(base_f0 + vec3(0.0001));\n\tvec3 r1 = iridescence_iorToFresnel(baseIor, iridescenceIor);\n\tvec3 r23 = iridescence_fresnel(cosTheta2, r1);\n\tvec3 phi23 = vec3(0.0);\n\tif (baseIor[0] < iridescenceIor) phi23[0] = PI;\n\tif (baseIor[1] < iridescenceIor) phi23[1] = PI;\n\tif (baseIor[2] < iridescenceIor) phi23[2] = PI;\n\tfloat opd = 2.0 * iridescenceIor * iridescenceThickness * cosTheta2;\n\tvec3 phi = vec3(phi21) + phi23; \n\tvec3 r123Sq = clamp(r12 * r23, 1e-5, 0.9999);\n\tvec3 r123 = sqrt(r123Sq);\n\tvec3 rs = pow(t121, 2.0) * r23 / (1.0 - r123Sq);\n\tvec3 c0 = r12 + rs;\n\tvec3 i = c0;\n\tvec3 cm = rs - t121;\n\tfor (int m = 1; m <= 2; m++) {\n\t\tcm *= r123;\n\t\tvec3 sm = 2.0 * iridescence_sensitivity(float(m) * opd, float(m) * phi);\n\t\ti += cm * sm;\n\t}\n\treturn max(i, vec3(0.0));\n}\nvec3 getIridescence(float cosTheta, vec3 specularity, float iridescenceThickness) {\n\treturn calcIridescence(1.0, cosTheta, specularity, iridescenceThickness);\n}\n",iridescencePS:"\n#ifdef MAPFLOAT\nuniform float material_iridescence;\n#endif\nvoid getIridescence() {\n\tfloat iridescence = 1.0;\n\t#ifdef MAPFLOAT\n\tiridescence *= material_iridescence;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tiridescence *= texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\t#endif\n\tdIridescence = iridescence; \n}\n",iridescenceThicknessPS:"\nuniform float material_iridescenceThicknessMax;\n#ifdef MAPTEXTURE\nuniform float material_iridescenceThicknessMin;\n#endif\nvoid getIridescenceThickness() {\n\t#ifdef MAPTEXTURE\n\tfloat blend = texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\tfloat iridescenceThickness = mix(material_iridescenceThicknessMin, material_iridescenceThicknessMax, blend);\n\t#else\n\tfloat iridescenceThickness = material_iridescenceThicknessMax;\n\t#endif\n\tdIridescenceThickness = iridescenceThickness; \n}\n",iorPS:"\n#ifdef MAPFLOAT\nuniform float material_refractionIndex;\n#endif\nvoid getIor() {\n#ifdef MAPFLOAT\n\tdIor = material_refractionIndex;\n#else\n\tdIor = 1.0 / 1.5;\n#endif\n}\n",lightDiffuseLambertPS:"\nfloat getLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {\n\treturn max(dot(worldNormal, -lightDirNorm), 0.0);\n}\n",lightDirPointPS:"\nvoid getLightDirPoint(vec3 lightPosW) {\n\tdLightDirW = vPositionW - lightPosW;\n\tdLightDirNormW = normalize(dLightDirW);\n\tdLightPosW = lightPosW;\n}\n",lightmapAddPS:"\nvoid addLightMap(\n\tvec3 lightmap, \n\tvec3 dir, \n\tvec3 worldNormal, \n\tvec3 viewDir, \n\tvec3 reflectionDir, \n\tfloat gloss, \n\tvec3 specularity, \n\tvec3 vertexNormal, \n\tmat3 tbn\n#if defined(LIT_IRIDESCENCE)\n\tvec3 iridescenceFresnel, \n\tfloat iridescenceIntensity\n#endif\n) {\n\tdDiffuseLight += lightmap;\n}\n",lightmapDirAddPS:"\nvoid addLightMap(\n\tvec3 lightmap, \n\tvec3 dir, \n\tvec3 worldNormal, \n\tvec3 viewDir, \n\tvec3 reflectionDir, \n\tfloat gloss, \n\tvec3 specularity, \n\tvec3 vertexNormal, \n\tmat3 tbn\n#if defined(LIT_IRIDESCENCE)\n\tvec3 iridescenceFresnel, \n\tfloat iridescenceIntensity\n#endif\n) {\n\tif (dot(dir, dir) < 0.0001) {\n\t\tdDiffuseLight += lightmap;\n\t} else {\n\t\tfloat vlight = saturate(dot(dir, -vertexNormal));\n\t\tfloat flight = saturate(dot(dir, -worldNormal));\n\t\tfloat nlight = (flight / max(vlight, 0.01)) * 0.5;\n\t\tdDiffuseLight += lightmap * nlight * 2.0;\n\t\tvec3 halfDir = normalize(-dir + viewDir);\n\t\tvec3 specularLight = lightmap * getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, dir, gloss, tbn);\n#ifdef LIT_SPECULAR_FRESNEL\n\t\tspecularLight *= \n\t\t\tgetFresnel(dot(viewDir, halfDir), \n\t\t\tgloss, \n\t\t\tspecularity\n\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t, iridescenceFresnel,\n\t\t\tiridescenceIntensity\n\t\t#endif\n\t\t\t);\n#endif\n\t\tdSpecularLight += specularLight;\n\t}\n}\n",lightmapDirPS:"\nuniform sampler2D texture_lightMap;\nuniform sampler2D texture_dirLightMap;\nvoid getLightMap() {\n\tdLightmap = $DECODE(texture2DBias(texture_lightMap, $UV, textureBias)).$CH;\n\tvec3 dir = texture2DBias(texture_dirLightMap, $UV, textureBias).xyz * 2.0 - 1.0;\n\tfloat dirDot = dot(dir, dir);\n\tdLightmapDir = (dirDot > 0.001) ? dir / sqrt(dirDot) : vec3(0.0);\n}\n",lightmapSinglePS:"\nvoid getLightMap() {\n\tdLightmap = vec3(1.0);\n\t#ifdef MAPTEXTURE\n\tdLightmap *= $DECODE(texture2DBias($SAMPLER, $UV, textureBias)).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdLightmap *= saturate(vVertexColor.$VC);\n\t#endif\n}\n",lightSpecularAnisoGGXPS:"\nfloat calcLightSpecular(float gloss, vec3 worldNormal, vec3 viewDir, vec3 h, vec3 lightDirNorm, mat3 tbn) {\n\tfloat PI = 3.141592653589793;\n\tfloat roughness = max((1.0 - gloss) * (1.0 - gloss), 0.001);\n\tfloat anisotropy = material_anisotropy * roughness;\n \n\tfloat at = max((roughness + anisotropy), roughness / 4.0);\n\tfloat ab = max((roughness - anisotropy), roughness / 4.0);\n\tfloat NoH = dot(worldNormal, h);\n\tfloat ToH = dot(tbn[0], h);\n\tfloat BoH = dot(tbn[1], h);\n\tfloat a2 = at * ab;\n\tvec3 v = vec3(ab * ToH, at * BoH, a2 * NoH);\n\tfloat v2 = dot(v, v);\n\tfloat w2 = a2 / v2;\n\tfloat D = a2 * w2 * w2 * (1.0 / PI);\n\tfloat ToV = dot(tbn[0], viewDir);\n\tfloat BoV = dot(tbn[1], viewDir);\n\tfloat ToL = dot(tbn[0], -lightDirNorm);\n\tfloat BoL = dot(tbn[1], -lightDirNorm);\n\tfloat NoV = dot(worldNormal, viewDir);\n\tfloat NoL = dot(worldNormal, -lightDirNorm);\n\tfloat lambdaV = NoL * length(vec3(at * ToV, ab * BoV, NoV));\n\tfloat lambdaL = NoV * length(vec3(at * ToL, ab * BoL, NoL));\n\tfloat G = 0.5 / (lambdaV + lambdaL);\n\treturn D * G;\n}\nfloat getLightSpecular(vec3 h, vec3 reflDir, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float gloss, mat3 tbn) {\n\treturn calcLightSpecular(gloss, worldNormal, viewDir, h, lightDirNorm, tbn);\n}\n",lightSpecularBlinnPS:"\nfloat calcLightSpecular(float gloss, vec3 worldNormal, vec3 h) {\n\tfloat nh = max( dot( h, worldNormal ), 0.0 );\n\tfloat specPow = exp2(gloss * 11.0);\n\tspecPow = max(specPow, 0.0001);\n\treturn pow(nh, specPow) * (specPow + 2.0) / 8.0;\n}\nfloat getLightSpecular(vec3 h, vec3 reflDir, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float gloss, mat3 tbn) {\n\treturn calcLightSpecular(gloss, worldNormal, h);\n}\n",lightSheenPS:"\nfloat sheenD(vec3 normal, vec3 h, float roughness) {\n\tfloat invR = 1.0 / (roughness * roughness);\n\tfloat cos2h = max(dot(normal, h), 0.0);\n\tcos2h *= cos2h;\n\tfloat sin2h = max(1.0 - cos2h, 0.0078125);\n\treturn (2.0 + invR) * pow(sin2h, invR * 0.5) / (2.0 * PI);\n}\nfloat sheenV(vec3 normal, vec3 viewDir, vec3 light) {\n\tfloat NoV = max(dot(normal, viewDir), 0.000001);\n\tfloat NoL = max(dot(normal, light), 0.000001);\n\treturn 1.0 / (4.0 * (NoL + NoV - NoL * NoV));\n}\nfloat getLightSpecularSheen(vec3 h, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float sheenGloss) {\n\tfloat D = sheenD(worldNormal, h, sheenGloss);\n\tfloat V = sheenV(worldNormal, viewDir, -lightDirNorm);\n\treturn D * V;\n}\n",linearizeDepthPS:"\n#ifndef LINEARIZE_DEPTH\n#define LINEARIZE_DEPTH\nfloat linearizeDepth(float z, vec4 cameraParams) {\n\tif (cameraParams.w == 0.0)\n\t\treturn (cameraParams.z * cameraParams.y) / (cameraParams.y + z * (cameraParams.z - cameraParams.y));\n\telse\n\t\treturn cameraParams.z + z * (cameraParams.y - cameraParams.z);\n}\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\nfloat linearizeDepth(float z) {\n\treturn linearizeDepth(z, camera_params);\n}\n#endif\n",litShaderArgsPS:"\nvec3 litArgs_albedo;\nfloat litArgs_opacity;\nvec3 litArgs_emission;\nvec3 litArgs_worldNormal;\nfloat litArgs_ao;\nvec3 litArgs_lightmap;\nvec3 litArgs_lightmapDir;\nfloat litArgs_metalness;\nvec3 litArgs_specularity;\nfloat litArgs_specularityFactor;\nfloat litArgs_gloss;\nfloat litArgs_sheen_gloss;\nvec3 litArgs_sheen_specularity;\nfloat litArgs_transmission;\nfloat litArgs_thickness;\nfloat litArgs_ior;\nfloat litArgs_dispersion;\nfloat litArgs_iridescence_intensity;\nfloat litArgs_iridescence_thickness;\nvec3 litArgs_clearcoat_worldNormal;\nfloat litArgs_clearcoat_specularity;\nfloat litArgs_clearcoat_gloss;\n",ltcPS:"\nmat3 transposeMat3( const in mat3 m ) {\n\tmat3 tmp;\n\ttmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );\n\ttmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );\n\ttmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );\n\treturn tmp;\n}\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\tfloat dotNV = saturate( dot( N, V ) );\n\tvec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );\n\tuv = uv * LUT_SCALE + LUT_BIAS;\n\treturn uv;\n}\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n\tfloat l = length( f );\n\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n\tfloat x = dot( v1, v2 );\n\tfloat y = abs( x );\n\tfloat a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;\n\tfloat b = 3.4175940 + ( 4.1616724 + y ) * y;\n\tfloat v = a / b;\n\tfloat theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;\n\treturn cross( v1, v2 ) * theta_sintheta;\n}\nstruct Coords {\n\tvec3 coord0;\n\tvec3 coord1;\n\tvec3 coord2;\n\tvec3 coord3;\n};\nfloat LTC_EvaluateRect( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in Coords rectCoords) {\n\tvec3 v1 = rectCoords.coord1 - rectCoords.coord0;\n\tvec3 v2 = rectCoords.coord3 - rectCoords.coord0;\n\t\n\tvec3 lightNormal = cross( v1, v2 );\n\tfloat factor = sign(-dot( lightNormal, P - rectCoords.coord0 ));\n\tvec3 T1, T2;\n\tT1 = normalize( V - N * dot( V, N ) );\n\tT2 =  factor * cross( N, T1 );\n\tmat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );\n\tvec3 coords[ 4 ];\n\tcoords[ 0 ] = mat * ( rectCoords.coord0 - P );\n\tcoords[ 1 ] = mat * ( rectCoords.coord1 - P );\n\tcoords[ 2 ] = mat * ( rectCoords.coord2 - P );\n\tcoords[ 3 ] = mat * ( rectCoords.coord3 - P );\n\tcoords[ 0 ] = normalize( coords[ 0 ] );\n\tcoords[ 1 ] = normalize( coords[ 1 ] );\n\tcoords[ 2 ] = normalize( coords[ 2 ] );\n\tcoords[ 3 ] = normalize( coords[ 3 ] );\n\tvec3 vectorFormFactor = vec3( 0.0 );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n\tfloat result = LTC_ClippedSphereFormFactor( vectorFormFactor );\n\treturn result;\n}\nCoords dLTCCoords;\nCoords getLTCLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){\n\tCoords coords;\n\tcoords.coord0 = lightPos + halfWidth - halfHeight;\n\tcoords.coord1 = lightPos - halfWidth - halfHeight;\n\tcoords.coord2 = lightPos - halfWidth + halfHeight;\n\tcoords.coord3 = lightPos + halfWidth + halfHeight;\n\treturn coords;\n}\nfloat dSphereRadius;\nCoords getSphereLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){\n\tdSphereRadius = max(length(halfWidth), length(halfHeight));\n\tvec3 f = reflect(normalize(lightPos - view_position), vNormalW);\n\tvec3 w = normalize(cross(f, halfHeight));\n\tvec3 h = normalize(cross(f, w));\n\treturn getLTCLightCoords(lightPos, w * dSphereRadius, h * dSphereRadius);\n}\nvec2 dLTCUV;\n#ifdef LIT_CLEARCOAT\nvec2 ccLTCUV;\n#endif\nvec2 getLTCLightUV(float gloss, vec3 worldNormal, vec3 viewDir)\n{\n\tfloat roughness = max((1.0 - gloss) * (1.0 - gloss), 0.001);\n\treturn LTC_Uv( worldNormal, viewDir, roughness );\n}\nvec3 dLTCSpecFres;\n#ifdef LIT_CLEARCOAT\nvec3 ccLTCSpecFres;\n#endif\nvec3 getLTCLightSpecFres(vec2 uv, vec3 specularity)\n{\n\tvec4 t2 = texture2DLodEXT(areaLightsLutTex2, uv, 0.0);\n\treturn specularity * t2.x + ( vec3( 1.0 ) - specularity) * t2.y;\n}\nvoid calcLTCLightValues(float gloss, vec3 worldNormal, vec3 viewDir, vec3 specularity, float clearcoatGloss, vec3 clearcoatWorldNormal, float clearcoatSpecularity)\n{\n\tdLTCUV = getLTCLightUV(gloss, worldNormal, viewDir);\n\tdLTCSpecFres = getLTCLightSpecFres(dLTCUV, specularity); \n#ifdef LIT_CLEARCOAT\n\tccLTCUV = getLTCLightUV(clearcoatGloss, clearcoatWorldNormal, viewDir);\n\tccLTCSpecFres = getLTCLightSpecFres(ccLTCUV, vec3(clearcoatSpecularity));\n#endif\n}\nvoid calcRectLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)\n{\n\tdLTCCoords = getLTCLightCoords(lightPos, halfWidth, halfHeight);\n}\nvoid calcDiskLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)\n{\n\tcalcRectLightValues(lightPos, halfWidth, halfHeight);\n}\nvoid calcSphereLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)\n{\n\tdLTCCoords = getSphereLightCoords(lightPos, halfWidth, halfHeight);\n}\nvec3 SolveCubic(vec4 Coefficient)\n{\n\tfloat pi = 3.14159;\n\tCoefficient.xyz /= Coefficient.w;\n\tCoefficient.yz /= 3.0;\n\tfloat A = Coefficient.w;\n\tfloat B = Coefficient.z;\n\tfloat C = Coefficient.y;\n\tfloat D = Coefficient.x;\n\tvec3 Delta = vec3(\n\t\t-Coefficient.z * Coefficient.z + Coefficient.y,\n\t\t-Coefficient.y * Coefficient.z + Coefficient.x,\n\t\tdot(vec2(Coefficient.z, -Coefficient.y), Coefficient.xy)\n\t);\n\tfloat Discriminant = dot(vec2(4.0 * Delta.x, -Delta.y), Delta.zy);\n\tvec3 RootsA, RootsD;\n\tvec2 xlc, xsc;\n\t{\n\t\tfloat A_a = 1.0;\n\t\tfloat C_a = Delta.x;\n\t\tfloat D_a = -2.0 * B * Delta.x + Delta.y;\n\t\tfloat Theta = atan(sqrt(Discriminant), -D_a) / 3.0;\n\t\tfloat x_1a = 2.0 * sqrt(-C_a) * cos(Theta);\n\t\tfloat x_3a = 2.0 * sqrt(-C_a) * cos(Theta + (2.0 / 3.0) * pi);\n\t\tfloat xl;\n\t\tif ((x_1a + x_3a) > 2.0 * B)\n\t\t\txl = x_1a;\n\t\telse\n\t\t\txl = x_3a;\n\t\txlc = vec2(xl - B, A);\n\t}\n\t{\n\t\tfloat A_d = D;\n\t\tfloat C_d = Delta.z;\n\t\tfloat D_d = -D * Delta.y + 2.0 * C * Delta.z;\n\t\tfloat Theta = atan(D * sqrt(Discriminant), -D_d) / 3.0;\n\t\tfloat x_1d = 2.0 * sqrt(-C_d) * cos(Theta);\n\t\tfloat x_3d = 2.0 * sqrt(-C_d) * cos(Theta + (2.0 / 3.0) * pi);\n\t\tfloat xs;\n\t\tif (x_1d + x_3d < 2.0 * C)\n\t\t\txs = x_1d;\n\t\telse\n\t\t\txs = x_3d;\n\t\txsc = vec2(-D, xs + C);\n\t}\n\tfloat E =  xlc.y * xsc.y;\n\tfloat F = -xlc.x * xsc.y - xlc.y * xsc.x;\n\tfloat G =  xlc.x * xsc.x;\n\tvec2 xmc = vec2(C * F - B * G, -B * F + C * E);\n\tvec3 Root = vec3(xsc.x / xsc.y, xmc.x / xmc.y, xlc.x / xlc.y);\n\tif (Root.x < Root.y && Root.x < Root.z)\n\t\tRoot.xyz = Root.yxz;\n\telse if (Root.z < Root.x && Root.z < Root.y)\n\t\tRoot.xyz = Root.xzy;\n\treturn Root;\n}\nfloat LTC_EvaluateDisk(vec3 N, vec3 V, vec3 P, mat3 Minv, Coords points)\n{\n\tvec3 T1, T2;\n\tT1 = normalize(V - N * dot(V, N));\n\tT2 = cross(N, T1);\n\tmat3 R = transposeMat3( mat3( T1, T2, N ) );\n\tvec3 L_[ 3 ];\n\tL_[ 0 ] = R * ( points.coord0 - P );\n\tL_[ 1 ] = R * ( points.coord1 - P );\n\tL_[ 2 ] = R * ( points.coord2 - P );\n\tvec3 Lo_i = vec3(0);\n\tvec3 C  = 0.5 * (L_[0] + L_[2]);\n\tvec3 V1 = 0.5 * (L_[1] - L_[2]);\n\tvec3 V2 = 0.5 * (L_[1] - L_[0]);\n\tC  = Minv * C;\n\tV1 = Minv * V1;\n\tV2 = Minv * V2;\n\tfloat a, b;\n\tfloat d11 = dot(V1, V1);\n\tfloat d22 = dot(V2, V2);\n\tfloat d12 = dot(V1, V2);\n\tif (abs(d12) / sqrt(d11 * d22) > 0.0001)\n\t{\n\t\tfloat tr = d11 + d22;\n\t\tfloat det = -d12 * d12 + d11 * d22;\n\t\tdet = sqrt(det);\n\t\tfloat u = 0.5 * sqrt(tr - 2.0 * det);\n\t\tfloat v = 0.5 * sqrt(tr + 2.0 * det);\n\t\tfloat e_max = (u + v) * (u + v);\n\t\tfloat e_min = (u - v) * (u - v);\n\t\tvec3 V1_, V2_;\n\t\tif (d11 > d22)\n\t\t{\n\t\t\tV1_ = d12 * V1 + (e_max - d11) * V2;\n\t\t\tV2_ = d12 * V1 + (e_min - d11) * V2;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tV1_ = d12*V2 + (e_max - d22)*V1;\n\t\t\tV2_ = d12*V2 + (e_min - d22)*V1;\n\t\t}\n\t\ta = 1.0 / e_max;\n\t\tb = 1.0 / e_min;\n\t\tV1 = normalize(V1_);\n\t\tV2 = normalize(V2_);\n\t}\n\telse\n\t{\n\t\ta = 1.0 / dot(V1, V1);\n\t\tb = 1.0 / dot(V2, V2);\n\t\tV1 *= sqrt(a);\n\t\tV2 *= sqrt(b);\n\t}\n\tvec3 V3 = normalize(cross(V1, V2));\n\tif (dot(C, V3) < 0.0)\n\t\tV3 *= -1.0;\n\tfloat L  = dot(V3, C);\n\tfloat x0 = dot(V1, C) / L;\n\tfloat y0 = dot(V2, C) / L;\n\tfloat E1 = inversesqrt(a);\n\tfloat E2 = inversesqrt(b);\n\ta *= L * L;\n\tb *= L * L;\n\tfloat c0 = a * b;\n\tfloat c1 = a * b * (1.0 + x0 * x0 + y0 * y0) - a - b;\n\tfloat c2 = 1.0 - a * (1.0 + x0 * x0) - b * (1.0 + y0 * y0);\n\tfloat c3 = 1.0;\n\tvec3 roots = SolveCubic(vec4(c0, c1, c2, c3));\n\tfloat e1 = roots.x;\n\tfloat e2 = roots.y;\n\tfloat e3 = roots.z;\n\tvec3 avgDir = vec3(a * x0 / (a - e2), b * y0 / (b - e2), 1.0);\n\tmat3 rotate = mat3(V1, V2, V3);\n\tavgDir = rotate * avgDir;\n\tavgDir = normalize(avgDir);\n\tfloat L1 = sqrt(-e2 / e3);\n\tfloat L2 = sqrt(-e2 / e1);\n\tfloat formFactor = max(0.0, L1 * L2 * inversesqrt((1.0 + L1 * L1) * (1.0 + L2 * L2)));\n\t\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\tvec2 uv = vec2(avgDir.z * 0.5 + 0.5, formFactor);\n\tuv = uv*LUT_SCALE + LUT_BIAS;\n\tfloat scale = texture2DLodEXT(areaLightsLutTex2, uv, 0.0).w;\n\treturn formFactor*scale;\n}\nfloat getRectLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {\n\treturn LTC_EvaluateRect( worldNormal, viewDir, vPositionW, mat3( 1.0 ), dLTCCoords );\n}\nfloat getDiskLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {\n\treturn LTC_EvaluateDisk( worldNormal, viewDir, vPositionW, mat3( 1.0 ), dLTCCoords );\n}\nfloat getSphereLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {\n\tfloat falloff = dSphereRadius / (dot(lightDir, lightDir) + dSphereRadius);\n\treturn getLightDiffuse(worldNormal, viewDir, lightDir, lightDirNorm) * falloff;\n}\nmat3 getLTCLightInvMat(vec2 uv)\n{\n\tvec4 t1 = texture2DLodEXT(areaLightsLutTex1, uv, 0.0);\n\treturn mat3(\n\t\tvec3( t1.x, 0, t1.y ),\n\t\tvec3(\t0, 1,\t0 ),\n\t\tvec3( t1.z, 0, t1.w )\n\t);\n}\nfloat calcRectLightSpecular(vec3 worldNormal, vec3 viewDir, vec2 uv) {\n\tmat3 mInv = getLTCLightInvMat(uv);\n\treturn LTC_EvaluateRect( worldNormal, viewDir, vPositionW, mInv, dLTCCoords );\n}\nfloat getRectLightSpecular(vec3 worldNormal, vec3 viewDir) {\n\treturn calcRectLightSpecular(worldNormal, viewDir, dLTCUV);\n}\nfloat calcDiskLightSpecular(vec3 worldNormal, vec3 viewDir, vec2 uv) {\n\tmat3 mInv = getLTCLightInvMat(uv);\n\treturn LTC_EvaluateDisk( worldNormal, viewDir, vPositionW, mInv, dLTCCoords );\n}\nfloat getDiskLightSpecular(vec3 worldNormal, vec3 viewDir) {\n\treturn calcDiskLightSpecular(worldNormal, viewDir, dLTCUV);\n}\nfloat getSphereLightSpecular(vec3 worldNormal, vec3 viewDir) {\n\treturn calcDiskLightSpecular(worldNormal, viewDir, dLTCUV);\n}\n",metalnessPS:"\n#ifdef MAPFLOAT\nuniform float material_metalness;\n#endif\nvoid getMetalness() {\n\tfloat metalness = 1.0;\n\t#ifdef MAPFLOAT\n\tmetalness *= material_metalness;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tmetalness *= texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tmetalness *= saturate(vVertexColor.$VC);\n\t#endif\n\tdMetalness = metalness;\n}\n",metalnessModulatePS:"\nvec3 getSpecularModulate(in vec3 specularity, in vec3 albedo, in float metalness, in float f0) {\n\tvec3 dielectricF0 = f0 * specularity;\n\treturn mix(dielectricF0, albedo, metalness);\n}\nvec3 getAlbedoModulate(in vec3 albedo, in float metalness) {\n\treturn albedo * (1.0 - metalness);\n}\n",msdfPS:"\nuniform sampler2D texture_msdfMap;\nfloat median(float r, float g, float b) {\n\treturn max(min(r, g), min(max(r, g), b));\n}\nfloat map (float min, float max, float v) {\n\treturn (v - min) / (max - min);\n}\nuniform float font_sdfIntensity;\nuniform float font_pxrange;\nuniform float font_textureWidth;\n#ifdef UNIFORM_TEXT_PARAMETERS\nuniform vec4 outline_color;\nuniform float outline_thickness;\nuniform vec4 shadow_color;\nuniform vec2 shadow_offset;\n#else\nvarying vec4 outline_color;\nvarying float outline_thickness;\nvarying vec4 shadow_color;\nvarying vec2 shadow_offset;\n#endif\nvec4 applyMsdf(vec4 color) {\n\tvec3 tsample = texture2D(texture_msdfMap, vUv0).rgb;\n\tvec2 uvShdw = vUv0 - shadow_offset;\n\tvec3 ssample = texture2D(texture_msdfMap, uvShdw).rgb;\n\tfloat sigDist = median(tsample.r, tsample.g, tsample.b);\n\tfloat sigDistShdw = median(ssample.r, ssample.g, ssample.b);\n\tfloat smoothingMax = 0.2;\n\tvec2 w = fwidth(vUv0);\n\tfloat smoothing = clamp(w.x * font_textureWidth / font_pxrange, 0.0, smoothingMax);\n\tfloat mapMin = 0.05;\n\tfloat mapMax = clamp(1.0 - font_sdfIntensity, mapMin, 1.0);\n\tfloat sigDistInner = map(mapMin, mapMax, sigDist);\n\tfloat sigDistOutline = map(mapMin, mapMax, sigDist + outline_thickness);\n\tsigDistShdw = map(mapMin, mapMax, sigDistShdw + outline_thickness);\n\tfloat center = 0.5;\n\tfloat inside = smoothstep(center-smoothing, center+smoothing, sigDistInner);\n\tfloat outline = smoothstep(center-smoothing, center+smoothing, sigDistOutline);\n\tfloat shadow = smoothstep(center-smoothing, center+smoothing, sigDistShdw);\n\tvec4 tcolor = (outline > inside) ? outline * vec4(outline_color.a * outline_color.rgb, outline_color.a) : vec4(0.0);\n\ttcolor = mix(tcolor, color, inside);\n\tvec4 scolor = (shadow > outline) ? shadow * vec4(shadow_color.a * shadow_color.rgb, shadow_color.a) : tcolor;\n\ttcolor = mix(scolor, tcolor, outline);\n\t\n\treturn tcolor;\n}\n",msdfVS:"\nattribute vec3 vertex_outlineParameters;\nattribute vec3 vertex_shadowParameters;\nvarying vec4 outline_color;\nvarying float outline_thickness;\nvarying vec4 shadow_color;\nvarying vec2 shadow_offset;\nvoid unpackMsdfParams() {\n\tvec3 little = mod(vertex_outlineParameters, 256.);\n\tvec3 big = (vertex_outlineParameters - little) / 256.;\n\toutline_color.rb = little.xy / 255.;\n\toutline_color.ga = big.xy / 255.;\n\toutline_thickness = little.z / 255. * 0.2;\n\tlittle = mod(vertex_shadowParameters, 256.);\n\tbig = (vertex_shadowParameters - little) / 256.;\n\tshadow_color.rb = little.xy / 255.;\n\tshadow_color.ga = big.xy / 255.;\n\tshadow_offset = (vec2(little.z, big.z) / 127. - 1.) * 0.005;\n}\n",normalVS:"\nmat3 dNormalMatrix;\nvec3 getNormal() {\n\tdNormalMatrix = getNormalMatrix(dModelMatrix);\n\tvec3 localNormal = getLocalNormal(vertex_normal);\n\treturn normalize(dNormalMatrix * localNormal);\n}\n",normalCoreVS:"\nattribute vec3 vertex_normal;\n#ifdef MORPHING_NORMAL\n\t#ifdef MORPHING_INT\n\t\tuniform highp usampler2D morphNormalTex;\n\t#else\n\t\tuniform highp sampler2D morphNormalTex;\n\t#endif\n#endif\nvec3 getLocalNormal(vec3 vertexNormal) {\n\tvec3 localNormal = vertex_normal;\n\t#ifdef MORPHING_NORMAL\n\t\tivec2 morphUV = getTextureMorphCoords();\n\t\t#ifdef MORPHING_INT\n\t\t\tvec3 morphNormal = vec3(texelFetch(morphNormalTex, ivec2(morphUV), 0).xyz) / 65535.0 * 2.0 - 1.0;\n\t\t#else\n\t\t\tvec3 morphNormal = texelFetch(morphNormalTex, ivec2(morphUV), 0).xyz;\n\t\t#endif\n\t\tlocalNormal += morphNormal;\n\t#endif\n\treturn localNormal;\n}\n#ifdef SKIN\n\tmat3 getNormalMatrix(mat4 modelMatrix) {\n\t\treturn mat3(modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz);\n\t}\n#elif defined(INSTANCING)\n\tmat3 getNormalMatrix(mat4 modelMatrix) {\n\t\treturn mat3(modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz);\n\t}\n#else\n\tmat3 getNormalMatrix(mat4 modelMatrix) {\n\t\treturn matrix_normal;\n\t}\n#endif\n",normalDetailMapPS:"\n#ifdef MAPTEXTURE\nuniform float material_normalDetailMapBumpiness;\nvec3 blendNormals(vec3 n1, vec3 n2) {\n\tn1 += vec3(0, 0, 1);\n\tn2 *= vec3(-1, -1, 1);\n\treturn n1 * dot(n1, n2) / n1.z - n2;\n}\n#endif\nvec3 addNormalDetail(vec3 normalMap) {\n#ifdef MAPTEXTURE\n\tvec3 normalDetailMap = unpackNormal(texture2DBias($SAMPLER, $UV, textureBias));\n\tnormalDetailMap = mix(vec3(0.0, 0.0, 1.0), normalDetailMap, material_normalDetailMapBumpiness);\n\treturn blendNormals(normalMap, normalDetailMap);\n#else\n\treturn normalMap;\n#endif\n}\n",normalMapPS:"\n#ifdef MAPTEXTURE\nuniform float material_bumpiness;\n#endif\nvoid getNormal() {\n#ifdef MAPTEXTURE\n\tvec3 normalMap = unpackNormal(texture2DBias($SAMPLER, $UV, textureBias));\n\tnormalMap = mix(vec3(0.0, 0.0, 1.0), normalMap, material_bumpiness);\n\tdNormalW = normalize(dTBN * addNormalDetail(normalMap));\n#else\n\tdNormalW = dVertexNormalW;\n#endif\n}\n",normalXYPS:"\nvec3 unpackNormal(vec4 nmap) {\n\tvec3 normal;\n\tnormal.xy = nmap.wy * 2.0 - 1.0;\n\tnormal.z = sqrt(1.0 - saturate(dot(normal.xy, normal.xy)));\n\treturn normal;\n}\n",normalXYZPS:"\nvec3 unpackNormal(vec4 nmap) {\n\treturn nmap.xyz * 2.0 - 1.0;\n}\n",opacityPS:"\nuniform float material_opacity;\nvoid getOpacity() {\n\tdAlpha = material_opacity;\n\t#ifdef MAPTEXTURE\n\tdAlpha *= texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdAlpha *= clamp(vVertexColor.$VC, 0.0, 1.0);\n\t#endif\n}\n",opacityDitherPS:"\nuniform vec4 blueNoiseJitter;\n#ifdef DITHER_BLUENOISE\n\tuniform sampler2D blueNoiseTex32;\n#endif\nvoid opacityDither(float alpha, float id) {\n\t#ifdef DITHER_BAYER8\n\t\tfloat noise = bayer8(floor(mod(gl_FragCoord.xy + blueNoiseJitter.xy + id, 8.0))) / 64.0;\n\t#else\n\t\t#ifdef DITHER_BLUENOISE\n\t\t\tvec2 uv = fract(gl_FragCoord.xy / 32.0 + blueNoiseJitter.xy + id);\n\t\t\tfloat noise = texture2DLodEXT(blueNoiseTex32, uv, 0.0).y;\n\t\t#endif\n\t\t#ifdef DITHER_IGNNOISE\n\t\t\tvec3 magic = vec3(0.06711056, 0.00583715, 52.9829189);\n\t\t\tfloat noise = fract(magic.z * fract(dot(gl_FragCoord.xy + blueNoiseJitter.xy + id, magic.xy)));\n\t\t#endif\n\t#endif\n\tnoise = pow(noise, 2.2);\n\tif (alpha < noise)\n\t\tdiscard;\n}\n",outputPS:"\n",outputAlphaPS:"\ngl_FragColor.a = litArgs_opacity;\n",outputAlphaOpaquePS:"\n\tgl_FragColor.a = 1.0;\n",outputAlphaPremulPS:"\ngl_FragColor.rgb *= litArgs_opacity;\ngl_FragColor.a = litArgs_opacity;\n",outputTex2DPS:"\nvarying vec2 vUv0;\nuniform sampler2D source;\nvoid main(void) {\n\tgl_FragColor = texture2D(source, vUv0);\n}\n",sheenPS:"\nuniform vec3 material_sheen;\nvoid getSheen() {\n\tvec3 sheenColor = material_sheen;\n\t#ifdef MAPTEXTURE\n\tsheenColor *= $DECODE(texture2DBias($SAMPLER, $UV, textureBias)).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tsheenColor *= saturate(vVertexColor.$VC);\n\t#endif\n\tsSpecularity = sheenColor;\n}\n",sheenGlossPS:"\nuniform float material_sheenGloss;\nvoid getSheenGlossiness() {\n\tfloat sheenGlossiness = material_sheenGloss;\n\t#ifdef MAPTEXTURE\n\tsheenGlossiness *= texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tsheenGlossiness *= saturate(vVertexColor.$VC);\n\t#endif\n\t#ifdef MAPINVERT\n\tsheenGlossiness = 1.0 - sheenGlossiness;\n\t#endif\n\tsheenGlossiness += 0.0000001;\n\tsGlossiness = sheenGlossiness;\n}\n",parallaxPS:"\nuniform float material_heightMapFactor;\nvoid getParallax() {\n\tfloat parallaxScale = material_heightMapFactor;\n\tfloat height = texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\theight = height * parallaxScale - parallaxScale*0.5;\n\tvec3 viewDirT = dViewDirW * dTBN;\n\tviewDirT.z += 0.42;\n\tdUvOffset = height * (viewDirT.xy / viewDirT.z);\n}\n",particlePS:"\nvarying vec4 texCoordsAlphaLife;\nuniform sampler2D colorMap;\nuniform sampler2D colorParam;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\nuniform float softening;\nuniform float colorMult;\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvoid main(void) {\n\tvec4 tex  = texture2D(colorMap, vec2(texCoordsAlphaLife.x, 1.0 - texCoordsAlphaLife.y));\n\tvec4 ramp = texture2D(colorParam, vec2(texCoordsAlphaLife.w, 0.0));\n\tramp.rgb *= colorMult;\n\tramp.a += texCoordsAlphaLife.z;\n\tvec3 rgb = tex.rgb * ramp.rgb;\n\tfloat a  = tex.a * ramp.a;\n",particleVS:"\nvec3 unpack3NFloats(float src) {\n\tfloat r = fract(src);\n\tfloat g = fract(src * 256.0);\n\tfloat b = fract(src * 65536.0);\n\treturn vec3(r, g, b);\n}\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec4 tex1Dlod_lerp(TEXTURE_ACCEPT_HIGHP(tex), vec2 tc) {\n\treturn mix( texture2D(tex,tc), texture2D(tex,tc + graphSampleSize), fract(tc.x*graphNumSamples) );\n}\nvec4 tex1Dlod_lerp(TEXTURE_ACCEPT_HIGHP(tex), vec2 tc, out vec3 w) {\n\tvec4 a = texture2D(tex,tc);\n\tvec4 b = texture2D(tex,tc + graphSampleSize);\n\tfloat c = fract(tc.x*graphNumSamples);\n\tvec3 unpackedA = unpack3NFloats(a.w);\n\tvec3 unpackedB = unpack3NFloats(b.w);\n\tw = mix(unpackedA, unpackedB, c);\n\treturn mix(a, b, c);\n}\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix) {\n\tfloat c = cos(pRotation);\n\tfloat s = sin(pRotation);\n\tmat2 m = mat2(c, -s, s, c);\n\trotMatrix = m;\n\treturn m * quadXY;\n}\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY) {\n\t#ifdef SCREEN_SPACE\n\t\tvec3 pos = vec3(-1, 0, 0) * quadXY.x + vec3(0, -1, 0) * quadXY.y;\n\t#else\n\t\tvec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n\t#endif\n\treturn pos;\n}\nvec3 customFace(vec3 InstanceCoords, vec2 quadXY) {\n\tvec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;\n\treturn pos;\n}\nvec2 safeNormalize(vec2 v) {\n\tfloat l = length(v);\n\treturn (l > 1e-06) ? v / l : v;\n}\nvoid main(void) {\n\tvec3 meshLocalPos = particle_vertexData.xyz;\n\tfloat id = floor(particle_vertexData.w);\n\tfloat rndFactor = fract(sin(id + 1.0 + seed));\n\tvec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n\tfloat uv = id / numParticlesPot;\n\treadInput(uv);\n#ifdef LOCAL_SPACE\n\tinVel = mat3(matrix_model) * inVel;\n#endif\n\tvec2 velocityV = safeNormalize((mat3(matrix_view) * inVel).xy);\n\tfloat particleLifetime = lifetime;\n\tif (inLife <= 0.0 || inLife > particleLifetime || !inShow) meshLocalPos = vec3(0.0);\n\tvec2 quadXY = meshLocalPos.xy;\n\tfloat nlife = clamp(inLife / particleLifetime, 0.0, 1.0);\n\tvec3 paramDiv;\n\tvec4 params = tex1Dlod_lerp(TEXTURE_PASS(internalTex2), vec2(nlife, 0), paramDiv);\n\tfloat scale = params.y;\n\tfloat scaleDiv = paramDiv.x;\n\tfloat alphaDiv = paramDiv.z;\n\tscale += (scaleDiv * 2.0 - 1.0) * scaleDivMult * fract(rndFactor*10000.0);\n#ifndef USE_MESH\n\ttexCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);\n#else\n\ttexCoordsAlphaLife = vec4(particle_uv, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);\n#endif\n\tvec3 particlePos = inPos;\n\tvec3 particlePosMoved = vec3(0.0);\n\tmat2 rotMatrix;\n",particleAnimFrameClampVS:"\n\tfloat animFrame = min(floor(texCoordsAlphaLife.w * animTexParams.y) + animTexParams.x, animTexParams.z);\n",particleAnimFrameLoopVS:"\n\tfloat animFrame = floor(mod(texCoordsAlphaLife.w * animTexParams.y + animTexParams.x, animTexParams.z + 1.0));\n",particleAnimTexVS:"\n\tfloat animationIndex;\n\tif (animTexIndexParams.y == 1.0) {\n\t\tanimationIndex = floor((animTexParams.w + 1.0) * rndFactor3.z) * (animTexParams.z + 1.0);\n\t} else {\n\t\tanimationIndex = animTexIndexParams.x * (animTexParams.z + 1.0);\n\t}\n\tfloat atlasX = (animationIndex + animFrame) * animTexTilesParams.x;\n\tfloat atlasY = 1.0 - floor(atlasX + 1.0) * animTexTilesParams.y;\n\tatlasX = fract(atlasX);\n\ttexCoordsAlphaLife.xy *= animTexTilesParams.xy;\n\ttexCoordsAlphaLife.xy += vec2(atlasX, atlasY);\n",particleInputFloatPS:"\nvoid readInput(float uv) {\n\tvec4 tex = texture2D(particleTexIN, vec2(uv, 0.25));\n\tvec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.75));\n\tinPos = tex.xyz;\n\tinVel = tex2.xyz;\n\tinAngle = (tex.w < 0.0? -tex.w : tex.w) - 1000.0;\n\tinShow = tex.w >= 0.0;\n\tinLife = tex2.w;\n}\n",particleInputRgba8PS:"\n#define PI2 6.283185307179586\nuniform vec3 inBoundsSize;\nuniform vec3 inBoundsCenter;\nuniform float maxVel;\nfloat decodeFloatRG(vec2 rg) {\n\treturn rg.y*(1.0/255.0) + rg.x;\n}\nfloat decodeFloatRGBA( vec4 rgba ) {\n\treturn dot( rgba, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0) );\n}\nvoid readInput(float uv) {\n\tvec4 tex0 = texture2D(particleTexIN, vec2(uv, 0.125));\n\tvec4 tex1 = texture2D(particleTexIN, vec2(uv, 0.375));\n\tvec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.625));\n\tvec4 tex3 = texture2D(particleTexIN, vec2(uv, 0.875));\n\tinPos = vec3(decodeFloatRG(tex0.rg), decodeFloatRG(tex0.ba), decodeFloatRG(tex1.rg));\n\tinPos = (inPos - vec3(0.5)) * inBoundsSize + inBoundsCenter;\n\tinVel = tex2.xyz;\n\tinVel = (inVel - vec3(0.5)) * maxVel;\n\tinAngle = decodeFloatRG(tex1.ba) * PI2;\n\tinShow = tex2.a > 0.5;\n\tinLife = decodeFloatRGBA(tex3);\n\tfloat maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n\tfloat maxPosLife = lifetime+1.0;\n\tinLife = inLife * (maxNegLife + maxPosLife) - maxNegLife;\n}\n",particleOutputFloatPS:"\nvoid writeOutput() {\n\tif (gl_FragCoord.y<1.0) {\n\t\tgl_FragColor = vec4(outPos, (outAngle + 1000.0) * visMode);\n\t} else {\n\t\tgl_FragColor = vec4(outVel, outLife);\n\t}\n}\n",particleOutputRgba8PS:"\nuniform vec3 outBoundsMul;\nuniform vec3 outBoundsAdd;\nvec2 encodeFloatRG( float v ) {\n\tvec2 enc = vec2(1.0, 255.0) * v;\n\tenc = fract(enc);\n\tenc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n\treturn enc;\n}\nvec4 encodeFloatRGBA( float v ) {\n\tvec4 enc = vec4(1.0, 255.0, 65025.0, 160581375.0) * v;\n\tenc = fract(enc);\n\tenc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);\n\treturn enc;\n}\nvoid writeOutput() {\n\toutPos = outPos * outBoundsMul + outBoundsAdd;\n\toutAngle = fract(outAngle / PI2);\n\toutVel = (outVel / maxVel) + vec3(0.5);\n\tfloat maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n\tfloat maxPosLife = lifetime+1.0;\n\toutLife = (outLife + maxNegLife) / (maxNegLife + maxPosLife);\n\tif (gl_FragCoord.y < 1.0) {\n\t\tgl_FragColor = vec4(encodeFloatRG(outPos.x), encodeFloatRG(outPos.y));\n\t} else if (gl_FragCoord.y < 2.0) {\n\t\tgl_FragColor = vec4(encodeFloatRG(outPos.z), encodeFloatRG(outAngle));\n\t} else if (gl_FragCoord.y < 3.0) {\n\t\tgl_FragColor = vec4(outVel, visMode*0.5+0.5);\n\t} else {\n\t\tgl_FragColor = encodeFloatRGBA(outLife);\n\t}\n}\n",particleUpdaterAABBPS:"\nuniform mat3 spawnBounds;\nuniform vec3 spawnPosInnerRatio;\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n\tvec3 pos = inBounds - vec3(0.5);\n\tvec3 posAbs = abs(pos);\n\tvec3 maxPos = vec3(max(posAbs.x, max(posAbs.y, posAbs.z)));\n\tvec3 edge = maxPos + (vec3(0.5) - maxPos) * spawnPosInnerRatio;\n\tpos.x = edge.x * (maxPos.x == posAbs.x ? sign(pos.x) : 2.0 * pos.x);\n\tpos.y = edge.y * (maxPos.y == posAbs.y ? sign(pos.y) : 2.0 * pos.y);\n\tpos.z = edge.z * (maxPos.z == posAbs.z ? sign(pos.z) : 2.0 * pos.z);\n#ifndef LOCAL_SPACE\n\treturn emitterPos + spawnBounds * pos;\n#else\n\treturn spawnBounds * pos;\n#endif\n}\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n\tlocalVelocity -= vec3(0, 0, initialVelocity);\n}\n",particleUpdaterEndPS:"\n\twriteOutput();\n}\n",particleUpdaterInitPS:"\nvarying vec2 vUv0;\nuniform highp sampler2D particleTexIN;\nuniform highp sampler2D internalTex0;\nuniform highp sampler2D internalTex1;\nuniform highp sampler2D internalTex2;\nuniform highp sampler2D internalTex3;\nuniform mat3 emitterMatrix;\nuniform mat3 emitterMatrixInv;\nuniform vec3 emitterScale;\nuniform vec3 emitterPos;\nuniform vec3 frameRandom;\nuniform vec3 localVelocityDivMult;\nuniform vec3 velocityDivMult;\nuniform float delta;\nuniform float rate;\nuniform float rateDiv;\nuniform float lifetime;\nuniform float numParticles;\nuniform float rotSpeedDivMult;\nuniform float radialSpeedDivMult;\nuniform float seed;\nuniform float startAngle;\nuniform float startAngle2;\nuniform float initialVelocity;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\nfloat visMode;\nvec3 outPos;\nvec3 outVel;\nfloat outAngle;\nbool outShow;\nfloat outLife;\n",particleUpdaterNoRespawnPS:"\n\tif (outLife >= lifetime) {\n\t\toutLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n\t\tvisMode = -1.0;\n\t}\n",particleUpdaterOnStopPS:"\n\tvisMode = outLife < 0.0? -1.0: visMode;\n",particleUpdaterRespawnPS:"\n\tif (outLife >= lifetime) {\n\t\toutLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n\t\tvisMode = 1.0;\n\t}\n\tvisMode = outLife < 0.0? 1.0: visMode;\n",particleUpdaterSpherePS:"\nuniform float spawnBoundsSphere;\nuniform float spawnBoundsSphereInnerRatio;\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n\tfloat rnd4 = fract(rndFactor * 1000.0);\n\tvec3 norm = normalize(inBounds.xyz - vec3(0.5));\n\tfloat r = rnd4 * (1.0 - spawnBoundsSphereInnerRatio) + spawnBoundsSphereInnerRatio;\n#ifndef LOCAL_SPACE\n\treturn emitterPos + norm * r * spawnBoundsSphere;\n#else\n\treturn norm * r * spawnBoundsSphere;\n#endif\n}\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n\tlocalVelocity += normalize(inBounds - vec3(0.5)) * initialVelocity;\n}\n",particleUpdaterStartPS:"\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec3 unpack3NFloats(float src) {\n\tfloat r = fract(src);\n\tfloat g = fract(src * 256.0);\n\tfloat b = fract(src * 65536.0);\n\treturn vec3(r, g, b);\n}\nvec3 tex1Dlod_lerp(TEXTURE_ACCEPT_HIGHP(tex), vec2 tc, out vec3 w) {\n\tvec4 a = texture2D(tex, tc);\n\tvec4 b = texture2D(tex, tc + graphSampleSize);\n\tfloat c = fract(tc.x * graphNumSamples);\n\tvec3 unpackedA = unpack3NFloats(a.w);\n\tvec3 unpackedB = unpack3NFloats(b.w);\n\tw = mix(unpackedA, unpackedB, c);\n\treturn mix(a.xyz, b.xyz, c);\n}\n#define HASHSCALE4 vec4(1031, .1030, .0973, .1099)\nvec4 hash41(float p) {\n\tvec4 p4 = fract(vec4(p) * HASHSCALE4);\n\tp4 += dot(p4, p4.wzxy+19.19);\n\treturn fract(vec4((p4.x + p4.y)*p4.z, (p4.x + p4.z)*p4.y, (p4.y + p4.z)*p4.w, (p4.z + p4.w)*p4.x));\n}\nvoid main(void) {\n\tif (gl_FragCoord.x > numParticles) discard;\n\treadInput(vUv0.x);\n\tvisMode = inShow? 1.0 : -1.0;\n\tvec4 rndFactor = hash41(gl_FragCoord.x + seed);\n\tfloat particleRate = rate + rateDiv * rndFactor.x;\n\toutLife = inLife + delta;\n\tfloat nlife = clamp(outLife / lifetime, 0.0, 1.0);\n\tvec3 localVelocityDiv;\n\tvec3 velocityDiv;\n\tvec3 paramDiv;\n\tvec3 localVelocity = tex1Dlod_lerp(TEXTURE_PASS(internalTex0), vec2(nlife, 0), localVelocityDiv);\n\tvec3 velocity =\t  tex1Dlod_lerp(TEXTURE_PASS(internalTex1), vec2(nlife, 0), velocityDiv);\n\tvec3 params =\t\ttex1Dlod_lerp(TEXTURE_PASS(internalTex2), vec2(nlife, 0), paramDiv);\n\tfloat rotSpeed = params.x;\n\tfloat rotSpeedDiv = paramDiv.y;\n\tvec3 radialParams = tex1Dlod_lerp(TEXTURE_PASS(internalTex3), vec2(nlife, 0), paramDiv);\n\tfloat radialSpeed = radialParams.x;\n\tfloat radialSpeedDiv = radialParams.y;\n\tbool respawn = inLife <= 0.0 || outLife >= lifetime;\n\tinPos = respawn ? calcSpawnPosition(rndFactor.xyz, rndFactor.x) : inPos;\n\tinAngle = respawn ? mix(startAngle, startAngle2, rndFactor.x) : inAngle;\n#ifndef LOCAL_SPACE\n\tvec3 radialVel = inPos - emitterPos;\n#else\n\tvec3 radialVel = inPos;\n#endif\n\tradialVel = (dot(radialVel, radialVel) > 1.0E-8) ? radialSpeed * normalize(radialVel) : vec3(0.0);\n\tradialVel += (radialSpeedDiv * vec3(2.0) - vec3(1.0)) * radialSpeedDivMult * rndFactor.xyz;\n\tlocalVelocity +=\t(localVelocityDiv * vec3(2.0) - vec3(1.0)) * localVelocityDivMult * rndFactor.xyz;\n\tvelocity +=\t\t (velocityDiv * vec3(2.0) - vec3(1.0)) * velocityDivMult * rndFactor.xyz;\n\trotSpeed +=\t\t (rotSpeedDiv * 2.0 - 1.0) * rotSpeedDivMult * rndFactor.y;\n\taddInitialVelocity(localVelocity, rndFactor.xyz);\n#ifndef LOCAL_SPACE\n\toutVel = emitterMatrix * localVelocity + (radialVel + velocity) * emitterScale;\n#else\n\toutVel = (localVelocity + radialVel) / emitterScale + emitterMatrixInv * velocity;\n#endif\n\toutPos = inPos + outVel * delta;\n\toutAngle = inAngle + rotSpeed * delta;\n",particle_billboardVS:"\n\tquadXY = rotate(quadXY, inAngle, rotMatrix);\n\tvec3 localPos = billboard(particlePos, quadXY);\n",particle_blendAddPS:"\n\tdBlendModeFogFactor = 0.0;\n\trgb *= saturate(gammaCorrectInput(max(a, 0.0)));\n\tif ((rgb.r + rgb.g + rgb.b) < 0.000001) discard;\n",particle_blendMultiplyPS:"\n\trgb = mix(vec3(1.0), rgb, vec3(a));\n\tif (rgb.r + rgb.g + rgb.b > 2.99) discard;\n",particle_blendNormalPS:"\n\tif (a < 0.01) discard;\n",particle_cpuVS:"\nattribute vec4 particle_vertexData;\nattribute vec4 particle_vertexData2;\nattribute vec4 particle_vertexData3;\nattribute float particle_vertexData4;\n#ifndef USE_MESH\nattribute vec2 particle_vertexData5;\n#else\nattribute vec4 particle_vertexData5;\n#endif\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\nuniform float numParticles;\nuniform float lifetime;\nuniform float stretch;\nuniform float seed;\nuniform vec3 wrapBounds;\nuniform vec3 emitterScale;\nuniform vec3 faceTangent;\nuniform vec3 faceBinorm;\n#ifdef PARTICLE_GPU\n\tuniform highp sampler2D internalTex0;\n\tuniform highp sampler2D internalTex1;\n\tuniform highp sampler2D internalTex2;\n#endif\nuniform vec3 emitterPos;\nvarying vec4 texCoordsAlphaLife;\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix)\n{\n\tfloat c = cos(pRotation);\n\tfloat s = sin(pRotation);\n\tmat2 m = mat2(c, -s, s, c);\n\trotMatrix = m;\n\treturn m * quadXY;\n}\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY)\n{\n\tvec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n\treturn pos;\n}\nvec3 customFace(vec3 InstanceCoords, vec2 quadXY)\n{\n\tvec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;\n\treturn pos;\n}\nvoid main(void)\n{\n\tvec3 particlePos = particle_vertexData.xyz;\n\tvec3 inPos = particlePos;\n\tvec3 vertPos = particle_vertexData3.xyz;\n\tvec3 inVel = vec3(particle_vertexData2.w, particle_vertexData3.w, particle_vertexData5.x);\n\tfloat id = floor(particle_vertexData4);\n\tfloat rndFactor = fract(sin(id + 1.0 + seed));\n\tvec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n#ifdef LOCAL_SPACE\n\tinVel = mat3(matrix_model) * inVel;\n#endif\n\tvec2 velocityV = normalize((mat3(matrix_view) * inVel).xy);\n\tvec2 quadXY = vertPos.xy;\n#ifdef USE_MESH\n\ttexCoordsAlphaLife = vec4(particle_vertexData5.zw, particle_vertexData2.z, particle_vertexData.w);\n#else\n\ttexCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, particle_vertexData2.z, particle_vertexData.w);\n#endif\n\tmat2 rotMatrix;\n\tfloat inAngle = particle_vertexData2.x;\n\tvec3 particlePosMoved = vec3(0.0);\n\tvec3 meshLocalPos = particle_vertexData3.xyz;\n",particle_cpu_endVS:"\n\tlocalPos *= particle_vertexData2.y * emitterScale;\n\tlocalPos += particlePos;\n\tgl_Position = matrix_viewProjection * vec4(localPos, 1.0);\n",particle_customFaceVS:"\n\tquadXY = rotate(quadXY, inAngle, rotMatrix);\n\tvec3 localPos = customFace(particlePos, quadXY);\n",particle_endPS:"\n\trgb = addFog(rgb);\n\trgb = toneMap(rgb);\n\trgb = gammaCorrectOutput(rgb);\n\tgl_FragColor = vec4(rgb, a);\n}\n",particle_endVS:"\n\tlocalPos *= scale * emitterScale;\n\tlocalPos += particlePos;\n\t#ifdef SCREEN_SPACE\n\tgl_Position = vec4(localPos.x, localPos.y, 0.0, 1.0);\n\t#else\n\tgl_Position = matrix_viewProjection * vec4(localPos.xyz, 1.0);\n\t#endif\n",particle_halflambertPS:"\n\tvec3 negNormal = normal*0.5+0.5;\n\tvec3 posNormal = -normal*0.5+0.5;\n\tnegNormal *= negNormal;\n\tposNormal *= posNormal;\n",particle_initVS:"\nattribute vec4 particle_vertexData;\n#ifdef USE_MESH\nattribute vec2 particle_uv;\n#endif\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform float numParticles;\nuniform float numParticlesPot;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nuniform float stretch;\nuniform vec3 wrapBounds;\nuniform vec3 emitterScale;\nuniform vec3 emitterPos;\nuniform vec3 faceTangent;\nuniform vec3 faceBinorm;\nuniform float rate;\nuniform float rateDiv;\nuniform float lifetime;\nuniform float deltaRandomnessStatic;\nuniform float scaleDivMult;\nuniform float alphaDivMult;\nuniform float seed;\nuniform float delta;\nuniform sampler2D particleTexOUT;\nuniform sampler2D particleTexIN;\n#ifdef PARTICLE_GPU\n\tuniform highp sampler2D internalTex0;\n\tuniform highp sampler2D internalTex1;\n\tuniform highp sampler2D internalTex2;\n#endif\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\nvarying vec4 texCoordsAlphaLife;\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\n",particle_lambertPS:"\n\tvec3 negNormal = max(normal, vec3(0.0));\n\tvec3 posNormal = max(-normal, vec3(0.0));\n",particle_lightingPS:"\n\tvec3 light = negNormal.x*lightCube[0] + posNormal.x*lightCube[1] +\n\t\t\t\t\t\tnegNormal.y*lightCube[2] + posNormal.y*lightCube[3] +\n\t\t\t\t\t\tnegNormal.z*lightCube[4] + posNormal.z*lightCube[5];\n\trgb *= light;\n",particle_localShiftVS:"\n\tparticlePos = (matrix_model * vec4(particlePos, 1.0)).xyz;\n",particle_meshVS:"\n\tvec3 localPos = meshLocalPos;\n\tlocalPos.xy = rotate(localPos.xy, inAngle, rotMatrix);\n\tlocalPos.yz = rotate(localPos.yz, inAngle, rotMatrix);\n\tbillboard(particlePos, quadXY);\n",particle_normalVS:"\n\tNormal = normalize(localPos + matrix_viewInverse[2].xyz);\n",particle_normalMapPS:"\n\tvec3 normalMap = normalize(texture2D(normalMap, vec2(texCoordsAlphaLife.x, 1.0 - texCoordsAlphaLife.y)).xyz * 2.0 - 1.0);\n\tvec3 normal = ParticleMat * normalMap;\n",particle_pointAlongVS:"\n\tinAngle = atan(velocityV.x, velocityV.y);\n",particle_softPS:"\n\tfloat depth = getLinearScreenDepth();\n\tfloat particleDepth = vDepth;\n\tfloat depthDiff = saturate(abs(particleDepth - depth) * softening);\n\ta *= depthDiff;\n",particle_softVS:"\n\tvDepth = getLinearDepth(localPos);\n",particle_stretchVS:"\n\tvec3 moveDir = inVel * stretch;\n\tvec3 posPrev = particlePos - moveDir;\n\tposPrev += particlePosMoved;\n\tvec2 centerToVertexV = normalize((mat3(matrix_view) * localPos).xy);\n\tfloat interpolation = dot(-velocityV, centerToVertexV) * 0.5 + 0.5;\n\tparticlePos = mix(particlePos, posPrev, interpolation);\n",particle_TBNVS:"\n\tmat3 rot3 = mat3(rotMatrix[0][0], rotMatrix[0][1], 0.0, rotMatrix[1][0], rotMatrix[1][1], 0.0, 0.0, 0.0, 1.0);\n\tParticleMat = mat3(-matrix_viewInverse[0].xyz, -matrix_viewInverse[1].xyz, matrix_viewInverse[2].xyz) * rot3;\n",particle_wrapVS:"\n\tvec3 origParticlePos = particlePos;\n\tparticlePos -= matrix_model[3].xyz;\n\tparticlePos = mod(particlePos, wrapBounds) - wrapBounds * 0.5;\n\tparticlePos += matrix_model[3].xyz;\n\tparticlePosMoved = particlePos - origParticlePos;\n",pickPS:"\nuniform uint meshInstanceId;\nvec4 getPickOutput() {\n\tconst vec4 inv = vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0);\n\tconst uvec4 shifts = uvec4(16, 8, 0, 24);\n\tuvec4 col = (uvec4(meshInstanceId) >> shifts) & uvec4(0xff);\n\treturn vec4(col) * inv;\n}\n",reflDirPS:"\nvoid getReflDir(vec3 worldNormal, vec3 viewDir, float gloss, mat3 tbn) {\n\tdReflDirW = normalize(-reflect(viewDir, worldNormal));\n}\n",reflDirAnisoPS:"\nvoid getReflDir(vec3 worldNormal, vec3 viewDir, float gloss, mat3 tbn) {\n\tfloat roughness = sqrt(1.0 - min(gloss, 1.0));\n\tfloat anisotropy = material_anisotropy * roughness;\n\tvec3 anisotropicDirection = anisotropy >= 0.0 ? tbn[1] : tbn[0];\n\tvec3 anisotropicTangent = cross(anisotropicDirection, viewDir);\n\tvec3 anisotropicNormal = cross(anisotropicTangent, anisotropicDirection);\n\tvec3 bentNormal = normalize(mix(normalize(worldNormal), normalize(anisotropicNormal), anisotropy));\n\tdReflDirW = reflect(-viewDir, bentNormal);\n}\n",reflectionCCPS:"\n#ifdef LIT_CLEARCOAT\nvoid addReflectionCC(vec3 reflDir, float gloss) {\n\tccReflection += calcReflection(reflDir, gloss);\n}\n#endif\n",reflectionCubePS:"\nuniform samplerCube texture_cubeMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 reflDir, float gloss) {\n\tvec3 lookupVec = cubeMapProject(reflDir);\n\tlookupVec.x *= -1.0;\n\treturn $DECODE(textureCube(texture_cubeMap, lookupVec));\n}\nvoid addReflection(vec3 reflDir, float gloss) {   \n\tdReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);\n}\n",reflectionEnvHQPS:"\n#ifndef ENV_ATLAS\n#define ENV_ATLAS\nuniform sampler2D texture_envAtlas;\n#endif\nuniform samplerCube texture_cubeMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 reflDir, float gloss) {\n\tvec3 dir = cubeMapProject(reflDir) * vec3(-1.0, 1.0, 1.0);\n\tvec2 uv = toSphericalUv(dir);\n\tfloat level = saturate(1.0 - gloss) * 5.0;\n\tfloat ilevel = floor(level);\n\tfloat flevel = level - ilevel;\n\tvec3 sharp = $DECODE_CUBEMAP(textureCube(texture_cubeMap, dir));\n\tvec3 roughA = $DECODE(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel)));\n\tvec3 roughB = $DECODE(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel + 1.0)));\n\treturn processEnvironment(mix(sharp, mix(roughA, roughB, flevel), min(level, 1.0)));\n}\nvoid addReflection(vec3 reflDir, float gloss) {   \n\tdReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);\n}\n",reflectionEnvPS:"\n#ifndef ENV_ATLAS\n#define ENV_ATLAS\nuniform sampler2D texture_envAtlas;\n#endif\nuniform float material_reflectivity;\nfloat shinyMipLevel(vec2 uv) {\n\tvec2 dx = dFdx(uv);\n\tvec2 dy = dFdy(uv);\n\tvec2 uv2 = vec2(fract(uv.x + 0.5), uv.y);\n\tvec2 dx2 = dFdx(uv2);\n\tvec2 dy2 = dFdy(uv2);\n\tfloat maxd = min(max(dot(dx, dx), dot(dy, dy)), max(dot(dx2, dx2), dot(dy2, dy2)));\n\treturn clamp(0.5 * log2(maxd) - 1.0 + textureBias, 0.0, 5.0);\n}\nvec3 calcReflection(vec3 reflDir, float gloss) {\n\tvec3 dir = cubeMapProject(reflDir) * vec3(-1.0, 1.0, 1.0);\n\tvec2 uv = toSphericalUv(dir);\n\tfloat level = saturate(1.0 - gloss) * 5.0;\n\tfloat ilevel = floor(level);\n\tfloat level2 = shinyMipLevel(uv * atlasSize);\n\tfloat ilevel2 = floor(level2);\n\tvec2 uv0, uv1;\n\tfloat weight;\n\tif (ilevel == 0.0) {\n\t\tuv0 = mapShinyUv(uv, ilevel2);\n\t\tuv1 = mapShinyUv(uv, ilevel2 + 1.0);\n\t\tweight = level2 - ilevel2;\n\t} else {\n\t\tuv0 = uv1 = mapRoughnessUv(uv, ilevel);\n\t\tweight = 0.0;\n\t}\n\tvec3 linearA = $DECODE(texture2D(texture_envAtlas, uv0));\n\tvec3 linearB = $DECODE(texture2D(texture_envAtlas, uv1));\n\tvec3 linear0 = mix(linearA, linearB, weight);\n\tvec3 linear1 = $DECODE(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel + 1.0)));\n\treturn processEnvironment(mix(linear0, linear1, level - ilevel));\n}\nvoid addReflection(vec3 reflDir, float gloss) {   \n\tdReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);\n}\n",reflectionSpherePS:"\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 reflDir, float gloss) {\n\tvec3 reflDirV = (mat3(matrix_view) * reflDir).xyz;\n\tfloat m = 2.0 * sqrt( dot(reflDirV.xy, reflDirV.xy) + (reflDirV.z+1.0)*(reflDirV.z+1.0) );\n\tvec2 sphereMapUv = reflDirV.xy / m + 0.5;\n\treturn $DECODE(texture2D(texture_sphereMap, sphereMapUv));\n}\nvoid addReflection(vec3 reflDir, float gloss) {   \n\tdReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);\n}\n",reflectionSheenPS:"\nvoid addReflectionSheen(vec3 worldNormal, vec3 viewDir, float gloss) {\n\tfloat NoV = dot(worldNormal, viewDir);\n\tfloat alphaG = gloss * gloss;\n\tfloat a = gloss < 0.25 ? -339.2 * alphaG + 161.4 * gloss - 25.9 : -8.48 * alphaG + 14.3 * gloss - 9.95;\n\tfloat b = gloss < 0.25 ? 44.0 * alphaG - 23.7 * gloss + 3.26 : 1.97 * alphaG - 3.27 * gloss + 0.72;\n\tfloat DG = exp( a * NoV + b ) + ( gloss < 0.25 ? 0.0 : 0.1 * ( gloss - 0.25 ) );\n\tsReflection += calcReflection(worldNormal, 0.0) * saturate(DG);\n}\n",refractionCubePS:"\nvec3 refract2(vec3 viewVec, vec3 normal, float IOR) {\n\tfloat vn = dot(viewVec, normal);\n\tfloat k = 1.0 - IOR * IOR * (1.0 - vn * vn);\n\tvec3 refrVec = IOR * viewVec - (IOR * vn + sqrt(k)) * normal;\n\treturn refrVec;\n}\nvoid addRefraction(\n\tvec3 worldNormal, \n\tvec3 viewDir, \n\tfloat thickness, \n\tfloat gloss, \n\tvec3 specularity, \n\tvec3 albedo, \n\tfloat transmission,\n\tfloat refractionIndex,\n\tfloat dispersion\n#if defined(LIT_IRIDESCENCE)\n\t, vec3 iridescenceFresnel,\n\tfloat iridescenceIntensity\n#endif \n) {\n\tvec4 tmpRefl = dReflection;\n\tvec3 reflectionDir = refract2(-viewDir, worldNormal, refractionIndex);\n\tdReflection = vec4(0);\n\taddReflection(reflectionDir, gloss);\n\tdDiffuseLight = mix(dDiffuseLight, dReflection.rgb * albedo, transmission);\n\tdReflection = tmpRefl;\n}\n",refractionDynamicPS:"\nuniform float material_invAttenuationDistance;\nuniform vec3 material_attenuation;\nvec3 evalRefractionColor(vec3 refractionVector, float gloss, float refractionIndex) {\n\tvec4 pointOfRefraction = vec4(vPositionW + refractionVector, 1.0);\n\tvec4 projectionPoint = matrix_viewProjection * pointOfRefraction;\n\tvec2 uv = getGrabScreenPos(projectionPoint);\n\tfloat iorToRoughness = (1.0 - gloss) * clamp((1.0 / refractionIndex) * 2.0 - 2.0, 0.0, 1.0);\n\tfloat refractionLod = log2(uScreenSize.x) * iorToRoughness;\n\tvec3 refraction = texture2DLodEXT(uSceneColorMap, uv, refractionLod).rgb;\n\treturn refraction;\n}\nvoid addRefraction(\n\tvec3 worldNormal, \n\tvec3 viewDir, \n\tfloat thickness, \n\tfloat gloss, \n\tvec3 specularity, \n\tvec3 albedo, \n\tfloat transmission,\n\tfloat refractionIndex,\n\tfloat dispersion\n#if defined(LIT_IRIDESCENCE)\n\t, vec3 iridescenceFresnel,\n\tfloat iridescenceIntensity\n#endif\n) {\n\tvec3 modelScale;\n\tmodelScale.x = length(vec3(matrix_model[0].xyz));\n\tmodelScale.y = length(vec3(matrix_model[1].xyz));\n\tmodelScale.z = length(vec3(matrix_model[2].xyz));\n\tvec3 scale = thickness * modelScale;\n\tvec3 refractionVector = normalize(refract(-viewDir, worldNormal, refractionIndex)) * scale;\n\tvec3 refraction = evalRefractionColor(refractionVector, gloss, refractionIndex);\n\t#ifdef DISPERSION\n\t\tfloat halfSpread = (1.0 / refractionIndex - 1.0) * 0.025 * dispersion;\n\t\tfloat refractionIndexR = refractionIndex - halfSpread;\n\t\trefractionVector = normalize(refract(-viewDir, worldNormal, refractionIndexR)) * scale;\n\t\trefraction.r = evalRefractionColor(refractionVector, gloss, refractionIndexR).r;\n\t\tfloat refractionIndexB = refractionIndex + halfSpread;\n\t\trefractionVector = normalize(refract(-viewDir, worldNormal, refractionIndexB)) * scale;\n\t\trefraction.b = evalRefractionColor(refractionVector, gloss, refractionIndexB).b;\n\t#endif\n\tvec3 transmittance;\n\tif (material_invAttenuationDistance != 0.0)\n\t{\n\t\tvec3 attenuation = -log(material_attenuation) * material_invAttenuationDistance;\n\t\ttransmittance = exp(-attenuation * length(refractionVector));\n\t}\n\telse\n\t{\n\t\ttransmittance = refraction;\n\t}\n\tvec3 fresnel = vec3(1.0) - \n\t\tgetFresnel(\n\t\t\tdot(viewDir, worldNormal), \n\t\t\tgloss, \n\t\t\tspecularity\n\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t, iridescenceFresnel,\n\t\t\tiridescenceIntensity\n\t\t#endif\n\t\t);\n\tdDiffuseLight = mix(dDiffuseLight, refraction * transmittance * fresnel, transmission);\n}\n",reprojectPS:`\nvarying vec2 vUv0;\n#ifdef CUBEMAP_SOURCE\n\tuniform samplerCube sourceCube;\n#else\n\tuniform sampler2D sourceTex;\n#endif\n#ifdef USE_SAMPLES_TEX\n\tuniform sampler2D samplesTex;\n\tuniform vec2 samplesTexInverseSize;\n#endif\nuniform vec3 params;\nfloat targetFace() { return params.x; }\nfloat targetTotalPixels() { return params.y; }\nfloat sourceTotalPixels() { return params.z; }\nfloat PI = 3.141592653589793;\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\n${ll}\n${hl}\nvec3 modifySeams(vec3 dir, float scale) {\n\tvec3 adir = abs(dir);\n\tfloat M = max(max(adir.x, adir.y), adir.z);\n\treturn dir / M * vec3(\n\t\tadir.x == M ? 1.0 : scale,\n\t\tadir.y == M ? 1.0 : scale,\n\t\tadir.z == M ? 1.0 : scale\n\t);\n}\nvec2 toSpherical(vec3 dir) {\n\treturn vec2(dir.xz == vec2(0.0) ? 0.0 : atan(dir.x, dir.z), asin(dir.y));\n}\nvec3 fromSpherical(vec2 uv) {\n\treturn vec3(cos(uv.y) * sin(uv.x),\n\t\t\t\tsin(uv.y),\n\t\t\t\tcos(uv.y) * cos(uv.x));\n}\nvec3 getDirectionEquirect() {\n\treturn fromSpherical((vec2(vUv0.x, 1.0 - vUv0.y) * 2.0 - 1.0) * vec2(PI, PI * 0.5));\n}\nfloat signNotZero(float k){\n\treturn(k >= 0.0) ? 1.0 : -1.0;\n}\nvec2 signNotZero(vec2 v) {\n\treturn vec2(signNotZero(v.x), signNotZero(v.y));\n}\nvec3 octDecode(vec2 o) {\n\tvec3 v = vec3(o.x, 1.0 - abs(o.x) - abs(o.y), o.y);\n\tif (v.y < 0.0) {\n\t\tv.xz = (1.0 - abs(v.zx)) * signNotZero(v.xz);\n\t}\n\treturn normalize(v);\n}\nvec3 getDirectionOctahedral() {\n\treturn octDecode(vec2(vUv0.x, 1.0 - vUv0.y) * 2.0 - 1.0);\n}\nvec2 octEncode(in vec3 v) {\n\tfloat l1norm = abs(v.x) + abs(v.y) + abs(v.z);\n\tvec2 result = v.xz * (1.0 / l1norm);\n\tif (v.y < 0.0) {\n\t\tresult = (1.0 - abs(result.yx)) * signNotZero(result.xy);\n\t}\n\treturn result;\n}\n#ifdef CUBEMAP_SOURCE\n\tvec4 sampleCubemap(vec3 dir) {\n\t\treturn textureCube(sourceCube, modifySeams(dir, 1.0));\n\t}\n\tvec4 sampleCubemap(vec2 sph) {\n\treturn sampleCubemap(fromSpherical(sph));\n}\n\tvec4 sampleCubemap(vec3 dir, float mipLevel) {\n\t\treturn textureCubeLodEXT(sourceCube, modifySeams(dir, 1.0), mipLevel);\n\t}\n\tvec4 sampleCubemap(vec2 sph, float mipLevel) {\n\t\treturn sampleCubemap(fromSpherical(sph), mipLevel);\n\t}\n#else\n\tvec4 sampleEquirect(vec2 sph) {\n\t\tvec2 uv = sph / vec2(PI * 2.0, PI) + 0.5;\n\t\treturn texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));\n\t}\n\tvec4 sampleEquirect(vec3 dir) {\n\t\treturn sampleEquirect(toSpherical(dir));\n\t}\n\tvec4 sampleEquirect(vec2 sph, float mipLevel) {\n\t\tvec2 uv = sph / vec2(PI * 2.0, PI) + 0.5;\n\t\treturn texture2DLodEXT(sourceTex, vec2(uv.x, 1.0 - uv.y), mipLevel);\n\t}\n\tvec4 sampleEquirect(vec3 dir, float mipLevel) {\n\t\treturn sampleEquirect(toSpherical(dir), mipLevel);\n\t}\n\tvec4 sampleOctahedral(vec3 dir) {\n\t\tvec2 uv = octEncode(dir) * 0.5 + 0.5;\n\t\treturn texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));\n\t}\n\tvec4 sampleOctahedral(vec2 sph) {\n\t\treturn sampleOctahedral(fromSpherical(sph));\n\t}\n\tvec4 sampleOctahedral(vec3 dir, float mipLevel) {\n\t\tvec2 uv = octEncode(dir) * 0.5 + 0.5;\n\t\treturn texture2DLodEXT(sourceTex, vec2(uv.x, 1.0 - uv.y), mipLevel);\n\t}\n\tvec4 sampleOctahedral(vec2 sph, float mipLevel) {\n\t\treturn sampleOctahedral(fromSpherical(sph), mipLevel);\n\t}\n#endif\nvec3 getDirectionCubemap() {\n\tvec2 st = vUv0 * 2.0 - 1.0;\n\tfloat face = targetFace();\n\tvec3 vec;\n\tif (face == 0.0) {\n\t\tvec = vec3(1, -st.y, -st.x);\n\t} else if (face == 1.0) {\n\t\tvec = vec3(-1, -st.y, st.x);\n\t} else if (face == 2.0) {\n\t\tvec = vec3(st.x, 1, st.y);\n\t} else if (face == 3.0) {\n\t\tvec = vec3(st.x, -1, -st.y);\n\t} else if (face == 4.0) {\n\t\tvec = vec3(st.x, -st.y, 1);\n\t} else {\n\t\tvec = vec3(-st.x, -st.y, -1);\n\t}\n\treturn normalize(modifySeams(vec, 1.0));\n}\nmat3 matrixFromVector(vec3 n) {\n\tfloat a = 1.0 / (1.0 + n.z);\n\tfloat b = -n.x * n.y * a;\n\tvec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);\n\tvec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);\n\treturn mat3(b1, b2, n);\n}\nmat3 matrixFromVectorSlow(vec3 n) {\n\tvec3 up = (1.0 - abs(n.y) <= 0.0000001) ? vec3(0.0, 0.0, n.y > 0.0 ? 1.0 : -1.0) : vec3(0.0, 1.0, 0.0);\n\tvec3 x = normalize(cross(up, n));\n\tvec3 y = cross(n, x);\n\treturn mat3(x, y, n);\n}\nvec4 reproject() {\n\tif (NUM_SAMPLES <= 1) {\n\t\treturn ENCODE_FUNC(DECODE_FUNC(SOURCE_FUNC(TARGET_FUNC())));\n\t} else {\n\t\tvec3 t = TARGET_FUNC();\n\t\tvec3 tu = dFdx(t);\n\t\tvec3 tv = dFdy(t);\n\t\tvec3 result = vec3(0.0);\n\t\tfor (float u = 0.0; u < NUM_SAMPLES_SQRT; ++u) {\n\t\t\tfor (float v = 0.0; v < NUM_SAMPLES_SQRT; ++v) {\n\t\t\t\tresult += DECODE_FUNC(SOURCE_FUNC(normalize(t +\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttu * (u / NUM_SAMPLES_SQRT - 0.5) +\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttv * (v / NUM_SAMPLES_SQRT - 0.5))));\n\t\t\t}\n\t\t}\n\t\treturn ENCODE_FUNC(result / (NUM_SAMPLES_SQRT * NUM_SAMPLES_SQRT));\n\t}\n}\nvec4 unpackFloat = vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0);\n#ifdef USE_SAMPLES_TEX\n\tvoid unpackSample(int i, out vec3 L, out float mipLevel) {\n\t\tfloat u = (float(i * 4) + 0.5) * samplesTexInverseSize.x;\n\t\tfloat v = (floor(u) + 0.5) * samplesTexInverseSize.y;\n\t\tvec4 raw;\n\t\traw.x = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;\n\t\traw.y = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;\n\t\traw.z = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;\n\t\traw.w = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat);\n\t\tL.xyz = raw.xyz * 2.0 - 1.0;\n\t\tmipLevel = raw.w * 8.0;\n\t}\n\tvec4 prefilterSamples() {\n\t\tmat3 vecSpace = matrixFromVectorSlow(TARGET_FUNC());\n\t\tvec3 L;\n\t\tfloat mipLevel;\n\t\tvec3 result = vec3(0.0);\n\t\tfloat totalWeight = 0.0;\n\t\tfor (int i = 0; i < NUM_SAMPLES; ++i) {\n\t\t\tunpackSample(i, L, mipLevel);\n\t\t\tresult += DECODE_FUNC(SOURCE_FUNC(vecSpace * L, mipLevel)) * L.z;\n\t\t\ttotalWeight += L.z;\n\t\t}\n\t\treturn ENCODE_FUNC(result / totalWeight);\n\t}\n\tvec4 prefilterSamplesUnweighted() {\n\t\tmat3 vecSpace = matrixFromVectorSlow(TARGET_FUNC());\n\t\tvec3 L;\n\t\tfloat mipLevel;\n\t\tvec3 result = vec3(0.0);\n\t\tfloat totalWeight = 0.0;\n\t\tfor (int i = 0; i < NUM_SAMPLES; ++i) {\n\t\t\tunpackSample(i, L, mipLevel);\n\t\t\tresult += DECODE_FUNC(SOURCE_FUNC(vecSpace * L, mipLevel));\n\t\t}\n\t\treturn ENCODE_FUNC(result / float(NUM_SAMPLES));\n\t}\n#endif\nvoid main(void) {\n\tgl_FragColor = PROCESS_FUNC();\n}\n`,sampleCatmullRomPS:"\nvec4 SampleTextureCatmullRom(TEXTURE_ACCEPT(tex), vec2 uv, vec2 texSize) {\n\tvec2 samplePos = uv * texSize;\n\tvec2 texPos1 = floor(samplePos - 0.5) + 0.5;\n\tvec2 f = samplePos - texPos1;\n\tvec2 w0 = f * (-0.5 + f * (1.0 - 0.5 * f));\n\tvec2 w1 = 1.0 + f * f * (-2.5 + 1.5 * f);\n\tvec2 w2 = f * (0.5 + f * (2.0 - 1.5 * f));\n\tvec2 w3 = f * f * (-0.5 + 0.5 * f);\n\tvec2 w12 = w1 + w2;\n\tvec2 offset12 = w2 / (w1 + w2);\n\tvec2 texPos0 = (texPos1 - 1.0) / texSize;\n\tvec2 texPos3 = (texPos1 + 2.0) / texSize;\n\tvec2 texPos12 = (texPos1 + offset12) / texSize;\n\tvec4 result = vec4(0.0);\n\tresult += texture2DLodEXT(tex, vec2(texPos0.x, texPos0.y), 0.0) * w0.x * w0.y;\n\tresult += texture2DLodEXT(tex, vec2(texPos12.x, texPos0.y), 0.0) * w12.x * w0.y;\n\tresult += texture2DLodEXT(tex, vec2(texPos3.x, texPos0.y), 0.0) * w3.x * w0.y;\n\tresult += texture2DLodEXT(tex, vec2(texPos0.x, texPos12.y), 0.0) * w0.x * w12.y;\n\tresult += texture2DLodEXT(tex, vec2(texPos12.x, texPos12.y), 0.0) * w12.x * w12.y;\n\tresult += texture2DLodEXT(tex, vec2(texPos3.x, texPos12.y), 0.0) * w3.x * w12.y;\n\tresult += texture2DLodEXT(tex, vec2(texPos0.x, texPos3.y), 0.0) * w0.x * w3.y;\n\tresult += texture2DLodEXT(tex, vec2(texPos12.x, texPos3.y), 0.0) * w12.x * w3.y;\n\tresult += texture2DLodEXT(tex, vec2(texPos3.x, texPos3.y), 0.0) * w3.x * w3.y;\n\treturn result;\n}\n",screenDepthPS:"\nuniform highp sampler2D uSceneDepthMap;\n#ifndef SCREENSIZE\n#define SCREENSIZE\nuniform vec4 uScreenSize;\n#endif\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n#ifndef LINEARIZE_DEPTH\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\n#define LINEARIZE_DEPTH\nfloat linearizeDepth(float z) {\n\tif (camera_params.w == 0.0)\n\t\treturn (camera_params.z * camera_params.y) / (camera_params.y + z * (camera_params.z - camera_params.y));\n\telse\n\t\treturn camera_params.z + z * (camera_params.y - camera_params.z);\n}\n#endif\nfloat delinearizeDepth(float linearDepth) {\n\tif (camera_params.w == 0.0) {\n\t\treturn (camera_params.y * (camera_params.z - linearDepth)) / (linearDepth * (camera_params.z - camera_params.y));\n\t} else {\n\t\treturn (linearDepth - camera_params.z) / (camera_params.y - camera_params.z);\n\t}\n}\nfloat getLinearScreenDepth(vec2 uv) {\n\t#ifdef SCENE_DEPTHMAP_LINEAR\n\t\t#ifdef SCENE_DEPTHMAP_FLOAT\n\t\t\treturn texture2D(uSceneDepthMap, uv).r;\n\t\t#else\n\t\t\tivec2 textureSize = textureSize(uSceneDepthMap, 0);\n\t\t\tivec2 texel = ivec2(uv * vec2(textureSize));\n\t\t\tvec4 data = texelFetch(uSceneDepthMap, texel, 0);\n\t\t\tuint intBits = \n\t\t\t\t(uint(data.r * 255.0) << 24u) |\n\t\t\t\t(uint(data.g * 255.0) << 16u) |\n\t\t\t\t(uint(data.b * 255.0) << 8u) |\n\t\t\t\tuint(data.a * 255.0);\n\t\t\treturn uintBitsToFloat(intBits);\n\t\t#endif\n\t#else\n\t\treturn linearizeDepth(texture2D(uSceneDepthMap, uv).r);\n\t#endif\n}\n#ifndef VERTEXSHADER\nfloat getLinearScreenDepth() {\n\tvec2 uv = gl_FragCoord.xy * uScreenSize.zw;\n\treturn getLinearScreenDepth(uv);\n}\n#endif\nfloat getLinearDepth(vec3 pos) {\n\treturn -(matrix_view * vec4(pos, 1.0)).z;\n}\n",shadowCascadesPS:"\nconst float maxCascades = 4.0;\nmat4 cascadeShadowMat;\nvoid getShadowCascadeMatrix(mat4 shadowMatrixPalette[4], float shadowCascadeDistances[4], float shadowCascadeCount) {\n\tfloat depth = 1.0 / gl_FragCoord.w;\n\tfloat cascadeIndex = 0.0;\n\tfor (float i = 0.0; i < maxCascades; i++) {\n\t\tif (depth < shadowCascadeDistances[int(i)]) {\n\t\t\tcascadeIndex = i;\n\t\t\tbreak;\n\t\t}\n\t}\n\tcascadeIndex = min(cascadeIndex, shadowCascadeCount - 1.0);\n\tcascadeShadowMat = shadowMatrixPalette[int(cascadeIndex)];\n}\nvoid fadeShadow(float shadowCascadeDistances[4]) {\t\t\t\t  \n\tfloat depth = 1.0 / gl_FragCoord.w;\n\tif (depth > shadowCascadeDistances[int(maxCascades - 1.0)]) {\n\t\tdShadowCoord.z = -9999999.0;\n\t}\n}\n",shadowEVSMPS:"\nfloat VSM$(TEXTURE_ACCEPT(tex), vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n\tvec3 moments = texture2D(tex, texCoords).xyz;\n\treturn calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfloat getShadowVSM$(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {\n\treturn VSM$(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, shadowCoord.z, shadowParams.y, exponent);\n}\nfloat getShadowSpotVSM$(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {\n\treturn VSM$(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, length(lightDir) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\n",shadowEVSMnPS:"\nfloat VSM$(TEXTURE_ACCEPT(tex), vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n\tfloat pixelSize = 1.0 / resolution;\n\ttexCoords -= vec2(pixelSize);\n\tvec3 s00 = texture2D(tex, texCoords).xyz;\n\tvec3 s10 = texture2D(tex, texCoords + vec2(pixelSize, 0)).xyz;\n\tvec3 s01 = texture2D(tex, texCoords + vec2(0, pixelSize)).xyz;\n\tvec3 s11 = texture2D(tex, texCoords + vec2(pixelSize)).xyz;\n\tvec2 fr = fract(texCoords * resolution);\n\tvec3 h0 = mix(s00, s10, fr.x);\n\tvec3 h1 = mix(s01, s11, fr.x);\n\tvec3 moments = mix(h0, h1, fr.y);\n\treturn calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfloat getShadowVSM$(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {\n\treturn VSM$(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, shadowCoord.z, shadowParams.y, exponent);\n}\nfloat getShadowSpotVSM$(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {\n\treturn VSM$(TEXTURE_PASS(shadowMap), shadowCoord.xy, shadowParams.x, length(lightDir) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\n",shadowPCSSPS:"\n#define PCSS_SAMPLE_COUNT 16\nuniform float pcssDiskSamples[PCSS_SAMPLE_COUNT];\nuniform float pcssSphereSamples[PCSS_SAMPLE_COUNT];\nvec2 vogelDisk(int sampleIndex, float count, float phi, float r) {\n\tconst float GoldenAngle = 2.4;\n\tfloat theta = float(sampleIndex) * GoldenAngle + phi;\n\tfloat sine = sin(theta);\n\tfloat cosine = cos(theta);\n\treturn vec2(r * cosine, r * sine);\n}\nvec3 vogelSphere(int sampleIndex, float count, float phi, float r) {\n\tconst float GoldenAngle = 2.4;\n\tfloat theta = float(sampleIndex) * GoldenAngle + phi;\n\tfloat weight = float(sampleIndex) / count;\n\treturn vec3(cos(theta) * r, weight, sin(theta) * r);\n}\nfloat noise(vec2 screenPos) {\n\tconst float PHI = 1.61803398874989484820459;\n\treturn fract(sin(dot(screenPos * PHI, screenPos)) * screenPos.x);\n}\nfloat viewSpaceDepth(float depth, mat4 invProjection) {\n\tfloat z = depth * 2.0 - 1.0;\n\tvec4 clipSpace = vec4(0.0, 0.0, z, 1.0);\n\tvec4 viewSpace = invProjection * clipSpace;\n\treturn viewSpace.z;\n}\nfloat PCSSBlockerDistance(TEXTURE_ACCEPT(shadowMap), vec2 sampleCoords[PCSS_SAMPLE_COUNT], vec2 shadowCoords, vec2 searchSize, float z) {\n\tfloat blockers = 0.0;\n\tfloat averageBlocker = 0.0;\n\tfor (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {\n\t\tvec2 offset = sampleCoords[i] * searchSize;\n\t\tvec2 sampleUV = shadowCoords + offset;\n\t\tfloat blocker = textureLod(shadowMap, sampleUV, 0.0).r;\n\t\tfloat isBlocking = step(blocker, z);\n\t\tblockers += isBlocking;\n\t\taverageBlocker += blocker * isBlocking;\n\t}\n\tif (blockers > 0.0)\n\t\treturn averageBlocker /= blockers;\n\treturn -1.0;\n}\nfloat PCSS(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoords, vec4 cameraParams, vec2 shadowSearchArea) {\n\tfloat receiverDepth = shadowCoords.z;\n\tvec2 samplePoints[PCSS_SAMPLE_COUNT];\n\tfloat noise = noise( gl_FragCoord.xy ) * 2.0 * PI;\n\tfor (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {\n\t\tfloat pcssPresample = pcssDiskSamples[i];\n\t\tsamplePoints[i] = vogelDisk(i, float(PCSS_SAMPLE_COUNT), noise, pcssPresample);\n\t}\n\tfloat averageBlocker = PCSSBlockerDistance(TEXTURE_PASS(shadowMap), samplePoints, shadowCoords.xy, shadowSearchArea, receiverDepth);\n\tif (averageBlocker == -1.0) {\n\t\treturn 1.0;\n\t} else {\n\t\tvec2 filterRadius = ((receiverDepth - averageBlocker) / averageBlocker) * shadowSearchArea * cameraParams.x;\n\t\tfloat shadow = 0.0;\n\t\tfor (int i = 0; i < PCSS_SAMPLE_COUNT; i ++)\n\t\t{\n\t\t\tvec2 sampleUV = samplePoints[i] * filterRadius;\n\t\t\tsampleUV = shadowCoords.xy + sampleUV;\n\t\t\tfloat depth = textureLod(shadowMap, sampleUV, 0.0).r;\n\t\t\tshadow += step(receiverDepth, depth);\n\t\t}\n\t\treturn shadow / float(PCSS_SAMPLE_COUNT);\n\t} \n}\nfloat PCSSCubeBlockerDistance(samplerCube shadowMap, vec3 lightDirNorm, vec3 samplePoints[PCSS_SAMPLE_COUNT], float z, float shadowSearchArea) {\n\tfloat blockers = 0.0;\n\tfloat averageBlocker = 0.0;\n\tfor (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {\n\t\tvec3 sampleDir = lightDirNorm + samplePoints[i] * shadowSearchArea;\n\t\tsampleDir = normalize(sampleDir);\n\t\tfloat blocker = textureCubeLodEXT(shadowMap, sampleDir, 0.0).r;\n\t\tfloat isBlocking = step(blocker, z);\n\t\tblockers += isBlocking;\n\t\taverageBlocker += blocker * isBlocking;\n\t}\n\tif (blockers > 0.0)\n\t\treturn averageBlocker /= float(blockers);\n\treturn -1.0;\n}\nfloat PCSSCube(samplerCube shadowMap, vec4 shadowParams, vec3 shadowCoords, vec4 cameraParams, float shadowSearchArea, vec3 lightDir) {\n\t\n\tvec3 samplePoints[PCSS_SAMPLE_COUNT];\n\tfloat noise = noise( gl_FragCoord.xy ) * 2.0 * PI;\n\tfor (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {\n\t\tfloat r = pcssSphereSamples[i];\n\t\tsamplePoints[i] = vogelSphere(i, float(PCSS_SAMPLE_COUNT), noise, r);\n\t}\n\tfloat receiverDepth = length(lightDir) * shadowParams.w + shadowParams.z;\n\tvec3 lightDirNorm = normalize(lightDir);\n\t\n\tfloat averageBlocker = PCSSCubeBlockerDistance(shadowMap, lightDirNorm, samplePoints, receiverDepth, shadowSearchArea);\n\tif (averageBlocker == -1.0) {\n\t\treturn 1.0;\n\t} else {\n\t\tfloat filterRadius = ((receiverDepth - averageBlocker) / averageBlocker) * shadowSearchArea;\n\t\tfloat shadow = 0.0;\n\t\tfor (int i = 0; i < PCSS_SAMPLE_COUNT; i++)\n\t\t{\n\t\t\tvec3 offset = samplePoints[i] * filterRadius;\n\t\t\tvec3 sampleDir = lightDirNorm + offset;\n\t\t\tsampleDir = normalize(sampleDir);\n\t\t\tfloat depth = textureCubeLodEXT(shadowMap, sampleDir, 0.0).r;\n\t\t\tshadow += step(receiverDepth, depth);\n\t\t}\n\t\treturn shadow / float(PCSS_SAMPLE_COUNT);\n\t}\n}\nfloat getShadowPointPCSS(samplerCube shadowMap, vec3 shadowCoord, vec4 shadowParams, vec4 cameraParams, vec2 shadowSearchArea, vec3 lightDir) {\n\treturn PCSSCube(shadowMap, shadowParams, shadowCoord, cameraParams, shadowSearchArea.x, lightDir);\n}\nfloat getShadowSpotPCSS(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, vec4 cameraParams, vec2 shadowSearchArea, vec3 lightDir) {\n\treturn PCSS(TEXTURE_PASS(shadowMap), shadowCoord, cameraParams, shadowSearchArea);\n}\nfloat getShadowPCSS(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, vec4 cameraParams, vec2 shadowSearchArea, vec3 lightDir) {\n\treturn PCSS(TEXTURE_PASS(shadowMap), shadowCoord, cameraParams, shadowSearchArea);\n}\n",shadowSampleCoordPS:"\nvec3 getShadowSampleCoord$LIGHT(mat4 shadowTransform, vec4 shadowParams, vec3 worldPosition, vec3 lightPos, inout vec3 lightDir, vec3 lightDirNorm, vec3 normal) {\n\tvec3 surfacePosition = worldPosition;\n#ifdef SHADOW_SAMPLE_POINT\n\t#ifdef SHADOW_SAMPLE_NORMAL_OFFSET\n\t\tfloat distScale = length(lightDir);\n\t\tsurfacePosition = worldPosition + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;\n\t\tlightDir = surfacePosition - lightPos;\n\t\treturn lightDir;\n\t#endif\n#else\n\t#ifdef SHADOW_SAMPLE_SOURCE_ZBUFFER\n\t\t#ifdef SHADOW_SAMPLE_NORMAL_OFFSET\n\t\t\tsurfacePosition = worldPosition + normal * shadowParams.y;\n\t\t#endif\n\t#else\n\t\t#ifdef SHADOW_SAMPLE_NORMAL_OFFSET\n\t\t\t#ifdef SHADOW_SAMPLE_ORTHO\n\t\t\t\tfloat distScale = 1.0;\n\t\t\t#else\n\t\t\t\tfloat distScale = abs(dot(vPositionW - lightPos, lightDirNorm));\n\t\t\t#endif\n\t\t\tsurfacePosition = worldPosition + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;\n\t\t#endif\n\t#endif\n\tvec4 positionInShadowSpace = shadowTransform * vec4(surfacePosition, 1.0);\n\t#ifdef SHADOW_SAMPLE_ORTHO\n\t\tpositionInShadowSpace.z = saturate(positionInShadowSpace.z) - 0.0001;\n\t#else\n\t\t#ifdef SHADOW_SAMPLE_SOURCE_ZBUFFER\n\t\t\tpositionInShadowSpace.xyz /= positionInShadowSpace.w;\n\t\t#else\n\t\t\tpositionInShadowSpace.xy /= positionInShadowSpace.w;\n\t\t\tpositionInShadowSpace.z = length(lightDir) * shadowParams.w;\n\t\t#endif\n\t#endif\n\t#ifdef SHADOW_SAMPLE_Z_BIAS\n\t\tpositionInShadowSpace.z += getShadowBias(shadowParams.x, shadowParams.z);\n\t#endif\n\tsurfacePosition = positionInShadowSpace.xyz;\n#endif\n\treturn surfacePosition;\n}\n",shadowStandardPS:"\nfloat _getShadowPCF3x3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec3 shadowParams) {\n\tfloat z = shadowCoord.z;\n\tvec2 uv = shadowCoord.xy * shadowParams.x;\n\tfloat shadowMapSizeInv = 1.0 / shadowParams.x;\n\tvec2 base_uv = floor(uv + 0.5);\n\tfloat s = (uv.x + 0.5 - base_uv.x);\n\tfloat t = (uv.y + 0.5 - base_uv.y);\n\tbase_uv -= vec2(0.5);\n\tbase_uv *= shadowMapSizeInv;\n\tfloat sum = 0.0;\n\tfloat uw0 = (3.0 - 2.0 * s);\n\tfloat uw1 = (1.0 + 2.0 * s);\n\tfloat u0 = (2.0 - s) / uw0 - 1.0;\n\tfloat u1 = s / uw1 + 1.0;\n\tfloat vw0 = (3.0 - 2.0 * t);\n\tfloat vw1 = (1.0 + 2.0 * t);\n\tfloat v0 = (2.0 - t) / vw0 - 1.0;\n\tfloat v1 = t / vw1 + 1.0;\n\tu0 = u0 * shadowMapSizeInv + base_uv.x;\n\tv0 = v0 * shadowMapSizeInv + base_uv.y;\n\tu1 = u1 * shadowMapSizeInv + base_uv.x;\n\tv1 = v1 * shadowMapSizeInv + base_uv.y;\n\tsum += uw0 * vw0 * textureShadow(shadowMap, vec3(u0, v0, z));\n\tsum += uw1 * vw0 * textureShadow(shadowMap, vec3(u1, v0, z));\n\tsum += uw0 * vw1 * textureShadow(shadowMap, vec3(u0, v1, z));\n\tsum += uw1 * vw1 * textureShadow(shadowMap, vec3(u1, v1, z));\n\tsum *= 1.0f / 16.0;\n\treturn sum;\n}\nfloat getShadowPCF3x3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn _getShadowPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);\n}\nfloat getShadowSpotPCF3x3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn _getShadowPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);\n}\nfloat getShadowPCF1x1(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn textureShadow(shadowMap, shadowCoord);\n}\nfloat getShadowSpotPCF1x1(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn textureShadow(shadowMap, shadowCoord);\n}\n#ifndef WEBGPU\nfloat getShadowPointPCF3x3(samplerCubeShadow shadowMap, vec4 shadowParams, vec3 dir) {\n\t\n\tfloat shadowZ = length(dir) * shadowParams.w + shadowParams.z;\n\tfloat z = 1.0 / float(textureSize(shadowMap, 0));\n\tvec3 tc = normalize(dir);\n\tmediump vec4 shadows;\n\tshadows.x = texture(shadowMap, vec4(tc + vec3( z, z, z), shadowZ));\n\tshadows.y = texture(shadowMap, vec4(tc + vec3(-z,-z, z), shadowZ));\n\tshadows.z = texture(shadowMap, vec4(tc + vec3(-z, z,-z), shadowZ));\n\tshadows.w = texture(shadowMap, vec4(tc + vec3( z,-z,-z), shadowZ));\n\treturn dot(shadows, vec4(0.25));\n}\nfloat getShadowPointPCF1x1(samplerCubeShadow shadowMap, vec3 shadowCoord, vec4 shadowParams, vec3 lightDir) {\n\tfloat shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;\n\treturn texture(shadowMap, vec4(lightDir, shadowZ));\n}\nfloat getShadowPointPCF3x3(samplerCubeShadow shadowMap, vec3 shadowCoord, vec4 shadowParams, vec3 lightDir) {\n\treturn getShadowPointPCF3x3(shadowMap, shadowParams, lightDir);\n}\n#endif\n",shadowStandardGL2PS:"\nfloat _getShadowPCF5x5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec3 shadowParams) {\n\tfloat z = shadowCoord.z;\n\tvec2 uv = shadowCoord.xy * shadowParams.x;\n\tfloat shadowMapSizeInv = 1.0 / shadowParams.x;\n\tvec2 base_uv = floor(uv + 0.5);\n\tfloat s = (uv.x + 0.5 - base_uv.x);\n\tfloat t = (uv.y + 0.5 - base_uv.y);\n\tbase_uv -= vec2(0.5);\n\tbase_uv *= shadowMapSizeInv;\n\tfloat uw0 = (4.0 - 3.0 * s);\n\tfloat uw1 = 7.0;\n\tfloat uw2 = (1.0 + 3.0 * s);\n\tfloat u0 = (3.0 - 2.0 * s) / uw0 - 2.0;\n\tfloat u1 = (3.0 + s) / uw1;\n\tfloat u2 = s / uw2 + 2.0;\n\tfloat vw0 = (4.0 - 3.0 * t);\n\tfloat vw1 = 7.0;\n\tfloat vw2 = (1.0 + 3.0 * t);\n\tfloat v0 = (3.0 - 2.0 * t) / vw0 - 2.0;\n\tfloat v1 = (3.0 + t) / vw1;\n\tfloat v2 = t / vw2 + 2.0;\n\tfloat sum = 0.0;\n\tu0 = u0 * shadowMapSizeInv + base_uv.x;\n\tv0 = v0 * shadowMapSizeInv + base_uv.y;\n\tu1 = u1 * shadowMapSizeInv + base_uv.x;\n\tv1 = v1 * shadowMapSizeInv + base_uv.y;\n\tu2 = u2 * shadowMapSizeInv + base_uv.x;\n\tv2 = v2 * shadowMapSizeInv + base_uv.y;\n\tsum += uw0 * vw0 * textureShadow(shadowMap, vec3(u0, v0, z));\n\tsum += uw1 * vw0 * textureShadow(shadowMap, vec3(u1, v0, z));\n\tsum += uw2 * vw0 * textureShadow(shadowMap, vec3(u2, v0, z));\n\tsum += uw0 * vw1 * textureShadow(shadowMap, vec3(u0, v1, z));\n\tsum += uw1 * vw1 * textureShadow(shadowMap, vec3(u1, v1, z));\n\tsum += uw2 * vw1 * textureShadow(shadowMap, vec3(u2, v1, z));\n\tsum += uw0 * vw2 * textureShadow(shadowMap, vec3(u0, v2, z));\n\tsum += uw1 * vw2 * textureShadow(shadowMap, vec3(u1, v2, z));\n\tsum += uw2 * vw2 * textureShadow(shadowMap, vec3(u2, v2, z));\n\tsum *= 1.0f / 144.0;\n\tsum = saturate(sum);\n\treturn sum;\n}\nfloat getShadowPCF5x5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn _getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);\n}\nfloat getShadowSpotPCF5x5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\treturn _getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);\n}\n",shadowVSM_commonPS:"\nfloat linstep(float a, float b, float v) {\n\treturn saturate((v - a) / (b - a));\n}\nfloat reduceLightBleeding(float pMax, float amount) {\n\t return linstep(amount, 1.0, pMax);\n}\nfloat chebyshevUpperBound(vec2 moments, float mean, float minVariance, float lightBleedingReduction) {\n\tfloat variance = moments.y - (moments.x * moments.x);\n\tvariance = max(variance, minVariance);\n\tfloat d = mean - moments.x;\n\tfloat pMax = variance / (variance + (d * d));\n\tpMax = reduceLightBleeding(pMax, lightBleedingReduction);\n\treturn (mean <= moments.x ? 1.0 : pMax);\n}\nfloat calculateEVSM(vec3 moments, float Z, float vsmBias, float exponent) {\n\tZ = 2.0 * Z - 1.0;\n\tfloat warpedDepth = exp(exponent * Z);\n\tmoments.xy += vec2(warpedDepth, warpedDepth*warpedDepth) * (1.0 - moments.z);\n\tfloat VSMBias = vsmBias;\n\tfloat depthScale = VSMBias * exponent * warpedDepth;\n\tfloat minVariance1 = depthScale * depthScale;\n\treturn chebyshevUpperBound(moments.xy, warpedDepth, minVariance1, 0.1);\n}\n",skinBatchTexVS:"\nattribute float vertex_boneIndices;\nuniform highp sampler2D texture_poseMap;\nuniform vec4 texture_poseMapSize;\nmat4 getBoneMatrix(const in float i) {\n\tfloat j = i * 3.0;\n\tfloat dx = texture_poseMapSize.z;\n\tfloat dy = texture_poseMapSize.w;\n\tfloat y = floor(j * dx);\n\tfloat x = j - (y * texture_poseMapSize.x);\n\ty = dy * (y + 0.5);\n\tvec4 v1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n\tvec4 v2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n\tvec4 v3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, 1\n\t);\n}\n",skinTexVS:"\nattribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\nuniform highp sampler2D texture_poseMap;\nuniform vec4 texture_poseMapSize;\nvoid getBoneMatrix(const in float index, out vec4 v1, out vec4 v2, out vec4 v3) {\n\tfloat i = float(index);\n\tfloat j = i * 3.0;\n\tfloat dx = texture_poseMapSize.z;\n\tfloat dy = texture_poseMapSize.w;\n\t\n\tfloat y = floor(j * dx);\n\tfloat x = j - (y * texture_poseMapSize.x);\n\ty = dy * (y + 0.5);\n\tv1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n\tv2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n\tv3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n}\nmat4 getSkinMatrix(const in vec4 indices, const in vec4 weights) {\n\tvec4 a1, a2, a3;\n\tgetBoneMatrix(indices.x, a1, a2, a3);\n\tvec4 b1, b2, b3;\n\tgetBoneMatrix(indices.y, b1, b2, b3);\n\tvec4 c1, c2, c3;\n\tgetBoneMatrix(indices.z, c1, c2, c3);\n\tvec4 d1, d2, d3;\n\tgetBoneMatrix(indices.w, d1, d2, d3);\n\tvec4 v1 = a1 * weights.x + b1 * weights.y + c1 * weights.z + d1 * weights.w;\n\tvec4 v2 = a2 * weights.x + b2 * weights.y + c2 * weights.z + d2 * weights.w;\n\tvec4 v3 = a3 * weights.x + b3 * weights.y + c3 * weights.z + d3 * weights.w;\n\tfloat one = dot(weights, vec4(1.0));\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, one\n\t);\n}\n",skyboxPS:'\n\t#include "decodePS"\n\t#include "gamma"\n\t#include "tonemappingPS"\n\t#include "envMultiplyPS"\n\tvarying vec3 vViewDir;\n\tuniform float skyboxHighlightMultiplier;\n\t#ifdef SKY_CUBEMAP\n\t\tuniform samplerCube texture_cubeMap;\n\t\t#ifdef SKYMESH\n\t\t\tvarying vec3 vWorldPos;\n\t\t\tuniform mat3 cubeMapRotationMatrix;\n\t\t\tuniform vec3 projectedSkydomeCenter;\n\t\t#endif\n\t#else\n\t\t#include "sphericalPS"\n\t\t#include "envAtlasPS"\n\t\tuniform sampler2D texture_envAtlas;\n\t\tuniform float mipLevel;\n\t#endif\n\tvoid main(void) {\n\t\t#ifdef SKY_CUBEMAP\n\t\t\t#ifdef SKYMESH\n\t\t\t\tvec3 envDir = normalize(vWorldPos - projectedSkydomeCenter);\n\t\t\t\tvec3 dir = envDir * cubeMapRotationMatrix;\n\t\t\t#else\n\t\t\t\tvec3 dir = vViewDir;\n\t\t\t#endif\n\t\t\tdir.x *= -1.0;\n\t\t\tvec3 linear = SKYBOX_DECODE_FNC(textureCube(texture_cubeMap, dir));\n\t\t#else\n\t\t\tvec3 dir = vViewDir * vec3(-1.0, 1.0, 1.0);\n\t\t\tvec2 uv = toSphericalUv(normalize(dir));\n\t\t\tvec3 linear = SKYBOX_DECODE_FNC(texture2D(texture_envAtlas, mapRoughnessUv(uv, mipLevel)));\n\t\t#endif\n\t\tif (any(greaterThanEqual(linear, vec3(64.0)))) {\n\t\t\tlinear *= skyboxHighlightMultiplier;\n\t\t}\n\t\tgl_FragColor = vec4(gammaCorrectOutput(toneMap(processEnvironment(linear))), 1.0);\n\t}\n',skyboxVS:"\nattribute vec3 aPosition;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform mat4 matrix_projectionSkybox;\nuniform mat3 cubeMapRotationMatrix;\nvarying vec3 vViewDir;\n#ifdef SKYMESH\n\tuniform mat4 matrix_model;\n\tvarying vec3 vWorldPos;\n#endif\nvoid main(void) {\n\tmat4 view = matrix_view;\n\t#ifdef SKYMESH\n\t\tvec4 worldPos = matrix_model * vec4(aPosition, 1.0);\n\t\tvWorldPos = worldPos.xyz;\n\t\tgl_Position = matrix_projectionSkybox * view * worldPos;\n\t#else\n\t\tview[3][0] = view[3][1] = view[3][2] = 0.0;\n\t\tgl_Position = matrix_projectionSkybox * view * vec4(aPosition, 1.0);\n\t\tvViewDir = aPosition * cubeMapRotationMatrix;\n\t#endif\n\tgl_Position.z = gl_Position.w - 1.0e-7;\n}\n",specularPS:"\n#ifdef MAPCOLOR\nuniform vec3 material_specular;\n#endif\nvoid getSpecularity() {\n\tvec3 specularColor = vec3(1,1,1);\n\t#ifdef MAPCOLOR\n\tspecularColor *= material_specular;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tspecularColor *= $DECODE(texture2DBias($SAMPLER, $UV, textureBias)).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tspecularColor *= saturate(vVertexColor.$VC);\n\t#endif\n\tdSpecularity = specularColor;\n}\n",sphericalPS:"\nconst float PI = 3.141592653589793;\nvec2 toSpherical(vec3 dir) {\n\treturn vec2(dir.xz == vec2(0.0) ? 0.0 : atan(dir.x, dir.z), asin(dir.y));\n}\nvec2 toSphericalUv(vec3 dir) {\n\tvec2 uv = toSpherical(dir) / vec2(PI * 2.0, PI) + 0.5;\n\treturn vec2(uv.x, 1.0 - uv.y);\n}\n",specularityFactorPS:"\n#ifdef MAPFLOAT\nuniform float material_specularityFactor;\n#endif\nvoid getSpecularityFactor() {\n\tfloat specularityFactor = 1.0;\n\t#ifdef MAPFLOAT\n\tspecularityFactor *= material_specularityFactor;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tspecularityFactor *= texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tspecularityFactor *= saturate(vVertexColor.$VC);\n\t#endif\n\tdSpecularityFactor = specularityFactor;\n}\n",spotPS:"\nfloat getSpotEffect(vec3 lightSpotDir, float lightInnerConeAngle, float lightOuterConeAngle, vec3 lightDirNorm) {\n\tfloat cosAngle = dot(lightDirNorm, lightSpotDir);\n\treturn smoothstep(lightOuterConeAngle, lightInnerConeAngle, cosAngle);\n}\n",startPS:"\nvoid main(void) {\n\tdReflection = vec4(0);\n\t#ifdef LIT_CLEARCOAT\n\tccSpecularLight = vec3(0);\n\tccReflection = vec3(0);\n\t#endif\n",startVS:"\nvoid main(void) {\n\tgl_Position = getPosition();\n",startNineSlicedPS:"\n\tnineSlicedUv = vUv0;\n\tnineSlicedUv.y = 1.0 - nineSlicedUv.y;\n",startNineSlicedTiledPS:"\n\tvec2 tileMask = step(vMask, vec2(0.99999));\n\tvec2 tileSize = 0.5 * (innerOffset.xy + innerOffset.zw);\n\tvec2 tileScale = vec2(1.0) / (vec2(1.0) - tileSize);\n\tvec2 clampedUv = mix(innerOffset.xy * 0.5, vec2(1.0) - innerOffset.zw * 0.5, fract((vTiledUv - tileSize) * tileScale));\n\tclampedUv = clampedUv * atlasRect.zw + atlasRect.xy;\n\tnineSlicedUv = vUv0 * tileMask + clampedUv * (vec2(1.0) - tileMask);\n\tnineSlicedUv.y = 1.0 - nineSlicedUv.y;\n\t\n",storeEVSMPS:"\nfloat exponent = VSM_EXPONENT;\ndepth = 2.0 * depth - 1.0;\ndepth =  exp(exponent * depth);\ngl_FragColor = vec4(depth, depth*depth, 1.0, 1.0);\n",tangentBinormalVS:"\nvec3 getTangent() {\n\treturn normalize(dNormalMatrix * vertex_tangent.xyz);\n}\nvec3 getBinormal() {\n\treturn cross(vNormalW, vTangentW) * vertex_tangent.w;\n}\n",TBNPS:"\nvoid getTBN(vec3 tangent, vec3 binormal, vec3 normal) {\n\tdTBN = mat3(normalize(tangent), normalize(binormal), normalize(normal));\n}\n",TBNderivativePS:"\nuniform float tbnBasis;\nvoid getTBN(vec3 tangent, vec3 binormal, vec3 normal) {\n\tvec2 uv = $UV;\n\tvec3 dp1 = dFdx( vPositionW );\n\tvec3 dp2 = dFdy( vPositionW );\n\tvec2 duv1 = dFdx( uv );\n\tvec2 duv2 = dFdy( uv );\n\tvec3 dp2perp = cross( dp2, normal );\n\tvec3 dp1perp = cross( normal, dp1 );\n\tvec3 T = dp2perp * duv1.x + dp1perp * duv2.x;\n\tvec3 B = dp2perp * duv1.y + dp1perp * duv2.y;\n\tfloat denom = max( dot(T,T), dot(B,B) );\n\tfloat invmax = (denom == 0.0) ? 0.0 : tbnBasis / sqrt( denom );\n\tdTBN = mat3(T * invmax, -B * invmax, normal );\n}\n",TBNObjectSpacePS:"\nvoid getTBN(vec3 tangent, vec3 binormal, vec3 normal) {\n\tvec3 B = cross(normal, vObjectSpaceUpW);\n\tvec3 T = cross(normal, B);\n\tif (dot(B,B)==0.0)\n\t{\n\t\tfloat major=max(max(normal.x, normal.y), normal.z);\n\t\tif (normal.x == major)\n\t\t{\n\t\t\tB=cross(normal, vec3(0,1,0));\n\t\t\tT=cross(normal, B);\n\t\t}\n\t\telse if (normal.y == major)\n\t\t{\n\t\t\tB=cross(normal, vec3(0,0,1));\n\t\t\tT=cross(normal, B);\n\t\t}\n\t\telse if (normal.z == major)\n\t\t{\n\t\t\tB=cross(normal, vec3(1,0,0));\n\t\t\tT=cross(normal, B);\n\t\t}\n\t}\n\tdTBN = mat3(normalize(T), normalize(B), normalize(normal));\n}\n",thicknessPS:"\n#ifdef MAPFLOAT\nuniform float material_thickness;\n#endif\nvoid getThickness() {\n\tdThickness = 1.0;\n\t#ifdef MAPFLOAT\n\tdThickness *= material_thickness;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tdThickness *= texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdThickness *= saturate(vVertexColor.$VC);\n\t#endif\n}\n",tonemappingPS:'\n#if (TONEMAP == NONE)\n\t#include "tonemappingNonePS"\n#elif TONEMAP == FILMIC\n\t#include "tonemappingFilmicPS"\n#elif TONEMAP == LINEAR\n\t#include "tonemappingLinearPS"\n#elif TONEMAP == HEJL\n\t#include "tonemappingHejlPS"\n#elif TONEMAP == ACES\n\t#include "tonemappingAcesPS"\n#elif TONEMAP == ACES2\n\t#include "tonemappingAces2PS"\n#elif TONEMAP == NEUTRAL\n\t#include "tonemappingNeutralPS"\n#endif\n',tonemappingAcesPS:"\nuniform float exposure;\nvec3 toneMap(vec3 color) {\n\tfloat tA = 2.51;\n\tfloat tB = 0.03;\n\tfloat tC = 2.43;\n\tfloat tD = 0.59;\n\tfloat tE = 0.14;\n\tvec3 x = color * exposure;\n\treturn (x*(tA*x+tB))/(x*(tC*x+tD)+tE);\n}\n",tonemappingAces2PS:"\nuniform float exposure;\nconst mat3 ACESInputMat = mat3(\n\t0.59719, 0.35458, 0.04823,\n\t0.07600, 0.90834, 0.01566,\n\t0.02840, 0.13383, 0.83777\n);\nconst mat3 ACESOutputMat = mat3(\n\t 1.60475, -0.53108, -0.07367,\n\t-0.10208,  1.10813, -0.00605,\n\t-0.00327, -0.07276,  1.07602\n);\nvec3 RRTAndODTFit(vec3 v) {\n\tvec3 a = v * (v + 0.0245786) - 0.000090537;\n\tvec3 b = v * (0.983729 * v + 0.4329510) + 0.238081;\n\treturn a / b;\n}\nvec3 toneMap(vec3 color) {\n\tcolor *= exposure / 0.6;\n\tcolor = color * ACESInputMat;\n\tcolor = RRTAndODTFit(color);\n\tcolor = color * ACESOutputMat;\n\tcolor = clamp(color, 0.0, 1.0);\n\treturn color;\n}\n",tonemappingFilmicPS:"\nconst float A =  0.15;\nconst float B =  0.50;\nconst float C =  0.10;\nconst float D =  0.20;\nconst float E =  0.02;\nconst float F =  0.30;\nconst float W =  11.2;\nuniform float exposure;\nvec3 uncharted2Tonemap(vec3 x) {\n\t return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;\n}\nvec3 toneMap(vec3 color) {\n\tcolor = uncharted2Tonemap(color * exposure);\n\tvec3 whiteScale = 1.0 / uncharted2Tonemap(vec3(W,W,W));\n\tcolor = color * whiteScale;\n\treturn color;\n}\n",tonemappingHejlPS:"\nuniform float exposure;\nvec3 toneMap(vec3 color) {\n\tcolor *= exposure;\n\tconst float  A = 0.22, B = 0.3, C = .1, D = 0.2, E = .01, F = 0.3;\n\tconst float Scl = 1.25;\n\tvec3 h = max( vec3(0.0), color - vec3(0.004) );\n\treturn (h*((Scl*A)*h+Scl*vec3(C*B,C*B,C*B))+Scl*vec3(D*E,D*E,D*E)) / (h*(A*h+vec3(B,B,B))+vec3(D*F,D*F,D*F)) - Scl*vec3(E/F,E/F,E/F);\n}\n",tonemappingLinearPS:"\nuniform float exposure;\nvec3 toneMap(vec3 color) {\n\treturn color * exposure;\n}\n",tonemappingNeutralPS:"\nuniform float exposure;\nvec3 toneMap(vec3 color) {\n\tcolor *= exposure;\n\tfloat startCompression = 0.8 - 0.04;\n\tfloat desaturation = 0.15;\n\tfloat x = min(color.r, min(color.g, color.b));\n\tfloat offset = x < 0.08 ? x - 6.25 * x * x : 0.04;\n\tcolor -= offset;\n\tfloat peak = max(color.r, max(color.g, color.b));\n\tif (peak < startCompression) return color;\n\tfloat d = 1. - startCompression;\n\tfloat newPeak = 1. - d * d / (peak + d - startCompression);\n\tcolor *= newPeak / peak;\n\tfloat g = 1. - 1. / (desaturation * (peak - newPeak) + 1.);\n\treturn mix(color, newPeak * vec3(1, 1, 1), g);\n}\n",tonemappingNonePS:"\nvec3 toneMap(vec3 color) {\n\treturn color;\n}\n",transformVS:"\n#ifdef PIXELSNAP\nuniform vec4 uScreenSize;\n#endif\n#ifdef SCREENSPACE\nuniform float projectionFlipY;\n#endif\nvec4 evalWorldPosition(vec3 vertexPosition, mat4 modelMatrix) {\n\tvec3 localPos = getLocalPosition(vertexPosition);\n\t#ifdef NINESLICED\n\t\tlocalPos.xz *= outerScale;\n\t\tvec2 positiveUnitOffset = clamp(vertexPosition.xz, vec2(0.0), vec2(1.0));\n\t\tvec2 negativeUnitOffset = clamp(-vertexPosition.xz, vec2(0.0), vec2(1.0));\n\t\tlocalPos.xz += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n\t\tvTiledUv = (localPos.xz - outerScale + innerOffset.xy) * -0.5 + 1.0;\n\t\tlocalPos.xz *= -0.5;\n\t\tlocalPos = localPos.xzy;\n\t#endif\n\tvec4 posW = modelMatrix * vec4(localPos, 1.0);\n\t#ifdef SCREENSPACE\n\t\tposW.zw = vec2(0.0, 1.0);\n\t#endif\n\treturn posW;\n}\nvec4 getPosition() {\n\tdModelMatrix = getModelMatrix();\n\tvec4 posW = evalWorldPosition(vertex_position.xyz, dModelMatrix);\n\tdPositionW = posW.xyz;\n\tvec4 screenPos;\n\t#ifdef UV1LAYOUT\n\tscreenPos = vec4(vertex_texCoord1.xy * 2.0 - 1.0, 0.5, 1);\n\t\t#ifdef WEBGPU\n\t\tscreenPos.y *= -1.0;\n\t\t#endif\n\t#else\n\t#ifdef SCREENSPACE\n\tscreenPos = posW;\n\tscreenPos.y *= projectionFlipY;\n\t#else\n\tscreenPos = matrix_viewProjection * posW;\n\t#endif\n\t#ifdef PIXELSNAP\n\tscreenPos.xy = (screenPos.xy * 0.5) + 0.5;\n\tscreenPos.xy *= uScreenSize.xy;\n\tscreenPos.xy = floor(screenPos.xy);\n\tscreenPos.xy *= uScreenSize.zw;\n\tscreenPos.xy = (screenPos.xy * 2.0) - 1.0;\n\t#endif\n\t#endif\n\treturn screenPos;\n}\nvec3 getWorldPosition() {\n\treturn dPositionW;\n}\n",transformCoreVS:'\nattribute vec4 vertex_position;\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\n#ifdef MORPHING\n\tuniform vec2 morph_tex_params;\n\tattribute uint morph_vertex_id;\n\tivec2 getTextureMorphCoords() {\n\t\tivec2 textureSize = ivec2(morph_tex_params);\n\t\tint morphGridV = int(morph_vertex_id) / textureSize.x;\n\t\tint morphGridU = int(morph_vertex_id) - (morphGridV * textureSize.x);\n\t\t#ifdef WEBGPU\n\t\t\tmorphGridV = textureSize.y - morphGridV - 1;\n\t\t#endif\n\t\treturn ivec2(morphGridU, morphGridV);\n\t}\n\t#ifdef MORPHING_POSITION\n\t\t#ifdef MORPHING_INT\n\t\t\tuniform vec3 aabbSize;\n\t\t\tuniform vec3 aabbMin;\n\t\t\tuniform usampler2D morphPositionTex;\n\t\t#else\n\t\t\tuniform highp sampler2D morphPositionTex;\n\t\t#endif\n\t#endif\n#endif\n#ifdef defined(BATCH)\n\t#include "skinBatchTexVS"\n\tmat4 getModelMatrix() {\n\t\treturn getBoneMatrix(vertex_boneIndices);\n\t}\n#elif defined(SKIN)\n\t#include "skinTexVS"\n\tmat4 getModelMatrix() {\n\t\treturn matrix_model * getSkinMatrix(vertex_boneIndices, vertex_boneWeights);\n\t}\n#elif defined(INSTANCING)\n\t#include "transformInstancing"\n#else\n\tmat4 getModelMatrix() {\n\t\treturn matrix_model;\n\t}\n#endif\nvec3 getLocalPosition(vec3 vertexPosition) {\n\tvec3 localPos = vertexPosition;\n\t#ifdef MORPHING_POSITION\n\t\tivec2 morphUV = getTextureMorphCoords();\n\t\t#ifdef MORPHING_INT\n\t\t\tvec3 morphPos = vec3(texelFetch(morphPositionTex, ivec2(morphUV), 0).xyz) / 65535.0 * aabbSize + aabbMin;\n\t\t#else\n\t\t\tvec3 morphPos = texelFetch(morphPositionTex, ivec2(morphUV), 0).xyz;\n\t\t#endif\n\t\tlocalPos += morphPos;\n\t#endif\n\treturn localPos;\n}\n',transformInstancingVS:"\nattribute vec4 instance_line1;\nattribute vec4 instance_line2;\nattribute vec4 instance_line3;\nattribute vec4 instance_line4;\nmat4 getModelMatrix() {\n\treturn matrix_model * mat4(instance_line1, instance_line2, instance_line3, instance_line4);\n}\n",transmissionPS:"\n#ifdef MAPFLOAT\nuniform float material_refraction;\n#endif\nvoid getRefraction() {\n\tfloat refraction = 1.0;\n\t#ifdef MAPFLOAT\n\trefraction = material_refraction;\n\t#endif\n\t#ifdef MAPTEXTURE\n\trefraction *= texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\trefraction *= saturate(vVertexColor.$VC);\n\t#endif\n\tdTransmission = refraction;\n}\n",twoSidedLightingPS:"\nuniform float twoSidedLightingNegScaleFactor;\nvoid handleTwoSidedLighting() {\n\tdTBN[2] *= gl_FrontFacing ? twoSidedLightingNegScaleFactor : -twoSidedLightingNegScaleFactor;\n}\n",uv0VS:"\n#ifdef NINESLICED\nvec2 getUv0() {\n\tvec2 uv = vertex_position.xz;\n\tvec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));\n\tvec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));\n\tuv += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n\tuv = uv * -0.5 + 0.5;\n\tuv = uv * atlasRect.zw + atlasRect.xy;\n\tvMask = vertex_texCoord0.xy;\n\treturn uv;\n}\n#else\nvec2 getUv0() {\n\treturn vertex_texCoord0;\n}\n#endif\n",uv1VS:"\nvec2 getUv1() {\n\treturn vertex_texCoord1;\n}\n",viewDirPS:"\nvoid getViewDir() {\n\tdViewDirW = normalize(view_position - vPositionW);\n}\n",viewNormalVS:"\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nvec3 getViewNormal() {\n\treturn mat3(matrix_view) * vNormalW;\n}\n",webgpuPS:pa,webgpuVS:fa},dl=new _n;function ul(e){return dl.get(e)}class pl{static begin(){return"void main(void)\n{\n"}static end(){return"}\n"}static definesHash(e){const t=Array.from(e).sort(((e,t)=>e[0]>t[0]?1:-1));return jn(JSON.stringify(t))}static fogCode(e,t=cl){var s,i,n;return"linear"===e?null!=(s=t.fogLinearPS)?s:cl.fogLinearPS:"exp"===e?null!=(i=t.fogExpPS)?i:cl.fogExpPS:"exp2"===e?null!=(n=t.fogExp2PS)?n:cl.fogExp2PS:t.fogNonePS?t.fogNonePS:cl.fogNonePS}static gammaCode(e,t=cl){var s,i;return 1===e?null!=(i=t.gamma2_2PS)?i:cl.gamma2_2PS:null!=(s=t.gamma1_0PS)?s:cl.gamma1_0PS}static tonemapCode(e,t=cl){var s,i,n,r,a,o,l;switch(e){case 1:return null!=(s=t.tonemappingFilmicPS)?s:cl.tonemappingFilmicPS;case 0:return null!=(i=t.tonemappingLinearPS)?i:cl.tonemappingLinearPS;case 2:return null!=(n=t.tonemappingHejlPS)?n:cl.tonemappingHejlPS;case 3:return null!=(r=t.tonemappingAcesPS)?r:cl.tonemappingAcesPS;case 4:return null!=(a=t.tonemappingAces2PS)?a:cl.tonemappingAces2PS;case 5:return null!=(o=t.tonemappingNeutralPS)?o:cl.tonemappingNeutralPS}return null!=(l=t.tonemapingNonePS)?l:cl.tonemappingNonePS}}function fl(e,t,s,i,n,r=!1,a={}){"boolean"==typeof r?a.useTransformFeedback=r:"object"==typeof r&&(a=kn({},a,r));const o=ul(e);let l=o.getCachedShader(i);return l||(l=new ba(e,_a.createDefinition(e,kn({},a,{name:i,vertexCode:t,fragmentCode:s,attributes:n}))),o.setCachedShader(i,l)),l}class ml extends pl{constructor(e,t){super(),this.key=e,this.shaderDefinition=t}generateKey(e){return this.key}createShaderDefinition(e,t){return this.shaderDefinition}}const gl=(e,t)=>{const s=new Map(e.defines);return t.defines.forEach(((e,t)=>s.set(t,e))),s},_l={type:5,base:0,count:4,indexed:!1},vl=new Ss,bl=new Ss,yl=new En;class xl{constructor(e){this.uniformBuffer=void 0,this.bindGroup=void 0;const t=e.device;if(this.shader=e,t.supportsUniformBuffers){const s=new ol;this.shader=function(e,t){var s;const i=e.definition,n=`${null!=(s=i.name)?s:"shader"}-id-${e.id}`,r=new ml(n,i),a="shader",o=ul(e.device);o.register(a,r);const l=o.getProgram(a,{},t);return e.definition.shaderLanguage===Ui&&(l.meshUniformBufferFormat=i.meshUniformBufferFormat,l.meshBindGroupFormat=i.meshBindGroupFormat),o.unregister(a),l}(e,s);const i=this.shader.meshUniformBufferFormat;i&&(this.uniformBuffer=new Ca(t,i,!1));const n=this.shader.meshBindGroupFormat;this.bindGroup=new Pn(t,n)}}destroy(){var e,t;null==(e=this.uniformBuffer)||e.destroy(),this.uniformBuffer=null,null==(t=this.bindGroup)||t.destroy(),this.bindGroup=null}render(e,t){const s=this.shader.device;var i;e&&(vl.set(s.vx,s.vy,s.vw,s.vh),bl.set(s.sx,s.sy,s.sw,s.sh),t=null!=(i=t)?i:e,s.setViewport(e.x,e.y,e.z,e.w),s.setScissor(t.x,t.y,t.z,t.w));s.setVertexBuffer(s.quadVertexBuffer,0);const n=this.shader;if(s.setShader(n),s.supportsUniformBuffers){s.setBindGroup(0,s.emptyBindGroup);const e=this.bindGroup;e.update(),s.setBindGroup(1,e);const t=this.uniformBuffer;t?(t.update(yl),s.setBindGroup(2,yl.bindGroup,yl.offsets)):s.setBindGroup(2,s.emptyBindGroup)}s.draw(_l),e&&(s.setViewport(vl.x,vl.y,vl.z,vl.w),s.setScissor(bl.x,bl.y,bl.z,bl.w))}}class wl extends uo{constructor(e,t,s,i){super(e),this.quad=t,this.rect=s,this.scissorRect=i}execute(){const{device:e}=this;e.setCullMode(0),e.setDepthState(On.NODEPTH),e.setStencilState(null,null),this.quad.render(this.rect,this.scissorRect)}}const Sl=new Ss;function Cl(e,t,s,i,n){const r=new xl(s);i||((i=Sl).x=0,i.y=0,i.z=t?t.width:e.width,i.w=t?t.height:e.height);const a=new wl(e,r,i,n);a.init(t),a.colorOps.clear=!1,a.depthStencilOps.clearDepth=!1,e.isWebGPU&&null===t&&e.samples>1&&(a.colorOps.store=!0),a.render(),r.destroy()}class Tl{constructor(e,t,s,i,n=[0]){this._ui=!1,this._sprite=!1,this._obj={model:[],element:[],sprite:[],render:[]},this.id=void 0,this.name=void 0,this.dynamic=void 0,this.maxAabbSize=void 0,this.layers=void 0,this.id=e,this.name=t,this.dynamic=s,this.maxAabbSize=i,this.layers=n}}Tl.MODEL="model",Tl.ELEMENT="element",Tl.SPRITE="sprite",Tl.RENDER="render";const El=new As;class Pl{constructor(e){this.bones=void 0,this.boneTextureSize=void 0,this._dirty=!0,this._rootBone=null,this._skinUpdateIndex=-1,this._updateBeforeCull=!0,e&&this.initSkin(e)}set rootBone(e){this._rootBone=e}get rootBone(){return this._rootBone}init(e,t){const s=3*t;let i=Math.ceil(Math.sqrt(s));i=rs.roundUp(i,3);const n=Math.ceil(s/i);this.boneTexture=new yn(e,{width:i,height:n,format:$s,mipmaps:!1,minFilter:0,magFilter:0,name:"skin"}),this.boneTextureSize=[i,n,1/i,1/n],this.matrixPalette=this.boneTexture.lock({mode:1}),this.boneTexture.unlock()}destroy(){this.boneTexture&&(this.boneTexture.destroy(),this.boneTexture=null)}resolve(e,t){this.rootBone=e;const s=this.skin,i=[];for(let n=0;n<s.boneNames.length;n++){const r=s.boneNames[n];let a=e.findByName(r);a||(a=t),i.push(a)}this.bones=i}initSkin(e){this.skin=e,this.bones=[];const t=e.inverseBindPose.length;this.init(e.device,t),this.matrices=[];for(let e=0;e<t;e++)this.matrices[e]=new As}uploadBones(e){this.boneTexture.upload()}_updateMatrices(e,t){if(this._skinUpdateIndex!==t){this._skinUpdateIndex=t,El.copy(e.getWorldTransform()).invert();for(let e=this.bones.length-1;e>=0;e--)this.matrices[e].mulAffine2(El,this.bones[e].getWorldTransform()),this.matrices[e].mulAffine2(this.matrices[e],this.skin.inverseBindPose[e])}}updateMatrices(e,t){this._updateBeforeCull&&this._updateMatrices(e,t)}updateMatrixPalette(e,t){this._updateMatrices(e,t);const s=this.matrixPalette,i=this.bones.length;for(let e=0;e<i;e++){const t=this.matrices[e].data,i=12*e;s[i]=t[0],s[i+1]=t[4],s[i+2]=t[8],s[i+3]=t[12],s[i+4]=t[1],s[i+5]=t[5],s[i+6]=t[9],s[i+7]=t[13],s[i+8]=t[2],s[i+9]=t[6],s[i+10]=t[10],s[i+11]=t[14]}this.uploadBones(this.skin.device)}}let kl=0;class Al{constructor(){this.initDefaults()}initDefaults(){this.recreate=!1,this.verticesUsage=0,this.indicesUsage=0,this.maxVertices=0,this.maxIndices=0,this.vertexCount=0,this.indexCount=0,this.vertexStreamsUpdated=!1,this.indexStreamUpdated=!1,this.vertexStreamDictionary={},this.indices=null}_changeVertexCount(e,t){this.vertexCount||(this.vertexCount=e)}}Al.DEFAULT_COMPONENTS_POSITION=3,Al.DEFAULT_COMPONENTS_NORMAL=3,Al.DEFAULT_COMPONENTS_UV=2,Al.DEFAULT_COMPONENTS_COLORS=4;class Ml{constructor(e,t,s,i,n){this.data=e,this.componentCount=t,this.dataType=s,this.dataTypeNormalize=i,this.asInt=n}}class Dl extends Tr{constructor(e,t){super(),this.indexBuffer=[null],this.vertexBuffer=null,this.primitive=[{type:0,base:0,count:0}],this.skin=null,this.boneAabb=null,this._aabbVer=0,this._aabb=new Bs,this._geometryData=null,this._morph=null,this._storageIndex=!1,this._storageVertex=!1,this.id=kl++,this.device=e,this._storageIndex=(null==t?void 0:t.storageIndex)||!1,this._storageVertex=(null==t?void 0:t.storageVertex)||!1}static fromGeometry(e,t,s={}){const i=new Dl(e,s),{positions:n,normals:r,tangents:a,colors:o,uvs:l,uvs1:h,blendIndices:c,blendWeights:d,indices:u}=t;return n&&i.setPositions(n),r&&i.setNormals(r),a&&i.setVertexStream(ci,a,4),o&&i.setColors32(o),l&&i.setUvs(0,l),h&&i.setUvs(1,h),c&&i.setVertexStream(ui,c,4,c.length/4,1),d&&i.setVertexStream(di,d,4),u&&i.setIndices(u),i.update(),i}set morph(e){e!==this._morph&&(this._morph&&this._morph.decRefCount(),this._morph=e,e&&e.incRefCount())}get morph(){return this._morph}set aabb(e){this._aabb=e,this._aabbVer++}get aabb(){return this._aabb}destroy(){const e=this.morph;e&&(this.morph=null,e.refCount<1&&e.destroy()),this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);for(let e=0;e<this.indexBuffer.length;e++)this._destroyIndexBuffer(e);this.indexBuffer.length=0,this._geometryData=null}_destroyIndexBuffer(e){this.indexBuffer[e]&&(this.indexBuffer[e].destroy(),this.indexBuffer[e]=null)}_initBoneAabbs(e){let t,s,i,n,r;this.boneAabb=[],this.boneUsed=[];const a=[],o=[],l=this.boneUsed,h=this.skin.boneNames.length;let c,d,u;for(let e=0;e<h;e++)a[e]=new ys(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),o[e]=new ys(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);const p=new Eo(this.vertexBuffer),f=p.element[li],m=p.element[di],g=p.element[ui],_=this.vertexBuffer.numVertices;for(let h=0;h<_;h++){for(let p=0;p<4;p++){if(m.array[m.index+p]>0){const m=g.array[g.index+p];if(l[m]=!0,t=f.array[f.index],s=f.array[f.index+1],i=f.array[f.index+2],n=o[m],r=a[m],r.x>t&&(r.x=t),r.y>s&&(r.y=s),r.z>i&&(r.z=i),n.x<t&&(n.x=t),n.y<s&&(n.y=s),n.z<i&&(n.z=i),e){let a=c=t,o=d=s,l=u=i;for(let t=0;t<e.length;t++){const s=e[t],i=s.deltaPositions[3*h],n=s.deltaPositions[3*h+1],r=s.deltaPositions[3*h+2];i<0?a+=i:c+=i,n<0?o+=n:d+=n,r<0?l+=r:u+=r}r.x>a&&(r.x=a),r.y>o&&(r.y=o),r.z>l&&(r.z=l),n.x<c&&(n.x=c),n.y<d&&(n.y=d),n.z<u&&(n.z=u)}}}p.next()}const v=this.vertexBuffer.getFormat().elements.find((e=>e.name===li));if(v&&v.normalize){const e=(()=>{switch(v.dataType){case 0:return e=>Math.max(e/127,-1);case 1:return e=>e/255;case 2:return e=>Math.max(e/32767,-1);case 3:return e=>e/65535;default:return e=>e}})();for(let t=0;t<h;t++)if(l[t]){const s=a[t],i=o[t];s.set(e(s.x),e(s.y),e(s.z)),i.set(e(i.x),e(i.y),e(i.z))}}for(let e=0;e<h;e++){const t=new Bs;t.setMinMax(a[e],o[e]),this.boneAabb.push(t)}}_initGeometryData(){this._geometryData||(this._geometryData=new Al,this.vertexBuffer&&(this._geometryData.vertexCount=this.vertexBuffer.numVertices,this._geometryData.maxVertices=this.vertexBuffer.numVertices),this.indexBuffer.length>0&&this.indexBuffer[0]&&(this._geometryData.indexCount=this.indexBuffer[0].numIndices,this._geometryData.maxIndices=this.indexBuffer[0].numIndices))}clear(e,t,s=0,i=0){this._initGeometryData(),this._geometryData.initDefaults(),this._geometryData.recreate=!0,this._geometryData.maxVertices=s,this._geometryData.maxIndices=i,this._geometryData.verticesUsage=e?0:1,this._geometryData.indicesUsage=t?0:1}setVertexStream(e,t,s,i,n=6,r=!1,a=!1){this._initGeometryData();const o=i||t.length/s;this._geometryData._changeVertexCount(o,e),this._geometryData.vertexStreamsUpdated=!0,this._geometryData.vertexStreamDictionary[e]=new Ml(t,s,n,r,a)}getVertexStream(e,t){let s=0,i=!1;if(this._geometryData){const n=this._geometryData.vertexStreamDictionary[e];n&&(i=!0,s=this._geometryData.vertexCount,ArrayBuffer.isView(t)?t.set(n.data):(t.length=0,t.push(n.data)))}if(!i&&this.vertexBuffer){s=new Eo(this.vertexBuffer).readData(e,t)}return s}setPositions(e,t=Al.DEFAULT_COMPONENTS_POSITION,s){this.setVertexStream(li,e,t,s,6,!1)}setNormals(e,t=Al.DEFAULT_COMPONENTS_NORMAL,s){this.setVertexStream(hi,e,t,s,6,!1)}setUvs(e,t,s=Al.DEFAULT_COMPONENTS_UV,i){this.setVertexStream(fi+e,t,s,i,6,!1)}setColors(e,t=Al.DEFAULT_COMPONENTS_COLORS,s){this.setVertexStream(pi,e,t,s,6,!1)}setColors32(e,t){this.setVertexStream(pi,e,Al.DEFAULT_COMPONENTS_COLORS,t,1,!0)}setIndices(e,t){this._initGeometryData(),this._geometryData.indexStreamUpdated=!0,this._geometryData.indices=e,this._geometryData.indexCount=t||e.length}getPositions(e){return this.getVertexStream(li,e)}getNormals(e){return this.getVertexStream(hi,e)}getUvs(e,t){return this.getVertexStream(fi+e,t)}getColors(e){return this.getVertexStream(pi,e)}getIndices(e){let t=0;if(this._geometryData&&this._geometryData.indices){const s=this._geometryData.indices;if(t=this._geometryData.indexCount,ArrayBuffer.isView(e))e.set(s);else{e.length=0;for(let t=0,i=s.length;t<i;t++)e.push(s[t])}}else if(this.indexBuffer.length>0&&this.indexBuffer[0]){t=this.indexBuffer[0].readData(e)}return t}update(e=4,t=!0){if(this._geometryData){if(t){const e=this._geometryData.vertexStreamDictionary[li];e&&3===e.componentCount&&(this._aabb.compute(e.data,this._geometryData.vertexCount),this._aabbVer++)}let s=this._geometryData.recreate;this._geometryData.vertexCount>this._geometryData.maxVertices&&(s=!0,this._geometryData.maxVertices=this._geometryData.vertexCount),s&&this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);let i=this._geometryData.recreate;this._geometryData.indexCount>this._geometryData.maxIndices&&(i=!0,this._geometryData.maxIndices=this._geometryData.indexCount),i&&this.indexBuffer.length>0&&this.indexBuffer[0]&&(this.indexBuffer[0].destroy(),this.indexBuffer[0]=null),this._geometryData.vertexStreamsUpdated&&this._updateVertexBuffer(),this._geometryData.indexStreamUpdated&&this._updateIndexBuffer(),this.primitive[0].type=e,this.indexBuffer.length>0&&this.indexBuffer[0]?this._geometryData.indexStreamUpdated&&(this.primitive[0].count=this._geometryData.indexCount,this.primitive[0].indexed=!0):this._geometryData.vertexStreamsUpdated&&(this.primitive[0].count=this._geometryData.vertexCount,this.primitive[0].indexed=!1),this._geometryData.vertexCount=0,this._geometryData.indexCount=0,this._geometryData.vertexStreamsUpdated=!1,this._geometryData.indexStreamUpdated=!1,this._geometryData.recreate=!1,this.updateRenderStates()}}_buildVertexFormat(e){const t=[];for(const e in this._geometryData.vertexStreamDictionary){const s=this._geometryData.vertexStreamDictionary[e];t.push({semantic:e,components:s.componentCount,type:s.dataType,normalize:s.dataTypeNormalize,asInt:s.asInt})}return new Kn(this.device,t,e)}_updateVertexBuffer(){if(!this.vertexBuffer){const e=this._geometryData.maxVertices,t=this._buildVertexFormat(e);this.vertexBuffer=new Hn(this.device,t,e,{usage:this._geometryData.verticesUsage,storage:this._storageVertex})}const e=new Eo(this.vertexBuffer),t=this._geometryData.vertexCount;for(const s in this._geometryData.vertexStreamDictionary){const i=this._geometryData.vertexStreamDictionary[s];e.writeData(s,i.data,t),delete this._geometryData.vertexStreamDictionary[s]}e.end()}_updateIndexBuffer(){if(this.indexBuffer.length<=0||!this.indexBuffer[0]){const e=this._geometryData.maxVertices,t=e>65535||0===e?2:1,s=this._storageIndex?{storage:!0}:void 0;this.indexBuffer[0]=new lo(this.device,t,this._geometryData.maxIndices,this._geometryData.indicesUsage,void 0,s)}const e=this._geometryData.indices;if(e){this.indexBuffer[0].writeData(e,this._geometryData.indexCount),this._geometryData.indices=null}}prepareRenderState(e){1===e?this.generateWireframe():2===e&&(this.primitive[2]={type:0,base:0,count:this.vertexBuffer?this.vertexBuffer.numVertices:0,indexed:!1})}updateRenderStates(){this.primitive[2]&&this.prepareRenderState(2),this.primitive[1]&&this.prepareRenderState(1)}generateWireframe(){this._destroyIndexBuffer(1);const e=this.vertexBuffer.numVertices,t=[];let s;if(this.indexBuffer.length>0&&this.indexBuffer[0]){const i=[[0,1],[1,2],[2,0]],n=this.primitive[0].base,r=this.primitive[0].count,a=this.indexBuffer[0],o=new rn[a.format](a.storage),l=new Set;for(let s=n;s<n+r;s+=3)for(let n=0;n<3;n++){const r=o[s+i[n][0]],a=o[s+i[n][1]],h=r>a?a*e+r:r*e+a;l.has(h)||(l.add(h),t.push(r,a))}s=a.format}else{for(let s=0;s<e;s+=3)t.push(s,s+1,s+1,s+2,s+2,s);s=t.length>65535?2:1}const i=new lo(this.vertexBuffer.device,s,t.length);new rn[i.format](i.storage).set(t),i.unlock(),this.primitive[1]={type:1,base:0,count:t.length,indexed:!0},this.indexBuffer[1]=i}}const Rl=new _n;function Ll(e){return Rl.get(e)}class Il{static incRef(e){this.cache.incRef(e)}static decRef(e){this.cache.decRef(e)}static destroy(){this.cache.destroy()}}Il.cache=new class{constructor(){this.cache=new Map}destroy(){this.cache.forEach(((e,t)=>{t.destroy()})),this.cache.clear()}incRef(e){const t=(this.cache.get(e)||0)+1;this.cache.set(e,t)}decRef(e){if(e){let t=this.cache.get(e);t&&(t--,0===t?(this.cache.delete(e),e.destroy()):this.cache.set(e,t))}}};let Fl=0;const Ol=new Bs,Bl=new Bs,zl=new Us,Nl=new Set,Ul=new Uint32Array(4);class Vl{constructor(e){this.vertexBuffer=null,this._destroyVertexBuffer=!1,this.count=e}destroy(){var e;this._destroyVertexBuffer&&(null==(e=this.vertexBuffer)||e.destroy());this.vertexBuffer=null}}class Gl{constructor(){this.shader=void 0,this.bindGroup=null,this.uniformBuffer=null,this.hashes=void 0}getBindGroup(e){if(!this.bindGroup){const t=this.shader.meshBindGroupFormat;this.bindGroup=new Pn(e,t)}return this.bindGroup}getUniformBuffer(e){if(!this.uniformBuffer){const t=this.shader.meshUniformBufferFormat;this.uniformBuffer=new Ca(e,t,!1)}return this.uniformBuffer}destroy(){var e,t;null==(e=this.bindGroup)||e.destroy(),this.bindGroup=null,null==(t=this.uniformBuffer)||t.destroy(),this.uniformBuffer=null}}class Hl{constructor(e,t,s=null){if(this.castShadow=!1,this.cull=!0,this.drawOrder=0,this.node=void 0,this.visible=!0,this.visibleThisFrame=!1,this.flipFacesFactor=1,this.gsplatInstance=null,this.id=Fl++,this.isVisibleFunc=null,this.instancingData=null,this.parameters={},this.pick=!0,this.stencilFront=null,this.stencilBack=null,this.transparent=!1,this._aabb=new Bs,this._aabbVer=-1,this._aabbMeshVer=-1,this._customAabb=null,this._updateAabb=!0,this._updateAabbFunc=null,this._key=[0,0],this._layer=15,this._material=null,this._skinInstance=null,this._morphInstance=null,this._receiveShadow=!0,this._renderStyle=0,this._screenSpace=!1,this._shaderCache=new Map,this._shaderDefs=65536,this._calculateSortDistance=null,this.node=s,this._mesh=e,e.incRefCount(),this.material=t,e.vertexBuffer){const t=e.vertexBuffer.format;this._shaderDefs|=t.hasUv0?4:0,this._shaderDefs|=t.hasUv1?8:0,this._shaderDefs|=t.hasColor?16:0,this._shaderDefs|=t.hasTangents?512:0}this.updateKey()}set renderStyle(e){this._renderStyle=e,this.mesh.prepareRenderState(e)}get renderStyle(){return this._renderStyle}set mesh(e){e!==this._mesh&&(this._mesh&&this._mesh.decRefCount(),this._mesh=e,e&&e.incRefCount())}get mesh(){return this._mesh}set aabb(e){this._aabb=e}get aabb(){if(!this._updateAabb)return this._aabb;if(this._updateAabbFunc)return this._updateAabbFunc(this._aabb);let e=this._customAabb,t=!!e;if(!e)if(e=Ol,this.skinInstance){if(!this.mesh.boneAabb){const e=this._morphInstance?this._morphInstance.morph._targets:null;this.mesh._initBoneAabbs(e)}const s=this.mesh.boneUsed;let i=!0;for(let t=0;t<this.mesh.boneAabb.length;t++)s[t]&&(Bl.setFromTransformedAabb(this.mesh.boneAabb[t],this.skinInstance.matrices[t]),i?(i=!1,e.center.copy(Bl.center),e.halfExtents.copy(Bl.halfExtents)):e.add(Bl));t=!0}else if(this.node._aabbVer!==this._aabbVer||this.mesh._aabbVer!==this._aabbMeshVer){if(this.mesh?(e.center.copy(this.mesh.aabb.center),e.halfExtents.copy(this.mesh.aabb.halfExtents)):(e.center.set(0,0,0),e.halfExtents.set(0,0,0)),this.mesh&&this.mesh.morph){const t=this.mesh.morph.aabb;e._expand(t.getMin(),t.getMax())}t=!0,this._aabbVer=this.node._aabbVer,this._aabbMeshVer=this.mesh._aabbVer}return t&&this._aabb.setFromTransformedAabb(e,this.node.getWorldTransform()),this._aabb}clearShaders(){this._shaderCache.forEach((e=>{e.destroy()})),this._shaderCache.clear()}getShaderInstance(e,t,s,i,n,r,a){const o=this._shaderDefs;Ul[0]=e,Ul[1]=t,Ul[2]=o,Ul[3]=i.hash;const l=Wn(Ul);let h=this._shaderCache.get(l);if(!h){const t=this._material;if(h=new Gl,h.shader=t.variants.get(l),h.hashes=new Uint32Array(Ul),!h.shader){var c;const d=t.getShaderVariant({device:this.mesh.device,scene:s,objDefs:o,cameraShaderParams:i,pass:e,sortedLights:a,viewUniformFormat:n,viewBindGroupFormat:r,vertexFormat:null==(c=this.mesh.vertexBuffer)?void 0:c.format});t.variants.set(l,d),h.shader=d}this._shaderCache.set(l,h)}return h}set material(e){this.clearShaders();const t=this._material;t&&t.removeMeshInstanceRef(this),this._material=e,e&&(e.addMeshInstanceRef(this),this.transparent=e.transparent,this.updateKey())}get material(){return this._material}set layer(e){this._layer=e,this.updateKey()}get layer(){return this._layer}_updateShaderDefs(e){e!==this._shaderDefs&&(this._shaderDefs=e,this.clearShaders())}set calculateSortDistance(e){this._calculateSortDistance=e}get calculateSortDistance(){return this._calculateSortDistance}set receiveShadow(e){this._receiveShadow!==e&&(this._receiveShadow=e,this._updateShaderDefs(e?-2&this._shaderDefs:1|this._shaderDefs))}get receiveShadow(){return this._receiveShadow}set batching(e){this._updateShaderDefs(e?this._shaderDefs|el:-16385&this._shaderDefs)}get batching(){return!!(this._shaderDefs&el)}set skinInstance(e){this._skinInstance=e,this._updateShaderDefs(e?2|this._shaderDefs:-3&this._shaderDefs),this._setupSkinUpdate()}get skinInstance(){return this._skinInstance}set morphInstance(e){var t;null==(t=this._morphInstance)||t.destroy(),this._morphInstance=e;let s=this._shaderDefs;s=e&&e.morph.morphPositions?s|Yo:-1025&s,s=e&&e.morph.morphNormals?s|Qo:-2049&s,s=e&&e.morph.intRenderFormat?s|Zo:-8193&s,this._updateShaderDefs(s)}get morphInstance(){return this._morphInstance}set screenSpace(e){this._screenSpace!==e&&(this._screenSpace=e,this._updateShaderDefs(e?this._shaderDefs|Ko:-257&this._shaderDefs))}get screenSpace(){return this._screenSpace}set key(e){this._key[0]=e}get key(){return this._key[0]}set mask(e){const t=65535&this._shaderDefs;this._updateShaderDefs(t|e<<16)}get mask(){return this._shaderDefs>>16}set instancingCount(e){this.instancingData&&(this.instancingData.count=e)}get instancingCount(){return this.instancingData?this.instancingData.count:0}destroy(){var e,t,s;const i=this.mesh;i&&(this.mesh=null,i.refCount<1&&i.destroy()),this.setRealtimeLightmap(Hl.lightmapParamNames[0],null),this.setRealtimeLightmap(Hl.lightmapParamNames[1],null),null==(e=this._skinInstance)||e.destroy(),this._skinInstance=null,null==(t=this.morphInstance)||t.destroy(),this.morphInstance=null,this.clearShaders(),this.material=null,null==(s=this.instancingData)||s.destroy()}static _prepareRenderStyleForArray(e,t){if(e){for(let s=0;s<e.length;s++){e[s]._renderStyle=t;const i=e[s].mesh;Nl.has(i)||(Nl.add(i),i.prepareRenderState(t))}Nl.clear()}}_isVisible(e){return!!this.visible&&(this.isVisibleFunc?this.isVisibleFunc(e):(zl.center=this.aabb.center,zl.radius=this._aabb.halfExtents.length(),e.frustum.containsSphere(zl)>0))}updateKey(){const e=this.material,t=e.alphaToCoverage||e.alphaTest?2:e.blendType;this._key[0]=(15&this.layer)<<27|(3===t?1:0)<<26|33554431&e.id}setInstancing(e,t=!1){e?(this.instancingData=new Vl(e.numVertices),this.instancingData.vertexBuffer=e,e.format.instancing=!0,this.cull=t):(this.instancingData=null,this.cull=!0),this._updateShaderDefs(e?32|this._shaderDefs:-33&this._shaderDefs)}ensureMaterial(e){this.material||(this.material=Ll(e))}clearParameters(){this.parameters={}}getParameters(){return this.parameters}getParameter(e){return this.parameters[e]}setParameter(e,t,s=4294967295){const i=this.parameters[e];i?(i.data=t,i.passFlags=s):this.parameters[e]={scopeId:null,data:t,passFlags:s}}setRealtimeLightmap(e,t){const s=this.getParameter(e);s!==t&&(s&&Il.decRef(s.data),t?(Il.incRef(t),this.setParameter(e,t)):this.deleteParameter(e))}deleteParameter(e){this.parameters[e]&&delete this.parameters[e]}setParameters(e,t){const s=this.parameters;for(const i in s){const n=s[i];n.passFlags&t&&(n.scopeId||(n.scopeId=e.scope.resolve(i)),n.scopeId.setValue(n.data))}}setLightmapped(e){e?this.mask=-6&this.mask|2:(this.setRealtimeLightmap(Hl.lightmapParamNames[0],null),this.setRealtimeLightmap(Hl.lightmapParamNames[1],null),this._shaderDefs&=-4289,this.mask=-7&this.mask|1)}setCustomAabb(e){e?this._customAabb?this._customAabb.copy(e):this._customAabb=e.clone():(this._customAabb=null,this._aabbVer=-1),this._setupSkinUpdate()}_setupSkinUpdate(){this._skinInstance&&(this._skinInstance._updateBeforeCull=!this._customAabb)}}Hl.lightmapParamNames=["texture_lightMap","texture_dirLightMap"];const jl="uSceneColorMap";class Wl extends uo{constructor(...e){super(...e),this.colorRenderTarget=null,this.source=null}destroy(){super.destroy(),this.releaseRenderTarget(this.colorRenderTarget)}shouldReallocate(e,t,s){if((null==e?void 0:e.colorBuffer.format)!==s)return!0;const i=(null==t?void 0:t.width)||this.device.width,n=(null==t?void 0:t.height)||this.device.height;return!e||i!==e.width||n!==e.height}allocateRenderTarget(e,t,s,i){const n=new yn(s,{name:jl,format:i,width:t?t.colorBuffer.width:s.width,height:t?t.colorBuffer.height:s.height,mipmaps:!0,minFilter:5,magFilter:1,addressU:1,addressV:1});return e?(e.destroyFrameBuffers(),e._colorBuffer=n,e._colorBuffers=[n]):e=new tr({name:"ColorGrabRT",colorBuffer:n,depth:!1,stencil:!1,autoResolve:!1}),e}releaseRenderTarget(e){e&&(e.destroyTextureBuffers(),e.destroy())}frameUpdate(){var e;const t=this.device,s=this.source,i=null!=(e=null==s?void 0:s.colorBuffer.format)?e:this.device.backBufferFormat;this.shouldReallocate(this.colorRenderTarget,null==s?void 0:s.colorBuffer,i)&&(this.releaseRenderTarget(this.colorRenderTarget),this.colorRenderTarget=this.allocateRenderTarget(this.colorRenderTarget,s,t,i));const n=this.colorRenderTarget.colorBuffer;t.scope.resolve(jl).setValue(n)}execute(){const e=this.device,t=this.source,s=this.colorRenderTarget.colorBuffer;e.isWebGPU?(e.copyRenderTarget(t,this.colorRenderTarget,!0,!1),e.mipmapRenderer.generate(this.colorRenderTarget.colorBuffer.impl)):(e.copyRenderTarget(t,this.colorRenderTarget,!0,!1),e.activeTexture(e.maxCombinedTextures-1),e.bindTexture(s),e.gl.generateMipmap(s.impl._glTarget))}}const $l="uSceneDepthMap";class ql extends uo{constructor(e,t){super(e),this.depthRenderTarget=null,this.camera=null,this.camera=t}destroy(){super.destroy(),this.releaseRenderTarget(this.depthRenderTarget)}shouldReallocate(e,t){const s=(null==t?void 0:t.width)||this.device.width,i=(null==t?void 0:t.height)||this.device.height;return!e||s!==e.width||i!==e.height}allocateRenderTarget(e,t,s,i,n){const r=new yn(s,{name:$l,format:i,width:t?t.colorBuffer.width:s.width,height:t?t.colorBuffer.height:s.height,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1});return e?(e.destroyFrameBuffers(),n?e._depthBuffer=r:(e._colorBuffer=r,e._colorBuffers=[r])):e=new tr({name:"DepthGrabRT",colorBuffer:n?null:r,depthBuffer:n?r:null,depth:!n,stencil:s.supportsStencil,autoResolve:!1}),e}releaseRenderTarget(e){e&&(e.destroyTextureBuffers(),e.destroy())}before(){var e,t,s,i;const n=this.camera,r=this.device,a=null!=(e=null==n?void 0:n.renderTarget)?e:r.backBuffer;let o=!0,l=a.stencil?Ks:Xs;if(r.isWebGPU){a.samples>1&&(l=qs,o=!1)}const h=null!=(t=null==(s=n.renderTarget)?void 0:s.depthBuffer)?t:null==(i=n.renderTarget)?void 0:i.colorBuffer;this.shouldReallocate(this.depthRenderTarget,h)&&(this.releaseRenderTarget(this.depthRenderTarget),this.depthRenderTarget=this.allocateRenderTarget(this.depthRenderTarget,n.renderTarget,r,l,o));const c=o?this.depthRenderTarget.depthBuffer:this.depthRenderTarget.colorBuffer;r.scope.resolve($l).setValue(c)}execute(){const e=this.device;if(e.isWebGL2&&e.renderTarget.samples>1){const t=e.renderTarget.impl._glFrameBuffer,s=this.depthRenderTarget;e.renderTarget=s,e.updateBegin(),this.depthRenderTarget.impl.internalResolve(e,t,s.impl._glFrameBuffer,this.depthRenderTarget,e.gl.DEPTH_BUFFER_BIT)}else e.copyRenderTarget(e.renderTarget,this.depthRenderTarget,!1,!0)}}class Xl{constructor(){this._gammaCorrection=1,this._toneMapping=0,this._srgbRenderTarget=!1,this._ssaoEnabled=!1,this._fog=jo,this._sceneDepthMapLinear=!1,this._hash=void 0,this._defines=new Map,this._definesDirty=!0}get hash(){if(void 0===this._hash){const e=`${this.gammaCorrection}_${this.toneMapping}_${this.srgbRenderTarget}_${this.fog}_${this.ssaoEnabled}_${this.sceneDepthMapLinear}`;this._hash=jn(e)}return this._hash}get defines(){const e=this._defines;return this._definesDirty&&(this._definesDirty=!1,e.clear(),this._sceneDepthMapLinear&&e.set("SCENE_DEPTHMAP_LINEAR",!0)),e}markDirty(){this._hash=void 0,this._definesDirty=!0}set fog(e){this._fog!==e&&(this._fog=e,this.markDirty())}get fog(){return this._fog}set ssaoEnabled(e){this._ssaoEnabled!==e&&(this._ssaoEnabled=e,this.markDirty())}get ssaoEnabled(){return this._ssaoEnabled}set gammaCorrection(e){this._gammaCorrectionAssigned=!0,this._gammaCorrection!==e&&(this._gammaCorrection=e,this.markDirty())}get gammaCorrection(){return this._gammaCorrection}set toneMapping(e){this._toneMapping!==e&&(this._toneMapping=e,this.markDirty())}get toneMapping(){return this._toneMapping}set srgbRenderTarget(e){this._srgbRenderTarget!==e&&(this._srgbRenderTarget=e,this.markDirty())}get srgbRenderTarget(){return this._srgbRenderTarget}set sceneDepthMapLinear(e){this._sceneDepthMapLinear!==e&&(this._sceneDepthMapLinear=e,this.markDirty())}get sceneDepthMapLinear(){return this._sceneDepthMapLinear}get shaderOutputGamma(){return 1===this._gammaCorrection&&!this._srgbRenderTarget?1:0}}const Kl=new ys,Yl=new ys,Ql=new ys,Jl=new As,Zl=[new ys,new ys,new ys,new ys,new ys,new ys,new ys,new ys];class eh{constructor(){this.shaderPassInfo=null,this.renderPassColorGrab=null,this.renderPassDepthGrab=null,this.fogParams=null,this.shaderParams=new Xl,this.renderPasses=[],this.jitter=0,this._aspectRatio=16/9,this._aspectRatioMode=0,this._calculateProjection=null,this._calculateTransform=null,this._clearColor=new os(.75,.75,.75,1),this._clearColorBuffer=!0,this._clearDepth=1,this._clearDepthBuffer=!0,this._clearStencil=0,this._clearStencilBuffer=!0,this._cullFaces=!0,this._farClip=1e3,this._flipFaces=!1,this._fov=45,this._frustumCulling=!0,this._horizontalFov=!1,this._layers=[0,1,2,4,3],this._layersSet=new Set(this._layers),this._nearClip=.1,this._node=null,this._orthoHeight=10,this._projection=0,this._rect=new Ss(0,0,1,1),this._renderTarget=null,this._scissorRect=new Ss(0,0,1,1),this._scissorRectClear=!1,this._aperture=16,this._shutter=.001,this._sensitivity=1e3,this._projMat=new As,this._projMatDirty=!0,this._projMatSkybox=new As,this._viewMat=new As,this._viewMatDirty=!0,this._viewProjMat=new As,this._viewProjMatDirty=!0,this._shaderMatricesVersion=0,this._viewProjInverse=new As,this._viewProjCurrent=null,this._viewProjPrevious=new As,this._jitters=[0,0,0,0],this.frustum=new Gs,this._xr=null,this._xrProperties={horizontalFov:this._horizontalFov,fov:this._fov,aspectRatio:this._aspectRatio,farClip:this._farClip,nearClip:this._nearClip}}destroy(){var e,t;null==(e=this.renderPassColorGrab)||e.destroy(),this.renderPassColorGrab=null,null==(t=this.renderPassDepthGrab)||t.destroy(),this.renderPassDepthGrab=null,this.renderPasses.length=0}_storeShaderMatrices(e,t,s,i){var n;this._shaderMatricesVersion!==i&&(this._shaderMatricesVersion=i,this._viewProjPrevious.copy(null!=(n=this._viewProjCurrent)?n:e),null!=this._viewProjCurrent||(this._viewProjCurrent=new As),this._viewProjCurrent.copy(e),this._viewProjInverse.invert(e),this._jitters[2]=this._jitters[0],this._jitters[3]=this._jitters[1],this._jitters[0]=t,this._jitters[1]=s)}get fullSizeClearRect(){const e=this._scissorRectClear?this.scissorRect:this._rect;return 0===e.x&&0===e.y&&1===e.z&&1===e.w}set aspectRatio(e){this._aspectRatio!==e&&(this._aspectRatio=e,this._projMatDirty=!0)}get aspectRatio(){var e;return null!=(e=this.xr)&&e.active?this._xrProperties.aspectRatio:this._aspectRatio}set aspectRatioMode(e){this._aspectRatioMode!==e&&(this._aspectRatioMode=e,this._projMatDirty=!0)}get aspectRatioMode(){return this._aspectRatioMode}set calculateProjection(e){this._calculateProjection=e,this._projMatDirty=!0}get calculateProjection(){return this._calculateProjection}set calculateTransform(e){this._calculateTransform=e}get calculateTransform(){return this._calculateTransform}set clearColor(e){this._clearColor.copy(e)}get clearColor(){return this._clearColor}set clearColorBuffer(e){this._clearColorBuffer=e}get clearColorBuffer(){return this._clearColorBuffer}set clearDepth(e){this._clearDepth=e}get clearDepth(){return this._clearDepth}set clearDepthBuffer(e){this._clearDepthBuffer=e}get clearDepthBuffer(){return this._clearDepthBuffer}set clearStencil(e){this._clearStencil=e}get clearStencil(){return this._clearStencil}set clearStencilBuffer(e){this._clearStencilBuffer=e}get clearStencilBuffer(){return this._clearStencilBuffer}set cullFaces(e){this._cullFaces=e}get cullFaces(){return this._cullFaces}set farClip(e){this._farClip!==e&&(this._farClip=e,this._projMatDirty=!0)}get farClip(){var e;return null!=(e=this.xr)&&e.active?this._xrProperties.farClip:this._farClip}set flipFaces(e){this._flipFaces=e}get flipFaces(){return this._flipFaces}set fov(e){this._fov!==e&&(this._fov=e,this._projMatDirty=!0)}get fov(){var e;return null!=(e=this.xr)&&e.active?this._xrProperties.fov:this._fov}set frustumCulling(e){this._frustumCulling=e}get frustumCulling(){return this._frustumCulling}set horizontalFov(e){this._horizontalFov!==e&&(this._horizontalFov=e,this._projMatDirty=!0)}get horizontalFov(){var e;return null!=(e=this.xr)&&e.active?this._xrProperties.horizontalFov:this._horizontalFov}set layers(e){this._layers=e.slice(0),this._layersSet=new Set(this._layers)}get layers(){return this._layers}get layersSet(){return this._layersSet}set nearClip(e){this._nearClip!==e&&(this._nearClip=e,this._projMatDirty=!0)}get nearClip(){var e;return null!=(e=this.xr)&&e.active?this._xrProperties.nearClip:this._nearClip}set node(e){this._node=e}get node(){return this._node}set orthoHeight(e){this._orthoHeight!==e&&(this._orthoHeight=e,this._projMatDirty=!0)}get orthoHeight(){return this._orthoHeight}set projection(e){this._projection!==e&&(this._projection=e,this._projMatDirty=!0)}get projection(){return this._projection}get projectionMatrix(){return this._evaluateProjectionMatrix(),this._projMat}set rect(e){this._rect.copy(e)}get rect(){return this._rect}set renderTarget(e){this._renderTarget=e}get renderTarget(){return this._renderTarget}set scissorRect(e){this._scissorRect.copy(e)}get scissorRect(){return this._scissorRect}get viewMatrix(){if(this._viewMatDirty){const e=this._node.getWorldTransform();this._viewMat.copy(e).invert(),this._viewMatDirty=!1}return this._viewMat}set aperture(e){this._aperture=e}get aperture(){return this._aperture}set sensitivity(e){this._sensitivity=e}get sensitivity(){return this._sensitivity}set shutter(e){this._shutter=e}get shutter(){return this._shutter}set xr(e){this._xr!==e&&(this._xr=e,this._projMatDirty=!0)}get xr(){return this._xr}clone(){return(new eh).copy(this)}copy(e){return this._aspectRatio=e._aspectRatio,this._farClip=e._farClip,this._fov=e._fov,this._horizontalFov=e._horizontalFov,this._nearClip=e._nearClip,this._xrProperties.aspectRatio=e._xrProperties.aspectRatio,this._xrProperties.farClip=e._xrProperties.farClip,this._xrProperties.fov=e._xrProperties.fov,this._xrProperties.horizontalFov=e._xrProperties.horizontalFov,this._xrProperties.nearClip=e._xrProperties.nearClip,this.aspectRatioMode=e.aspectRatioMode,this.calculateProjection=e.calculateProjection,this.calculateTransform=e.calculateTransform,this.clearColor=e.clearColor,this.clearColorBuffer=e.clearColorBuffer,this.clearDepth=e.clearDepth,this.clearDepthBuffer=e.clearDepthBuffer,this.clearStencil=e.clearStencil,this.clearStencilBuffer=e.clearStencilBuffer,this.cullFaces=e.cullFaces,this.flipFaces=e.flipFaces,this.frustumCulling=e.frustumCulling,this.layers=e.layers,this.orthoHeight=e.orthoHeight,this.projection=e.projection,this.rect=e.rect,this.renderTarget=e.renderTarget,this.scissorRect=e.scissorRect,this.aperture=e.aperture,this.shutter=e.shutter,this.sensitivity=e.sensitivity,this.shaderPassInfo=e.shaderPassInfo,this.jitter=e.jitter,this._projMatDirty=!0,this}_enableRenderPassColorGrab(e,t){var s;t?this.renderPassColorGrab||(this.renderPassColorGrab=new Wl(e)):(null==(s=this.renderPassColorGrab)||s.destroy(),this.renderPassColorGrab=null)}_enableRenderPassDepthGrab(e,t,s){var i;s?this.renderPassDepthGrab||(this.renderPassDepthGrab=new ql(e,this)):(null==(i=this.renderPassDepthGrab)||i.destroy(),this.renderPassDepthGrab=null)}_updateViewProjMat(){(this._projMatDirty||this._viewMatDirty||this._viewProjMatDirty)&&(this._viewProjMat.mul2(this.projectionMatrix,this.viewMatrix),this._viewProjMatDirty=!1)}worldToScreen(e,t,s,i=new ys){this._updateViewProjMat(),this._viewProjMat.transformPoint(e,i);const n=this._viewProjMat.data,r=e.x*n[3]+e.y*n[7]+e.z*n[11]+1*n[15];return i.x=.5*(i.x/r+1)*t,i.y=.5*(1-i.y/r)*s,i}screenToWorld(e,t,s,i,n,r=new ys){const a=this.farClip-this.nearClip;if(Kl.set(e/i,(n-t)/n,s/a),Kl.mulScalar(2),Kl.sub(ys.ONE),0===this._projection){As._getPerspectiveHalfSize(Yl,this.fov,this.aspectRatio,this.nearClip,this.horizontalFov),Yl.x*=Kl.x,Yl.y*=Kl.y;const e=this._node.getWorldTransform();Yl.z=-this.nearClip,e.transformPoint(Yl,Ql);const t=this._node.getPosition();r.sub2(Ql,t),r.normalize(),r.mulScalar(s),r.add(t)}else this._updateViewProjMat(),Jl.copy(this._viewProjMat).invert(),Jl.transformPoint(Kl,r);return r}_evaluateProjectionMatrix(){if(this._projMatDirty){if(0===this._projection)this._projMat.setPerspective(this.fov,this.aspectRatio,this.nearClip,this.farClip,this.horizontalFov),this._projMatSkybox.copy(this._projMat);else{const e=this._orthoHeight,t=e*this.aspectRatio;this._projMat.setOrtho(-t,t,-e,e,this.nearClip,this.farClip),this._projMatSkybox.setPerspective(this.fov,this.aspectRatio,this.nearClip,this.farClip)}this._projMatDirty=!1}}getProjectionMatrixSkybox(){return this._evaluateProjectionMatrix(),this._projMatSkybox}getExposure(){const e=Math.log2(this._aperture*this._aperture/this._shutter*100/this._sensitivity);return 1/(1.2*Math.pow(2,e))}getScreenSize(e){if(0===this._projection){const t=this._node.getPosition().distance(e.center);if(t<e.radius)return 1;const s=Math.asin(e.radius/t),i=Math.tan(s),n=Math.tan(this.fov/2*rs.DEG_TO_RAD);return Math.min(i/n,1)}return rs.clamp(e.radius/this._orthoHeight,0,1)}getFrustumCorners(e=this.nearClip,t=this.farClip){const s=this.fov*Math.PI/180;let i,n;0===this.projection?this.horizontalFov?(i=e*Math.tan(s/2),n=i/this.aspectRatio):(n=e*Math.tan(s/2),i=n*this.aspectRatio):(n=this._orthoHeight,i=n*this.aspectRatio);const r=Zl;return r[0].x=i,r[0].y=-n,r[0].z=-e,r[1].x=i,r[1].y=n,r[1].z=-e,r[2].x=-i,r[2].y=n,r[2].z=-e,r[3].x=-i,r[3].y=-n,r[3].z=-e,0===this._projection&&(this.horizontalFov?(i=t*Math.tan(s/2),n=i/this.aspectRatio):(n=t*Math.tan(s/2),i=n*this.aspectRatio)),r[4].x=i,r[4].y=-n,r[4].z=-t,r[5].x=i,r[5].y=n,r[5].z=-t,r[6].x=-i,r[6].y=n,r[6].z=-t,r[7].x=-i,r[7].y=-n,r[7].z=-t,r}setXrProperties(e){Object.assign(this._xrProperties,e),this._projMatDirty=!0}}const th=new As,sh=new ys,ih=new Ds,nh=new Ds,rh=new ys,ah=new ys,oh=new As,lh=new Ds,hh=new ys,ch=new As,dh=new Ds,uh=new Ds,ph=new As,fh=new ys,mh=new ys;function gh(e,t){return e instanceof Function?e:s=>{let i=s[e];return i instanceof Function&&(i=i()),i===t}}function _h(e,t){if(t(e))return e;const s=e._children,i=s.length;for(let e=0;e<i;++e){const i=_h(s[e],t);if(i)return i}return null}class vh extends Kt{constructor(e="Untitled"){super(),this.name=void 0,this.tags=new es(this),this.localPosition=new ys,this.localRotation=new Ds,this.localScale=new ys(1,1,1),this.localEulerAngles=new ys,this.position=new ys,this.rotation=new Ds,this.eulerAngles=new ys,this._scale=null,this.localTransform=new As,this._dirtyLocal=!1,this._aabbVer=0,this._frozen=!1,this.worldTransform=new As,this._dirtyWorld=!1,this._worldScaleSign=0,this._normalMatrix=new xs,this._dirtyNormal=!0,this._right=null,this._up=null,this._forward=null,this._parent=null,this._children=[],this._graphDepth=0,this._enabled=!0,this._enabledInHierarchy=!1,this.scaleCompensation=!1,this.name=e}get right(){return this._right||(this._right=new ys),this.getWorldTransform().getX(this._right).normalize()}get up(){return this._up||(this._up=new ys),this.getWorldTransform().getY(this._up).normalize()}get forward(){return this._forward||(this._forward=new ys),this.getWorldTransform().getZ(this._forward).normalize().mulScalar(-1)}get normalMatrix(){const e=this._normalMatrix;return this._dirtyNormal&&(e.invertMat4(this.getWorldTransform()).transpose(),this._dirtyNormal=!1),e}set enabled(e){var t;this._enabled!==e&&(this._enabled=e,(e&&null!=(t=this._parent)&&t.enabled||!e)&&this._notifyHierarchyStateChanged(this,e))}get enabled(){return this._enabled&&this._enabledInHierarchy}get parent(){return this._parent}get path(){let e=this._parent;if(!e)return"";let t=this.name;for(;e&&e._parent;)t=`${e.name}/${t}`,e=e._parent;return t}get root(){let e=this;for(;e._parent;)e=e._parent;return e}get children(){return this._children}get graphDepth(){return this._graphDepth}_notifyHierarchyStateChanged(e,t){e._onHierarchyStateChanged(t);const s=e._children;for(let e=0,i=s.length;e<i;e++)s[e]._enabled&&this._notifyHierarchyStateChanged(s[e],t)}_onHierarchyStateChanged(e){this._enabledInHierarchy=e,e&&!this._frozen&&this._unfreezeParentToRoot()}_cloneInternal(e){e.name=this.name;const t=this.tags._list;e.tags.clear();for(let s=0;s<t.length;s++)e.tags.add(t[s]);e.localPosition.copy(this.localPosition),e.localRotation.copy(this.localRotation),e.localScale.copy(this.localScale),e.localEulerAngles.copy(this.localEulerAngles),e.position.copy(this.position),e.rotation.copy(this.rotation),e.eulerAngles.copy(this.eulerAngles),e.localTransform.copy(this.localTransform),e._dirtyLocal=this._dirtyLocal,e.worldTransform.copy(this.worldTransform),e._dirtyWorld=this._dirtyWorld,e._dirtyNormal=this._dirtyNormal,e._aabbVer=this._aabbVer+1,e._enabled=this._enabled,e.scaleCompensation=this.scaleCompensation,e._enabledInHierarchy=!1}clone(){const e=new this.constructor;return this._cloneInternal(e),e}copy(e){return e._cloneInternal(this),this}destroy(){this.remove();const e=this._children;for(;e.length;){const t=e.pop();t._parent=null,t.destroy()}this.fire("destroy",this),this.off()}find(e,t){const s=[],i=gh(e,t);return this.forEach((e=>{i(e)&&s.push(e)})),s}findOne(e,t){return _h(this,gh(e,t))}findByTag(){const e=arguments,t=[],s=(i,n)=>{n&&i.tags.has(...e)&&t.push(i);for(let e=0;e<i._children.length;e++)s(i._children[e],!0)};return s(this,!1),t}findByName(e){return this.findOne("name",e)}findByPath(e){const t=Array.isArray(e)?e:e.split("/");let s=this;for(let e=0,i=t.length;e<i;++e)if(s=s.children.find((s=>s.name===t[e])),!s)return null;return s}forEach(e,t){e.call(t,this);const s=this._children,i=s.length;for(let n=0;n<i;++n)s[n].forEach(e,t)}isDescendantOf(e){let t=this._parent;for(;t;){if(t===e)return!0;t=t._parent}return!1}isAncestorOf(e){return e.isDescendantOf(this)}getEulerAngles(){return this.getWorldTransform().getEulerAngles(this.eulerAngles),this.eulerAngles}getLocalEulerAngles(){return this.localRotation.getEulerAngles(this.localEulerAngles),this.localEulerAngles}getLocalPosition(){return this.localPosition}getLocalRotation(){return this.localRotation}getLocalScale(){return this.localScale}getLocalTransform(){return this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this.localTransform}getPosition(){return this.getWorldTransform().getTranslation(this.position),this.position}getRotation(){return this.rotation.setFromMat4(this.getWorldTransform()),this.rotation}getScale(){return this._scale||(this._scale=new ys),this.getWorldTransform().getScale(this._scale)}getWorldTransform(){return this._dirtyLocal||this._dirtyWorld?(this._parent&&this._parent.getWorldTransform(),this._sync(),this.worldTransform):this.worldTransform}get worldScaleSign(){return 0===this._worldScaleSign&&(this._worldScaleSign=this.getWorldTransform().scaleSign),this._worldScaleSign}remove(){var e;null==(e=this._parent)||e.removeChild(this)}reparent(e,t){this.remove(),e&&(t>=0?e.insertChild(this,t):e.addChild(this))}setLocalEulerAngles(e,t,s){this.localRotation.setFromEulerAngles(e,t,s),this._dirtyLocal||this._dirtifyLocal()}setLocalPosition(e,t,s){e instanceof ys?this.localPosition.copy(e):this.localPosition.set(e,t,s),this._dirtyLocal||this._dirtifyLocal()}setLocalRotation(e,t,s,i){e instanceof Ds?this.localRotation.copy(e):this.localRotation.set(e,t,s,i),this._dirtyLocal||this._dirtifyLocal()}setLocalScale(e,t,s){e instanceof ys?this.localScale.copy(e):this.localScale.set(e,t,s),this._dirtyLocal||this._dirtifyLocal()}_dirtifyLocal(){this._dirtyLocal||(this._dirtyLocal=!0,this._dirtyWorld||this._dirtifyWorld())}_unfreezeParentToRoot(){let e=this._parent;for(;e;)e._frozen=!1,e=e._parent}_dirtifyWorld(){this._dirtyWorld||this._unfreezeParentToRoot(),this._dirtifyWorldInternal()}_dirtifyWorldInternal(){if(!this._dirtyWorld){this._frozen=!1,this._dirtyWorld=!0;for(let e=0;e<this._children.length;e++)this._children[e]._dirtyWorld||this._children[e]._dirtifyWorldInternal()}this._dirtyNormal=!0,this._worldScaleSign=0,this._aabbVer++}setPosition(e,t,s){e instanceof ys?hh.copy(e):hh.set(e,t,s),null===this._parent?this.localPosition.copy(hh):(ch.copy(this._parent.getWorldTransform()).invert(),ch.transformPoint(hh,this.localPosition)),this._dirtyLocal||this._dirtifyLocal()}setRotation(e,t,s,i){if(e instanceof Ds?dh.copy(e):dh.set(e,t,s,i),null===this._parent)this.localRotation.copy(dh);else{const e=this._parent.getRotation();uh.copy(e).invert(),this.localRotation.copy(uh).mul(dh)}this._dirtyLocal||this._dirtifyLocal()}setPositionAndRotation(e,t){if(null===this._parent)this.localPosition.copy(e),this.localRotation.copy(t);else{const s=this._parent.getWorldTransform();ch.copy(s).invert(),ch.transformPoint(e,this.localPosition),this.localRotation.setFromMat4(ch).mul(t)}this._dirtyLocal||this._dirtifyLocal()}setEulerAngles(e,t,s){if(this.localRotation.setFromEulerAngles(e,t,s),null!==this._parent){const e=this._parent.getRotation();uh.copy(e).invert(),this.localRotation.mul2(uh,this.localRotation)}this._dirtyLocal||this._dirtifyLocal()}addChild(e){this._prepareInsertChild(e),this._children.push(e),this._onInsertChild(e)}addChildAndSaveTransform(e){const t=e.getPosition(),s=e.getRotation();this._prepareInsertChild(e),e.setPosition(oh.copy(this.worldTransform).invert().transformPoint(t)),e.setRotation(lh.copy(this.getRotation()).invert().mul(s)),this._children.push(e),this._onInsertChild(e)}insertChild(e,t){this._prepareInsertChild(e),this._children.splice(t,0,e),this._onInsertChild(e)}_prepareInsertChild(e){e.remove()}_fireOnHierarchy(e,t,s){this.fire(e,s);for(let e=0;e<this._children.length;e++)this._children[e]._fireOnHierarchy(t,t,s)}_onInsertChild(e){e._parent=this;const t=e._enabled&&this.enabled;e._enabledInHierarchy!==t&&(e._enabledInHierarchy=t,e._notifyHierarchyStateChanged(e,t)),e._updateGraphDepth(),e._dirtifyWorld(),this._frozen&&e._unfreezeParentToRoot(),e._fireOnHierarchy("insert","inserthierarchy",this),this.fire&&this.fire("childinsert",e)}_updateGraphDepth(){this._graphDepth=this._parent?this._parent._graphDepth+1:0;for(let e=0,t=this._children.length;e<t;e++)this._children[e]._updateGraphDepth()}removeChild(e){const t=this._children.indexOf(e);-1!==t&&(this._children.splice(t,1),e._parent=null,e._fireOnHierarchy("remove","removehierarchy",this),this.fire("childremove",e))}_sync(){if(this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this._dirtyWorld){if(null===this._parent)this.worldTransform.copy(this.localTransform);else if(this.scaleCompensation){let e;const t=this._parent;let s=this.localScale,i=t;if(i){for(;i&&i.scaleCompensation;)i=i._parent;i&&(i=i._parent,i&&(e=i.worldTransform.getScale(),rh.mul2(e,this.localScale),s=rh))}nh.setFromMat4(t.worldTransform),ih.mul2(nh,this.localRotation);let n=t.worldTransform;t.scaleCompensation&&(ah.mul2(e,t.getLocalScale()),th.setTRS(t.worldTransform.getTranslation(sh),nh,ah),n=th),n.transformPoint(this.localPosition,sh),this.worldTransform.setTRS(sh,ih,s)}else this.worldTransform.mulAffine2(this._parent.worldTransform,this.localTransform);this._dirtyWorld=!1}}syncHierarchy(){if(!this._enabled)return;if(this._frozen)return;this._frozen=!0,(this._dirtyLocal||this._dirtyWorld)&&this._sync();const e=this._children;for(let t=0,s=e.length;t<s;t++)e[t].syncHierarchy()}lookAt(e,t,s,i=0,n=1,r=0){if(e instanceof ys)fh.copy(e),t instanceof ys?mh.copy(t):mh.copy(ys.UP);else{if(void 0===s)return;fh.set(e,t,s),mh.set(i,n,r)}ph.setLookAt(this.getPosition(),fh,mh),dh.setFromMat4(ph),this.setRotation(dh)}translate(e,t,s){e instanceof ys?hh.copy(e):hh.set(e,t,s),hh.add(this.getPosition()),this.setPosition(hh)}translateLocal(e,t,s){e instanceof ys?hh.copy(e):hh.set(e,t,s),this.localRotation.transformVector(hh,hh),this.localPosition.add(hh),this._dirtyLocal||this._dirtifyLocal()}rotate(e,t,s){if(dh.setFromEulerAngles(e,t,s),null===this._parent)this.localRotation.mul2(dh,this.localRotation);else{const e=this.getRotation(),t=this._parent.getRotation();uh.copy(t).invert(),dh.mul2(uh,dh),this.localRotation.mul2(dh,e)}this._dirtyLocal||this._dirtifyLocal()}rotateLocal(e,t,s){dh.setFromEulerAngles(e,t,s),this.localRotation.mul(dh),this._dirtyLocal||this._dirtifyLocal()}}const bh=new As,yh=new As,xh=new As;class wh{static create(e,t,s){const i=new eh;switch(i.node=new vh(e),i.aspectRatio=1,i.aspectRatioMode=1,i._scissorRectClear=!0,t){case 1:i.node.setRotation(wh.pointLightRotations[s]),i.fov=90,i.projection=0;break;case 2:i.projection=0;break;case 0:i.projection=1}return i}static evalSpotCookieMatrix(e){let t=wh._spotCookieCamera;t||(t=wh.create("SpotCookieCamera",2),wh._spotCookieCamera=t),t.fov=2*e._outerConeAngle;const s=t._node;s.setPosition(e._node.getPosition()),s.setRotation(e._node.getRotation()),s.rotateLocal(-90,0,0),bh.setTRS(s.getPosition(),s.getRotation(),ys.ONE).invert(),yh.mul2(t.projectionMatrix,bh);const i=e.cookieMatrix,n=e.atlasViewport;return xh.setViewport(n.x,n.y,n.z,n.w),i.mul2(xh,yh),i}}wh.pointLightRotations=[(new Ds).setFromEulerAngles(0,90,180),(new Ds).setFromEulerAngles(0,-90,180),(new Ds).setFromEulerAngles(90,0,0),(new Ds).setFromEulerAngles(-90,0,0),(new Ds).setFromEulerAngles(0,180,180),(new Ds).setFromEulerAngles(0,0,180)],wh._spotCookieCamera=null;const Sh=new ys,Ch=new Float32Array(6),Th=new ys(-.5,0,0),Eh=new ys(0,0,.5),Ph={FLAGS:0,COLOR_A:1,COLOR_B:2,SPOT_ANGLES:3,SHADOW_BIAS:4,COOKIE_A:5,COOKIE_B:6,COUNT:7},kh={POSITION_RANGE:0,SPOT_DIRECTION:1,PROJ_MAT_0:2,ATLAS_VIEWPORT:2,PROJ_MAT_1:3,PROJ_MAT_2:4,PROJ_MAT_3:5,AREA_DATA_WIDTH:6,AREA_DATA_HEIGHT:7,COUNT:8};let Ah;class Mh{static getShaderDefines(){const e=(e,t)=>Object.keys(e).map((s=>`#define ${t}${s} ${e[s]}`)).join("\n");return Ah||(Ah=`\n\n\t\t\t\t\t\t\t\t${e(Ph,"CLUSTER_TEXTURE_8_")}\n\t\t\t\t\t\t\t\t${e(kh,"CLUSTER_TEXTURE_F_")}\n\t\t\t\t\t\t`),Ah}constructor(e){this.areaLightsEnabled=!1,this.device=e,this.cookiesEnabled=!1,this.shadowsEnabled=!1,this.areaLightsEnabled=!1,this.maxLights=255;const t=Ph.COUNT;this.lights8=new Uint8ClampedArray(4*t*this.maxLights),this.lightsTexture8=this.createTexture(this.device,t,this.maxLights,7,"LightsTexture8"),this._lightsTexture8Id=this.device.scope.resolve("lightsTexture8");const s=kh.COUNT;this.lightsFloat=new Float32Array(4*s*this.maxLights),this.lightsTextureFloat=this.createTexture(this.device,s,this.maxLights,$s,"LightsTextureFloat"),this._lightsTextureFloatId=this.device.scope.resolve("lightsTextureFloat"),this.invMaxColorValue=0,this.invMaxAttenuation=0,this.boundsMin=new ys,this.boundsDelta=new ys}destroy(){var e,t;null==(e=this.lightsTexture8)||e.destroy(),this.lightsTexture8=null,null==(t=this.lightsTextureFloat)||t.destroy(),this.lightsTextureFloat=null}createTexture(e,t,s,i,n){return new yn(e,{name:n,width:t,height:s,mipmaps:!1,format:i,addressU:1,addressV:1,type:Ai,magFilter:0,minFilter:0,anisotropy:1})}setCompressionRanges(e,t){this.invMaxColorValue=1/t,this.invMaxAttenuation=1/e}setBounds(e,t){this.boundsMin.copy(e),this.boundsDelta.copy(t)}uploadTextures(){this.lightsTextureFloat.lock().set(this.lightsFloat),this.lightsTextureFloat.unlock(),this.lightsTexture8.lock().set(this.lights8),this.lightsTexture8.unlock()}updateUniforms(){this._lightsTexture8Id.setValue(this.lightsTexture8),this._lightsTextureFloatId.setValue(this.lightsTextureFloat)}getSpotDirection(e,t){t._node.getWorldTransform().getY(e).mulScalar(-1),e.normalize()}getLightAreaSizes(e){const t=e._node.getWorldTransform();return t.transformVector(Th,Sh),Ch[0]=Sh.x,Ch[1]=Sh.y,Ch[2]=Sh.z,t.transformVector(Eh,Sh),Ch[3]=Sh.x,Ch[4]=Sh.y,Ch[5]=Sh.z,Ch}addLightDataFlags(e,t,s,i,n,r){e[t+0]=i?255:0,e[t+1]=this.areaLightsEnabled?64*s._shape:0,e[t+2]=255*s._falloffMode,e[t+3]=n?255*r:0}addLightDataColor(e,t,s,i){const n=this.invMaxColorValue,r=s._colorLinear;fs.float2Bytes(r[0]*n,e,t+0,2),fs.float2Bytes(r[1]*n,e,t+2,2),fs.float2Bytes(r[2]*n,e,t+4,2),e[t+6]=i?255:0;const a=!!(1&s.mask),o=!!(2&s.mask);e[t+7]=a&&o?127:o?255:0}addLightDataSpotAngles(e,t,s){fs.float2Bytes(.499999*s._innerConeAngleCos+.5,e,t+0,2),fs.float2Bytes(.499999*s._outerConeAngleCos+.5,e,t+2,2)}addLightDataShadowBias(e,t,s){const i=s.getRenderData(null,0),n=s._getUniformBiasValues(i);fs.float2BytesRange(n.bias,e,t,-1,20,2),fs.float2Bytes(n.normalBias,e,t+2,2)}addLightDataCookies(e,t,s){const i="rgb"===s._cookieChannel;if(e[t+0]=Math.floor(255*s.cookieIntensity),e[t+1]=i?255:0,!i){const i=s._cookieChannel;e[t+4]="rrr"===i?255:0,e[t+5]="ggg"===i?255:0,e[t+6]="bbb"===i?255:0,e[t+7]="aaa"===i?255:0}}addLightData(e,t){const s=2===e._type,i=e.atlasViewportAllocated,n=this.cookiesEnabled&&!!e._cookie&&i,r=this.areaLightsEnabled&&0!==e.shape,a=this.shadowsEnabled&&e.castShadows&&i,o=e._node.getPosition();let l=null,h=null;if(s)if(a){l=e.getRenderData(null,0).shadowMatrix}else n&&(l=wh.evalSpotCookieMatrix(e));else(a||n)&&(h=e.atlasViewport);const c=this.lights8,d=t*this.lightsTexture8.width*4;this.addLightDataFlags(c,d+4*Ph.FLAGS,e,s,a,e.shadowIntensity),this.addLightDataColor(c,d+4*Ph.COLOR_A,e,n),s&&this.addLightDataSpotAngles(c,d+4*Ph.SPOT_ANGLES,e),e.castShadows&&this.addLightDataShadowBias(c,d+4*Ph.SHADOW_BIAS,e),n&&this.addLightDataCookies(c,d+4*Ph.COOKIE_A,e);const u=this.lightsFloat,p=t*this.lightsTextureFloat.width*4;if(u[p+4*kh.POSITION_RANGE+0]=o.x,u[p+4*kh.POSITION_RANGE+1]=o.y,u[p+4*kh.POSITION_RANGE+2]=o.z,u[p+4*kh.POSITION_RANGE+3]=e.attenuationEnd,s&&(this.getSpotDirection(Sh,e),u[p+4*kh.SPOT_DIRECTION+0]=Sh.x,u[p+4*kh.SPOT_DIRECTION+1]=Sh.y,u[p+4*kh.SPOT_DIRECTION+2]=Sh.z),l){const e=l.data;for(let t=0;t<16;t++)u[p+4*kh.PROJ_MAT_0+t]=e[t]}if(h&&(u[p+4*kh.ATLAS_VIEWPORT+0]=h.x,u[p+4*kh.ATLAS_VIEWPORT+1]=h.y,u[p+4*kh.ATLAS_VIEWPORT+2]=h.z/3),r){const t=this.getLightAreaSizes(e);u[p+4*kh.AREA_DATA_WIDTH+0]=t[0],u[p+4*kh.AREA_DATA_WIDTH+1]=t[1],u[p+4*kh.AREA_DATA_WIDTH+2]=t[2],u[p+4*kh.AREA_DATA_HEIGHT+0]=t[3],u[p+4*kh.AREA_DATA_HEIGHT+1]=t[4],u[p+4*kh.AREA_DATA_HEIGHT+2]=t[5]}}}const Dh=new ys,Rh=new ys,Lh=new ys,Ih=new Bs,Fh=1e-6;class Oh{constructor(){this.light=null,this.min=new ys,this.max=new ys}}class Bh{constructor(e){this.clusterTexture=void 0,this.device=e,this.name="Untitled",this.reportCount=0,this.boundsMin=new ys,this.boundsMax=new ys,this.boundsDelta=new ys,this._cells=new ys(1,1,1),this._cellsLimit=new ys,this.cells=this._cells,this.maxCellLightCount=4,this._maxAttenuation=0,this._maxColorValue=0,this._usedLights=[],this._usedLights.push(new Oh),this.lightsBuffer=new Mh(e),this.registerUniforms(e)}set maxCellLightCount(e){e!==this._maxCellLightCount&&(this._maxCellLightCount=e,this._cellsDirty=!0)}get maxCellLightCount(){return this._maxCellLightCount}set cells(e){Dh.copy(e).floor(),this._cells.equals(Dh)||(this._cells.copy(Dh),this._cellsLimit.copy(Dh).sub(ys.ONE),this._cellsDirty=!0)}get cells(){return this._cells}destroy(){this.lightsBuffer.destroy(),this.releaseClusterTexture()}releaseClusterTexture(){this.clusterTexture&&(this.clusterTexture.destroy(),this.clusterTexture=null)}registerUniforms(e){this._clusterSkipId=e.scope.resolve("clusterSkip"),this._clusterMaxCellsId=e.scope.resolve("clusterMaxCells"),this._clusterWorldTextureId=e.scope.resolve("clusterWorldTexture"),this._clusterTextureSizeId=e.scope.resolve("clusterTextureSize"),this._clusterTextureSizeData=new Float32Array(3),this._clusterBoundsMinId=e.scope.resolve("clusterBoundsMin"),this._clusterBoundsMinData=new Float32Array(3),this._clusterBoundsDeltaId=e.scope.resolve("clusterBoundsDelta"),this._clusterBoundsDeltaData=new Float32Array(3),this._clusterCellsCountByBoundsSizeId=e.scope.resolve("clusterCellsCountByBoundsSize"),this._clusterCellsCountByBoundsSizeData=new Float32Array(3),this._clusterCellsDotId=e.scope.resolve("clusterCellsDot"),this._clusterCellsDotData=new Float32Array(3),this._clusterCellsMaxId=e.scope.resolve("clusterCellsMax"),this._clusterCellsMaxData=new Float32Array(3),this._clusterCompressionLimit0Id=e.scope.resolve("clusterCompressionLimit0"),this._clusterCompressionLimit0Data=new Float32Array(2)}updateParams(e){e&&(this.cells=e.cells,this.maxCellLightCount=e.maxLightsPerCell,this.lightsBuffer.cookiesEnabled=e.cookiesEnabled,this.lightsBuffer.shadowsEnabled=e.shadowsEnabled,this.lightsBuffer.areaLightsEnabled=e.areaLightsEnabled)}updateCells(){if(this._cellsDirty){this._cellsDirty=!1;const e=this._cells.x,t=this._cells.y,s=this._cells.z,i=e*t*s,n=this.maxCellLightCount*i;let r=Math.ceil(Math.sqrt(n));r=rs.roundUp(r,this.maxCellLightCount);const a=Math.ceil(n/r);this._clusterCellsMaxData[0]=e,this._clusterCellsMaxData[1]=t,this._clusterCellsMaxData[2]=s,this._clusterCellsDotData[0]=this.maxCellLightCount,this._clusterCellsDotData[1]=e*s*this.maxCellLightCount,this._clusterCellsDotData[2]=e*this.maxCellLightCount,this.clusters=new Uint8ClampedArray(n),this.counts=new Int32Array(i),this._clusterTextureSizeData[0]=r,this._clusterTextureSizeData[1]=1/r,this._clusterTextureSizeData[2]=1/a,this.releaseClusterTexture(),this.clusterTexture=this.lightsBuffer.createTexture(this.device,r,a,52,"ClusterTexture")}}uploadTextures(){this.clusterTexture.lock().set(this.clusters),this.clusterTexture.unlock(),this.lightsBuffer.uploadTextures()}updateUniforms(){this._clusterSkipId.setValue(this._usedLights.length>1?0:1),this.lightsBuffer.updateUniforms(),this._clusterWorldTextureId.setValue(this.clusterTexture),this._clusterMaxCellsId.setValue(this.maxCellLightCount);const e=this.boundsDelta;this._clusterCellsCountByBoundsSizeData[0]=this._cells.x/e.x,this._clusterCellsCountByBoundsSizeData[1]=this._cells.y/e.y,this._clusterCellsCountByBoundsSizeData[2]=this._cells.z/e.z,this._clusterCellsCountByBoundsSizeId.setValue(this._clusterCellsCountByBoundsSizeData),this._clusterBoundsMinData[0]=this.boundsMin.x,this._clusterBoundsMinData[1]=this.boundsMin.y,this._clusterBoundsMinData[2]=this.boundsMin.z,this._clusterBoundsDeltaData[0]=e.x,this._clusterBoundsDeltaData[1]=e.y,this._clusterBoundsDeltaData[2]=e.z,this._clusterCompressionLimit0Data[0]=this._maxAttenuation,this._clusterCompressionLimit0Data[1]=this._maxColorValue,this._clusterTextureSizeId.setValue(this._clusterTextureSizeData),this._clusterBoundsMinId.setValue(this._clusterBoundsMinData),this._clusterBoundsDeltaId.setValue(this._clusterBoundsDeltaData),this._clusterCellsDotId.setValue(this._clusterCellsDotData),this._clusterCellsMaxId.setValue(this._clusterCellsMaxData),this._clusterCompressionLimit0Id.setValue(this._clusterCompressionLimit0Data)}evalLightCellMinMax(e,t,s){t.copy(e.min),t.sub(this.boundsMin),t.div(this.boundsDelta),t.mul2(t,this.cells),t.floor(),s.copy(e.max),s.sub(this.boundsMin),s.div(this.boundsDelta),s.mul2(s,this.cells),s.ceil(),t.max(ys.ZERO),s.min(this._cellsLimit)}collectLights(e){const t=this.lightsBuffer.maxLights,s=this._usedLights;let i=1;e.forEach((e=>{const n=!!(3&e.mask),r=2===e.type&&0===e._outerConeAngle;if(e.enabled&&0!==e.type&&e.visibleThisFrame&&e.intensity>0&&n&&!r&&i<t){let t;i<s.length?t=s[i]:(t=new Oh,s.push(t)),t.light=e,e.getBoundingBox(Ih),t.min.copy(Ih.getMin()),t.max.copy(Ih.getMax()),i++}})),s.length=i}evaluateBounds(){const e=this._usedLights,t=this.boundsMin,s=this.boundsMax;if(e.length>1){t.copy(e[1].min),s.copy(e[1].max);for(let i=2;i<e.length;i++)t.min(e[i].min),s.max(e[i].max)}else t.set(0,0,0),s.set(1,1,1);this.boundsDelta.sub2(s,t),this.lightsBuffer.setBounds(t,this.boundsDelta)}evaluateCompressionLimits(){let e=0,t=0;const s=this._usedLights;for(let i=1;i<s.length;i++){const n=s[i].light;e=Math.max(n.attenuationEnd,e);const r=n._colorLinear;t=Math.max(r[0],t),t=Math.max(r[1],t),t=Math.max(r[2],t)}this._maxAttenuation=e+Fh,this._maxColorValue=t+Fh,this.lightsBuffer.setCompressionRanges(this._maxAttenuation,this._maxColorValue)}updateClusters(e){this.counts.fill(0),this.clusters.fill(0),this.lightsBuffer.areaLightsEnabled=!!e&&e.areaLightsEnabled;const t=this._cells.x,s=this._cells.z,i=this.counts,n=this._maxCellLightCount,r=this.clusters,a=this.maxCellLightCount,o=this._usedLights;for(let e=1;e<o.length;e++){const l=o[e],h=l.light;this.lightsBuffer.addLightData(h,e),this.evalLightCellMinMax(l,Rh,Lh);const c=Rh.x,d=Lh.x,u=Rh.y,p=Lh.y,f=Rh.z,m=Lh.z;for(let o=c;o<=d;o++)for(let l=f;l<=m;l++)for(let h=u;h<=p;h++){const c=o+t*(l+h*s),d=i[c];d<n&&(r[a*c+d]=e,i[c]=d+1)}}}update(e,t=null){this.updateParams(t),this.updateCells(),this.collectLights(e),this.evaluateBounds(),this.evaluateCompressionLimits(),this.updateClusters(t),this.uploadTextures()}activate(){this.updateUniforms()}}let zh=null;const Nh=()=>{if(!zh){const e=atob("muPIHORMLNDCz4DxVR/ZvYfAUVEFR47KRIC4nwAAAAAP7WxlhD6Ci+2HCe7BF8jRAPZwdH2UPpI5PdLCJdkvG4UTaNDJ/0crAzne71GCrb4kbdMjjCEGzdX6fNxDMLJq5xkeoIVTdfiZkodEeArmZmp/FQzFjD4x8iOW7Dg64n+3mWqyEwLxXT8zoJXfbw8QJKDCaarUYyTlMzNFHbgUe9IQV7g4YOgtSKpIFZJ0qERm7u4PpmiF89ktHWCywaGmD6h+hfh2/Zd8KYlKqqo4Cem4T42bT/Z9FpCQF1hhSjfBzZ5XFn/y3jegWC6u86KuELRundQS/1Rp+XuKKGIgRv3CvP5y749yqLlFO495JOT3+f2CXgd71npU0/KjjpkZucbJ5m78IVyuSrSozc9jgBUhDrz0hFsyb7LFUH9//wJbBgLdNWJZObfKxrNt8TliLA9w9sXFv6g26iXpf6r/BqcAusj/QzGBZuoUGeEtw8BCXCZ3jUiw4hvM18ZVqlUD3C40LAFXW6FRjuAZGRNstb0/qVk4skwyT+MHrvRorI4rKHVMWZmKyAkzL/78u/9pMQuX14pZN50b2PHn6fRxeaCQLsfT4dpvIkWWFuFVENZIh+8xgR6lU+85W0PPdAu1j99kcCG40JBQa4JMyRzq6qriOBLtqF87vpCJan0WEduVr/mOYkS00urVA0mA6M3031+GmGmW48PaJDYOEIb3bIXWPaLoAOEinX1TN3+/vwhG6nqJu0TdHpedS7QsGZIoxH3nQYYjQP1jmbahlbNngw5ogsGk1y50XZyUmQBY+/JBJ3Unu4dApm+WmPwHPU9gLb+4mHh4BiY6M86pq+WeTyWdI3s0CXPEtHGXZ8zMZgUoyRomBi1VdazzuN+WOmQ9Pa0Z0tlNopUi8AJ4x2Xn4mmOKEbXLxlbVsWu8XhuDGYFOGCRVdSqDPXrHU5SDdUlti3k5///SBwzTMwK3L4a1H7w4lnpEas6////AfX8asyIBfeFXVJ3tgvxQ/blZuUKyIODIfr/UzdWNu7pciLBpdZRZ4pIfZ1R6szq+XNxkGG///8EZFpu7VHAhFWqHEOrB9unw+YQa5o8/9IR/V5/zq+986rJSyfgJKt2u9hxU1wzyQWPjJGvzG9+eWWxGFOHVKqI4jBQALwZZswesnvZ2UmmkEXdiRpz8B+oWE7PY70ZTMndisYSXg2TqoI+3y9BxbnY2Y4EfbdcRhAvG59NqDENNYbxKvK5HJfPG5M+Wi2AcpLVJrD6caiEOzgSoVNSgQK8fm2M3zGcF4xtClv/8Hs9oD7C3jitTATYNQxmKqKf1LhIxzf1bmfiNn7UKFmcJu4sLqVLwxGSue3taBEyknkw5hXTsUCvqmmL/f8n/w0giR7Hu/9EHvpkz3yuu64TioMkzdTJ30i0+hFnQqW1+v9mMwq+z9qGX0UFu9MomvVG2xod6vc12AAAAACq7sGa5qptFR0jF3nQt/D+7PibKYahaxP3hEixPbGi9nwNf2LAa7LkEZRKxzXeCD64Xpii5n+8Kpg8eHIv7AWXZltgMoGltmoJ0XGdOCL8WkzphvR9N2o3ARSZ42l5e5Pe4B58MCRlP3EKv+mcloknH+fto5BWsmEutW6KvjOVsznFCktkSczVk4aGvj9VXlRcLeDoKG8RkBgdcNG2bf8HUL4MT2DM+ar7NImJhKpxakX4Vk0CnP+/XNhl5UsP0lXgeZXPoDBMSW5An+DXlTCO5FQGwSPYwHLKYVIimEdAoVe49rQLaaNcye5LxU2/c5TijTgJtD5eQQIe1snxauj5jZsxJBUJdoP/zqpjqv8qBruoPsVsP8N44PCUW5Dd0DzqjSS/Dl5mI9cn1w2ndN/0KAEm1QAAAACwu6KM/083IBbH5bPa/9oHUwcU8I9v3j6/v18QYammrf+P6VL///8BrpuM3fOLCxaLNOFNF1zPbPYTP65ni6njft4eVcyrVXRQFrs52tr35StiSp55edVDCBC0H5rIfac6nzUwxQSt7y15QoKb+5zebEQUmVbrPjXuUa19Ey7sqXMiSUKHaw72PJKDdrutJoQr3u6lEYJ8K0MakWKj9zjTFi4X94TsKYco0GrLeB60M6D8M/80rhXUW8iMequg8y5F838WI0+gp3GBN5Kj/xIOxTWQuUaPV/LwvARr1VH93BFgGZR1MFW0Ua30GbYmdnAgo9VWy8SQtpDUgGE2r2zq2eTEMCL7sMKmE1hchVhuF/TCq9iXKEm86kzOf3Rp9ZnCxbpDUj+FKNxVyXe6pVZkRXv/m95SnB/EB8aME29N85MtAcDoXWlor8De2Q5Dg1tar+8wgiZufbMam81j//ASUohoR/zSh2KG4bvT6mkIPz6C5/98DC3LaWlaEZ1zA5JORZRu6J/a0GY285sEYzw71YqOT1ihAG0z5SDt1xNiDQWZdFpndArp6xWhqSDkRb4kSJEHb9liPvw7uLV/6i5MVf//A9Qjr8xkAEUh+KDI+zdtJ68d6MBOktg1iyp/SCq8O9f5pbamn1VVVQPRTWqNBvhQKa07s6P0lc9Luu/3gw4HeyOUfz8MxMwV4UQhua+t9cr4bz/nIB2wnDSK1K7I94M+s6C84htaX/CNlMQUSs2KJO+yaebfTbkNX5yWcqEJevo0vbKUiETuFXiL019A3E+lmsyZMwXrXLLiQAZ5t9+jI3JobhJTMiDH5ZOQ+8Jau5555NMjHSscP9qCVaa40doh+1a3Ukf6jqBmLddgh79/fwTfCyqiuldNkUoy+nUp+4nerwg0OjtGv2x485PJOJvUEokNhYIdWjpx7BWk0VZGWOp3jSFTJ2bnu6KCduZtG/UcBC9RZ3W/jMSfSMw4Etr/DoD/XYP2V5Ovw+YoM3F5g2dGLdvuG6ZkVGLE6Dk5Zr+sdSyGliJP1y2OFf/KFO0RWO+3gsGhesTnfZVpTd8/HwgO216gwaqo+vY3TljfJWowY+i0p0Os4SLn/1wLqDHMlszggmT/D8MRFzs+pLv6LNJSsNZ/r41mWi/rF6ZcKp/yzJdK0VU44hskq3RGpgO6mIpJDsf/mZkFrz0yYOMLbuaj/wp1v7JMFM5eqvBhmTd7U8frQAtHtys4zgpjZmzUhOVTfNNLifElGXADlqHGKrkBT/nYwX8ZRm3RjvyPvjKyEqEGKUpVnvOGx+NKPHiWM//ZDpDVGvvrjmk8RPF/wiYZD3+Us8YCXjrVOfjdd1UPAfjLp8jgSn4me7DPTpz1Ggy9XL80guFO7ECT10AvILKfD18Qx+KY/f8aRqu0oOO8hfKRFZa9PUJwCsp6VdZz6LFkm2b9Pl2LIifCwzRy7TpdG2uAtOxP2OemY26bJMa9ZGSLIRlMsgpDpnDJwd0oa5pQ13x1hrHf52HpulUWonGWsfXZbSQYKu9bnEN76ciQih0opN3deDVrbrxorfVlnCmL1R9zq3ePGWIv21c7pW8kEiFTM5JX8dAw867s/60cf79/BH+MDFCZBHlz1L+qGOJf/1txhhmrf3//As+RIJwevDb+fgNXVeHw67QptZegayhrEwr5Gy+EPo1RLaMtPbqOZYoVzXzwzjMFWZxyUG9YUIf6////AQWy84iAygLk9COtXt92+0mT/xg0zMzMBeLkb8y9SL2TDXgSX422hDgpGNLJyuPioA+YJ91G8znrpNqHkwYyscaJDEc9Vc+j4cXle3hvcd2JqDQH2lBZxDn6mUTs0b75raMvbs727codX01Anj8f3wir9P2xQaQ22v/TxCMglKDFoTjaP01XTLgxnTvPv02JgEUrW6UDgOnobFpLdvKdlypgIzPcq14fgXU5tvVW0FEs7VRlsG1IyA69fN4n+awHhT34cE+xUvdj86C8LgAsFheTjI9Ht9EyYAAAAAAVBVKRx2wLgUTI0/2QfyJo2riRw3JDqzEShmx/Lifo6mRkQVbS7X53t+EvKxcXogtdts31e9MRHdcHgsA8rt4/mt2unlzQ/wsU8Gu7+W6Oj7eD8EQdDp5XlCsVaS/AV/t5ZpPOHR3rGpyAJe9IPV+xMrBL1Oz/8MQhFs31h0N1cVnq371uqIJYHyafKH1jteAK3VpMXBcuC+yt0ZeKyRUY4QhdrJJ4tJ1wg3Hu6kDsbovxupTMkGdRrm8oZSoYPbJ+PwH/xotgTdkA1205vUEfnqkI04T/fnnd1fiZW5AwNcggd7fi4j5zasmcntZexIxqFZQMzMJpfndmI5jn17cgn5EV5t9XN0C///8Q9wlJpMGXdoiaMTG2sVyHQsn8mWRISCLNG777S0OuDRP2GlLcJ2UeOg7Fo8hTNPeJ//iTJhyqxhKRUntdXOihq2wfKfH///8B0GGrwT+fSOQRdctKxjjGCSS11d6BlQ9BDfE0J6Z25FaNTKGpFKNCMr2G/041KpWwBLVe1k08vncseQbKZdXi8x1t9XA45U/Wd43D9wAh3Tal0aiLVzGPusOZ1F+W3TWoqlX/A95+dNef11TsuGful+ctGssldk3fqpfqh+43XTxL42+leSHoF/dWHYGX6maqUEuLX7UB+r/6Llr4LKocbVIeu+hB9QTPfz9fCP8RyWmX4SmbhMFsNtCijV7lVcwejLKlvl0GfCndnWV7/39VBrtTRuUx92oke3GBgKkC5fdGK0YvNK+xenKaDmsHDjNFUM3NMz3ZiXXFuLgojosPVCDEl2W5BjX3Ms+j0GSqACHmh0+RPWyuNm/Qe8vFf9AW7N1uRaxWirrUytqEJnJ4/Flm8hSoiZ2NQBsS6w/yQlC4gCaFo8q4nyY6AFdo4hiwhBXzbNKKvZvktCjSCukRR/BbYVbNwZi2Yh3hGodEacLW8qijiWJODf0P2bhfaiPspPT4lYJBgi/KfcFwCfvyUIgkJOv///8CG/JEepRBLaMFE+2TgrqsJXOVOWHt6g/bFwVLLMVBsMR50dis/39/AlBX+/rMTJkUQrnlxpR2iu0Tp8tATkRYGmDIrcAiRP8PjoWIlb7/0ecTdSCE9Y58+a+n/FovJQTVF4F2jAxMZhTgrM/KVS5BQu6bVbkWY5HXnxRshks3urDdW4RkWp4M4TeLmFK5KF/uHkkiO5Kv96RioH984v/CSDBnG+BwlnU9B+o7Y+0X0Nob+0pLsStxjvPXMy2eCpzhOWV4XbObBHN4UE2sLQ/DIqXhOzxVf38GlTi6aG7EnePO7TRJm9yOfUUcqq1I2iQHrVDqn3TUNRi/lMw8KbMW/3/nqCz/Ef8PoW5Qxcz2yHR/f78EPB2Stbd+ZFmfNTUYILzsb9YNhpaHcaymYrBiNHmFE3Y4ccYJ25Prqm7zHobGHED8/93ZNlWro9vcKivGZs31UiK1k5zjUhexUgbqJb+fUTjxce/7Zly8a5KMC1fX5nfjPgibdvzbXV1jRT2asXvmSAusaLdq1TSIJ8fXINk5AtT34EWPAsfP9IFQqM5K11O6saoHJA==");zh=Uint8Array.from(e,(e=>e.charCodeAt(0)))}},Uh=()=>(Nh(),zh);class Vh{constructor(e=0){this.seed=0,this.seed=4*e,Nh()}_next(){this.seed=(this.seed+4)%zh.length}value(){return this._next(),zh[this.seed]/255}vec4(e=new Ss){return this._next(),e.set(zh[this.seed],zh[this.seed+1],zh[this.seed+2],zh[this.seed+3]).mulScalar(1/255)}}const Gh=[new ys(-1,0,0),new ys(1,0,0),new ys(0,-1,0),new ys(0,1,0),new ys(0,0,-1),new ys(0,0,1)];class Hh{constructor(){this.colors=new Float32Array(18)}update(e,t){const s=this.colors,{r:i,g:n,b:r}=e;for(let e=0;e<6;e++)s[3*e]=i,s[3*e+1]=n,s[3*e+2]=r;for(let e=0;e<t.length;e++){const i=t[e];if(0===i._type)for(let e=0;e<6;e++){const t=Math.max(Gh[e].dot(i._direction),0)*i._intensity,n=i._color;s[3*e]+=n.r*t,s[3*e+1]+=n.g*t,s[3*e+2]+=n.b*t}}}}const jh=new _n,Wh=e=>jh.get(e,(()=>{const t=Uh(),s=Math.sqrt(t.length/4);return((e,t,s,i)=>{const n=new yn(e,{name:`${t}${s}`,width:s,height:s,format:7,addressU:0,addressV:0,type:Ai,magFilter:0,minFilter:0,anisotropy:1,mipmaps:!1});return n.lock().set(i),n.unlock(),n})(e,"BlueNoise",s,t)}));class $h{constructor(e,t){this.texture=e,this.cached=!1,this.renderTargets=t}destroy(){this.texture&&(this.texture.destroy(),this.texture=null);const e=this.renderTargets;for(let t=0;t<e.length;t++)e[t].destroy();this.renderTargets.length=0}static getShadowFiltering(e,t){return 3===t?e.extTextureFloatLinear?1:0:1}static create(e,t){let s=null;return s=1===t._type?this.createCubemap(e,t._shadowResolution,t._shadowType):this.create2dMap(e,t._shadowResolution,t._shadowType),s}static createAtlas(e,t,s){const i=this.create2dMap(e,t,s),n=i.renderTargets,r=n[0];for(let e=0;e<5;e++)n.push(r);return i}static create2dMap(e,t,s){var i;const n=Wo.get(s),r=this.getShadowFiltering(e,s),a=null==(i=si.get(n.format))?void 0:i.name,o=new yn(e,{format:null==n?void 0:n.format,width:t,height:t,mipmaps:!1,minFilter:r,magFilter:r,addressU:1,addressV:1,name:`ShadowMap2D_${a}`});let l=null;return null!=n&&n.pcf?(o.compareOnRead=!0,o.compareFunc=1,l=new tr({depthBuffer:o})):l=new tr({colorBuffer:o,depth:!0}),e.isWebGPU&&(l.flipY=!0),new $h(o,[l])}static createCubemap(e,t,s){var i;const n=Wo.get(s),r=null==(i=si.get(n.format))?void 0:i.name,a=6===s,o=a?0:1,l=new yn(e,{format:null==n?void 0:n.format,width:t,height:t,cubemap:!0,mipmaps:!1,minFilter:o,magFilter:o,addressU:1,addressV:1,name:`ShadowMapCube_${r}`});a||(l.compareOnRead=!0,l.compareFunc=1);const h=[];for(let e=0;e<6;e++)a?h.push(new tr({colorBuffer:l,face:e,depth:!0})):h.push(new tr({depthBuffer:l,face:e}));return new $h(l,h)}}const qh=[],Xh=[],Kh=new Ss,Yh=new Ss;class Qh{constructor(e){this.size=Math.floor(1024*e.w),this.used=!1,this.lightId=-1,this.rect=e}}class Jh{constructor(e){this.device=e,this.version=1,this.shadowAtlasResolution=2048,this.shadowAtlas=null,this.shadowEdgePixels=3,this.cookieAtlasResolution=4,this.cookieAtlas=new yn(this.device,{name:"CookieAtlas",width:this.cookieAtlasResolution,height:this.cookieAtlasResolution,format:7,cubemap:!1,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1}),this.cookieRenderTarget=new tr({colorBuffer:this.cookieAtlas,depth:!1,flipY:!0}),this.slots=[],this.atlasSplit=[],this.cubeSlotsOffsets=[new ws(0,0),new ws(0,1),new ws(1,0),new ws(1,1),new ws(2,0),new ws(2,1)],this.scissorVec=new Ss,this.allocateShadowAtlas(1),this.allocateCookieAtlas(1),this.allocateUniforms()}destroy(){this.destroyShadowAtlas(),this.destroyCookieAtlas()}destroyShadowAtlas(){var e;null==(e=this.shadowAtlas)||e.destroy(),this.shadowAtlas=null}destroyCookieAtlas(){var e,t;null==(e=this.cookieAtlas)||e.destroy(),this.cookieAtlas=null,null==(t=this.cookieRenderTarget)||t.destroy(),this.cookieRenderTarget=null}allocateShadowAtlas(e,t=0){var s;const i=null==(s=this.shadowAtlas)?void 0:s.texture.format,n=Wo.get(t).format;if(!this.shadowAtlas||this.shadowAtlas.texture.width!==e||i!==n){this.version++,this.destroyShadowAtlas(),this.shadowAtlas=$h.createAtlas(this.device,e,t),this.shadowAtlas.cached=!0;const s=4/this.shadowAtlasResolution;this.scissorVec.set(s,s,-2*s,-2*s)}}allocateCookieAtlas(e){this.cookieAtlas.width!==e&&(this.cookieRenderTarget.resize(e,e),this.version++)}allocateUniforms(){this._shadowAtlasTextureId=this.device.scope.resolve("shadowAtlasTexture"),this._shadowAtlasParamsId=this.device.scope.resolve("shadowAtlasParams"),this._shadowAtlasParams=new Float32Array(2),this._cookieAtlasTextureId=this.device.scope.resolve("cookieAtlasTexture")}updateUniforms(){const e=this.shadowAtlas.renderTargets[0].depthBuffer;this._shadowAtlasTextureId.setValue(e),this._shadowAtlasParams[0]=this.shadowAtlasResolution,this._shadowAtlasParams[1]=this.shadowEdgePixels,this._shadowAtlasParamsId.setValue(this._shadowAtlasParams),this._cookieAtlasTextureId.setValue(this.cookieAtlas)}subdivide(e,t){let s=t.atlasSplit;if(!s){const t=Math.ceil(Math.sqrt(e));s=Xh,s[0]=t,s.length=1}if(i=s,n=this.atlasSplit,i.length!==n.length||!i.every(((e,t)=>e===n[t]))){this.version++,this.slots.length=0,this.atlasSplit.length=0,this.atlasSplit.push(...s);const e=this.atlasSplit[0];if(e>1){const t=1/e;for(let s=0;s<e;s++)for(let i=0;i<e;i++){const n=new Ss(s*t,i*t,t,t),r=this.atlasSplit[1+s*e+i];if(r>1)for(let e=0;e<r;e++)for(let s=0;s<r;s++){const i=t/r,a=new Ss(n.x+e*i,n.y+s*i,i,i);this.slots.push(new Qh(a))}else this.slots.push(new Qh(n))}}else this.slots.push(new Qh(new Ss(0,0,1,1)));this.slots.sort(((e,t)=>t.size-e.size))}var i,n}collectLights(e,t){const s=t.cookiesEnabled,i=t.shadowsEnabled;let n=!1,r=!1;const a=qh;a.length=0;return(s||i)&&(e=>{for(let t=0;t<e.length;t++){const o=e[t];if(o.visibleThisFrame){const e=i&&o.castShadows,t=s&&!!o.cookie;n||(n=e),r||(r=t),(e||t)&&a.push(o)}}})(e),a.sort(((e,t)=>t.maxScreenSize-e.maxScreenSize)),n&&this.allocateShadowAtlas(this.shadowAtlasResolution,t.shadowType),r&&this.allocateCookieAtlas(this.cookieAtlasResolution),(n||r)&&this.subdivide(a.length,t),a}setupSlot(e,t){e.atlasViewport.copy(t);const s=e.numShadowFaces;for(let i=0;i<s;i++)if(e.castShadows||e._cookie){if(Kh.copy(t),Yh.copy(t),2===e._type&&Kh.add(this.scissorVec),1===e._type){const e=Kh.z/3,t=this.cubeSlotsOffsets[i];Kh.x+=e*t.x,Kh.y+=e*t.y,Kh.z=e,Kh.w=e,Yh.copy(Kh)}if(e.castShadows){const t=e.getRenderData(null,i);t.shadowViewport.copy(Kh),t.shadowScissor.copy(Yh)}}}assignSlot(e,t,s){e.atlasViewportAllocated=!0;const i=this.slots[t];i.lightId=e.id,i.used=!0,s&&(e.atlasSlotUpdated=!0,e.atlasVersion=this.version,e.atlasSlotIndex=t)}update(e,t){this.shadowAtlasResolution=t.shadowAtlasResolution,this.cookieAtlasResolution=t.cookieAtlasResolution;const s=this.collectLights(e,t);if(s.length>0){const e=this.slots;for(let t=0;t<e.length;t++)e[t].used=!1;const t=Math.min(s.length,e.length);for(let i=0;i<t;i++){const t=s[i];t.castShadows&&(t._shadowMap=this.shadowAtlas);const n=e[t.atlasSlotIndex];if(t.atlasVersion===this.version&&t.id===(null==n?void 0:n.lightId)){const s=e[t.atlasSlotIndex];s.size!==e[i].size||s.used||this.assignSlot(t,t.atlasSlotIndex,!1)}}let i=0;for(let n=0;n<t;n++){for(;i<e.length&&e[i].used;)i++;const t=s[n];t.atlasViewportAllocated||this.assignSlot(t,i,!0);const r=e[t.atlasSlotIndex];this.setupSlot(t,r.rect)}}this.updateUniforms()}}const Zh=[];Zh[0]={src:1,dst:1,op:2},Zh[3]={src:1,dst:0,op:0},Zh[2]={src:6,dst:8,op:0,alphaSrc:1},Zh[4]={src:1,dst:8,op:0},Zh[1]={src:1,dst:1,op:0},Zh[6]={src:6,dst:1,op:0},Zh[7]={src:4,dst:2,op:0},Zh[8]={src:5,dst:1,op:0},Zh[5]={src:4,dst:0,op:0},Zh[9]={src:1,dst:1,op:3},Zh[10]={src:1,dst:1,op:4};let ec=0;class tc{constructor(){this.meshInstances=[],this.name="Untitled",this.userId="",this.id=ec++,this.variants=new Map,this.defines=new Map,this._definesDirty=!1,this.parameters={},this.alphaTest=0,this.alphaToCoverage=!1,this._blendState=new Rn,this._depthState=new On,this.cull=1,this.stencilFront=null,this.stencilBack=null,this._shaderVersion=0,this._scene=null,this.dirty=!0}set depthBias(e){this._depthState.depthBias=e}get depthBias(){return this._depthState.depthBias}set slopeDepthBias(e){this._depthState.depthBiasSlope=e}get slopeDepthBias(){return this._depthState.depthBiasSlope}set redWrite(e){this._blendState.redWrite=e}get redWrite(){return this._blendState.redWrite}set greenWrite(e){this._blendState.greenWrite=e}get greenWrite(){return this._blendState.greenWrite}set blueWrite(e){this._blendState.blueWrite=e}get blueWrite(){return this._blendState.blueWrite}set alphaWrite(e){this._blendState.alphaWrite=e}get alphaWrite(){return this._blendState.alphaWrite}get transparent(){return this._blendState.blend}_updateTransparency(){const e=this.transparent,t=this.meshInstances;for(let s=0;s<t.length;s++)t[s].transparent=e}set blendState(e){this._blendState.copy(e),this._updateTransparency()}get blendState(){return this._blendState}set blendType(e){var t,s,i;const n=Zh[e];this._blendState.setColorBlend(n.op,n.src,n.dst),this._blendState.setAlphaBlend(null!=(t=n.alphaOp)?t:n.op,null!=(s=n.alphaSrc)?s:n.src,null!=(i=n.alphaDst)?i:n.dst);const r=3!==e;this._blendState.blend!==r&&(this._blendState.blend=r,this._updateTransparency()),this._updateMeshInstanceKeys()}get blendType(){if(!this.transparent)return 3;const{colorOp:e,colorSrcFactor:t,colorDstFactor:s,alphaOp:i,alphaSrcFactor:n,alphaDstFactor:r}=this._blendState;for(let a=0;a<Zh.length;a++){const o=Zh[a];if(o.src===t&&o.dst===s&&o.op===e&&o.src===n&&o.dst===r&&o.op===i)return a}return 2}set depthState(e){this._depthState.copy(e)}get depthState(){return this._depthState}set depthTest(e){this._depthState.test=e}get depthTest(){return this._depthState.test}set depthFunc(e){this._depthState.func=e}get depthFunc(){return this._depthState.func}set depthWrite(e){this._depthState.write=e}get depthWrite(){return this._depthState.write}copy(e){var t;this.name=e.name,this.alphaTest=e.alphaTest,this.alphaToCoverage=e.alphaToCoverage,this._blendState.copy(e._blendState),this._depthState.copy(e._depthState),this.cull=e.cull,this.stencilFront=null==(t=e.stencilFront)?void 0:t.clone(),e.stencilBack&&(this.stencilBack=e.stencilFront===e.stencilBack?this.stencilFront:e.stencilBack.clone()),this.clearParameters();for(const t in e.parameters)e.parameters.hasOwnProperty(t)&&this._setParameterSimple(t,e.parameters[t].data);return this.defines.clear(),e.defines.forEach(((e,t)=>this.defines.set(t,e))),this}clone(){return(new this.constructor).copy(this)}_updateMeshInstanceKeys(){const e=this.meshInstances;for(let t=0;t<e.length;t++)e[t].updateKey()}updateUniforms(e,t){}getShaderVariant(e){}update(){this._definesDirty&&(this._definesDirty=!1,this.clearVariants()),this.dirty=!0}clearParameters(){this.parameters={}}getParameters(){return this.parameters}clearVariants(){this.variants.clear();const e=this.meshInstances,t=e.length;for(let s=0;s<t;s++)e[s].clearShaders()}getParameter(e){return this.parameters[e]}_setParameterSimple(e,t){const s=this.parameters[e];s?s.data=t:this.parameters[e]={scopeId:null,data:t}}setParameter(e,t){if(void 0===t&&"object"==typeof e){const s=e;if(s.length){for(let e=0;e<s.length;e++)this.setParameter(s[e]);return}e=s.name,t=s.value}this._setParameterSimple(e,t)}deleteParameter(e){this.parameters[e]&&delete this.parameters[e]}setParameters(e,t){const s=this.parameters;void 0===t&&(t=s);for(const i in t){const t=s[i];t&&(t.scopeId||(t.scopeId=e.scope.resolve(i)),t.scopeId.setValue(t.data))}}setDefine(e,t){let s=!1;const{defines:i}=this;void 0!==t&&!1!==t?(s=!i.has(e)||i.get(e)!==t,i.set(e,t)):(s=i.has(e),i.delete(e)),this._definesDirty||(this._definesDirty=s)}getDefine(e){return this.defines.has(e)}destroy(){this.variants.clear();for(let e=0;e<this.meshInstances.length;e++){const t=this.meshInstances[e];if(t.clearShaders(),t._material=null,t.mesh){const e=Ll(t.mesh.device);this!==e&&(t.material=e)}}this.meshInstances.length=0}addMeshInstanceRef(e){this.meshInstances.push(e)}removeMeshInstanceRef(e){const t=this.meshInstances,s=t.indexOf(e);-1!==s&&t.splice(s,1)}}class sc{constructor(){this.cache=new Map}destroy(){this.clear(),this.cache=null}clear(){this.cache.forEach((e=>{e.forEach((e=>{e.destroy()}))})),this.cache.clear()}getKey(e){return`${1===e._type}-${e._shadowType}-${e._shadowResolution}`}get(e,t){const s=this.getKey(t),i=this.cache.get(s);if(i&&i.length)return i.pop();const n=$h.create(e,t);return n.cached=!0,n}add(e,t){const s=this.getKey(e),i=this.cache.get(s);i?i.push(t):this.cache.set(s,[t])}}class ic extends uo{constructor(e,t,s,i,n){super(e),this.requiresCubemaps=!1,this.shadowRenderer=t,this.light=s,this.face=i,this.applyVsm=n,this.shadowCamera=t.prepareFace(s,null,i),t.setupRenderPass(this,this.shadowCamera,!0)}execute(){this.shadowRenderer.renderFace(this.light,null,this.face,!1)}after(){this.applyVsm&&this.shadowRenderer.renderVsm(this.light,this.shadowCamera)}}class nc{constructor(e,t){this.shadowLights=[],this.renderer=void 0,this.shadowRenderer=void 0,this.device=void 0,this.renderer=e,this.shadowRenderer=t,this.device=e.device}cull(e,t,s=null){const i=this.renderer.scene.clusteredLightingEnabled;e.visibleThisFrame=!0,i||e._shadowMap||(e._shadowMap=$h.create(this.device,e));const n=e._type,r=2===n?1:6;for(let a=0;a<r;a++){const r=e.getRenderData(null,a),o=r.shadowCamera;o.nearClip=e.attenuationEnd/1e3,o.farClip=e.attenuationEnd,r.depthRangeCompensation=o.farClip-o.nearClip;const l=o._node,h=e._node;if(l.setPosition(h.getPosition()),2===n)o.fov=2*e._outerConeAngle,l.setRotation(h.getRotation()),l.rotateLocal(-90,0,0);else if(1===n)if(i){const t=2/(this.shadowRenderer.lightTextureAtlas.shadowAtlasResolution*e.atlasViewport.z/3)*this.shadowRenderer.lightTextureAtlas.shadowEdgePixels;o.fov=Math.atan(1+t)*rs.RAD_TO_DEG*2}else o.fov=90;this.renderer.updateCameraFrustum(o),this.shadowRenderer.cullShadowCasters(t,e,r.visibleCasters,o,s)}}prepareLights(e,t){let s;for(let i=0;i<t.length;i++){const n=t[i];if(this.shadowRenderer.needsShadowRendering(n)&&n.atlasViewportAllocated){e.push(n);for(let e=0;e<n.numShadowFaces;e++)s=this.shadowRenderer.prepareFace(n,null,e)}}return s}buildNonClusteredRenderPasses(e,t){for(let s=0;s<t.length;s++){const i=t[s];if(this.shadowRenderer.needsShadowRendering(i)){const t=2===i._type,s=i.numShadowFaces;for(let n=0;n<s;n++){const s=new ic(this.device,this.shadowRenderer,i,n,t);e.addRenderPass(s)}}}}}class rc extends uo{constructor(e,t,s,i,n){super(e),this.shadowRenderer=t,this.light=s,this.camera=i,this.allCascadesRendering=n}execute(){const{light:e,camera:t,shadowRenderer:s,allCascadesRendering:i}=this,n=e.numShadowFaces,r=e.shadowUpdateOverrides;for(let a=0;a<n;a++)0!==(null==r?void 0:r[a])&&s.renderFace(e,t,a,!i),1===(null==r?void 0:r[a])&&(r[a]=0)}after(){this.shadowRenderer.renderVsm(this.light,this.camera)}}const ac=new Bs,oc=new ys,lc=new As,hc=[new ys,new ys,new ys,new ys,new ys,new ys,new ys,new ys],cc={min:0,max:0};function dc(e,t,s){hc[0].x=hc[1].x=hc[2].x=hc[3].x=t.x,hc[1].y=hc[3].y=hc[7].y=hc[5].y=t.y,hc[2].z=hc[3].z=hc[6].z=hc[7].z=t.z,hc[4].x=hc[5].x=hc[6].x=hc[7].x=s.x,hc[0].y=hc[2].y=hc[4].y=hc[6].y=s.y,hc[0].z=hc[1].z=hc[4].z=hc[5].z=s.z;let i=9999999999,n=-9999999999;for(let t=0;t<8;++t){e.transformPoint(hc[t],hc[t]);const s=hc[t].z;s<i&&(i=s),s>n&&(n=s)}return cc.min=i,cc.max=n,cc}class uc{constructor(e,t){this.renderer=void 0,this.shadowRenderer=void 0,this.device=void 0,this.renderer=e,this.shadowRenderer=t,this.device=e.device}cull(e,t,s,i=null){e.visibleThisFrame=!0,e._shadowMap||(e._shadowMap=$h.create(this.device,e));const n=s._nearClip;this.generateSplitDistances(e,n,Math.min(s._farClip,e.shadowDistance));const r=e.shadowUpdateOverrides;for(let a=0;a<e.numCascades&&0!==(null==r?void 0:r[a]);a++){const r=e.getRenderData(s,a),o=r.shadowCamera;o.renderTarget=e._shadowMap.renderTargets[0],r.shadowViewport.copy(e.cascades[a]),r.shadowScissor.copy(e.cascades[a]);const l=o._node,h=e._node;l.setPosition(h.getPosition()),l.setRotation(h.getRotation()),l.rotateLocal(-90,0,0);const c=0===a?n:e._shadowCascadeDistances[a-1],d=e._shadowCascadeDistances[a],u=s.getFrustumCorners(c,d);oc.set(0,0,0);const p=s.node.getWorldTransform();for(let e=0;e<8;e++)p.transformPoint(u[e],u[e]),oc.add(u[e]);oc.mulScalar(1/8);let f=0;for(let e=0;e<8;e++){const t=u[e].sub(oc).length();t>f&&(f=t)}const m=l.right,g=l.up,_=l.forward,v=.25*e._shadowResolution/f,b=Math.ceil(oc.dot(g)*v)/v,y=Math.ceil(oc.dot(m)*v)/v,x=g.mulScalar(b),w=m.mulScalar(y),S=oc.dot(_),C=_.mulScalar(S);oc.add2(x,w).add(C),l.setPosition(oc),l.translateLocal(0,0,1e6),o.nearClip=.01,o.farClip=2e6,o.orthoHeight=f,this.renderer.updateCameraFrustum(o),this.shadowRenderer.cullShadowCasters(t,e,r.visibleCasters,o,i);let T=!0;const E=r.visibleCasters;for(let e=0;e<E.length;e++){const t=E[e];T?(T=!1,ac.copy(t.aabb)):ac.add(t.aabb)}lc.copy(l.getWorldTransform()).invert();const P=dc(lc,ac.getMin(),ac.getMax());l.translateLocal(0,0,P.max+.1),o.farClip=P.max-P.min+.2,r.depthRangeCompensation=o.farClip,r.projectionCompensation=f}}generateSplitDistances(e,t,s){e._shadowCascadeDistances.fill(s);for(let i=1;i<e.numCascades;i++){const n=i/e.numCascades,r=t+(s-t)*n,a=t*(s/t)**n,o=rs.lerp(r,a,e.cascadeDistribution);e._shadowCascadeDistances[i-1]=o}}getLightRenderPass(e,t){let s=null;if(this.shadowRenderer.needsShadowRendering(e)){const i=e.numShadowFaces,n=e.shadowUpdateOverrides;let r,a=!0;for(let s=0;s<i;s++)0===(null==n?void 0:n[s])&&(a=!1),r=this.shadowRenderer.prepareFace(e,t,s);s=new rc(this.device,this.shadowRenderer,e,t,a),this.shadowRenderer.setupRenderPass(s,r,a)}return s}}const pc=new _n;class fc{constructor(e,t,s={}){this.index=void 0,this.name=void 0,this.shaderDefines=void 0,this.name=e,this.index=t,Object.assign(this,s),this.shaderDefines=this.buildShaderDefines()}buildShaderDefines(){let e;this.isShadow?e="SHADOW":this.isForward?e="FORWARD":2===this.index?e="DEPTH":3===this.index&&(e="PICK");return(e?`#define ${e}_PASS\n`:"")+`#define ${this.name.toUpperCase()}_PASS\n`}}class mc{constructor(){this.passesNamed=new Map,this.passesIndexed=[],this.nextIndex=0;const e=(e,t,s)=>{this.allocate(e,s)};e("forward",0,{isForward:!0}),e("prepass"),e("depth"),e("pick"),e("shadow")}static get(e){return pc.get(e,(()=>new mc))}allocate(e,t){let s=this.passesNamed.get(e);return void 0===s&&(s=new fc(e,this.nextIndex,t),this.passesNamed.set(s.name,s),this.passesIndexed[s.index]=s,this.nextIndex++),s}getByIndex(e){return this.passesIndexed[e]}getByName(e){return this.passesNamed.get(e)}}const gc=new Set,_c=new As,vc=new As,bc=new Float32Array(2),yc=new Ss(1,1,0,0),xc=new As;function wc(e,t){return Math.exp(-e*e/(2*t*t))}class Sc{constructor(e,t){this.shadowPassCache=[],this.device=e.device,this.renderer=e,this.lightTextureAtlas=t;const s=this.device.scope;this.sourceId=s.resolve("source"),this.pixelOffsetId=s.resolve("pixelOffset"),this.weightId=s.resolve("weight[0]"),this.blurVsmShaderCode=[cl.blurVSMPS,`#define GAUSS\n${cl.blurVSMPS}`],this.blurVsmShader=[{},{}],this.blurVsmWeights={},this.shadowMapLightRadiusId=s.resolve("light_radius"),this.viewUniformFormat=null,this.viewBindGroupFormat=null,this.blendStateWrite=new Rn,this.blendStateNoWrite=new Rn,this.blendStateNoWrite.setColorWrite(!1,!1,!1,!1)}static createShadowCamera(e,t,s){var i,n;const r=wh.create("ShadowCamera",t,s),a=Wo.get(e),o=null!=(i=null==a?void 0:a.vsm)&&i,l=null!=(n=null==a?void 0:a.pcf)&&n;return r.clearColor=o?new os(0,0,0,0):new os(1,1,1,1),r.clearDepthBuffer=!0,r.clearStencilBuffer=!1,r.clearColorBuffer=!l,r}_cullShadowCastersInternal(e,t,s){const i=e.length;for(let n=0;n<i;n++){const i=e[n];i.castShadow&&(i.cull&&!i._isVisible(s)||(i.visibleThisFrame=!0,t.push(i)))}}cullShadowCasters(e,t,s,i,n){if(s.length=0,n)this._cullShadowCastersInternal(n,s,i);else{const n=e.layerList,r=n.length;for(let e=0;e<r;e++){const r=n[e];r._lightsSet.has(t)&&(gc.has(r)||(gc.add(r),this._cullShadowCastersInternal(r.shadowCasters,s,i)))}gc.clear()}s.sort(this.renderer.sortCompareDepth)}setupRenderState(e,t){const s=this.renderer.scene.clusteredLightingEnabled?t._isPcf:t._isPcf&&1!==t._type;e.setBlendState(s?this.blendStateNoWrite:this.blendStateWrite),e.setDepthState(t.shadowDepthState),e.setStencilState(null,null)}dispatchUniforms(e,t,s,i){const n=t._node;0!==e._type&&(this.renderer.dispatchViewPos(n.getPosition()),this.shadowMapLightRadiusId.setValue(e.attenuationEnd)),_c.setTRS(n.getPosition(),n.getRotation(),ys.ONE).invert(),vc.mul2(t.projectionMatrix,_c);const r=s.shadowViewport;t.rect=r,t.scissorRect=s.shadowScissor,xc.setViewport(r.x,r.y,r.z,r.w),s.shadowMatrix.mul2(xc,vc),0===e._type&&e._shadowMatrixPalette.set(s.shadowMatrix.data,16*i)}getShadowPass(e){var t;const s=e._type,i=e._shadowType;let n=null==(t=this.shadowPassCache[s])?void 0:t[i];if(!n){const e=`ShadowPass_${s}_${i}`;n=mc.get(this.device).allocate(e,{isShadow:!0,lightType:s,shadowType:i}),this.shadowPassCache[s]||(this.shadowPassCache[s]=[]),this.shadowPassCache[s][i]=n}return n.index}submitCasters(e,t,s){const i=this.device,n=this.renderer,r=n.scene,a=this.getShadowPass(t),o=s.shaderParams,l=e.length;for(let t=0;t<l;t++){const s=e[t],l=s.mesh;s.ensureMaterial(i);const h=s.material;n.setBaseConstants(i,h),n.setSkinning(i,s),h.dirty&&(h.updateUniforms(i,r),h.dirty=!1),h.chunks&&(n.setupCullMode(!0,1,s),h.setParameters(i),s.setParameters(i,16));const c=s.getShaderInstance(a,0,r,o,this.viewUniformFormat,this.viewBindGroupFormat),d=c.shader;s._key[1]=d.id,i.setShader(d),n.setVertexBuffers(i,l),n.setMorphing(i,s.morphInstance),this.renderer.setupMeshUniformBuffers(c,s);const u=s.renderStyle;i.setIndexBuffer(l.indexBuffer[u]),n.drawInstance(i,s,l,u),n._shadowDrawCalls++}}needsShadowRendering(e){const t=e.enabled&&e.castShadows&&0!==e.shadowUpdateMode&&e.visibleThisFrame;return 1===e.shadowUpdateMode&&(e.shadowUpdateMode=0),t&&(this.renderer._shadowMapUpdates+=e.numShadowFaces),t}getLightRenderData(e,t,s){return e.getRenderData(0===e._type?t:null,s)}setupRenderPass(e,t,s){const i=t.renderTarget;e.init(i),e.depthStencilOps.clearDepthValue=1,e.depthStencilOps.clearDepth=s,i.depthBuffer?e.depthStencilOps.storeDepth=!0:(e.colorOps.clearValue.copy(t.clearColor),e.colorOps.clear=s,e.depthStencilOps.storeDepth=!1),e.requiresCubemaps=!1}prepareFace(e,t,s){const i=e._type,n=this.getLightRenderData(e,t,s).shadowCamera,r=0===i?0:s;return n.renderTarget=e._shadowMap.renderTargets[r],n}renderFace(e,t,s,i,n=!0){const r=this.device,a=this.getLightRenderData(e,t,s),o=a.shadowCamera;this.dispatchUniforms(e,o,a,s);const l=o.renderTarget,h=this.renderer;h.setCameraUniforms(o,l),r.supportsUniformBuffers&&h.setupViewUniformBuffers(a.viewBindGroups,this.viewUniformFormat,this.viewBindGroupFormat,1),n?(h.setupViewport(o,l),i&&h.clear(o)):h.clearView(o,l,!0,!1),this.setupRenderState(r,e),this.submitCasters(a.visibleCasters,e,o)}render(e,t,s=!0){if(this.needsShadowRendering(e)){const i=e.numShadowFaces;for(let n=0;n<i;n++)this.prepareFace(e,t,n),this.renderFace(e,t,n,!0,s);this.renderVsm(e,t)}}renderVsm(e,t){if(e._isVsm&&e._vsmBlurSize>1){this.renderer.scene.clusteredLightingEnabled&&0!==e._type||this.applyVsmBlur(e,t)}}getVsmBlurShader(e,t){const s=this.blurVsmShader;let i=s[e][t];if(!i){this.blurVsmWeights[t]=function(e){const t=(e-1)/6,s=.5*(e-1),i=new Array(e);let n=0;for(let r=0;r<e;++r)i[r]=wc(r-s,t),n+=i[r];for(let t=0;t<e;++t)i[t]/=n;return i}(t);const n=cl.fullscreenQuadVS;let r=`#define SAMPLES ${t}\n`;r+=this.blurVsmShaderCode[e];const a=`blurVsm${e}${t}`;i=fl(this.device,n,r,a),s[e][t]=i}return i}applyVsmBlur(e,t){const s=this.device;s.setBlendState(Rn.NOBLEND);const i=e.getRenderData(0===e._type?t:null,0).shadowCamera.renderTarget,n=this.renderer.shadowMapCache.get(s,e),r=n.renderTargets[0],a=e.vsmBlurMode,o=e._vsmBlurSize,l=this.getVsmBlurShader(a,o);yc.z=e._shadowResolution-2,yc.w=yc.z,this.sourceId.setValue(i.colorBuffer),bc[0]=1/e._shadowResolution,bc[1]=0,this.pixelOffsetId.setValue(bc),1===a&&this.weightId.setValue(this.blurVsmWeights[o]),Cl(s,r,l,null,yc),this.sourceId.setValue(r.colorBuffer),bc[1]=bc[0],bc[0]=0,this.pixelOffsetId.setValue(bc),Cl(s,i,l,null,yc),this.renderer.shadowMapCache.add(e,n)}initViewBindGroupFormat(){this.device.supportsUniformBuffers&&!this.viewUniformFormat&&(this.viewUniformFormat=new Br(this.device,[new Or("matrix_viewProjection",Vi)]),this.viewBindGroupFormat=new gn(this.device,[new un(tn,3)]))}frameUpdate(){this.initViewBindGroupFormat()}}const Cc=[];class Tc{constructor(e){this._empty=null,this._allocated=[],this._clusters=new Map,this.device=e}destroy(){this._empty&&(this._empty.destroy(),this._empty=null),this._allocated.forEach((e=>{e.destroy()})),this._allocated.length=0}get count(){return this._allocated.length}get empty(){if(!this._empty){const e=new Bh(this.device);e.name="ClusterEmpty",e.update([]),this._empty=e}return this._empty}assign(e){const t=this.empty;Cc.push(...this._allocated),this._allocated.length=0,this._clusters.clear();const s=e.length;for(let n=0;n<s;n++){const s=e[n].renderActions;if(s){const e=s.length;for(let n=0;n<e;n++){const e=s[n];e.lightClusters=null;const r=e.layer;if(r.hasClusteredLights&&r.meshInstances.length){const t=r.getLightIdHash(),s=this._clusters.get(t);let n=null==s?void 0:s.lightClusters;var i;if(!n)n=null!=(i=Cc.pop())?i:new Bh(this.device),this._allocated.push(n),this._clusters.set(t,e);e.lightClusters=n}e.lightClusters||(e.lightClusters=t)}}}Cc.forEach((e=>e.destroy())),Cc.length=0}update(e,t){this.assign(e),this._clusters.forEach((e=>{const s=e.layer;e.lightClusters.update(s.clusteredLightsSet,t)}))}}const Ec="\n\tattribute vec2 vertex_position;\n\tvarying vec2 uv0;\n\tvoid main(void) {\n\t\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\t\tuv0 = vertex_position.xy * 0.5 + 0.5;\n\t\t#ifndef WEBGPU\n\t\t\tuv0.y = 1.0 - uv0.y;\n\t\t#endif\n\t}",Pc=new Ss,kc=[];class Ac extends uo{constructor(e,t){super(e),this._quadRenderer2D=null,this._quadRendererCube=null,this._filteredLights=[],this._cubeSlotsOffsets=t,this.requiresCubemaps=!1,this.blitTextureId=e.scope.resolve("blitTexture"),this.invViewProjId=e.scope.resolve("invViewProj")}destroy(){var e,t;null==(e=this._quadRenderer2D)||e.destroy(),this._quadRenderer2D=null,null==(t=this._quadRendererCube)||t.destroy(),this._quadRendererCube=null}static create(e,t){const s=new Ac(e.device,t);return s.init(e),s.colorOps.clear=!1,s.depthStencilOps.clearDepth=!1,s}update(e){const t=this._filteredLights;this.filter(e,t),this.executeEnabled=t.length>0}filter(e,t){for(let s=0;s<e.length;s++){const i=e[s];0!==i._type&&(i.atlasViewportAllocated&&i.atlasSlotUpdated&&i.enabled&&i.cookie&&i.visibleThisFrame&&t.push(i))}}initInvViewProjMatrices(){if(!kc.length)for(let e=0;e<6;e++){const t=wh.create(null,1,e),s=t.projectionMatrix,i=t.node.getLocalTransform().clone().invert();kc[e]=(new As).mul2(s,i).invert()}}get quadRenderer2D(){if(!this._quadRenderer2D){const e=fl(this.device,Ec,"\n\tvarying vec2 uv0;\n\tuniform sampler2D blitTexture;\n\tvoid main(void) {\n\t\tgl_FragColor = texture2D(blitTexture, uv0);\n\t}","cookieRenderer2d");this._quadRenderer2D=new xl(e)}return this._quadRenderer2D}get quadRendererCube(){if(!this._quadRendererCube){const e=fl(this.device,Ec,"\n\tvarying vec2 uv0;\n\tuniform samplerCube blitTexture;\n\tuniform mat4 invViewProj;\n\tvoid main(void) {\n\t\tvec4 projPos = vec4(uv0 * 2.0 - 1.0, 0.5, 1.0);\n\t\tvec4 worldPos = invViewProj * projPos;\n\t\tgl_FragColor = textureCube(blitTexture, worldPos.xyz);\n\t}","cookieRendererCube");this._quadRendererCube=new xl(e)}return this._quadRendererCube}execute(){const e=this.device;e.setBlendState(Rn.NOBLEND),e.setCullMode(0),e.setDepthState(On.NODEPTH),e.setStencilState();const t=this.renderTarget.colorBuffer.width,s=this._cubeSlotsOffsets,i=this._filteredLights;for(let e=0;e<i.length;e++){const n=i[e],r=n.numShadowFaces,a=r>1?this.quadRendererCube:this.quadRenderer2D;r>1&&this.initInvViewProjMatrices(),this.blitTextureId.setValue(n.cookie);for(let e=0;e<r;e++){if(Pc.copy(n.atlasViewport),r>1){const t=Pc.z/3,i=s[e];Pc.x+=t*i.x,Pc.y+=t*i.y,Pc.z=t,Pc.w=t,this.invViewProjId.setValue(kc[e].data)}Pc.mulScalar(t),a.render(Pc)}}i.length=0}}class Mc extends uo{constructor(e,t,s){super(e),this.requiresCubemaps=!1,this.shadowRenderer=t,this.shadowRendererLocal=s}update(e){const t=this.shadowRendererLocal.shadowLights,s=this.shadowRendererLocal.prepareLights(t,e),i=t.length;this.enabled=i>0,i&&this.shadowRenderer.setupRenderPass(this,s,!1)}execute(){const e=this.shadowRendererLocal.shadowLights,t=e.length;for(let s=0;s<t;s++){const t=e[s];for(let e=0;e<t.numShadowFaces;e++)this.shadowRenderer.renderFace(t,null,e,!0)}e.length=0}}class Dc extends uo{constructor(e,t,s,i,n){super(e),this.renderer=t,this.frameGraph=null,this.cookiesRenderPass=Ac.create(n.cookieRenderTarget,n.cubeSlotsOffsets),this.beforePasses.push(this.cookiesRenderPass),this.shadowRenderPass=new Mc(e,s,i),this.beforePasses.push(this.shadowRenderPass)}update(e,t,s,i,n){this.frameGraph=e,this.cookiesRenderPass.enabled=s,s&&this.cookiesRenderPass.update(i),this.shadowRenderPass.enabled=t,t&&this.shadowRenderPass.update(n)}destroy(){this.cookiesRenderPass.destroy(),this.cookiesRenderPass=null}execute(){const{renderer:e}=this,{scene:t}=e;e.worldClustersAllocator.update(this.frameGraph.renderPasses,t.lighting)}}let Rc=0;const Lc=new As,Ic=new As,Fc=new As,Oc=new xs,Bc=new Us,zc=(new As).setScale(1,-1,1),Nc=new Set,Uc=new Set,Vc=new En,Gc=(new As).set([1,0,0,0,0,1,0,0,0,0,.5,0,0,0,.5,1]),Hc=[new ws(.5,.333333),new ws(.25,.666667),new ws(.75,.111111),new ws(.125,.444444),new ws(.625,.777778),new ws(.375,.222222),new ws(.875,.555556),new ws(.0625,.888889),new ws(.5625,.037037),new ws(.3125,.37037),new ws(.8125,.703704),new ws(.1875,.148148),new ws(.6875,.481481),new ws(.4375,.814815),new ws(.9375,.259259),new ws(.03125,.592593)],jc=new As,Wc=new As,$c=new As,qc=new As,Xc=new As,Kc=new As,Yc=new Set,Qc=[],Jc=[];class Zc{constructor(e){this.clustersDebugRendered=!1,this.processingMeshInstances=new Set,this.worldClustersAllocator=void 0,this.lights=[],this.localLights=[],this.cameraDirShadowLights=new Map,this.dirLightShadows=new Map,this.blueNoise=new Vh(123),this.device=e,this.scene=null,this.worldClustersAllocator=new Tc(e),this.lightTextureAtlas=new Jh(e),this.shadowMapCache=new sc,this.shadowRenderer=new Sc(this,this.lightTextureAtlas),this._shadowRendererLocal=new nc(this,this.shadowRenderer),this._shadowRendererDirectional=new uc(this,this.shadowRenderer),this._renderPassUpdateClustered=new Dc(this.device,this,this.shadowRenderer,this._shadowRendererLocal,this.lightTextureAtlas),this.viewUniformFormat=null,this.viewBindGroupFormat=null,this._skinTime=0,this._morphTime=0,this._cullTime=0,this._shadowMapTime=0,this._lightClustersTime=0,this._layerCompositionUpdateTime=0,this._shadowDrawCalls=0,this._skinDrawCalls=0,this._instancedDrawCalls=0,this._shadowMapUpdates=0,this._numDrawCallsCulled=0,this._camerasRendered=0,this._lightClusters=0;const t=e.scope;this.boneTextureId=t.resolve("texture_poseMap"),this.boneTextureSizeId=t.resolve("texture_poseMapSize"),this.modelMatrixId=t.resolve("matrix_model"),this.normalMatrixId=t.resolve("matrix_normal"),this.viewInvId=t.resolve("matrix_viewInverse"),this.viewPos=new Float32Array(3),this.viewPosId=t.resolve("view_position"),this.projId=t.resolve("matrix_projection"),this.projSkyboxId=t.resolve("matrix_projectionSkybox"),this.viewId=t.resolve("matrix_view"),this.viewId3=t.resolve("matrix_view3"),this.viewProjId=t.resolve("matrix_viewProjection"),this.flipYId=t.resolve("projectionFlipY"),this.tbnBasis=t.resolve("tbnBasis"),this.nearClipId=t.resolve("camera_near"),this.farClipId=t.resolve("camera_far"),this.cameraParams=new Float32Array(4),this.cameraParamsId=t.resolve("camera_params"),this.viewIndexId=t.resolve("view_index"),this.blueNoiseJitterVersion=0,this.blueNoiseJitterVec=new Ss,this.blueNoiseJitterData=new Float32Array(4),this.blueNoiseJitterId=t.resolve("blueNoiseJitter"),this.blueNoiseTextureId=t.resolve("blueNoiseTex32"),this.alphaTestId=t.resolve("alpha_ref"),this.opacityMapId=t.resolve("texture_opacityMap"),this.exposureId=t.resolve("exposure"),this.twoSidedLightingNegScaleFactorId=t.resolve("twoSidedLightingNegScaleFactor"),this.twoSidedLightingNegScaleFactorId.setValue(0),this.morphPositionTex=t.resolve("morphPositionTex"),this.morphNormalTex=t.resolve("morphNormalTex"),this.morphTexParams=t.resolve("morph_tex_params"),this.lightCube=new Hh,this.constantLightCube=t.resolve("lightCube[0]")}destroy(){this.shadowRenderer=null,this._shadowRendererLocal=null,this._shadowRendererDirectional=null,this.shadowMapCache.destroy(),this.shadowMapCache=null,this._renderPassUpdateClustered.destroy(),this._renderPassUpdateClustered=null,this.lightTextureAtlas.destroy(),this.lightTextureAtlas=null}sortCompare(e,t){if(e.layer===t.layer){if(e.drawOrder&&t.drawOrder)return e.drawOrder-t.drawOrder;if(e.zdist&&t.zdist)return t.zdist-e.zdist;if(e.zdist2&&t.zdist2)return e.zdist2-t.zdist2}return t._key[0]-e._key[0]}sortCompareMesh(e,t){if(e.layer===t.layer){if(e.drawOrder&&t.drawOrder)return e.drawOrder-t.drawOrder;if(e.zdist&&t.zdist)return t.zdist-e.zdist}const s=e._key[0],i=t._key[0];return s===i&&e.mesh&&t.mesh?t.mesh.id-e.mesh.id:i-s}sortCompareDepth(e,t){const s=e._key[1],i=t._key[1];return s===i&&e.mesh&&t.mesh?t.mesh.id-e.mesh.id:i-s}setupViewport(e,t){const s=this.device,i=t?t.width:s.width,n=t?t.height:s.height,r=e.rect;let a=Math.floor(r.x*i),o=Math.floor(r.y*n),l=Math.floor(r.z*i),h=Math.floor(r.w*n);if(s.setViewport(a,o,l,h),e._scissorRectClear){const t=e.scissorRect;a=Math.floor(t.x*i),o=Math.floor(t.y*n),l=Math.floor(t.z*i),h=Math.floor(t.w*n)}s.setScissor(a,o,l,h)}setCameraUniforms(e,t){const s=null==t?void 0:t.flipY;let i=1;if(e.xr&&e.xr.session){var n;const t=(null==(n=e._node)||null==(n=n.parent)?void 0:n.getWorldTransform())||null,s=e.xr.views;i=s.list.length;for(let n=0;n<i;n++){const i=s.list[n];i.updateTransforms(t),e.frustum.setFromMat4(i.projViewOffMat)}}else{let i=e.projectionMatrix;e.calculateProjection&&e.calculateProjection(i,0);let n=e.getProjectionMatrixSkybox();s&&(i=jc.mul2(zc,i),n=Wc.mul2(zc,n)),this.device.isWebGPU&&(i=$c.mul2(Gc,i),n=qc.mul2(Gc,n));const{jitter:r}=e;let a=0,o=0;if(r>0){const e=t?t.width:this.device.width,s=t?t.height:this.device.height,l=Hc[this.device.renderVersion%Hc.length];a=r*(2*l.x-1)/e,o=r*(2*l.y-1)/s,i=Xc.copy(i),i.data[8]=a,i.data[9]=o,n=Kc.copy(n),n.data[8]=a,n.data[9]=o,this.blueNoiseJitterVersion!==this.device.renderVersion&&(this.blueNoiseJitterVersion=this.device.renderVersion,this.blueNoise.vec4(this.blueNoiseJitterVec))}const l=r>0?this.blueNoiseJitterVec:Ss.ZERO;if(this.blueNoiseJitterData[0]=l.x,this.blueNoiseJitterData[1]=l.y,this.blueNoiseJitterData[2]=l.z,this.blueNoiseJitterData[3]=l.w,this.blueNoiseJitterId.setValue(this.blueNoiseJitterData),this.projId.setValue(i.data),this.projSkyboxId.setValue(n.data),e.calculateTransform)e.calculateTransform(Ic,0);else{const t=e._node.getPosition(),s=e._node.getRotation();Ic.setTRS(t,s,ys.ONE)}this.viewInvId.setValue(Ic.data),Fc.copy(Ic).invert(),this.viewId.setValue(Fc.data),Oc.setFromMat4(Fc),this.viewId3.setValue(Oc.data),Lc.mul2(i,Fc),this.viewProjId.setValue(Lc.data),e._storeShaderMatrices(Lc,a,o,this.device.renderVersion),this.flipYId.setValue(s?-1:1),this.dispatchViewPos(e._node.getPosition()),e.frustum.setFromMat4(Lc)}this.tbnBasis.setValue(s?-1:1);const r=e._nearClip,a=e._farClip;return this.nearClipId.setValue(r),this.farClipId.setValue(a),this.cameraParams[0]=1/a,this.cameraParams[1]=a,this.cameraParams[2]=r,this.cameraParams[3]=1===e.projection?1:0,this.cameraParamsId.setValue(this.cameraParams),this.exposureId.setValue(this.scene.physicalUnits?e.getExposure():this.scene.exposure),i}clear(e,t,s,i){const n=((null!=t?t:e._clearColorBuffer)?1:0)|((null!=s?s:e._clearDepthBuffer)?2:0)|((null!=i?i:e._clearStencilBuffer)?4:0);if(n){this.device.clear({color:[e._clearColor.r,e._clearColor.g,e._clearColor.b,e._clearColor.a],depth:e._clearDepth,stencil:e._clearStencil,flags:n})}}setCamera(e,t,s,i=null){this.setCameraUniforms(e,t),this.clearView(e,t,s,!1)}clearView(e,t,s,i){const n=this.device;if(n.setRenderTarget(t),n.updateBegin(),i&&(n.setColorWrite(!0,!0,!0,!0),n.setDepthWrite(!0)),this.setupViewport(e,t),s){const t=e._clearOptions;n.clear(t||{color:[e._clearColor.r,e._clearColor.g,e._clearColor.b,e._clearColor.a],depth:e._clearDepth,flags:(e._clearColorBuffer?1:0)|(e._clearDepthBuffer?2:0)|(e._clearStencilBuffer?4:0),stencil:e._clearStencil})}}setupCullMode(e,t,s){const i=s.material;let n=0;if(e){let e=1;2!==i.cull&&1!==i.cull||(e=t*s.flipFacesFactor*s.node.worldScaleSign),n=e<0?2===i.cull?1:2:i.cull}this.device.setCullMode(n),0===n&&0===i.cull&&this.twoSidedLightingNegScaleFactorId.setValue(s.node.worldScaleSign)}updateCameraFrustum(e){if(e.xr&&e.xr.views.list.length){const t=e.xr.views.list[0];return Lc.mul2(t.projMat,t.viewOffMat),void e.frustum.setFromMat4(Lc)}const t=e.projectionMatrix;if(e.calculateProjection&&e.calculateProjection(t,0),e.calculateTransform)e.calculateTransform(Ic,0);else{const t=e._node.getPosition(),s=e._node.getRotation();Ic.setTRS(t,s,ys.ONE),this.viewInvId.setValue(Ic.data)}Fc.copy(Ic).invert(),Lc.mul2(t,Fc),e.frustum.setFromMat4(Lc)}setBaseConstants(e,t){e.setCullMode(t.cull),t.opacityMap&&this.opacityMapId.setValue(t.opacityMap),(t.opacityMap||t.alphaTest>0)&&this.alphaTestId.setValue(t.alphaTest)}updateCpuSkinMatrices(e){Rc++;const t=e.length;if(0!==t)for(let s=0;s<t;s++){const t=e[s].skinInstance;t&&(t.updateMatrices(e[s].node,Rc),t._dirty=!0)}}updateGpuSkinMatrices(e){for(const t of e){const e=t.skinInstance;e&&e._dirty&&(e.updateMatrixPalette(t.node,Rc),e._dirty=!1)}}updateMorphing(e){for(const t of e){const e=t.morphInstance;e&&e._dirty&&e.update()}}updateGSplats(e){for(const s of e){var t;null==(t=s.gsplatInstance)||t.update()}}gpuUpdate(e){this.updateGpuSkinMatrices(e),this.updateMorphing(e),this.updateGSplats(e)}setVertexBuffers(e,t){e.setVertexBuffer(t.vertexBuffer)}setMorphing(e,t){t&&(t.prepareRendering(e),e.setVertexBuffer(t.morph.vertexBufferIds),this.morphPositionTex.setValue(t.texturePositions),this.morphNormalTex.setValue(t.textureNormals),this.morphTexParams.setValue(t._textureParams))}setSkinning(e,t){const s=t.skinInstance;if(s){this._skinDrawCalls++;const e=s.boneTexture;this.boneTextureId.setValue(e),this.boneTextureSizeId.setValue(s.boneTextureSize)}}dispatchViewPos(e){const t=this.viewPos;t[0]=e.x,t[1]=e.y,t[2]=e.z,this.viewPosId.setValue(t)}initViewBindGroupFormat(e){if(this.device.supportsUniformBuffers&&!this.viewUniformFormat){const t=[new Or("matrix_viewProjection",Vi),new Or("cubeMapRotationMatrix",13),new Or("view_position",4),new Or("skyboxIntensity",2),new Or("exposure",2),new Or("textureBias",2)];e&&t.push(new Or("clusterCellsCountByBoundsSize",4),new Or("clusterTextureSize",4),new Or("clusterBoundsMin",4),new Or("clusterBoundsDelta",4),new Or("clusterCellsDot",4),new Or("clusterCellsMax",4),new Or("clusterCompressionLimit0",3),new Or("shadowAtlasParams",3),new Or("clusterMaxCells",1),new Or("clusterSkip",2)),this.viewUniformFormat=new Br(this.device,t);const s=[new un(tn,3),new fn("lightsTextureFloat",2,Ii,1),new fn("lightsTexture8",2,Ii,1),new fn("shadowAtlasTexture",2,Ii,2),new fn("cookieAtlasTexture",2,Ii,0),new fn("areaLightsLutTex1",2,Ii,0),new fn("areaLightsLutTex2",2,Ii,0)];e&&s.push(new fn("clusterWorldTexture",2,Ii,1)),this.viewBindGroupFormat=new gn(this.device,s)}}setupViewUniformBuffers(e,t,s,i){const n=this.device;for(;e.length<i;){const i=new Ca(n,t,!1),r=new Pn(n,s,i);e.push(r)}const r=e[0];r.defaultUniformBuffer.update(),r.update(),n.setBindGroup(0,r)}setupMeshUniformBuffers(e,t){const s=this.device;if(s.supportsUniformBuffers){this.modelMatrixId.setValue(t.node.worldTransform.data),this.normalMatrixId.setValue(t.node.normalMatrix.data);const i=e.getBindGroup(s);i.update(),s.setBindGroup(1,i);e.getUniformBuffer(s).update(Vc),s.setBindGroup(2,Vc.bindGroup,Vc.offsets)}}drawInstance(e,t,s,i,n){const r=t.node.worldTransform;this.modelMatrixId.setValue(r.data),n&&this.normalMatrixId.setValue(t.node.normalMatrix.data);const a=t.instancingData;a?a.count>0?(this._instancedDrawCalls++,e.setVertexBuffer(a.vertexBuffer),e.draw(s.primitive[i],a.count)):e.clearVertexBuffer():e.draw(s.primitive[i])}drawInstance2(e,t,s,i){const n=t.instancingData;n?n.count>0?(this._instancedDrawCalls++,e.draw(s.primitive[i],n.count,!0)):e.clearVertexBuffer():e.draw(s.primitive[i],void 0,!0)}cull(e,t,s){const i=s.opaque;i.length=0;const n=s.transparent;n.length=0;const r=e.frustumCulling,a=t.length;for(let s=0;s<a;s++){const a=t[s];if(a.visible){if(!r||!a.cull||a._isVisible(e)){a.visibleThisFrame=!0;(a.transparent?n:i).push(a),(a.skinInstance||a.morphInstance||a.gsplatInstance)&&(this.processingMeshInstances.add(a),a.gsplatInstance&&a.gsplatInstance.cameras.push(e))}}}}collectLights(e){this.lights.length=0,this.localLights.length=0;const t=this.scene._stats,s=e.layerList.length;for(let t=0;t<s;t++){const s=e.layerList[t];if(!Uc.has(s)){Uc.add(s);const e=s._lights;for(let t=0;t<e.length;t++){const s=e[t];Nc.has(s)||(Nc.add(s),this.lights.push(s),0!==s._type&&this.localLights.push(s))}}}t.lights=this.lights.length,Nc.clear(),Uc.clear()}cullLights(e,t){const s=this.scene.clusteredLightingEnabled,i=this.scene.physicalUnits;for(let n=0;n<t.length;n++){const r=t[n];if(r.enabled)if(0!==r._type)if(r.getBoundingSphere(Bc),e.frustum.containsSphere(Bc)){r.visibleThisFrame=!0,r.usePhysicalUnits=i;const t=e.getScreenSize(Bc);r.maxScreenSize=Math.max(r.maxScreenSize,t)}else s||r.castShadows&&!r.shadowMap&&(r.visibleThisFrame=!0);else r.usePhysicalUnits=this.scene.physicalUnits}}cullShadowmaps(e){const t=this.scene.clusteredLightingEnabled;for(let s=0;s<this.localLights.length;s++){const i=this.localLights[s];0!==i._type&&(t?i.atlasSlotUpdated&&0===i.shadowUpdateMode&&(i.shadowUpdateMode=1):0===i.shadowUpdateMode&&i.castShadows&&(i.getRenderData(null,0).shadowCamera.renderTarget||(i.shadowUpdateMode=1)),i.visibleThisFrame&&i.castShadows&&0!==i.shadowUpdateMode&&this._shadowRendererLocal.cull(i,e))}this.cameraDirShadowLights.clear();const s=e.cameras;for(let t=0;t<s.length;t++){const n=s[t];if(n.enabled){const t=n.camera;let s;const r=t.layers;for(let n=0;n<r.length;n++){const a=e.getLayerById(r[n]);if(a){const n=a.splitLights[0];for(let r=0;r<n.length;r++){const a=n[r];var i;if(a.castShadows&&!Yc.has(a))Yc.add(a),s=null!=(i=s)?i:[],s.push(a),this._shadowRendererDirectional.cull(a,e,t)}}}s&&this.cameraDirShadowLights.set(t,s),Yc.clear()}}}cullComposition(e){const{scene:t}=this;this.processingMeshInstances.clear();const s=e.cameras.length;this._camerasRendered+=s;for(let i=0;i<s;i++){const s=e.cameras[i];null==t||t.fire("precull",s);const n=s.renderTarget;s.frameUpdate(n),this.updateCameraFrustum(s.camera);const r=s.layers;for(let t=0;t<r.length;t++){const i=e.getLayerById(r[t]);if(i&&i.enabled){this.cullLights(s.camera,i._lights);const e=i.getCulledInstances(s.camera);this.cull(s.camera,i.meshInstances,e)}}null==t||t.fire("postcull",s)}t.clusteredLightingEnabled&&this.updateLightTextureAtlas(),this.cullShadowmaps(e)}updateShaders(e,t){const s=e.length;for(let i=0;i<s;i++){const s=e[i].material;if(s&&!Yc.has(s)&&(Yc.add(s),s.getShaderVariant!==tc.prototype.getShaderVariant)){if(t&&(!s.useLighting||s.emitter&&!s.emitter.lighting))continue;s.clearVariants()}}Yc.clear()}updateFrameUniforms(){this.blueNoiseTextureId.setValue(Wh(this.device))}beginFrame(e){const t=this.scene,s=t.updateShaders,i=e.layerList,n=i.length;for(let e=0;e<n;e++){const t=i[e].meshInstances,n=t.length;for(let e=0;e<n;e++){const i=t[e];i.visibleThisFrame=!1,s&&Qc.push(i),i.skinInstance&&Jc.push(i)}}if(s){const e=!t.updateShaders;this.updateShaders(Qc,e),t.updateShaders=!1,t._shaderVersion++}this.updateFrameUniforms(),this.updateCpuSkinMatrices(Jc),Qc.length=0,Jc.length=0;const r=this.lights,a=r.length;for(let e=0;e<a;e++)r[e].beginFrame()}updateLightTextureAtlas(){this.lightTextureAtlas.update(this.localLights,this.scene.lighting)}updateLayerComposition(e){const t=e.layerList.length,s=this.scene._shaderVersion;for(let i=0;i<t;i++){e.layerList[i]._shaderVersion=s}e._update()}frameUpdate(){this.clustersDebugRendered=!1,this.initViewBindGroupFormat(this.scene.clusteredLightingEnabled),this.dirLightShadows.clear()}}class ed{constructor(){this.layer=null,this.transparent=!1,this.camera=null,this.renderTarget=null,this.lightClusters=null,this.clearColor=!1,this.clearDepth=!1,this.clearStencil=!1,this.triggerPostprocess=!1,this.firstCameraUse=!1,this.lastCameraUse=!1,this.viewBindGroups=[],this.useCameraPasses=!1}destroy(){this.viewBindGroups.forEach((e=>{e.defaultUniformBuffer.destroy(),e.destroy()})),this.viewBindGroups.length=0}setupClears(e,t){this.clearColor=(null==e?void 0:e.clearColorBuffer)||t.clearColorBuffer,this.clearDepth=(null==e?void 0:e.clearDepthBuffer)||t.clearDepthBuffer,this.clearStencil=(null==e?void 0:e.clearStencilBuffer)||t.clearStencilBuffer}}class td extends uo{constructor(e,t,s,i){super(e),this.layerComposition=void 0,this.scene=void 0,this.renderer=void 0,this.renderActions=[],this.noDepthClear=!1,this.layerComposition=t,this.scene=s,this.renderer=i}get rendersAnything(){return this.renderActions.length>0}addRenderAction(e){this.renderActions.push(e)}addLayer(e,t,s,i=!0){const n=new ed;if(n.renderTarget=this.renderTarget,n.camera=e,n.layer=t,n.transparent=s,i){const s=0===this.renderActions.length;n.setupClears(s?e:void 0,t)}this.addRenderAction(n)}addLayers(e,t,s,i,n,r=!0){const{layerList:a,subLayerList:o}=e;let l=i,h=s;for(;h<a.length;){const e=a[h],s=o[h];if(t.camera.layersSet.has(e.id)&&(this.addLayer(t,e,s,l),l=!1),h++,e.id===n&&s===r)break}return h}updateDirectionalShadows(){const{renderer:e,renderActions:t}=this;for(let s=0;s<t.length;s++){const i=t[s].camera.camera,n=this.renderer.cameraDirShadowLights.get(i);if(n)for(let t=0;t<n.length;t++){const s=n[t];if(e.dirLightShadows.get(s)!==i){e.dirLightShadows.set(s,i);const t=e._shadowRendererDirectional.getLightRenderPass(s,i);t&&this.beforePasses.push(t)}}}}updateClears(){const e=this.renderActions[0];if(e){const t=e.camera.camera,s=t.fullSizeClearRect;this.setClearColor(s&&e.clearColor?t.clearColor:void 0),this.setClearDepth(s&&e.clearDepth&&!this.noDepthClear?t.clearDepth:void 0),this.setClearStencil(s&&e.clearStencil?t.clearStencil:void 0)}}frameUpdate(){super.frameUpdate(),this.updateDirectionalShadows(),this.updateClears()}before(){const{renderActions:e}=this;for(let t=0;t<e.length;t++){const s=e[t];s.firstCameraUse&&this.scene.fire(rl,s.camera)}}execute(){const{layerComposition:e,renderActions:t}=this;for(let s=0;s<t.length;s++){const i=t[s],n=i.layer;e.isEnabled(n,i.transparent)&&this.renderRenderAction(i,0===s)}}after(){for(let e=0;e<this.renderActions.length;e++){const t=this.renderActions[e];t.lastCameraUse&&this.scene.fire(al,t.camera)}this.beforePasses.length=0}renderRenderAction(e,t){const{renderer:s,scene:i}=this,n=s.device,{layer:r,transparent:a,camera:o}=e;if(o){var l,h,c;i.fire("prerender:layer",o,r,a);const d={lightClusters:e.lightClusters},u=null!=(l=null==(h=o.camera.shaderPassInfo)?void 0:h.index)?l:0;t&&o.camera.fullSizeClearRect||(d.clearColor=e.clearColor,d.clearDepth=e.clearDepth,d.clearStencil=e.clearStencil);const p=null!=(c=e.renderTarget)?c:n.backBuffer;s.renderForwardLayer(o.camera,p,r,a,u,e.viewBindGroups,d),n.setBlendState(Rn.NOBLEND),n.setStencilState(null,null),n.setAlphaToCoverage(!1),i.fire("postrender:layer",o,r,a)}}}class sd extends uo{constructor(e,t,s){super(e),this.renderer=t,this.renderAction=s,this.requiresCubemaps=!1}execute(){this.renderAction.camera.onPostprocessing()}}const id=[[],[],[]],nd=new os,rd={drawCalls:[],shaderInstances:[],isNewMaterial:[],lightMaskChanged:[],clear:function(){this.drawCalls.length=0,this.shaderInstances.length=0,this.isNewMaterial.length=0,this.lightMaskChanged.length=0}};class ad extends Zc{constructor(e){super(e);const t=this.device;this._forwardDrawCalls=0,this._materialSwitches=0,this._depthMapTime=0,this._forwardTime=0,this._sortTime=0;const s=t.scope;this.fogColorId=s.resolve("fog_color"),this.fogStartId=s.resolve("fog_start"),this.fogEndId=s.resolve("fog_end"),this.fogDensityId=s.resolve("fog_density"),this.ambientId=s.resolve("light_globalAmbient"),this.skyboxIntensityId=s.resolve("skyboxIntensity"),this.cubeMapRotationMatrixId=s.resolve("cubeMapRotationMatrix"),this.pcssDiskSamplesId=s.resolve("pcssDiskSamples[0]"),this.pcssSphereSamplesId=s.resolve("pcssSphereSamples[0]"),this.lightColorId=[],this.lightDir=[],this.lightDirId=[],this.lightShadowMapId=[],this.lightShadowMatrixId=[],this.lightShadowParamsId=[],this.lightShadowIntensity=[],this.lightRadiusId=[],this.lightPos=[],this.lightPosId=[],this.lightWidth=[],this.lightWidthId=[],this.lightHeight=[],this.lightHeightId=[],this.lightInAngleId=[],this.lightOutAngleId=[],this.lightCookieId=[],this.lightCookieIntId=[],this.lightCookieMatrixId=[],this.lightCookieOffsetId=[],this.lightShadowSearchAreaId=[],this.lightCameraParamsId=[],this.shadowMatrixPaletteId=[],this.shadowCascadeDistancesId=[],this.shadowCascadeCountId=[],this.screenSizeId=s.resolve("uScreenSize"),this._screenSize=new Float32Array(4),this.fogColor=new Float32Array(3),this.ambientColor=new Float32Array(3),this.pcssDiskSamples=function(e){const t=[];for(let s=0;s<e;++s){const i=Math.sqrt(s+.5)/Math.sqrt(e);t.push(i)}return t}(16),this.pcssSphereSamples=function(e){const t=[];for(let s=0;s<e;s++){const i=s/e,n=Math.sqrt(1-i*i);t.push(n)}return t}(16)}destroy(){super.destroy()}dispatchGlobalLights(e){const t=this.ambientColor;if(nd.linear(e.ambientLight),t[0]=nd.r,t[1]=nd.g,t[2]=nd.b,e.physicalUnits)for(let s=0;s<3;s++)t[s]*=e.ambientLuminance;this.ambientId.setValue(t),this.skyboxIntensityId.setValue(e.physicalUnits?e.skyboxLuminance:e.skyboxIntensity),this.cubeMapRotationMatrixId.setValue(e._skyboxRotationMat3.data)}_resolveLight(e,t){const s=`light${t}`;this.lightColorId[t]=e.resolve(`${s}_color`),this.lightDir[t]=new Float32Array(3),this.lightDirId[t]=e.resolve(`${s}_direction`),this.lightShadowMapId[t]=e.resolve(`${s}_shadowMap`),this.lightShadowMatrixId[t]=e.resolve(`${s}_shadowMatrix`),this.lightShadowParamsId[t]=e.resolve(`${s}_shadowParams`),this.lightShadowIntensity[t]=e.resolve(`${s}_shadowIntensity`),this.lightShadowSearchAreaId[t]=e.resolve(`${s}_shadowSearchArea`),this.lightRadiusId[t]=e.resolve(`${s}_radius`),this.lightPos[t]=new Float32Array(3),this.lightPosId[t]=e.resolve(`${s}_position`),this.lightWidth[t]=new Float32Array(3),this.lightWidthId[t]=e.resolve(`${s}_halfWidth`),this.lightHeight[t]=new Float32Array(3),this.lightHeightId[t]=e.resolve(`${s}_halfHeight`),this.lightInAngleId[t]=e.resolve(`${s}_innerConeAngle`),this.lightOutAngleId[t]=e.resolve(`${s}_outerConeAngle`),this.lightCookieId[t]=e.resolve(`${s}_cookie`),this.lightCookieIntId[t]=e.resolve(`${s}_cookieIntensity`),this.lightCookieMatrixId[t]=e.resolve(`${s}_cookieMatrix`),this.lightCookieOffsetId[t]=e.resolve(`${s}_cookieOffset`),this.lightCameraParamsId[t]=e.resolve(`${s}_cameraParams`),this.shadowMatrixPaletteId[t]=e.resolve(`${s}_shadowMatrixPalette[0]`),this.shadowCascadeDistancesId[t]=e.resolve(`${s}_shadowCascadeDistances[0]`),this.shadowCascadeCountId[t]=e.resolve(`${s}_shadowCascadeCount`)}setLTCDirectionalLight(e,t,s,i,n){this.lightPos[t][0]=i.x-s.x*n,this.lightPos[t][1]=i.y-s.y*n,this.lightPos[t][2]=i.z-s.z*n,this.lightPosId[t].setValue(this.lightPos[t]);const r=e.transformVector(new ys(-.5,0,0));this.lightWidth[t][0]=r.x*n,this.lightWidth[t][1]=r.y*n,this.lightWidth[t][2]=r.z*n,this.lightWidthId[t].setValue(this.lightWidth[t]);const a=e.transformVector(new ys(0,0,.5));this.lightHeight[t][0]=a.x*n,this.lightHeight[t][1]=a.y*n,this.lightHeight[t][2]=a.z*n,this.lightHeightId[t].setValue(this.lightHeight[t])}dispatchDirectLights(e,t,s){let i=0;const n=this.device.scope;for(let r=0;r<e.length;r++){if(!(e[r].mask&t))continue;const a=e[r],o=a._node.getWorldTransform();if(this.lightColorId[i]||this._resolveLight(n,i),this.lightColorId[i].setValue(a._colorLinear),o.getY(a._direction).mulScalar(-1),a._direction.normalize(),this.lightDir[i][0]=a._direction.x,this.lightDir[i][1]=a._direction.y,this.lightDir[i][2]=a._direction.z,this.lightDirId[i].setValue(this.lightDir[i]),0!==a.shape&&this.setLTCDirectionalLight(o,i,a._direction,s._node.getPosition(),s.farClip),a.castShadows){const e=a.getRenderData(s,0),t=a._getUniformBiasValues(e);this.lightShadowMapId[i].setValue(e.shadowBuffer),this.lightShadowMatrixId[i].setValue(e.shadowMatrix.data),this.shadowMatrixPaletteId[i].setValue(a._shadowMatrixPalette),this.shadowCascadeDistancesId[i].setValue(a._shadowCascadeDistances),this.shadowCascadeCountId[i].setValue(a.numCascades),this.lightShadowIntensity[i].setValue(a.shadowIntensity);const n=50/e.projectionCompensation,r=e.shadowCamera.renderTarget;if(r){const e=a.penumbraSize/r.width;this.lightShadowSearchAreaId[i].setValue(e*n)}const o=a._shadowCameraParams;o.length=4,o[0]=e.depthRangeCompensation,o[1]=e.shadowCamera._farClip,o[2]=e.shadowCamera._nearClip,o[3]=1,this.lightCameraParamsId[i].setValue(o);const l=a._shadowRenderParams;l.length=4,l[0]=a._shadowResolution,l[1]=t.normalBias,l[2]=t.bias,l[3]=0,this.lightShadowParamsId[i].setValue(l)}i++}return i}setLTCPositionalLight(e,t){const s=e.transformVector(new ys(-.5,0,0));this.lightWidth[t][0]=s.x,this.lightWidth[t][1]=s.y,this.lightWidth[t][2]=s.z,this.lightWidthId[t].setValue(this.lightWidth[t]);const i=e.transformVector(new ys(0,0,.5));this.lightHeight[t][0]=i.x,this.lightHeight[t][1]=i.y,this.lightHeight[t][2]=i.z,this.lightHeightId[t].setValue(this.lightHeight[t])}dispatchOmniLight(e,t,s){const i=t._node.getWorldTransform();if(this.lightColorId[s]||this._resolveLight(e,s),this.lightRadiusId[s].setValue(t.attenuationEnd),this.lightColorId[s].setValue(t._colorLinear),i.getTranslation(t._position),this.lightPos[s][0]=t._position.x,this.lightPos[s][1]=t._position.y,this.lightPos[s][2]=t._position.z,this.lightPosId[s].setValue(this.lightPos[s]),0!==t.shape&&this.setLTCPositionalLight(i,s),t.castShadows){const e=t.getRenderData(null,0);this.lightShadowMapId[s].setValue(e.shadowBuffer);const i=t._getUniformBiasValues(e),n=t._shadowRenderParams;n.length=4,n[0]=t._shadowResolution,n[1]=i.normalBias,n[2]=i.bias,n[3]=1/t.attenuationEnd,this.lightShadowParamsId[s].setValue(n),this.lightShadowIntensity[s].setValue(t.shadowIntensity);const r=t.penumbraSize/e.shadowCamera.renderTarget.width;this.lightShadowSearchAreaId[s].setValue(r);const a=t._shadowCameraParams;a.length=4,a[0]=e.depthRangeCompensation,a[1]=e.shadowCamera._farClip,a[2]=e.shadowCamera._nearClip,a[3]=0,this.lightCameraParamsId[s].setValue(a)}t._cookie&&(this.lightCookieId[s].setValue(t._cookie),this.lightShadowMatrixId[s].setValue(i.data),this.lightCookieIntId[s].setValue(t.cookieIntensity))}dispatchSpotLight(e,t,s){const i=t._node.getWorldTransform();if(this.lightColorId[s]||this._resolveLight(e,s),this.lightInAngleId[s].setValue(t._innerConeAngleCos),this.lightOutAngleId[s].setValue(t._outerConeAngleCos),this.lightRadiusId[s].setValue(t.attenuationEnd),this.lightColorId[s].setValue(t._colorLinear),i.getTranslation(t._position),this.lightPos[s][0]=t._position.x,this.lightPos[s][1]=t._position.y,this.lightPos[s][2]=t._position.z,this.lightPosId[s].setValue(this.lightPos[s]),0!==t.shape&&this.setLTCPositionalLight(i,s),i.getY(t._direction).mulScalar(-1),t._direction.normalize(),this.lightDir[s][0]=t._direction.x,this.lightDir[s][1]=t._direction.y,this.lightDir[s][2]=t._direction.z,this.lightDirId[s].setValue(this.lightDir[s]),t.castShadows){const e=t.getRenderData(null,0);this.lightShadowMapId[s].setValue(e.shadowBuffer),this.lightShadowMatrixId[s].setValue(e.shadowMatrix.data);const i=t._getUniformBiasValues(e),n=t._shadowRenderParams;n.length=4,n[0]=t._shadowResolution,n[1]=i.normalBias,n[2]=i.bias,n[3]=1/t.attenuationEnd,this.lightShadowParamsId[s].setValue(n),this.lightShadowIntensity[s].setValue(t.shadowIntensity);const r=t.penumbraSize/e.shadowCamera.renderTarget.width,a=e.shadowCamera._fov*Math.PI/180,o=1/Math.tan(a/2);this.lightShadowSearchAreaId[s].setValue(r*o);const l=t._shadowCameraParams;l.length=4,l[0]=e.depthRangeCompensation,l[1]=e.shadowCamera._farClip,l[2]=e.shadowCamera._nearClip,l[3]=0,this.lightCameraParamsId[s].setValue(l)}if(t._cookie){if(!t.castShadows){const e=wh.evalSpotCookieMatrix(t);this.lightShadowMatrixId[s].setValue(e.data)}this.lightCookieId[s].setValue(t._cookie),this.lightCookieIntId[s].setValue(t.cookieIntensity),t._cookieTransform&&(t._cookieTransformUniform[0]=t._cookieTransform.x,t._cookieTransformUniform[1]=t._cookieTransform.y,t._cookieTransformUniform[2]=t._cookieTransform.z,t._cookieTransformUniform[3]=t._cookieTransform.w,this.lightCookieMatrixId[s].setValue(t._cookieTransformUniform),t._cookieOffsetUniform[0]=t._cookieOffset.x,t._cookieOffsetUniform[1]=t._cookieOffset.y,this.lightCookieOffsetId[s].setValue(t._cookieOffsetUniform))}}dispatchLocalLights(e,t,s){let i=s;const n=this.device.scope,r=e[1],a=r.length;for(let e=0;e<a;e++){const s=r[e];s.mask&t&&(this.dispatchOmniLight(n,s,i),i++)}const o=e[2],l=o.length;for(let e=0;e<l;e++){const s=o[e];s.mask&t&&(this.dispatchSpotLight(n,s,i),i++)}}renderForwardPrepareMaterials(e,t,s,i,n,r){var a,o,l;const h=null!=(a=e.fog)?a:this.scene.fog,c=e.shaderParams;c.fog=h.type,c.srgbRenderTarget=null!=(o=null==t?void 0:t.isColorBufferSrgb(0))&&o;const d=(e,t,s,i)=>{rd.drawCalls.push(e),rd.shaderInstances.push(t),rd.isNewMaterial.push(s),rd.lightMaskChanged.push(i)};rd.clear();const u=this.device,p=this.scene,f=p.clusteredLightingEnabled,m=null!=(l=null==n?void 0:n.getLightHash(f))?l:0;let g,_,v=null;const b=s.length;for(let e=0;e<b;e++){const t=s[e];t.ensureMaterial(u);const n=t.material,a=t._shaderDefs,o=t.mask;n&&n===v&&a!==g&&(v=null),n!==v&&(this._materialSwitches++,n._scene=p,n.dirty&&(n.updateUniforms(u,p),n.dirty=!1));const l=t.getShaderInstance(r,m,p,c,this.viewUniformFormat,this.viewBindGroupFormat,i);d(t,l,n!==v,!v||o!==_),v=n,g=a,_=o}return rd}renderForwardInternal(e,t,s,i,n,r){const a=this.device,o=1<<i,l=r?-1:1,h=this.scene.clusteredLightingEnabled,c=t.drawCalls.length;for(let i=0;i<c;i++){var d,u;const r=t.drawCalls[i],p=t.isNewMaterial[i],f=t.lightMaskChanged[i],m=t.shaderInstances[i],g=r.material,_=r.mask;if(p){const t=!1;if(a.setShader(m.shader,t),g.setParameters(a),f){const t=this.dispatchDirectLights(s[0],_,e);h||this.dispatchLocalLights(s,_,t)}this.alphaTestId.setValue(g.alphaTest),a.setBlendState(g.blendState),a.setDepthState(g.depthState),a.setAlphaToCoverage(g.alphaToCoverage)}this.setupCullMode(e._cullFaces,l,r);const v=null!=(d=r.stencilFront)?d:g.stencilFront,b=null!=(u=r.stencilBack)?u:g.stencilBack;a.setStencilState(v,b),r.setParameters(a,o),a.scope.resolve("meshInstanceId").setValue(r.id);const y=r.mesh;this.setVertexBuffers(a,y),this.setMorphing(a,r.morphInstance),this.setSkinning(a,r),this.setupMeshUniformBuffers(m,r);const x=r.renderStyle;if(a.setIndexBuffer(y.indexBuffer[x]),null==n||n(r,i),e.xr&&e.xr.session&&e.xr.views.list.length){const t=e.xr.views;for(let e=0;e<t.list.length;e++){const s=t.list[e];a.setViewport(s.viewport.x,s.viewport.y,s.viewport.z,s.viewport.w),this.projId.setValue(s.projMat.data),this.projSkyboxId.setValue(s.projMat.data),this.viewId.setValue(s.viewOffMat.data),this.viewInvId.setValue(s.viewInvOffMat.data),this.viewId3.setValue(s.viewMat3.data),this.viewProjId.setValue(s.projViewOffMat.data),this.viewPosId.setValue(s.positionData),this.viewIndexId.setValue(e),0===e?this.drawInstance(a,r,y,x,!0):this.drawInstance2(a,r,y,x),this._forwardDrawCalls++}}else this.drawInstance(a,r,y,x,!0),this._forwardDrawCalls++;i<c-1&&!t.isNewMaterial[i+1]&&g.setParameters(a,r.parameters)}}renderForward(e,t,s,i,n,r,a,o){const l=this.renderForwardPrepareMaterials(e,t,s,i,a,n);this.renderForwardInternal(e,l,i,n,r,o),rd.clear()}renderForwardLayer(e,t,s,i,n,r,a={}){var o,l,h,c;const{scene:d,device:u}=this,p=d.clusteredLightingEnabled;let f,m;if(this.setupViewport(e,t),s){s.sortVisible(e,i);const t=s.getCulledInstances(e);f=i?t.transparent:t.opaque,d.immediate.onPreRenderLayer(s,f,i),s.requiresLightCube&&(this.lightCube.update(d.ambientLight,s._lights),this.constantLightCube.setValue(this.lightCube.colors)),m=s.splitLights}else{var g;f=a.meshInstances,m=null!=(g=a.splitLights)?g:id}if(p){var _;(null!=(_=a.lightClusters)?_:this.worldClustersAllocator.empty).activate(),s&&(this.clustersDebugRendered||d.lighting.debugLayer!==s.id||(this.clustersDebugRendered=!0))}d._activeCamera=e;const v=null!=(o=e.fog)?o:this.scene.fog;this.setFogConstants(v);const b=this.setCameraUniforms(e,t);u.supportsUniformBuffers&&this.setupViewUniformBuffers(r,this.viewUniformFormat,this.viewBindGroupFormat,b);const y=null!=(l=a.clearColor)&&l,x=null!=(h=a.clearDepth)&&h,w=null!=(c=a.clearStencil)&&c;(y||x||w)&&this.clear(e,y,x,w);const S=!!(e._flipFaces^(null==t?void 0:t.flipY)),C=this._forwardDrawCalls;this.renderForward(e,t,f,m,n,null,s,S),s&&(s._forwardDrawCalls+=this._forwardDrawCalls-C)}setFogConstants(e){if(e.type!==jo){nd.linear(e.color);const t=this.fogColor;t[0]=nd.r,t[1]=nd.g,t[2]=nd.b,this.fogColorId.setValue(t),"linear"===e.type?(this.fogStartId.setValue(e.start),this.fogEndId.setValue(e.end)):this.fogDensityId.setValue(e.density)}}setSceneConstants(){const e=this.scene;this.dispatchGlobalLights(e);const t=this.device;this._screenSize[0]=t.width,this._screenSize[1]=t.height,this._screenSize[2]=1/t.width,this._screenSize[3]=1/t.height,this.screenSizeId.setValue(this._screenSize),this.pcssDiskSamplesId.setValue(this.pcssDiskSamples),this.pcssSphereSamplesId.setValue(this.pcssSphereSamples)}buildFrameGraph(e,t){const s=this.scene;if(e.reset(),s.clusteredLightingEnabled){const{shadowsEnabled:t,cookiesEnabled:i}=s.lighting;this._renderPassUpdateClustered.update(e,t,i,this.lights,this.localLights),e.addRenderPass(this._renderPassUpdateClustered)}else this._shadowRendererLocal.buildNonClusteredRenderPasses(e,this.localLights);let i=0,n=!0,r=null;const a=t._renderActions;for(let s=i;s<a.length;s++){const o=a[s],{layer:l,camera:h}=o;if(o.useCameraPasses)h.camera.renderPasses.forEach((t=>{e.addRenderPass(t)}));else{const c=1===l.id,d=c&&(h.renderSceneColorMap||h.renderSceneDepthMap);n&&(n=!1,i=s,r=o.renderTarget);const u=a[s+1],p=!!u&&(!u.useCameraPasses&&1===u.layer.id)&&(h.renderSceneColorMap||h.renderSceneDepthMap),f=!!u&&(u.firstCameraUse&&this.cameraDirShadowLights.has(u.camera.camera));if(!u||u.renderTarget!==r||f||p||d){if(c&&i===s||this.addMainRenderPass(e,t,r,i,s),c){if(h.renderSceneColorMap){const t=h.camera.renderPassColorGrab;t.source=h.renderTarget,e.addRenderPass(t)}h.renderSceneDepthMap&&e.addRenderPass(h.camera.renderPassDepthGrab)}if(o.triggerPostprocess&&null!=h&&h.onPostprocessing){const t=new sd(this.device,this,o);e.addRenderPass(t)}n=!0}}}}addMainRenderPass(e,t,s,i,n){const r=new td(this.device,t,this.scene,this);r.init(s);const a=t._renderActions;for(let e=i;e<=n;e++)r.addRenderAction(a[e]);e.addRenderPass(r)}update(e){this.frameUpdate(),this.shadowRenderer.frameUpdate(),this.scene._updateSkyMesh(),this.updateLayerComposition(e),this.collectLights(e),this.beginFrame(e),this.setSceneConstants(),this.cullComposition(e),this.gpuUpdate(this.processingMeshInstances)}}let od=0;const ld=[],hd=new Set;const cd=[null,function(e,t){return e.drawOrder-t.drawOrder},function(e,t){const s=e._key[0],i=t._key[0];return s===i&&e.mesh&&t.mesh?t.mesh.id-e.mesh.id:i-s},function(e,t){return t.zdist-e.zdist},function(e,t){return e.zdist-t.zdist}];class dd{constructor(){this.opaque=[],this.transparent=[]}}class ud{constructor(e={}){var t,s,i;this.meshInstances=[],this.meshInstancesSet=new Set,this.shadowCasters=[],this.shadowCastersSet=new Set,this._visibleInstances=new WeakMap,this._lights=[],this._lightsSet=new Set,this._clusteredLightsSet=new Set,this._splitLights=[[],[],[]],this._splitLightsDirty=!0,this.requiresLightCube=!1,this.cameras=[],this.camerasSet=new Set,this._dirtyComposition=!1,void 0!==e.id?(this.id=e.id,od=Math.max(this.id+1,od)):this.id=od++,this.name=e.name,this._enabled=null==(t=e.enabled)||t,this._refCounter=this._enabled?1:0,this.opaqueSortMode=null!=(s=e.opaqueSortMode)?s:2,this.transparentSortMode=null!=(i=e.transparentSortMode)?i:3,e.renderTarget&&(this.renderTarget=e.renderTarget),this._clearColorBuffer=!!e.clearColorBuffer,this._clearDepthBuffer=!!e.clearDepthBuffer,this._clearStencilBuffer=!!e.clearStencilBuffer,this.onEnable=e.onEnable,this.onDisable=e.onDisable,this._enabled&&this.onEnable&&this.onEnable(),this.customSortCallback=null,this.customCalculateSortValues=null,this._lightHash=0,this._lightHashDirty=!1,this._lightIdHash=0,this._lightIdHashDirty=!1,this._shaderVersion=-1}set enabled(e){e!==this._enabled&&(this._dirtyComposition=!0,this._enabled=e,e?(this.incrementCounter(),this.onEnable&&this.onEnable()):(this.decrementCounter(),this.onDisable&&this.onDisable()))}get enabled(){return this._enabled}set clearColorBuffer(e){this._clearColorBuffer=e,this._dirtyComposition=!0}get clearColorBuffer(){return this._clearColorBuffer}set clearDepthBuffer(e){this._clearDepthBuffer=e,this._dirtyComposition=!0}get clearDepthBuffer(){return this._clearDepthBuffer}set clearStencilBuffer(e){this._clearStencilBuffer=e,this._dirtyComposition=!0}get clearStencilBuffer(){return this._clearStencilBuffer}get hasClusteredLights(){return this._clusteredLightsSet.size>0}get clusteredLightsSet(){return this._clusteredLightsSet}incrementCounter(){0===this._refCounter&&(this._enabled=!0,this.onEnable&&this.onEnable()),this._refCounter++}decrementCounter(){if(1===this._refCounter)this._enabled=!1,this.onDisable&&this.onDisable();else if(0===this._refCounter)return;this._refCounter--}addMeshInstances(e,t){const s=this.meshInstances,i=this.meshInstancesSet;for(let t=0;t<e.length;t++){const n=e[t];i.has(n)||(s.push(n),i.add(n),hd.add(n.material))}if(t||this.addShadowCasters(e),hd.size>0){const e=this._shaderVersion;hd.forEach((t=>{e>=0&&t._shaderVersion!==e&&(t.getShaderVariant!==tc.prototype.getShaderVariant&&t.clearVariants(),t._shaderVersion=e)})),hd.clear()}}removeMeshInstances(e,t){const s=this.meshInstances,i=this.meshInstancesSet;for(let t=0;t<e.length;t++){const n=e[t];if(i.has(n)){i.delete(n);const e=s.indexOf(n);e>=0&&s.splice(e,1)}}t||this.removeShadowCasters(e)}addShadowCasters(e){const t=this.shadowCasters,s=this.shadowCastersSet;for(let i=0;i<e.length;i++){const n=e[i];n.castShadow&&!s.has(n)&&(s.add(n),t.push(n))}}removeShadowCasters(e){const t=this.shadowCasters,s=this.shadowCastersSet;for(let i=0;i<e.length;i++){const n=e[i];if(s.has(n)){s.delete(n);const e=t.indexOf(n);e>=0&&t.splice(e,1)}}}clearMeshInstances(e=!1){this.meshInstances.length=0,this.meshInstancesSet.clear(),e||(this.shadowCasters.length=0,this.shadowCastersSet.clear())}markLightsDirty(){this._lightHashDirty=!0,this._lightIdHashDirty=!0,this._splitLightsDirty=!0}addLight(e){const t=e.light;this._lightsSet.has(t)||(this._lightsSet.add(t),this._lights.push(t),this.markLightsDirty()),0!==t.type&&this._clusteredLightsSet.add(t)}removeLight(e){const t=e.light;this._lightsSet.has(t)&&(this._lightsSet.delete(t),this._lights.splice(this._lights.indexOf(t),1),this.markLightsDirty()),0!==t.type&&this._clusteredLightsSet.delete(t)}clearLights(){this._lightsSet.forEach((e=>e.removeLayer(this))),this._lightsSet.clear(),this._clusteredLightsSet.clear(),this._lights.length=0,this.markLightsDirty()}get splitLights(){if(this._splitLightsDirty){this._splitLightsDirty=!1;const e=this._splitLights;for(let t=0;t<e.length;t++)e[t].length=0;const t=this._lights;for(let s=0;s<t.length;s++){const i=t[s];i.enabled&&e[i._type].push(i)}for(let t=0;t<e.length;t++)e[t].sort(((e,t)=>e.key-t.key))}return this._splitLights}evaluateLightHash(e,t,s){let i=0;const n=this._lights;for(let i=0;i<n.length;i++){const r=0!==n[i].type;(e&&r||t&&!r)&&ld.push(s?n[i].id:n[i].key)}return ld.length>0&&(ld.sort(),i=Wn(ld),ld.length=0),i}getLightHash(e){return this._lightHashDirty&&(this._lightHashDirty=!1,this._lightHash=this.evaluateLightHash(!e,!0,!1)),this._lightHash}getLightIdHash(){return this._lightIdHashDirty&&(this._lightIdHashDirty=!1,this._lightIdHash=this.evaluateLightHash(!0,!1,!0)),this._lightIdHash}addCamera(e){this.camerasSet.has(e.camera)||(this.camerasSet.add(e.camera),this.cameras.push(e),this._dirtyComposition=!0)}removeCamera(e){if(this.camerasSet.has(e.camera)){this.camerasSet.delete(e.camera);const t=this.cameras.indexOf(e);this.cameras.splice(t,1),this._dirtyComposition=!0}}clearCameras(){this.cameras.length=0,this.camerasSet.clear(),this._dirtyComposition=!0}_calculateSortDistances(e,t,s,i){for(let n=0;n<t;n++){const t=e[n];if(t.layer<=2)continue;if(t.calculateSortDistance){t.zdist=t.calculateSortDistance(t,s,i);continue}const r=t.aabb.center,a=r.x-s.x,o=r.y-s.y,l=r.z-s.z;t.zdist=a*i.x+o*i.y+l*i.z}}getCulledInstances(e){let t=this._visibleInstances.get(e);return t||(t=new dd,this._visibleInstances.set(e,t)),t}sortVisible(e,t){const s=t?this.transparentSortMode:this.opaqueSortMode;if(0===s)return;const i=this.getCulledInstances(e),n=t?i.transparent:i.opaque,r=e.node;if(5===s){const e=r.getPosition(),t=r.forward;this.customCalculateSortValues&&this.customCalculateSortValues(n,n.length,e,t),this.customSortCallback&&n.sort(this.customSortCallback)}else{if(3===s||4===s){const e=r.getPosition(),t=r.forward;this._calculateSortDistances(n,n.length,e,t)}n.sort(cd[s])}}}const pd=(e,t)=>e.priority-t.priority,fd=e=>e.sort(pd);class md extends Kt{constructor(e="Untitled"){super(),this.layerList=[],this.layerIdMap=new Map,this.layerNameMap=new Map,this.layerOpaqueIndexMap=new Map,this.layerTransparentIndexMap=new Map,this.subLayerList=[],this.subLayerEnabled=[],this.cameras=[],this._renderActions=[],this._dirty=!1,this.name=e,this._opaqueOrder={},this._transparentOrder={}}destroy(){this.destroyRenderActions()}destroyRenderActions(){this._renderActions.forEach((e=>e.destroy())),this._renderActions.length=0}_update(){const e=this.layerList.length;if(!this._dirty)for(let t=0;t<e;t++)if(this.layerList[t]._dirtyComposition){this._dirty=!0;break}if(this._dirty){this._dirty=!1,this.cameras.length=0;for(let t=0;t<e;t++){const e=this.layerList[t];e._dirtyComposition=!1;for(let t=0;t<e.cameras.length;t++){const s=e.cameras[t];this.cameras.indexOf(s)<0&&this.cameras.push(s)}}this.cameras.length>1&&fd(this.cameras);let t=0;this.destroyRenderActions();for(let s=0;s<this.cameras.length;s++){const i=this.cameras[s];if(i.camera.renderPasses.length>0){this.addDummyRenderAction(t,i),t++;continue}let n=!0;const r=t;let a=null,o=!1;for(let s=0;s<e;s++){const e=this.layerList[s];if(e.enabled&&this.subLayerEnabled[s]&&e.cameras.length>0&&i.layers.indexOf(e.id)>=0){o||e.id!==i.disablePostEffectsLayer||(o=!0,a&&(a.triggerPostprocess=!0));const r=this.subLayerList[s];a=this.addRenderAction(t,e,r,i,n,o),t++,n=!1}}r<t&&(a.lastCameraUse=!0),!o&&a&&(a.triggerPostprocess=!0),i.renderTarget&&i.postEffectsEnabled&&this.propagateRenderTarget(r-1,i)}this._logRenderActions()}}getNextRenderAction(e){const t=new ed;return this._renderActions.push(t),t}addDummyRenderAction(e,t){const s=this.getNextRenderAction(e);s.camera=t,s.useCameraPasses=!0}addRenderAction(e,t,s,i,n,r){let a=1!==t.id?i.renderTarget:null,o=!1;const l=this._renderActions;for(let t=e-1;t>=0;t--)if(l[t].camera===i&&l[t].renderTarget===a){o=!0;break}r&&i.postEffectsEnabled&&(a=null);const h=this.getNextRenderAction(e);h.triggerPostprocess=!1,h.layer=t,h.transparent=s,h.camera=i,h.renderTarget=a,h.firstCameraUse=n,h.lastCameraUse=!1;const c=n||!o,d=t.clearColorBuffer||t.clearDepthBuffer||t.clearStencilBuffer;return(c||d)&&h.setupClears(c?i:void 0,t),h}propagateRenderTarget(e,t){for(let s=e;s>=0;s--){const e=this._renderActions[s],i=e.layer;if(e.renderTarget&&1!==i.id)break;if(1===i.id)continue;if(e.useCameraPasses)break;const n=null==e?void 0:e.camera.camera;if(n&&(!t.camera.rect.equals(n.rect)||!t.camera.scissorRect.equals(n.scissorRect)))break;e.renderTarget=t.renderTarget}}_logRenderActions(){}_isLayerAdded(e){return this.layerIdMap.get(e.id)===e}_isSublayerAdded(e,t){return void 0!==(t?this.layerTransparentIndexMap:this.layerOpaqueIndexMap).get(e)}push(e){this._isLayerAdded(e)||(this.layerList.push(e),this.layerList.push(e),this._opaqueOrder[e.id]=this.subLayerList.push(!1)-1,this._transparentOrder[e.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this.subLayerEnabled.push(!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e))}insert(e,t){if(this._isLayerAdded(e))return;this.layerList.splice(t,0,e,e),this.subLayerList.splice(t,0,!1,!0);const s=this.layerList.length;this._updateOpaqueOrder(t,s-1),this._updateTransparentOrder(t,s-1),this.subLayerEnabled.splice(t,0,!0,!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e)}remove(e){let t=this.layerList.indexOf(e);for(delete this._opaqueOrder[t],delete this._transparentOrder[t];t>=0;)this.layerList.splice(t,1),this.subLayerList.splice(t,1),this.subLayerEnabled.splice(t,1),t=this.layerList.indexOf(e),this._dirty=!0,this.fire("remove",e);const s=this.layerList.length;this._updateOpaqueOrder(0,s-1),this._updateTransparentOrder(0,s-1),this._updateLayerMaps()}pushOpaque(e){this._isSublayerAdded(e,!1)||(this.layerList.push(e),this._opaqueOrder[e.id]=this.subLayerList.push(!1)-1,this.subLayerEnabled.push(!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e))}insertOpaque(e,t){if(this._isSublayerAdded(e,!1))return;this.layerList.splice(t,0,e),this.subLayerList.splice(t,0,!1);const s=this.subLayerList.length;this._updateOpaqueOrder(t,s-1),this.subLayerEnabled.splice(t,0,!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e)}removeOpaque(e){for(let t=0,s=this.layerList.length;t<s;t++)if(this.layerList[t]===e&&!this.subLayerList[t]){this.layerList.splice(t,1),this.subLayerList.splice(t,1),s--,this._updateOpaqueOrder(t,s-1),this.subLayerEnabled.splice(t,1),this._dirty=!0,this.layerList.indexOf(e)<0&&this.fire("remove",e);break}this._updateLayerMaps()}pushTransparent(e){this._isSublayerAdded(e,!0)||(this.layerList.push(e),this._transparentOrder[e.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e))}insertTransparent(e,t){if(this._isSublayerAdded(e,!0))return;this.layerList.splice(t,0,e),this.subLayerList.splice(t,0,!0);const s=this.subLayerList.length;this._updateTransparentOrder(t,s-1),this.subLayerEnabled.splice(t,0,!0),this._updateLayerMaps(),this._dirty=!0,this.fire("add",e)}removeTransparent(e){for(let t=0,s=this.layerList.length;t<s;t++)if(this.layerList[t]===e&&this.subLayerList[t]){this.layerList.splice(t,1),this.subLayerList.splice(t,1),s--,this._updateTransparentOrder(t,s-1),this.subLayerEnabled.splice(t,1),this._dirty=!0,this.layerList.indexOf(e)<0&&this.fire("remove",e);break}this._updateLayerMaps()}getOpaqueIndex(e){var t;return null!=(t=this.layerOpaqueIndexMap.get(e))?t:-1}getTransparentIndex(e){var t;return null!=(t=this.layerTransparentIndexMap.get(e))?t:-1}isEnabled(e,t){if(e.enabled){const s=t?this.getTransparentIndex(e):this.getOpaqueIndex(e);if(s>=0)return this.subLayerEnabled[s]}return!1}_updateLayerMaps(){this.layerIdMap.clear(),this.layerNameMap.clear(),this.layerOpaqueIndexMap.clear(),this.layerTransparentIndexMap.clear();for(let e=0;e<this.layerList.length;e++){const t=this.layerList[e];this.layerIdMap.set(t.id,t),this.layerNameMap.set(t.name,t);(this.subLayerList[e]?this.layerTransparentIndexMap:this.layerOpaqueIndexMap).set(t,e)}}getLayerById(e){var t;return null!=(t=this.layerIdMap.get(e))?t:null}getLayerByName(e){var t;return null!=(t=this.layerNameMap.get(e))?t:null}_updateOpaqueOrder(e,t){for(let s=e;s<=t;s++)!1===this.subLayerList[s]&&(this._opaqueOrder[this.layerList[s].id]=s)}_updateTransparentOrder(e,t){for(let s=e;s<=t;s++)!0===this.subLayerList[s]&&(this._transparentOrder[this.layerList[s].id]=s)}_sortLayersDescending(e,t,s){let i=-1,n=-1;for(let t=0,n=e.length;t<n;t++){const n=e[t];s.hasOwnProperty(n)&&(i=Math.max(i,s[n]))}for(let e=0,i=t.length;e<i;e++){const i=t[e];s.hasOwnProperty(i)&&(n=Math.max(n,s[i]))}return-1===i&&-1!==n?1:-1===n&&-1!==i?-1:n-i}sortTransparentLayers(e,t){return this._sortLayersDescending(e,t,this._transparentOrder)}sortOpaqueLayers(e,t){return this._sortLayersDescending(e,t,this._opaqueOrder)}}const gd=new ys,_d={bias:0,normalBias:0},vd=new os,bd={r:0,g:1,b:2,a:3},yd={directional:0,omni:1,point:1,spot:2},xd=[[new Ss(0,0,1,1)],[new Ss(0,0,.5,.5),new Ss(0,.5,.5,.5)],[new Ss(0,0,.5,.5),new Ss(0,.5,.5,.5),new Ss(.5,0,.5,.5)],[new Ss(0,0,.5,.5),new Ss(0,.5,.5,.5),new Ss(.5,0,.5,.5),new Ss(.5,.5,.5,.5)]];let wd=0;class Sd{constructor(e,t,s){this.light=s,this.camera=e,this.shadowCamera=Sc.createShadowCamera(s._shadowType,s._type,t),this.shadowMatrix=new As,this.shadowViewport=new Ss(0,0,1,1),this.shadowScissor=new Ss(0,0,1,1),this.depthRangeCompensation=0,this.projectionCompensation=0,this.face=t,this.visibleCasters=[],this.viewBindGroups=[]}destroy(){this.viewBindGroups.forEach((e=>{e.defaultUniformBuffer.destroy(),e.destroy()})),this.viewBindGroups.length=0}get shadowBuffer(){const e=this.shadowCamera.renderTarget;return e?this.light._isPcf?e.depthBuffer:e.colorBuffer:null}}class Cd{constructor(e,t){this.layers=new Set,this.clusteredLighting=void 0,this.shadowDepthState=On.DEFAULT.clone(),this.device=e,this.clusteredLighting=t,this.id=wd++,this._type=0,this._color=new os(.8,.8,.8),this._intensity=1,this._affectSpecularity=!0,this._luminance=0,this._castShadows=!1,this._enabled=!1,this._mask=1,this.isStatic=!1,this.key=0,this.bakeDir=!0,this.bakeNumSamples=1,this.bakeArea=0,this.attenuationStart=10,this.attenuationEnd=10,this._falloffMode=0,this._shadowType=0,this._vsmBlurSize=11,this.vsmBlurMode=1,this.vsmBias=.0025,this._cookie=null,this.cookieIntensity=1,this._cookieFalloff=!0,this._cookieChannel="rgb",this._cookieTransform=null,this._cookieTransformUniform=new Float32Array(4),this._cookieOffset=null,this._cookieOffsetUniform=new Float32Array(2),this._cookieTransformSet=!1,this._cookieOffsetSet=!1,this._innerConeAngle=40,this._outerConeAngle=45,this.cascades=null,this._shadowMatrixPalette=null,this._shadowCascadeDistances=null,this.numCascades=1,this.cascadeDistribution=.5,this._shape=0,this._colorLinear=new Float32Array(3),this._updateLinearColor(),this._position=new ys(0,0,0),this._direction=new ys(0,0,0),this._innerConeAngleCos=Math.cos(this._innerConeAngle*Math.PI/180),this._updateOuterAngle(this._outerConeAngle),this._usePhysicalUnits=void 0,this._shadowMap=null,this._shadowRenderParams=[],this._shadowCameraParams=[],this.shadowDistance=40,this._shadowResolution=1024,this._shadowBias=-5e-4,this.shadowIntensity=1,this._normalOffsetBias=0,this.shadowUpdateMode=2,this.shadowUpdateOverrides=null,this._penumbraSize=1,this._isVsm=!1,this._isPcf=!0,this._cookieMatrix=null,this._atlasViewport=null,this.atlasViewportAllocated=!1,this.atlasVersion=0,this.atlasSlotIndex=0,this.atlasSlotUpdated=!1,this._node=null,this._renderData=[],this.visibleThisFrame=!1,this.maxScreenSize=0,this._updateShadowBias()}destroy(){this._destroyShadowMap(),this.releaseRenderData(),this._renderData=null}releaseRenderData(){if(this._renderData){for(let e=0;e<this._renderData.length;e++)this._renderData[e].destroy();this._renderData.length=0}}addLayer(e){this.layers.add(e)}removeLayer(e){this.layers.delete(e)}set shadowBias(e){this._shadowBias!==e&&(this._shadowBias=e,this._updateShadowBias())}get shadowBias(){return this._shadowBias}set numCascades(e){this.cascades&&this.numCascades===e||(this.cascades=xd[e-1],this._shadowMatrixPalette=new Float32Array(64),this._shadowCascadeDistances=new Float32Array(4),this._destroyShadowMap(),this.updateKey())}get numCascades(){return this.cascades.length}set shadowMap(e){this._shadowMap!==e&&(this._destroyShadowMap(),this._shadowMap=e)}get shadowMap(){return this._shadowMap}set mask(e){this._mask!==e&&(this._mask=e,this.updateKey())}get mask(){return this._mask}get numShadowFaces(){const e=this._type;return 0===e?this.numCascades:1===e?6:1}set type(e){if(this._type===e)return;this._type=e,this._destroyShadowMap(),this._updateShadowBias(),this.updateKey();const t=this._shadowType;this._shadowType=null,this.shadowUpdateOverrides=null,this.shadowType=t}get type(){return this._type}set shape(e){if(this._shape===e)return;this._shape=e,this._destroyShadowMap(),this.updateKey();const t=this._shadowType;this._shadowType=null,this.shadowType=t}get shape(){return this._shape}set usePhysicalUnits(e){this._usePhysicalUnits!==e&&(this._usePhysicalUnits=e,this._updateLinearColor())}get usePhysicalUnits(){return this._usePhysicalUnits}set shadowType(e){var t,s;if(this._shadowType===e)return;const i=this.device;1===this._type&&5!==e&&0!==e&&7!==e&&8!==e&&6!==e&&(e=0),3!==e||i.textureFloatRenderable&&i.textureFloatFilterable||(e=2),2!==e||i.textureHalfFloatRenderable||(e=0);const n=Wo.get(e);this._isVsm=null!=(t=null==n?void 0:n.vsm)&&t,this._isPcf=null!=(s=null==n?void 0:n.pcf)&&s,this._shadowType=e,this._destroyShadowMap(),this.updateKey()}get shadowType(){return this._shadowType}set enabled(e){this._enabled!==e&&(this._enabled=e,this.layersDirty())}get enabled(){return this._enabled}set castShadows(e){this._castShadows!==e&&(this._castShadows=e,this._destroyShadowMap(),this.layersDirty(),this.updateKey())}get castShadows(){return this._castShadows&&4!==this._mask&&0!==this._mask}get bakeShadows(){return this._castShadows&&4===this._mask}set shadowResolution(e){this._shadowResolution!==e&&(e=1===this._type?Math.min(e,this.device.maxCubeMapSize):Math.min(e,this.device.maxTextureSize),this._shadowResolution=e,this._destroyShadowMap())}get shadowResolution(){return this._shadowResolution}set vsmBlurSize(e){this._vsmBlurSize!==e&&(e%2==0&&e++,this._vsmBlurSize=e)}get vsmBlurSize(){return this._vsmBlurSize}set normalOffsetBias(e){this._normalOffsetBias!==e&&((!this._normalOffsetBias&&e||this._normalOffsetBias&&!e)&&this.updateKey(),this._normalOffsetBias=e)}get normalOffsetBias(){return this._normalOffsetBias}set falloffMode(e){this._falloffMode!==e&&(this._falloffMode=e,this.updateKey())}get falloffMode(){return this._falloffMode}set innerConeAngle(e){this._innerConeAngle!==e&&(this._innerConeAngle=e,this._innerConeAngleCos=Math.cos(e*Math.PI/180),this._usePhysicalUnits&&this._updateLinearColor())}get innerConeAngle(){return this._innerConeAngle}set outerConeAngle(e){this._outerConeAngle!==e&&(this._outerConeAngle=e,this._updateOuterAngle(e),this._usePhysicalUnits&&this._updateLinearColor())}get outerConeAngle(){return this._outerConeAngle}set penumbraSize(e){this._penumbraSize=e}get penumbraSize(){return this._penumbraSize}_updateOuterAngle(e){const t=e*Math.PI/180;this._outerConeAngleCos=Math.cos(t),this._outerConeAngleSin=Math.sin(t)}set intensity(e){this._intensity!==e&&(this._intensity=e,this._updateLinearColor())}get intensity(){return this._intensity}set affectSpecularity(e){0===this._type&&(this._affectSpecularity=e,this.updateKey())}get affectSpecularity(){return this._affectSpecularity}set luminance(e){this._luminance!==e&&(this._luminance=e,this._updateLinearColor())}get luminance(){return this._luminance}get cookieMatrix(){return this._cookieMatrix||(this._cookieMatrix=new As),this._cookieMatrix}get atlasViewport(){return this._atlasViewport||(this._atlasViewport=new Ss(0,0,1,1)),this._atlasViewport}set cookie(e){this._cookie!==e&&(this._cookie=e,this.updateKey())}get cookie(){return this._cookie}set cookieFalloff(e){this._cookieFalloff!==e&&(this._cookieFalloff=e,this.updateKey())}get cookieFalloff(){return this._cookieFalloff}set cookieChannel(e){if(this._cookieChannel!==e){if(e.length<3){const t=e.charAt(e.length-1),s=3-e.length;for(let i=0;i<s;i++)e+=t}this._cookieChannel=e,this.updateKey()}}get cookieChannel(){return this._cookieChannel}set cookieTransform(e){this._cookieTransform!==e&&(this._cookieTransform=e,this._cookieTransformSet=!!e,e&&!this._cookieOffset&&(this.cookieOffset=new ws,this._cookieOffsetSet=!1),this.updateKey())}get cookieTransform(){return this._cookieTransform}set cookieOffset(e){if(this._cookieOffset===e)return;!(!this._cookieTransformSet&&!e)&&!e&&this._cookieOffset?this._cookieOffset.set(0,0):this._cookieOffset=e,this._cookieOffsetSet=!!e,e&&!this._cookieTransform&&(this.cookieTransform=new Ss(1,1,0,0),this._cookieTransformSet=!1),this.updateKey()}get cookieOffset(){return this._cookieOffset}beginFrame(){this.visibleThisFrame=0===this._type&&this._enabled,this.maxScreenSize=0,this.atlasViewportAllocated=!1,this.atlasSlotUpdated=!1}_destroyShadowMap(){if(this.releaseRenderData(),this._shadowMap&&(this._shadowMap.cached||this._shadowMap.destroy(),this._shadowMap=null),0===this.shadowUpdateMode&&(this.shadowUpdateMode=1),this.shadowUpdateOverrides)for(let e=0;e<this.shadowUpdateOverrides.length;e++)0===this.shadowUpdateOverrides[e]&&(this.shadowUpdateOverrides[e]=1)}getRenderData(e,t){for(let s=0;s<this._renderData.length;s++){const i=this._renderData[s];if(i.camera===e&&i.face===t)return i}const s=new Sd(e,t,this);return this._renderData.push(s),s}clone(){const e=new Cd(this.device,this.clusteredLighting);return e.type=this._type,e.setColor(this._color),e.intensity=this._intensity,e.affectSpecularity=this._affectSpecularity,e.luminance=this._luminance,e.castShadows=this.castShadows,e._enabled=this._enabled,e.attenuationStart=this.attenuationStart,e.attenuationEnd=this.attenuationEnd,e.falloffMode=this._falloffMode,e.shadowType=this._shadowType,e.vsmBlurSize=this._vsmBlurSize,e.vsmBlurMode=this.vsmBlurMode,e.vsmBias=this.vsmBias,e.penumbraSize=this.penumbraSize,e.shadowUpdateMode=this.shadowUpdateMode,e.mask=this.mask,this.shadowUpdateOverrides&&(e.shadowUpdateOverrides=this.shadowUpdateOverrides.slice()),e.innerConeAngle=this._innerConeAngle,e.outerConeAngle=this._outerConeAngle,e.numCascades=this.numCascades,e.cascadeDistribution=this.cascadeDistribution,e.shape=this._shape,e.shadowDepthState.copy(this.shadowDepthState),e.shadowBias=this.shadowBias,e.normalOffsetBias=this._normalOffsetBias,e.shadowResolution=this._shadowResolution,e.shadowDistance=this.shadowDistance,e.shadowIntensity=this.shadowIntensity,e}static getLightUnitConversion(e,t=Math.PI/4,s=0){switch(e){case 2:{const e=Math.cos(t),i=Math.cos(s);return 2*Math.PI*(1-i+(i-e)/2)}case 1:return 4*Math.PI;case 0:return 1}}_getUniformBiasValues(e){const t=e.shadowCamera._farClip;switch(this._type){case 1:_d.bias=this.shadowBias,_d.normalBias=this._normalOffsetBias;break;case 2:this._isVsm?_d.bias=-2e-4:_d.bias=20*this.shadowBias,_d.normalBias=this._isVsm?this.vsmBias/(this.attenuationEnd/7):this._normalOffsetBias;break;case 0:this._isVsm?_d.bias=-2e-4:_d.bias=this.shadowBias/t*100,_d.normalBias=this._isVsm?this.vsmBias/(t/7):this._normalOffsetBias}return _d}getColor(){return this._color}getBoundingSphere(e){if(2===this._type){const t=this.attenuationEnd,s=this._outerConeAngle,i=this._outerConeAngleCos,n=this._node;gd.copy(n.up),s>45?(e.radius=t*this._outerConeAngleSin,gd.mulScalar(-t*i)):(e.radius=t/(2*i),gd.mulScalar(-e.radius)),e.center.add2(n.getPosition(),gd)}else 1===this._type&&(e.center=this._node.getPosition(),e.radius=this.attenuationEnd)}getBoundingBox(e){if(2===this._type){const t=this.attenuationEnd,s=this._outerConeAngle,i=this._node,n=Math.abs(Math.sin(s*rs.DEG_TO_RAD)*t);e.center.set(0,.5*-t,0),e.halfExtents.set(n,.5*t,n),e.setFromTransformedAabb(e,i.getWorldTransform(),!0)}else 1===this._type&&(e.center.copy(this._node.getPosition()),e.halfExtents.set(this.attenuationEnd,this.attenuationEnd,this.attenuationEnd))}_updateShadowBias(){if(1!==this._type||this.clusteredLighting){const e=-1e3*this.shadowBias;this.shadowDepthState.depthBias=e,this.shadowDepthState.depthBiasSlope=e}else this.shadowDepthState.depthBias=0,this.shadowDepthState.depthBiasSlope=0}_updateLinearColor(){let e=this._intensity;this._usePhysicalUnits&&(e=this._luminance/Cd.getLightUnitConversion(this._type,this._outerConeAngle*rs.DEG_TO_RAD,this._innerConeAngle*rs.DEG_TO_RAD));const t=this._color,s=this._colorLinear;e>=1?vd.linear(t).mulScalar(e):vd.copy(t).mulScalar(e).linear(),s[0]=vd.r,s[1]=vd.g,s[2]=vd.b}setColor(){1===arguments.length?this._color.set(arguments[0].r,arguments[0].g,arguments[0].b):3===arguments.length&&this._color.set(arguments[0],arguments[1],arguments[2]),this._updateLinearColor()}layersDirty(){this.layers.forEach((e=>{e.markLightsDirty()}))}updateKey(){let e=this._type<<29|this._shadowType<<25|this._falloffMode<<23|(0!==this._normalOffsetBias?1:0)<<22|(this._cookie?1:0)<<21|(this._cookieFalloff?1:0)<<20|bd[this._cookieChannel.charAt(0)]<<18|(this._cookieTransform?1:0)<<12|this._shape<<10|this.numCascades-1<<8|(this.affectSpecularity?1:0)<<7|this.mask<<6|(this._castShadows?1:0)<<3;3===this._cookieChannel.length&&(e|=bd[this._cookieChannel.charAt(1)]<<16,e|=bd[this._cookieChannel.charAt(2)]<<14),e!==this.key&&this.layersDirty(),this.key=e}}class Td{constructor(e,t,s){this._areaLightsEnabled=!1,this._cells=new ys(10,3,10),this._maxLightsPerCell=255,this._shadowsEnabled=!0,this._shadowType=0,this._shadowAtlasResolution=2048,this._cookiesEnabled=!1,this._cookieAtlasResolution=2048,this.debugLayer=void 0,this.atlasSplit=null,this._supportsAreaLights=e,this._maxTextureSize=t,this._dirtyLightsFnc=s}applySettings(e){var t,s,i,n,r,a,o;this.shadowsEnabled=null!=(t=e.lightingShadowsEnabled)?t:this.shadowsEnabled,this.cookiesEnabled=null!=(s=e.lightingCookiesEnabled)?s:this.cookiesEnabled,this.areaLightsEnabled=null!=(i=e.lightingAreaLightsEnabled)?i:this.areaLightsEnabled,this.shadowAtlasResolution=null!=(n=e.lightingShadowAtlasResolution)?n:this.shadowAtlasResolution,this.cookieAtlasResolution=null!=(r=e.lightingCookieAtlasResolution)?r:this.cookieAtlasResolution,this.maxLightsPerCell=null!=(a=e.lightingMaxLightsPerCell)?a:this.maxLightsPerCell,this.shadowType=null!=(o=e.lightingShadowType)?o:this.shadowType,e.lightingCells&&(this.cell=new ys(e.lightingCells))}set cells(e){this._cells.copy(e)}get cells(){return this._cells}set maxLightsPerCell(e){this._maxLightsPerCell=rs.clamp(e,1,255)}get maxLightsPerCell(){return this._maxLightsPerCell}set cookieAtlasResolution(e){this._cookieAtlasResolution=rs.clamp(e,32,this._maxTextureSize)}get cookieAtlasResolution(){return this._cookieAtlasResolution}set shadowAtlasResolution(e){this._shadowAtlasResolution=rs.clamp(e,32,this._maxTextureSize)}get shadowAtlasResolution(){return this._shadowAtlasResolution}set shadowType(e){this._shadowType!==e&&(this._shadowType=e,this._dirtyLightsFnc())}get shadowType(){return this._shadowType}set cookiesEnabled(e){this._cookiesEnabled!==e&&(this._cookiesEnabled=e,this._dirtyLightsFnc())}get cookiesEnabled(){return this._cookiesEnabled}set areaLightsEnabled(e){this._supportsAreaLights&&this._areaLightsEnabled!==e&&(this._areaLightsEnabled=e,this._dirtyLightsFnc())}get areaLightsEnabled(){return this._areaLightsEnabled}set shadowsEnabled(e){this._shadowsEnabled!==e&&(this._shadowsEnabled=e,this._dirtyLightsFnc())}get shadowsEnabled(){return this._shadowsEnabled}}const Ed=new Rn(!0,0,1,1);class Pd{constructor(e){this.shaderCache=[],this.morph=e,e.incRefCount(),this.device=e.device,this._weights=[],this._weightMap=new Map;for(let t=0;t<e._targets.length;t++){const s=e._targets[t];s.name&&this._weightMap.set(s.name,t),this.setWeight(t,s.defaultWeight)}this._activeTargets=[],this.maxSubmitCount=this.device.maxTextures,this._shaderMorphWeights=new Float32Array(this.maxSubmitCount);const t=(t,s)=>(this[s]=e._createTexture(t,e._renderTextureFormat),new tr({colorBuffer:this[s],depth:!1}));e.morphPositions&&(this.rtPositions=t("MorphRTPos","texturePositions")),e.morphNormals&&(this.rtNormals=t("MorphRTNrm","textureNormals")),this._textureParams=new Float32Array([e.morphTextureWidth,e.morphTextureHeight]);const s=e.aabb.halfExtents;this._aabbSize=new Float32Array([4*s.x,4*s.y,4*s.z]);const i=e.aabb.getMin();this._aabbMin=new Float32Array([2*i.x,2*i.y,2*i.z]),this._aabbNrmSize=new Float32Array([2,2,2]),this._aabbNrmMin=new Float32Array([-1,-1,-1]),this.aabbSizeId=this.device.scope.resolve("aabbSize"),this.aabbMinId=this.device.scope.resolve("aabbMin");for(let e=0;e<this.maxSubmitCount;e++)this[`morphBlendTex${e}`]=this.device.scope.resolve(`morphBlendTex${e}`);this.morphFactor=this.device.scope.resolve("morphFactor[0]"),this.zeroTextures=!1}destroy(){this.shader=null;const e=this.morph;e&&(this.morph=null,e.decRefCount(),e.refCount<1&&e.destroy()),this.rtPositions&&(this.rtPositions.destroy(),this.rtPositions=null),this.texturePositions&&(this.texturePositions.destroy(),this.texturePositions=null),this.rtNormals&&(this.rtNormals.destroy(),this.rtNormals=null),this.textureNormals&&(this.textureNormals.destroy(),this.textureNormals=null)}clone(){return new Pd(this.morph)}_getWeightIndex(e){if("string"==typeof e){return this._weightMap.get(e)}return e}getWeight(e){const t=this._getWeightIndex(e);return this._weights[t]}setWeight(e,t){const s=this._getWeightIndex(e);this._weights[s]=t,this._dirty=!0}_getFragmentShader(e){let t="",s="";for(let i=0;i<e;i++)t+=`uniform highp sampler2D morphBlendTex${i};`,s+=`color.xyz += morphFactor[${i}] * texture2D(morphBlendTex${i}, uv0).xyz;`;return`\n\n\t\t\t\t\t\tvarying vec2 uv0;\n\t\t\t\t\t\t${this.morph.intRenderFormat?"#define MORPH_INT":""}\n\t\t\t\t\t\t${e>0?`uniform highp float morphFactor[${e}];`:""}\n\t\t\t\t\t\t${t}\n\n\t\t\t\t\t\t#ifdef MORPH_INT\n\t\t\t\t\t\t\t\tuniform vec3 aabbSize;\n\t\t\t\t\t\t\t\tuniform vec3 aabbMin;\n\t\t\t\t\t\t#endif\n\n\t\t\t\t\t\tvoid main (void) {\n\t\t\t\t\t\t\t\thighp vec4 color = vec4(0, 0, 0, 1);\n\n\t\t\t\t\t\t\t\t${s}\n\n\t\t\t\t\t\t\t\t#ifdef MORPH_INT\n\t\t\t\t\t\t\t\t\t\tcolor.xyz = (color.xyz - aabbMin) / aabbSize * 65535.0;\n\t\t\t\t\t\t\t\t\t\tgl_FragColor = uvec4(color);\n\t\t\t\t\t\t\t\t#else\n\t\t\t\t\t\t\t\t\t\tgl_FragColor = color;\n\t\t\t\t\t\t\t\t#endif\n\t\t\t\t\t\t}\n\t\t\t\t`}_getShader(e){let t=this.shaderCache[e];if(!t){const s=this._getFragmentShader(e),i=this.morph.intRenderFormat?"uvec4":"vec4";t=fl(this.device,"\n\tattribute vec2 vertex_position;\n\tvarying vec2 uv0;\n\tvoid main(void) {\n\t\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\t\tuv0 = vertex_position.xy * 0.5 + 0.5;\n\t}\n\t",s,`textureMorph${e}`,void 0,{fragmentOutputTypes:[i]}),this.shaderCache[e]=t}return t}_updateTextureRenderTarget(e,t,s){const i=this.device,n=(t,s)=>{this.morphFactor.setValue(this._shaderMorphWeights),i.setBlendState(s?Ed:Rn.NOBLEND);const n=this._getShader(t);Cl(i,e,n)};this.setAabbUniforms(s);let r=0,a=!1;const o=this._activeTargets.length;for(let e=0;e<o;e++){const s=this._activeTargets[e],i=s.target[t];i&&(this[`morphBlendTex${r}`].setValue(i),this._shaderMorphWeights[r]=s.weight,r++,r>=this.maxSubmitCount&&(n(r,a),r=0,a=!0))}(r>0||0===o&&!this.zeroTextures)&&n(r,a)}_updateTextureMorph(){(this._activeTargets.length>0||!this.zeroTextures)&&(this.rtPositions&&this._updateTextureRenderTarget(this.rtPositions,"texturePositions",!0),this.rtNormals&&this._updateTextureRenderTarget(this.rtNormals,"textureNormals",!1),this.zeroTextures=0===this._activeTargets.length)}setAabbUniforms(e=!0){this.aabbSizeId.setValue(e?this._aabbSize:this._aabbNrmSize),this.aabbMinId.setValue(e?this._aabbMin:this._aabbNrmMin)}prepareRendering(e){this.setAabbUniforms()}update(){this._dirty=!1;const e=this.morph._targets;let t=0;for(let s=0;s<e.length;s++){const i=Math.abs(this.getWeight(s));if(i>1e-5){this._activeTargets.length<=t&&(this._activeTargets[t]={});const n=this._activeTargets[t++];n.absWeight=i,n.weight=this.getWeight(s),n.target=e[s]}}this._activeTargets.length=t,this.morph.intRenderFormat&&this._activeTargets.length>this.maxSubmitCount&&(this._activeTargets.sort(((e,t)=>e.absWeight<t.absWeight?1:t.absWeight<e.absWeight?-1:0)),this._activeTargets.length=this.maxSubmitCount),this._updateTextureMorph()}}class kd{constructor(){this.graph=null,this.meshInstances=[],this.skinInstances=[],this.morphInstances=[],this.cameras=[],this.lights=[],this._shadersVersion=0,this._immutable=!1}getGraph(){return this.graph}setGraph(e){this.graph=e}getCameras(){return this.cameras}setCameras(e){this.cameras=e}getLights(){return this.lights}setLights(e){this.lights=e}getMaterials(){const e=[];for(let t=0;t<this.meshInstances.length;t++){const s=this.meshInstances[t];-1===e.indexOf(s.material)&&e.push(s.material)}return e}clone(){const e=[],t=[],s=function s(i){const n=i.clone();e.push(i),t.push(n);for(let e=0;e<i._children.length;e++)n.addChild(s(i._children[e]));return n}(this.graph),i=[],n=[],r=[];for(let e=0;e<this.skinInstances.length;e++){const t=this.skinInstances[e].skin,i=new Pl(t),r=[];for(let e=0;e<t.boneNames.length;e++){const i=t.boneNames[e],n=s.findByName(i);r.push(n)}i.bones=r,n.push(i)}for(let e=0;e<this.morphInstances.length;e++){const t=this.morphInstances[e].morph,s=new Pd(t);r.push(s)}for(let s=0;s<this.meshInstances.length;s++){const a=this.meshInstances[s],o=e.indexOf(a.node),l=new Hl(a.mesh,a.material,t[o]);if(a.skinInstance){const e=this.skinInstances.indexOf(a.skinInstance);l.skinInstance=n[e]}if(a.morphInstance){const e=this.morphInstances.indexOf(a.morphInstance);l.morphInstance=r[e]}i.push(l)}const a=new kd;return a.graph=s,a.meshInstances=i,a.skinInstances=n,a.morphInstances=r,a.getGraph().syncHierarchy(),a}destroy(){const e=this.meshInstances;for(let t=0;t<e.length;t++)e[t].destroy();this.meshInstances.length=0}generateWireframe(){Hl._prepareRenderStyleForArray(this.meshInstances,1)}}class Ad extends Tr{constructor(e,t,{preferHighPrecision:s=!1}={}){var i;super(),this._aabb=void 0,this.preferHighPrecision=void 0,this.device=t,this.preferHighPrecision=s,this._targets=e.slice();const n=this.device,r=n.textureHalfFloatRenderable?Ws:void 0,a=n.textureFloatRenderable?$s:void 0;this._renderTextureFormat=this.preferHighPrecision?null!=a?a:r:null!=r?r:a,this._renderTextureFormat=null!=(i=this._renderTextureFormat)?i:47,this.intRenderFormat=ri(this._renderTextureFormat),this._textureFormat=this.preferHighPrecision?13:Ws,this._init(),this._updateMorphFlags()}get aabb(){if(!this._aabb){const e=new ys,t=new ys;for(let s=0;s<this._targets.length;s++){const i=this._targets[s].aabb;e.min(i.getMin()),t.max(i.getMax())}this._aabb=new Bs,this._aabb.setMinMax(e,t)}return this._aabb}get morphPositions(){return this._morphPositions}get morphNormals(){return this._morphNormals}_init(){this._initTextureBased();for(let e=0;e<this._targets.length;e++)this._targets[e]._postInit()}_findSparseSet(e,t,s){let i=1;const n=e[0].length;for(let r=0;r<n;r+=3){let n=!1;for(let t=0;t<e.length;t++){const s=e[t];if(0!==s[r]||0!==s[r+1]||0!==s[r+2]){n=!0;break}}n?(t.push(i),s.push(r/3),i++):t.push(0)}return i}_initTextureBased(){const e=[],t=[];for(let s=0;s<this._targets.length;s++){const i=this._targets[s];i.options.deltaPositions&&(e.push(i.options.deltaPositions),t.push({target:i,name:"texturePositions"})),i.options.deltaNormals&&(e.push(i.options.deltaNormals),t.push({target:i,name:"textureNormals"}))}const s=[],i=[],n=this._findSparseSet(e,s,i),r=this.device.maxTextureSize;let a=Math.ceil(Math.sqrt(n));a=Math.min(a,r);const o=Math.ceil(n/a);if(o>r)return!1;this.morphTextureWidth=a,this.morphTextureHeight=o;let l=!1,h=3;const c=fs.float2Half;this._textureFormat===Ws&&(l=!0,h=4);const d=[];for(let t=0;t<e.length;t++)d.push(this._createTexture("MorphTarget",this._textureFormat));for(let s=0;s<e.length;s++){const n=e[s],r=d[s],a=r.lock();if(l)for(let e=0;e<i.length;e++){const t=3*i[e],s=e*h+h;a[s]=c(n[t]),a[s+1]=c(n[t+1]),a[s+2]=c(n[t+2])}else for(let e=0;e<i.length;e++){const t=3*i[e],s=e*h+h;a[s]=n[t],a[s+1]=n[t+1],a[s+2]=n[t+2]}r.unlock();t[s].target._setTexture(t[s].name,r)}const u=[{semantic:ki,components:1,type:5,asInt:!0}];return this.vertexBufferIds=new Hn(this.device,new Kn(this.device,u,s.length),s.length,{data:new Uint32Array(s)}),!0}destroy(){var e;null==(e=this.vertexBufferIds)||e.destroy(),this.vertexBufferIds=null;for(let e=0;e<this._targets.length;e++)this._targets[e].destroy();this._targets.length=0}get targets(){return this._targets}_updateMorphFlags(){this._morphPositions=!1,this._morphNormals=!1;for(let e=0;e<this._targets.length;e++){const t=this._targets[e];t.morphPositions&&(this._morphPositions=!0),t.morphNormals&&(this._morphNormals=!0)}}_createTexture(e,t){return new yn(this.device,{width:this.morphTextureWidth,height:this.morphTextureHeight,format:t,cubemap:!1,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1,name:e})}}class Md{constructor(e){this.used=!1,this.options=e,this._name=e.name,this._defaultWeight=e.defaultWeight||0,this._aabb=e.aabb,this.deltaPositions=e.deltaPositions}destroy(){var e,t;null==(e=this.texturePositions)||e.destroy(),this.texturePositions=null,null==(t=this.textureNormals)||t.destroy(),this.textureNormals=null}get name(){return this._name}get defaultWeight(){return this._defaultWeight}get aabb(){return this._aabb||(this._aabb=new Bs,this.deltaPositions&&this._aabb.compute(this.deltaPositions)),this._aabb}get morphPositions(){return!!this.texturePositions}get morphNormals(){return!!this.textureNormals}clone(){return new Md(this.options)}_postInit(){this.options.preserveData||(this.options=null),this.used=!0}_setTexture(e,t){this[e]=t}}const Dd=new class extends pl{generateKey(e){const t=e.shaderDesc,s=t.vertexCode?jn(t.vertexCode):0,i=t.fragmentCode?jn(t.fragmentCode):0,n=pl.definesHash(e.defines);let r=`${t.uniqueName}_${s}_${i}_${n}`;return r+=`_${e.pass}`,r+=`_${e.gamma}`,r+=`_${e.toneMapping}`,r+=`_${e.fog}`,e.skin&&(r+="_skin"),e.useInstancing&&(r+="_inst"),e.useMorphPosition&&(r+="_morphp"),e.useMorphNormal&&(r+="_morphn"),e.useMorphTextureBasedInt&&(r+="_morphi"),r}createAttributesDefinition(e,t){const s=t.shaderDesc.attributes,i=s?kn({},s):void 0;t.skin&&(i.vertex_boneWeights=di,i.vertex_boneIndices=ui),(t.useMorphPosition||t.useMorphNormal)&&(i.morph_vertex_id=ki),e.attributes=i}createVertexDefinition(e,t,s){const i=t.shaderDesc;if(e.shaderLanguage===Ui)e.vertexCode=i.vertexCode;else{const n=new Map,r=new Map(t.defines);n.set("shaderPassDefines",s.shaderDefines),n.set("userCode",i.vertexCode),n.set("transformCore",cl.transformCoreVS),n.set("transformInstancing",""),n.set("normalCore",cl.normalCoreVS),n.set("skinCode",cl.skinTexVS),n.set("skinTexVS",cl.skinTexVS),t.skin&&r.set("SKIN",!0),t.useInstancing&&r.set("INSTANCING",!0),(t.useMorphPosition||t.useMorphNormal)&&(r.set("MORPHING",!0),t.useMorphTextureBasedInt&&r.set("MORPHING_INT",!0),t.useMorphPosition&&r.set("MORPHING_POSITION",!0),t.useMorphNormal&&r.set("MORPHING_NORMAL",!0)),e.vertexCode='\n\t\t#include "shaderPassDefines"\n\t\t#include "userCode"\n',e.vertexIncludes=n,e.vertexDefines=r}}createFragmentDefinition(e,t,s){const i=t.shaderDesc;if(e.shaderLanguage===Ui)e.fragmentCode=i.fragmentCode;else{const n=new Map(Object.entries(kn({},cl,t.chunks)));n.set("shaderPassDefines",s.shaderDefines),n.set("gamma",pl.gammaCode(t.gamma)),n.set("fog",pl.fogCode(t.fog)),n.set("userCode",i.fragmentCode);const r=new Map(t.defines);r.set("TONEMAP",Xo[t.toneMapping]),e.fragmentCode='\n\t\t#include "shaderPassDefines"\n\t\t#include "decodePS"\n\t\t#include "gamma"\n\t\t#include "tonemappingPS"\n\t\t#include "fog"\n\t\t#include "userCode"\n',e.fragmentIncludes=n,e.fragmentDefines=r}}createShaderDefinition(e,t){const s=mc.get(e).getByIndex(t.pass),i=t.shaderDesc,n={name:`ShaderMaterial-${i.uniqueName}`,shaderLanguage:i.shaderLanguage,fragmentOutputTypes:i.fragmentOutputTypes,meshUniformBufferFormat:i.meshUniformBufferFormat,meshBindGroupFormat:i.meshBindGroupFormat};return this.createAttributesDefinition(n,t),this.createVertexDefinition(n,t,s),this.createFragmentDefinition(n,t,s),_a.createDefinition(e,n)}};class Rd extends tc{constructor(e){super(),this._shaderDesc=void 0,this.shaderDesc=e}set shaderDesc(e){this._shaderDesc=e?kn({},e):void 0,this.clearVariants()}get shaderDesc(){return this._shaderDesc}copy(e){return super.copy(e),this.shaderDesc=e.shaderDesc,this}getShaderVariant(e){const{objDefs:t,cameraShaderParams:s}=e,i={defines:gl(this,s),skin:!!(2&t),useInstancing:!!(32&t),useMorphPosition:!!(t&Yo),useMorphNormal:!!(t&Qo),useMorphTextureBasedInt:!!(t&Zo),pass:e.pass,gamma:e.cameraShaderParams.shaderOutputGamma,toneMapping:e.cameraShaderParams.toneMapping,fog:e.cameraShaderParams.fog,shaderDesc:this.shaderDesc},n=new ol(e.viewUniformFormat,e.viewBindGroupFormat,e.vertexFormat),r=ul(e.device);return r.register("shader-material",Dd),r.getProgram("shader-material",i,n,this.userId)}}const Ld={linear:"decodeLinear",srgb:"decodeGamma",rgbm:"decodeRGBM",rgbe:"decodeRGBE",rgbp:"decodeRGBP"},Id={linear:"encodeLinear",srgb:"encodeGamma",rgbm:"encodeRGBM",rgbe:"encodeRGBE",rgbp:"encodeRGBP"};class Fd{static decodeFunc(e){return Ld[e]||"decodeGamma"}static encodeFunc(e){return Id[e]||"encodeGamma"}static getScreenDepthChunk(e,t){return`\n\t\t\t\t\t\t${t.sceneDepthMapLinear?"#define SCENE_DEPTHMAP_LINEAR":""}\n\t\t\t\t\t\t${e.textureFloatRenderable?"#define SCENE_DEPTHMAP_FLOAT":""}\n\t\t\t\t\t\t${cl.screenDepthPS}\n\t\t\t\t`}}const Od=new class extends pl{generateKey(e){const t=pl.definesHash(e.defines);return`skybox-${e.type}-${e.encoding}-${e.gamma}-${e.toneMapping}-${e.skymesh}_${t}`+("cubemap"===e.type?`-${e.mip}`:"")}createShaderDefinition(e,t){const s=new Map;s.set("TONEMAP",Xo[t.toneMapping]),s.set("SKYBOX_DECODE_FNC",Fd.decodeFunc(t.encoding)),t.skymesh!==tl&&s.set("SKYMESH",""),"cubemap"===t.type&&s.set("SKY_CUBEMAP","");const i=new Map(Object.entries(kn({},cl,t.chunks)));return i.set("decodePS",cl.decodePS),i.set("gamma",pl.gammaCode(t.gamma)),i.set("envMultiplyPS",cl.envMultiplyPS),"cubemap"!==t.type&&(i.set("sphericalPS",cl.sphericalPS),i.set("envAtlasPS",cl.envAtlasPS)),_a.createDefinition(e,{name:"SkyboxShader",attributes:{aPosition:li},vertexCode:cl.skyboxVS,vertexDefines:s,fragmentCode:cl.skyboxPS,fragmentDefines:s,fragmentIncludes:i})}},Bd=(e,t)=>{const s=t.length/3,i=e.length/3,n=new ys,r=new ys,a=new ys,o=new ys,l=new ys,h=new ys,c=[];for(let t=0;t<e.length;t++)c[t]=0;for(let i=0;i<s;i++){const s=t[3*i],d=t[3*i+1],u=t[3*i+2];n.set(e[3*s],e[3*s+1],e[3*s+2]),r.set(e[3*d],e[3*d+1],e[3*d+2]),a.set(e[3*u],e[3*u+1],e[3*u+2]),o.sub2(r,n),l.sub2(a,n),h.cross(o,l).normalize(),c[3*s]+=h.x,c[3*s+1]+=h.y,c[3*s+2]+=h.z,c[3*d]+=h.x,c[3*d+1]+=h.y,c[3*d+2]+=h.z,c[3*u]+=h.x,c[3*u+1]+=h.y,c[3*u+2]+=h.z}for(let e=0;e<i;e++){const t=c[3*e],s=c[3*e+1],i=c[3*e+2],n=1/Math.sqrt(t*t+s*s+i*i);c[3*e]*=n,c[3*e+1]*=n,c[3*e+2]*=n}return c},zd=(e,t,s,i)=>{const n=i.length/3,r=e.length/3,a=new ys,o=new ys,l=new ys,h=new ws,c=new ws,d=new ws,u=new ys,p=new ys,f=new Float32Array(3*r),m=new Float32Array(3*r),g=[];for(let t=0;t<n;t++){const n=i[3*t],r=i[3*t+1],g=i[3*t+2];a.set(e[3*n],e[3*n+1],e[3*n+2]),o.set(e[3*r],e[3*r+1],e[3*r+2]),l.set(e[3*g],e[3*g+1],e[3*g+2]),h.set(s[2*n],s[2*n+1]),c.set(s[2*r],s[2*r+1]),d.set(s[2*g],s[2*g+1]);const _=o.x-a.x,v=l.x-a.x,b=o.y-a.y,y=l.y-a.y,x=o.z-a.z,w=l.z-a.z,S=c.x-h.x,C=d.x-h.x,T=c.y-h.y,E=d.y-h.y,P=S*E-C*T;if(0===P)u.set(0,1,0),p.set(1,0,0);else{const e=1/P;u.set((E*_-T*v)*e,(E*b-T*y)*e,(E*x-T*w)*e),p.set((S*v-C*_)*e,(S*y-C*b)*e,(S*w-C*x)*e)}f[3*n+0]+=u.x,f[3*n+1]+=u.y,f[3*n+2]+=u.z,f[3*r+0]+=u.x,f[3*r+1]+=u.y,f[3*r+2]+=u.z,f[3*g+0]+=u.x,f[3*g+1]+=u.y,f[3*g+2]+=u.z,m[3*n+0]+=p.x,m[3*n+1]+=p.y,m[3*n+2]+=p.z,m[3*r+0]+=p.x,m[3*r+1]+=p.y,m[3*r+2]+=p.z,m[3*g+0]+=p.x,m[3*g+1]+=p.y,m[3*g+2]+=p.z}const _=new ys,v=new ys,b=new ys,y=new ys;for(let e=0;e<r;e++){b.set(t[3*e],t[3*e+1],t[3*e+2]),_.set(f[3*e],f[3*e+1],f[3*e+2]),v.set(m[3*e],m[3*e+1],m[3*e+2]);const s=b.dot(_);y.copy(b).mulScalar(s),y.sub2(_,y).normalize(),g[4*e]=y.x,g[4*e+1]=y.y,g[4*e+2]=y.z,y.cross(b,_),g[4*e+3]=y.dot(v)<0?-1:1}return g};class Nd{constructor(){this.positions=void 0,this.normals=void 0,this.colors=void 0,this.uvs=void 0,this.uvs1=void 0,this.blendIndices=void 0,this.blendWeights=void 0,this.tangents=void 0,this.indices=void 0}calculateNormals(){this.normals=Bd(this.positions,this.indices)}calculateTangents(){this.tangents=zd(this.positions,this.normals,this.uvs,this.indices)}}const Ud=4/64;class Vd extends Nd{constructor(e={}){var t,s,i,n,r;super();const a=null!=(t=e.halfExtents)?t:new ys(.5,.5,.5),o=null!=(s=e.widthSegments)?s:1,l=null!=(i=e.lengthSegments)?i:1,h=null!=(n=e.heightSegments)?n:1,c=null!=(r=e.yOffset)?r:0,d=-a.y+c,u=a.y+c,p=[new ys(-a.x,d,a.z),new ys(a.x,d,a.z),new ys(a.x,u,a.z),new ys(-a.x,u,a.z),new ys(a.x,d,-a.z),new ys(-a.x,d,-a.z),new ys(-a.x,u,-a.z),new ys(a.x,u,-a.z)],f=[[0,1,3],[4,5,7],[3,2,6],[1,0,4],[1,4,2],[5,0,6]],m=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],g=1,_=2,v=3,b=4,y=5,x=[],w=[],S=[],C=[];let T=0;const E=(e,t,s)=>{const i=new ys,n=new ys,r=new ys,a=new ys;for(let o=0;o<=t;o++)for(let l=0;l<=s;l++){i.lerp(p[f[e][0]],p[f[e][1]],o/t),n.lerp(p[f[e][0]],p[f[e][2]],l/s),r.sub2(n,p[f[e][0]]),a.add2(i,r);let h=o/t,c=l/s;x.push(a.x,a.y,a.z),w.push(m[e][0],m[e][1],m[e][2]),S.push(h,1-c),h=.875*h+Ud,c=.875*c+Ud,h/=3,c/=3,h+=e%3/3,c+=Math.floor(e/3)/3,o<t&&l<s&&(C.push(T+s+1,T+1,T),C.push(T+s+1,T+s+2,T+1)),T++}};E(0,o,h),E(g,o,h),E(_,o,l),E(v,o,l),E(b,l,h),E(y,l,h),this.positions=x,this.normals=w,this.uvs=S,this.uvs1=S,this.indices=C,e.calculateTangents&&(this.tangents=zd(x,w,S,C))}}class Gd extends Nd{constructor(e={}){var t,s,i;super();const n=null!=(t=e.radius)?t:.5,r=null!=(s=e.latitudeBands)?s:16,a=null!=(i=e.longitudeBands)?i:16,o=[],l=[],h=[],c=[];for(let e=0;e<=r;e++){const t=e*Math.PI/r,s=Math.sin(t),i=Math.cos(t);for(let t=0;t<=a;t++){const c=2*t*Math.PI/a-Math.PI/2,d=Math.sin(c),u=Math.cos(c)*s,p=i,f=d*s,m=1-t/a,g=1-e/r;o.push(u*n,p*n,f*n),l.push(u,p,f),h.push(m,1-g)}}for(let e=0;e<r;++e)for(let t=0;t<a;++t){const s=e*(a+1)+t,i=s+a+1;c.push(s+1,i,s),c.push(s+1,i+1,i)}this.positions=o,this.normals=l,this.uvs=h,this.uvs1=h,this.indices=c,e.calculateTangents&&(this.tangents=zd(o,l,h,c))}}class Hd extends Gd{constructor(e={}){var t,s;const i=.5;super({radius:i,latitudeBands:null!=(t=e.latitudeBands)?t:16,longitudeBands:null!=(s=e.longitudeBands)?s:16});const n=this.positions;for(let e=0;e<n.length;e+=3){const t=n[e]/i;let s=n[e+1]/i;const r=n[e+2]/i;s<0&&(s*=.3,t*t+r*r<.9025&&(s=-.1)),s+=.1,s*=i,n[e+1]=s}}}class jd{static create(e,t){switch(t){case"box":return jd.box(e);case sl:return jd.dome(e)}return jd.infinite(e)}static infinite(e){return Dl.fromGeometry(e,new Vd(e))}static box(e){return Dl.fromGeometry(e,new Vd({yOffset:.5}))}static dome(e){const t=new Hd({latitudeBands:50,longitudeBands:50});return t.normals=void 0,t.uvs=void 0,Dl.fromGeometry(e,t)}}class Wd{constructor(e,t,s,i,n){this.meshInstance=null;const r=new Rd;r.name="SkyMaterial",r.getShaderVariant=function(t){const{scene:s,cameraShaderParams:r}=t,a={defines:gl(this,r),pass:t.pass,encoding:i.encoding,gamma:r.shaderOutputGamma,toneMapping:r.toneMapping,skymesh:n};i.cubemap?(a.type="cubemap",a.mip=s.skyboxMip):a.type="envAtlas";const o=new ol(t.viewUniformFormat,t.viewBindGroupFormat),l=ul(e);return l.register("skybox",Od),l.getProgram("skybox",a,o)},r.setParameter("skyboxHighlightMultiplier",t.skyboxHighlightMultiplier),i.cubemap?r.setParameter("texture_cubeMap",i):(r.setParameter("texture_envAtlas",i),r.setParameter("mipLevel",t.skyboxMip)),r.cull=2,r.depthWrite=!1;const a=t.layers.getLayerById(2);if(a){const t=jd.create(e,n),i=new Hl(t,r,s);this.meshInstance=i,i.cull=!1,i.pick=!1,a.addMeshInstances([i]),this.skyLayer=a}}destroy(){this.meshInstance&&(this.skyLayer&&this.skyLayer.removeMeshInstances([this.meshInstance]),this.meshInstance.destroy(),this.meshInstance=null)}}class $d{constructor(e){this._type=tl,this._center=new ys(0,1,0),this.skyMesh=null,this.node=new vh("SkyMeshNode"),this.device=e.device,this.scene=e,this.center=new ys(0,1,0),this.centerArray=new Float32Array(3),this.projectedSkydomeCenterId=this.device.scope.resolve("projectedSkydomeCenter")}applySettings(e){var t,s,i,n;this.type=null!=(t=e.skyType)?t:tl,this.node.setLocalPosition(new ys(null!=(s=e.skyMeshPosition)?s:[0,0,0])),this.node.setLocalEulerAngles(new ys(null!=(i=e.skyMeshRotation)?i:[0,0,0])),this.node.setLocalScale(new ys(null!=(n=e.skyMeshScale)?n:[1,1,1])),e.skyCenter&&(this._center=new ys(e.skyCenter))}set type(e){this._type!==e&&(this._type=e,this.scene.updateShaders=!0,this.updateSkyMesh())}get type(){return this._type}set center(e){this._center.copy(e)}get center(){return this._center}updateSkyMesh(){const e=this.scene._getSkyboxTex();e&&(this.resetSkyMesh(),this.skyMesh=new Wd(this.device,this.scene,this.node,e,this.type),this.scene.fire("set:skybox",e))}resetSkyMesh(){var e;null==(e=this.skyMesh)||e.destroy(),this.skyMesh=null}update(){if(this.type!==tl){const{center:e,centerArray:t}=this,s=new ys;this.node.getWorldTransform().transformPoint(e,s),t[0]=s.x,t[1]=s.y,t[2]=s.z,this.projectedSkydomeCenterId.setValue(t)}}}const qd=new vh;qd.worldTransform=As.IDENTITY,qd._dirtyWorld=qd._dirtyNormal=!1;class Xd{constructor(e,t,s){this.material=t,this.layer=s,this.positions=[],this.colors=[],this.mesh=new Dl(e),this.meshInstance=null}addLines(e,t){const s=this.positions,i=e.length;for(let t=0;t<i;t++){const i=e[t];s.push(i.x,i.y,i.z)}const n=this.colors;if(t.length)for(let e=0;e<i;e++){const s=t[e];n.push(s.r,s.g,s.b,s.a)}else for(let e=0;e<i;e++)n.push(t.r,t.g,t.b,t.a)}addLinesArrays(e,t){const s=this.positions;for(let t=0;t<e.length;t+=3)s.push(e[t],e[t+1],e[t+2]);const i=this.colors;if(t.length)for(let e=0;e<t.length;e+=4)i.push(t[e],t[e+1],t[e+2],t[e+3]);else{const s=e.length/3;for(let e=0;e<s;e++)i.push(t.r,t.g,t.b,t.a)}}onPreRender(e,t){this.positions.length>0&&this.material.transparent===t&&(this.mesh.setPositions(this.positions),this.mesh.setColors(this.colors),this.mesh.update(1,!1),this.meshInstance||(this.meshInstance=new Hl(this.mesh,this.material,qd)),e.push(this.meshInstance))}clear(){this.positions.length=0,this.colors.length=0}}class Kd{constructor(e){this.device=e,this.map=new Map}getBatch(e,t){let s=this.map.get(e);return s||(s=new Xd(this.device,e,t),this.map.set(e,s)),s}onPreRender(e,t){this.map.forEach((s=>{s.onPreRender(e,t)}))}clear(){this.map.forEach((e=>e.clear()))}}const Yd=[],Qd=new ys,Jd={uniqueName:"ImmediateLine",vertexCode:"\n\t\tattribute vec3 vertex_position;\n\t\tattribute vec4 vertex_color;\n\t\tuniform mat4 matrix_model;\n\t\tuniform mat4 matrix_viewProjection;\n\t\tvarying vec4 color;\n\t\tvoid main(void) {\n\t\t\tcolor = vertex_color;\n\t\t\tgl_Position = matrix_viewProjection * matrix_model * vec4(vertex_position, 1);\n\t\t}\n\t",fragmentCode:"\n\t\tvarying vec4 color;\n\t\tvoid main(void) {\n\t\t\tgl_FragColor = vec4(gammaCorrectOutput(decodeGamma(color.rgb)), color.a);\n\t\t}\n\t",attributes:{vertex_position:li,vertex_color:pi}};class Zd{constructor(e){this.shaderDescs=new Map,this.device=e,this.quadMesh=null,this.textureShader=null,this.depthTextureShader=null,this.cubeLocalPos=null,this.cubeWorldPos=null,this.batchesMap=new Map,this.allBatches=new Set,this.updatedLayers=new Set,this._materialDepth=null,this._materialNoDepth=null,this.layerMeshInstances=new Map}createMaterial(e){const t=new Rd(Jd);return t.blendType=2,t.depthTest=e,t.update(),t}get materialDepth(){return this._materialDepth||(this._materialDepth=this.createMaterial(!0)),this._materialDepth}get materialNoDepth(){return this._materialNoDepth||(this._materialNoDepth=this.createMaterial(!1)),this._materialNoDepth}getBatch(e,t){let s=this.batchesMap.get(e);s||(s=new Kd(this.device),this.batchesMap.set(e,s)),this.allBatches.add(s);const i=t?this.materialDepth:this.materialNoDepth;return s.getBatch(i,e)}getShaderDesc(e,t){if(!this.shaderDescs.has(e)){const s="\n\t\t\t\tattribute vec2 vertex_position;\n\t\t\t\tuniform mat4 matrix_model;\n\t\t\t\tvarying vec2 uv0;\n\t\t\t\tvoid main(void) {\n\t\t\t\t\tgl_Position = matrix_model * vec4(vertex_position, 0, 1);\n\t\t\t\t\tuv0 = vertex_position.xy + 0.5;\n\t\t\t\t}\n\t\t\t";this.shaderDescs.set(e,{uniqueName:`DebugShader:${e}`,vertexCode:s,fragmentCode:t,attributes:{vertex_position:li}})}return this.shaderDescs.get(e)}getTextureShaderDesc(e){const t=Fd.decodeFunc(e);return this.getShaderDesc(`textureShader-${e}`,`\n\t\t\tvarying vec2 uv0;\n\t\t\tuniform sampler2D colorMap;\n\t\t\tvoid main (void) {\n\t\t\t\tvec3 linearColor = ${t}(texture2D(colorMap, uv0));\n\t\t\t\tgl_FragColor = vec4(gammaCorrectOutput(linearColor), 1);\n\t\t\t}\n\t\t`)}getUnfilterableTextureShaderDesc(){return this.getShaderDesc("textureShaderUnfilterable","\n\t\t\tvarying vec2 uv0;\n\t\t\tuniform highp sampler2D colorMap;\n\t\t\tvoid main (void) {\n\t\t\t\tivec2 uv = ivec2(uv0 * textureSize(colorMap, 0));\n\t\t\t\tgl_FragColor = vec4(texelFetch(colorMap, uv, 0).xyz, 1);\n\t\t\t}\n\t\t")}getDepthTextureShaderDesc(){return this.getShaderDesc("depthTextureShader",`\n\t\t\t${cl.screenDepthPS}\n\t\t\tvarying vec2 uv0;\n\t\t\tvoid main() {\n\t\t\t\tfloat depth = getLinearScreenDepth(getImageEffectUV(uv0)) * camera_params.x;\n\t\t\t\tgl_FragColor = vec4(gammaCorrectOutput(vec3(depth)), 1.0);\n\t\t\t}\n\t\t`)}getQuadMesh(){return this.quadMesh||(this.quadMesh=new Dl(this.device),this.quadMesh.setPositions([-.5,-.5,0,.5,-.5,0,-.5,.5,0,.5,.5,0]),this.quadMesh.update(5)),this.quadMesh}drawMesh(e,t,s,i,n){if(!i){const n=this.getGraphNode(t);i=new Hl(s,e,n)}let r=this.layerMeshInstances.get(n);r||(r=[],this.layerMeshInstances.set(n,r)),r.push(i)}drawWireAlignedBox(e,t,s,i,n,r){if(r){const s=(e,t,s)=>{Qd.set(e,t,s),r.transformPoint(Qd,Qd),Yd.push(Qd.x,Qd.y,Qd.z)};s(e.x,e.y,e.z),s(e.x,t.y,e.z),s(e.x,t.y,e.z),s(t.x,t.y,e.z),s(t.x,t.y,e.z),s(t.x,e.y,e.z),s(t.x,e.y,e.z),s(e.x,e.y,e.z),s(e.x,e.y,t.z),s(e.x,t.y,t.z),s(e.x,t.y,t.z),s(t.x,t.y,t.z),s(t.x,t.y,t.z),s(t.x,e.y,t.z),s(t.x,e.y,t.z),s(e.x,e.y,t.z),s(e.x,e.y,e.z),s(e.x,e.y,t.z),s(e.x,t.y,e.z),s(e.x,t.y,t.z),s(t.x,t.y,e.z),s(t.x,t.y,t.z),s(t.x,e.y,e.z),s(t.x,e.y,t.z)}else Yd.push(e.x,e.y,e.z,e.x,t.y,e.z,e.x,t.y,e.z,t.x,t.y,e.z,t.x,t.y,e.z,t.x,e.y,e.z,t.x,e.y,e.z,e.x,e.y,e.z,e.x,e.y,t.z,e.x,t.y,t.z,e.x,t.y,t.z,t.x,t.y,t.z,t.x,t.y,t.z,t.x,e.y,t.z,t.x,e.y,t.z,e.x,e.y,t.z,e.x,e.y,e.z,e.x,e.y,t.z,e.x,t.y,e.z,e.x,t.y,t.z,t.x,t.y,e.z,t.x,t.y,t.z,t.x,e.y,e.z,t.x,e.y,t.z);this.getBatch(n,i).addLinesArrays(Yd,s),Yd.length=0}drawWireSphere(e,t,s,i,n,r){const a=2*Math.PI/i;let o=0;for(let s=0;s<i;s++){const s=Math.sin(o),i=Math.cos(o);o+=a;const n=Math.sin(o),r=Math.cos(o);Yd.push(e.x+t*s,e.y,e.z+t*i),Yd.push(e.x+t*n,e.y,e.z+t*r),Yd.push(e.x+t*s,e.y+t*i,e.z),Yd.push(e.x+t*n,e.y+t*r,e.z),Yd.push(e.x,e.y+t*s,e.z+t*i),Yd.push(e.x,e.y+t*n,e.z+t*r)}this.getBatch(r,n).addLinesArrays(Yd,s),Yd.length=0}getGraphNode(e){const t=new vh("ImmediateDebug");return t.worldTransform=e,t._dirtyWorld=t._dirtyNormal=!1,t}onPreRenderLayer(e,t,s){if(this.batchesMap.forEach(((i,n)=>{n===e&&i.onPreRender(t,s)})),!this.updatedLayers.has(e)){this.updatedLayers.add(e);const s=this.layerMeshInstances.get(e);if(s){for(let e=0;e<s.length;e++)t.push(s[e]);s.length=0}}}onPostRender(){this.allBatches.forEach((e=>e.clear())),this.allBatches.clear(),this.updatedLayers.clear()}}const eu=2.399963229728653,tu={circlePoint(e){const t=Math.sqrt(Math.random()),s=2*Math.random()*Math.PI;e.x=t*Math.cos(s),e.y=t*Math.sin(s)},circlePointDeterministic(e,t,s){const i=t*eu,n=Math.sqrt(t)/Math.sqrt(s);e.x=n*Math.cos(i),e.y=n*Math.sin(i)},spherePointDeterministic(e,t,s,i=0,n=1){i=1-2*i,n=1-2*n;const r=rs.lerp(i,n,t/s),a=Math.sqrt(1-r*r),o=eu*t;e.x=Math.cos(o)*a,e.y=r,e.z=Math.sin(o)*a},radicalInverse(e){let t=(e<<16|e>>>16)>>>0;return t=((1431655765&t)<<1|(2863311530&t)>>>1)>>>0,t=((858993459&t)<<2|(3435973836&t)>>>2)>>>0,t=((252645135&t)<<4|(4042322160&t)>>>4)>>>0,t=((16711935&t)<<8|(4278255360&t)>>>8)>>>0,2.3283064365386963e-10*t}},su=e=>{switch(e){case zi:return"Cubemap";case"octahedral":return"Octahedral";default:return"Equirect"}},iu=(e,t,s)=>{if(e<=0)t[s+0]=0,t[s+1]=0,t[s+2]=0,t[s+3]=0;else if(e>=1)t[s+0]=255,t[s+1]=0,t[s+2]=0,t[s+3]=0;else{let i=1*e%1,n=255*e%1,r=65025*e%1;const a=16581375*e%1;i-=n/255,n-=r/255,r-=a/255,t[s+0]=Math.min(255,Math.floor(256*i)),t[s+1]=Math.min(255,Math.floor(256*n)),t[s+2]=Math.min(255,Math.floor(256*r)),t[s+3]=Math.min(255,Math.floor(256*a))}},nu=(e,t,s,i)=>{const n=2*s*Math.PI,r=Math.pow(1-t,1/(i+1)),a=Math.sqrt(1-r*r);e.set(Math.cos(n)*a,Math.sin(n)*a,r).normalize()},ru=(e,t,s)=>{const i=2*s*Math.PI,n=Math.sqrt(1-t),r=Math.sqrt(t);e.set(Math.cos(i)*r,Math.sin(i)*r,n).normalize()},au=(e,t,s,i)=>{const n=2*s*Math.PI,r=Math.sqrt((1-t)/(1+(i*i-1)*t)),a=Math.sqrt(1-r*r);e.set(Math.cos(n)*a,Math.sin(n)*a,r).normalize()},ou=(e,t)=>{const s=e*t,i=t/(1-e*e+s*s);return i*i*(1/Math.PI)},lu={16:{2:26,8:20,32:17,128:16,512:16},32:{2:53,8:40,32:34,128:32,512:32},128:{2:214,8:163,32:139,128:130,512:128},1024:{2:1722,8:1310,32:1114,128:1041,512:1025}},hu=(e,t,s)=>{const i=s/e,n=1-Math.log2(t)/11,r=n*n,a=new ys,o=new ys,l=new ys(0,0,1),h=[],c=((e,t)=>{const s=lu[e];return s&&s[t]||e})(e,t);for(let e=0;e<c;++e){au(a,e/c,tu.radicalInverse(e),r);const t=a.z;if(o.set(a.x,a.y,a.z).mulScalar(2*t).sub(l),o.z>0){const e=ou(Math.min(1,t),r)/4+.001,s=.5*Math.log2(i/e);h.push(o.x,o.y,o.z,s)}}for(;h.length<4*e;)h.push(0,0,0,0);return h},cu=(e,t,s)=>{const i=(e=>{const t=e.length,s=Math.min(t,512),i=Math.ceil(t/s),n=new Uint8Array(s*i*4);let r=0;for(let s=0;s<t;s+=4)iu(.5*e[s+0]+.5,n,r+0),iu(.5*e[s+1]+.5,n,r+4),iu(.5*e[s+2]+.5,n,r+8),iu(e[s+3]/8,n,r+12),r+=16;return{width:s,height:i,data:n}})(s);return new yn(e,{name:t,width:i.width,height:i.height,mipmaps:!1,minFilter:0,magFilter:0,levels:[i.data]})};class du{constructor(e=!0){this.map=new Map,this.destroyContent=e}destroy(){this.destroyContent&&this.map.forEach(((e,t)=>{e.destroy()}))}get(e,t){if(!this.map.has(e)){const s=t();return this.map.set(e,s),s}return this.map.get(e)}}const uu=new du(!1),pu=new _n,fu=(e,t,s)=>pu.get(e,(()=>new du)).get(t,(()=>cu(e,t,uu.get(t,s)))),mu=(e,t,s)=>fu(e,`lambert-samples-${t}-${s}`,(()=>((e,t)=>{const s=t/e,i=new ys,n=[];for(let t=0;t<e;++t){ru(i,t/e,tu.radicalInverse(t));const r=i.z/Math.PI,a=.5*Math.log2(s/r);n.push(i.x,i.y,i.z,a)}return n})(t,s))),gu=(e,t,s)=>fu(e,`phong-samples-${t}-${s}`,(()=>((e,t)=>{const s=new ys,i=[];for(let n=0;n<e;++n)nu(s,n/e,tu.radicalInverse(n),t),i.push(s.x,s.y,s.z,0);return i})(t,s)));function _u(e,t,s={}){var i,n,r,a,o;const l=null!=(i=s.seamPixels)?i:0,h=(null!=(n=null==(r=s.rect)?void 0:r.z)?n:t.width)-2*l,c=(null!=(a=null==(o=s.rect)?void 0:o.w)?a:t.height)-2*l;if(h<1||c<1)return!1;const d=s.hasOwnProperty("specularPower")?s.specularPower:1,u=s.hasOwnProperty("face")?s.face:null,p=s.hasOwnProperty("distribution")?s.distribution:1===d?"none":"phong",f={none:"reproject",lambert:"prefilterSamplesUnweighted",phong:"prefilterSamplesUnweighted",ggx:"prefilterSamples"}[p]||"reproject",m=f.startsWith("prefilterSamples"),g=Fd.decodeFunc(e.encoding),_=Fd.encodeFunc(t.encoding),v=`sample${su(e.projection)}`,b=`getDirection${su(t.projection)}`,y=s.hasOwnProperty("numSamples")?s.numSamples:1024,x=`${f}_${g}_${_}_${v}_${b}_${y}`,w=e.device;let S=ul(w).getCachedShader(x);if(!S){S=fl(w,"\nattribute vec2 vertex_position;\n\nuniform vec4 uvMod;\n\nvarying vec2 vUv0;\n\nvoid main(void) {\n\t\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\t\tvUv0 = getImageEffectUV((vertex_position.xy * 0.5 + 0.5) * uvMod.xy + uvMod.zw);\n}\n",`${`#define PROCESS_FUNC ${f}\n${m?"#define USE_SAMPLES_TEX\n":""}${e.cubemap?"#define CUBEMAP_SOURCE\n":""}#define DECODE_FUNC ${g}\n#define ENCODE_FUNC ${_}\n#define SOURCE_FUNC ${v}\n#define TARGET_FUNC ${b}\n#define NUM_SAMPLES ${y}\n#define NUM_SAMPLES_SQRT ${Math.round(Math.sqrt(y)).toFixed(1)}\n`}\n${cl.reprojectPS}`,x)}w.setBlendState(Rn.NOBLEND);w.scope.resolve(e.cubemap?"sourceCube":"sourceTex").setValue(e);const C=w.scope.resolve("params"),T=w.scope.resolve("uvMod");l>0?T.setValue([(h+2*l)/h,(c+2*l)/c,-l/h,-l/c]):T.setValue([1,1,0,0]);const E=[0,t.width*t.height*(t.cubemap?6:1),e.width*e.height*(e.cubemap?6:1)];if(m){const t=e.width*e.height*(e.cubemap?6:1),s="ggx"===p?((e,t,s,i)=>fu(e,`ggx-samples-${t}-${s}-${i}`,(()=>hu(t,s,i))))(w,y,d,t):"lambert"===p?mu(w,y,t):gu(w,y,d);w.scope.resolve("samplesTex").setValue(s),w.scope.resolve("samplesTexInverseSize").setValue([1/s.width,1/s.height])}for(let e=0;e<(t.cubemap?6:1);e++)if(null===u||e===u){const i=new tr({colorBuffer:t,face:e,depth:!1,flipY:w.isWebGPU});E[0]=e,C.setValue(E),Cl(w,i,S,null==s?void 0:s.rect),i.destroy()}return!0}const vu=(e,t=0)=>1+Math.floor(Math.log2(Math.max(e,t)));class bu{static generateSkyboxCubemap(e,t){const s=((e,t,s,i)=>new yn(e,{name:`lighting-${t}`,cubemap:!0,width:t,height:t,format:s,type:Ri,addressU:1,addressV:1,mipmaps:!!i}))(e.device,t||(e.cubemap?e.width:e.width/4),7,!1);return _u(e,s,{numSamples:1024}),s}static generateLightingSource(e,t){const s=e.device,i=(e=>(e=>e.textureHalfFloatRenderable)(e)?Ws:(e=>e.textureFloatRenderable)(e)?$s:7)(s),n=(null==t?void 0:t.target)||new yn(s,{name:"lighting-source",cubemap:!0,width:(null==t?void 0:t.size)||128,height:(null==t?void 0:t.size)||128,format:i,type:7===i?Ri:Ai,addressU:1,addressV:1,mipmaps:!0});return _u(e,n,{numSamples:e.mipmaps?1:1024}),n}static generateAtlas(e,t){const s=e.device,i=(null==t?void 0:t.target)||new yn(s,{name:"envAtlas",width:(null==t?void 0:t.size)||512,height:(null==t?void 0:t.size)||512,format:7,type:Ri,projection:Ni,addressU:1,addressV:1,mipmaps:!1}),n=i.width/512,r=new Ss(0,0,512*n,256*n),a=vu(256)-vu(4);for(let t=0;t<a;++t)_u(e,i,{numSamples:1,rect:r,seamPixels:n}),r.x+=r.w,r.y+=r.w,r.z=Math.max(1,Math.floor(.5*r.z)),r.w=Math.max(1,Math.floor(.5*r.w));r.set(0,256*n,256*n,128*n);for(let s=1;s<7;++s)_u(e,i,{numSamples:(null==t?void 0:t.numReflectionSamples)||1024,distribution:(null==t?void 0:t.distribution)||"ggx",specularPower:Math.max(1,2048>>2*s),rect:r,seamPixels:n}),r.y+=r.w,r.z=Math.max(1,Math.floor(.5*r.z)),r.w=Math.max(1,Math.floor(.5*r.w));return r.set(128*n,384*n,64*n,32*n),_u(e,i,{numSamples:(null==t?void 0:t.numAmbientSamples)||2048,distribution:"lambert",rect:r,seamPixels:n}),i}static generatePrefilteredAtlas(e,t){const s=e[0].device,i=e[0].format,n=e[0].type,r=(null==t?void 0:t.target)||new yn(s,{name:"envPrefilteredAtlas",width:(null==t?void 0:t.size)||512,height:(null==t?void 0:t.size)||512,format:i,type:n,projection:Ni,addressU:1,addressV:1,mipmaps:!1}),a=r.width/512,o=new Ss(0,0,512*a,256*a),l=vu(512);for(let t=0;t<l;++t)_u(e[0],r,{numSamples:1,rect:o,seamPixels:a}),o.x+=o.w,o.y+=o.w,o.z=Math.max(1,Math.floor(.5*o.z)),o.w=Math.max(1,Math.floor(.5*o.w));o.set(0,256*a,256*a,128*a);for(let t=1;t<e.length;++t)_u(e[t],r,{numSamples:1,rect:o,seamPixels:a}),o.y+=o.w,o.z=Math.max(1,Math.floor(.5*o.z)),o.w=Math.max(1,Math.floor(.5*o.w));return o.set(128*a,384*a,64*a,32*a),null!=t&&t.legacyAmbient?_u(e[5],r,{numSamples:1,rect:o,seamPixels:a}):_u(e[0],r,{numSamples:(null==t?void 0:t.numSamples)||2048,distribution:"lambert",rect:o,seamPixels:a}),r}}class yu{constructor(){this.type=jo,this.color=new os(0,0,0),this.density=0,this.start=1,this.end=1e3}}class xu extends Kt{constructor(e){super(),this.ambientBake=!1,this.ambientBakeOcclusionBrightness=0,this.ambientBakeOcclusionContrast=0,this.ambientLight=new os(0,0,0),this.ambientLuminance=0,this.exposure=1,this.lightmapSizeMultiplier=1,this.lightmapMaxResolution=2048,this.lightmapMode=1,this.lightmapFilterEnabled=!1,this.lightmapHDR=!1,this.root=null,this.physicalUnits=!1,this._envAtlas=null,this._skyboxCubeMap=null,this._fogParams=new yu,this.device=e,this._gravity=new ys(0,-9.8,0),this._layers=null,this._prefilteredCubemaps=[],this._internalEnvAtlas=null,this._skyboxIntensity=1,this._skyboxLuminance=0,this._skyboxMip=0,this._skyboxHighlightMultiplier=1,this._skyboxRotationShaderInclude=!1,this._skyboxRotation=new Ds,this._skyboxRotationMat3=new xs,this._skyboxRotationMat4=new As,this._ambientBakeNumSamples=1,this._ambientBakeSpherePart=.4,this._lightmapFilterRange=10,this._lightmapFilterSmoothness=.2,this._clusteredLightingEnabled=!0,this._lightingParams=new Td(this.device.supportsAreaLights,this.device.maxTextureSize,(()=>{this.updateShaders=!0})),this._sky=new $d(this),this._stats={meshInstances:0,lights:0,dynamicLights:0,bakedLights:0,updateShadersTime:0},this.updateShaders=!0,this._shaderVersion=0,this.immediate=new Zd(this.device)}get defaultDrawLayer(){return this.layers.getLayerById(3)}set ambientBakeNumSamples(e){this._ambientBakeNumSamples=rs.clamp(Math.floor(e),1,255)}get ambientBakeNumSamples(){return this._ambientBakeNumSamples}set ambientBakeSpherePart(e){this._ambientBakeSpherePart=rs.clamp(e,.001,1)}get ambientBakeSpherePart(){return this._ambientBakeSpherePart}set clusteredLightingEnabled(e){this.device.isWebGPU&&!e||(this._clusteredLightingEnabled||!e?this._clusteredLightingEnabled=e:console.error("Turning on disabled clustered lighting is not currently supported"))}get clusteredLightingEnabled(){return this._clusteredLightingEnabled}set envAtlas(e){e!==this._envAtlas&&(this._envAtlas=e,e&&(e.addressU=1,e.addressV=1,e.minFilter=1,e.magFilter=1,e.mipmaps=!1),this._prefilteredCubemaps=[],this._internalEnvAtlas&&(this._internalEnvAtlas.destroy(),this._internalEnvAtlas=null),this._resetSkyMesh())}get envAtlas(){return this._envAtlas}set layers(e){const t=this._layers;this._layers=e,this.fire("set:layers",t,e)}get layers(){return this._layers}get sky(){return this._sky}get lighting(){return this._lightingParams}get fog(){return this._fogParams}set lightmapFilterRange(e){this._lightmapFilterRange=Math.max(e,.001)}get lightmapFilterRange(){return this._lightmapFilterRange}set lightmapFilterSmoothness(e){this._lightmapFilterSmoothness=Math.max(e,.001)}get lightmapFilterSmoothness(){return this._lightmapFilterSmoothness}set prefilteredCubemaps(e){e=e||[];const t=this._prefilteredCubemaps,s=t.length!==e.length||t.some(((t,s)=>t!==e[s]));if(s){const t=6===e.length&&e.every((e=>!!e));t?(this._internalEnvAtlas=bu.generatePrefilteredAtlas(e,{target:this._internalEnvAtlas}),this._envAtlas=this._internalEnvAtlas):(this._internalEnvAtlas&&(this._internalEnvAtlas.destroy(),this._internalEnvAtlas=null),this._envAtlas=null),this._prefilteredCubemaps=e.slice(),this._resetSkyMesh()}}get prefilteredCubemaps(){return this._prefilteredCubemaps}set skybox(e){e!==this._skyboxCubeMap&&(this._skyboxCubeMap=e,this._resetSkyMesh())}get skybox(){return this._skyboxCubeMap}set skyboxIntensity(e){e!==this._skyboxIntensity&&(this._skyboxIntensity=e,this._resetSkyMesh())}get skyboxIntensity(){return this._skyboxIntensity}set skyboxLuminance(e){e!==this._skyboxLuminance&&(this._skyboxLuminance=e,this._resetSkyMesh())}get skyboxLuminance(){return this._skyboxLuminance}set skyboxMip(e){e!==this._skyboxMip&&(this._skyboxMip=e,this._resetSkyMesh())}get skyboxMip(){return this._skyboxMip}set skyboxHighlightMultiplier(e){e!==this._skyboxHighlightMultiplier&&(this._skyboxHighlightMultiplier=e,this._resetSkyMesh())}get skyboxHighlightMultiplier(){return this._skyboxHighlightMultiplier}set skyboxRotation(e){if(!this._skyboxRotation.equals(e)){const t=e.equals(Ds.IDENTITY);this._skyboxRotation.copy(e),t?this._skyboxRotationMat3.setIdentity():(this._skyboxRotationMat4.setTRS(ys.ZERO,e,ys.ONE),this._skyboxRotationMat3.invertMat4(this._skyboxRotationMat4)),this._skyboxRotationShaderInclude||t||(this._skyboxRotationShaderInclude=!0,this._resetSkyMesh())}}get skyboxRotation(){return this._skyboxRotation}destroy(){this._resetSkyMesh(),this.root=null,this.off()}drawLine(e,t,s=os.WHITE,i=!0,n=this.defaultDrawLayer){this.immediate.getBatch(n,i).addLines([e,t],[s,s])}drawLines(e,t,s=!0,i=this.defaultDrawLayer){this.immediate.getBatch(i,s).addLines(e,t)}drawLineArrays(e,t,s=!0,i=this.defaultDrawLayer){this.immediate.getBatch(i,s).addLinesArrays(e,t)}applySettings(e){var t,s,i,n;const r=e.physics,a=e.render;this._gravity.set(r.gravity[0],r.gravity[1],r.gravity[2]),this.ambientLight.set(a.global_ambient[0],a.global_ambient[1],a.global_ambient[2]),this.ambientLuminance=a.ambientLuminance,this.fog.type=a.fog,this.fog.color.set(a.fog_color[0],a.fog_color[1],a.fog_color[2]),this.fog.start=a.fog_start,this.fog.end=a.fog_end,this.fog.density=a.fog_density,this.lightmapSizeMultiplier=a.lightmapSizeMultiplier,this.lightmapMaxResolution=a.lightmapMaxResolution,this.lightmapMode=a.lightmapMode,this.exposure=a.exposure,this._skyboxIntensity=null!=(t=a.skyboxIntensity)?t:1,this._skyboxLuminance=null!=(s=a.skyboxLuminance)?s:2e4,this._skyboxMip=null!=(i=a.skyboxMip)?i:0,a.skyboxRotation&&(this.skyboxRotation=(new Ds).setFromEulerAngles(a.skyboxRotation[0],a.skyboxRotation[1],a.skyboxRotation[2])),this.sky.applySettings(a),this.clusteredLightingEnabled=null!=(n=a.clusteredLightingEnabled)&&n,this.lighting.applySettings(a),["lightmapFilterEnabled","lightmapFilterRange","lightmapFilterSmoothness","ambientBake","ambientBakeNumSamples","ambientBakeSpherePart","ambientBakeOcclusionBrightness","ambientBakeOcclusionContrast"].forEach((e=>{a.hasOwnProperty(e)&&(this[e]=a[e])})),this._resetSkyMesh()}_getSkyboxTex(){const e=this._prefilteredCubemaps;if(this._skyboxMip){return e[[0,1,3,4,5,6][this._skyboxMip]]||this._envAtlas||e[0]||this._skyboxCubeMap}return this._skyboxCubeMap||e[0]||this._envAtlas}_updateSkyMesh(){this.sky.skyMesh||this.sky.updateSkyMesh(),this.sky.update()}_resetSkyMesh(){this.sky.resetSkyMesh(),this.updateShaders=!0}setSkybox(e){e?(this.skybox=e[0]||null,e[1]&&!e[1].cubemap?this.envAtlas=e[1]:this.prefilteredCubemaps=e.slice(1)):(this.skybox=null,this.envAtlas=null)}get lightmapPixelFormat(){return this.lightmapHDR&&this.device.getRenderableHdrFormat()||7}}xu.EVENT_SETLAYERS="set:layers",xu.EVENT_SETSKYBOX="set:skybox",xu.EVENT_PRERENDER="prerender",xu.EVENT_POSTRENDER="postrender",xu.EVENT_PRERENDER_LAYER="prerender:layer",xu.EVENT_POSTRENDER_LAYER="postrender:layer",xu.EVENT_PRECULL="precull",xu.EVENT_POSTCULL="postcull";class wu{constructor(e,t,s){this.device=e,this.inverseBindPose=t,this.boneNames=s}}class Su{constructor(){this.hasTangents=!1,this.chunks={},this.pass=0,this.alphaTest=!1,this.blendType=3,this.separateAmbient=!1,this.screenSpace=!1,this.skin=!1,this.batch=!1,this.useInstancing=!1,this.useMorphPosition=!1,this.useMorphNormal=!1,this.useMorphTextureBasedInt=!1,this.nineSlicedMode=0,this.clusteredLightingEnabled=!0,this.clusteredLightingCookiesEnabled=!1,this.clusteredLightingShadowsEnabled=!1,this.clusteredLightingShadowType=0,this.clusteredLightingAreaLightsEnabled=!1,this.vertexColors=!1,this.lightMapEnabled=!1,this.dirLightMapEnabled=!1,this.useHeights=!1,this.useNormals=!1,this.useClearCoatNormals=!1,this.useAo=!1,this.diffuseMapEnabled=!1,this.customFragmentShader=null,this.pixelSnap=!1,this.ambientSH=!1,this.ssao=!1,this.twoSidedLighting=!1,this.occludeDirect=!1,this.occludeSpecular=0,this.occludeSpecularFloat=!1,this.useMsdf=!1,this.msdfTextAttribute=!1,this.alphaToCoverage=!1,this.opacityFadesSpecular=!1,this.opacityDither=il,this.opacityShadowDither=il,this.cubeMapProjection=0,this.useSpecular=!1,this.useSpecularityFactor=!1,this.enableGGXSpecular=!1,this.fresnelModel=0,this.useRefraction=!1,this.useClearCoat=!1,this.useSheen=!1,this.useIridescence=!1,this.useMetalness=!1,this.useDynamicRefraction=!1,this.dispersion=!1,this.fog=jo,this.gamma=0,this.toneMap=-1,this.reflectionSource=null,this.reflectionEncoding=null,this.reflectionCubemapEncoding=null,this.ambientSource="constant",this.ambientEncoding=null,this.skyboxIntensity=1,this.useCubeMapRotation=!1,this.lightMapWithoutAmbient=!1,this.lights=[],this.noShadow=!1,this.lightMaskDynamic=0,this.userAttributes={},this.linearDepth=!1}}class Cu{static update(e,t,s,i,n,r,a){Cu.updateSharedOptions(e,t,s,n,r),Cu.updateMaterialOptions(e,t),Cu.updateEnvOptions(e,t,s,i),Cu.updateLightingOptions(e,t,n,a)}static updateSharedOptions(e,t,s,i,n){e.chunks=t.chunks,e.pass=n,e.alphaTest=t.alphaTest>0,e.blendType=t.blendType,e.screenSpace=i&&!!(i&Ko),e.skin=i&&!!(2&i),e.useInstancing=i&&!!(32&i),e.useMorphPosition=i&&!!(i&Yo),e.useMorphNormal=i&&!!(i&Qo),e.useMorphTextureBasedInt=i&&!!(i&Zo),e.hasTangents=i&&!!(512&i),e.nineSlicedMode=t.nineSlicedMode||0,t.useLighting&&s.clusteredLightingEnabled?(e.clusteredLightingEnabled=!0,e.clusteredLightingCookiesEnabled=s.lighting.cookiesEnabled,e.clusteredLightingShadowsEnabled=s.lighting.shadowsEnabled,e.clusteredLightingShadowType=s.lighting.shadowType,e.clusteredLightingAreaLightsEnabled=s.lighting.areaLightsEnabled):(e.clusteredLightingEnabled=!1,e.clusteredLightingCookiesEnabled=!1,e.clusteredLightingShadowsEnabled=!1,e.clusteredLightingAreaLightsEnabled=!1)}static updateMaterialOptions(e,t){e.separateAmbient=!1,e.customFragmentShader=null,e.pixelSnap=t.pixelSnap,e.ambientSH=t.ambientSH,e.twoSidedLighting=t.twoSidedLighting,e.occludeDirect=t.occludeDirect,e.occludeSpecular=t.occludeSpecular,e.occludeSpecularFloat=1!==t.occludeSpecularIntensity,e.useMsdf=!1,e.msdfTextAttribute=!1,e.alphaToCoverage=t.alphaToCoverage,e.opacityFadesSpecular=t.opacityFadesSpecular,e.opacityDither=t.opacityDither,e.cubeMapProjection=0,e.useSpecular=t.hasSpecular,e.useSpecularityFactor=t.hasSpecularityFactor,e.enableGGXSpecular=t.ggxSpecular,e.fresnelModel=t.fresnelModel,e.useRefraction=t.hasRefraction,e.useClearCoat=t.hasClearCoat,e.useSheen=t.hasSheen,e.useIridescence=t.hasIrridescence,e.useMetalness=t.hasMetalness,e.useDynamicRefraction=t.dynamicRefraction,e.dispersion=t.dispersion>0,e.vertexColors=!1,e.lightMapEnabled=t.hasLighting,e.dirLightMapEnabled=t.dirLightMap,e.useHeights=t.hasHeights,e.useNormals=t.hasNormals,e.useClearCoatNormals=t.hasClearCoatNormals,e.useAo=t.hasAo,e.diffuseMapEnabled=t.hasDiffuseMap}static updateEnvOptions(e,t,s,i){e.fog=t.useFog?i.fog:jo,e.gamma=i.shaderOutputGamma,e.toneMap=t.useTonemap?i.toneMapping:6,t.useSkybox&&s.envAtlas&&s.skybox?(e.reflectionSource="envAtlasHQ",e.reflectionEncoding=s.envAtlas.encoding,e.reflectionCubemapEncoding=s.skybox.encoding):t.useSkybox&&s.envAtlas?(e.reflectionSource="envAtlas",e.reflectionEncoding=s.envAtlas.encoding):t.useSkybox&&s.skybox?(e.reflectionSource="cubeMap",e.reflectionEncoding=s.skybox.encoding):(e.reflectionSource=null,e.reflectionEncoding=null),t.ambientSH?(e.ambientSource="ambientSH",e.ambientEncoding=null):e.reflectionSource&&s.envAtlas?(e.ambientSource="envAtlas",e.ambientEncoding=s.envAtlas.encoding):(e.ambientSource="constant",e.ambientEncoding=null);const n=!!e.reflectionSource;e.skyboxIntensity=n,e.useCubeMapRotation=n&&s._skyboxRotationShaderInclude}static updateLightingOptions(e,t,s,i){if(e.lightMapWithoutAmbient=!1,t.useLighting){const t=[],n=s?s>>16:1;e.lightMaskDynamic=!!(1&n),e.lightMapWithoutAmbient=!1,i&&(Cu.collectLights(0,i[0],t,n),Cu.collectLights(1,i[1],t,n),Cu.collectLights(2,i[2],t,n)),e.lights=t}else e.lights=[];(0===e.lights.length||1&s)&&(e.noShadow=!0)}static collectLights(e,t,s,i){for(let e=0;e<t.length;e++){const n=t[e];n.enabled&&n.mask&i&&s.push(n)}}}class Tu{constructor(){this.code=""}append(...e){e.forEach((e=>{e.endsWith("\n")?this.code+=e:this.code+=`${e}\n`}))}prepend(...e){e.forEach((e=>{e.endsWith("\n")?this.code=e+this.code:this.code=`${e}\n${this.code}`}))}}const Eu={vertex_normal:hi,vertex_tangent:ci,vertex_texCoord0:mi,vertex_texCoord1:gi,vertex_color:pi,vertex_boneWeights:di,vertex_boneIndices:ui},Pu={vVertexColor:"vec4",vPositionW:"vec3",vNormalV:"vec3",vNormalW:"vec3",vTangentW:"vec3",vBinormalW:"vec3",vObjectSpaceUpW:"vec3",vUv0:"vec2",vUv1:"vec2",vLinearDepth:"float"};class ku{constructor(e,t){if(this.device=e,this.options=t,this.attributes={vertex_position:li},t.userAttributes)for(const[e,s]of Object.entries(t.userAttributes))this.attributes[s]=e;if(t.chunks){const e=t.chunks;this.chunks=Object.create(cl);for(const t in cl)if(e.hasOwnProperty(t)){const s=e[t];for(const e in Eu)Eu.hasOwnProperty(e)&&s.indexOf(e)>=0&&(this.attributes[e]=Eu[e]);this.chunks[t]=s}}else this.chunks=cl;this.shaderPassInfo=mc.get(this.device).getByIndex(t.pass),this.shadowPass=this.shaderPassInfo.isShadow,this.lighting=t.lights.length>0||t.dirLightMapEnabled||t.clusteredLightingEnabled,this.reflections=!!t.reflectionSource,this.needsNormal=this.lighting||this.reflections||t.useSpecular||t.ambientSH||t.useHeights||t.enableGGXSpecular||t.clusteredLightingEnabled&&!this.shadowPass||t.useClearCoatNormals,this.needsNormal=this.needsNormal&&!this.shadowPass,this.needsSceneColor=t.useDynamicRefraction,this.needsScreenSize=t.useDynamicRefraction,this.needsTransforms=t.useDynamicRefraction,this.varyings="",this.varyingDefines="",this.vshader=null,this.frontendDecl=null,this.frontendCode=null,this.frontendFunc=null,this.lightingUv=null,this.defines=[],this.fshader=null}_vsAddBaseCode(e,t,s){return e+=t.baseVS,1!==s.nineSlicedMode&&2!==s.nineSlicedMode||(e+=t.baseNineSlicedVS),e}_setMapTransform(e,t,s,i){const n=s+100*i;if(!e[3][n]){const r=`texture_${t}MapTransform`;e[0]+=`uniform vec3 ${r}0;\n`,e[0]+=`uniform vec3 ${r}1;\n`,e[1]+=`varying vec2 vUV${i}_${s};\n`,e[2]+=`   vUV${i}_${s} = vec2(dot(vec3(uv${i}, 1), ${r}0), dot(vec3(uv${i}, 1), ${r}1));\n`,e[3][n]=!0}return e}_fsGetBaseCode(){const e=this.options,t=this.chunks;let s=this.chunks.basePS;return 1===e.nineSlicedMode?s+=t.baseNineSlicedPS:2===e.nineSlicedMode&&(s+=t.baseNineSlicedTiledPS),s}_fsGetStartCode(e,t,s,i){let n=s.startPS;return 1===i.nineSlicedMode?n+=s.startNineSlicedPS:2===i.nineSlicedMode&&(n+=s.startNineSlicedTiledPS),n}_getLightSourceShapeString(e){switch(e){case 1:return"Rect";case 2:return"Disk";case 3:return"Sphere";default:return""}}generateVertexShader(e,t,s){const i=this.device,n=this.options,r=this.chunks;let a="",o="",l="";a=this._vsAddBaseCode(a,r,n),o+="   vPositionW = getWorldPosition();\n",this.options.linearDepth&&(l+="\n\t\t\t\t\t\t\t\t#ifndef VIEWMATRIX\n\t\t\t\t\t\t\t\t#define VIEWMATRIX\n\t\t\t\t\t\t\t\t\t\tuniform mat4 matrix_view;\n\t\t\t\t\t\t\t\t#endif\n\t\t\t\t\t\t",o+="\n\t\t\t\t\t\t\t\t// linear depth from the worldPosition, see getLinearDepth\n\t\t\t\t\t\t\t\tvLinearDepth = -(matrix_view * vec4(vPositionW, 1.0)).z;\n\t\t\t\t\t\t"),this.options.useInstancing&&this.chunks.transformInstancingVS===cl.transformInstancingVS&&(this.attributes.instance_line1=Ti,this.attributes.instance_line2=Ei,this.attributes.instance_line3=Pi,this.attributes.instance_line4=ki),a+=r.transformVS,this.needsNormal&&(a+=r.normalCoreVS,a+=r.normalVS),this.needsNormal&&(this.attributes.vertex_normal=hi,o+="   vNormalW = getNormal();\n","sphereMap"===n.reflectionSource&&i.fragmentUniformsCount<=16&&(a+=r.viewNormalVS,o+="   vNormalV    = getViewNormal();\n"),n.hasTangents&&(n.useHeights||n.useNormals||n.enableGGXSpecular)?(this.attributes.vertex_tangent=ci,a+=r.tangentBinormalVS,o+="   vTangentW   = getTangent();\n",o+="   vBinormalW  = getBinormal();\n"):n.enableGGXSpecular&&(o+="   vObjectSpaceUpW = normalize(dNormalMatrix * vec3(0, 1, 0));\n"));for(let s=0;s<2;s++)e[s]&&(this.attributes[`vertex_texCoord${s}`]=`TEXCOORD${s}`,a+=r[`uv${s}VS`],o+=`   vec2 uv${s} = getUv${s}();\n`),t[s]&&(o+=`   vUv${s} = uv${s};\n`);const h=[a,this.varyings,o,[]];s.forEach((e=>{this._setMapTransform(h,e.name,e.id,e.uv)})),a=h[0],this.varyings=h[1],o=h[2],n.vertexColors&&(this.attributes.vertex_color=pi,o+="   vVertexColor = vertex_color;\n"),n.useMsdf&&n.msdfTextAttribute&&(this.attributes.vertex_outlineParameters=Si,this.attributes.vertex_shadowParameters=Ci,o+="    unpackMsdfParams();\n",a+=r.msdfVS),(n.useMorphPosition||n.useMorphNormal)&&(l+="#define MORPHING\n",n.useMorphTextureBasedInt&&(l+="#define MORPHING_INT\n"),n.useMorphPosition&&(l+="#define MORPHING_POSITION\n"),n.useMorphNormal&&(l+="#define MORPHING_NORMAL\n"),this.attributes.morph_vertex_id=ki),n.skin?(this.attributes.vertex_boneIndices=ui,n.batch?l+="#define BATCH\n":(this.attributes.vertex_boneWeights=di,l+="#define SKIN\n")):n.useInstancing&&(l+="#define INSTANCING\n"),n.screenSpace&&(l+="#define SCREENSPACE\n"),n.pixelSnap&&(l+="#define PIXELSNAP\n"),a+="\n",a+=r.startVS,a+=o,a+=r.endVS,a+="}",Object.keys(Pu).forEach((e=>{a.indexOf(e)>=0&&(this.varyings+=`varying ${Pu[e]} ${e};\n`,this.varyingDefines+=`#define VARYING_${e.toUpperCase()}\n`)}));const c=this.shaderPassInfo.shaderDefines;this.vshader=c+l+this.varyings+a}_fsGetBeginCode(){let e=this.shaderPassInfo.shaderDefines;for(let t=0;t<this.defines.length;t++)e+=`#define ${this.defines[t]}\n`;return e}_fsGetPickPassCode(){return`\n\t\t\t\t\t\t${this._fsGetBeginCode()}\n\t\t\t\t\t\t${this.varyings}\n\t\t\t\t\t\t${this.varyingDefines}\n\t\t\t\t\t\t${this.frontendDecl}\n\t\t\t\t\t\t${this.frontendCode}\n\t\t\t\t\t\t${this.chunks.pickPS}\n\n\t\t\t\t\t\tvoid main(void) {\n\t\t\t\t\t\t\t\t${this.frontendFunc}\n\t\t\t\t\t\t\t\tgl_FragColor = getPickOutput();\n\t\t\t\t\t\t}\n\t\t\t\t`}_fsGetDepthPassCode(){let e=this._fsGetBeginCode();return e+=this.varyings,e+=this.varyingDefines,e+=this.frontendDecl,e+=this.frontendCode,e+=pl.begin(),e+=this.frontendFunc,e+="    gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);\n",e+=pl.end(),e}_fsGetPrePassCode(){let e=this._fsGetBeginCode();return e+=this.varyings,e+=this.varyingDefines,e+=this.frontendDecl,e+=this.frontendCode,e+=pl.begin(),e+=this.frontendFunc,e+=this.device.textureFloatRenderable?"\n\t\t\t\t\t\tgl_FragColor = vec4(vLinearDepth, 1.0, 1.0, 1.0);\n\t\t\t\t":"\n\t\t\t\t\t\tuint intBits = floatBitsToUint(vLinearDepth);\n\t\t\t\t\t\tgl_FragColor = vec4(\n\t\t\t\t\t\t\t\tfloat((intBits >> 24u) & 0xFFu) / 255.0,\n\t\t\t\t\t\t\t\tfloat((intBits >> 16u) & 0xFFu) / 255.0,\n\t\t\t\t\t\t\t\tfloat((intBits >> 8u) & 0xFFu) / 255.0,\n\t\t\t\t\t\t\t\tfloat(intBits & 0xFFu) / 255.0\n\t\t\t\t\t\t);\n\t\t\t\t",e+=pl.end(),e}_fsGetShadowPassCode(){var e;const t=this.options,s=this.chunks,i=this.varyings,n=this.shaderPassInfo.lightType;let r=this.shaderPassInfo.shadowType;0!==n&&t.clusteredLightingEnabled&&(2!==r&&3!==r&&6!==r||(r=0));const a=Wo.get(r),o=null!=(e=null==a?void 0:a.vsm)&&e;let l=this._fsGetBeginCode();3===r?l+="#define VSM_EXPONENT 15.0\n\n":2===r&&(l+="#define VSM_EXPONENT 5.54\n\n"),0!==n&&(l+="uniform vec3 view_position;\n",l+="uniform float light_radius;\n"),l+=i,l+=this.varyingDefines,l+=this.frontendDecl,l+=this.frontendCode,6===r&&(l+=cl.linearizeDepthPS),l+=pl.begin(),l+=this.frontendFunc;let h=!1;if(0===n||!o&&2===n?l+="    float depth = gl_FragCoord.z;\n":(l+="    float depth = min(distance(view_position, vPositionW) / light_radius, 0.99999);\n",h=!0),o)l+=s.storeEVSMPS;else{6===r?l+="    gl_FragColor.r = depth;\n":(h&&(l+="    gl_FragDepth = depth;\n"),l+="    gl_FragColor = vec4(1.0);\n")}return l+=pl.end(),l}_fsGetLitPassCode(){const e=this.device,t=this.options,s=this.chunks,i=new Tu,n=new Tu,r=new Tu,a=new Tu;!1===t.opacityFadesSpecular&&i.append("uniform float material_alphaFade;"),t.useSpecular&&(this.defines.push("LIT_SPECULAR"),this.reflections&&this.defines.push("LIT_REFLECTIONS"),t.useClearCoat&&this.defines.push("LIT_CLEARCOAT"),t.fresnelModel>0&&this.defines.push("LIT_SPECULAR_FRESNEL"),t.useSheen&&this.defines.push("LIT_SHEEN"),t.useIridescence&&this.defines.push("LIT_IRIDESCENCE"));const o=[];let l=0,h=!1,c=!1,d=!1,u=t.lights.some((e=>e._shape&&0!==e._shape));t.clusteredLightingEnabled&&t.clusteredLightingAreaLightsEnabled&&(u=!0),(u||t.clusteredLightingEnabled)&&(i.append("#define AREA_LIGHTS"),i.append("uniform highp sampler2D areaLightsLutTex1;"),i.append("uniform highp sampler2D areaLightsLutTex2;"));for(let e=0;e<t.lights.length;e++){const s=t.lights[e],n=s._type;if(t.clusteredLightingEnabled&&0!==n)continue;const r=u&&s._shape?s._shape:0;i.append(`uniform vec3 light${e}_color;`),6===s._shadowType&&s.castShadows&&!t.noShadow&&(i.append(`uniform float light${e}_shadowSearchArea;`),i.append(`uniform vec4 light${e}_cameraParams;`)),0===n?i.append(`uniform vec3 light${e}_direction;`):(i.append(`uniform vec3 light${e}_position;`),i.append(`uniform float light${e}_radius;`),2===n&&(i.append(`uniform vec3 light${e}_direction;`),i.append(`uniform float light${e}_innerConeAngle;`),i.append(`uniform float light${e}_outerConeAngle;`))),0!==r&&(0===n&&i.append(`uniform vec3 light${e}_position;`),i.append(`uniform vec3 light${e}_halfWidth;`),i.append(`uniform vec3 light${e}_halfHeight;`)),s.castShadows&&!t.noShadow&&(i.append(`uniform mat4 light${e}_shadowMatrix;`),i.append(`uniform float light${e}_shadowIntensity;`),0===n&&(i.append(`uniform mat4 light${e}_shadowMatrixPalette[4];`),i.append(`uniform float light${e}_shadowCascadeDistances[4];`),i.append(`uniform float light${e}_shadowCascadeCount;`)),i.append(`uniform vec4 light${e}_shadowParams;`),0===n&&(h=!0),1===n?i.append(`uniform ${s._isPcf?"samplerCubeShadow":"samplerCube"} light${e}_shadowMap;`):i.append(`uniform ${s._isPcf?"sampler2DShadow":"sampler2D"} light${e}_shadowMap;`),l++,o[s._shadowType]=!0,s._isVsm&&(c=!0),6===s._shadowType&&(d=!0)),s._cookie&&(s._cookie._cubemap?1===n&&(i.append(`uniform samplerCube light${e}_cookie;`),i.append(`uniform float light${e}_cookieIntensity;`),s.castShadows&&!t.noShadow||i.append(`uniform mat4 light${e}_shadowMatrix;`)):2===n&&(i.append(`uniform sampler2D light${e}_cookie;`),i.append(`uniform float light${e}_cookieIntensity;`),s.castShadows&&!t.noShadow||i.append(`uniform mat4 light${e}_shadowMatrix;`),s._cookieTransform&&(i.append(`uniform vec4 light${e}_cookieMatrix;`),i.append(`uniform vec2 light${e}_cookieOffset;`))))}const p=this.needsNormal&&(t.useNormals||t.useClearCoatNormals||t.enableGGXSpecular&&!t.useHeights);if(p&&(t.hasTangents?n.append(s.TBNPS):t.useNormals||t.useClearCoatNormals?n.append(s.TBNderivativePS.replace(/\$UV/g,this.lightingUv)):n.append(s.TBNObjectSpacePS),t.twoSidedLighting&&n.append(s.twoSidedLightingPS)),n.append(s.sphericalPS),n.append(s.decodePS),n.append(pl.gammaCode(t.gamma,s)),n.append(pl.tonemapCode(t.toneMap,s)),n.append(pl.fogCode(t.fog,s)),n.append(this.frontendCode),t.useCubeMapRotation&&i.append("#define CUBEMAP_ROTATION"),this.needsNormal&&(n.append(s.cubeMapRotatePS),n.append(t.cubeMapProjection>0?s.cubeMapProjectBoxPS:s.cubeMapProjectNonePS),n.append(t.skyboxIntensity?s.envMultiplyPS:s.envConstPS)),(this.lighting&&t.useSpecular||this.reflections)&&(t.useMetalness&&n.append(s.metalnessModulatePS),2===t.fresnelModel&&n.append(s.fresnelSchlickPS),t.useIridescence&&n.append(s.iridescenceDiffractionPS)),t.useAo)switch(n.append(s.aoDiffuseOccPS),t.occludeSpecular){case 1:n.append(t.occludeSpecularFloat?s.aoSpecOccSimplePS:s.aoSpecOccConstSimplePS);break;case 2:n.append(t.occludeSpecularFloat?s.aoSpecOccPS:s.aoSpecOccConstPS)}"envAtlasHQ"===t.reflectionSource?(n.append(s.envAtlasPS),n.append(s.reflectionEnvHQPS.replace(/\$DECODE_CUBEMAP/g,Fd.decodeFunc(t.reflectionCubemapEncoding)).replace(/\$DECODE/g,Fd.decodeFunc(t.reflectionEncoding)))):"envAtlas"===t.reflectionSource?(n.append(s.envAtlasPS),n.append(s.reflectionEnvPS.replace(/\$DECODE/g,Fd.decodeFunc(t.reflectionEncoding)))):"cubeMap"===t.reflectionSource?n.append(s.reflectionCubePS.replace(/\$DECODE/g,Fd.decodeFunc(t.reflectionEncoding))):"sphereMap"===t.reflectionSource&&n.append(s.reflectionSpherePS.replace(/\$DECODE/g,Fd.decodeFunc(t.reflectionEncoding))),this.reflections&&(t.useClearCoat&&n.append(s.reflectionCCPS),t.useSheen&&n.append(s.reflectionSheenPS)),t.useRefraction&&(t.useDynamicRefraction?(t.dispersion&&(i.append("uniform float material_dispersion;"),i.append("#define DISPERSION\n")),n.append(s.refractionDynamicPS)):this.reflections&&n.append(s.refractionCubePS)),t.useSheen&&n.append(s.lightSheenPS),t.clusteredLightingEnabled&&(n.append(s.clusteredLightUtilsPS),t.clusteredLightingCookiesEnabled&&n.append(s.clusteredLightCookiesPS),t.clusteredLightingShadowsEnabled&&!t.noShadow&&(o[0]=!0,o[4]=!0,o[6]=!0)),(l>0||t.clusteredLightingEnabled)&&(h&&n.append(s.shadowCascadesPS),(o[5]||o[0]||o[7]||o[8])&&n.append(s.shadowStandardPS),(o[4]||o[9])&&n.append(s.shadowStandardGL2PS),c&&(n.append(s.shadowVSM_commonPS),o[2]&&n.append(s.shadowEVSMPS.replace(/\$/g,"16")),o[3]&&n.append(e.extTextureFloatLinear?s.shadowEVSMPS.replace(/\$/g,"32"):s.shadowEVSMnPS.replace(/\$/g,"32"))),d&&(n.append(s.linearizeDepthPS),n.append(s.shadowPCSSPS))),t.enableGGXSpecular&&n.append("uniform float material_anisotropy;"),this.lighting&&(n.append(s.lightDiffuseLambertPS),(u||t.clusteredLightingAreaLightsEnabled)&&n.append(s.ltcPS));let f=!1;t.useSpecular&&(this.lighting&&n.append(t.enableGGXSpecular?s.lightSpecularAnisoGGXPS:s.lightSpecularBlinnPS),t.fresnelModel||this.reflections||t.diffuseMapEnabled||(i.append("uniform vec3 material_ambient;"),i.append("#define LIT_OLD_AMBIENT"),f=!0)),n.append(s.combinePS),t.lightMapEnabled&&n.append(t.useSpecular&&t.dirLightMapEnabled?s.lightmapDirAddPS:s.lightmapAddPS);const m=!t.lightMapEnabled||t.lightMapWithoutAmbient;m&&("ambientSH"===t.ambientSource?n.append(s.ambientSHPS):"envAtlas"===t.ambientSource?("envAtlas"!==t.reflectionSource&&"envAtlasHQ"!==t.reflectionSource&&n.append(s.envAtlasPS),n.append(s.ambientEnvPS.replace(/\$DECODE/g,Fd.decodeFunc(t.ambientEncoding)))):n.append(s.ambientConstantPS)),f||i.append("uniform vec3 material_ambient;"),t.useMsdf&&(t.msdfTextAttribute||i.append("#define UNIFORM_TEXT_PARAMETERS"),n.append(s.msdfPS)),this.needsNormal&&(n.append(s.viewDirPS),t.useSpecular&&n.append(t.enableGGXSpecular?s.reflDirAnisoPS:s.reflDirPS));let g,_=!1,v=!1,b=!1,y=!1,x=!1;if(t.clusteredLightingEnabled&&this.lighting){if(y=!0,_=!0,v=!0,x=!0,n.append(s.floatUnpackingPS),t.lightMaskDynamic&&i.append("#define CLUSTER_MESH_DYNAMIC_LIGHTS"),t.clusteredLightingCookiesEnabled&&i.append("#define CLUSTER_COOKIES"),t.clusteredLightingShadowsEnabled&&!t.noShadow){var w;const e=(null==(w=Wo.get(t.clusteredLightingShadowType))?void 0:w.name).substring(0,4);i.append("#define CLUSTER_SHADOWS"),i.append(`#define CLUSTER_SHADOW_TYPE_${e}`)}t.clusteredLightingAreaLightsEnabled&&i.append("#define CLUSTER_AREALIGHTS"),i.append(Mh.getShaderDefines()),t.clusteredLightingShadowsEnabled&&!t.noShadow&&n.append(s.clusteredLightShadowsPS),n.append(s.clusteredLightPS)}if(a.append(this._fsGetStartCode(a,e,s,t)),this.needsNormal&&(a.append("    dVertexNormalW = normalize(vNormalW);"),(t.useHeights||t.useNormals)&&t.hasTangents&&(a.append("    dTangentW = vTangentW;"),a.append("    dBinormalW = vBinormalW;")),a.append("    getViewDir();"),p&&(a.append("    getTBN(dTangentW, dBinormalW, dVertexNormalW);"),t.twoSidedLighting&&a.append("    handleTwoSidedLighting();"))),a.append(this.frontendFunc),t.ssao&&(n.append("\n\t\t\t\t\t\t\t\t\t\tuniform sampler2D ssaoTexture;\n\t\t\t\t\t\t\t\t\t\tuniform vec2 ssaoTextureSizeInv;\n\t\t\t\t\t\t\t\t"),r.append("litArgs_ao *= texture2DLodEXT(ssaoTexture, gl_FragCoord.xy * ssaoTextureSizeInv, 0.0).r;")),this.needsNormal&&(t.useSpecular&&r.append("    getReflDir(litArgs_worldNormal, dViewDirW, litArgs_gloss, dTBN);"),t.useClearCoat&&r.append("    ccReflDirW = normalize(-reflect(dViewDirW, litArgs_clearcoat_worldNormal));")),(this.lighting&&t.useSpecular||this.reflections)&&(t.useMetalness&&(r.append("    float f0 = 1.0 / litArgs_ior; f0 = (f0 - 1.0) / (f0 + 1.0); f0 *= f0;"),r.append("    litArgs_specularity = getSpecularModulate(litArgs_specularity, litArgs_albedo, litArgs_metalness, f0);"),r.append("    litArgs_albedo = getAlbedoModulate(litArgs_albedo, litArgs_metalness);")),t.useIridescence&&r.append("    vec3 iridescenceFresnel = getIridescence(saturate(dot(dViewDirW, litArgs_worldNormal)), litArgs_specularity, litArgs_iridescence_thickness);")),m&&(r.append("    addAmbient(litArgs_worldNormal);"),t.useSpecular&&r.append("   dDiffuseLight = dDiffuseLight * (1.0 - litArgs_specularity);"),t.separateAmbient&&r.append("\n\t\t\t\t\t\t\t\t\t\tvec3 dAmbientLight = dDiffuseLight;\n\t\t\t\t\t\t\t\t\t\tdDiffuseLight = vec3(0);\n\t\t\t\t\t\t\t\t")),f||r.append("    dDiffuseLight *= material_ambient;"),t.useAo&&!t.occludeDirect&&r.append("    occludeDiffuse(litArgs_ao);"),t.lightMapEnabled&&r.append("    addLightMap(\n\t\t\t\t\t\t\t\tlitArgs_lightmap, \n\t\t\t\t\t\t\t\tlitArgs_lightmapDir, \n\t\t\t\t\t\t\t\tlitArgs_worldNormal, \n\t\t\t\t\t\t\t\tdViewDirW, \n\t\t\t\t\t\t\t\tdReflDirW, \n\t\t\t\t\t\t\t\tlitArgs_gloss, \n\t\t\t\t\t\t\t\tlitArgs_specularity, \n\t\t\t\t\t\t\t\tdVertexNormalW,\n\t\t\t\t\t\t\t\tdTBN\n\t\t\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t\t\t\t, iridescenceFresnel,\n\t\t\t\t\t\t\t\tlitArgs_iridescence_intensity\n\t\t\t\t\t\t#endif\n\t\t\t\t\t\t\t\t);"),this.lighting||this.reflections){this.reflections&&(t.useClearCoat&&(r.append("    addReflectionCC(ccReflDirW, litArgs_clearcoat_gloss);"),t.fresnelModel>0?(r.append("    ccFresnel = getFresnelCC(dot(dViewDirW, litArgs_clearcoat_worldNormal));"),r.append("    ccReflection.rgb *= ccFresnel;")):r.append("    ccFresnel = 0.0;")),t.useSpecularityFactor&&r.append("    ccReflection.rgb *= litArgs_specularityFactor;"),t.useSheen&&r.append("    addReflectionSheen(litArgs_worldNormal, dViewDirW, litArgs_sheen_gloss);"),r.append("    addReflection(dReflDirW, litArgs_gloss);"),t.fresnelModel>0?r.append("    dReflection.rgb *= \n\t\t\t\t\t\t\t\t\t\t\t\tgetFresnel(\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdot(dViewDirW, litArgs_worldNormal), \n\t\t\t\t\t\t\t\t\t\t\t\t\t\tlitArgs_gloss, \n\t\t\t\t\t\t\t\t\t\t\t\t\t\tlitArgs_specularity\n\t\t\t\t\t\t\t\t\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t, iridescenceFresnel,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tlitArgs_iridescence_intensity\n\t\t\t\t\t\t\t\t\t\t\t\t#endif\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t);"):r.append("    dReflection.rgb *= litArgs_specularity;"),t.useSpecularityFactor&&r.append("    dReflection.rgb *= litArgs_specularityFactor;")),u&&(r.append("    dSpecularLight *= litArgs_specularity;"),t.useSpecular&&r.append("    calcLTCLightValues(litArgs_gloss, litArgs_worldNormal, dViewDirW, litArgs_specularity, litArgs_clearcoat_gloss, litArgs_clearcoat_worldNormal, litArgs_clearcoat_specularity);"));for(let i=0;i<t.lights.length;i++){const a=t.lights[i],o=a._type;if(t.clusteredLightingEnabled&&0!==o)continue;g=!1;const l=u&&a._shape?a.shape:0,h=u&&a._shape?this._getLightSourceShapeString(l):"";if(0!==l&&r.append(`    calc${h}LightValues(light${i}_position, light${i}_halfWidth, light${i}_halfHeight);`),0===o?(r.append(`    dLightDirNormW = light${i}_direction;`),r.append("    dAtten = 1.0;")):(a._cookie&&(2!==o||a._cookie._cubemap?1===o&&a._cookie._cubemap&&(x=!0,g=!0):(x=!0,g=!0)),r.append(`    getLightDirPoint(light${i}_position);`),_=!0,g&&(2===o?r.append(`    dAtten3 = getCookie2D${a._cookieFalloff?"":"Clip"}${a._cookieTransform?"Xform":""}(light${i}_cookie, light${i}_shadowMatrix, light${i}_cookieIntensity${a._cookieTransform?`, light${i}_cookieMatrix, light${i}_cookieOffset`:""}).${a._cookieChannel};`):r.append(`    dAtten3 = getCookieCube(light${i}_cookie, light${i}_shadowMatrix, light${i}_cookieIntensity).${a._cookieChannel};`)),0===l?0===a._falloffMode?(r.append(`    dAtten = getFalloffLinear(light${i}_radius, dLightDirW);`),v=!0):(r.append(`    dAtten = getFalloffInvSquared(light${i}_radius, dLightDirW);`),b=!0):(r.append(`    dAtten = getFalloffWindow(light${i}_radius, dLightDirW);`),b=!0),r.append("    if (dAtten > 0.00001) {"),2===o&&(g&&!a._cookieFalloff||(r.append(`    dAtten *= getSpotEffect(light${i}_direction, light${i}_innerConeAngle, light${i}_outerConeAngle, dLightDirNormW);`),y=!0))),0!==l?0===o?r.append("    dAttenD = getLightDiffuse(litArgs_worldNormal, dViewDirW, dLightDirW, dLightDirNormW);"):r.append(`    dAttenD = get${h}LightDiffuse(litArgs_worldNormal, dViewDirW, dLightDirW, dLightDirNormW) * 16.0;`):r.append("    dAtten *= getLightDiffuse(litArgs_worldNormal, dViewDirW, dLightDirW, dLightDirNormW);"),a.castShadows&&!t.noShadow){const t=Wo.get(a._shadowType),h=6===a._shadowType,c=null==t?void 0:t.vsm,d=null==t?void 0:t.pcf;let u,p=null;switch(a._shadowType){case 2:p="VSM16",u="5.54";break;case 3:p="VSM32",u="15.0";break;case 5:case 7:p="PCF1x1";break;case 4:case 9:p="PCF5x5";break;case 6:p="PCSS";break;default:p="PCF3x3"}if(null!==p){a._normalOffsetBias&&!a._isVsm&&n.append("#define SHADOW_SAMPLE_NORMAL_OFFSET"),0===o&&n.append("#define SHADOW_SAMPLE_ORTHO"),(d||h||e.isWebGPU)&&n.append("#define SHADOW_SAMPLE_SOURCE_ZBUFFER"),1===o&&n.append("#define SHADOW_SAMPLE_POINT");const t=s.shadowSampleCoordPS;n.append(t.replace("$LIGHT",i)),n.append("#undef SHADOW_SAMPLE_NORMAL_OFFSET"),n.append("#undef SHADOW_SAMPLE_ORTHO"),n.append("#undef SHADOW_SAMPLE_SOURCE_ZBUFFER"),n.append("#undef SHADOW_SAMPLE_POINT");let f=`light${i}_shadowMatrix`;0===o&&a.numCascades>1&&(r.append(`    getShadowCascadeMatrix(light${i}_shadowMatrixPalette, light${i}_shadowCascadeDistances, light${i}_shadowCascadeCount);`),f="cascadeShadowMat"),r.append(`    dShadowCoord = getShadowSampleCoord${i}(${f}, light${i}_shadowParams, vPositionW, dLightPosW, dLightDirW, dLightDirNormW, dVertexNormalW);`),0===o&&r.append(`    fadeShadow(light${i}_shadowCascadeDistances);`);let m=`SHADOWMAP_PASS(light${i}_shadowMap), dShadowCoord, light${i}_shadowParams`;if(c)m=`${m}, ${u}, dLightDirW`;else if(h){let e=`vec2(light${i}_shadowSearchArea)`;0!==l&&(e=`vec2(length(light${i}_halfWidth), length(light${i}_halfHeight)) * light${i}_shadowSearchArea`),m=`${m}, light${i}_cameraParams, ${e}, dLightDirW`}1===o?(p=`Point${p}`,h||(m=`${m}, dLightDirW`)):2===o&&(p=`Spot${p}`),r.append(`    float shadow${i} = getShadow${p}(${m});`),r.append(`    dAtten *= mix(1.0, shadow${i}, light${i}_shadowIntensity);`)}}if(0!==l?t.useSpecular?r.append(`    dDiffuseLight += ((dAttenD * dAtten) * light${i}_color${g?" * dAtten3":""}) * (1.0 - dLTCSpecFres);`):r.append(`    dDiffuseLight += (dAttenD * dAtten) * light${i}_color${g?" * dAtten3":""};`):u&&t.useSpecular?r.append(`    dDiffuseLight += (dAtten * light${i}_color${g?" * dAtten3":""}) * (1.0 - litArgs_specularity);`):r.append(`    dDiffuseLight += dAtten * light${i}_color${g?" * dAtten3":""};`),t.useSpecular&&r.append("    dHalfDirW = normalize(-dLightDirNormW + dViewDirW);"),a.affectSpecularity)if(0!==l)t.useClearCoat&&r.append(`    ccSpecularLight += ccLTCSpecFres * get${h}LightSpecular(litArgs_clearcoat_worldNormal, dViewDirW) * dAtten * light${i}_color${g?" * dAtten3":""};`),t.useSpecular&&r.append(`    dSpecularLight += dLTCSpecFres * get${h}LightSpecular(litArgs_worldNormal, dViewDirW) * dAtten * light${i}_color${g?" * dAtten3":""};`);else{let e=!1;0===o&&t.fresnelModel>0&&(e=!0),t.useClearCoat&&r.append(`    ccSpecularLight += getLightSpecular(dHalfDirW, ccReflDirW, litArgs_clearcoat_worldNormal, dViewDirW, dLightDirNormW, litArgs_clearcoat_gloss, dTBN) * dAtten * light${i}_color${g?" * dAtten3":""}${e?" * getFresnelCC(dot(dViewDirW, dHalfDirW));":";"}`),t.useSheen&&r.append(`    sSpecularLight += getLightSpecularSheen(dHalfDirW, litArgs_worldNormal, dViewDirW, dLightDirNormW, litArgs_sheen_gloss) * dAtten * light${i}_color${g?" * dAtten3;":";"}`),t.useSpecular&&r.append(`    dSpecularLight += getLightSpecular(dHalfDirW, dReflDirW, litArgs_worldNormal, dViewDirW, dLightDirNormW, litArgs_gloss, dTBN) * dAtten * light${i}_color${g?" * dAtten3":""}${e?" \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t* getFresnel(\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdot(dViewDirW, dHalfDirW), \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tlitArgs_gloss, \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tlitArgs_specularity\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t, iridescenceFresnel, \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tlitArgs_iridescence_intensity\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t#endif\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t);":"* litArgs_specularity;"}`)}0!==o&&r.append("    }")}t.clusteredLightingEnabled&&this.lighting&&(v=!0,b=!0,_=!0,r.append("    addClusteredLights(\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tlitArgs_worldNormal, \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdViewDirW, \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdReflDirW,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t#if defined(LIT_CLEARCOAT)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tccReflDirW,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t#endif\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tlitArgs_gloss, \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tlitArgs_specularity, \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdVertexNormalW, \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdTBN, \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tiridescenceFresnel,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t#endif\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tlitArgs_clearcoat_worldNormal, \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tlitArgs_clearcoat_gloss,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tlitArgs_sheen_gloss,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tlitArgs_iridescence_intensity\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t);")),u&&(t.useClearCoat&&r.append("    litArgs_clearcoat_specularity = 1.0;"),t.useSpecular&&r.append("    litArgs_specularity = vec3(1);")),t.useRefraction&&r.append("    addRefraction(\n\t\t\t\t\t\t\t\t\t\t\t\tlitArgs_worldNormal, \n\t\t\t\t\t\t\t\t\t\t\t\tdViewDirW, \n\t\t\t\t\t\t\t\t\t\t\t\tlitArgs_thickness, \n\t\t\t\t\t\t\t\t\t\t\t\tlitArgs_gloss, \n\t\t\t\t\t\t\t\t\t\t\t\tlitArgs_specularity, \n\t\t\t\t\t\t\t\t\t\t\t\tlitArgs_albedo, \n\t\t\t\t\t\t\t\t\t\t\t\tlitArgs_transmission,\n\t\t\t\t\t\t\t\t\t\t\t\tlitArgs_ior,\n\t\t\t\t\t\t\t\t\t\t\t\tlitArgs_dispersion\n\t\t\t\t\t\t\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t\t\t\t\t\t\t\t, iridescenceFresnel, \n\t\t\t\t\t\t\t\t\t\t\t\tlitArgs_iridescence_intensity\n\t\t\t\t\t\t\t\t\t\t#endif\n\t\t\t\t\t\t\t\t\t\t);")}t.useAo&&(t.occludeDirect&&r.append("    occludeDiffuse(litArgs_ao);"),1!==t.occludeSpecular&&2!==t.occludeSpecular||r.append("    occludeSpecular(litArgs_gloss, litArgs_ao, litArgs_worldNormal, dViewDirW);")),t.useSpecularityFactor&&r.append("    dSpecularLight *= litArgs_specularityFactor;"),!1===t.opacityFadesSpecular&&(2!==t.blendType&&4!==t.blendType||(r.append("float specLum = dot((dSpecularLight + dReflection.rgb * dReflection.a), vec3( 0.2126, 0.7152, 0.0722 ));"),r.append("#ifdef LIT_CLEARCOAT\n specLum += dot(ccSpecularLight * litArgs_clearcoat_specularity + ccReflection.rgb * litArgs_clearcoat_specularity, vec3( 0.2126, 0.7152, 0.0722 ));\n#endif"),r.append("litArgs_opacity = clamp(litArgs_opacity + gammaCorrectInput(specLum), 0.0, 1.0);")),r.append("litArgs_opacity *= material_alphaFade;")),r.append(s.endPS),2===t.blendType||6===t.blendType||t.alphaToCoverage?r.append(s.outputAlphaPS):4===t.blendType?r.append(s.outputAlphaPremulPS):r.append(s.outputAlphaOpaquePS),t.useMsdf&&r.append("    gl_FragColor = applyMsdf(gl_FragColor);"),r.append(s.outputPS),r.append(s.debugOutputPS),_&&n.prepend(s.lightDirPointPS),v&&n.prepend(s.falloffLinearPS),b&&n.prepend(s.falloffInvSquaredPS),y&&n.prepend(s.spotPS),x&&!t.clusteredLightingEnabled&&n.prepend(s.cookiePS);let S="";const C=`void evaluateBackend() {\n${r.code}\n}`;n.append(C),a.append(s.debugProcessFrontendPS),a.append("    evaluateBackend();"),a.append(pl.end());const T=i.code+n.code+a.code;T.includes("dTBN")&&(S+="mat3 dTBN;\n"),T.includes("dVertexNormalW")&&(S+="vec3 dVertexNormalW;\n"),T.includes("dTangentW")&&(S+="vec3 dTangentW;\n"),T.includes("dBinormalW")&&(S+="vec3 dBinormalW;\n"),T.includes("dViewDirW")&&(S+="vec3 dViewDirW;\n"),T.includes("dReflDirW")&&(S+="vec3 dReflDirW;\n"),T.includes("dHalfDirW")&&(S+="vec3 dHalfDirW;\n"),T.includes("ccReflDirW")&&(S+="vec3 ccReflDirW;\n"),T.includes("dLightDirNormW")&&(S+="vec3 dLightDirNormW;\n"),T.includes("dLightDirW")&&(S+="vec3 dLightDirW;\n"),T.includes("dLightPosW")&&(S+="vec3 dLightPosW;\n"),T.includes("dShadowCoord")&&(S+="vec3 dShadowCoord;\n"),T.includes("dReflection")&&(S+="vec4 dReflection;\n"),T.includes("dDiffuseLight")&&(S+="vec3 dDiffuseLight;\n"),T.includes("dSpecularLight")&&(S+="vec3 dSpecularLight;\n"),T.includes("dAtten")&&(S+="float dAtten;\n"),T.includes("dAttenD")&&(S+="float dAttenD;\n"),T.includes("dAtten3")&&(S+="vec3 dAtten3;\n"),T.includes("dMsdf")&&(S+="vec4 dMsdf;\n"),T.includes("ccFresnel")&&(S+="float ccFresnel;\n"),T.includes("ccReflection")&&(S+="vec3 ccReflection;\n"),T.includes("ccSpecularLight")&&(S+="vec3 ccSpecularLight;\n"),T.includes("ccSpecularityNoFres")&&(S+="float ccSpecularityNoFres;\n"),T.includes("sSpecularLight")&&(S+="vec3 sSpecularLight;\n"),T.includes("sReflection")&&(S+="vec3 sReflection;\n");return this._fsGetBeginCode()+this.varyings+this.varyingDefines+this._fsGetBaseCode()+S+this.frontendDecl+T}generateFragmentShader(e,t,s,i){var n;const r=this.options;this.frontendDecl=e,this.frontendCode=t,this.frontendFunc=s,this.lightingUv=i,3===r.pass?this.fshader=this._fsGetPickPassCode():2===r.pass?this.fshader=this._fsGetDepthPassCode():1===r.pass?this.fshader=this._fsGetPrePassCode():this.shadowPass?this.fshader=this._fsGetShadowPassCode():r.customFragmentShader?this.fshader=this._fsGetBeginCode()+r.customFragmentShader:this.fshader=this._fsGetLitPassCode(),null==(n=this.handleCompatibility)||n.call(this)}getDefinition(e){const t=new Map;t.set("transformCore",this.chunks.transformCoreVS),t.set("transformInstancing",this.chunks.transformInstancingVS),t.set("skinTexVS",this.chunks.skinTexVS),t.set("skinBatchTexVS",this.chunks.skinBatchTexVS);const s=new Map(e.defines),i=_a.createDefinition(this.device,{name:"LitShader",attributes:this.attributes,vertexCode:this.vshader,fragmentCode:this.fshader,vertexIncludes:t,fragmentDefines:s,vertexDefines:s});return this.shaderPassInfo.isForward&&(i.tag=1),i}}const Au={generateKey:e=>`lit${Object.keys(e).sort().map((t=>"chunks"===t?Au.generateChunksKey(e):"lights"===t?Au.generateLightsKey(e):t+e[t])).join("\n")}`,generateLightsKey:e=>`lights:${e.lights.map((t=>e.clusteredLightingEnabled&&0!==t._type?"":`${t.key},`)).join("")}`,generateChunksKey(e){var t;return`chunks:\n${Object.keys(null!=(t=e.chunks)?t:{}).sort().map((t=>t+e.chunks[t])).join("")}`}};class Mu{constructor(){this.defines=new Map,this.forceUv1=!1,this.specularTint=!1,this.metalnessTint=!1,this.glossTint=!1,this.emissiveEncoding="linear",this.lightMapEncoding="linear",this.packedNormal=!1,this.glossInvert=!1,this.sheenGlossInvert=!1,this.clearCoatGlossInvert=!1,this.useAO=!1,this.litOptions=new Su}get pass(){return this.litOptions.pass}}const Du=[],Ru=e=>Object.keys(e).filter((e=>"litOptions"!==e)).sort();const Lu=new class extends pl{constructor(...e){super(...e),this.optionsContext=new Mu,this.optionsContextMin=new Mu}generateKey(e){let t;e===this.optionsContextMin?(this.propsMin||(this.propsMin=Ru(e)),t=this.propsMin):e===this.optionsContext?(this.props||(this.props=Ru(e)),t=this.props):t=Ru(e);return`standard:\n${pl.definesHash(e.defines)}\n${t.map((t=>t+e[t])).join("\n")}${Au.generateKey(e.litOptions)}`}_getUvSourceExpression(e,t,s){const i=s[e],n=s[t],r=0===s.litOptions.pass;let a;return r&&1===s.litOptions.nineSlicedMode||r&&2===s.litOptions.nineSlicedMode?a="nineSlicedUv":(a=0===i?`vUv${n}`:`vUV${n}_${i}`,s.heightMap&&"heightMapTransform"!==e&&(a+=" + dUvOffset")),a}_addMapDef(e,t){return t?`#define ${e}\n`:`#undef ${e}\n`}_addMapDefs(e,t,s,i,n){return this._addMapDef("MAPFLOAT",e)+this._addMapDef("MAPCOLOR",t)+this._addMapDef("MAPVERTEX",s)+this._addMapDef("MAPTEXTURE",i)+this._addMapDef("MAPINVERT",n)}_addMap(e,t,s,i,n,r=null){const a=`${e}Map`,o=`${a}Uv`,l=`${a}Identifier`,h=`${a}Transform`,c=`${a}Channel`,d=`${e}VertexColorChannel`,u=`${e}VertexColor`,p=`${e}Mode`,f=`${e}Invert`,m=s[`${e}Tint`],g=s[u],_=s[a],v=s[l],b=s[p];let y=i[t];if(_){const e=this._getUvSourceExpression(h,o,s);if(y=y.replace(/\$UV/g,e).replace(/\$CH/g,s[c]),n&&-1!==y.search(/\$SAMPLER/g)){let e=`texture_${a}`;const t=n[v];t?e=t:n[v]=e,y=y.replace(/\$SAMPLER/g,e)}if(r&&(y="aaa"===s[c]?y.replace(/\$DECODE/g,"passThrough"):y.replace(/\$DECODE/g,Fd.decodeFunc(r)),y.indexOf("$texture2DSAMPLE"))){const e={linear:"texture2D",srgb:"texture2DSRGB",rgbm:"texture2DRGBM",rgbe:"texture2DRGBE"};y=y.replace(/\$texture2DSAMPLE/g,e[r]||"texture2D")}}g&&(y=y.replace(/\$VC/g,s[d])),b&&(y=y.replace(/\$DETAILMODE/g,b));const x=!!(1&m),w=!!(2&m),S=!!s[f];return y=this._addMapDefs(x,w,g,_,S)+y,y.replace(/\$/g,"")}_correctChannel(e,t,s){if(s[e]>0){if(s[e]<t.length)return t.substring(0,s[e]);if(s[e]>t.length){let i=t;const n=i.charAt(i.length-1),r=s[e]-i.length;for(let e=0;e<r;e++)i+=n;return i}return t}}createShaderDefinition(e,t){const s=mc.get(e).getByIndex(t.litOptions.pass).isForward,i=new ku(e,t.litOptions),n=[],r=[],a=[],o={};for(const e in Du){const s=`${e}Map`;if(t[`${e}VertexColor`]){const s=`${e}VertexColorChannel`;t[s]=this._correctChannel(e,t[s],Du)}if(t[s]){const i=`${s}Channel`,o=`${s}Transform`,l=`${s}Uv`;t[l]=Math.min(t[l],1),t[i]=this._correctChannel(e,t[i],Du);const h=t[l];n[h]=!0,r[h]=r[h]||t[s]&&!t[o],t[o]&&a.push({name:e,id:t[o],uv:t[l]})}}t.forceUv1&&(n[1]=!0,r[1]=void 0===r[1]||r[1]),i.generateVertexShader(n,r,a),t.litOptions.fresnelModel=0===t.litOptions.fresnelModel?2:t.litOptions.fresnelModel;const l=new Tu,h=new Tu,c=new Tu,d=new Tu;let u="";if(2===t.litOptions.nineSlicedMode?l.append("const float textureBias = -1000.0;"):l.append("uniform float textureBias;"),s){if(t.heightMap&&(l.append("vec2 dUvOffset;"),h.append(this._addMap("height","parallaxPS",t,i.chunks,o)),c.append("getParallax();")),3!==t.litOptions.blendType||t.litOptions.alphaTest||t.litOptions.alphaToCoverage||t.litOptions.opacityDither!==il){l.append("float dAlpha;"),h.append(this._addMap("opacity","opacityPS",t,i.chunks,o)),c.append("getOpacity();"),d.append("litArgs_opacity = dAlpha;"),t.litOptions.alphaTest&&(h.append(i.chunks.alphaTestPS),c.append("alphaTest(dAlpha);"));const e=t.litOptions.opacityDither;e!==il&&(e===nl&&l.append(i.chunks.bayerPS),l.append(`#define DITHER_${e.toUpperCase()}\n`),l.append(i.chunks.opacityDitherPS),c.append("opacityDither(dAlpha, 0.0);"))}else l.append("float dAlpha = 1.0;");if(i.needsNormal){if((t.normalMap||t.clearCoatNormalMap)&&(h.append(t.packedNormal?i.chunks.normalXYPS:i.chunks.normalXYZPS),!t.litOptions.hasTangents)){const e=t.normalMap?"normalMap":"clearCoatNormalMap";u=this._getUvSourceExpression(`${e}Transform`,`${e}Uv`,t)}l.append("vec3 dNormalW;"),h.append(this._addMap("normalDetail","normalDetailMapPS",t,i.chunks,o)),h.append(this._addMap("normal","normalMapPS",t,i.chunks,o)),c.append("getNormal();"),d.append("litArgs_worldNormal = dNormalW;")}if(i.needsSceneColor&&l.append("uniform sampler2D uSceneColorMap;"),i.needsScreenSize&&l.append("uniform vec4 uScreenSize;"),i.needsTransforms&&(l.append("uniform mat4 matrix_viewProjection;"),l.append("uniform mat4 matrix_model;")),(t.diffuseDetail||t.aoDetail)&&h.append(i.chunks.detailModesPS),l.append("vec3 dAlbedo;"),t.diffuseDetail&&h.append(this._addMap("diffuseDetail","diffuseDetailMapPS",t,i.chunks,o,t.diffuseDetailEncoding)),h.append(this._addMap("diffuse","diffusePS",t,i.chunks,o,t.diffuseEncoding)),c.append("getAlbedo();"),d.append("litArgs_albedo = dAlbedo;"),t.litOptions.useRefraction&&(l.append("float dTransmission;"),h.append(this._addMap("refraction","transmissionPS",t,i.chunks,o)),c.append("getRefraction();"),d.append("litArgs_transmission = dTransmission;"),l.append("float dThickness;"),h.append(this._addMap("thickness","thicknessPS",t,i.chunks,o)),c.append("getThickness();"),d.append("litArgs_thickness = dThickness;"),t.litOptions.dispersion&&d.append("litArgs_dispersion = material_dispersion;")),t.litOptions.useIridescence&&(l.append("float dIridescence;"),h.append(this._addMap("iridescence","iridescencePS",t,i.chunks,o)),c.append("getIridescence();"),d.append("litArgs_iridescence_intensity = dIridescence;"),l.append("float dIridescenceThickness;"),h.append(this._addMap("iridescenceThickness","iridescenceThicknessPS",t,i.chunks,o)),c.append("getIridescenceThickness();"),d.append("litArgs_iridescence_thickness = dIridescenceThickness;")),i.lighting&&t.litOptions.useSpecular||i.reflections?(l.append("vec3 dSpecularity;"),l.append("float dGlossiness;"),t.litOptions.useSheen&&(l.append("vec3 sSpecularity;"),h.append(this._addMap("sheen","sheenPS",t,i.chunks,o,t.sheenEncoding)),c.append("getSheen();"),d.append("litArgs_sheen_specularity = sSpecularity;"),l.append("float sGlossiness;"),h.append(this._addMap("sheenGloss","sheenGlossPS",t,i.chunks,o)),c.append("getSheenGlossiness();"),d.append("litArgs_sheen_gloss = sGlossiness;")),t.litOptions.useMetalness&&(l.append("float dMetalness;"),h.append(this._addMap("metalness","metalnessPS",t,i.chunks,o)),c.append("getMetalness();"),d.append("litArgs_metalness = dMetalness;"),l.append("float dIor;"),h.append(this._addMap("ior","iorPS",t,i.chunks,o)),c.append("getIor();"),d.append("litArgs_ior = dIor;")),t.litOptions.useSpecularityFactor&&(l.append("float dSpecularityFactor;"),h.append(this._addMap("specularityFactor","specularityFactorPS",t,i.chunks,o)),c.append("getSpecularityFactor();"),d.append("litArgs_specularityFactor = dSpecularityFactor;")),t.useSpecularColor?h.append(this._addMap("specular","specularPS",t,i.chunks,o,t.specularEncoding)):h.append("void getSpecularity() { dSpecularity = vec3(1); }"),h.append(this._addMap("gloss","glossPS",t,i.chunks,o)),c.append("getGlossiness();"),c.append("getSpecularity();"),d.append("litArgs_specularity = dSpecularity;"),d.append("litArgs_gloss = dGlossiness;")):(l.append("vec3 dSpecularity = vec3(0.0);"),l.append("float dGlossiness = 0.0;")),t.aoDetail&&h.append(this._addMap("aoDetail","aoDetailMapPS",t,i.chunks,o)),(t.aoMap||t.aoVertexColor||t.useAO)&&(l.append("float dAo;"),h.append(this._addMap("ao","aoPS",t,i.chunks,o)),c.append("getAO();"),d.append("litArgs_ao = dAo;")),l.append("vec3 dEmission;"),h.append(this._addMap("emissive","emissivePS",t,i.chunks,o,t.emissiveEncoding)),c.append("getEmission();"),d.append("litArgs_emission = dEmission;"),t.litOptions.useClearCoat&&(l.append("float ccSpecularity;"),l.append("float ccGlossiness;"),l.append("vec3 ccNormalW;"),h.append(this._addMap("clearCoat","clearCoatPS",t,i.chunks,o)),h.append(this._addMap("clearCoatGloss","clearCoatGlossPS",t,i.chunks,o)),h.append(this._addMap("clearCoatNormal","clearCoatNormalPS",t,i.chunks,o)),c.append("getClearCoat();"),c.append("getClearCoatGlossiness();"),c.append("getClearCoatNormal();"),d.append("litArgs_clearcoat_specularity = ccSpecularity;"),d.append("litArgs_clearcoat_gloss = ccGlossiness;"),d.append("litArgs_clearcoat_worldNormal = ccNormalW;")),t.lightMap||t.lightVertexColor){const e=t.dirLightMap&&t.litOptions.useSpecular,s=e?"lightmapDirPS":"lightmapSinglePS";l.append("vec3 dLightmap;"),e&&l.append("vec3 dLightmapDir;"),h.append(this._addMap("light",s,t,i.chunks,o,t.lightMapEncoding)),c.append("getLightMap();"),d.append("litArgs_lightmap = dLightmap;"),e&&d.append("litArgs_lightmapDir = dLightmapDir;")}}else{const e=t.litOptions.opacityShadowDither;(t.litOptions.alphaTest||e)&&(l.append("float dAlpha;"),h.append(this._addMap("opacity","opacityPS",t,i.chunks,o)),c.append("getOpacity();"),d.append("litArgs_opacity = dAlpha;"),t.litOptions.alphaTest&&(h.append(i.chunks.alphaTestPS),c.append("alphaTest(dAlpha);")),e!==il&&(e===nl&&l.append(i.chunks.bayerPS),l.append(`#define DITHER_${e.toUpperCase()}\n`),l.append(i.chunks.opacityDitherPS),c.append("opacityDither(dAlpha, 0.0);")))}l.append(i.chunks.litShaderArgsPS),h.append(`void evaluateFrontend() { \n${c.code}\n${d.code}\n }\n`),c.code="evaluateFrontend();";for(const e in o)l.append(`uniform sampler2D ${o[e]};`);return c.code=`\n${c.code.split("\n").map((e=>`    ${e}`)).join("\n")}\n\n`,i.generateFragmentShader(l.code,h.code,c.code,u),i.getDefinition(t)}},Iu=(e,t)=>{if(e.length!==t.length)return!1;for(let s=0;s<e.length;++s)if(e[s]!==t[s])return!1;return!0};class Fu{constructor(){this._mapXForms=null}updateMinRef(e,t,s,i,n,r){this._updateSharedOptions(e,t,s,i,n),this._updateMinOptions(e,s,n),this._updateUVOptions(e,s,i,!0)}updateRef(e,t,s,i,n,r,a){this._updateSharedOptions(e,t,i,n,r),this._updateEnvOptions(e,i,t,s),this._updateMaterialOptions(e,i),e.litOptions.hasTangents=n&&!!(512&n),this._updateLightOptions(e,t,i,n,a),this._updateUVOptions(e,i,n,!1,s)}_updateSharedOptions(e,t,s,i,n){e.forceUv1=s.forceUv1,s.userAttributes&&(e.litOptions.userAttributes=Object.fromEntries(s.userAttributes.entries())),e.litOptions.chunks=s.chunks||{},e.litOptions.pass=n,e.litOptions.alphaTest=s.alphaTest>0,e.litOptions.blendType=s.blendType,e.litOptions.screenSpace=i&&!!(i&Ko),e.litOptions.skin=i&&!!(2&i),e.litOptions.batch=i&&!!(i&el),e.litOptions.useInstancing=i&&!!(32&i),e.litOptions.useMorphPosition=i&&!!(i&Yo),e.litOptions.useMorphNormal=i&&!!(i&Qo),e.litOptions.useMorphTextureBasedInt=i&&!!(i&Zo),e.litOptions.nineSlicedMode=s.nineSlicedMode||0,t.clusteredLightingEnabled&&s.useLighting?(e.litOptions.clusteredLightingEnabled=!0,e.litOptions.clusteredLightingCookiesEnabled=t.lighting.cookiesEnabled,e.litOptions.clusteredLightingShadowsEnabled=t.lighting.shadowsEnabled,e.litOptions.clusteredLightingShadowType=t.lighting.shadowType,e.litOptions.clusteredLightingAreaLightsEnabled=t.lighting.areaLightsEnabled):(e.litOptions.clusteredLightingEnabled=!1,e.litOptions.clusteredLightingCookiesEnabled=!1,e.litOptions.clusteredLightingShadowsEnabled=!1,e.litOptions.clusteredLightingAreaLightsEnabled=!1)}_updateUVOptions(e,t,s,i,n){let r=!1,a=!1,o=!1;s&&(r=!!(4&s),a=!!(8&s),o=!!(16&s)),e.litOptions.vertexColors=!1,this._mapXForms=[];const l={};for(const s in Du)this._updateTexOptions(e,t,s,r,a,o,i,l);this._mapXForms=null,e.litOptions.ssao=null==n?void 0:n.ssaoEnabled,e.useAO=e.litOptions.ssao,e.litOptions.lightMapEnabled=e.lightMap,e.litOptions.dirLightMapEnabled=e.dirLightMap,e.litOptions.useHeights=e.heightMap,e.litOptions.useNormals=e.normalMap,e.litOptions.useClearCoatNormals=e.clearCoatNormalMap,e.litOptions.useAo=e.aoMap||e.aoVertexColor||e.litOptions.ssao,e.litOptions.diffuseMapEnabled=e.diffuseMap}_updateTexOptions(e,t,s,i,n,r,a,o){const l="opacity"===s;if(!a||l){const a=`${s}Map`,h=`${s}VertexColor`,c=`${s}VertexColorChannel`,d=`${a}Channel`,u=`${a}Transform`,p=`${a}Uv`,f=`${a}Identifier`;if("light"!==s&&(e[a]=!1,e[f]=void 0,e[d]="",e[u]=0,e[p]=0),e[h]=!1,e[c]="",l&&3===t.blendType&&0===t.alphaTest&&!t.alphaToCoverage&&t.opacityDither===il)return;if("height"!==s&&t[h]&&r&&(e[h]=t[h],e[c]=t[c],e.litOptions.vertexColors=!0),t[a]){let r=!0;if(0!==t[p]||i||(r=!1),1!==t[p]||n||(r=!1),r){const i=t[a].id;let n=o[i];void 0===n&&(o[i]=s,n=s),e[a]=!!t[a],e[f]=n,e[u]=this._getMapTransformID(t.getUniform(u),t[p]),e[d]=t[d],e[p]=t[p]}}}}_updateMinOptions(e,t,s){const i=1===s;e.litOptions.opacityShadowDither=i?t.opacityDither:t.opacityShadowDither,e.litOptions.linearDepth=i,e.litOptions.lights=[]}_updateMaterialOptions(e,t){var s,i,n,r;const a=!!(t.useMetalness||t.specularMap||t.sphereMap||t.cubeMap||(o=t.specular,0!==o.r||0!==o.g||0!==o.b)||t.specularityFactor>0&&t.useMetalness||t.enableGGXSpecular||t.clearCoat>0);var o;const l=!t.useMetalness||t.useMetalnessSpecularColor,h=a&&(t.specularTint||!t.specularMap&&!t.specularVertexColor)&&(e=>1!==e.r||1!==e.g||1!==e.b)(t.specular),c=a&&t.useMetalnessSpecularColor&&(t.specularityFactorTint||t.specularityFactor<1&&!t.specularityFactorMap),d=!!t.normalMap&&(t.normalMap.format===js||t.normalMap.type===Li),u=(e,t)=>Math.abs(e-t)<1e-4;e.specularTint=h?2:0,e.specularityFactorTint=c?1:0,e.metalnessTint=t.useMetalness&&t.metalness<1?1:0,e.glossTint=1,e.diffuseEncoding=null==(s=t.diffuseMap)?void 0:s.encoding,e.diffuseDetailEncoding=null==(i=t.diffuseDetailMap)?void 0:i.encoding,e.emissiveEncoding=null==(n=t.emissiveMap)?void 0:n.encoding,e.lightMapEncoding=null==(r=t.lightMap)?void 0:r.encoding,e.packedNormal=d,e.refractionTint=u(t.refraction,1)?0:1,e.refractionIndexTint=u(t.refractionIndex,1/1.5)?0:1,e.thicknessTint=t.useDynamicRefraction&&1!==t.thickness?1:0,e.specularEncoding=t.specularEncoding||"linear",e.sheenEncoding=t.sheenEncoding||"linear",e.aoMapUv=t.aoUvSet,e.aoDetail=!!t.aoMap,e.diffuseDetail=!!t.diffuseMap,e.normalDetail=!!t.normalMap,e.diffuseDetailMode=t.diffuseDetailMode,e.aoDetailMode=t.aoDetailMode,e.clearCoatTint=u(t.clearCoat,1)?0:1,e.clearCoatGloss=!!t.clearCoatGloss,e.clearCoatGlossTint=1!==t.clearCoatGloss?1:0,e.iorTint=u(t.refractionIndex,1/1.5)?0:1,e.iridescenceTint=1!==t.iridescence?1:0,e.glossInvert=t.glossInvert,e.sheenGlossInvert=t.sheenGlossInvert,e.clearCoatGlossInvert=t.clearCoatGlossInvert,e.useSpecularColor=l,e.litOptions.separateAmbient=!1,e.litOptions.customFragmentShader=t.customFragmentShader,e.litOptions.pixelSnap=t.pixelSnap,e.litOptions.ambientSH=!!t.ambientSH,e.litOptions.twoSidedLighting=t.twoSidedLighting,e.litOptions.occludeSpecular=t.occludeSpecular,e.litOptions.occludeSpecularFloat=1!==t.occludeSpecularIntensity,e.litOptions.useMsdf=!!t.msdfMap,e.litOptions.msdfTextAttribute=!!t.msdfTextAttribute,e.litOptions.alphaToCoverage=t.alphaToCoverage,e.litOptions.opacityFadesSpecular=t.opacityFadesSpecular,e.litOptions.opacityDither=t.opacityDither,e.litOptions.cubeMapProjection=t.cubeMapProjection,e.litOptions.occludeDirect=t.occludeDirect,e.litOptions.useSpecular=a,e.litOptions.useSpecularityFactor=(c||!!t.specularityFactorMap)&&t.useMetalnessSpecularColor,e.litOptions.enableGGXSpecular=t.enableGGXSpecular,e.litOptions.fresnelModel=t.fresnelModel,e.litOptions.useRefraction=(t.refraction||!!t.refractionMap)&&(t.useDynamicRefraction||!!e.litOptions.reflectionSource),e.litOptions.useClearCoat=!!t.clearCoat,e.litOptions.useSheen=t.useSheen,e.litOptions.useIridescence=t.useIridescence&&0!==t.iridescence,e.litOptions.useMetalness=t.useMetalness,e.litOptions.useDynamicRefraction=t.useDynamicRefraction,e.litOptions.dispersion=t.dispersion>0}_updateEnvOptions(e,t,s,i){e.litOptions.fog=t.useFog?i.fog:jo,e.litOptions.gamma=i.shaderOutputGamma,e.litOptions.toneMap=t.useTonemap?i.toneMapping:6;let n=!1;if(t.envAtlas&&t.cubeMap?(e.litOptions.reflectionSource="envAtlasHQ",e.litOptions.reflectionEncoding=t.envAtlas.encoding,e.litOptions.reflectionCubemapEncoding=t.cubeMap.encoding):t.envAtlas?(e.litOptions.reflectionSource="envAtlas",e.litOptions.reflectionEncoding=t.envAtlas.encoding):t.cubeMap?(e.litOptions.reflectionSource="cubeMap",e.litOptions.reflectionEncoding=t.cubeMap.encoding):t.sphereMap?(e.litOptions.reflectionSource="sphereMap",e.litOptions.reflectionEncoding=t.sphereMap.encoding):t.useSkybox&&s.envAtlas&&s.skybox?(e.litOptions.reflectionSource="envAtlasHQ",e.litOptions.reflectionEncoding=s.envAtlas.encoding,e.litOptions.reflectionCubemapEncoding=s.skybox.encoding,n=!0):t.useSkybox&&s.envAtlas?(e.litOptions.reflectionSource="envAtlas",e.litOptions.reflectionEncoding=s.envAtlas.encoding,n=!0):t.useSkybox&&s.skybox?(e.litOptions.reflectionSource="cubeMap",e.litOptions.reflectionEncoding=s.skybox.encoding,n=!0):(e.litOptions.reflectionSource=null,e.litOptions.reflectionEncoding=null),t.ambientSH)e.litOptions.ambientSource="ambientSH",e.litOptions.ambientEncoding=null;else{const i=t.envAtlas||(t.useSkybox&&s.envAtlas?s.envAtlas:null);i?(e.litOptions.ambientSource="envAtlas",e.litOptions.ambientEncoding=i.encoding):(e.litOptions.ambientSource="constant",e.litOptions.ambientEncoding=null)}e.litOptions.skyboxIntensity=n,e.litOptions.useCubeMapRotation=n&&s._skyboxRotationShaderInclude}_updateLightOptions(e,t,s,i,n){if(e.lightMap=!1,e.lightMapChannel="",e.lightMapUv=0,e.lightMapTransform=0,e.litOptions.lightMapWithoutAmbient=!1,e.dirLightMap=!1,i&&(e.litOptions.noShadow=!!(1&i),64&i&&(e.lightMapEncoding=7===t.lightmapPixelFormat?"rgbm":"linear",e.lightMap=!0,e.lightMapChannel="rgb",e.lightMapUv=1,e.lightMapTransform=0,e.litOptions.lightMapWithoutAmbient=!s.lightMap,128&i&&(e.dirLightMap=!0),i&Jo&&(e.litOptions.lightMapWithoutAmbient=!1))),s.useLighting){const t=[],s=i?i>>16:1;e.litOptions.lightMaskDynamic=!!(1&s),n&&(Cu.collectLights(0,n[0],t,s),Cu.collectLights(1,n[1],t,s),Cu.collectLights(2,n[2],t,s)),e.litOptions.lights=t}else e.litOptions.lights=[];0===e.litOptions.lights.length&&(e.litOptions.noShadow=!0)}_getMapTransformID(e,t){if(!e)return 0;let s=this._mapXForms[t];s||(s=[],this._mapXForms[t]=s);for(let t=0;t<s.length;t++)if(Iu(s[t][0].value,e[0].value)&&Iu(s[t][1].value,e[1].value))return t+1;return s.push(e)}}function Ou(e,t=!0,s=!0){const i={};return i[`${e}Map`]="texture",i[`${e}MapTiling`]="vec2",i[`${e}MapOffset`]="vec2",i[`${e}MapRotation`]="number",i[`${e}MapUv`]="number",t&&(i[`${e}MapChannel`]="string",s&&(i[`${e}VertexColor`]="boolean",i[`${e}VertexColorChannel`]="string")),i}const Bu=kn({name:"string",chunks:"chunks",mappingFormat:"string",_engine:"boolean",ambient:"rgb"},Ou("ao"),Ou("aoDetail",!0,!1),{aoDetailMode:"string",diffuse:"rgb"},Ou("diffuse"),Ou("diffuseDetail",!0,!1),{diffuseDetailMode:"string",specular:"rgb",specularTint:"boolean"},Ou("specular"),{occludeSpecular:"enum:occludeSpecular",specularityFactor:"number",specularityFactorTint:"boolean"},Ou("specularityFactor"),{useMetalness:"boolean",metalness:"number",enableGGXSpecular:"boolean",anisotropy:"number",metalnessTint:"boolean"},Ou("metalness"),{useMetalnessSpecularColor:"boolean",shininess:"number",gloss:"number",glossInvert:"boolean"},Ou("gloss"),{clearCoat:"number"},Ou("clearCoat"),{clearCoatGloss:"number",clearCoatGlossInvert:"boolean"},Ou("clearCoatGloss"),{clearCoatBumpiness:"number"},Ou("clearCoatNormal",!1),{useSheen:"boolean",sheen:"rgb"},Ou("sheen"),{sheenGloss:"number",sheenGlossInvert:"boolean"},Ou("sheenGloss"),{fresnelModel:"number",emissive:"rgb"},Ou("emissive"),{emissiveIntensity:"number"},Ou("normal",!1),{bumpiness:"number"},Ou("normalDetail",!1),{normalDetailMapBumpiness:"number"},Ou("height",!0,!1),{heightMapFactor:"number",alphaToCoverage:"boolean",alphaTest:"number",alphaFade:"number",opacity:"number"},Ou("opacity"),{opacityFadesSpecular:"boolean",opacityDither:"string",opacityShadowDither:"string",reflectivity:"number",refraction:"number",refractionTint:"boolean"},Ou("refraction"),{refractionIndex:"number",dispersion:"number",thickness:"number",thicknessTint:"boolean"},Ou("thickness"),{attenuation:"rgb",attenuationDistance:"number",useDynamicRefraction:"boolean",sphereMap:"texture",cubeMap:"cubemap",cubeMapProjection:"number",cubeMapProjectionBox:"boundingbox",useIridescence:"boolean",iridescence:"number",iridescenceTint:"boolean"},Ou("iridescence"),{iridescenceThicknessTint:"boolean",iridescenceThicknessMin:"number",iridescenceThicknessMax:"number",iridescenceRefractionIndex:"number"},Ou("iridescenceThickness"),Ou("light"),{depthTest:"boolean",depthFunc:"enum:depthFunc",depthWrite:"boolean",depthBias:"number",slopeDepthBias:"number",cull:"enum:cull",blendType:"enum:blendType",useFog:"boolean",useLighting:"boolean",useSkybox:"boolean",useTonemap:"boolean",envAtlas:"texture",twoSidedLighting:"boolean"}),zu=[];for(const e in Bu){"texture"===Bu[e]&&zu.push(e)}const Nu=[];for(const e in Bu){"cubemap"===Bu[e]&&Nu.push(e)}const Uu={},Vu={};let Gu=new Set;const Hu=new os;class ju extends tc{constructor(){super(),this.userAttributes=new Map,this._dirtyShader=!0,this._assetReferences={},this._activeParams=new Set,this._activeLightingParams=new Set,this.shaderOptBuilder=new Fu,this.reset()}reset(){Object.keys(Uu).forEach((e=>{this[`_${e}`]=Uu[e].value()})),this._chunks={},this._uniformCache={}}set chunks(e){this._dirtyShader=!0,this._chunks=e}get chunks(){return this._dirtyShader=!0,this._chunks}copy(e){super.copy(e),Object.keys(Uu).forEach((t=>{this[t]=e[t]}));for(const t in e._chunks)e._chunks.hasOwnProperty(t)&&(this._chunks[t]=e._chunks[t]);return this.userAttributes=new Map(e.userAttributes),this}setAttribute(e,t){this.userAttributes.set(t,e)}_setParameter(e,t){Gu.add(e),this.setParameter(e,t)}_setParameters(e){e.forEach((e=>{this._setParameter(e.name,e.value)}))}_processParameters(e){const t=this[e];t.forEach((e=>{Gu.has(e)||delete this.parameters[e]})),this[e]=Gu,Gu=t,Gu.clear()}_updateMap(e){const t=`${e}Map`,s=this[t];if(s){this._setParameter(`texture_${t}`,s);const e=`${t}Transform`,i=this.getUniform(e);i&&this._setParameters(i)}}_allocUniform(e,t){let s=this._uniformCache[e];return s||(s=t(),this._uniformCache[e]=s),s}getUniform(e,t,s){return Vu[e](this,t,s)}updateUniforms(e,t){const s=s=>this.getUniform(s,e,t);this._setParameter("material_ambient",s("ambient")),this._setParameter("material_diffuse",s("diffuse")),this._setParameter("material_aoIntensity",this.aoIntensity),this.useMetalness?((!this.metalnessMap||this.metalness<1)&&this._setParameter("material_metalness",this.metalness),this.specularMap&&!this.specularTint||this._setParameter("material_specular",s("specular")),this.specularityFactorMap&&!this.specularityFactorTint||this._setParameter("material_specularityFactor",this.specularityFactor),this._setParameter("material_sheen",s("sheen")),this._setParameter("material_sheenGloss",this.sheenGloss),this._setParameter("material_refractionIndex",this.refractionIndex)):this.specularMap&&!this.specularTint||this._setParameter("material_specular",s("specular")),this.enableGGXSpecular&&this._setParameter("material_anisotropy",this.anisotropy),this.clearCoat>0&&(this._setParameter("material_clearCoat",this.clearCoat),this._setParameter("material_clearCoatGloss",this.clearCoatGloss),this._setParameter("material_clearCoatBumpiness",this.clearCoatBumpiness)),this._setParameter("material_gloss",this.gloss),this._setParameter("material_emissive",s("emissive")),this._setParameter("material_emissiveIntensity",this.emissiveIntensity),this.refraction>0&&this._setParameter("material_refraction",this.refraction),this.dispersion>0&&this._setParameter("material_dispersion",this.dispersion),this.useDynamicRefraction&&(this._setParameter("material_thickness",this.thickness),this._setParameter("material_attenuation",s("attenuation")),this._setParameter("material_invAttenuationDistance",0===this.attenuationDistance?0:1/this.attenuationDistance)),this.useIridescence&&(this._setParameter("material_iridescence",this.iridescence),this._setParameter("material_iridescenceRefractionIndex",this.iridescenceRefractionIndex),this._setParameter("material_iridescenceThicknessMin",this.iridescenceThicknessMin),this._setParameter("material_iridescenceThicknessMax",this.iridescenceThicknessMax)),this._setParameter("material_opacity",this.opacity),!1===this.opacityFadesSpecular&&this._setParameter("material_alphaFade",this.alphaFade),this.occludeSpecular&&this._setParameter("material_occludeSpecularIntensity",this.occludeSpecularIntensity),1===this.cubeMapProjection&&this._setParameter(s("cubeMapProjectionBox"));for(const e in Du)this._updateMap(e);this.ambientSH&&this._setParameter("ambientSH[0]",this.ambientSH),this.normalMap&&this._setParameter("material_bumpiness",this.bumpiness),this.normalMap&&this.normalDetailMap&&this._setParameter("material_normalDetailMapBumpiness",this.normalDetailMapBumpiness),this.heightMap&&this._setParameter("material_heightMapFactor",s("heightMapFactor")),this.envAtlas&&this.cubeMap?(this._setParameter("texture_envAtlas",this.envAtlas),this._setParameter("texture_cubeMap",this.cubeMap)):this.envAtlas?this._setParameter("texture_envAtlas",this.envAtlas):this.cubeMap?this._setParameter("texture_cubeMap",this.cubeMap):this.sphereMap&&this._setParameter("texture_sphereMap",this.sphereMap),this._setParameter("material_reflectivity",this.reflectivity),this._processParameters("_activeParams"),this._dirtyShader&&this.clearVariants()}updateEnvUniforms(e,t){!(this.envAtlas||this.cubeMap||this.sphereMap)&&this.useSkybox&&(t.envAtlas&&t.skybox?(this._setParameter("texture_envAtlas",t.envAtlas),this._setParameter("texture_cubeMap",t.skybox)):t.envAtlas?this._setParameter("texture_envAtlas",t.envAtlas):t.skybox&&this._setParameter("texture_cubeMap",t.skybox)),this._processParameters("_activeLightingParams")}getShaderVariant(e){const{device:t,scene:s,pass:i,objDefs:n,sortedLights:r,cameraShaderParams:a}=e;this.updateEnvUniforms(t,s);const o=mc.get(t).getByIndex(i),l=2===i||3===i||1===i||o.isShadow;let h=l?Lu.optionsContextMin:Lu.optionsContext;h.defines=gl(this,a),l?this.shaderOptBuilder.updateMinRef(h,s,this,n,i,r):this.shaderOptBuilder.updateRef(h,s,a,this,n,i,r),this.onUpdateShader&&(h=this.onUpdateShader(h));const c=new ol(e.viewUniformFormat,e.viewBindGroupFormat,e.vertexFormat),d=ul(t);d.register("standard",Lu);const u=d.getProgram("standard",h,c,this.userId);return this._dirtyShader=!1,u}destroy(){for(const e in this._assetReferences)this._assetReferences[e]._unbind();this._assetReferences=null,super.destroy()}}ju.TEXTURE_PARAMETERS=zu,ju.CUBEMAP_PARAMETERS=Nu;const Wu=(e,t)=>{Vu[e]=t},$u=(e,t,s,i)=>{Object.defineProperty(ju.prototype,e,{get:i||function(){return this[`_${e}`]},set:s}),Uu[e]={value:t}},qu=e=>{const t=`_${e.name}`,s=e.dirtyShaderFunc||(()=>!0);$u(e.name,(()=>e.defaultValue),(function(e){const i=this[t];i!==e&&(this._dirtyShader=this._dirtyShader||s(i,e),this[t]=e)}),e.getterFunc)},Xu=e=>{const t=`_${e.name}`,s=e.dirtyShaderFunc||(()=>!0);$u(e.name,(()=>e.defaultValue.clone()),(function(e){const i=this[t];i.equals(e)||(this._dirtyShader=this._dirtyShader||s(i,e),this[t]=i.copy(e))}),e.getterFunc)},Ku=e=>e.defaultValue&&e.defaultValue.clone?Xu(e):qu(e);function Yu(e,t="rgb",s=!0,i=0){Du[e]=t.length||-1,Ku({name:`${e}Map`,defaultValue:null,dirtyShaderFunc:(e,t)=>!!e!=!!t||e&&(e.type!==t.type||e.format!==t.format)}),Ku({name:`${e}MapTiling`,defaultValue:new ws(1,1)}),Ku({name:`${e}MapOffset`,defaultValue:new ws(0,0)}),Ku({name:`${e}MapRotation`,defaultValue:0}),Ku({name:`${e}MapUv`,defaultValue:i}),t&&(Ku({name:`${e}MapChannel`,defaultValue:t}),s&&(Ku({name:`${e}VertexColor`,defaultValue:!1}),Ku({name:`${e}VertexColorChannel`,defaultValue:t})));const n=`${e}MapTiling`,r=`${e}MapOffset`,a=`${e}MapRotation`,o=`${e}MapTransform`;Wu(o,((e,t,s)=>{const i=e[n],l=e[r],h=e[a];if(1===i.x&&1===i.y&&0===l.x&&0===l.y&&0===h)return null;const c=e._allocUniform(o,(()=>[{name:`texture_${o}0`,value:new Float32Array(3)},{name:`texture_${o}1`,value:new Float32Array(3)}])),d=Math.cos(h*rs.DEG_TO_RAD),u=Math.sin(h*rs.DEG_TO_RAD),p=c[0].value;p[0]=d*i.x,p[1]=-u*i.y,p[2]=l.x;const f=c[1].value;return f[0]=u*i.x,f[1]=d*i.y,f[2]=1-i.y-l.y,c}))}function Qu(e,t){Ku({name:e,defaultValue:t,getterFunc:function(){return this._dirtyShader=!0,this[`_${e}`]}}),Wu(e,((t,s,i)=>{const n=t._allocUniform(e,(()=>new Float32Array(3))),r=t[e];return Hu.linear(r),n[0]=Hu.r,n[1]=Hu.g,n[2]=Hu.b,n}))}function Ju(e,t,s){Ku({name:e,defaultValue:t,dirtyShaderFunc:(e,t)=>(0===e||1===e)!=(0===t||1===t)}),Wu(e,s)}function Zu(e,t){Ku({name:e,defaultValue:null,dirtyShaderFunc:(e,t)=>!!e==!!t}),Wu(e,t)}function ep(e,t){Ku({name:e,defaultValue:t})}!function(){Qu("ambient",new os(1,1,1)),Qu("diffuse",new os(1,1,1)),Qu("specular",new os(0,0,0)),Qu("emissive",new os(0,0,0)),Qu("sheen",new os(1,1,1)),Qu("attenuation",new os(1,1,1)),Ju("emissiveIntensity",1),Ju("specularityFactor",1),Ju("sheenGloss",0),Ju("gloss",.25),Ju("aoIntensity",1),Ju("heightMapFactor",1,((e,t,s)=>.025*e.heightMapFactor)),Ju("opacity",1),Ju("alphaFade",1),Ju("alphaTest",0),Ju("bumpiness",1),Ju("normalDetailMapBumpiness",1),Ju("reflectivity",1),Ju("occludeSpecularIntensity",1),Ju("refraction",0),Ju("refractionIndex",1/1.5),Ju("dispersion",0),Ju("thickness",0),Ju("attenuationDistance",0),Ju("metalness",1),Ju("anisotropy",0),Ju("clearCoat",0),Ju("clearCoatGloss",1),Ju("clearCoatBumpiness",1),Ju("aoUvSet",0,null),Ju("iridescence",0),Ju("iridescenceRefractionIndex",1/1.5),Ju("iridescenceThicknessMin",0),Ju("iridescenceThicknessMax",0),Zu("ambientSH"),Zu("cubeMapProjectionBox",((e,t,s)=>{const i=e._allocUniform("cubeMapProjectionBox",(()=>[{name:"envBoxMin",value:new Float32Array(3)},{name:"envBoxMax",value:new Float32Array(3)}])),n=e.cubeMapProjectionBox.getMin(),r=i[0].value;r[0]=n.x,r[1]=n.y,r[2]=n.z;const a=e.cubeMapProjectionBox.getMax(),o=i[1].value;return o[0]=a.x,o[1]=a.y,o[2]=a.z,i})),ep("specularTint",!1),ep("specularityFactorTint",!1),ep("useMetalness",!1),ep("useMetalnessSpecularColor",!1),ep("useSheen",!1),ep("enableGGXSpecular",!1),ep("occludeDirect",!1),ep("opacityFadesSpecular",!0),ep("occludeSpecular",1),ep("fresnelModel",2),ep("useDynamicRefraction",!1),ep("cubeMapProjection",0),ep("customFragmentShader",null),ep("useFog",!0),ep("useLighting",!0),ep("useTonemap",!0),ep("useSkybox",!0),ep("forceUv1",!1),ep("pixelSnap",!1),ep("twoSidedLighting",!1),ep("nineSlicedMode",void 0),ep("msdfTextAttribute",!1),ep("useIridescence",!1),ep("glossInvert",!1),ep("sheenGlossInvert",!1),ep("clearCoatGlossInvert",!1),ep("opacityDither",il),ep("opacityShadowDither",il),Yu("diffuse"),Yu("specular"),Yu("emissive"),Yu("thickness","g"),Yu("specularityFactor","g"),Yu("normal",""),Yu("metalness","g"),Yu("gloss","g"),Yu("opacity","a"),Yu("refraction","g"),Yu("height","g",!1),Yu("ao","g"),Yu("light","rgb",!0,1),Yu("msdf",""),Yu("diffuseDetail","rgb",!1),Yu("normalDetail",""),Yu("aoDetail","g",!1),Yu("clearCoat","g"),Yu("clearCoatGloss","g"),Yu("clearCoatNormal",""),Yu("sheen","rgb"),Yu("sheenGloss","g"),Yu("iridescence","g"),Yu("iridescenceThickness","g"),ep("diffuseDetailMode","mul"),ep("aoDetailMode","mul"),Zu("cubeMap"),Zu("sphereMap"),Zu("envAtlas");const e=[null,null,null,null,null,null];$u("prefilteredCubemaps",(()=>e.slice()),(function(e){const t=this._prefilteredCubemaps;e=e||[];let s=!1,i=!0;for(let n=0;n<6;++n){const r=e[n]||null;t[n]!==r&&(t[n]=r,s=!0),i=i&&!!t[n]}s&&(i?this.envAtlas=bu.generatePrefilteredAtlas(t,{target:this.envAtlas}):this.envAtlas&&(this.envAtlas.destroy(),this.envAtlas=null),this._dirtyShader=!0)}),(function(){return this._prefilteredCubemaps}))}();const tp=4/64,sp=.875;class ip extends Nd{constructor(e,t,s,i,n,r){super();const a=new ys,o=new ys,l=new ys,h=new ys,c=new ys,d=new ys,u=[],p=[],f=[],m=[],g=[];let _;if(s>0)for(let r=0;r<=i;r++)for(let _=0;_<=n;_++){const v=_/n*2*Math.PI-Math.PI,b=Math.sin(v),y=Math.cos(v);c.set(b*e,-s/2,y*e),h.set(b*t,s/2,y*t),a.lerp(c,h,r/i),o.sub2(h,c).normalize(),d.set(y,0,-b),l.cross(d,o).normalize(),u.push(a.x,a.y,a.z),p.push(l.x,l.y,l.z);let x=_/n,w=r/i;f.push(x,1-w);const S=w;if(w=x,x=S,x=x*sp+tp,w=w*sp+tp,x/=3,m.push(x,1-w),r<i&&_<n){const e=r*(n+1)+_,t=r*(n+1)+(_+1),s=(r+1)*(n+1)+_,i=(r+1)*(n+1)+(_+1);g.push(e,t,s),g.push(t,i,s)}}if(r){const e=Math.floor(n/2),r=n,a=s/2;for(let s=0;s<=e;s++){const i=s*Math.PI*.5/e,n=Math.sin(i),o=Math.cos(i);for(let i=0;i<=r;i++){const l=2*i*Math.PI/r-Math.PI/2,h=Math.sin(l),c=Math.cos(l)*n,d=o,g=h*n;let _=1-i/r,v=1-s/e;u.push(c*t,d*t+a,g*t),p.push(c,d,g),f.push(_,1-v),_=_*sp+tp,v=v*sp+tp,_/=3,v/=3,_+=1/3,m.push(_,1-v)}}_=(i+1)*(n+1);for(let t=0;t<e;++t)for(let e=0;e<r;++e){const s=t*(r+1)+e,i=s+r+1;g.push(_+s+1,_+i,_+s),g.push(_+s+1,_+i+1,_+i)}for(let s=0;s<=e;s++){const i=.5*Math.PI+s*Math.PI*.5/e,n=Math.sin(i),o=Math.cos(i);for(let i=0;i<=r;i++){const l=2*i*Math.PI/r-Math.PI/2,h=Math.sin(l),c=Math.cos(l)*n,d=o,g=h*n;let _=1-i/r,v=1-s/e;u.push(c*t,d*t-a,g*t),p.push(c,d,g),f.push(_,1-v),_=_*sp+tp,v=v*sp+tp,_/=3,v/=3,_+=2/3,m.push(_,1-v)}}_=(i+1)*(n+1)+(r+1)*(e+1);for(let t=0;t<e;++t)for(let e=0;e<r;++e){const s=t*(r+1)+e,i=s+r+1;g.push(_+s+1,_+i,_+s),g.push(_+s+1,_+i+1,_+i)}}else{if(_=(i+1)*(n+1),e>0)for(let t=0;t<n;t++){const i=t/n*2*Math.PI,r=Math.sin(i),a=-s/2,o=Math.cos(i);let l=1-(r+1)/2,h=(o+1)/2;u.push(r*e,a,o*e),p.push(0,-1,0),f.push(l,1-h),l=l*sp+tp,h=h*sp+tp,l/=3,h/=3,l+=1/3,m.push(l,1-h),t>1&&g.push(_,_+t,_+t-1)}if(_+=n,t>0)for(let e=0;e<n;e++){const i=e/n*2*Math.PI,r=Math.sin(i),a=s/2,o=Math.cos(i);let l=1-(r+1)/2,h=(o+1)/2;u.push(r*t,a,o*t),p.push(0,1,0),f.push(l,1-h),l=l*sp+tp,h=h*sp+tp,l/=3,h/=3,l+=2/3,m.push(l,1-h),e>1&&g.push(_,_+e-1,_+e)}}this.positions=u,this.normals=p,this.uvs=f,this.uvs1=m,this.indices=g}}class np extends ip{constructor(e={}){var t,s,i,n;const r=null!=(t=e.radius)?t:.3;super(r,r,(null!=(s=e.height)?s:1)-2*r,null!=(i=e.heightSegments)?i:1,null!=(n=e.sides)?n:20,!0),e.calculateTangents&&(this.tangents=zd(this.positions,this.normals,this.uvs,this.indices))}}class rp extends ip{constructor(e={}){var t,s,i,n,r;super(null!=(t=e.baseRadius)?t:.5,null!=(s=e.peakRadius)?s:0,null!=(i=e.height)?i:1,null!=(n=e.heightSegments)?n:5,null!=(r=e.capSegments)?r:18,!1),e.calculateTangents&&(this.tangents=zd(this.positions,this.normals,this.uvs,this.indices))}}class ap extends ip{constructor(e={}){var t,s,i,n;const r=null!=(t=e.radius)?t:.5;super(r,r,null!=(s=e.height)?s:1,null!=(i=e.heightSegments)?i:5,null!=(n=e.capSegments)?n:20,!1),e.calculateTangents&&(this.tangents=zd(this.positions,this.normals,this.uvs,this.indices))}}class op extends Nd{constructor(e={}){var t,s,i;super();const n=null!=(t=e.halfExtents)?t:new ws(.5,.5),r=null!=(s=e.widthSegments)?s:5,a=null!=(i=e.lengthSegments)?i:5,o=[],l=[],h=[],c=[];let d=0;for(let e=0;e<=r;e++)for(let t=0;t<=a;t++){const s=-n.x+2*n.x*e/r,i=0,u=-(-n.y+2*n.y*t/a),p=e/r,f=t/a;o.push(s,i,u),l.push(0,1,0),h.push(p,1-f),e<r&&t<a&&(c.push(d+a+1,d+1,d),c.push(d+a+1,d+a+2,d+1)),d++}this.positions=o,this.normals=l,this.uvs=h,this.uvs1=h,this.indices=c,e.calculateTangents&&(this.tangents=zd(o,l,h,c))}}class lp extends Nd{constructor(e={}){var t,s,i,n,r;super();const a=null!=(t=e.tubeRadius)?t:.2,o=null!=(s=e.ringRadius)?s:.3,l=(null!=(i=e.sectorAngle)?i:360)*rs.DEG_TO_RAD,h=null!=(n=e.segments)?n:30,c=null!=(r=e.sides)?r:20,d=[],u=[],p=[],f=[];for(let e=0;e<=c;e++)for(let t=0;t<=h;t++){const s=Math.cos(l*t/h)*(o+a*Math.cos(2*Math.PI*e/c)),i=Math.sin(2*Math.PI*e/c)*a,n=Math.sin(l*t/h)*(o+a*Math.cos(2*Math.PI*e/c)),r=Math.cos(l*t/h)*Math.cos(2*Math.PI*e/c),m=Math.sin(2*Math.PI*e/c),g=Math.sin(l*t/h)*Math.cos(2*Math.PI*e/c),_=e/c,v=1-t/h;if(d.push(s,i,n),u.push(r,m,g),p.push(_,1-v),e<c&&t<h){const s=e*(h+1)+t,i=(e+1)*(h+1)+t,n=e*(h+1)+(t+1),r=(e+1)*(h+1)+(t+1);f.push(s,i,n),f.push(i,r,n)}}this.positions=d,this.normals=u,this.uvs=p,this.uvs1=p,this.indices=f,e.calculateTangents&&(this.tangents=zd(d,u,p,f))}}class hp{constructor(e,t){this.processedCache=new Map,this.definitionsCache=new Map,this._generators=new Map,this._device=e,this._isClearingCache=!1,this._precached=!1,this._programsCollection=[],this._defaultStdMatOption=new Mu,this._defaultStdMatOptionMin=new Mu;const s=new Xl;t.shaderOptBuilder.updateRef(this._defaultStdMatOption,{},s,t,null,[],0,null),t.shaderOptBuilder.updateMinRef(this._defaultStdMatOptionMin,{},t,null,4,null),e.on("destroy:shader",(e=>{this.removeFromCache(e)}))}destroy(){this.clearCache()}register(e,t){this._generators.has(e)||this._generators.set(e,t)}unregister(e){this._generators.has(e)&&this._generators.delete(e)}isRegistered(e){return this._generators.has(e)}generateShaderDefinition(e,t,s,i){let n=this.definitionsCache.get(s);if(!n){var r,a,o;let l;null!=(r=i.litOptions)&&r.lights&&(l=i.litOptions.lights,i.litOptions.lights=l.map((e=>{const t=e.clone?e.clone():e;return t.key=e.key,t}))),this.storeNewProgram(t,i),null!=(a=i.litOptions)&&a.lights&&(i.litOptions.lights=l);const h=this._device;n=e.createShaderDefinition(h,i),n.name=null!=(o=n.name)?o:i.pass?`${t}-pass:${i.pass}`:t,this.definitionsCache.set(s,n)}return n}getCachedShader(e){return this.processedCache.get(e)}setCachedShader(e,t){this.processedCache.set(e,t)}getProgram(e,t,s,i){const n=this._generators.get(e);if(!n)return null;const r=jn(n.generateKey(t)),a=`${r}#${jn(s.generateKey(this._device))}`;let o=this.getCachedShader(a);if(!o){const l=this.generateShaderDefinition(n,e,r,t);let h,c="";void 0!==t.pass&&(h=mc.get(this._device).getByIndex(t.pass),c=`-${h.name}`),this._device.fire("shader:generate",{userMaterialId:i,shaderPassInfo:h,definition:l});const d={name:`${l.name}${c}-proc`,attributes:l.attributes,vshader:l.vshader,vincludes:l.vincludes,fincludes:l.fincludes,fshader:l.fshader,processingOptions:s,shaderLanguage:l.shaderLanguage,meshUniformBufferFormat:l.meshUniformBufferFormat,meshBindGroupFormat:l.meshBindGroupFormat};o=new ba(this._device,d),this.setCachedShader(a,o)}return o}storeNewProgram(e,t){let s={};if("standard"===e){const e=this._getDefaultStdMatOptions(t.pass);for(const i in t)(t.hasOwnProperty(i)&&e[i]!==t[i]||"pass"===i)&&(s[i]=t[i]);for(const e in t.litOptions)s[e]=t.litOptions[e]}else s=t;this._programsCollection.push(JSON.stringify({name:e,options:s}))}dumpPrograms(){let e="let device = pc.app ? pc.app.graphicsDevice : pc.Application.getApplication().graphicsDevice;\n";e+="let shaders = [",this._programsCollection[0]&&(e+=`\n\t${this._programsCollection[0]}`);for(let t=1;t<this._programsCollection.length;++t)e+=`,\n\t${this._programsCollection[t]}`;e+="\n];\n",e+="pc.getProgramLibrary(device).precompile(shaders);\n",e+=`if (pc.version != "${Mt}" || pc.revision != "${Dt}")\n`,e+='\tconsole.warn("precompile-shaders.js: engine version mismatch, rebuild shaders lib with current engine");';const t=document.createElement("a");t.setAttribute("href",`data:text/plain;charset=utf-8,${encodeURIComponent(e)}`),t.setAttribute("download","precompile-shaders.js"),t.style.display="none",document.body.appendChild(t),t.click(),document.body.removeChild(t)}clearCache(){this._isClearingCache=!0,this.processedCache.forEach((e=>{e.destroy()})),this.processedCache.clear(),this._isClearingCache=!1}removeFromCache(e){this._isClearingCache||this.processedCache.forEach(((t,s)=>{e===t&&this.processedCache.delete(s)}))}_getDefaultStdMatOptions(e){const t=mc.get(this._device).getByIndex(e);return 2===e||3===e||1===e||t.isShadow?this._defaultStdMatOptionMin:this._defaultStdMatOption}precompile(e){if(e){const t=new Array(e.length);for(let s=0;s<e.length;s++){if("standard"===e[s].name){const t=e[s].options,i=this._getDefaultStdMatOptions(t.pass);for(const e in i)i.hasOwnProperty(e)&&void 0===t[e]&&(t[e]=i[e])}t[s]=this.getProgram(e[s].name,e[s].options)}}this._precached=!0}}const cp={bakeDirLmEndPS:"\n\tvec4 dirLm = texture2D(texture_dirLightMap, vUv1);\n\tif (bakeDir > 0.5) {\n\t\tif (dAtten > 0.00001) {\n\t\t\tdirLm.xyz = dirLm.xyz * 2.0 - vec3(1.0);\n\t\t\tdAtten = saturate(dAtten);\n\t\t\tgl_FragColor.rgb = normalize(dLightDirNormW.xyz*dAtten + dirLm.xyz*dirLm.w) * 0.5 + vec3(0.5);\n\t\t\tgl_FragColor.a = dirLm.w + dAtten;\n\t\t\tgl_FragColor.a = max(gl_FragColor.a, 1.0 / 255.0);\n\t\t} else {\n\t\t\tgl_FragColor = dirLm;\n\t\t}\n\t} else {\n\t\tgl_FragColor.rgb = dirLm.xyz;\n\t\tgl_FragColor.a = max(dirLm.w, dAtten > 0.00001? (1.0/255.0) : 0.0);\n\t}\n",bakeLmEndPS:"\n#ifdef LIGHTMAP_RGBM\n\tgl_FragColor.rgb = dDiffuseLight;\n\tgl_FragColor.rgb = pow(gl_FragColor.rgb, vec3(0.5));\n\tgl_FragColor.rgb /= 8.0;\n\tgl_FragColor.a = clamp( max( max( gl_FragColor.r, gl_FragColor.g ), max( gl_FragColor.b, 1.0 / 255.0 ) ), 0.0,1.0 );\n\tgl_FragColor.a = ceil(gl_FragColor.a * 255.0) / 255.0;\n\tgl_FragColor.rgb /= gl_FragColor.a;\n#else\n\tgl_FragColor = vec4(dDiffuseLight, 1.0);\n#endif\n",dilatePS:"\nvarying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\nvoid main(void) {\n\tvec4 c = texture2DLodEXT(source, vUv0, 0.0);\n\tc = c.a>0.0? c : texture2DLodEXT(source, vUv0 - pixelOffset, 0.0);\n\tc = c.a>0.0? c : texture2DLodEXT(source, vUv0 + vec2(0, -pixelOffset.y), 0.0);\n\tc = c.a>0.0? c : texture2DLodEXT(source, vUv0 + vec2(pixelOffset.x, -pixelOffset.y), 0.0);\n\tc = c.a>0.0? c : texture2DLodEXT(source, vUv0 + vec2(-pixelOffset.x, 0), 0.0);\n\tc = c.a>0.0? c : texture2DLodEXT(source, vUv0 + vec2(pixelOffset.x, 0), 0.0);\n\tc = c.a>0.0? c : texture2DLodEXT(source, vUv0 + vec2(-pixelOffset.x, pixelOffset.y), 0.0);\n\tc = c.a>0.0? c : texture2DLodEXT(source, vUv0 + vec2(0, pixelOffset.y), 0.0);\n\tc = c.a>0.0? c : texture2DLodEXT(source, vUv0 + pixelOffset, 0.0);\n\tgl_FragColor = c;\n}\n",bilateralDeNoisePS:"\nfloat normpdf3(in vec3 v, in float sigma) {\n\treturn 0.39894 * exp(-0.5 * dot(v, v) / (sigma * sigma)) / sigma;\n}\nvec3 decodeRGBM(vec4 rgbm) {\n\tvec3 color = (8.0 * rgbm.a) * rgbm.rgb;\n\treturn color * color;\n}\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec4 encodeRGBM(vec3 color) {\n\tvec4 encoded;\n\tencoded.rgb = pow(color.rgb, vec3(0.5));\n\tencoded.rgb *= 1.0 / 8.0;\n\tencoded.a = saturate( max( max( encoded.r, encoded.g ), max( encoded.b, 1.0 / 255.0 ) ) );\n\tencoded.a = ceil(encoded.a * 255.0) / 255.0;\n\tencoded.rgb /= encoded.a;\n\treturn encoded;\n}\n#define MSIZE 15\nvarying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\nuniform vec2 sigmas;\nuniform float bZnorm;\nuniform float kernel[MSIZE];\nvoid main(void) {\n\t\n\tvec4 pixelRgbm = texture2DLodEXT(source, vUv0, 0.0);\n\tif (pixelRgbm.a <= 0.0) {\n\t\tgl_FragColor = pixelRgbm;\n\t\treturn ;\n\t}\n\tfloat sigma = sigmas.x;\n\tfloat bSigma = sigmas.y;\n\tvec3 pixelHdr = decodeRGBM(pixelRgbm);\n\tvec3 accumulatedHdr = vec3(0.0);\n\tfloat accumulatedFactor = 0.0;\n\tconst int kSize = (MSIZE-1)/2;\n\tfor (int i = -kSize; i <= kSize; ++i) {\n\t\tfor (int j = -kSize; j <= kSize; ++j) {\n\t\t\t\n\t\t\tvec2 coord = vUv0 + vec2(float(i), float(j)) * pixelOffset;\n\t\t\tvec4 rgbm = texture2DLodEXT(source, coord, 0.0);\n\t\t\tif (rgbm.a > 0.0) {\n\t\t\t\tvec3 hdr = decodeRGBM(rgbm);\n\t\t\t\tfloat factor = kernel[kSize + j] * kernel[kSize + i];\n\t\t\t\tfactor *= normpdf3(hdr - pixelHdr, bSigma) * bZnorm;\n\t\t\t\taccumulatedHdr += factor * hdr;\n\t\t\t\taccumulatedFactor += factor;\n\t\t\t}\n\t\t}\n\t}\n\tgl_FragColor = encodeRGBM(accumulatedHdr / accumulatedFactor);\n}\n"},dp=new As,up=new Ds,pp=new Bs,fp=new Bs,mp=new os(1,1,0,.4),gp=.28209479177387814;class _p{constructor(e,t,s,i,n){const r=e.getProp("x"),a=e.getProp("y"),o=e.getProp("z"),l=e.getProp("rot_1"),h=e.getProp("rot_2"),c=e.getProp("rot_3"),d=e.getProp("rot_0"),u=e.getProp("scale_0"),p=e.getProp("scale_1"),f=e.getProp("scale_2"),m=e.getProp("f_dc_0"),g=e.getProp("f_dc_1"),_=e.getProp("f_dc_2"),v=e.getProp("opacity");this.read=e=>{t&&(t.x=r[e],t.y=a[e],t.z=o[e]),s&&s.set(l[e],h[e],c[e],d[e]),i&&i.set(Math.exp(u[e]),Math.exp(p[e]),Math.exp(f[e])),n&&n.set(.5+m[e]*gp,.5+g[e]*gp,.5+_[e]*gp,(e=>{if(e>0)return 1/(1+Math.exp(-e));const t=Math.exp(e);return t/(1+t)})(v[e]))}}}const vp=(e,t,s)=>{up.set(s.x,s.y,s.z,s.w).normalize(),e.setTRS(t,up,ys.ONE)};class bp{constructor(e){this.elements=void 0,this.numSplats=void 0,this.elements=e,this.numSplats=this.getElement("vertex").count}static calcSplatAabb(e,t,s,i){vp(dp,t,s),pp.center.set(0,0,0),pp.halfExtents.set(2*i.x,2*i.y,2*i.z),e.setFromTransformedAabb(pp,dp)}getProp(e,t="vertex"){var s;return null==(s=this.getElement(t))||null==(s=s.properties.find((t=>t.name===e)))?void 0:s.storage}getElement(e){return this.elements.find((t=>t.name===e))}addProp(e,t){this.getElement("vertex").properties.push({type:"float",name:e,storage:t,byteSize:4})}createIter(e,t,s,i){return new _p(this,e,t,s,i)}calcAabb(e,t){let s,i,n,r,a,o,l=!0;const h=this.getProp("x"),c=this.getProp("y"),d=this.getProp("z"),u=this.getProp("scale_0"),p=this.getProp("scale_1"),f=this.getProp("scale_2");for(let e=0;e<this.numSplats;++e){if(t&&!t(e))continue;const m=2*Math.exp(Math.max(u[e],p[e],f[e])),g=h[e],_=c[e],v=d[e];l?(l=!1,s=g-m,i=_-m,n=v-m,r=g+m,a=_+m,o=v+m):(s=Math.min(s,g-m),i=Math.min(i,_-m),n=Math.min(n,v-m),r=Math.max(r,g+m),a=Math.max(a,_+m),o=Math.max(o,v+m))}return l||(e.center.set(.5*(s+r),.5*(i+a),.5*(n+o)),e.halfExtents.set(.5*(r-s),.5*(a-i),.5*(o-n))),!l}calcAabbExact(e,t){const s=new ys,i=new Ds,n=new ys,r=this.createIter(s,i,n);let a=!0;for(let o=0;o<this.numSplats;++o)t&&!t(o)||(r.read(o),a?(a=!1,bp.calcSplatAabb(e,s,i,n)):(bp.calcSplatAabb(fp,s,i,n),e.add(fp)));return!a}getCenters(e){const t=this.getProp("x"),s=this.getProp("y"),i=this.getProp("z");for(let n=0;n<this.numSplats;++n)e[3*n+0]=t[n],e[3*n+1]=s[n],e[3*n+2]=i[n]}calcFocalPoint(e,t){const s=this.getProp("x"),i=this.getProp("y"),n=this.getProp("z"),r=this.getProp("scale_0"),a=this.getProp("scale_1"),o=this.getProp("scale_2");e.x=0,e.y=0,e.z=0;let l=0;for(let h=0;h<this.numSplats;++h){if(t&&!t(h))continue;const c=1/(1+Math.exp(Math.max(r[h],a[h],o[h])));e.x+=s[h]*c,e.y+=i[h]*c,e.z+=n[h]*c,l+=c}e.mulScalar(1/l)}renderWireframeBounds(e,t){const s=new ys,i=new Ds,n=new ys,r=new ys,a=new ys,o=this.createIter(s,i,n);for(let l=0;l<this.numSplats;++l)o.read(l),vp(dp,s,i),dp.mul2(t,dp),r.set(-2*n.x,-2*n.y,-2*n.z),a.set(2*n.x,2*n.y,2*n.z),e.immediate.drawWireAlignedBox(r,a,mp,!0,e.defaultDrawLayer,dp)}get isCompressed(){return!1}get hasSHData(){for(let e=0;e<45;++e)if(!this.getProp(`f_rest_${e}`))return!1;return!0}calcMortonOrder(){const e=e=>{let t=e[0],s=e[0];for(let i=1;i<e.length;i++)e[i]<t&&(t=e[i]),e[i]>s&&(s=e[i]);return{min:t,max:s}},t=(e,t,s)=>{const i=e=>e=153391689&((e=51130563&((e=50393103&((e=4278190335&((e&=1023)^e<<16))^e<<8))^e<<4))^e<<2);return(i(s)<<2)+(i(t)<<1)+i(e)},s=this.getProp("x"),i=this.getProp("y"),n=this.getProp("z"),{min:r,max:a}=e(s),{min:o,max:l}=e(i),{min:h,max:c}=e(n),d=r===a?0:1024/(a-r),u=o===l?0:1024/(l-o),p=h===c?0:1024/(c-h),f=new Map;for(let e=0;e<this.numSplats;e++){const a=t(Math.floor((s[e]-r)*d),Math.floor((i[e]-o)*u),Math.floor((n[e]-h)*p)),l=f.get(a);l?l.push(e):f.set(a,[e])}const m=Array.from(f.keys()).sort(((e,t)=>e-t)),g=new Uint32Array(this.numSplats);let _=0;for(let e=0;e<m.length;++e){const t=f.get(m[e]);for(let e=0;e<t.length;++e)g[_++]=t[e]}return g}reorder(e){const t=new Map,s=s=>{const i=new s.constructor((e=>{if(t.has(e)){const s=t.get(e);return t.delete(e),s}return new ArrayBuffer(e)})(s.byteLength));for(let t=0;t<e.length;t++)i[t]=s[e[t]];var n;return n=s.buffer,t.set(n.byteLength,n),i};this.elements.forEach((e=>{e.properties.forEach((e=>{e.storage&&(e.storage=s(e.storage))}))}))}reorderData(){this.reorder(this.calcMortonOrder())}}const yp={[$o]:"NONE",[qo]:"SRGB"},xp=new Map(Object.entries(cl));const wp=new class{generateKey(e){const{pass:t,gamma:s,toneMapping:i,vertex:n,fragment:r,dither:a,defines:o,chunks:l}=e;return`splat-${t}-${s}-${i}-${jn(n)}-${jn(r)}-${a}-${pl.definesHash(o)}-${l&&Object.keys(l).sort().join(":")}`}createShaderDefinition(e,t){var s,i,n,r;const a=mc.get(e).getByIndex(t.pass).shaderDefines,o=new Map;o.set("TONEMAP",null==(s=Xo[t.toneMapping])||s),o.set("GAMMA",null==(i=yp[t.gamma])||i),o.set(`DITHER_${t.dither.toUpperCase()}`,!0),t.defines.forEach(((e,t)=>{o.set(t,e)}));const l=`${a}\n`,h=l+(null!=(n=t.vertex)?n:cl.gsplatVS),c=l+(null!=(r=t.fragment)?r:cl.gsplatPS),d=t.chunks?new Map(Object.entries(kn({},cl,t.chunks))):xp;return _a.createDefinition(e,{name:"SplatShader",attributes:{vertex_position:li,vertex_id_attrib:Ei},vertexCode:h,vertexDefines:o,vertexIncludes:d,fragmentCode:c,fragmentDefines:o,fragmentIncludes:d})}},Sp=(e={})=>{var t;const s=null!=(t=e.dither)?t:il,i=s!==il,n=new Rd;return n.name="splatMaterial",n.cull=0,n.blendType=i?3:2,n.depthWrite=i,n.getShaderVariant=function(t){const{cameraShaderParams:i}=t,r={defines:gl(n,i),pass:t.pass,gamma:i.shaderOutputGamma,toneMapping:i.toneMapping,vertex:e.vertex,fragment:e.fragment,chunks:e.chunks,dither:s},a=new ol(t.viewUniformFormat,t.viewBindGroupFormat),o=ul(t.device);return o.register("splat",wp),o.getProgram("splat",r,a)},n.update(),n};class Cp{constructor(e,t){this.device=void 0,this.numSplats=void 0,this.numSplatsVisible=void 0,this.centers=void 0,this.aabb=void 0,this.colorTexture=void 0,this.transformATexture=void 0,this.transformBTexture=void 0,this.hasSH=void 0,this.sh1to3Texture=void 0,this.sh4to7Texture=void 0,this.sh8to11Texture=void 0,this.sh12to15Texture=void 0;const s=t.numSplats;this.device=e,this.numSplats=s,this.numSplatsVisible=s,this.centers=new Float32Array(3*t.numSplats),t.getCenters(this.centers),this.aabb=new Bs,t.calcAabb(this.aabb);const i=this.evalTextureSize(s);this.colorTexture=this.createTexture("splatColor",7,i),this.transformATexture=this.createTexture("transformA",ei,i),this.transformBTexture=this.createTexture("transformB",Ws,i),this.updateColorData(t),this.updateTransformData(t),this.hasSH=t.hasSHData,this.hasSH&&(this.sh1to3Texture=this.createTexture("splatSH_1to3",ei,i),this.sh4to7Texture=this.createTexture("splatSH_4to7",ei,i),this.sh8to11Texture=this.createTexture("splatSH_8to11",ei,i),this.sh12to15Texture=this.createTexture("splatSH_12to15",ei,i),this.updateSHData(t))}destroy(){var e,t,s,i,n,r,a;null==(e=this.colorTexture)||e.destroy(),null==(t=this.transformATexture)||t.destroy(),null==(s=this.transformBTexture)||s.destroy(),null==(i=this.sh1to3Texture)||i.destroy(),null==(n=this.sh4to7Texture)||n.destroy(),null==(r=this.sh8to11Texture)||r.destroy(),null==(a=this.sh12to15Texture)||a.destroy()}createMaterial(e){const t=Sp(e);return t.setParameter("splatColor",this.colorTexture),t.setParameter("transformA",this.transformATexture),t.setParameter("transformB",this.transformBTexture),t.setParameter("numSplats",this.numSplatsVisible),this.hasSH?(t.setDefine("SH_BANDS",3),t.setParameter("splatSH_1to3",this.sh1to3Texture),t.setParameter("splatSH_4to7",this.sh4to7Texture),t.setParameter("splatSH_8to11",this.sh8to11Texture),t.setParameter("splatSH_12to15",this.sh12to15Texture)):t.setDefine("SH_BANDS",0),t}evalTextureSize(e){const t=Math.ceil(Math.sqrt(e)),s=Math.ceil(e/t);return new ws(t,s)}createTexture(e,t,s){return new yn(this.device,{name:e,width:s.x,height:s.y,format:t,cubemap:!1,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1})}updateColorData(e){const t=this.colorTexture;if(!t)return;const s=t.lock(),i=e.getProp("f_dc_0"),n=e.getProp("f_dc_1"),r=e.getProp("f_dc_2"),a=e.getProp("opacity"),o=.28209479177387814;for(let e=0;e<this.numSplats;++e){const t=255*(i[e]*o+.5),l=255*(n[e]*o+.5),h=255*(r[e]*o+.5),c=255/(1+Math.exp(-a[e]));s[4*e+0]=t<0?0:t>255?255:t,s[4*e+1]=l<0?0:l>255?255:l,s[4*e+2]=h<0?0:h>255?255:h,s[4*e+3]=c<0?0:c>255?255:c}t.unlock()}updateTransformData(e){const t=fs.float2Half;if(!this.transformATexture)return;const s=this.transformATexture.lock(),i=new Float32Array(s.buffer),n=this.transformBTexture.lock(),r=new ys,a=new Ds,o=new ys,l=e.createIter(r,a,o),h=new xs,c=new ys,d=new ys;for(let e=0;e<this.numSplats;e++)l.read(e),a.normalize(),h.setFromQuat(a),this.computeCov3d(h,o,c,d),i[4*e+0]=r.x,i[4*e+1]=r.y,i[4*e+2]=r.z,s[4*e+3]=t(d.x)|t(d.y)<<16,n[4*e+0]=t(c.x),n[4*e+1]=t(c.y),n[4*e+2]=t(c.z),n[4*e+3]=t(d.z);this.transformATexture.unlock(),this.transformBTexture.unlock()}computeCov3d(e,t,s,i){const n=t.x,r=t.y,a=t.z,o=e.data,l=o[0]*n,h=o[1]*n,c=o[2]*n,d=o[3]*r,u=o[4]*r,p=o[5]*r,f=o[6]*a,m=o[7]*a,g=o[8]*a;s.x=l*l+d*d+f*f,s.y=l*h+d*u+f*m,s.z=l*c+d*p+f*g,i.x=h*h+u*u+m*m,i.y=h*c+u*p+m*g,i.z=c*c+p*p+g*g}updateSHData(e){const t=this.sh1to3Texture.lock(),s=this.sh4to7Texture.lock(),i=this.sh8to11Texture.lock(),n=this.sh12to15Texture.lock(),r=(e=>{const t=[];for(let s=0;s<45;++s)t.push(e.getProp(`f_rest_${s}`));return t})(e),a=new Float32Array(1),o=new Uint32Array(a.buffer),l=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(let h=0;h<e.numSplats;++h){for(let e=0;e<15;++e)l[3*e]=r[e][h],l[3*e+1]=r[e+15][h],l[3*e+2]=r[e+30][h];let e=l[0];for(let t=1;t<45;++t)e=Math.max(e,Math.abs(l[t]));if(0!==e){for(let t=0;t<15;++t)l[3*t+0]=Math.floor(2047*(l[3*t+0]/e*.5+.5)+.5),l[3*t+1]=Math.floor(1023*(l[3*t+1]/e*.5+.5)+.5),l[3*t+2]=Math.floor(2047*(l[3*t+2]/e*.5+.5)+.5);a[0]=e,t[4*h+0]=o[0],t[4*h+1]=l[0]<<21|l[1]<<11|l[2],t[4*h+2]=l[3]<<21|l[4]<<11|l[5],t[4*h+3]=l[6]<<21|l[7]<<11|l[8],s[4*h+0]=l[9]<<21|l[10]<<11|l[11],s[4*h+1]=l[12]<<21|l[13]<<11|l[14],s[4*h+2]=l[15]<<21|l[16]<<11|l[17],s[4*h+3]=l[18]<<21|l[19]<<11|l[20],i[4*h+0]=l[21]<<21|l[22]<<11|l[23],i[4*h+1]=l[24]<<21|l[25]<<11|l[26],i[4*h+2]=l[27]<<21|l[28]<<11|l[29],i[4*h+3]=l[30]<<21|l[31]<<11|l[32],n[4*h+0]=l[33]<<21|l[34]<<11|l[35],n[4*h+1]=l[36]<<21|l[37]<<11|l[38],n[4*h+2]=l[39]<<21|l[40]<<11|l[41],n[4*h+3]=l[42]<<21|l[43]<<11|l[44]}}this.sh1to3Texture.unlock(),this.sh4to7Texture.unlock(),this.sh8to11Texture.unlock(),this.sh12to15Texture.unlock()}}function Tp(){let e,t,s,i,n,r=!1;const a={x:0,y:0,z:0},o={x:0,y:0,z:0},l={x:0,y:0,z:0},h={x:0,y:0,z:0};let c,d;self.onmessage=u=>{if(u.data.order&&(e=new Uint32Array(u.data.order)),u.data.centers){t=new Float32Array(u.data.centers),l.x=h.x=t[0],l.y=h.y=t[1],l.z=h.z=t[2];const e=t.length/3;for(let s=1;s<e;++s){const e=t[3*s+0],i=t[3*s+1],n=t[3*s+2];l.x=Math.min(l.x,e),l.y=Math.min(l.y,i),l.z=Math.min(l.z,n),h.x=Math.max(h.x,e),h.y=Math.max(h.y,i),h.z=Math.max(h.z,n)}r=!0}u.data.hasOwnProperty("mapping")&&(s=u.data.mapping?new Uint32Array(u.data.mapping):null,r=!0),u.data.cameraPosition&&(i=u.data.cameraPosition),u.data.cameraDirection&&(n=u.data.cameraDirection),(()=>{var u;if(!(e&&t&&0!==t.length&&i&&n))return;const p=i.x,f=i.y,m=i.z,g=n.x,_=n.y,v=n.z,b=.001;if(!r&&Math.abs(p-a.x)<b&&Math.abs(f-a.y)<b&&Math.abs(m-a.z)<b&&Math.abs(g-o.x)<b&&Math.abs(_-o.y)<b&&Math.abs(v-o.z)<b)return;let y,x;r=!1,a.x=p,a.y=f,a.z=m,o.x=g,o.y=_,o.z=v;for(let e=0;e<8;++e){const t=((1&e?l.x:h.x)-p)*g+((2&e?l.y:h.y)-f)*_+((4&e?l.z:h.z)-m)*v;0===e?y=x=t:(y=Math.min(y,t),x=Math.max(x,t))}const w=t.length/3,S=Math.max(10,Math.min(20,Math.round(Math.log2(w/4)))),C=2**S+1;(null==(u=c)?void 0:u.length)!==w&&(c=new Uint32Array(w)),d&&d.length===C?d.fill(0):d=new Uint32Array(C);const T=x-y,E=T<1e-6?0:1/T*2**S;for(let e=0;e<w;++e){const s=3*e,i=(t[s+0]-p)*g+(t[s+1]-f)*_+(t[s+2]-m)*v,n=Math.floor((i-y)*E);c[e]=n,d[n]++}for(let e=1;e<C;e++)d[e]+=d[e-1];for(let t=0;t<w;t++){const s=c[t],i=--d[s];e[i]=t}const P=t=>c[e[t]]/E+y,k=P(w-1)>=0?(()=>{const e=((e,t,s)=>{for(;e<=t;){const i=t+e>>1,n=s(i);if(n>0)e=i+1;else{if(!(n<0))return i;t=i-1}}return~e})(0,w-1,(e=>-P(e)));return Math.min(w,Math.abs(e))})():w;if(s)for(let t=0;t<w;++t)e[t]=s[e[t]];self.postMessage({order:e.buffer,count:k},[e.buffer]),e=null})()}}class Ep extends Kt{constructor(){super(),this.worker=void 0,this.orderTexture=void 0,this.centers=void 0,this.worker=new Worker(URL.createObjectURL(new Blob([`(${Tp.toString()})()`],{type:"application/javascript"}))),this.worker.onmessage=e=>{const t=e.data.order,s=this.orderTexture._levels[0].buffer;this.worker.postMessage({order:s},[s]),this.orderTexture._levels[0]=new Uint32Array(t),this.orderTexture.upload(),this.fire("updated",e.data.count)}}destroy(){this.worker.terminate(),this.worker=null}init(e,t){this.orderTexture=e,this.centers=t.slice();const s=this.orderTexture.lock({mode:1}).buffer.slice();this.orderTexture.unlock(),this.worker.postMessage({order:s,centers:t.buffer},[s,t.buffer])}setMapping(e){if(e){const t=new Float32Array(3*e.length);for(let s=0;s<e.length;++s){const i=3*e[s],n=3*s;t[n+0]=this.centers[i+0],t[n+1]=this.centers[i+1],t[n+2]=this.centers[i+2]}this.worker.postMessage({centers:t.buffer,mapping:e.buffer},[t.buffer,e.buffer])}else{const e=this.centers.slice();this.worker.postMessage({centers:e.buffer,mapping:null},[e.buffer])}}setCamera(e,t){this.worker.postMessage({cameraPosition:{x:e.x,y:e.y,z:e.z},cameraDirection:{x:t.x,y:t.y,z:t.z}})}}const Pp=new As,kp=new ys,Ap=new ys,Mp=[0,0];class Dp{constructor(e,t){this.splat=void 0,this.mesh=void 0,this.meshInstance=void 0,this.material=void 0,this.orderTexture=void 0,this.options={},this.sorter=null,this.lastCameraPosition=new ys,this.lastCameraDirection=new ys,this.cameras=[],this.splat=e,t=Object.assign(this.options,t);const s=e.device;this.orderTexture=this.splat.createTexture("splatOrder",37,this.splat.evalTextureSize(this.splat.numSplats)),this.createMaterial(t);const i=128,n=Math.ceil(e.numSplats/i)*i/i,r=new Uint32Array(n);for(let e=0;e<n;++e)r[e]=e*i;const a=new Kn(s,[{semantic:Ei,components:1,type:5,asInt:!0}]),o=new Hn(s,a,n,{usage:0,data:r.buffer}),l=new Float32Array(1536),h=new Uint32Array(768);for(let e=0;e<i;++e){l.set([-1,-1,e,1,-1,e,1,1,e,-1,1,e],12*e);const t=4*e;h.set([0+t,1+t,2+t,0+t,2+t,3+t],6*e)}const c=new Dl(s);c.setPositions(l,3),c.setIndices(h),c.update(),this.mesh=c,this.mesh.aabb.copy(e.aabb),this.meshInstance=new Hl(this.mesh,this.material),this.meshInstance.setInstancing(o,!0),this.meshInstance.gsplatInstance=this,this.meshInstance.instancingCount=0,this.centers=new Float32Array(e.centers),t.dither&&t.dither!==il||(this.sorter=new Ep,this.sorter.init(this.orderTexture,this.centers),this.sorter.on("updated",(e=>{this.meshInstance.instancingCount=Math.ceil(e/i),this.material.setParameter("numSplats",e)})))}destroy(){var e,t,s;null==(e=this.material)||e.destroy(),null==(t=this.meshInstance)||t.destroy(),null==(s=this.sorter)||s.destroy()}clone(){return new Dp(this.splat,this.options)}createMaterial(e){this.material=this.splat.createMaterial(e),this.material.setParameter("splatOrder",this.orderTexture),this.meshInstance&&(this.meshInstance.material=this.material)}updateViewport(){const e=this.splat.device;if(Mp[0]=e.width,Mp[1]=e.height,this.cameras.length>0){const e=this.cameras[0].xr;e&&e.active&&2===e.views.list.length&&(Mp[0]/=2)}this.material.setParameter("viewport",Mp)}sort(e){if(this.sorter){const t=e.getWorldTransform();t.getTranslation(kp),t.getZ(Ap);const s=this.meshInstance.node.getWorldTransform(),i=Pp.invert(s);i.transformPoint(kp,kp),i.transformVector(Ap,Ap),kp.equalsApprox(this.lastCameraPosition)&&Ap.equalsApprox(this.lastCameraDirection)||(this.lastCameraPosition.copy(kp),this.lastCameraDirection.copy(Ap),this.sorter.setCamera(kp,Ap))}this.updateViewport()}update(){if(this.cameras.length>0){const e=this.cameras[0];this.sort(e._node),this.cameras.length=0}}}const Rp="KEEP_ASPECT",Lp="AUTO";let Ip;function Fp(){return Ip}function Op(e){Ip=e}class Bp{constructor(){this.renderPasses=[],this.renderTargetMap=new Map}addRenderPass(e){e.frameUpdate();const t=e.beforePasses;for(let e=0;e<t.length;e++){const s=t[e];s.enabled&&this.addRenderPass(s)}e.enabled&&this.renderPasses.push(e);const s=e.afterPasses;for(let e=0;e<s.length;e++){const t=s[e];t.enabled&&this.addRenderPass(t)}}reset(){this.renderPasses.length=0}compile(){const e=this.renderTargetMap,t=this.renderPasses;for(let s=0;s<t.length;s++){const i=t[s],n=i.renderTarget;if(void 0!==n){const t=e.get(n);if(t){const e=i.colorArrayOps.length;for(let s=0;s<e;s++){i.colorArrayOps[s].clear||(t.colorArrayOps[s].store=!0)}i.depthStencilOps.clearDepth||(t.depthStencilOps.storeDepth=!0),i.depthStencilOps.clearStencil||(t.depthStencilOps.storeStencil=!0)}e.set(n,i)}}for(let e=0;e<t.length-1;e++){const s=t[e],i=s.renderTarget,n=t[e+1];i===n.renderTarget&&void 0!==i&&(n.depthStencilOps.clearDepth||n.depthStencilOps.clearStencil||n.colorArrayOps.some((e=>e.clear))||s.afterPasses.length>0||n.beforePasses.length>0||(s._skipEnd=!0,n._skipStart=!0))}let s=null,i=null;for(let e=0;e<t.length;e++){const n=t[e],r=n.renderTarget,a=null==r?void 0:r.colorBuffer;if(null!=a&&a.cubemap){if(s===a){const e=i.colorArrayOps.length;for(let t=0;t<e;t++)i.colorArrayOps[t].mipmaps=!1}s=r.colorBuffer,i=n}else n.requiresCubemaps&&(s=null,i=null)}e.clear()}render(e){this.compile();const t=this.renderPasses;for(let e=0;e<t.length;e++)t[e].render()}}class zp{constructor(e,t){this.texture0=e,this.texture1=t}destroy(){var e,t;null==(e=this.texture0)||e.destroy(),null==(t=this.texture1)||t.destroy()}}const Np=new _n;class Up{static createTexture(e,t,s,i=""){return new yn(e,{name:`AreaLightLUT${i}`,width:s,height:s,format:t,addressU:1,addressV:1,type:Ai,magFilter:1,minFilter:0,anisotropy:1,mipmaps:!1})}static applyTextures(e,t,s){Np.remove(e),Np.get(e,(()=>new zp(t,t===s?null:s))),e.scope.resolve("areaLightsLutTex1").setValue(t),e.scope.resolve("areaLightsLutTex2").setValue(s)}static createPlaceholder(e){const t=Up.createTexture(e,Ws,2,"placeholder");t.lock().fill(0),t.unlock(),Up.applyTextures(e,t,t)}static set(e,t,s){function i(e,t,s){const i=Up.createTexture(e,s,64);return i.lock().set(t),i.unlock(),i}function n(e){const t=e.length,s=new Uint16Array(t),i=fs.float2Half;for(let n=0;n<t;n++)s[n]=i(e[n]);return s}const r=s,a=n(t),o=n(r),l=i(e,a,Ws),h=i(e,o,Ws);Up.applyTextures(e,l,h)}}const Vp="en-US",Gp={en:"en-US",es:"en-ES",zh:"zh-CN","zh-HK":"zh-TW","zh-TW":"zh-HK","zh-MO":"zh-HK",fr:"fr-FR",de:"de-DE",it:"it-IT",ru:"ru-RU",ja:"ja-JP"},Hp={};function jp(e,t){for(let s=0,i=e.length;s<i;s++)Hp[e[s]]=t}function Wp(e){const t=e.indexOf("-");return-1!==t?e.substring(0,t):e}function $p(e,t){if(t[e])return e;let s=Gp[e];if(s&&t[s])return s;const i=Wp(e);return s=Gp[i],t[s]?s:t[i]?i:Vp}jp(["ja","ko","th","vi","zh","id"],(e=>0)),jp(["fa","hi"],(e=>e>=0&&e<=1?0:1)),jp(["fr","pt"],(e=>e>=0&&e<2?0:1)),jp(["da"],(e=>1===e||!Number.isInteger(e)&&e>=0&&e<=1?0:1)),jp(["de","en","it","el","es","tr","fi","sv","nb","no","ur"],(e=>1===e?0:1)),jp(["ru","uk"],(e=>{if(Number.isInteger(e)){const t=e%10,s=e%100;if(1===t&&11!==s)return 0;if(t>=2&&t<=4&&(s<12||s>14))return 1;if(0===t||t>=5&&t<=9||s>=11&&s<=14)return 2}return 3})),jp(["pl"],(e=>{if(Number.isInteger(e)){if(1===e)return 0;const t=e%10,s=e%100;if(t>=2&&t<=4&&(s<12||s>14))return 1;if(t>=0&&t<=1||t>=5&&t<=9||s>=12&&s<=14)return 2}return 3})),jp(["ar"],(e=>{if(0===e)return 0;if(1===e)return 1;if(2===e)return 2;if(Number.isInteger(e)){const t=e%100;if(t>=3&&t<=10)return 3;if(t>=11&&t<=99)return 4}return 5}));const qp=Hp[Wp(Vp)];function Xp(e){return Hp[e]||qp}const Kp=new RegExp("^\\s*(?:(?:[a-z]+[a-z0-9\\-+.]*:)?//|data:|blob:)","i");class Yp{constructor(e="",t="",s=null,i=null,n=null,r=null){this.url=e,this.filename=t,this.hash=s,this.size=i,this.opt=n,this.contents=r}equals(e){return this.url===e.url&&this.filename===e.filename&&this.hash===e.hash&&this.size===e.size&&this.opt===e.opt&&this.contents===e.contents}}let Qp=-1;const Jp={pvr:"extCompressedTexturePVRTC",dxt:"extCompressedTextureS3TC",etc2:"extCompressedTextureETC",etc1:"extCompressedTextureETC1",basis:"canvas"},Zp=["pvr","dxt","etc2","etc1","basis"];class ef extends Kt{constructor(e,t,s,i,n){super(),this._id=Qp--,this._name=e||"",this.type=t,this.tags=new es(this),this._preload=!1,this._file=null,this._data=i||{},this.options=n||{},this._resources=[],this.urlObject=null,this._i18n={},this.loaded=!1,this.loading=!1,this.registry=null,s&&(this.file=s)}set id(e){this._id=e}get id(){return this._id}set name(e){if(this._name===e)return;const t=this._name;this._name=e,this.fire("name",this,this._name,t)}get name(){return this._name}set file(e){if(e&&e.variants&&-1!==["texture","textureatlas","bundle"].indexOf(this.type)){var t;const s=(null==(t=this.registry)||null==(t=t._loader)?void 0:t._app)||Fp(),i=null==s?void 0:s.graphicsDevice;if(i)for(let t=0,n=Zp.length;t<n;t++){const n=Zp[t];if(e.variants[n]&&i[Jp[n]]){e=e.variants[n];break}if(s.enableBundles){const e=s.bundles.listBundlesForAsset(this);if(e&&e.find((e=>{var t;return null==e||null==(t=e.file)?void 0:t.variants[n]})))break}}}const s=this._file,i=e?new Yp(e.url,e.filename,e.hash,e.size,e.opt,e.contents):null;(!!i!=!!s||i&&!i.equals(s))&&(this._file=i,this.fire("change",this,"file",i,s),this.reload())}get file(){return this._file}set data(e){const t=this._data;this._data=e,e!==t&&(this.fire("change",this,"data",e,t),this.loaded&&this.registry._loader.patch(this,this.registry))}get data(){return this._data}set resource(e){const t=this._resources[0];this._resources[0]=e,this.fire("change",this,"resource",e,t)}get resource(){return this._resources[0]}set resources(e){const t=this._resources;this._resources=e,this.fire("change",this,"resources",e,t)}get resources(){return this._resources}set preload(e){e=!!e,this._preload!==e&&(this._preload=e,this._preload&&!this.loaded&&!this.loading&&this.registry&&this.registry.load(this))}get preload(){return this._preload}set loadFaces(e){e=!!e,this.hasOwnProperty("_loadFaces")&&e===this._loadFaces||(this._loadFaces=e,this.loaded&&this.registry._loader.patch(this,this.registry))}get loadFaces(){return this._loadFaces}getFileUrl(){const e=this.file;if(!e||!e.url)return null;let t=e.url;if(this.registry&&this.registry.prefix&&!Kp.test(t)&&(t=this.registry.prefix+t),"script"!==this.type&&e.hash){const s=-1!==t.indexOf("?")?"&":"?";t+=`${s}t=${e.hash}`}return t}getAbsoluteUrl(e){if(e.startsWith("blob:")||e.startsWith("data:"))return e;const t=It.getDirectory(this.file.url);return It.join(t,e)}getLocalizedAssetId(e){return e=$p(e,this._i18n),this._i18n[e]||null}addLocalizedAssetId(e,t){this._i18n[e]=t,this.fire("add:localized",e,t)}removeLocalizedAssetId(e){const t=this._i18n[e];t&&(delete this._i18n[e],this.fire("remove:localized",e,t))}ready(e,t){t=t||this,this.loaded?e.call(t,this):this.once("load",(s=>{e.call(t,s)}))}reload(){this.loaded&&(this.loaded=!1,this.registry.load(this))}unload(){if(!this.loaded&&0===this._resources.length)return;this.fire("unload",this),this.registry.fire(`unload:${this.id}`,this);const e=this._resources;this.urlObject&&(URL.revokeObjectURL(this.urlObject),this.urlObject=null),this.resources=[],this.loaded=!1,this.file&&this.registry._loader.clearCache(this.getFileUrl(),this.type);for(let t=0;t<e.length;++t){const s=e[t];s&&s.destroy&&s.destroy()}}static fetchArrayBuffer(e,t,s,i=0){var n;null!=s&&null!=(n=s.file)&&n.contents?setTimeout((()=>{t(null,s.file.contents)})):Ho.get(e,{cache:!0,responseType:"arraybuffer",retry:i>0,maxRetries:i},t)}}ef.EVENT_LOAD="load",ef.EVENT_UNLOAD="unload",ef.EVENT_REMOVE="remove",ef.EVENT_ERROR="error",ef.EVENT_CHANGE="change",ef.EVENT_ADDLOCALIZED="add:localized",ef.EVENT_REMOVELOCALIZED="remove:localized";class tf{constructor(e=null){this._index={},this._key=void 0,this._key=e}addItem(e){const t=e.tags._list;for(const s of t)this.add(s,e)}removeItem(e){const t=e.tags._list;for(const s of t)this.remove(s,e)}add(e,t){this._index[e]&&-1!==this._index[e].list.indexOf(t)||(this._index[e]||(this._index[e]={list:[]},this._key&&(this._index[e].keys={})),this._index[e].list.push(t),this._key&&(this._index[e].keys[t[this._key]]=t))}remove(e,t){if(!this._index[e])return;if(this._key&&!this._index[e].keys[t[this._key]])return;const s=this._index[e].list.indexOf(t);-1!==s&&(this._index[e].list.splice(s,1),this._key&&delete this._index[e].keys[t[this._key]],0===this._index[e].list.length&&delete this._index[e])}find(e){const t={},s=[];let i,n,r,a,o;const l=(e,t)=>this._index[e].list.length-this._index[t].list.length;for(let h=0;h<e.length;h++){if(n=e[h],n instanceof Array){if(0===n.length)continue;if(1!==n.length){o=!1;for(let e=0;e<n.length;e++)if(!this._index[n[e]]){o=!0;break}if(o)continue;r=n.slice(0).sort(l),a=r.slice(1),1===a.length&&(a=a[0]);for(let e=0;e<this._index[r[0]].list.length;e++)i=this._index[r[0]].list[e],(this._key?!t[i[this._key]]:-1===s.indexOf(i))&&i.tags.has(a)&&(this._key&&(t[i[this._key]]=!0),s.push(i));continue}n=n[0]}if(n&&"string"==typeof n&&this._index[n])for(let e=0;e<this._index[n].list.length;e++)i=this._index[n].list[e],this._key?t[i[this._key]]||(t[i[this._key]]=!0,s.push(i)):-1===s.indexOf(i)&&s.push(i)}return s}}class sf extends Kt{constructor(e){super(),this._assets=new Set,this._loader=void 0,this._idToAsset=new Map,this._urlToAsset=new Map,this._nameToAsset=new Map,this._tags=new tf("_id"),this.prefix=null,this.bundles=null,this._loader=e}list(e={}){const t=Array.from(this._assets);return void 0!==e.preload?t.filter((t=>t.preload===e.preload)):t}add(e){var t,s;this._assets.has(e)||(this._assets.add(e),this._idToAsset.set(e.id,e),null!=(t=e.file)&&t.url&&this._urlToAsset.set(e.file.url,e),this._nameToAsset.has(e.name)||this._nameToAsset.set(e.name,new Set),this._nameToAsset.get(e.name).add(e),e.on("name",this._onNameChange,this),e.registry=this,this._tags.addItem(e),e.tags.on("add",this._onTagAdd,this),e.tags.on("remove",this._onTagRemove,this),this.fire("add",e),this.fire(`add:${e.id}`,e),null!=(s=e.file)&&s.url&&this.fire(`add:url:${e.file.url}`,e),e.preload&&this.load(e))}remove(e){var t,s;if(!this._assets.has(e))return!1;if(this._assets.delete(e),this._idToAsset.delete(e.id),null!=(t=e.file)&&t.url&&this._urlToAsset.delete(e.file.url),e.off("name",this._onNameChange,this),this._nameToAsset.has(e.name)){const t=this._nameToAsset.get(e.name);t.delete(e),0===t.size&&this._nameToAsset.delete(e.name)}return this._tags.removeItem(e),e.tags.off("add",this._onTagAdd,this),e.tags.off("remove",this._onTagRemove,this),e.fire("remove",e),this.fire("remove",e),this.fire(`remove:${e.id}`,e),null!=(s=e.file)&&s.url&&this.fire(`remove:url:${e.file.url}`,e),!0}get(e){return this._idToAsset.get(Number(e))}getByUrl(e){return this._urlToAsset.get(e)}load(e,t){if((e.loading||e.loaded)&&(null==t||!t.force))return;const s=e.file,i=()=>{this.fire("load",e),this.fire(`load:${e.id}`,e),s&&s.url&&this.fire(`load:url:${s.url}`,e),e.fire("load",e)},n=t=>{if(t instanceof Array?e.resources=t:e.resource=t,this._loader.patch(e,this),"bundle"===e.type){const t=e.data.assets;for(let e=0;e<t.length;e++){const s=this._idToAsset.get(t[e]);s&&!s.loaded&&this.load(s,{force:!0})}e.resource.loaded?i():(this.fire("load:start",e),this.fire(`load:start:${e.id}`,e),s&&s.url&&this.fire(`load:start:url:${s.url}`,e),e.fire("load:start",e),e.resource.on("load",i))}else i()},r=(t,s,i)=>{if(e.loaded=!0,e.loading=!1,t)this.fire("error",t,e),this.fire(`error:${e.id}`,t,e),e.fire("error",t,e);else{if("script"===e.type){const t=this._loader.getHandler("script");t._cache[e.id]&&t._cache[e.id].parentNode===document.head&&document.head.removeChild(t._cache[e.id]),t._cache[e.id]=i}n(s)}};if(s||"cubemap"===e.type){this.fire("load:start",e),this.fire(`load:${e.id}:start`,e),e.loading=!0;const s=e.getFileUrl();if("bundle"===e.type){const t=e.data.assets;for(let e=0;e<t.length;e++){const s=this._idToAsset.get(t[e]);s&&(s.loaded||s.resource||s.loading||(s.loading=!0))}}this._loader.load(s,e.type,r,e,t)}else{const t=this._loader.open(e.type,e.data);e.loaded=!0,n(t)}}loadFromUrl(e,t,s){this.loadFromUrlAndFilename(e,null,t,s)}loadFromUrlAndFilename(e,t,s,i){const n=It.getBasename(t||e),r={filename:t||n,url:e};let a=this.getByUrl(e);if(a){if(a.loaded)return void i(a.loadFromUrlError||null,a)}else a=new ef(n,s,r),this.add(a);const o=e=>{e.once("load",(e=>{"material"===s?this._loadTextures(e,((t,s)=>{i(t,e)})):i(null,e)})),e.once("error",(t=>{t&&(this.loadFromUrlError=t),i(t,e)})),this.load(e)};a.resource?i(null,a):"model"===s?this._loadModel(a,o):o(a)}_loadModel(e,t){const s=e.getFileUrl(),i=It.getExtension(s);if(".json"===i||".glb"===i){const n=It.getDirectory(s),r=It.getBasename(s),a=It.join(n,r.replace(i,".mapping.json"));this._loader.load(a,"json",((s,i)=>{s?(e.data={mapping:[]},t(e)):this._loadMaterials(e,i,((s,n)=>{e.data=i,t(e)}))}))}else t(e)}_loadMaterials(e,t,s){const i=[];let n=0;const r=(e,t)=>{this._loadTextures(t,((e,r)=>{i.push(t),i.length===n&&s(null,i)}))};for(let s=0;s<t.mapping.length;s++){const i=t.mapping[s].path;if(i){n++;const t=e.getAbsoluteUrl(i);this.loadFromUrl(t,"material",r)}}0===n&&s(null,i)}_loadTextures(e,t){const s=[];let i=0;const n=e.data;if("path"!==n.mappingFormat)return void t(null,s);const r=(e,n)=>{e&&console.error(e),s.push(n),s.length===i&&t(null,s)},a=zu;for(let t=0;t<a.length;t++){const s=n[a[t]];if(s&&"string"==typeof s){i++;const t=e.getAbsoluteUrl(s);this.loadFromUrl(t,"texture",r)}}0===i&&t(null,s)}_onTagAdd(e,t){this._tags.add(e,t)}_onTagRemove(e,t){this._tags.remove(e,t)}_onNameChange(e,t,s){if(this._nameToAsset.has(s)){const t=this._nameToAsset.get(s);t.delete(e),0===t.size&&this._nameToAsset.delete(s)}this._nameToAsset.has(e.name)||this._nameToAsset.set(e.name,new Set),this._nameToAsset.get(e.name).add(e)}findByTag(...e){return this._tags.find(e)}filter(e){return Array.from(this._assets).filter((t=>e(t)))}find(e,t){const s=this._nameToAsset.get(e);if(!s)return null;for(const e of s)if(!t||e.type===t)return e;return null}findAll(e,t){const s=this._nameToAsset.get(e);if(!s)return[];const i=Array.from(s);return t?i.filter((e=>e.type===t)):i}}sf.EVENT_LOAD="load",sf.EVENT_ADD="add",sf.EVENT_REMOVE="remove",sf.EVENT_ERROR="error";class nf{constructor(e){this._idToBundle=new Map,this._assetToBundles=new Map,this._urlsToBundles=new Map,this._fileRequests=new Map,this._assets=e,this._assets.bundles=this,this._assets.on("add",this._onAssetAdd,this),this._assets.on("remove",this._onAssetRemove,this)}_onAssetAdd(e){if("bundle"===e.type){this._idToBundle.set(e.id,e),this._assets.on(`load:start:${e.id}`,this._onBundleLoadStart,this),this._assets.on(`load:${e.id}`,this._onBundleLoad,this),this._assets.on(`error:${e.id}`,this._onBundleError,this);const t=e.data.assets;for(let s=0;s<t.length;s++)this._indexAssetInBundle(t[s],e)}else this._assetToBundles.has(e.id)&&this._indexAssetFileUrls(e)}_unbindAssetEvents(e){this._assets.off(`load:start:${e}`,this._onBundleLoadStart,this),this._assets.off(`load:${e}`,this._onBundleLoad,this),this._assets.off(`error:${e}`,this._onBundleError,this)}_indexAssetInBundle(e,t){let s=this._assetToBundles.get(e);s||(s=new Set,this._assetToBundles.set(e,s)),s.add(t);const i=this._assets.get(e);i&&this._indexAssetFileUrls(i)}_indexAssetFileUrls(e){const t=this._getAssetFileUrls(e);if(t)for(let s=0;s<t.length;s++){const i=this._assetToBundles.get(e.id);i&&this._urlsToBundles.set(t[s],i)}}_getAssetFileUrls(e){let t=e.getFileUrl();if(!t)return null;t=t.split("?")[0];const s=[t];if("font"===e.type){const i=e.data.info.maps.length;for(let e=1;e<i;e++)s.push(t.replace(".png",`${e}.png`))}return s}_onAssetRemove(e){if("bundle"===e.type){this._idToBundle.delete(e.id),this._unbindAssetEvents(e.id);const t=e.data.assets;for(let s=0;s<t.length;s++){const i=this._assetToBundles.get(t[s]);if(i&&(i.delete(e),0===i.size)){this._assetToBundles.delete(t[s]);for(const[e,t]of this._urlsToBundles)t===i&&this._urlsToBundles.delete(e)}}this._onBundleError(`Bundle ${e.id} was removed`)}else{if(!this._assetToBundles.get(e.id))return;this._assetToBundles.delete(e.id);const t=this._getAssetFileUrls(e);if(!t)return;for(let e=0;e<t.length;e++)this._urlsToBundles.delete(t[e])}}_onBundleLoadStart(e){e.resource.on("add",((e,t)=>{const s=this._fileRequests.get(e);if(s){for(let e=0;e<s.length;e++)s[e](null,t);this._fileRequests.delete(e)}}))}_onBundleLoad(e){if(e.resource){if(this._fileRequests)for(const[t,s]of this._fileRequests){const i=this._urlsToBundles.get(t);if(!i||!i.has(e))continue;const n=decodeURIComponent(t);let r,a;if(e.resource.has(n))a=e.resource.get(n);else{if(!e.resource.loaded)continue;r=`Bundle ${e.id} does not contain URL ${t}`}for(let e=0;e<s.length;e++)s[e](r,r||a);this._fileRequests.delete(t)}}else this._onBundleError(`Bundle ${e.id} failed to load`)}_onBundleError(e){for(const[t,s]of this._fileRequests){if(!this._findLoadedOrLoadingBundleForUrl(t)){for(let t=0;t<s.length;t++)s[t](e);this._fileRequests.delete(t)}}}_findLoadedOrLoadingBundleForUrl(e){const t=this._urlsToBundles.get(e);if(!t)return null;let s=null;for(const e of t){if(e.loaded&&e.resource)return e;e.loading&&(s=e)}return s}listBundlesForAsset(e){const t=this._assetToBundles.get(e.id);return t?Array.from(t):null}list(){return Array.from(this._idToBundle.values())}hasUrl(e){return this._urlsToBundles.has(e)}urlIsLoadedOrLoading(e){return!!this._findLoadedOrLoadingBundleForUrl(e)}loadUrl(e,t){const s=this._findLoadedOrLoadingBundleForUrl(e);if(!s)return void t(`URL ${e} not found in any bundles`);if(s.loaded){const i=decodeURIComponent(e);if(s.resource.has(i))return void t(null,s.resource.get(i));if(s.resource.loaded)return void t(`Bundle ${s.id} does not contain URL ${e}`)}let i=this._fileRequests.get(e);i||(i=[],this._fileRequests.set(e,i)),i.push(t)}destroy(){this._assets.off("add",this._onAssetAdd,this),this._assets.off("remove",this._onAssetRemove,this);for(const e of this._idToBundle.keys())this._unbindAssetEvents(e);this._assets=null,this._idToBundle.clear(),this._idToBundle=null,this._assetToBundles.clear(),this._assetToBundles=null,this._urlsToBundles.clear(),this._urlsToBundles=null,this._fileRequests.clear(),this._fileRequests=null}}class rf extends Kt{constructor(){super(),this.anim=void 0,this.animation=void 0,this.audiolistener=void 0,this.button=void 0,this.camera=void 0,this.collision=void 0,this.element=void 0,this.joint=void 0,this.layoutchild=void 0,this.layoutgroup=void 0,this.light=void 0,this.model=void 0,this.particlesystem=void 0,this.render=void 0,this.rigidbody=void 0,this.screen=void 0,this.script=void 0,this.scrollbar=void 0,this.scrollview=void 0,this.sound=void 0,this.sprite=void 0,this.zone=void 0,this.list=[]}add(e){const t=e.id;if(this[t])throw new Error(`ComponentSystem name '${t}' already registered or not allowed`);this[t]=e,this.list.push(e)}remove(e){const t=e.id;if(!this[t])throw new Error(`No ComponentSystem named '${t}' registered`);delete this[t];const s=this.list.indexOf(this[t]);-1!==s&&this.list.splice(s,1)}destroy(){this.off();for(let e=0;e<this.list.length;e++)this.list[e].destroy()}}class af extends Kt{constructor(...e){super(...e),this._index=new Map,this._loaded=!1}addFile(e,t){this._index.has(e)||(this._index.set(e,t),this.fire("add",e,t))}has(e){return this._index.has(e)}get(e){return this._index.get(e)||null}destroy(){this._index.clear()}set loaded(e){e&&!this._loaded&&(this._loaded=!0,this.fire("load"))}get loaded(){return this._loaded}}af.EVENT_ADD="add",af.EVENT_LOAD="load";class of extends Kt{constructor(e,t=""){super(),this.headerSize=512,this.paddingSize=512,this.bytesRead=0,this.bytesReceived=0,this.headerRead=!1,this.reader=null,this.data=new Uint8Array(0),this.decoder=null,this.prefix="",this.fileName="",this.fileSize=0,this.fileType="",this.ustarFormat="",this.prefix=t||"",this.reader=e.body.getReader(),this.reader.read().then((e=>{this.pump(e.done,e.value)})).catch((e=>{this.fire("error",e)}))}pump(e,t){if(e)return this.fire("done"),null;this.bytesReceived+=t.byteLength;const s=new Uint8Array(this.data.length+t.length);for(s.set(this.data),s.set(t,this.data.length),this.data=s;this.readFile(););return this.reader.read().then((e=>{this.pump(e.done,e.value)})).catch((e=>{this.fire("error",e)}))}readFile(){if(!this.headerRead&&this.bytesReceived>this.bytesRead+this.headerSize){this.headerRead=!0;const e=new DataView(this.data.buffer,this.bytesRead,this.headerSize);null!=this.decoder||(this.decoder=new TextDecoder("windows-1252"));const t=this.decoder.decode(e);if(this.fileName=t.substring(0,100).replace(/\0/g,""),this.fileSize=parseInt(t.substring(124,136),8),this.fileType=t.substring(156,157),this.ustarFormat=t.substring(257,263),-1!==this.ustarFormat.indexOf("ustar")){const e=t.substring(345,500).replace(/\0/g,"");e.length>0&&(this.fileName=e.trim()+this.fileName.trim())}this.bytesRead+=512}if(this.headerRead){if(this.bytesReceived<this.bytesRead+this.fileSize)return!1;if(""===this.fileType||"0"===this.fileType){const e=new DataView(this.data.buffer,this.bytesRead,this.fileSize),t={name:this.prefix+this.fileName,size:this.fileSize,data:e};this.fire("file",t)}this.bytesRead+=this.fileSize,this.headerRead=!1;const e=this.bytesRead%this.paddingSize;return 0!==e&&(this.bytesRead+=this.paddingSize-e),!0}return!1}}class lf{constructor(e,t){this.handlerType="",this._app=void 0,this._maxRetries=0,this._app=e,this.handlerType=t}set maxRetries(e){this._maxRetries=e}get maxRetries(){return this._maxRetries}load(e,t,s){}open(e,t,s){return t}patch(e,t){}}class hf extends lf{constructor(e){super(e,"bundle"),this._assets=e.assets}_fetchRetries(e,t,s=0){return new Promise(((i,n)=>{const r=()=>{fetch(e,t).then(i).catch((e=>{++s<this.maxRetries?r():n(e)}))};r()}))}load(e,t){"string"==typeof e&&(e={load:e,original:e}),this._fetchRetries(e.load,{mode:"cors",credentials:"include"},this.maxRetries).then((e=>{const s=new af;t(null,s);const i=new of(e,this._assets.prefix);i.on("file",(e=>{s.addFile(e.name,e.data)})),i.on("done",(()=>{s.loaded=!0})),i.on("error",(e=>{t(e)}))})).catch((e=>{t(e)}))}open(e,t){return t}}class cf{constructor(e){this._handlers={},this._requests={},this._cache={},this._app=e}addHandler(e,t){this._handlers[e]=t,t._loader=this}removeHandler(e){delete this._handlers[e]}getHandler(e){return this._handlers[e]}static makeKey(e,t){return`${e}-${t}`}load(e,t,s,i,n){const r=this._handlers[t];if(!r){return void s(`No resource handler for asset type: '${t}' when loading [${e}]`)}if(!e)return void this._loadNull(r,s,i);const a=cf.makeKey(e,t);if(void 0!==this._cache[a])s(null,this._cache[a]);else if(this._requests[a])this._requests[a].push(s);else{this._requests[a]=[s];const t=this,l=function(e,s){if(e)t._onFailure(a,e);else{if(s.load instanceof DataView){if(r.openBinary){if(!t._requests[a])return;try{const e=r.openBinary(s.load);t._onSuccess(a,e)}catch(e){t._onFailure(a,e)}return}s.load=URL.createObjectURL(new Blob([s.load])),i&&(i.urlObject&&URL.revokeObjectURL(i.urlObject),i.urlObject=s.load)}r.load(s,((e,n,o)=>{if(t._requests[a])if(e)t._onFailure(a,e);else try{t._onSuccess(a,r.open(s.original,n,i),o)}catch(e){t._onFailure(a,e)}}),i)}},h=e.split("?")[0];if(!this._app.enableBundles||!this._app.bundles.hasUrl(h)||n&&n.bundlesIgnore)l(null,{load:e,original:i&&i.file.filename||e});else{if(!this._app.bundles.urlIsLoadedOrLoading(h)){var o;const e=this._app.bundles.listBundlesForAsset(i);let t;n&&n.bundlesFilter&&(t=n.bundlesFilter(e)),t||(null==e||e.sort(((e,t)=>e.file.size-t.file.size)),t=null==e?void 0:e[0]),t&&(null==(o=this._app.assets)||o.load(t))}this._app.bundles.loadUrl(h,((e,t)=>{l(e,{load:t,original:h})}))}}}_loadNull(e,t,s){e.load(null,(function(i,n,r){if(i)t(i);else try{t(null,e.open(null,n,s),r)}catch(e){t(e)}}),s)}_onSuccess(e,t,s){null!==t?this._cache[e]=t:delete this._cache[e];for(let i=0;i<this._requests[e].length;i++)this._requests[e][i](null,t,s);delete this._requests[e]}_onFailure(e,t){if(console.error(t),this._requests[e]){for(let s=0;s<this._requests[e].length;s++)this._requests[e][s](t);delete this._requests[e]}}open(e,t){const s=this._handlers[e];return s?s.open(null,t):(console.warn(`No resource handler found for: ${e}`),t)}patch(e,t){const s=this._handlers[e.type];s?s.patch&&s.patch(e,t):console.warn(`No resource handler found for: ${e.type}`)}clearCache(e,t){const s=cf.makeKey(e,t);delete this._cache[s]}getFromCache(e,t){const s=cf.makeKey(e,t);if(this._cache[s])return this._cache[s]}enableRetry(e=5){e=Math.max(0,e)||0;for(const t in this._handlers)this._handlers[t].maxRetries=e}disableRetry(){for(const e in this._handlers)this._handlers[e].maxRetries=0}destroy(){this._handlers={},this._requests={},this._cache={}}}class df{_validate(e){if(!e.header)throw new Error('pc.I18n#addData: Missing "header" field');if(!e.header.version)throw new Error('pc.I18n#addData: Missing "header.version" field');if(1!==e.header.version)throw new Error('pc.I18n#addData: Invalid "header.version" field');if(!e.data)throw new Error('pc.I18n#addData: Missing "data" field');if(!Array.isArray(e.data))throw new Error('pc.I18n#addData: "data" field must be an array');for(let t=0,s=e.data.length;t<s;t++){const s=e.data[t];if(!s.info)throw new Error(`pc.I18n#addData: missing "data[${t}].info" field`);if(!s.info.locale)throw new Error(`pc.I18n#addData: missing "data[${t}].info.locale" field`);if("string"!=typeof s.info.locale)throw new Error(`pc.I18n#addData: "data[${t}].info.locale" must be a string`);if(!s.messages)throw new Error(`pc.I18n#addData: missing "data[${t}].messages" field`)}}parse(e){return e.data}}class uf extends Kt{constructor(e){super(),this.locale=Vp,this._translations={},this._availableLangs={},this._app=e,this._assets=[],this._parser=new df}set assets(e){const t={};for(let s=0,i=e.length;s<i;s++){t[e[s]instanceof ef?e[s].id:e[s]]=!0}let s=this._assets.length;for(;s--;){const e=this._assets[s];if(!t[e]){this._app.assets.off(`add:${e}`,this._onAssetAdd,this);const t=this._app.assets.get(e);t&&this._onAssetRemove(t),this._assets.splice(s,1)}}for(const e in t){const t=parseInt(e,10);if(-1!==this._assets.indexOf(t))continue;this._assets.push(t);const s=this._app.assets.get(t);s?this._onAssetAdd(s):this._app.assets.once(`add:${t}`,this._onAssetAdd,this)}}get assets(){return this._assets}set locale(e){if(this._locale===e)return;let t=Wp(e);if("in"===t&&(t="id",e=function(e,t){const s=e.indexOf("-");return-1!==s?t+e.substring(s):t}(e,t),this._locale===e))return;const s=this._locale;this._locale=e,this._lang=t,this._pluralFn=Xp(this._lang),this.fire("set:locale",e,s)}get locale(){return this._locale}static findAvailableLocale(e,t){return $p(e,t)}findAvailableLocale(e){if(this._translations[e])return e;const t=Wp(e);return this._findFallbackLocale(e,t)}getText(e,t){let s,i=e;t||(t=this._locale,s=this._lang);let n=this._translations[t];return n||(s||(s=Wp(t)),t=this._findFallbackLocale(t,s),n=this._translations[t]),n&&n.hasOwnProperty(e)&&(i=n[e],Array.isArray(i)&&(i=i[0]),null==i&&(i=e)),i}getPluralText(e,t,s){let i,n,r=e;s?(i=Wp(s),n=Xp(i)):(s=this._locale,i=this._lang,n=this._pluralFn);let a=this._translations[s];if(a||(i=Wp(s=this._findFallbackLocale(s,i)),n=Xp(i),a=this._translations[s]),a&&a[e]&&n){const s=n(t);r=a[e][s],null==r&&(r=e)}return r}addData(e){let t;try{t=this._parser.parse(e)}catch(e){return void console.error(e)}for(let e=0,s=t.length;e<s;e++){const s=t[e],i=s.info.locale,n=s.messages;if(!this._translations[i]){this._translations[i]={};const e=Wp(i);this._availableLangs[e]||(this._availableLangs[e]=i)}Object.assign(this._translations[i],n),this.fire("data:add",i,n)}}removeData(e){let t;try{t=this._parser.parse(e)}catch(e){return void console.error(e)}for(let e=0,s=t.length;e<s;e++){const s=t[e],i=s.info.locale,n=this._translations[i];if(!n)continue;const r=s.messages;for(const e in r)delete n[e];0===Object.keys(n).length&&(delete this._translations[i],delete this._availableLangs[Wp(i)]),this.fire("data:remove",i,r)}}destroy(){this._translations=null,this._availableLangs=null,this._assets=null,this._parser=null,this.off()}_findFallbackLocale(e,t){let s=Gp[e];return s&&this._translations[s]?s:(s=Gp[t],s&&this._translations[s]?s:(s=this._availableLangs[t],s&&this._translations[s]?s:Vp))}_onAssetAdd(e){e.on("load",this._onAssetLoad,this),e.on("change",this._onAssetChange,this),e.on("remove",this._onAssetRemove,this),e.on("unload",this._onAssetUnload,this),e.resource&&this._onAssetLoad(e)}_onAssetLoad(e){this.addData(e.resource)}_onAssetChange(e){e.resource&&this.addData(e.resource)}_onAssetRemove(e){e.off("load",this._onAssetLoad,this),e.off("change",this._onAssetChange,this),e.off("remove",this._onAssetRemove,this),e.off("unload",this._onAssetUnload,this),e.resource&&this.removeData(e.resource),this._app.assets.once(`add:${e.id}`,this._onAssetAdd,this)}_onAssetUnload(e){e.resource&&this.removeData(e.resource)}}class pf extends Kt{constructor(e){super(),this._scripts={},this._list=[],this._scriptSchemas=new Map,this.app=e}destroy(){this.app=null,this.off()}addSchema(e,t){t&&this._scriptSchemas.set(e,t)}getSchema(e){return this._scriptSchemas.get(e)}add(e){const t=e.__name;return this._scripts.hasOwnProperty(t)?(setTimeout((()=>{if(e.prototype.swap){const s=this._scripts[t],i=this._list.indexOf(s);this._list[i]=e,this._scripts[t]=e,this.fire("swap",t,e),this.fire(`swap:${t}`,e)}else console.warn(`script registry already has '${t}' script, define 'swap' method for new script type to enable code hot swapping`)})),!1):(this._scripts[t]=e,this._list.push(e),this.fire("add",t,e),this.fire(`add:${t}`,e),setTimeout((()=>{if(!this._scripts.hasOwnProperty(t))return;if(!this.app||!this.app.systems||!this.app.systems.script)return;const e=this.app.systems.script._components;let s;const i=[],n=[];for(e.loopIndex=0;e.loopIndex<e.length;e.loopIndex++){const n=e.items[e.loopIndex];if(n._scriptsIndex[t]&&n._scriptsIndex[t].awaiting){n._scriptsData&&n._scriptsData[t]&&(s=n._scriptsData[t].attributes);const e=n.create(t,{preloading:!0,ind:n._scriptsIndex[t].ind,attributes:s});e&&i.push(e);for(const e of n.scripts)n.initializeAttributes(e)}}for(let e=0;e<i.length;e++)i[e].enabled&&(i[e]._initialized=!0,n.push(i[e]),i[e].initialize&&i[e].initialize());for(let e=0;e<n.length;e++)n[e].enabled&&!n[e]._postInitialized&&(n[e]._postInitialized=!0,n[e].postInitialize&&n[e].postInitialize())})),!0)}remove(e){let t=e,s=e;if("string"!=typeof s?s=t.__name:t=this.get(s),this.get(s)!==t)return!1;delete this._scripts[s];const i=this._list.indexOf(t);return this._list.splice(i,1),this.fire("remove",s,t),this.fire(`remove:${s}`,t),!0}get(e){return this._scripts[e]||null}has(e){if("string"==typeof e)return this._scripts.hasOwnProperty(e);if(!e)return!1;const t=e.__name;return this._scripts[t]===e}list(){return this._list}}const ff=(e,t)=>e.constructor.order-t.constructor.order,mf=[],gf=[],_f=e=>{e.length=0,gf.push(e)};class vf extends vh{constructor(e,t=Fp()){super(e),this.anim=void 0,this.animation=void 0,this.audiolistener=void 0,this.button=void 0,this.camera=void 0,this.collision=void 0,this.element=void 0,this.gsplat=void 0,this.layoutchild=void 0,this.layoutgroup=void 0,this.light=void 0,this.model=void 0,this.particlesystem=void 0,this.render=void 0,this.rigidbody=void 0,this.screen=void 0,this.script=void 0,this.scrollbar=void 0,this.scrollview=void 0,this.sound=void 0,this.sprite=void 0,this.c={},this._app=void 0,this._destroying=!1,this._guid=null,this._template=!1,this._app=t}addComponent(e,t){const s=this._app.systems[e];return s?this.c[e]?null:s.addComponent(this,t):null}removeComponent(e){const t=this._app.systems[e];t&&this.c[e]&&t.removeComponent(this)}findComponent(e){const t=this.findOne((t=>{var s;return null==(s=t.c)?void 0:s[e]}));return t&&t.c[e]}findComponents(e){return this.find((t=>{var s;return null==(s=t.c)?void 0:s[e]})).map((t=>t.c[e]))}findScript(e){const t=this.findOne((t=>{var s;return null==(s=t.c)||null==(s=s.script)?void 0:s.has(e)}));return null==t?void 0:t.c.script.get(e)}findScripts(e){return this.find((t=>{var s;return null==(s=t.c)||null==(s=s.script)?void 0:s.has(e)})).map((t=>t.c.script.get(e)))}getGuid(){return this._guid||this.setGuid(Lt.create()),this._guid}setGuid(e){const t=this._app._entityIndex;this._guid&&delete t[this._guid],this._guid=e,t[this._guid]=this}_notifyHierarchyStateChanged(e,t){let s=!1;e===this&&0===mf.length&&(s=!0),e._beingEnabled=!0,e._onHierarchyStateChanged(t),e._onHierarchyStatePostChanged&&mf.push(e);const i=e._children;for(let e=0,s=i.length;e<s;e++)i[e]._enabled&&this._notifyHierarchyStateChanged(i[e],t);if(e._beingEnabled=!1,s){for(let e=0;e<mf.length;e++)mf[e]._onHierarchyStatePostChanged();mf.length=0}}_onHierarchyStateChanged(e){super._onHierarchyStateChanged(e);const t=this._getSortedComponents();for(let s=0;s<t.length;s++){const i=t[s];i.enabled&&(e?i.onEnable():i.onDisable())}_f(t)}_onHierarchyStatePostChanged(){const e=this._getSortedComponents();for(let t=0;t<e.length;t++)e[t].onPostStateChange();_f(e)}findByGuid(e){if(this._guid===e)return this;const t=this._app._entityIndex[e];return t&&(t===this||t.isDescendantOf(this))?t:null}destroy(){this._destroying=!0;for(const e in this.c)this.c[e].enabled=!1;for(const e in this.c)this.c[e].system.removeComponent(this);super.destroy(),this._guid&&delete this._app._entityIndex[this._guid],this._destroying=!1}clone(){const e={},t=this._cloneRecursively(e);return e[this.getGuid()]=t,bf(this,this,t,e),t}_getSortedComponents(){const e=this.c,t=null!=(s=gf.pop())?s:[];var s;let i=0;for(const s in e)if(e.hasOwnProperty(s)){const n=e[s];i|=0!==n.constructor.order,t.push(n)}return i&&t.length>1&&t.sort(ff),t}_cloneRecursively(e){const t=new this.constructor(void 0,this._app);super._cloneInternal(t);for(const e in this.c){this.c[e].system.cloneComponent(this,t)}for(let s=0;s<this._children.length;s++){const i=this._children[s];if(i instanceof vf){const s=i._cloneRecursively(e);t.addChild(s),e[i.getGuid()]=s}}return t}}function bf(e,t,s,i){if(t instanceof vf){const n=t.c;for(const t in n){const r=n[t],a=r.system.getPropertiesOfType("entity");for(let n=0,o=a.length;n<o;n++){const o=a[n].name,l=r[o];if(!!e.findByGuid(l)){const e=i[l].getGuid();e&&(s.c[t][o]=e)}}}n.script&&s.script.resolveDuplicatedEntityReferenceProperties(n.script,i),n.render&&s.render.resolveDuplicatedEntityReferenceProperties(n.render,i),n.anim&&s.anim.resolveDuplicatedEntityReferenceProperties(n.anim,i);const r=t.children.filter((e=>e instanceof vf)),a=s.children.filter((e=>e instanceof vf));for(let t=0,s=r.length;t<s;t++)bf(e,r[t],a[t],i)}}vf.EVENT_DESTROY="destroy";class yf{constructor(e,t){this.name=void 0,this.url=void 0,this.data=null,this._loading=!1,this._onLoadedCallbacks=[],this.name=e,this.url=t}get loaded(){return!!this.data}get loading(){return this._loading}}class xf{constructor(e){this._app=void 0,this._list=[],this._index={},this._urlIndex={},this._app=e}destroy(){this._app=null}list(){return this._list}add(e,t){if(this._index.hasOwnProperty(e))return!1;const s=new yf(e,t),i=this._list.push(s);return this._index[s.name]=i-1,this._urlIndex[s.url]=i-1,!0}find(e){return this._index.hasOwnProperty(e)?this._list[this._index[e]]:null}findByUrl(e){return this._urlIndex.hasOwnProperty(e)?this._list[this._urlIndex[e]]:null}remove(e){if(this._index.hasOwnProperty(e)){const t=this._index[e];let s=this._list[t];delete this._urlIndex[s.url],delete this._index[e],this._list.splice(t,1);for(let e=0;e<this._list.length;e++)s=this._list[e],this._index[s.name]=e,this._urlIndex[s.url]=e}}_loadSceneData(e,t,s){const i=this._app;let n=e;if("string"==typeof e&&(e=this.findByUrl(n)||this.find(n)||new yf("Untitled",n)),n=e.url,n)if(e.loaded)s(null,e);else{if(i.assets&&i.assets.prefix&&!Kp.test(n)&&(n=It.join(i.assets.prefix,n)),e._onLoadedCallbacks.push(s),!e._loading){i.loader.getHandler("hierarchy").load(n,((s,i)=>{e.data=i,e._loading=!1;for(let t=0;t<e._onLoadedCallbacks.length;t++)e._onLoadedCallbacks[t](s,e);t||(e.data=null),e._onLoadedCallbacks.length=0}))}e._loading=!0}else s("Cannot find scene to load")}loadSceneData(e,t){this._loadSceneData(e,!0,t)}unloadSceneData(e){"string"==typeof e&&(e=this.findByUrl(e)),e&&(e.data=null)}_loadSceneHierarchy(e,t,s){this._loadSceneData(e,!1,((e,i)=>{if(e)return void(s&&s(e));t&&t(i);const n=this._app;n._preloadScripts(i.data,(()=>{const e=n.loader.getHandler("hierarchy");n.systems.script.preloading=!0;const t=e.open(i.url,i.data);n.systems.script.preloading=!1,n.loader.clearCache(i.url,"hierarchy"),n.root.addChild(t),n.systems.fire("initialize",t),n.systems.fire("postInitialize",t),n.systems.fire("postPostInitialize",t),s&&s(null,t)}))}))}loadSceneHierarchy(e,t){this._loadSceneHierarchy(e,null,t)}loadSceneSettings(e,t){this._loadSceneData(e,!1,((e,s)=>{e?t&&t(e):(this._app.applySceneSettings(s.data.settings),t&&t(null))}))}changeScene(e,t){const s=this._app;this._loadSceneHierarchy(e,(e=>{const{children:t}=s.root;for(;t.length;)t[0].destroy();s.applySceneSettings(e.data.settings)}),t)}loadScene(e,t){const s=this._app,i=s.loader.getHandler("scene");s.assets&&s.assets.prefix&&!Kp.test(e)&&(e=It.join(s.assets.prefix,e)),i.load(e,((n,r)=>{if(n)t&&t(n);else{const n=()=>{s.systems.script.preloading=!0;const n=i.open(e,r),a=this.findByUrl(e);a&&!a.loaded&&(a.data=r),s.systems.script.preloading=!1,s.loader.clearCache(e,"scene"),s.loader.patch({resource:n,type:"scene"},s.assets),s.root.addChild(n.root),s.systems.rigidbody&&"undefined"!=typeof Ammo&&s.systems.rigidbody.gravity.set(n._gravity.x,n._gravity.y,n._gravity.z),t&&t(null,n)};s._preloadScripts(r,n)}}))}}class wf{constructor(e){this.frame={fps:0,ms:0,dt:0,updateStart:0,updateTime:0,renderStart:0,renderTime:0,physicsStart:0,physicsTime:0,cullTime:0,sortTime:0,skinTime:0,morphTime:0,instancingTime:0,triangles:0,otherPrimitives:0,shaders:0,materials:0,cameras:0,shadowMapUpdates:0,shadowMapTime:0,depthMapTime:0,forwardTime:0,lightClustersTime:0,lightClusters:0,_timeToCountFrames:0,_fpsAccum:0},this.drawCalls={forward:0,depth:0,shadow:0,immediate:0,misc:0,total:0,skinned:0,instanced:0,removedByInstancing:0},this.misc={renderTargetCreationTime:0},this.particles={updatesPerFrame:0,_updatesPerFrame:0,frameTime:0,_frameTime:0},this.shaders=e._shaderStats,this.vram=e._vram,Object.defineProperty(this.vram,"totalUsed",{get:function(){return this.tex+this.vb+this.ib}}),Object.defineProperty(this.vram,"geom",{get:function(){return this.vb+this.ib}})}get scene(){return Fp().scene._stats}get lightmapper(){var e;return null==(e=Fp().lightmapper)?void 0:e.stats}get batcher(){const e=Fp()._batcher;return e?e._stats:null}}class Sf extends Kt{constructor(e){super(),this._batcher=null,this._destroyRequested=!1,this._inFrameUpdate=!1,this._librariesLoaded=!1,this._fillMode=Rp,this._resolutionMode="FIXED",this._allowResize=!0,this._skyboxAsset=null,this._soundManager=void 0,this._visibilityChangeHandler=void 0,this._entityIndex={},this._inTools=!1,this._scriptPrefix="",this._time=0,this.enableBundles="undefined"!=typeof TextDecoder,this.frameRequestId=void 0,this.timeScale=1,this.maxDeltaTime=.1,this.frame=0,this.frameGraph=new Bp,this.renderer=void 0,this.scriptsOrder=[],this.stats=void 0,this.autoRender=!0,this.renderNextFrame=!1,this.graphicsDevice=void 0,this.root=void 0,this.scene=void 0,this.lightmapper=null,this.loader=new cf(this),this.assets=void 0,this.bundles=void 0,this.scenes=new xf(this),this.scripts=new pf(this),this.systems=new rf,this.i18n=new uf(this),this.keyboard=null,this.mouse=null,this.touch=null,this.gamepads=null,this.elementInput=null,this.xr=null,Sf._applications[e.id]=this,Op(this),this.root=new vf,this.root._enabledInHierarchy=!0}init(e){const{assetPrefix:t,batchManager:s,componentSystems:i,elementInput:n,gamepads:r,graphicsDevice:a,keyboard:o,lightmapper:l,mouse:h,resourceHandlers:c,scriptsOrder:d,scriptPrefix:u,soundManager:p,touch:f,xr:m}=e;this.graphicsDevice=a,this._initDefaultMaterial(),this._initProgramLibrary(),this.stats=new wf(a),this._soundManager=p,this.scene=new xu(a),this._registerSceneImmediate(this.scene),this.assets=new sf(this.loader),t&&(this.assets.prefix=t),this.bundles=new nf(this.assets),this.scriptsOrder=d||[],this.defaultLayerWorld=new ud({name:"World",id:0}),this.defaultLayerDepth=new ud({name:"Depth",id:1,enabled:!1,opaqueSortMode:0}),this.defaultLayerSkybox=new ud({name:"Skybox",id:2,opaqueSortMode:0}),this.defaultLayerUi=new ud({name:"UI",id:4,transparentSortMode:1}),this.defaultLayerImmediate=new ud({name:"Immediate",id:3,opaqueSortMode:0});const g=new md("default");g.pushOpaque(this.defaultLayerWorld),g.pushOpaque(this.defaultLayerDepth),g.pushOpaque(this.defaultLayerSkybox),g.pushTransparent(this.defaultLayerWorld),g.pushOpaque(this.defaultLayerImmediate),g.pushTransparent(this.defaultLayerImmediate),g.pushTransparent(this.defaultLayerUi),this.scene.layers=g,Up.createPlaceholder(a),this.renderer=new ad(a),this.renderer.scene=this.scene,l&&(this.lightmapper=new l(a,this.root,this.scene,this.renderer,this.assets),this.once("prerender",this._firstBake,this)),s&&(this._batcher=new s(a,this.root,this.scene),this.once("prerender",this._firstBatch,this)),this.keyboard=o||null,this.mouse=h||null,this.touch=f||null,this.gamepads=r||null,n&&(this.elementInput=n,this.elementInput.app=this),this.xr=m?new m(this):null,this.elementInput&&this.elementInput.attachSelectEvents(),this._scriptPrefix=u||"",this.enableBundles&&this.loader.addHandler("bundle",new hf(this)),c.forEach((e=>{const t=new e(this);this.loader.addHandler(t.handlerType,t)})),i.forEach((e=>{this.systems.add(new e(this))})),this._visibilityChangeHandler=this.onVisibilityChange.bind(this),"undefined"!=typeof document&&(void 0!==document.hidden?(this._hiddenAttr="hidden",document.addEventListener("visibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.mozHidden?(this._hiddenAttr="mozHidden",document.addEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.msHidden?(this._hiddenAttr="msHidden",document.addEventListener("msvisibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.webkitHidden&&(this._hiddenAttr="webkitHidden",document.addEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1))),this.tick=Tf(this)}static getApplication(e){return e?Sf._applications[e]:Fp()}_initDefaultMaterial(){const e=new ju;e.name="Default Material",function(e,t){Rl.get(e,(()=>t))}(this.graphicsDevice,e)}_initProgramLibrary(){const e=new hp(this.graphicsDevice,new ju);!function(e,t){dl.get(e,(()=>t))}(this.graphicsDevice,e)}get soundManager(){return this._soundManager}get batcher(){return this._batcher}get fillMode(){return this._fillMode}get resolutionMode(){return this._resolutionMode}configure(e,t){Ho.get(e,((e,s)=>{if(e)return void t(e);const i=s.application_properties,n=s.scenes,r=s.assets;this._parseApplicationProperties(i,(e=>{this._parseScenes(n),this._parseAssets(r),t(e||null)}))}))}preload(e){this.fire("preload:start");const t=this.assets.list({preload:!0});if(0===t.length)return this.fire("preload:end"),void e();let s=0;const i=()=>{s++,this.fire("preload:progress",s/t.length),s===t.length&&(this.fire("preload:end"),e())};t.forEach((e=>{e.loaded?i():(e.once("load",i),e.once("error",i),this.assets.load(e))}))}_preloadScripts(e,t){t()}_parseApplicationProperties(e,t){if("number"==typeof e.maxAssetRetries&&e.maxAssetRetries>0&&this.loader.enableRetry(e.maxAssetRetries),e.useDevicePixelRatio||(e.useDevicePixelRatio=e.use_device_pixel_ratio),e.resolutionMode||(e.resolutionMode=e.resolution_mode),e.fillMode||(e.fillMode=e.fill_mode),this._width=e.width,this._height=e.height,e.useDevicePixelRatio&&(this.graphicsDevice.maxPixelRatio=window.devicePixelRatio),this.setCanvasResolution(e.resolutionMode,this._width,this._height),this.setCanvasFillMode(e.fillMode,this._width,this._height),e.layers&&e.layerOrder){const t=new md("application"),s={};for(const t in e.layers){const i=e.layers[t];i.id=parseInt(t,10),i.enabled=1!==i.id,s[t]=new ud(i)}for(let i=0,n=e.layerOrder.length;i<n;i++){const n=e.layerOrder[i],r=s[n.layer];r&&(n.transparent?t.pushTransparent(r):t.pushOpaque(r),t.subLayerEnabled[i]=n.enabled)}this.scene.layers=t}if(e.batchGroups){const t=this.batcher;if(t)for(let s=0,i=e.batchGroups.length;s<i;s++){const i=e.batchGroups[s];t.addGroup(i.name,i.dynamic,i.maxAabbSize,i.id,i.layers)}}e.i18nAssets&&(this.i18n.assets=e.i18nAssets),this._loadLibraries(e.libraries,t)}_loadLibraries(e,t){const s=e.length;let i=s;const n=/^https?:\/\//;if(s){const r=(e,s)=>{i--,e?t(e):0===i&&(this.onLibrariesLoaded(),t(null))};for(let t=0;t<s;++t){let s=e[t];!n.test(s.toLowerCase())&&this._scriptPrefix&&(s=It.join(this._scriptPrefix,s)),this.loader.load(s,"script",r)}}else this.onLibrariesLoaded(),t(null)}_parseScenes(e){if(e)for(let t=0;t<e.length;t++)this.scenes.add(e[t].name,e[t].url)}_parseAssets(e){const t=[],s={},i={};for(let i=0;i<this.scriptsOrder.length;i++){const n=this.scriptsOrder[i];e[n]&&(s[n]=!0,t.push(e[n]))}if(this.enableBundles)for(const s in e)"bundle"===e[s].type&&(i[s]=!0,t.push(e[s]));for(const n in e)s[n]||i[n]||t.push(e[n]);for(let e=0;e<t.length;e++){const s=t[e],i=new ef(s.name,s.type,s.file,s.data);if(i.id=parseInt(s.id,10),i.preload=!!s.preload&&s.preload,i.loaded="script"===s.type&&s.data&&s.data.loadingType>0,i.tags.add(s.tags),s.i18n)for(const e in s.i18n)i.addLocalizedAssetId(e,s.i18n[e]);this.assets.add(i)}}start(){this.frame=0,this.fire("start",{timestamp:ts(),target:this}),this._librariesLoaded||this.onLibrariesLoaded(),this.systems.fire("initialize",this.root),this.fire("initialize"),this.systems.fire("postInitialize",this.root),this.systems.fire("postPostInitialize",this.root),this.fire("postinitialize"),this.tick()}inputUpdate(e){this.controller&&this.controller.update(e),this.mouse&&this.mouse.update(),this.keyboard&&this.keyboard.update(),this.gamepads&&this.gamepads.update()}update(e){this.frame++,this.graphicsDevice.updateClientRect(),this.systems.fire(this._inTools?"toolsUpdate":"update",e),this.systems.fire("animationUpdate",e),this.systems.fire("postUpdate",e),this.fire("update",e),this.inputUpdate(e)}frameStart(){this.graphicsDevice.frameStart()}frameEnd(){this.graphicsDevice.frameEnd()}render(){this.fire("prerender"),this.root.syncHierarchy(),this._batcher&&this._batcher.updateAll(),this.renderComposition(this.scene.layers),this.fire("postrender")}renderComposition(e){this.renderer.update(e),this.renderer.buildFrameGraph(this.frameGraph,e),this.frameGraph.render(this.graphicsDevice)}_fillFrameStatsBasic(e,t,s){const i=this.stats.frame;i.dt=t,i.ms=s,e>i._timeToCountFrames?(i.fps=i._fpsAccum,i._fpsAccum=0,i._timeToCountFrames=e+1e3):i._fpsAccum++,this.stats.drawCalls.total=this.graphicsDevice._drawCallsPerFrame,this.graphicsDevice._drawCallsPerFrame=0}_fillFrameStats(){let e=this.stats.frame;e.cameras=this.renderer._camerasRendered,e.materials=this.renderer._materialSwitches,e.shaders=this.graphicsDevice._shaderSwitchesPerFrame,e.shadowMapUpdates=this.renderer._shadowMapUpdates,e.shadowMapTime=this.renderer._shadowMapTime,e.depthMapTime=this.renderer._depthMapTime,e.forwardTime=this.renderer._forwardTime;const t=this.graphicsDevice._primsPerFrame;e.triangles=t[4]/3+Math.max(t[5]-2,0)+Math.max(t[6]-2,0),e.cullTime=this.renderer._cullTime,e.sortTime=this.renderer._sortTime,e.skinTime=this.renderer._skinTime,e.morphTime=this.renderer._morphTime,e.lightClusters=this.renderer._lightClusters,e.lightClustersTime=this.renderer._lightClustersTime,e.otherPrimitives=0;for(let s=0;s<t.length;s++)s<4&&(e.otherPrimitives+=t[s]),t[s]=0;this.renderer._camerasRendered=0,this.renderer._materialSwitches=0,this.renderer._shadowMapUpdates=0,this.graphicsDevice._shaderSwitchesPerFrame=0,this.renderer._cullTime=0,this.renderer._layerCompositionUpdateTime=0,this.renderer._lightClustersTime=0,this.renderer._sortTime=0,this.renderer._skinTime=0,this.renderer._morphTime=0,this.renderer._shadowMapTime=0,this.renderer._depthMapTime=0,this.renderer._forwardTime=0,e=this.stats.drawCalls,e.forward=this.renderer._forwardDrawCalls,e.culled=this.renderer._numDrawCallsCulled,e.depth=0,e.shadow=this.renderer._shadowDrawCalls,e.skinned=this.renderer._skinDrawCalls,e.immediate=0,e.instanced=0,e.removedByInstancing=0,e.misc=e.total-(e.forward+e.shadow),this.renderer._depthDrawCalls=0,this.renderer._shadowDrawCalls=0,this.renderer._forwardDrawCalls=0,this.renderer._numDrawCallsCulled=0,this.renderer._skinDrawCalls=0,this.renderer._immediateRendered=0,this.renderer._instancedDrawCalls=0,this.stats.misc.renderTargetCreationTime=this.graphicsDevice.renderTargetCreationTime,e=this.stats.particles,e.updatesPerFrame=e._updatesPerFrame,e.frameTime=e._frameTime,e._updatesPerFrame=0,e._frameTime=0}setCanvasFillMode(e,t,s){this._fillMode=e,this.resizeCanvas(t,s)}setCanvasResolution(e,t,s){this._resolutionMode=e,e===Lp&&void 0===t&&(t=this.graphicsDevice.canvas.clientWidth,s=this.graphicsDevice.canvas.clientHeight),this.graphicsDevice.resizeCanvas(t,s)}isHidden(){return document[this._hiddenAttr]}onVisibilityChange(){this.isHidden()?this._soundManager&&this._soundManager.suspend():this._soundManager&&this._soundManager.resume()}resizeCanvas(e,t){if(!this._allowResize)return;if(this.xr&&this.xr.session)return;const s=window.innerWidth,i=window.innerHeight;if(this._fillMode===Rp){const n=this.graphicsDevice.canvas.width/this.graphicsDevice.canvas.height;n>s/i?t=(e=s)/n:e=(t=i)*n}else"FILL_WINDOW"===this._fillMode&&(e=s,t=i);return this.graphicsDevice.canvas.style.width=`${e}px`,this.graphicsDevice.canvas.style.height=`${t}px`,this.updateCanvasSize(),{width:e,height:t}}updateCanvasSize(){var e;if(this._allowResize&&(null==(e=this.xr)||!e.active)&&this._resolutionMode===Lp){const e=this.graphicsDevice.canvas;this.graphicsDevice.resizeCanvas(e.clientWidth,e.clientHeight)}}onLibrariesLoaded(){this._librariesLoaded=!0,this.systems.rigidbody&&this.systems.rigidbody.onLibraryLoaded()}applySceneSettings(e){let t;if(this.systems.rigidbody&&"undefined"!=typeof Ammo){const[t,s,i]=e.physics.gravity;this.systems.rigidbody.gravity.set(t,s,i)}this.scene.applySettings(e),e.render.hasOwnProperty("skybox")&&(e.render.skybox?(t=this.assets.get(e.render.skybox),t?this.setSkybox(t):this.assets.once(`add:${e.render.skybox}`,this.setSkybox,this)):this.setSkybox(null))}setAreaLightLuts(e,t){e&&t&&Up.set(this.graphicsDevice,e,t)}setSkybox(e){if(e!==this._skyboxAsset){const t=()=>{this.setSkybox(null)},s=()=>{this.scene.setSkybox(this._skyboxAsset?this._skyboxAsset.resources:null)};this._skyboxAsset&&(this.assets.off(`load:${this._skyboxAsset.id}`,s,this),this.assets.off(`remove:${this._skyboxAsset.id}`,t,this),this._skyboxAsset.off("change",s,this)),this._skyboxAsset=e,this._skyboxAsset&&(this.assets.on(`load:${this._skyboxAsset.id}`,s,this),this.assets.once(`remove:${this._skyboxAsset.id}`,t,this),this._skyboxAsset.on("change",s,this),0!==this.scene.skyboxMip||this._skyboxAsset.loadFaces||(this._skyboxAsset.loadFaces=!0),this.assets.load(this._skyboxAsset)),s()}}_firstBake(){var e;null==(e=this.lightmapper)||e.bake(null,this.scene.lightmapMode)}_firstBatch(){var e;null==(e=this.batcher)||e.generate()}_processTimestamp(e){return e}drawLine(e,t,s,i,n){this.scene.drawLine(e,t,s,i,n)}drawLines(e,t,s=!0,i=this.scene.defaultDrawLayer){this.scene.drawLines(e,t,s,i)}drawLineArrays(e,t,s=!0,i=this.scene.defaultDrawLayer){this.scene.drawLineArrays(e,t,s,i)}drawWireSphere(e,t,s=os.WHITE,i=20,n=!0,r=this.scene.defaultDrawLayer){this.scene.immediate.drawWireSphere(e,t,s,i,n,r)}drawWireAlignedBox(e,t,s=os.WHITE,i=!0,n=this.scene.defaultDrawLayer,r){this.scene.immediate.drawWireAlignedBox(e,t,s,i,n,r)}drawMeshInstance(e,t=this.scene.defaultDrawLayer){this.scene.immediate.drawMesh(null,null,null,e,t)}drawMesh(e,t,s,i=this.scene.defaultDrawLayer){this.scene.immediate.drawMesh(t,s,e,null,i)}drawQuad(e,t,s=this.scene.defaultDrawLayer){this.scene.immediate.drawMesh(t,e,this.scene.immediate.getQuadMesh(),null,s)}drawTexture(e,t,s,i,n,r,a=this.scene.defaultDrawLayer,o=!0){if(!1===o&&!this.graphicsDevice.isWebGPU)return;const l=new As;l.setTRS(new ys(e,t,0),Ds.IDENTITY,new ys(s,-i,0)),r||((r=new Rd).cull=0,r.setParameter("colorMap",n),r.shaderDesc=o?this.scene.immediate.getTextureShaderDesc(n.encoding):this.scene.immediate.getUnfilterableTextureShaderDesc(),r.update()),this.drawQuad(l,r,a)}drawDepthTexture(e,t,s,i,n=this.scene.defaultDrawLayer){const r=new Rd;r.cull=0,r.shaderDesc=this.scene.immediate.getDepthTextureShaderDesc(),r.update(),this.drawTexture(e,t,s,i,null,r,n)}destroy(){var e,t,s,i;if(this._inFrameUpdate)return void(this._destroyRequested=!0);const n=this.graphicsDevice.canvas.id;this.fire("destroy",this),this.off("librariesloaded"),"undefined"!=typeof document&&(document.removeEventListener("visibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("msvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1)),this._visibilityChangeHandler=null,this.root.destroy(),this.root=null,this.mouse&&(this.mouse.off(),this.mouse.detach(),this.mouse=null),this.keyboard&&(this.keyboard.off(),this.keyboard.detach(),this.keyboard=null),this.touch&&(this.touch.off(),this.touch.detach(),this.touch=null),this.elementInput&&(this.elementInput.detach(),this.elementInput=null),this.gamepads&&(this.gamepads.destroy(),this.gamepads=null),this.controller&&(this.controller=null),this.systems.destroy(),this.scene.layers&&this.scene.layers.destroy();const r=this.assets.list();for(let e=0;e<r.length;e++)r[e].unload(),r[e].off();this.assets.off(),this.bundles.destroy(),this.bundles=null,this.i18n.destroy(),this.i18n=null;const a=this.loader.getHandler("script");null==a||a.clearCache(),this.loader.destroy(),this.loader=null,this.scene.destroy(),this.scene=null,this.systems=null,this.context=null,this.scripts.destroy(),this.scripts=null,this.scenes.destroy(),this.scenes=null,null==(e=this.lightmapper)||e.destroy(),this.lightmapper=null,this._batcher&&(this._batcher.destroy(),this._batcher=null),this._entityIndex={},this.defaultLayerDepth.onDisable=null,this.defaultLayerDepth.onEnable=null,this.defaultLayerDepth=null,this.defaultLayerWorld=null,null==(t=this.xr)||t.end(),null==(s=this.xr)||s.destroy(),this.renderer.destroy(),this.renderer=null,this.graphicsDevice.destroy(),this.graphicsDevice=null,this.tick=null,this.off(),null==(i=this._soundManager)||i.destroy(),this._soundManager=null,Sf._applications[n]=null,Fp()===this&&Op(null),Sf.cancelTick(this)}static cancelTick(e){e.frameRequestId&&(window.cancelAnimationFrame(e.frameRequestId),e.frameRequestId=void 0)}getEntityFromIndex(e){return this._entityIndex[e]}_registerSceneImmediate(e){this.on("postrender",e.immediate.onPostRender,e.immediate)}}Sf._applications={};const Cf={},Tf=function(e){const t=e;return function(e,s){var i,n;if(!t.graphicsDevice)return;t.frameRequestId&&(null==(n=t.xr)||null==(n=n.session)||n.cancelAnimationFrame(t.frameRequestId),cancelAnimationFrame(t.frameRequestId),t.frameRequestId=null);t._inFrameUpdate=!0,Op(t);const r=t._processTimestamp(e)||ts(),a=r-(t._time||r);let o=a/1e3;if(o=rs.clamp(o,0,t.maxDeltaTime),o*=t.timeScale,t._time=r,null!=(i=t.xr)&&i.session?t.frameRequestId=t.xr.session.requestAnimationFrame(t.tick):t.frameRequestId=qt.browser||qt.worker?requestAnimationFrame(t.tick):null,t.graphicsDevice.contextLost)return;t._fillFrameStatsBasic(r,o,a),t.fire("frameupdate",a);let l=!0;var h;s?(l=null==(h=t.xr)?void 0:h.update(s),t.graphicsDevice.defaultFramebuffer=s.session.renderState.baseLayer.framebuffer):t.graphicsDevice.defaultFramebuffer=null;l&&(t.update(o),t.fire("framerender"),(t.autoRender||t.renderNextFrame)&&(t.updateCanvasSize(),t.frameStart(),t.render(),t.frameEnd(),t.renderNextFrame=!1),Cf.timestamp=ts(),Cf.target=t,t.fire("frameend",Cf)),t._inFrameUpdate=!1,t._destroyRequested&&t.destroy()}};class Ef{constructor(){this.elementInput=void 0,this.keyboard=void 0,this.mouse=void 0,this.touch=void 0,this.gamepads=void 0,this.scriptPrefix=void 0,this.assetPrefix=void 0,this.scriptsOrder=void 0,this.soundManager=void 0,this.graphicsDevice=void 0,this.lightmapper=void 0,this.batchManager=void 0,this.xr=void 0,this.componentSystems=[],this.resourceHandlers=[]}}const Pf=new Us;class kf{constructor(e,t,s){this.scene=e,this.light=t,this.store(),t.numCascades=1,this.scene.clusteredLightingEnabled&&(t.castShadows=t.bakeShadows&&s.shadowsEnabled),0!==t.type&&(t._node.getWorldTransform(),t.getBoundingSphere(Pf),this.lightBounds=new Bs,this.lightBounds.center.copy(Pf.center),this.lightBounds.halfExtents.set(Pf.radius,Pf.radius,Pf.radius))}store(){this.mask=this.light.mask,this.shadowUpdateMode=this.light.shadowUpdateMode,this.enabled=this.light.enabled,this.intensity=this.light.intensity,this.rotation=this.light._node.getLocalRotation().clone(),this.numCascades=this.light.numCascades,this.castShadows=this.light._castShadows}restore(){const e=this.light;e.mask=this.mask,e.shadowUpdateMode=this.shadowUpdateMode,e.enabled=this.enabled,e.intensity=this.intensity,e._node.setLocalRotation(this.rotation),e.numCascades=this.numCascades,e._castShadows=this.castShadows}startBake(){this.light.enabled=!0,this.light._destroyShadowMap(),this.light.beginFrame()}endBake(e){const t=this.light;t.enabled=!1,t.shadowMap&&(t.shadowMap.cached&&e.add(t,t.shadowMap),t.shadowMap=null)}}const Af=new ws;class Mf extends kf{constructor(e,t){super(e.scene,t,e.lightingParams)}get numVirtualLights(){return 0===this.light.type?this.light.bakeNumSamples:1}prepareVirtualLight(e,t){const s=this.light;if(s._node.setLocalRotation(this.rotation),e>0){const i=s.bakeArea;tu.circlePointDeterministic(Af,e,t),Af.mulScalar(.5*i),s._node.rotateLocal(Af.x,0,Af.y)}s._node.getWorldTransform();const i=Math.pow(this.intensity,2.2);s.intensity=Math.pow(i/t,1/2.2)}}const Df=new ys;class Rf extends kf{constructor(e){const t=e.scene,s=new vf("AmbientLight");s.addComponent("light",{type:"directional",affectDynamic:!0,affectLightmapped:!1,bake:!0,bakeNumSamples:t.ambientBakeNumSamples,castShadows:!0,normalOffsetBias:.05,shadowBias:.2,shadowDistance:1,shadowResolution:2048,shadowType:0,color:os.WHITE,intensity:1,bakeDir:!1}),super(t,s.light.light,e.lightingParams)}get numVirtualLights(){return this.light.bakeNumSamples}prepareVirtualLight(e,t){tu.spherePointDeterministic(Df,e,t,0,this.scene.ambientBakeSpherePart),this.light._node.lookAt(Df.mulScalar(-1)),this.light._node.rotateLocal(90,0,0);const s=2*Math.PI*this.scene.ambientBakeSpherePart,i=Math.pow(s,2.2);this.light.intensity=Math.pow(i/t,1/2.2)}}class Lf{constructor(e,t=null){this.node=e,this.component=e.render||e.model,t=t||this.component.meshInstances,this.store(),this.meshInstances=t,this.bounds=null,this.renderTargets=[]}store(){this.castShadows=this.component.castShadows}restore(){this.component.castShadows=this.castShadows}}class If{constructor(e){this.device=e,this.shaderDilate=fl(e,cl.fullscreenQuadVS,cp.dilatePS,"lmDilate"),this.constantTexSource=e.scope.resolve("source"),this.constantPixelOffset=e.scope.resolve("pixelOffset"),this.pixelOffset=new Float32Array(2),this.shaderDenoise=null,this.sigmas=null,this.constantSigmas=null,this.kernel=null}setSourceTexture(e){this.constantTexSource.setValue(e)}prepare(e,t){this.pixelOffset[0]=1/e,this.pixelOffset[1]=1/t,this.constantPixelOffset.setValue(this.pixelOffset)}prepareDenoise(e,t){this.shaderDenoise||(this.shaderDenoise=fl(this.device,cl.fullscreenQuadVS,cp.bilateralDeNoisePS,"lmBilateralDeNoise"),this.sigmas=new Float32Array(2),this.constantSigmas=this.device.scope.resolve("sigmas"),this.constantKernel=this.device.scope.resolve("kernel[0]"),this.bZnorm=this.device.scope.resolve("bZnorm")),this.sigmas[0]=e,this.sigmas[1]=t,this.constantSigmas.setValue(this.sigmas),this.evaluateDenoiseUniforms(e,t)}evaluateDenoiseUniforms(e,t){function s(e,t){return.39894*Math.exp(-.5*e*e/(t*t))/t}this.kernel=this.kernel||new Float32Array(15);const i=this.kernel,n=Math.floor(7);for(let t=0;t<=n;++t){const r=s(t,e);i[n+t]=r,i[n-t]=r}this.constantKernel.setValue(this.kernel);const r=1/s(0,t);this.bZnorm.setValue(r)}}class Ff extends uo{constructor(e,t,s,i,n,r){super(e),this.viewBindGroups=[],this.renderer=t,this.camera=s,this.worldClusters=i,this.receivers=n,this.lightArray=r}destroy(){this.viewBindGroups.forEach((e=>{e.defaultUniformBuffer.destroy(),e.destroy()})),this.viewBindGroups.length=0}execute(){const{renderer:e,camera:t,receivers:s,renderTarget:i,worldClusters:n,lightArray:r}=this;e.renderForwardLayer(t,i,null,void 0,0,this.viewBindGroups,{meshInstances:s,splitLights:r,lightClusters:n})}}const Of=new ys;class Bf{constructor(e,t,s,i,n){this.device=e,this.root=t,this.scene=s,this.renderer=i,this.assets=n,this.shadowMapCache=i.shadowMapCache,this._tempSet=new Set,this._initCalled=!1,this.passMaterials=[],this.ambientAOMaterial=null,this.fog="",this.ambientLight=new os,this.renderTargets=new Map,this.stats={renderPasses:0,lightmapCount:0,totalRenderTime:0,forwardTime:0,fboTime:0,shadowMapTime:0,compileTime:0,shadersLinked:0}}destroy(){var e;Il.decRef(this.blackTex),this.blackTex=null,Il.destroy(),this.device=null,this.root=null,this.scene=null,this.renderer=null,this.assets=null,null==(e=this.camera)||e.destroy(),this.camera=null}initBake(e){if(!this._initCalled){this._initCalled=!0,this.lightmapFilters=new If(e),this.constantBakeDir=e.scope.resolve("bakeDir"),this.materials=[],this.blackTex=new yn(this.device,{width:4,height:4,format:7,type:Mi,name:"lightmapBlack"}),Il.incRef(this.blackTex);const t=new eh;t.clearColor.set(0,0,0,0),t.clearColorBuffer=!0,t.clearDepthBuffer=!1,t.clearStencilBuffer=!1,t.frustumCulling=!1,t.projection=1,t.aspectRatio=1,t.node=new vh,this.camera=t,this.camera.shaderParams.gammaCorrection=0,this.camera.shaderParams.toneMapping=0}if(this.scene.clusteredLightingEnabled){const t=new Td(e.supportsAreaLights,e.maxTextureSize,(()=>{}));this.lightingParams=t;const s=this.scene.lighting;t.shadowsEnabled=s.shadowsEnabled,t.shadowAtlasResolution=s.shadowAtlasResolution,t.cookiesEnabled=s.cookiesEnabled,t.cookieAtlasResolution=s.cookieAtlasResolution,t.areaLightsEnabled=s.areaLightsEnabled,t.cells=new ys(3,3,3),t.maxLightsPerCell=4,this.worldClusters=new Bh(e),this.worldClusters.name="ClusterLightmapper"}}finishBake(e){function t(e){Il.decRef(e.colorBuffer),e.destroy()}this.materials=[],this.renderTargets.forEach((e=>{t(e)})),this.renderTargets.clear(),e.forEach((e=>{e.renderTargets.forEach((e=>{t(e)})),e.renderTargets.length=0})),this.ambientAOMaterial=null,this.worldClusters&&(this.worldClusters.destroy(),this.worldClusters=null)}createMaterialForPass(e,t,s,i){const n=new ju;n.name=`lmMaterial-pass:${s}-ambient:${i}`,n.chunks.APIVersion=ln;if(n.chunks.transformVS="#define UV1LAYOUT\n"+cl.transformVS,0===s){let e=cp.bakeLmEndPS;i?e=`\n\t\t\t\t\t\t\t\t\t\tdDiffuseLight = ((dDiffuseLight - 0.5) * max(${t.ambientBakeOcclusionContrast.toFixed(1)} + 1.0, 0.0)) + 0.5;\n\t\t\t\t\t\t\t\t\t\tdDiffuseLight += vec3(${t.ambientBakeOcclusionBrightness.toFixed(1)});\n\t\t\t\t\t\t\t\t\t\tdDiffuseLight = saturate(dDiffuseLight);\n\t\t\t\t\t\t\t\t\t\tdDiffuseLight *= dAmbientLight;\n\t\t\t\t\t\t\t\t${e}`:n.ambient=new os(0,0,0),n.chunks.basePS=cl.basePS+(7===t.lightmapPixelFormat?"\n#define LIGHTMAP_RGBM\n":""),n.chunks.endPS=e,n.lightMap=this.blackTex}else n.chunks.basePS=`${cl.basePS}\nuniform sampler2D texture_dirLightMap;\nuniform float bakeDir;\n`,n.chunks.endPS=cp.bakeDirLmEndPS;return n.chunks.outputAlphaPS="\n",n.chunks.outputAlphaOpaquePS="\n",n.chunks.outputAlphaPremulPS="\n",n.cull=0,n.forceUv1=!0,n.update(),n}createMaterials(e,t,s){for(let i=0;i<s;i++)this.passMaterials[i]||(this.passMaterials[i]=this.createMaterialForPass(e,t,i,!1));this.ambientAOMaterial||(this.ambientAOMaterial=this.createMaterialForPass(e,t,0,!0),this.ambientAOMaterial.onUpdateShader=function(e){return e.litOptions.lightMapWithoutAmbient=!0,e.litOptions.separateAmbient=!0,e})}createTexture(e,t){return new yn(this.device,{width:e,height:e,format:this.scene.lightmapPixelFormat,mipmaps:!1,type:7===this.scene.lightmapPixelFormat?Mi:Ai,minFilter:0,magFilter:0,addressU:1,addressV:1,name:t})}collectModels(e,t,s){var i,n,r;if(!e.enabled)return;let a;if(null!=(i=e.model)&&i.model&&null!=(n=e.model)&&n.enabled&&(s&&s.push(new Lf(e)),e.model.lightmapped&&t&&(a=e.model.model.meshInstances)),null!=(r=e.render)&&r.enabled&&(s&&s.push(new Lf(e)),e.render.lightmapped&&t&&(a=e.render.meshInstances)),a){let s=!0;for(let e=0;e<a.length;e++)if(!a[e].mesh.vertexBuffer.format.hasUv1){s=!1;break}if(s){const s=[];for(let i=0;i<a.length;i++){const n=a[i].mesh;this._tempSet.has(n)?t.push(new Lf(e,[a[i]])):s.push(a[i]),this._tempSet.add(n)}this._tempSet.clear(),s.length>0&&t.push(new Lf(e,s))}}for(let i=0;i<e._children.length;i++)this.collectModels(e._children[i],t,s)}prepareShadowCasters(e){const t=[];for(let s=0;s<e.length;s++){const i=e[s].component;if(i.castShadows=i.castShadowsLightmap,i.castShadowsLightmap){const i=e[s].meshInstances;for(let e=0;e<i.length;e++)i[e].visibleThisFrame=!0,t.push(i[e])}}return t}updateTransforms(e){for(let t=0;t<e.length;t++){const s=e[t].meshInstances;for(let e=0;e<s.length;e++)s[e].node.getWorldTransform()}}calculateLightmapSize(e){let t;const s=this.scene.lightmapSizeMultiplier||16,i=Of;let n,r;e.model?(r=e.model.lightmapSizeMultiplier,e.model.asset?(t=this.assets.get(e.model.asset).data,t.area&&(n=t.area)):e.model._area&&(t=e.model,t._area&&(n=t._area))):e.render&&(r=e.render.lightmapSizeMultiplier,"asset"!==e.render.type&&e.render._area&&(t=e.render,t._area&&(n=t._area)));const a={x:1,y:1,z:1,uv:1};n&&(a.x=n.x,a.y=n.y,a.z=n.z,a.uv=n.uv);const o=r||1;a.x*=o,a.y*=o,a.z*=o;const l=e.render||e.model,h=this.computeNodeBounds(l.meshInstances);i.copy(h.halfExtents);let c=a.x*i.y*i.z+a.y*i.x*i.z+a.z*i.x*i.y;c/=a.uv,c=Math.sqrt(c);return Math.min(rs.nextPowerOfTwo(c*s),this.scene.lightmapMaxResolution||2048)}setLightmapping(e,t,s,i){for(let n=0;n<e.length;n++){const r=e[n],a=r.meshInstances;for(let e=0;e<a.length;e++){const n=a[e];if(n.setLightmapped(t),t){i&&(n._shaderDefs|=i),n.mask=2;for(let e=0;e<s;e++){const t=r.renderTargets[e].colorBuffer;t.minFilter=1,t.magFilter=1,n.setRealtimeLightmap(Hl.lightmapParamNames[e],t)}}}}}bake(e,t=1){const s=this.device,i=ts();this.scene._updateSkyMesh(),this.stats.renderPasses=0,this.stats.shadowMapTime=0,this.stats.forwardTime=0;const n=s._shaderStats.linked,r=s._renderTargetCreationTime,a=s._shaderStats.compileTime,o=[],l=[];if(e){for(let t=0;t<e.length;t++)this.collectModels(e[t],o,null);this.collectModels(this.root,null,l)}else this.collectModels(this.root,o,l);if(o.length>0){this.renderer.shadowRenderer.frameUpdate();const e=1===t?2:1;this.setLightmapping(o,!1,e),this.initBake(s),this.bakeInternal(e,o,l);let i=64;1===t&&(i|=128),this.scene.ambientBake&&(i|=Jo),this.setLightmapping(o,!0,e,i),this.finishBake(o)}const h=ts();this.stats.totalRenderTime=h-i,this.stats.shadersLinked=s._shaderStats.linked-n,this.stats.compileTime=s._shaderStats.compileTime-a,this.stats.fboTime=s._renderTargetCreationTime-r,this.stats.lightmapCount=o.length}allocateTextures(e,t){for(let s=0;s<e.length;s++){const i=e[s],n=this.calculateLightmapSize(i.node);for(let e=0;e<t;e++){const t=this.createTexture(n,`lightmapper_lightmap_${s}`);Il.incRef(t),i.renderTargets[e]=new tr({colorBuffer:t,depth:!1})}if(!this.renderTargets.has(n)){const e=this.createTexture(n,`lightmapper_temp_lightmap_${n}`);Il.incRef(e),this.renderTargets.set(n,new tr({colorBuffer:e,depth:!1}))}}}prepareLightsToBake(e,t){if(this.scene.ambientBake){const e=new Rf(this);t.push(e)}const s=this.renderer.lights;for(let i=0;i<s.length;i++){const n=s[i],r=new Mf(this,n);e.push(r),n.enabled&&4&n.mask&&(n.mask=7,n.shadowUpdateMode=0===n.type?2:1,t.push(r))}t.sort()}restoreLights(e){for(let t=0;t<e.length;t++)e[t].restore()}setupScene(){this.ambientLight.copy(this.scene.ambientLight),this.scene.ambientBake||this.scene.ambientLight.set(0,0,0),this.renderer.setSceneConstants()}restoreScene(){this.scene.ambientLight.copy(this.ambientLight)}computeNodeBounds(e){const t=new Bs;if(e.length>0){t.copy(e[0].aabb);for(let s=1;s<e.length;s++)t.add(e[s].aabb)}return t}computeNodesBounds(e){for(let t=0;t<e.length;t++){const s=e[t].meshInstances;e[t].bounds=this.computeNodeBounds(s)}}computeBounds(e){const t=new Bs;for(let s=0;s<e.length;s++){t.copy(e[0].aabb);for(let s=1;s<e.length;s++)t.add(e[s].aabb)}return t}backupMaterials(e){for(let t=0;t<e.length;t++)this.materials[t]=e[t].material}restoreMaterials(e){for(let t=0;t<e.length;t++)e[t].material=this.materials[t]}lightCameraPrepare(e,t){const s=t.light;let i;if(2===s.type){i=s.getRenderData(null,0).shadowCamera,i._node.setPosition(s._node.getPosition()),i._node.setRotation(s._node.getRotation()),i._node.rotateLocal(-90,0,0),i.projection=0,i.nearClip=s.attenuationEnd/1e3,i.farClip=s.attenuationEnd,i.aspectRatio=1,i.fov=2*s._outerConeAngle,this.renderer.updateCameraFrustum(i)}return i}lightCameraPrepareAndCull(e,t,s,i){const n=e.light;let r=!0;if(0===n.type){Of.copy(i.center),Of.y+=i.halfExtents.y,this.camera.node.setPosition(Of),this.camera.node.setEulerAngles(-90,0,0),this.camera.nearClip=0,this.camera.farClip=2*i.halfExtents.y;const e=Math.max(i.halfExtents.x,i.halfExtents.z);this.camera.orthoHeight=e}else e.lightBounds.intersects(t.bounds)||(r=!1);if(2===n.type){let e=!1;const i=t.meshInstances;for(let t=0;t<i.length;t++)if(i[t]._isVisible(s)){e=!0;break}e||(r=!1)}return r}setupLightArray(e,t){e[0].length=0,e[1].length=0,e[2].length=0,e[t.type][0]=t,t.visibleThisFrame=!0}renderShadowMap(e,t,s,i){const n=i.light,r=this.scene.clusteredLightingEnabled,a=n.castShadows&&(!r||this.scene.lighting.shadowsEnabled);if(!t&&a)if(n.shadowMap||r||(n.shadowMap=this.shadowMapCache.get(this.device,n)),0===n.type){this.renderer._shadowRendererDirectional.cull(n,e,this.camera,s);const t=this.renderer._shadowRendererDirectional.getLightRenderPass(n,this.camera);null==t||t.render()}else{if(this.device.isWebGPU)return!0;this.renderer._shadowRendererLocal.cull(n,e,s);const t=!1;this.renderer.shadowRenderer.render(n,this.camera,t)}return!0}postprocessTextures(e,t,s){const i=this.lightmapFilters.shaderDilate,n=this.scene.lightmapFilterEnabled;n&&this.lightmapFilters.prepareDenoise(this.scene.lightmapFilterRange,this.scene.lightmapFilterSmoothness),e.setBlendState(Rn.NOBLEND),e.setDepthState(On.NODEPTH),e.setStencilState(null,null);for(let r=0;r<t.length;r++){const a=t[r];for(let t=0;t<s;t++){const s=a.renderTargets[t],r=s.colorBuffer,o=this.renderTargets.get(r.width),l=o.colorBuffer;this.lightmapFilters.prepare(r.width,r.height);for(let a=0;a<1;a++){this.lightmapFilters.setSourceTexture(r);Cl(e,o,n&&0===t&&0===a?this.lightmapFilters.shaderDenoise:i),this.lightmapFilters.setSourceTexture(l),Cl(e,s,i)}}}}bakeInternal(e,t,s){const i=this.scene,n=i.layers,r=this.device,a=i.clusteredLightingEnabled;this.createMaterials(r,i,e),this.setupScene(),n._update(),this.computeNodesBounds(t),this.allocateTextures(t,e),this.renderer.collectLights(n);const o=[],l=[];this.prepareLightsToBake(o,l),this.updateTransforms(s);const h=this.prepareShadowCasters(s);this.renderer.updateCpuSkinMatrices(h),this.renderer.gpuUpdate(h);const c=this.computeBounds(h);let d,u,p,f;for(d=0;d<t.length;d++){for(p=t[d].meshInstances,u=0;u<p.length;u++)f=p[u],f.setLightmapped(!1),f.mask=4,f.setRealtimeLightmap(Hl.lightmapParamNames[0],this.blackTex),f.setRealtimeLightmap(Hl.lightmapParamNames[1],this.blackTex)}for(u=0;u<l.length;u++)l[u].light.enabled=!1;const m=[[],[],[]];let g,_,v=!1;for(d=0;d<l.length;d++){const s=l[d],o=s instanceof Rf,b=0===s.light.type;let y=s.numVirtualLights;e>1&&y>1&&s.light.bakeDir&&(y=1);for(let l=0;l<y;l++){y>1&&s.prepareVirtualLight(l,y),s.startBake();let d=!1;const x=this.lightCameraPrepare(r,s);for(_=0;_<t.length;_++){const w=t[_];p=w.meshInstances;if(!this.lightCameraPrepareAndCull(s,w,x,c))continue;this.setupLightArray(m,s.light);const S=b?[]:[s.light];for(a&&this.renderer.lightTextureAtlas.update(S,this.lightingParams),d=this.renderShadowMap(n,d,h,s),a&&this.worldClusters.update(S,this.lightingParams),this.backupMaterials(p),g=0;g<e&&!(g>0&&l>0)&&!(o&&g>0);g++){const e=w.renderTargets[g],t=w.renderTargets[g].colorBuffer.width,n=this.renderTargets.get(t),h=n.colorBuffer;0===g?v=i.updateShaders:v&&(i.updateShaders=!0);let c=this.passMaterials[g];if(o){l+1===y&&0===g&&(c=this.ambientAOMaterial)}for(u=0;u<p.length;u++)p[u].material=c;if(this.renderer.updateShaders(p),1===g&&this.constantBakeDir.setValue(s.light.bakeDir?1:0),r.isWebGPU){const e=new Ff(r,this.renderer,this.camera,a?this.worldClusters:null,p,m);e.init(n),e.render(),e.destroy()}else this.renderer.setCamera(this.camera,n,!0),a&&this.worldClusters.activate(),this.renderer._forwardTime=0,this.renderer._shadowMapTime=0,this.renderer.renderForward(this.camera,n,p,m,0),r.updateEnd();for(w.renderTargets[g]=n,this.renderTargets.set(t,e),u=0;u<p.length;u++)f=p[u],f.setRealtimeLightmap(Hl.lightmapParamNames[g],h),f._shaderDefs|=64}this.restoreMaterials(p)}s.endBake(this.shadowMapCache)}}for(this.postprocessTextures(r,t,e),_=0;_<s.length;_++)s[_].restore();this.restoreLights(o),this.restoreScene(),a||this.shadowMapCache.clear()}}class zf extends Kt{constructor(e,t){super(),this.system=void 0,this.entity=void 0,this.system=e,this.entity=t,this.system.schema&&!this._accessorsBuilt&&this.buildAccessors(this.system.schema),this.on("set",(function(e,t,s){this.fire(`set_${e}`,e,t,s)})),this.on("set_enabled",this.onSetEnabled,this)}static _buildAccessors(e,t){t.forEach((t=>{const s="object"==typeof t?t.name:t;Object.defineProperty(e,s,{get:function(){return this.data[s]},set:function(e){const t=this.data,i=t[s];t[s]=e,this.fire("set",s,i,e)},configurable:!0})})),e._accessorsBuilt=!0}buildAccessors(e){zf._buildAccessors(this,e)}onSetEnabled(e,t,s){t!==s&&this.entity.enabled&&(s?this.onEnable():this.onDisable())}onEnable(){}onDisable(){}onPostStateChange(){}get data(){const e=this.system.store[this.entity.getGuid()];return e?e.data:null}set enabled(e){}get enabled(){return!0}}zf.order=0;class Nf extends Kt{constructor(e){super(),this.app=e,this.store={},this.schema=[]}addComponent(e,t={}){const s=new this.ComponentType(this,e),i=new this.DataType;return this.store[e.getGuid()]={entity:e,data:i},e[this.id]=s,e.c[this.id]=s,this.initializeComponentData(s,t,[]),this.fire("add",e,s),s}removeComponent(e){const t=this.id,s=this.store[e.getGuid()],i=e.c[t];this.fire("beforeremove",e,i),delete this.store[e.getGuid()],e[t]=void 0,delete e.c[t],this.fire("remove",e,s.data)}cloneComponent(e,t){const s=this.store[e.getGuid()];return this.addComponent(t,s.data)}initializeComponentData(e,t={},s){for(let i=0,n=s.length;i<n;i++){const n=s[i];let r,a;"object"==typeof n?(r=n.name,a=n.type):(r=n,a=void 0);let o=t[r];void 0!==o?(void 0!==a&&(o=Uf(o,a)),e[r]=o):e[r]=e.data[r]}e.enabled&&e.entity.enabled&&e.onEnable()}getPropertiesOfType(e){const t=[];return(this.schema||[]).forEach((s=>{s&&"object"==typeof s&&s.type===e&&t.push(s)})),t}destroy(){this.off()}}function Uf(e,t){if(!e)return e;switch(t){case"rgb":return e instanceof os?e.clone():new os(e[0],e[1],e[2]);case"rgba":return e instanceof os?e.clone():new os(e[0],e[1],e[2],e[3]);case"vec2":return e instanceof ws?e.clone():new ws(e[0],e[1]);case"vec3":return e instanceof ys?e.clone():new ys(e[0],e[1],e[2]);case"vec4":return e instanceof Ss?e.clone():new Ss(e[0],e[1],e[2],e[3]);case"boolean":case"number":case"string":case"entity":return e;default:throw new Error(`Could not convert unhandled type: ${t}`)}}class Vf{constructor(){this._left=1/0,this._right=-1/0,this._len=0,this._recip=0,this._p0=0,this._p1=0,this._t=0,this._hermite={valid:!1,p0:0,m0:0,p1:0,m1:0}}update(e,t){if(e<this._left||e>=this._right){const s=t.length;if(s)if(e<t[0])this._left=-1/0,this._right=t[0],this._len=0,this._recip=0,this._p0=this._p1=0;else if(e>=t[s-1])this._left=t[s-1],this._right=1/0,this._len=0,this._recip=0,this._p0=this._p1=s-1;else{const s=this._findKey(e,t);this._left=t[s],this._right=t[s+1],this._len=this._right-this._left;const i=1/this._len;this._recip=isFinite(i)?i:0,this._p0=s,this._p1=s+1}else this._left=-1/0,this._right=1/0,this._len=0,this._recip=0,this._p0=this._p1=0}this._t=0===this._recip?0:(e-this._left)*this._recip,this._hermite.valid=!1}_findKey(e,t){let s=0;for(;e>=t[s+1];)s++;return s}eval(e,t,s){const i=s._data,n=s._components,r=this._p0*n;if(0===t)for(let t=0;t<n;++t)e[t]=i[r+t];else{const s=this._t,a=this._p1*n;switch(t){case 1:for(let t=0;t<n;++t)e[t]=rs.lerp(i[r+t],i[a+t],s);break;case 2:{const t=this._hermite;if(!t.valid){const e=s*s,i=s+s,n=1-s,r=n*n;t.valid=!0,t.p0=(1+i)*r,t.m0=s*r,t.p1=e*(3-i),t.m1=e*(s-1)}const r=(3*this._p0+1)*n,a=(3*this._p0+2)*n,o=(3*this._p1+1)*n,l=(3*this._p1+0)*n;for(let s=0;s<n;++s)e[s]=t.p0*i[r+s]+t.m0*i[a+s]*this._len+t.p1*i[o+s]+t.m1*i[l+s]*this._len;break}}}}}class Gf{constructor(e){this._name=`${e.name}Snapshot`,this._time=-1,this._cache=[],this._results=[];for(let t=0;t<e._inputs.length;++t)this._cache[t]=new Vf;const t=e._curves,s=e._outputs;for(let e=0;e<t.length;++e){const i=s[t[e]._output],n=[];for(let e=0;e<i._components;++e)n[e]=0;this._results[e]=n}}}class Hf{constructor(e,t,s,i,n,r){this._name=e.name,this._track=e,this._snapshot=new Gf(e),this._playing=i,this._time=t,this._speed=s,this._loop=n,this._blendWeight=1,this._blendOrder=0,this._eventHandler=r,this.alignCursorToCurrentTime()}set name(e){this._name=e}get name(){return this._name}set track(e){this._track=e,this._snapshot=new Gf(e)}get track(){return this._track}get snapshot(){return this._snapshot}set time(e){this._time=e,this.alignCursorToCurrentTime()}get time(){return this._time}set speed(e){const t=Math.sign(e)!==Math.sign(this._speed);this._speed=e,t&&this.alignCursorToCurrentTime()}get speed(){return this._speed}set loop(e){this._loop=e}get loop(){return this._loop}set blendWeight(e){this._blendWeight=e}get blendWeight(){return this._blendWeight}set blendOrder(e){this._blendOrder=e}get blendOrder(){return this._blendOrder}set eventCursor(e){this._eventCursor=e}get eventCursor(){return this._eventCursor}get eventCursorEnd(){return this.isReverse?0:this._track.events.length-1}get nextEvent(){return this._track.events[this._eventCursor]}get isReverse(){return this._speed<0}nextEventAheadOfTime(e){return!!this.nextEvent&&(this.isReverse?this.nextEvent.time<=e:this.nextEvent.time>=e)}nextEventBehindTime(e){return!!this.nextEvent&&(e===this.track.duration?this.isReverse?this.nextEvent.time>=e:this.nextEvent.time<=e:this.isReverse?this.nextEvent.time>e:this.nextEvent.time<e)}resetEventCursor(){this._eventCursor=this.isReverse?this._track.events.length-1:0}moveEventCursor(){this._eventCursor+=this.isReverse?-1:1,this._eventCursor>=this.track.events.length?this._eventCursor=0:this._eventCursor<0&&(this._eventCursor=this.track.events.length-1)}clipFrameTime(e){const t=Hf.eventFrame;t.start=0,t.end=e,t.residual=0,this.isReverse?e<0&&(t.start=this.track.duration,t.end=0,t.residual=e+this.track.duration):e>this.track.duration&&(t.start=0,t.end=this.track.duration,t.residual=e-this.track.duration)}alignCursorToCurrentTime(){for(this.resetEventCursor();this.nextEventBehindTime(this._time)&&this._eventCursor!==this.eventCursorEnd;)this.moveEventCursor()}fireNextEvent(){this._eventHandler.fire(this.nextEvent.name,kn({track:this.track},this.nextEvent)),this.moveEventCursor()}fireNextEventInFrame(e,t){return!(!this.nextEventAheadOfTime(e)||!this.nextEventBehindTime(t))&&(this.fireNextEvent(),!0)}activeEventsForFrame(e,t){const s=Hf.eventFrame;this.clipFrameTime(t);const i=this.eventCursor;for(;this.fireNextEventInFrame(e,s.end)&&i!==this.eventCursor;);this.loop&&Math.abs(s.residual)>0&&this.activeEventsForFrame(s.start,s.residual)}progressForTime(e){return e*this._speed/this._track.duration}_update(e){if(this._playing){let t=this._time;const s=this._track.duration,i=this._speed,n=this._loop;this._track.events.length>0&&s>0&&this.activeEventsForFrame(t,t+i*e),t+=i*e,i>=0?t>s&&(n?t=t%s||0:(t=this._track.duration,this.pause())):t<0&&(n?t=s+(t%s||0):(t=0,this.pause())),this._time=t}this._time!==this._snapshot._time&&this._track.eval(this._time,this._snapshot)}play(){this._playing=!0,this._time=0}stop(){this._playing=!1,this._time=0}pause(){this._playing=!1}resume(){this._playing=!0}reset(){this._time=0}}Hf.eventFrame={start:0,end:0,residual:0};const jf="NONE",Wf="INTEGER",$f="FLOAT",qf="BOOLEAN",Xf="TRIGGER",Kf="START",Yf="END",Qf="ANY",Jf=[Kf,Yf,Qf],Zf="OVERWRITE";class em{static dot(e,t){const s=e.length;let i=0;for(let n=0;n<s;++n)i+=e[n]*t[n];return i}static normalize(e){let t=em.dot(e,e);if(t>0){t=1/Math.sqrt(t);const s=e.length;for(let i=0;i<s;++i)e[i]*=t}}static set(e,t,s){const i=e.length;if("quaternion"===s){let s=em.dot(t,t);s>0&&(s=1/Math.sqrt(s));for(let n=0;n<i;++n)e[n]=t[n]*s}else for(let s=0;s<i;++s)e[s]=t[s]}static blendVec(e,t,s,i){const n=i?1:1-s,r=e.length;for(let i=0;i<r;++i)e[i]=e[i]*n+t[i]*s}static blendQuat(e,t,s,i){const n=e.length,r=i?1:1-s;em.dot(e,t)<0&&(s=-s);for(let i=0;i<n;++i)e[i]=e[i]*r+t[i]*s;i||em.normalize(e)}static blend(e,t,s,i,n){"quaternion"===i?em.blendQuat(e,t,s,n):em.blendVec(e,t,s,n)}static stableSort(e,t){const s=e.length;for(let i=0;i<s-1;++i)for(let n=i+1;n<s;++n)if(t(e[n],e[i])){const t=e[i];e[i]=e[n],e[n]=t}}}class tm{constructor(e,t){this._component=e,this.mask=new Int8Array(e.layers.length),this.weights=new Float32Array(e.layers.length),this.totalWeight=0,this.counter=0,this.layerCounter=0,this.valueType=t,this.dirty=!0,this.value=t===tm.TYPE_QUAT?[0,0,0,1]:[0,0,0],this.baseValue=null,this.setter=null}get _normalizeWeights(){return this._component.normalizeWeights}getWeight(e){return this.dirty&&this.updateWeights(),this._normalizeWeights&&0===this.totalWeight||!this.mask[e]?0:this._normalizeWeights?this.weights[e]/this.totalWeight:rs.clamp(this.weights[e],0,1)}_layerBlendType(e){return this._component.layers[e].blendType}setMask(e,t){this.mask[e]=t,this._normalizeWeights&&(this._component.layers[e].blendType===Zf&&(this.mask=this.mask.fill(0,0,e)),this.dirty=!0)}updateWeights(){this.totalWeight=0;for(let e=0;e<this.weights.length;e++)this.weights[e]=this._component.layers[e].weight,this.totalWeight+=this.mask[e]*this.weights[e];this.dirty=!1}updateValue(e,t){if(0===this.counter&&(em.set(this.value,tm.IDENTITY_QUAT_ARR,this.valueType),this._normalizeWeights||em.blend(this.value,this.baseValue,1,this.valueType)),this.mask[e]&&0!==this.getWeight(e)){if("ADDITIVE"!==this._layerBlendType(e)||this._normalizeWeights)em.blend(this.value,t,this.getWeight(e),this.valueType);else if(this.valueType===tm.TYPE_QUAT){const s=tm.q1.set(this.value[0],this.value[1],this.value[2],this.value[3]),i=tm.q2.set(this.baseValue[0],this.baseValue[1],this.baseValue[2],this.baseValue[3]),n=tm.q3.set(t[0],t[1],t[2],t[3]),r=i.invert().mul(n);r.slerp(Ds.IDENTITY,r,this.getWeight(e)),s.mul(r),tm.quatArr[0]=s.x,tm.quatArr[1]=s.y,tm.quatArr[2]=s.z,tm.quatArr[3]=s.w,em.set(this.value,tm.quatArr,this.valueType)}else tm.vecArr[0]=t[0]-this.baseValue[0],tm.vecArr[1]=t[1]-this.baseValue[1],tm.vecArr[2]=t[2]-this.baseValue[2],em.blend(this.value,tm.vecArr,this.getWeight(e),this.valueType,!0);this.setter&&this.setter(this.value)}}unbind(){this.setter&&this.setter(this.baseValue)}}tm.TYPE_QUAT="quaternion",tm.TYPE_VEC3="vector3",tm.q1=new Ds,tm.q2=new Ds,tm.q3=new Ds,tm.quatArr=[0,0,0,1],tm.vecArr=[0,0,0],tm.IDENTITY_QUAT_ARR=[0,0,0,1];class sm{constructor(e){this._binder=e,this._clips=[],this._inputs=[],this._outputs=[],this._targets={}}get clips(){return this._clips}addClip(e){const t=this._targets,s=this._binder,i=e.track.curves,n=e.snapshot,r=[],a=[];for(let e=0;e<i.length;++e){const o=i[e].paths;for(let i=0;i<o.length;++i){const l=o[i],h=s.resolve(l);let c=t[h&&h.targetPath||null];if(!c&&h){c={target:h,value:[],curves:0,blendCounter:0};for(let e=0;e<c.target.components;++e)c.value.push(0);if(t[h.targetPath]=c,s.animComponent){if(!s.animComponent.targets[h.targetPath]){let e;e="localRotation"===h.targetPath.substring(h.targetPath.length-13)?tm.TYPE_QUAT:tm.TYPE_VEC3,s.animComponent.targets[h.targetPath]=new tm(s.animComponent,e)}s.animComponent.targets[h.targetPath].layerCounter++,s.animComponent.targets[h.targetPath].setMask(s.layerIndex,1)}}c&&(c.curves++,r.push(n._results[e]),a.push(c))}}this._clips.push(e),this._inputs.push(r),this._outputs.push(a)}removeClip(e){const t=this._targets,s=this._binder,i=this._clips,n=i[e].track.curves;for(let e=0;e<n.length;++e){const i=n[e].paths;for(let e=0;e<i.length;++e){const n=i[e],r=this._binder.resolve(n);r&&(r.curves--,0===r.curves&&(s.unresolve(n),delete t[r.targetPath],s.animComponent&&s.animComponent.targets[r.targetPath].layerCounter--))}}i.splice(e,1),this._inputs.splice(e,1),this._outputs.splice(e,1)}removeClips(){for(;this._clips.length>0;)this.removeClip(0)}updateClipTrack(e,t){this._clips.forEach((s=>{s.name.includes(e)&&(s.track=t)})),this.rebind()}findClip(e){const t=this._clips;for(let s=0;s<t.length;++s){const i=t[s];if(i.name===e)return i}return null}rebind(){this._binder.rebind(),this._targets={};const e=[...this.clips];this.removeClips(),e.forEach((e=>{this.addClip(e)}))}assignMask(e){return this._binder.assignMask(e)}update(e,t=!0){const s=this._clips,i=s.map(((e,t)=>t));em.stableSort(i,((e,t)=>s[e].blendOrder<s[t].blendOrder));for(let n=0;n<i.length;++n){const r=i[n],a=s[r],o=this._inputs[r],l=this._outputs[r],h=a.blendWeight;if(h>0&&a._update(e),!t)break;let c,d,u;if(h>=1)for(let e=0;e<o.length;++e)c=o[e],d=l[e],u=d.value,em.set(u,c,d.target.type),d.blendCounter++;else if(h>0)for(let e=0;e<o.length;++e)c=o[e],d=l[e],u=d.value,0===d.blendCounter?em.set(u,c,d.target.type):em.blend(u,c,h,d.target.type),d.blendCounter++}const n=this._targets,r=this._binder;for(const e in n)if(n.hasOwnProperty(e)){const t=n[e];if(r.animComponent&&t.target.isTransform){const s=r.animComponent.targets[e];s.counter===s.layerCounter&&(s.counter=0),s.path||(s.path=e,s.baseValue=t.target.get(),s.setter=t.target.set),s.updateValue(r.layerIndex,t.value),s.counter++}else t.target.set(t.value);t.blendCounter=0}this._binder.update(e)}}class im{constructor(e){this._events=[...e],this._events.sort(((e,t)=>e.time-t.time))}get events(){return this._events}}var nm;class rm{constructor(e,t,s,i,n,r=new im([])){this._name=e,this._duration=t,this._inputs=s,this._outputs=i,this._curves=n,this._animEvents=r}get name(){return this._name}get duration(){return this._duration}get inputs(){return this._inputs}get outputs(){return this._outputs}get curves(){return this._curves}set events(e){this._animEvents=e}get events(){return this._animEvents.events}eval(e,t){t._time=e;const s=this._inputs,i=this._outputs,n=this._curves,r=t._cache,a=t._results;for(let t=0;t<s.length;++t)r[t].update(e,s[t]._data);for(let e=0;e<n.length;++e){const t=n[e],s=i[t._output],o=a[e];r[t._input].eval(o,t._interpolation,s)}}}nm=rm,rm.EMPTY=Object.freeze(new nm("empty",Number.MAX_VALUE,[],[],[]));class am{static joinPath(e,t){t=t||".";return e.map((function(e){return e.replace(/\\/g,"\\\\").replace(new RegExp(`\\${t}`,"g"),`\\${t}`)})).join(t)}static splitPath(e,t){t=t||".";const s=[];let i="",n=0;for(;n<e.length;){let r=e[n++];"\\"===r&&n<e.length?(r=e[n++],i+="\\"===r||r===t?r:`\\${r}`):r===t?(s.push(i),i=""):i+=r}return i.length>0&&s.push(i),s}static encode(e,t,s){return`${Array.isArray(e)?e.join("/"):e}/${t}/${Array.isArray(s)?s.join("/"):s}`}resolve(e){return null}unresolve(e){}update(e){}}class om{constructor(e,t,s,i){e.set?(this._set=e.set,this._get=e.get):this._set=e,this._type=t,this._components=s,this._targetPath=i,this._isTransform="localRotation"===this._targetPath.substring(this._targetPath.length-13)||"localPosition"===this._targetPath.substring(this._targetPath.length-13)||"localScale"===this._targetPath.substring(this._targetPath.length-10)}get set(){return this._set}get get(){return this._get}get type(){return this._type}get components(){return this._components}get targetPath(){return this._targetPath}get isTransform(){return this._isTransform}}class lm{constructor(e){if(this._isPathInMask=(e,t)=>{const s=this._mask[e];return!!s&&!!(s.children||t&&!1!==s.value)},this.graph=e,!e)return;this._mask=null;const t={};!function e(s){t[s.name]=s;for(let t=0;t<s.children.length;++t)e(s.children[t])}(e),this.nodes=t,this.targetCache={};const s=function(e){let t,s=e;for(;s&&!(s instanceof vf);)s=s.parent;return s&&(s.render?t=s.render.meshInstances:s.model&&(t=s.model.meshInstances)),t};this.nodeCounts={},this.activeNodes=[],this.handlers={localPosition:function(e){const t=e.localPosition;return lm.createAnimTarget((function(e){t.set(...e)}),"vector",3,e,"localPosition")},localRotation:function(e){const t=e.localRotation;return lm.createAnimTarget((function(e){t.set(...e)}),"quaternion",4,e,"localRotation")},localScale:function(e){const t=e.localScale;return lm.createAnimTarget((function(e){t.set(...e)}),"vector",3,e,"localScale")},weight:function(e,t){t=0===t.indexOf("name.")?t.replace("name.",""):Number(t);const i=s(e);let n;if(i)for(let s=0;s<i.length;++s)if(i[s].node.name===e.name&&i[s].morphInstance){const e=i[s].morphInstance,r=s=>{e.setWeight(t,s[0])};n||(n=[]),n.push(r)}if(n){const s=e=>{for(let t=0;t<n.length;++t)n[t](e)};return lm.createAnimTarget(s,"number",1,e,`weight.${t}`)}return null},materialTexture:(e,t)=>{const i=s(e);if(i){let s;for(let t=0;t<i.length;++t)if(i[t].node.name===e.name){s=i[t];break}if(s){const i=e=>{const i=this.animComponent.system.app.assets.get(e[0]);i&&i.resource&&"texture"===i.type&&(s.material[t]=i.resource,s.material.update())};return lm.createAnimTarget(i,"vector",1,e,"materialTexture","material")}}return null}}}_isPathActive(e){if(!this._mask)return!0;const t=[e.entityPath[0],this.graph.name];for(let s=0;s<t.length;++s){let i=t[s];if(this._isPathInMask(i,1===e.entityPath.length))return!0;for(let t=1;t<e.entityPath.length;t++)if(i+=`/${e.entityPath[t]}`,this._isPathInMask(i,t===e.entityPath.length-1))return!0}return!1}findNode(e){if(!this._isPathActive(e))return null;let t;return this.graph&&(t=this.graph.findByPath(e.entityPath),t||(t=this.graph.findByPath(e.entityPath.slice(1)))),t||(t=this.nodes[e.entityPath[e.entityPath.length-1]||""]),t}static createAnimTarget(e,t,s,i,n,r){const a=am.encode(i.path,r||"entity",n);return new om(e,t,s,a)}resolve(e){const t=am.encode(e.entityPath,e.component,e.propertyPath);let s=this.targetCache[t];if(s)return s;const i=this.findNode(e);if(!i)return null;const n=this.handlers[e.propertyPath];return n?(s=n(i),s?(this.targetCache[t]=s,this.nodeCounts[i.path]?this.nodeCounts[i.path]++:(this.activeNodes.push(i),this.nodeCounts[i.path]=1),s):null):null}unresolve(e){if("graph"!==e.component)return;const t=this.nodes[e.entityPath[e.entityPath.length-1]||""];if(this.nodeCounts[t.path]--,0===this.nodeCounts[t.path]){const e=this.activeNodes,s=e.indexOf(t.node),i=e.length;s<i-1&&(e[s]=e[i-1]),e.pop()}}update(e){const t=this.activeNodes;for(let e=0;e<t.length;++e)t[e]._dirtifyLocal()}assignMask(e){return e!==this._mask&&(this._mask=e,!0)}}class hm{constructor(e,t,s,i,n=1){this._state=e,this._parent=t,this._name=s,Array.isArray(i)?(this._point=new ws(i[0],i[1]),this._pointLength=this._point.length()):(this._point=i,this._pointLength=i),this._speed=n,this._weightedSpeed=1,this._weight=1,this._animTrack=null}get parent(){return this._parent}get name(){return this._name}get path(){return this._parent?`${this._parent.path}.${this._name}`:this._name}get point(){return this._point}get pointLength(){return this._pointLength}set weight(e){this._weight=e}get weight(){return this._parent?this._parent.weight*this._weight:this._weight}get normalizedWeight(){const e=this._state.totalWeight;return 0===e?0:this.weight/e}get speed(){return this._weightedSpeed*this._speed}get absoluteSpeed(){return Math.abs(this._speed)}set weightedSpeed(e){this._weightedSpeed=e}get weightedSpeed(){return this._weightedSpeed}set animTrack(e){this._animTrack=e}get animTrack(){return this._animTrack}}class cm extends hm{constructor(e,t,s,i,n,r,a,o,l){super(e,t,s,i),this._parameters=n,this._parameterValues=new Array(n.length),this._children=[],this._findParameter=l,this._syncAnimations=!1!==a,this._pointCache={};for(let t=0;t<r.length;t++){const s=r[t];s.children?this._children.push(o(s.type,e,this,s.name,1,s.parameter?[s.parameter]:s.parameters,s.children,s.syncAnimations,o,l)):this._children.push(new hm(e,this,s.name,s.point,s.speed))}}get weight(){return this.calculateWeights(),this._parent?this._parent.weight*this._weight:this._weight}get syncAnimations(){return this._syncAnimations}getChild(e){for(let t=0;t<this._children.length;t++)if(this._children[t].name===e)return this._children[t];return null}updateParameterValues(){let e=!0;for(let t=0;t<this._parameterValues.length;t++){const s=this._findParameter(this._parameters[t]).value;this._parameterValues[t]!==s&&(this._parameterValues[t]=s,e=!1)}return e}getNodeWeightedDuration(e){return this._children[e].animTrack.duration/this._children[e].speedMultiplier*this._children[e].weight}getNodeCount(){let e=0;for(let t=0;t<this._children.length;t++){this._children[t].constructor===cm?e+=this._children[t].getNodeCount():e++}return e}}class dm extends cm{constructor(e,t,s,i,n,r,a,o,l){r.sort(((e,t)=>e.point-t.point)),super(e,t,s,i,n,r,a,o,l)}calculateWeights(){if(this.updateParameterValues())return;let e=0;this._children[0].weight=0;for(let t=0;t<this._children.length;t++){const s=this._children[t];if(t!==this._children.length-1){const e=this._children[t+1];if(s.point===e.point)s.weight=.5,e.weight=.5;else if(rs.between(this._parameterValues[0],s.point,e.point,!0)){const t=Math.abs(s.point-e.point),i=(t-Math.abs(s.point-this._parameterValues[0]))/t;s.weight=i,e.weight=1-i}else e.weight=0}this._syncAnimations&&(e+=s.animTrack.duration/s.absoluteSpeed*s.weight)}if(this._syncAnimations)for(let t=0;t<this._children.length;t++){const s=this._children[t];s.weightedSpeed=s.animTrack.duration/s.absoluteSpeed/e}}}class um extends cm{pointDistanceCache(e,t){const s=`${e}${t}`;return this._pointCache[s]||(this._pointCache[s]=this._children[t].point.clone().sub(this._children[e].point)),this._pointCache[s]}calculateWeights(){if(this.updateParameterValues())return;let e,t;um._p.set(...this._parameterValues),e=0,t=0;for(let s=0;s<this._children.length;s++){const i=this._children[s],n=i.point;um._pip.set(um._p.x,um._p.y).sub(n);let r=Number.MAX_VALUE;for(let e=0;e<this._children.length;e++){if(s===e)continue;const t=this.pointDistanceCache(s,e),i=rs.clamp(1-um._pip.dot(t)/t.lengthSq(),0,1);i<r&&(r=i)}i.weight=r,e+=r,this._syncAnimations&&(t+=i.animTrack.duration/i.absoluteSpeed*i.weight)}for(let s=0;s<this._children.length;s++){const i=this._children[s];i.weight=i._weight/e,this._syncAnimations&&(i.weightedSpeed=i.animTrack.duration/i.absoluteSpeed/t)}}}um._p=new ws,um._pip=new ws;class pm extends cm{pointCache(e,t){const s=`${e}${t}`;return this._pointCache[s]||(this._pointCache[s]=new ws((this._children[t].pointLength-this._children[e].pointLength)/((this._children[t].pointLength+this._children[e].pointLength)/2),2*ws.angleRad(this._children[e].point,this._children[t].point))),this._pointCache[s]}calculateWeights(){if(this.updateParameterValues())return;let e,t;pm._p.set(...this._parameterValues);const s=pm._p.length();e=0,t=0;for(let i=0;i<this._children.length;i++){const n=this._children[i],r=n.point,a=n.pointLength;let o=Number.MAX_VALUE;for(let e=0;e<this._children.length;e++){if(i===e)continue;const t=this.pointCache(i,e),n=this._children[e].pointLength;pm._pip.set((s-a)/((n+a)/2),2*ws.angleRad(r,pm._p));const l=rs.clamp(1-Math.abs(pm._pip.dot(t)/t.lengthSq()),0,1);l<o&&(o=l)}n.weight=o,e+=o,this._syncAnimations&&(t+=n.animTrack.duration/n.absoluteSpeed*n.weight)}for(let s=0;s<this._children.length;s++){const i=this._children[s];if(i.weight=i._weight/e,this._syncAnimations){const s=i.animTrack.duration/t*e;i.weightedSpeed=i.absoluteSpeed*s}}}}pm._p=new ws,pm._pip=new ws;class fm extends cm{calculateWeights(){if(this.updateParameterValues())return;let e=0,t=0;for(let s=0;s<this._children.length;s++)if(e+=Math.max(this._parameterValues[s],0),this._syncAnimations){const e=this._children[s];t+=e.animTrack.duration/e.absoluteSpeed*e.weight}for(let s=0;s<this._children.length;s++){const i=this._children[s],n=Math.max(this._parameterValues[s],0);e?(i.weight=n/e,this._syncAnimations&&(i.weightedSpeed=i.animTrack.duration/i.absoluteSpeed/t)):(i.weight=0,this._syncAnimations&&(i.weightedSpeed=0))}}}class mm{constructor(e,t,s=1,i=!0,n){this._animations={},this._animationList=[],this._controller=e,this._name=t,this._speed=s,this._loop=i,this._hasAnimations=!1,this._blendTree=n?this._createTree(n.type,this,null,t,1,n.parameter?[n.parameter]:n.parameters,n.children,n.syncAnimations,this._createTree,this._controller.findParameter):new hm(this,null,t,1,s)}_createTree(e,t,s,i,n,r,a,o,l,h){switch(e){case"1D":return new dm(t,s,i,n,r,a,o,l,h);case"2D_CARTESIAN":return new um(t,s,i,n,r,a,o,l,h);case"2D_DIRECTIONAL":return new pm(t,s,i,n,r,a,o,l,h);case"DIRECT":return new fm(t,s,i,n,r,a,o,l,h)}}_getNodeFromPath(e){let t=this._blendTree;for(let s=1;s<e.length;s++)t=t.getChild(e[s]);return t}addAnimation(e,t){const s=e.join("."),i=this._animationList.findIndex((e=>e.path===s));if(i>=0)this._animationList[i].animTrack=t;else{const s=this._getNodeFromPath(e);s.animTrack=t,this._animationList.push(s)}this._updateHasAnimations()}_updateHasAnimations(){this._hasAnimations=this._animationList.length>0&&this._animationList.every((e=>e.animTrack&&e.animTrack!==rm.EMPTY))}get name(){return this._name}set animations(e){this._animationList=e,this._updateHasAnimations()}get animations(){return this._animationList}get hasAnimations(){return this._hasAnimations}set speed(e){this._speed=e}get speed(){return this._speed}set loop(e){this._loop=e}get loop(){return this._loop}get nodeCount(){return this._blendTree&&this._blendTree.constructor!==hm?this._blendTree.getNodeCount():1}get playable(){return-1!==Jf.indexOf(this.name)||this.animations.length===this.nodeCount}get looping(){if(this.animations.length>0){const e=`${this.name}.${this.animations[0].animTrack.name}`,t=this._controller.animEvaluator.findClip(e);if(t)return t.loop}return!1}get totalWeight(){let e=0;for(let t=0;t<this.animations.length;t++)e+=this.animations[t].weight;return e}get timelineDuration(){let e=0;for(let t=0;t<this.animations.length;t++){const s=this.animations[t];s.animTrack.duration>e&&(e=s.animTrack.duration)}return e}}class gm{constructor({from:e,to:t,time:s=0,priority:i=0,conditions:n=[],exitTime:r=null,transitionOffset:a=null,interruptionSource:o=jf}){this._from=e,this._to=t,this._time=s,this._priority=i,this._conditions=n,this._exitTime=r,this._transitionOffset=a,this._interruptionSource=o}get from(){return this._from}set to(e){this._to=e}get to(){return this._to}get time(){return this._time}get priority(){return this._priority}get conditions(){return this._conditions}get exitTime(){return this._exitTime}get transitionOffset(){return this._transitionOffset}get interruptionSource(){return this._interruptionSource}get hasExitTime(){return!!this.exitTime}}class _m{constructor(e,t,s,i,n,r,a){this._states={},this._stateNames=[],this._findTransitionsFromStateCache={},this._findTransitionsBetweenStatesCache={},this._previousStateName=null,this._activeStateName=Kf,this._activeStateDuration=0,this._activeStateDurationDirty=!0,this._playing=!1,this._activate=void 0,this._transitions=void 0,this._currTransitionTime=1,this._totalTransitionTime=1,this._isTransitioning=!1,this._transitionInterruptionSource=jf,this._transitionPreviousStates=[],this._timeInState=0,this._timeInStateBefore=0,this.findParameter=e=>this._findParameter(e),this._animEvaluator=e,this._eventHandler=n,this._findParameter=r,this._consumeTrigger=a;for(let e=0;e<t.length;e++)this._states[t[e].name]=new mm(this,t[e].name,t[e].speed,t[e].loop,t[e].blendTree),this._stateNames.push(t[e].name);this._transitions=s.map((e=>new gm(kn({},e)))),this._activate=i}get animEvaluator(){return this._animEvaluator}set activeState(e){this._activeStateName=e}get activeState(){return this._findState(this._activeStateName)}get activeStateName(){return this._activeStateName}get activeStateAnimations(){return this.activeState.animations}set previousState(e){this._previousStateName=e}get previousState(){return this._findState(this._previousStateName)}get previousStateName(){return this._previousStateName}get playable(){let e=!0;for(let t=0;t<this._stateNames.length;t++)this._states[this._stateNames[t]].playable||(e=!1);return e}set playing(e){this._playing=e}get playing(){return this._playing}get activeStateProgress(){return this._getActiveStateProgressForTime(this._timeInState)}get activeStateDuration(){if(this._activeStateDurationDirty){let e=0;for(let t=0;t<this.activeStateAnimations.length;t++){const s=this._animEvaluator.findClip(this.activeStateAnimations[t].name);s&&(e=Math.max(e,s.track.duration))}this._activeStateDuration=e,this._activeStateDurationDirty=!1}return this._activeStateDuration}set activeStateCurrentTime(e){this._timeInStateBefore=e,this._timeInState=e;for(let t=0;t<this.activeStateAnimations.length;t++){const s=this.animEvaluator.findClip(this.activeStateAnimations[t].name);s&&(s.time=e)}}get activeStateCurrentTime(){return this._timeInState}get transitioning(){return this._isTransitioning}get transitionProgress(){return this._currTransitionTime/this._totalTransitionTime}get states(){return this._stateNames}assignMask(e){return this._animEvaluator.assignMask(e)}_findState(e){return this._states[e]}_getActiveStateProgressForTime(e){if(this.activeStateName===Kf||this.activeStateName===Yf||this.activeStateName===Qf)return 1;const t=this._animEvaluator.findClip(this.activeStateAnimations[0].name);return t?t.progressForTime(e):null}_findTransitionsFromState(e){let t=this._findTransitionsFromStateCache[e];return t||(t=this._transitions.filter((t=>t.from===e)),fd(t),this._findTransitionsFromStateCache[e]=t),t}_findTransitionsBetweenStates(e,t){let s=this._findTransitionsBetweenStatesCache[`${e}->${t}`];return s||(s=this._transitions.filter((s=>s.from===e&&s.to===t)),fd(s),this._findTransitionsBetweenStatesCache[`${e}->${t}`]=s),s}_transitionHasConditionsMet(e){const t=e.conditions;for(let e=0;e<t.length;e++){const s=t[e],i=this._findParameter(s.parameterName);switch(s.predicate){case"GREATER_THAN":if(!(i.value>s.value))return!1;break;case"LESS_THAN":if(!(i.value<s.value))return!1;break;case"GREATER_THAN_EQUAL_TO":if(!(i.value>=s.value))return!1;break;case"LESS_THAN_EQUAL_TO":if(!(i.value<=s.value))return!1;break;case"EQUAL_TO":if(i.value!==s.value)return!1;break;case"NOT_EQUAL_TO":if(i.value===s.value)return!1}}return!0}_findTransition(e,t){let s=[];if(e&&t)s=s.concat(this._findTransitionsBetweenStates(e,t));else if(this._isTransitioning)switch(this._transitionInterruptionSource){case"PREV_STATE":s=s.concat(this._findTransitionsFromState(this._previousStateName)),s=s.concat(this._findTransitionsFromState(Qf));break;case"NEXT_STATE":s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState(Qf));break;case"PREV_STATE_NEXT_STATE":s=s.concat(this._findTransitionsFromState(this._previousStateName)),s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState(Qf));break;case"NEXT_STATE_PREV_STATE":s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState(this._previousStateName)),s=s.concat(this._findTransitionsFromState(Qf))}else s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState(Qf));if(s=s.filter((e=>{if(e.to===this.activeStateName)return!1;if(e.hasExitTime){let t=this._getActiveStateProgressForTime(this._timeInStateBefore),s=this._getActiveStateProgressForTime(this._timeInState);if(e.exitTime<1&&this.activeState.loop&&(t-=Math.floor(t),s-=Math.floor(s)),s===t){if(s!==e.exitTime)return null}else if(!(e.exitTime>t&&e.exitTime<=s))return null}return this._transitionHasConditionsMet(e)})),s.length>0){const e=s[0];if(e.to===Yf){const t=this._findTransitionsFromState(Kf)[0];e.to=t.to}return e}return null}updateStateFromTransition(e){let t,s,i;this.previousState=e.from?this.activeStateName:null,this.activeState=e.to,this._activeStateDurationDirty=!0;for(let t=0;t<e.conditions.length;t++){const s=e.conditions[t];this._findParameter(s.parameterName).type===Xf&&this._consumeTrigger(s.parameterName)}if(this.previousState){this._isTransitioning||(this._transitionPreviousStates=[]),this._transitionPreviousStates.push({name:this._previousStateName,weight:1});const e=Math.min(0!==this._totalTransitionTime?this._currTransitionTime/this._totalTransitionTime:1,1);for(let n=0;n<this._transitionPreviousStates.length;n++){this._isTransitioning?n!==this._transitionPreviousStates.length-1?this._transitionPreviousStates[n].weight*=1-e:this._transitionPreviousStates[n].weight=e:this._transitionPreviousStates[n].weight=1,t=this._findState(this._transitionPreviousStates[n].name);for(let e=0;e<t.animations.length;e++)s=t.animations[e],i=this._animEvaluator.findClip(`${s.name}.previous.${n}`),i||(i=this._animEvaluator.findClip(s.name),i.name=`${s.name}.previous.${n}`),n!==this._transitionPreviousStates.length-1&&i.pause()}}this._isTransitioning=!0,this._totalTransitionTime=e.time,this._currTransitionTime=0,this._transitionInterruptionSource=e.interruptionSource;const n=this.activeState,r=e.transitionOffset&&e.transitionOffset>0&&e.transitionOffset<1;let a=0,o=0;if(r){const t=n.timelineDuration*e.transitionOffset;a=t,o=t}this._timeInState=a,this._timeInStateBefore=o;for(let t=0;t<n.animations.length;t++){if(i=this._animEvaluator.findClip(n.animations[t].name),i)i.reset();else{const e=Number.isFinite(n.animations[t].speed)?n.animations[t].speed:n.speed;i=new Hf(n.animations[t].animTrack,this._timeInState,e,!0,n.loop,this._eventHandler),i.name=n.animations[t].name,this._animEvaluator.addClip(i)}if(e.time>0?i.blendWeight=0:i.blendWeight=n.animations[t].normalizedWeight,i.play(),r)i.time=n.timelineDuration*e.transitionOffset;else{const e=n.speed>=0?0:this.activeStateDuration;i.time=e}}}_transitionToState(e){if(!this._findState(e))return;let t=this._findTransition(this._activeStateName,e);t||(this._animEvaluator.removeClips(),t=new gm({from:null,to:e})),this.updateStateFromTransition(t)}assignAnimation(e,t,s,i){const n=e.split(".");let r=this._findState(n[0]);r||(r=new mm(this,n[0],s),this._states[n[0]]=r,this._stateNames.push(n[0])),r.addAnimation(n,t),this._animEvaluator.updateClipTrack(r.name,t),void 0!==s&&(r.speed=s),void 0!==i&&(r.loop=i),!this._playing&&this._activate&&this.playable&&this.play(),this._activeStateDurationDirty=!0}removeNodeAnimations(e){if(-1!==Jf.indexOf(e))return!1;const t=this._findState(e);return!!t&&(t.animations=[],!0)}play(e){e&&this._transitionToState(e),this._playing=!0}pause(){this._playing=!1}reset(){this._previousStateName=null,this._activeStateName=Kf,this._playing=!1,this._currTransitionTime=1,this._totalTransitionTime=1,this._isTransitioning=!1,this._timeInState=0,this._timeInStateBefore=0,this._animEvaluator.removeClips()}rebind(){this._animEvaluator.rebind()}update(e){if(!this._playing)return;let t,s,i;(this.activeState.loop||this._timeInState<this.activeStateDuration)&&(this._timeInStateBefore=this._timeInState,this._timeInState+=e*this.activeState.speed,!this.activeState.loop&&this._timeInState>this.activeStateDuration&&(this._timeInState=this.activeStateDuration,e=this.activeStateDuration-this._timeInStateBefore));const n=this._findTransition(this._activeStateName);if(n&&this.updateStateFromTransition(n),this._isTransitioning)if(this._currTransitionTime+=e,this._currTransitionTime<=this._totalTransitionTime){const e=0!==this._totalTransitionTime?this._currTransitionTime/this._totalTransitionTime:1;for(let n=0;n<this._transitionPreviousStates.length;n++){t=this._findState(this._transitionPreviousStates[n].name);const r=this._transitionPreviousStates[n].weight;for(let a=0;a<t.animations.length;a++)s=t.animations[a],i=this._animEvaluator.findClip(`${s.name}.previous.${n}`),i&&(i.blendWeight=(1-e)*s.normalizedWeight*r)}t=this.activeState;for(let i=0;i<t.animations.length;i++)s=t.animations[i],this._animEvaluator.findClip(s.name).blendWeight=e*s.normalizedWeight}else{this._isTransitioning=!1;const e=this.activeStateAnimations.length,n=this._animEvaluator.clips.length;for(let t=0;t<n-e;t++)this._animEvaluator.removeClip(0);this._transitionPreviousStates=[],t=this.activeState;for(let e=0;e<t.animations.length;e++)s=t.animations[e],i=this._animEvaluator.findClip(s.name),i&&(i.blendWeight=s.normalizedWeight)}else if(this.activeState._blendTree.constructor!==hm){t=this.activeState;for(let e=0;e<t.animations.length;e++)s=t.animations[e],i=this._animEvaluator.findClip(s.name),i&&(i.blendWeight=s.normalizedWeight,s.parent.syncAnimations&&(i.speed=s.speed))}this._animEvaluator.update(e,this.activeState.hasAnimations)}}const vm=new ws,bm=new ys,ym=new Ss,xm=new os,wm=new Ds;class Sm extends lm{constructor(e,t,s,i,n){super(t),this.animComponent=e,this._mask=i,this.layerName=s,this.layerIndex=n}static _packFloat(e){return e[0]}static _packBoolean(e){return!!e[0]}static _packVec2(e){return vm.x=e[0],vm.y=e[1],vm}static _packVec3(e){return bm.x=e[0],bm.y=e[1],bm.z=e[2],bm}static _packVec4(e){return ym.x=e[0],ym.y=e[1],ym.z=e[2],ym.w=e[3],ym}static _packColor(e){return xm.r=e[0],xm.g=e[1],xm.b=e[2],xm.a=e[3],xm}static _packQuat(e){return wm.x=e[0],wm.y=e[1],wm.z=e[2],wm.w=e[3],wm}resolve(e){const t=am.encode(e.entityPath,e.component,e.propertyPath);let s,i,n,r=this.targetCache[t];if(r)return r;switch(e.component){case"entity":s=this._getEntityFromHierarchy(e.entityPath),n=am.encode(s.path,"entity",e.propertyPath),i=s;break;case"graph":if(i=this.findNode(e),!i)return null;n=am.encode(i.path,"graph",e.propertyPath);break;default:if(s=this._getEntityFromHierarchy(e.entityPath),i=s.findComponent(e.component),!i)return null;n=am.encode(s.path,e.component,e.propertyPath)}return r=this._createAnimTargetForProperty(i,e.propertyPath,n),this.targetCache[t]=r,r}update(e){const t=this.activeNodes;if(t)for(let e=0;e<t.length;e++)t[e]._dirtifyLocal()}_getEntityFromHierarchy(e){if(!this.animComponent.entity.name===e[0])return null;const t=this.animComponent.entity;return 1===e.length?t:t._parent.findByPath(e)}_resolvePath(e,t,s){const i=t.length-(s?0:1);for(let s=0;s<i;s++)e=e[t[s]];return e}_setter(e,t,s){const i=this._resolvePath(e,t),n=t[t.length-1],r=`set${n.substring(0,1).toUpperCase()}${n.substring(1)}`;if(i[r]){let e=i[`get${n.substring(0,1).toUpperCase()}${n.substring(1)}`].bind(i)();e=[e.x,e.y,e.z,e.w];const t=i[r].bind(i);return{set:e=>{t(s(e))},get:()=>e}}const a=i[n];if("object"==typeof a&&a.hasOwnProperty("copy"))return function(e){a.copy(s(e))};if(-1!==[ws,ys,Ss,os,Ds].indexOf(i.constructor)&&t.length>1){const r=t.length>2?this._resolvePath(e,t.slice(0,-1)):e,a=t[t.length-2];return function(e){i[n]=s(e),r[a]=i}}return function(e){i[n]=s(e)}}_createAnimTargetForProperty(e,t,s){if(this.handlers&&t[0].startsWith("weight."))return this.handlers.weight(e,t[0].replace("weight.",""));if(this.handlers&&"material"===t[0]&&2===t.length){const s=t[1];if(s.endsWith("Map"))return this.handlers.materialTexture(e,s)}const i=this._resolvePath(e,t,!0);if(void 0===i)return null;let n,r,a;if("number"==typeof i)n=this._setter(e,t,Sm._packFloat),r="vector",a=1;else if("boolean"==typeof i)n=this._setter(e,t,Sm._packBoolean),r="vector",a=1;else if("object"==typeof i)switch(i.constructor){case ws:n=this._setter(e,t,Sm._packVec2),r="vector",a=2;break;case ys:n=this._setter(e,t,Sm._packVec3),r="vector",a=3;break;case Ss:n=this._setter(e,t,Sm._packVec4),r="vector",a=4;break;case os:n=this._setter(e,t,Sm._packColor),r="vector",a=4;break;case Ds:n=this._setter(e,t,Sm._packQuat),r="quaternion",a=4;break;default:return null}return-1!==t.indexOf("material")?new om((t=>{n(t),e.material.update()}),r,a,s):new om(n,r,a,s)}rebind(){this.targetCache={},this.animComponent.rootBone?this.graph=this.animComponent.rootBone:this.graph=this.animComponent.entity;const e={};!function t(s){e[s.name]=s;for(let e=0;e<s.children.length;++e)t(s.children[e])}(this.graph),this.nodes=e}}class Cm{constructor(e,t,s,i=1,n=Zf){this._name=void 0,this._controller=void 0,this._component=void 0,this._weight=void 0,this._blendType=void 0,this._mask=null,this._blendTime=0,this._blendTimeElapsed=0,this._startingWeight=0,this._targetWeight=0,this._name=e,this._controller=t,this._component=s,this._weight=i,this._blendType=n}get name(){return this._name}set playing(e){this._controller.playing=e}get playing(){return this._controller.playing}get playable(){return this._controller.playable}get activeState(){return this._controller.activeStateName}get previousState(){return this._controller.previousStateName}get activeStateProgress(){return this._controller.activeStateProgress}get activeStateDuration(){return this._controller.activeStateDuration}set activeStateCurrentTime(e){const t=this._controller,s=t.playing;t.playing=!0,t.activeStateCurrentTime=e,s||t.update(0),t.playing=s}get activeStateCurrentTime(){return this._controller.activeStateCurrentTime}get transitioning(){return this._controller.transitioning}get transitionProgress(){return this.transitioning?this._controller.transitionProgress:null}get states(){return this._controller.states}set weight(e){this._weight=e,this._component.dirtifyTargets()}get weight(){return this._weight}set blendType(e){e!==this._blendType&&(this._blendType=e,this._controller.normalizeWeights&&this._component.rebind())}get blendType(){return this._blendType}set mask(e){this._controller.assignMask(e)&&this._component.rebind(),this._mask=e}get mask(){return this._mask}play(e){this._controller.play(e)}pause(){this._controller.pause()}reset(){this._controller.reset()}rebind(){this._controller.rebind()}update(e){this._blendTime&&(this._blendTimeElapsed<this._blendTime?(this.weight=rs.lerp(this._startingWeight,this._targetWeight,this._blendTimeElapsed/this._blendTime),this._blendTimeElapsed+=e):(this.weight=this._targetWeight,this._blendTime=0,this._blendTimeElapsed=0,this._startingWeight=0,this._targetWeight=0)),this._controller.update(e)}blendToWeight(e,t){this._startingWeight=this.weight,this._targetWeight=e,this._blendTime=Math.max(0,t),this._blendTimeElapsed=0}assignAnimation(e,t,s,i){t instanceof rm&&(this._controller.assignAnimation(e,t,s,i),0===this._controller._transitions.length&&this._controller._transitions.push(new gm({from:"START",to:e})),this._component.activate&&this._component.playable&&(this._component.playing=!0))}removeNodeAnimations(e){this._controller.removeNodeAnimations(e)&&(this._component.playing=!1)}getAnimationAsset(e){return this._component.animationAssets[`${this.name}:${e}`]}transition(e,t=0,s=null){this._controller.updateStateFromTransition(new gm({from:this._controller.activeStateName,to:e,time:t,transitionOffset:s}))}}class Tm{constructor(e){if(this._layers=[],this._parameters={},Array.isArray(e.layers))this._layers=e.layers;else for(const t in e.layers){const s=e.layers[t],i={name:s.name,blendType:s.blendType,weight:s.weight,states:[],transitions:[]};for(let t=0;t<s.states.length;t++)i.states.push(e.states[s.states[t]]);for(let t=0;t<s.transitions.length;t++){const n=e.transitions[s.transitions[t]];if(n.conditions&&!Array.isArray(n.conditions)){const e=Object.keys(n.conditions),t=[];for(let s=0;s<e.length;s++){const i=n.conditions[e[s]];i.parameterName&&t.push(i)}n.conditions=t}Number.isInteger(n.from)&&(n.from=e.states[n.from].name),Number.isInteger(n.to)&&(n.to=e.states[n.to].name),i.transitions.push(n)}this._layers.push(i)}for(const t in e.parameters){const s=e.parameters[t];this._parameters[s.name]={type:s.type,value:s.value}}}get parameters(){return Object.assign({},this._parameters)}get layers(){return this._layers}}class Em extends zf{constructor(e,t){super(e,t),this.findParameter=e=>this._parameters[e],this.consumeTrigger=e=>{this._consumedTriggers.add(e)},this._stateGraphAsset=null,this._animationAssets={},this._speed=1,this._activate=!0,this._playing=!1,this._rootBone=null,this._stateGraph=null,this._layers=[],this._layerIndices={},this._parameters={},this._targets={},this._consumedTriggers=new Set,this._normalizeWeights=!1}set stateGraphAsset(e){if(null===e)return void this.removeStateGraph();if(this._stateGraphAsset){this.system.app.assets.get(this._stateGraphAsset).off("change",this._onStateGraphAssetChangeEvent,this)}let t,s;e instanceof ef?(t=e.id,s=this.system.app.assets.get(t),s||(this.system.app.assets.add(e),s=this.system.app.assets.get(t))):(t=e,s=this.system.app.assets.get(t)),s&&this._stateGraphAsset!==t&&(s.resource?(this._stateGraph=s.resource,this.loadStateGraph(this._stateGraph),s.on("change",this._onStateGraphAssetChangeEvent,this)):(s.once("load",(e=>{this._stateGraph=e.resource,this.loadStateGraph(this._stateGraph)})),s.on("change",this._onStateGraphAssetChangeEvent,this),this.system.app.assets.load(s)),this._stateGraphAsset=t)}get stateGraphAsset(){return this._stateGraphAsset}set normalizeWeights(e){this._normalizeWeights=e,this.unbind()}get normalizeWeights(){return this._normalizeWeights}set animationAssets(e){this._animationAssets=e,this.loadAnimationAssets()}get animationAssets(){return this._animationAssets}set speed(e){this._speed=e}get speed(){return this._speed}set activate(e){this._activate=e}get activate(){return this._activate}set playing(e){this._playing=e}get playing(){return this._playing}set rootBone(e){if("string"==typeof e){const t=this.entity.root.findByGuid(e);this._rootBone=t}else this._rootBone=e instanceof vf?e:null;this.rebind()}get rootBone(){return this._rootBone}set stateGraph(e){this._stateGraph=e}get stateGraph(){return this._stateGraph}get layers(){return this._layers}set layerIndices(e){this._layerIndices=e}get layerIndices(){return this._layerIndices}set parameters(e){this._parameters=e}get parameters(){return this._parameters}set targets(e){this._targets=e}get targets(){return this._targets}get playable(){for(let e=0;e<this._layers.length;e++)if(!this._layers[e].playable)return!1;return!0}get baseLayer(){return this._layers.length>0?this._layers[0]:null}_onStateGraphAssetChangeEvent(e){const t=this.animationAssets,s=this.layers.map((e=>e.mask));this.removeStateGraph(),this._stateGraph=new Tm(e._data),this.loadStateGraph(this._stateGraph),this.animationAssets=t,this.loadAnimationAssets(),this.layers.forEach(((e,t)=>{e.mask=s[t]})),this.rebind()}dirtifyTargets(){const e=Object.values(this._targets);for(let t=0;t<e.length;t++)e[t].dirty=!0}_addLayer({name:e,states:t,transitions:s,weight:i,mask:n,blendType:r}){let a;a=this.rootBone?this.rootBone:this.entity;const o=this._layers.length,l=new Sm(this,a,e,n,o),h=new sm(l),c=new _m(h,t,s,this._activate,this,this.findParameter,this.consumeTrigger);return this._layers.push(new Cm(e,c,this,i,r)),this._layerIndices[e]=o,this._layers[o]}addLayer(e,t,s,i){const n=this.findAnimationLayer(e);if(n)return n;return this._addLayer({name:e,states:[{name:"START",speed:1}],transitions:[],weight:t,mask:s,blendType:i})}_assignParameters(e){this._parameters={};const t=Object.keys(e.parameters);for(let s=0;s<t.length;s++){const i=t[s];this._parameters[i]={type:e.parameters[i].type,value:e.parameters[i].value}}}loadStateGraph(e){this._stateGraph=e,this._assignParameters(e),this._layers=[];let t=!1;for(let s=0;s<e.layers.length;s++){const i=e.layers[s];this._addLayer(kn({},i)),i.states.some((e=>e.blendTree))&&(t=!0)}t||this.setupAnimationAssets()}setupAnimationAssets(){for(let e=0;e<this._layers.length;e++){const t=this._layers[e],s=t.name;for(let e=0;e<t.states.length;e++){const i=t.states[e];if(-1===Jf.indexOf(i)){const e=`${s}:${i}`;this._animationAssets[e]||(this._animationAssets[e]={asset:null})}}}this.loadAnimationAssets()}loadAnimationAssets(){for(let e=0;e<this._layers.length;e++){const t=this._layers[e];for(let e=0;e<t.states.length;e++){const s=t.states[e];if(-1!==Jf.indexOf(s))continue;const i=this._animationAssets[`${t.name}:${s}`];if(!i||!i.asset){this.findAnimationLayer(t.name).assignAnimation(s,rm.EMPTY);continue}const n=i.asset,r=this.system.app.assets.get(n);r&&(r.resource?this.onAnimationAssetLoaded(t.name,s,r):(r.once("load",function(e,t){return function(s){this.onAnimationAssetLoaded(e,t,s)}.bind(this)}.bind(this)(t.name,s)),this.system.app.assets.load(r)))}}}onAnimationAssetLoaded(e,t,s){this.findAnimationLayer(e).assignAnimation(t,s.resource)}removeStateGraph(){this._stateGraph=null,this._stateGraphAsset=null,this._animationAssets={},this._layers=[],this._layerIndices={},this._parameters={},this._playing=!1,this.unbind(),this._targets={}}reset(){this._assignParameters(this._stateGraph);for(let e=0;e<this._layers.length;e++){const t=this._layers[e].playing;this._layers[e].reset(),this._layers[e].playing=t}}unbind(){this._normalizeWeights||Object.keys(this._targets).forEach((e=>{this._targets[e].unbind()}))}rebind(){this._targets={};for(let e=0;e<this._layers.length;e++)this._layers[e].rebind()}findAnimationLayer(e){const t=this._layerIndices[e];return this._layers[t]||null}addAnimationState(e,t,s=1,i=!0,n="Base"){this._stateGraph||this.loadStateGraph(new Tm({layers:[{name:n,states:[{name:"START",speed:1},{name:e,speed:s,loop:i,defaultState:!0}],transitions:[{from:"START",to:e}]}],parameters:{}}));const r=this.findAnimationLayer(n);var a;r?r.assignAnimation(e,t,s,i):null==(a=this.addLayer(n))||a.assignAnimation(e,t,s,i)}assignAnimation(e,t,s,i=1,n=!0){if(!this._stateGraph&&-1===e.indexOf("."))return this.loadStateGraph(new Tm({layers:[{name:"Base",states:[{name:"START",speed:1},{name:e,speed:i,loop:n,defaultState:!0}],transitions:[{from:"START",to:e}]}],parameters:{}})),void this.baseLayer.assignAnimation(e,t);const r=s?this.findAnimationLayer(s):this.baseLayer;r&&r.assignAnimation(e,t,i,n)}removeNodeAnimations(e,t){const s=t?this.findAnimationLayer(t):this.baseLayer;s&&s.removeNodeAnimations(e)}getParameterValue(e,t){const s=this._parameters[e];if(s&&s.type===t)return s.value}setParameterValue(e,t,s){const i=this._parameters[e];i&&i.type===t&&(i.value=s)}getFloat(e){return this.getParameterValue(e,$f)}setFloat(e,t){this.setParameterValue(e,$f,t)}getInteger(e){return this.getParameterValue(e,Wf)}setInteger(e,t){"number"==typeof t&&t%1==0&&this.setParameterValue(e,Wf,t)}getBoolean(e){return this.getParameterValue(e,qf)}setBoolean(e,t){this.setParameterValue(e,qf,!!t)}getTrigger(e){return this.getParameterValue(e,Xf)}setTrigger(e,t=!1){this.setParameterValue(e,Xf,!0),t&&this._consumedTriggers.add(e)}resetTrigger(e){this.setParameterValue(e,Xf,!1)}onBeforeRemove(){if(Number.isFinite(this._stateGraphAsset)){this.system.app.assets.get(this._stateGraphAsset).off("change",this._onStateGraphAssetChangeEvent,this)}}update(e){for(let t=0;t<this.layers.length;t++)this.layers[t].update(e*this.speed);this._consumedTriggers.forEach((e=>{this.parameters[e].value=!1})),this._consumedTriggers.clear()}resolveDuplicatedEntityReferenceProperties(e,t){e.rootBone&&t[e.rootBone.getGuid()]?this.rootBone=t[e.rootBone.getGuid()]:this.rebind()}}class Pm{constructor(){this.enabled=!0}}const km=["enabled"];class Am extends Nf{constructor(e){super(e),this.id="anim",this.ComponentType=Em,this.DataType=Pm,this.schema=km,this.on("beforeremove",this.onBeforeRemove,this),this.app.systems.on("animationUpdate",this.onAnimationUpdate,this)}initializeComponentData(e,t,s){super.initializeComponentData(e,t,km);const i=["animationAssets","stateGraph","layers","masks"];Object.keys(t).forEach((s=>{i.includes(s)||(e[s]=t[s])})),t.stateGraph&&(e.stateGraph=t.stateGraph,e.loadStateGraph(e.stateGraph)),t.layers&&t.layers.forEach(((t,s)=>{t._controller.states.forEach((i=>{t._controller._states[i]._animationList.forEach((i=>{if(i.animTrack&&i.animTrack!==rm.EMPTY)e.layers[s].assignAnimation(i.name,i.animTrack);else{const n=this.app.assets.get(t._component._animationAssets[`${t.name}:${i.name}`].asset);n&&!n.loaded&&n.once("load",(()=>{e.layers[s].assignAnimation(i.name,n.resource)}))}}))}))})),t.animationAssets&&(e.animationAssets=Object.assign(e.animationAssets,t.animationAssets)),t.masks&&Object.keys(t.masks).forEach((s=>{if(e.layers[s]){const i=t.masks[s].mask,n={};Object.keys(i).forEach((e=>{n[decodeURI(e)]=i[e]})),e.layers[s].mask=n}}))}onAnimationUpdate(e){const t=this.store;for(const s in t)if(t.hasOwnProperty(s)){const i=t[s].entity.anim;i.data.enabled&&i.entity.enabled&&i.playing&&i.update(e)}}cloneComponent(e,t){let s;e.anim.rootBone&&e.anim.rootBone!==e||(s={},e.anim.layers.forEach(((e,i)=>{if(e.mask){const n={};Object.keys(e.mask).forEach((s=>{const i=s.split("/");i.shift();const r=[t.name,...i].join("/");n[r]=e.mask[s]})),s[i]={mask:n}}})));const i={stateGraphAsset:e.anim.stateGraphAsset,animationAssets:e.anim.animationAssets,speed:e.anim.speed,activate:e.anim.activate,playing:e.anim.playing,rootBone:e.anim.rootBone,stateGraph:e.anim.stateGraph,layers:e.anim.layers,layerIndices:e.anim.layerIndices,parameters:e.anim.parameters,normalizeWeights:e.anim.normalizeWeights,masks:s};return this.addComponent(t,i)}onBeforeRemove(e,t){t.onBeforeRemove()}destroy(){super.destroy(),this.app.systems.off("animationUpdate",this.onAnimationUpdate,this)}}zf._buildAccessors(Em.prototype,km);class Mm extends Kt{constructor(e,t,s){if(super(),!(e&&e instanceof zf))throw new Error("The parentComponent argument is required and must be a Component");if(!t||"string"!=typeof t)throw new Error("The propertyName argument is required and must be a string");if(s&&"object"!=typeof s)throw new Error("If provided, the eventConfig argument must be an object");this._parentComponent=e,this._entityPropertyName=t,this._entity=null,this._app=e.system.app,this._configureEventListeners(s||{},{"entity#destroy":this._onEntityDestroy}),this._toggleLifecycleListeners("on")}_configureEventListeners(e,t){const s=this._parseEventListenerConfig(e,"external",this._parentComponent),i=this._parseEventListenerConfig(t,"internal",this);this._eventListenerConfigs=s.concat(i),this._listenerStatusFlags={},this._gainListeners={},this._loseListeners={}}_parseEventListenerConfig(e,t,s){return Object.keys(e).map(((i,n)=>{const r=i.split("#"),a=r[0],o=r[1],l=e[i];if(2!==r.length||"string"!=typeof a||0===a.length||"string"!=typeof o||0===o.length)throw new Error(`Invalid event listener description: \`${i}\``);if("function"!=typeof l)throw new Error(`Invalid or missing callback for event listener \`${i}\``);return{id:`${t}_${n}_${i}`,sourceName:a,eventName:o,callback:l,scope:s}}),this)}_toggleLifecycleListeners(e){this._parentComponent[e](`set_${this._entityPropertyName}`,this._onSetEntity,this),this._parentComponent.system[e]("beforeremove",this._onParentComponentRemove,this),this._app.systems[e]("postPostInitialize",this._updateEntityReference,this),this._app[e]("tools:sceneloaded",this._onSceneLoaded,this);const t=[];for(let e=0;e<this._eventListenerConfigs.length;++e){const s=this._eventListenerConfigs[e],i=this._app.systems[s.sourceName];i&&(-1===t.indexOf(i)&&t.push(i),i&&"gain"===s.eventName&&(this._gainListeners[s.sourceName]=s),i&&"lose"===s.eventName&&(this._loseListeners[s.sourceName]=s))}for(let s=0;s<t.length;++s)t[s][e]("add",this._onComponentAdd,this),t[s][e]("beforeremove",this._onComponentRemove,this)}_onSetEntity(e,t,s){if(s instanceof vf)this._updateEntityReference();else{if(null!=s&&"string"!=typeof s)return void console.warn(`Entity field \`${this._entityPropertyName}\` was set to unexpected type '${typeof s}'`);t!==s&&this._updateEntityReference()}}onParentComponentEnable(){this._entity||this._updateEntityReference()}_onSceneLoaded(){this._updateEntityReference()}_updateEntityReference(){let e,t=this._parentComponent.data[this._entityPropertyName];if(t instanceof vf)e=t,t=e.getGuid(),this._parentComponent.data[this._entityPropertyName]=t;else{const s=this._parentComponent.system.app.root;e=this._parentComponent.entity.isDescendantOf(s)&&t?s.findByGuid(t):null}this._entity!==e&&(this._entity&&this._onBeforeEntityChange(),this._entity=e,this._entity&&this._onAfterEntityChange(),this.fire("set:entity",this._entity))}_onBeforeEntityChange(){this._toggleEntityListeners("off"),this._callAllGainOrLoseListeners(this._loseListeners)}_onAfterEntityChange(){this._toggleEntityListeners("on"),this._callAllGainOrLoseListeners(this._gainListeners)}_onComponentAdd(e,t){const s=t.system.id;e===this._entity&&(this._callGainOrLoseListener(s,this._gainListeners),this._toggleComponentListeners("on",s))}_onComponentRemove(e,t){const s=t.system.id;e===this._entity&&(this._callGainOrLoseListener(s,this._loseListeners),this._toggleComponentListeners("off",s,!0))}_callAllGainOrLoseListeners(e){for(const t in this._entity.c)this._callGainOrLoseListener(t,e)}_callGainOrLoseListener(e,t){if(this._entity.c.hasOwnProperty(e)&&t[e]){const s=t[e];s.callback.call(s.scope)}}_toggleEntityListeners(e,t){if(this._entity)for(let s=0;s<this._eventListenerConfigs.length;++s)this._safeToggleListener(e,this._eventListenerConfigs[s],t)}_toggleComponentListeners(e,t,s){for(let i=0;i<this._eventListenerConfigs.length;++i){const n=this._eventListenerConfigs[i];n.sourceName===t&&this._safeToggleListener(e,n,s)}}_safeToggleListener(e,t,s){const i="on"===e;if(i&&this._listenerStatusFlags[t.id])return;const n=this._getEventSource(t.sourceName,s);n&&(n[e](t.eventName,t.callback,t.scope),this._listenerStatusFlags[t.id]=i)}_getEventSource(e,t){if("entity"===e)return this._entity;const s=this._entity[e];return s||(t||console.warn(`Entity has no component with name ${e}`),null)}_onEntityDestroy(e){this._entity===e&&(this._toggleEntityListeners("off",!0),this._entity=null)}_onParentComponentRemove(e,t){t===this._parentComponent&&(this._toggleLifecycleListeners("off"),this._toggleEntityListeners("off",!0))}hasComponent(e){return!(!this._entity||!this._entity.c)&&!!this._entity.c[e]}get entity(){return this._entity}}class Dm{constructor(){this.map=new Map}destroy(e){this.map.forEach((e=>e.mesh.destroy()))}}const Rm=new _n;class Lm extends Tr{constructor(e,t){super(),this.skin=e,this.skinInstance=t}}class Im{static createCachedSkinInstance(e,t,s){let i=Im.getCachedSkinInstance(e,t);return i||(i=new Pl(e),i.resolve(t,s),Im.addCachedSkinInstance(e,t,i)),i}static getCachedSkinInstance(e,t){let s=null;const i=Im._skinInstanceCache.get(t);if(i){const t=i.find((t=>t.skin===e));t&&(t.incRefCount(),s=t.skinInstance)}return s}static addCachedSkinInstance(e,t,s){let i=Im._skinInstanceCache.get(t);i||(i=[],Im._skinInstanceCache.set(t,i));let n=i.find((t=>t.skin===e));n||(n=new Lm(e,s),i.push(n)),n.incRefCount()}static removeCachedSkinInstance(e){if(e){const t=e.rootBone;if(t){const s=Im._skinInstanceCache.get(t);if(s){const i=s.findIndex((t=>t.skinInstance===e));if(i>=0){const n=s[i];n.decRefCount(),0===n.refCount&&(s.splice(i,1),s.length||Im._skinInstanceCache.delete(t),e&&(e.destroy(),n.skinInstance=null))}}}}}}Im._skinInstanceCache=new Map;class Fm{constructor(e,t,s,i,n){this._evtLoadById=null,this._evtUnloadById=null,this._evtAddById=null,this._evtRemoveById=null,this._evtLoadByUrl=null,this._evtAddByUrl=null,this._evtRemoveByUrl=null,this.propertyName=e,this.parent=t,this._scope=n,this._registry=s,this.id=null,this.url=null,this.asset=null,this._onAssetLoad=i.load,this._onAssetAdd=i.add,this._onAssetRemove=i.remove,this._onAssetUnload=i.unload}set id(e){if(this.url)throw Error("Can't set id and url");this._unbind(),this._id=e,this.asset=this._registry.get(this._id),this._bind()}get id(){return this._id}set url(e){if(this.id)throw Error("Can't set id and url");this._unbind(),this._url=e,this.asset=this._registry.getByUrl(this._url),this._bind()}get url(){return this._url}_bind(){this.id&&(this._onAssetLoad&&(this._evtLoadById=this._registry.on(`load:${this.id}`,this._onLoad,this)),this._onAssetAdd&&(this._evtAddById=this._registry.once(`add:${this.id}`,this._onAdd,this)),this._onAssetRemove&&(this._evtRemoveById=this._registry.on(`remove:${this.id}`,this._onRemove,this)),this._onAssetUnload&&(this._evtUnloadById=this._registry.on(`unload:${this.id}`,this._onUnload,this))),this.url&&(this._onAssetLoad&&(this._evtLoadByUrl=this._registry.on(`load:url:${this.url}`,this._onLoad,this)),this._onAssetAdd&&(this._evtAddByUrl=this._registry.once(`add:url:${this.url}`,this._onAdd,this)),this._onAssetRemove&&(this._evtRemoveByUrl=this._registry.on(`remove:url:${this.url}`,this._onRemove,this)))}_unbind(){var e,t,s,i,n,r,a;this.id&&(null==(e=this._evtLoadById)||e.off(),this._evtLoadById=null,null==(t=this._evtAddById)||t.off(),this._evtAddById=null,null==(s=this._evtRemoveById)||s.off(),this._evtRemoveById=null,null==(i=this._evtUnloadById)||i.off(),this._evtUnloadById=null);this.url&&(null==(n=this._evtLoadByUrl)||n.off(),this._evtLoadByUrl=null,null==(r=this._evtAddByUrl)||r.off(),this._evtAddByUrl=null,null==(a=this._evtRemoveByUrl)||a.off(),this._evtRemoveByUrl=null)}_onLoad(e){this._onAssetLoad.call(this._scope,this.propertyName,this.parent,e)}_onAdd(e){this.asset=e,this._onAssetAdd.call(this._scope,this.propertyName,this.parent,e)}_onRemove(e){this._onAssetRemove.call(this._scope,this.propertyName,this.parent,e),this.asset=null}_onUnload(e){this._onAssetUnload.call(this._scope,this.propertyName,this.parent,e)}}class Om extends zf{constructor(e,t){super(e,t),this._type="asset",this._castShadows=!0,this._receiveShadows=!0,this._castShadowsLightmap=!0,this._lightmapped=!1,this._lightmapSizeMultiplier=1,this.isStatic=!1,this._batchGroupId=-1,this._layers=[0],this._renderStyle=0,this._meshInstances=[],this._customAabb=null,this._area=null,this._assetReference=void 0,this._materialReferences=[],this._material=void 0,this._rootBone=void 0,this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._evtSetMeshes=null,this._rootBone=new Mm(this,"rootBone"),this._rootBone.on("set:entity",this._onSetRootBone,this),this._assetReference=new Fm("asset",this,e.app.assets,{add:this._onRenderAssetAdded,load:this._onRenderAssetLoad,remove:this._onRenderAssetRemove,unload:this._onRenderAssetUnload},this),this._material=e.defaultMaterial,t.on("remove",this.onRemoveChild,this),t.on("removehierarchy",this.onRemoveChild,this),t.on("insert",this.onInsertChild,this),t.on("inserthierarchy",this.onInsertChild,this)}set renderStyle(e){this._renderStyle!==e&&(this._renderStyle=e,Hl._prepareRenderStyleForArray(this._meshInstances,e))}get renderStyle(){return this._renderStyle}set customAabb(e){this._customAabb=e;const t=this._meshInstances;if(t)for(let e=0;e<t.length;e++)t[e].setCustomAabb(this._customAabb)}get customAabb(){return this._customAabb}set type(e){if(this._type!==e&&(this._area=null,this._type=e,this.destroyMeshInstances(),"asset"!==e)){let t=this._material;t&&t!==this.system.defaultMaterial||(t=this._materialReferences[0]&&this._materialReferences[0].asset&&this._materialReferences[0].asset.resource);const s=((e,t)=>{const s=Rm.get(e,(()=>new Dm));let i=s.map.get(t);if(!i){let n,r;switch(t){case"box":n=Dl.fromGeometry(e,new Vd),r={x:2,y:2,z:2,uv:2/3};break;case"capsule":n=Dl.fromGeometry(e,new np({radius:.5,height:2})),r={x:2*Math.PI,y:Math.PI,z:2*Math.PI,uv:1/3+1/3/3*2};break;case"cone":n=Dl.fromGeometry(e,new rp({baseRadius:.5,peakRadius:0,height:1})),r={x:2.54,y:2.54,z:2.54,uv:1/3+1/3/3};break;case"cylinder":n=Dl.fromGeometry(e,new ap({radius:.5,height:1})),r={x:Math.PI,y:1.58,z:Math.PI,uv:1/3+1/3/3*2};break;case"plane":n=Dl.fromGeometry(e,new op({halfExtents:new ws(.5,.5),widthSegments:1,lengthSegments:1})),r={x:0,y:1,z:0,uv:1};break;case"sphere":n=Dl.fromGeometry(e,new Gd({radius:.5})),r={x:Math.PI,y:Math.PI,z:Math.PI,uv:1};break;case"torus":n=Dl.fromGeometry(e,new lp({tubeRadius:.2,ringRadius:.3})),r={x:.5*Math.PI*.5-.1*Math.PI*.1,y:.4,z:.4,uv:1};break;default:throw new Error(`Invalid primitive type: ${t}`)}n.incRefCount(),i={mesh:n,area:r},s.map.set(t,i)}return i})(this.system.app.graphicsDevice,e);this._area=s.area,this.meshInstances=[new Hl(s.mesh,t||this.system.defaultMaterial,this.entity)]}}get type(){return this._type}set meshInstances(e){if(this.destroyMeshInstances(),this._meshInstances=e,this._meshInstances){const e=this._meshInstances;for(let t=0;t<e.length;t++)e[t].node||(e[t].node=this.entity),e[t].castShadow=this._castShadows,e[t].receiveShadow=this._receiveShadows,e[t].renderStyle=this._renderStyle,e[t].setLightmapped(this._lightmapped),e[t].setCustomAabb(this._customAabb);this.enabled&&this.entity.enabled&&this.addToLayers()}}get meshInstances(){return this._meshInstances}set lightmapped(e){if(e!==this._lightmapped){this._lightmapped=e;const t=this._meshInstances;if(t)for(let s=0;s<t.length;s++)t[s].setLightmapped(e)}}get lightmapped(){return this._lightmapped}set castShadows(e){if(this._castShadows!==e){const t=this._meshInstances;if(t){const s=this.layers,i=this.system.app.scene;if(this._castShadows&&!e)for(let e=0;e<s.length;e++){const s=i.layers.getLayerById(this.layers[e]);s&&s.removeShadowCasters(t)}for(let s=0;s<t.length;s++)t[s].castShadow=e;if(!this._castShadows&&e)for(let e=0;e<s.length;e++){const n=i.layers.getLayerById(s[e]);n&&n.addShadowCasters(t)}}this._castShadows=e}}get castShadows(){return this._castShadows}set receiveShadows(e){if(this._receiveShadows!==e){this._receiveShadows=e;const t=this._meshInstances;if(t)for(let s=0;s<t.length;s++)t[s].receiveShadow=e}}get receiveShadows(){return this._receiveShadows}set castShadowsLightmap(e){this._castShadowsLightmap=e}get castShadowsLightmap(){return this._castShadowsLightmap}set lightmapSizeMultiplier(e){this._lightmapSizeMultiplier=e}get lightmapSizeMultiplier(){return this._lightmapSizeMultiplier}set layers(e){const t=this.system.app.scene.layers;let s;if(this._meshInstances)for(let e=0;e<this._layers.length;e++)s=t.getLayerById(this._layers[e]),s&&s.removeMeshInstances(this._meshInstances);this._layers.length=0;for(let t=0;t<e.length;t++)this._layers[t]=e[t];if(this.enabled&&this.entity.enabled&&this._meshInstances)for(let e=0;e<this._layers.length;e++)s=t.getLayerById(this._layers[e]),s&&s.addMeshInstances(this._meshInstances)}get layers(){return this._layers}set batchGroupId(e){if(this._batchGroupId!==e){var t,s;if(this.entity.enabled&&this._batchGroupId>=0)null==(t=this.system.app.batcher)||t.remove(Tl.RENDER,this.batchGroupId,this.entity);if(this.entity.enabled&&e>=0)null==(s=this.system.app.batcher)||s.insert(Tl.RENDER,e,this.entity);e<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&this.addToLayers(),this._batchGroupId=e}}get batchGroupId(){return this._batchGroupId}set material(e){if(this._material!==e&&(this._material=e,this._meshInstances&&"asset"!==this._type))for(let t=0;t<this._meshInstances.length;t++)this._meshInstances[t].material=e}get material(){return this._material}set materialAssets(e=[]){if(this._materialReferences.length>e.length){for(let t=e.length;t<this._materialReferences.length;t++)this._materialReferences[t].id=null;this._materialReferences.length=e.length}for(let t=0;t<e.length;t++)if(this._materialReferences[t]||this._materialReferences.push(new Fm(t,this,this.system.app.assets,{add:this._onMaterialAdded,load:this._onMaterialLoad,remove:this._onMaterialRemove,unload:this._onMaterialUnload},this)),e[t]){const s=e[t]instanceof ef?e[t].id:e[t];this._materialReferences[t].id!==s&&(this._materialReferences[t].id=s),this._materialReferences[t].asset&&this._onMaterialAdded(t,this,this._materialReferences[t].asset)}else this._materialReferences[t].id=null,this._meshInstances[t]&&(this._meshInstances[t].material=this.system.defaultMaterial)}get materialAssets(){return this._materialReferences.map((e=>e.id))}set asset(e){const t=e instanceof ef?e.id:e;this._assetReference.id!==t&&(this._assetReference.asset&&this._assetReference.asset.resource&&this._onRenderAssetRemove(),this._assetReference.id=t,this._assetReference.asset&&this._onRenderAssetAdded())}get asset(){return this._assetReference.id}assignAsset(e){const t=e instanceof ef?e.id:e;this._assetReference.id=t}_onSetRootBone(e){e&&this._onRootBoneChanged()}_onRootBoneChanged(){this._clearSkinInstances(),this.enabled&&this.entity.enabled&&this._cloneSkinInstances()}destroyMeshInstances(){const e=this._meshInstances;if(e){this.removeFromLayers(),this._clearSkinInstances();for(let t=0;t<e.length;t++)e[t].destroy();this._meshInstances.length=0}}addToLayers(){const e=this.system.app.scene.layers;for(let t=0;t<this._layers.length;t++){const s=e.getLayerById(this._layers[t]);s&&s.addMeshInstances(this._meshInstances)}}removeFromLayers(){if(this._meshInstances&&this._meshInstances.length){const e=this.system.app.scene.layers;for(let t=0;t<this._layers.length;t++){const s=e.getLayerById(this._layers[t]);s&&s.removeMeshInstances(this._meshInstances)}}}onRemoveChild(){this.removeFromLayers()}onInsertChild(){this._meshInstances&&this.enabled&&this.entity.enabled&&this.addToLayers()}onRemove(){this.destroyMeshInstances(),this.asset=null,this.materialAsset=null,this._assetReference.id=null;for(let e=0;e<this._materialReferences.length;e++)this._materialReferences[e].id=null;this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)}onLayersChanged(e,t){this.addToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){this.layers.indexOf(e.id)<0||e.addMeshInstances(this._meshInstances)}onLayerRemoved(e){this.layers.indexOf(e.id)<0||e.removeMeshInstances(this._meshInstances)}onEnable(){const e=this.system.app,t=e.scene,s=t.layers;this._rootBone.onParentComponentEnable(),this._cloneSkinInstances(),this._evtLayersChanged=t.on("set:layers",this.onLayersChanged,this),s&&(this._evtLayerAdded=s.on("add",this.onLayerAdded,this),this._evtLayerRemoved=s.on("remove",this.onLayerRemoved,this));const i="asset"===this._type;this._meshInstances&&this._meshInstances.length?this.addToLayers():i&&this.asset&&this._onRenderAssetAdded();for(let e=0;e<this._materialReferences.length;e++)this._materialReferences[e].asset&&this.system.app.assets.load(this._materialReferences[e].asset);var n;this._batchGroupId>=0&&(null==(n=e.batcher)||n.insert(Tl.RENDER,this.batchGroupId,this.entity))}onDisable(){var e;const t=this.system.app,s=t.scene.layers;var i,n,r;(null==(e=this._evtLayersChanged)||e.off(),this._evtLayersChanged=null,s)&&(null==(i=this._evtLayerAdded)||i.off(),this._evtLayerAdded=null,null==(n=this._evtLayerRemoved)||n.off(),this._evtLayerRemoved=null);this._batchGroupId>=0&&(null==(r=t.batcher)||r.remove(Tl.RENDER,this.batchGroupId,this.entity));this.removeFromLayers()}hide(){if(this._meshInstances)for(let e=0;e<this._meshInstances.length;e++)this._meshInstances[e].visible=!1}show(){if(this._meshInstances)for(let e=0;e<this._meshInstances.length;e++)this._meshInstances[e].visible=!0}_onRenderAssetAdded(){this._assetReference.asset&&(this._assetReference.asset.resource?this._onRenderAssetLoad():this.enabled&&this.entity.enabled&&this.system.app.assets.load(this._assetReference.asset))}_onRenderAssetLoad(){if(this.destroyMeshInstances(),this._assetReference.asset){var e;const t=this._assetReference.asset.resource;null==(e=this._evtSetMeshes)||e.off(),this._evtSetMeshes=t.on("set:meshes",this._onSetMeshes,this),t.meshes&&this._onSetMeshes(t.meshes)}}_onSetMeshes(e){this._cloneMeshes(e)}_clearSkinInstances(){for(let e=0;e<this._meshInstances.length;e++){const t=this._meshInstances[e];Im.removeCachedSkinInstance(t.skinInstance),t.skinInstance=null}}_cloneSkinInstances(){if(this._meshInstances.length&&this._rootBone.entity instanceof vh)for(let e=0;e<this._meshInstances.length;e++){const t=this._meshInstances[e],s=t.mesh;s.skin&&!t.skinInstance&&(t.skinInstance=Im.createCachedSkinInstance(s.skin,this._rootBone.entity,this.entity))}}_cloneMeshes(e){if(e&&e.length){const t=[];for(let s=0;s<e.length;s++){const i=e[s],n=this._materialReferences[s]&&this._materialReferences[s].asset&&this._materialReferences[s].asset.resource,r=new Hl(i,n||this.system.defaultMaterial,this.entity);t.push(r),i.morph&&(r.morphInstance=new Pd(i.morph))}this.meshInstances=t,this._cloneSkinInstances()}}_onRenderAssetUnload(){"asset"===this._type&&this.destroyMeshInstances()}_onRenderAssetRemove(){var e;null==(e=this._evtSetMeshes)||e.off(),this._evtSetMeshes=null,this._onRenderAssetUnload()}_onMaterialAdded(e,t,s){s.resource?this._onMaterialLoad(e,t,s):this.enabled&&this.entity.enabled&&this.system.app.assets.load(s)}_updateMainMaterial(e,t){0===e&&(this.material=t)}_onMaterialLoad(e,t,s){this._meshInstances[e]&&(this._meshInstances[e].material=s.resource),this._updateMainMaterial(e,s.resource)}_onMaterialRemove(e,t,s){this._meshInstances[e]&&(this._meshInstances[e].material=this.system.defaultMaterial),this._updateMainMaterial(e,this.system.defaultMaterial)}_onMaterialUnload(e,t,s){this._meshInstances[e]&&(this._meshInstances[e].material=this.system.defaultMaterial),this._updateMainMaterial(e,this.system.defaultMaterial)}resolveDuplicatedEntityReferenceProperties(e,t){e.rootBone&&t[e.rootBone]&&(this.rootBone=t[e.rootBone]),this._clearSkinInstances()}}class Bm{constructor(){this.enabled=!0,this.rootBone=null}}const zm=[{name:"rootBone",type:"entity"},"enabled"],Nm=["material","meshInstances","asset","materialAssets","castShadows","receiveShadows","castShadowsLightmap","lightmapped","lightmapSizeMultiplier","renderStyle","type","layers","isStatic","batchGroupId"];class Um extends Nf{constructor(e){super(e),this.id="render",this.ComponentType=Om,this.DataType=Bm,this.schema=zm,this.defaultMaterial=Ll(e.graphicsDevice),this.on("beforeremove",this.onRemove,this)}initializeComponentData(e,t,s){null!==t.batchGroupId&&void 0!==t.batchGroupId||(t.batchGroupId=-1),t.layers&&t.layers.length&&(t.layers=t.layers.slice(0));for(let s=0;s<Nm.length;s++)t.hasOwnProperty(Nm[s])&&(e[Nm[s]]=t[Nm[s]]);t.aabbCenter&&t.aabbHalfExtents&&(e.customAabb=new Bs(new ys(t.aabbCenter),new ys(t.aabbHalfExtents))),super.initializeComponentData(e,t,zm)}cloneComponent(e,t){const s={};for(let t=0;t<Nm.length;t++)s[Nm[t]]=e.render[Nm[t]];s.enabled=e.render.enabled,delete s.meshInstances;const i=this.addComponent(t,s),n=e.render.meshInstances,r=n.map((e=>e.mesh));i._onSetMeshes(r);for(let e=0;e<n.length;e++)i.meshInstances[e].material=n[e].material;return e.render.customAabb&&(i.customAabb=e.render.customAabb.clone()),i}onRemove(e,t){t.onRemove()}}zf._buildAccessors(Om.prototype,zm);class Vm{constructor(e,t){this.effect=e,this.inputTarget=t,this.outputTarget=null,this.name=e.constructor.name}}class Gm{constructor(e,t){this.app=e,this.camera=t,this.destinationRenderTarget=null,this.effects=[],this.enabled=!1,this.depthTarget=null,t.on("set:rect",this.onCameraRectChanged,this)}_allocateColorBuffer(e,t){var s,i;const n=this.camera.rect,r=this.destinationRenderTarget,a=this.app.graphicsDevice,o=Math.floor(n.z*(null!=(s=null==r?void 0:r.width)?s:a.width)),l=Math.floor(n.w*(null!=(i=null==r?void 0:r.height)?i:a.height));return new yn(a,{name:t,format:e,width:o,height:l,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1})}_createOffscreenTarget(e,t){var s,i;const n=this.app.graphicsDevice,r=(null!=(s=this.destinationRenderTarget)?s:n.backBuffer).isColorBufferSrgb(0),a=null!=(i=t&&n.getRenderableHdrFormat([Ws,$s],!0))?i:r?Qs:7,o=`${this.camera.entity.name}-posteffect-${this.effects.length}`,l=this._allocateColorBuffer(a,o);return new tr({colorBuffer:l,depth:e,stencil:e&&this.app.graphicsDevice.supportsStencil,samples:e?n.samples:1})}_resizeOffscreenTarget(e){const t=e.colorBuffer.format,s=e.colorBuffer.name;e.destroyFrameBuffers(),e.destroyTextureBuffers(),e._colorBuffer=this._allocateColorBuffer(t,s),e._colorBuffers=[e._colorBuffer]}_destroyOffscreenTarget(e){e.destroyTextureBuffers(),e.destroy()}addEffect(e){const t=this.effects,s=0===t.length,i=this._createOffscreenTarget(s,e.hdr),n=new Vm(e,i);t.push(n),this._sourceTarget=n.inputTarget,t.length>1&&(t[t.length-2].outputTarget=n.inputTarget),this._newPostEffect=e,e.needsDepthBuffer&&this._requestDepthMap(),this.enable(),this._newPostEffect=void 0}removeEffect(e){let t=-1;for(let s=0,i=this.effects.length;s<i;s++)if(this.effects[s].effect===e){t=s;break}t>=0&&(t>0?this.effects[t-1].outputTarget=t+1<this.effects.length?this.effects[t+1].inputTarget:null:this.effects.length>1&&(this.effects[1].inputTarget._depth||(this._destroyOffscreenTarget(this.effects[1].inputTarget),this.effects[1].inputTarget=this._createOffscreenTarget(!0,this.effects[1].hdr),this._sourceTarget=this.effects[1].inputTarget),this.camera.renderTarget=this.effects[1].inputTarget),this._destroyOffscreenTarget(this.effects[t].inputTarget),this.effects.splice(t,1)),this.enabled&&e.needsDepthBuffer&&this._releaseDepthMap(),0===this.effects.length&&this.disable()}_requestDepthMaps(){for(let e=0,t=this.effects.length;e<t;e++){const t=this.effects[e].effect;this._newPostEffect!==t&&(t.needsDepthBuffer&&this._requestDepthMap())}}_releaseDepthMaps(){for(let e=0,t=this.effects.length;e<t;e++){this.effects[e].effect.needsDepthBuffer&&this._releaseDepthMap()}}_requestDepthMap(){const e=this.app.scene.layers.getLayerById(1);e&&(e.incrementCounter(),this.camera.requestSceneDepthMap(!0))}_releaseDepthMap(){const e=this.app.scene.layers.getLayerById(1);e&&(e.decrementCounter(),this.camera.requestSceneDepthMap(!1))}destroy(){for(let e=0,t=this.effects.length;e<t;e++)this.effects[e].inputTarget.destroy();this.effects.length=0,this.disable()}enable(){!this.enabled&&this.effects.length&&(this.enabled=!0,this._requestDepthMaps(),this.app.graphicsDevice.on("resizecanvas",this._onCanvasResized,this),this.destinationRenderTarget=this.camera.renderTarget,this.camera.renderTarget=this.effects[0].inputTarget,this.camera.onPostprocessing=()=>{if(this.enabled){let e=null;const t=this.effects.length;if(t)for(let s=0;s<t;s++){const i=this.effects[s];let n=i.outputTarget;s===t-1&&(e=this.camera.rect,this.destinationRenderTarget&&(n=this.destinationRenderTarget)),i.effect.render(i.inputTarget,n,e)}}})}disable(){this.enabled&&(this.enabled=!1,this.app.graphicsDevice.off("resizecanvas",this._onCanvasResized,this),this._releaseDepthMaps(),this._destroyOffscreenTarget(this._sourceTarget),this.camera.renderTarget=this.destinationRenderTarget,this.camera.onPostprocessing=null)}_onCanvasResized(e,t){var s,i;const n=this.camera.rect,r=this.destinationRenderTarget;e=null!=(s=null==r?void 0:r.width)?s:e,t=null!=(i=null==r?void 0:r.height)?i:t,this.camera.camera.aspectRatio=e*n.z/(t*n.w),this.resizeRenderTargets()}resizeRenderTargets(){var e,t;const s=this.app.graphicsDevice,i=this.destinationRenderTarget,n=null!=(e=null==i?void 0:i.width)?e:s.width,r=null!=(t=null==i?void 0:i.height)?t:s.height,a=this.camera.rect,o=Math.floor(a.z*n),l=Math.floor(a.w*r),h=this.effects;for(let e=0,t=h.length;e<t;e++){const t=h[e];t.inputTarget.width===o&&t.inputTarget.height===l||this._resizeOffscreenTarget(t.inputTarget)}}onCameraRectChanged(e,t,s){this.enabled&&this.resizeRenderTargets()}}class Hm extends zf{constructor(e,t){super(e,t),this.onPostprocessing=null,this._renderSceneDepthMap=0,this._renderSceneColorMap=0,this._sceneDepthMapRequested=!1,this._sceneColorMapRequested=!1,this._priority=0,this._disablePostEffectsLayer=4,this._camera=new eh,this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._camera.node=t,this._postEffects=new Gm(e.app,this)}setShaderPass(e){const t=mc.get(this.system.app.graphicsDevice),s=e?t.allocate(e,{isForward:!0}):null;return this._camera.shaderPassInfo=s,s.index}getShaderPass(){var e;return null==(e=this._camera.shaderPassInfo)?void 0:e.name}set renderPasses(e){this._camera.renderPasses=e||[],this.dirtyLayerCompositionCameras(),this.system.app.scene.updateShaders=!0}get renderPasses(){return this._camera.renderPasses}get shaderParams(){return this._camera.shaderParams}set gammaCorrection(e){this.camera.shaderParams.gammaCorrection=e}get gammaCorrection(){return this.camera.shaderParams.gammaCorrection}set toneMapping(e){this.camera.shaderParams.toneMapping=e}get toneMapping(){return this.camera.shaderParams.toneMapping}set fog(e){this._camera.fogParams=e}get fog(){return this._camera.fogParams}set aperture(e){this._camera.aperture=e}get aperture(){return this._camera.aperture}set aspectRatio(e){this._camera.aspectRatio=e}get aspectRatio(){return this._camera.aspectRatio}set aspectRatioMode(e){this._camera.aspectRatioMode=e}get aspectRatioMode(){return this._camera.aspectRatioMode}set calculateProjection(e){this._camera.calculateProjection=e}get calculateProjection(){return this._camera.calculateProjection}set calculateTransform(e){this._camera.calculateTransform=e}get calculateTransform(){return this._camera.calculateTransform}get camera(){return this._camera}set clearColor(e){this._camera.clearColor=e}get clearColor(){return this._camera.clearColor}set clearColorBuffer(e){this._camera.clearColorBuffer=e,this.dirtyLayerCompositionCameras()}get clearColorBuffer(){return this._camera.clearColorBuffer}set clearDepthBuffer(e){this._camera.clearDepthBuffer=e,this.dirtyLayerCompositionCameras()}get clearDepthBuffer(){return this._camera.clearDepthBuffer}set clearStencilBuffer(e){this._camera.clearStencilBuffer=e,this.dirtyLayerCompositionCameras()}get clearStencilBuffer(){return this._camera.clearStencilBuffer}set cullFaces(e){this._camera.cullFaces=e}get cullFaces(){return this._camera.cullFaces}set disablePostEffectsLayer(e){this._disablePostEffectsLayer=e,this.dirtyLayerCompositionCameras()}get disablePostEffectsLayer(){return this._disablePostEffectsLayer}set farClip(e){this._camera.farClip=e}get farClip(){return this._camera.farClip}set flipFaces(e){this._camera.flipFaces=e}get flipFaces(){return this._camera.flipFaces}set fov(e){this._camera.fov=e}get fov(){return this._camera.fov}get frustum(){return this._camera.frustum}set frustumCulling(e){this._camera.frustumCulling=e}get frustumCulling(){return this._camera.frustumCulling}set horizontalFov(e){this._camera.horizontalFov=e}get horizontalFov(){return this._camera.horizontalFov}set layers(e){const t=this._camera.layers;for(let e=0;e<t.length;e++){const s=this.system.app.scene.layers.getLayerById(t[e]);s&&s.removeCamera(this)}if(this._camera.layers=e,this.enabled&&this.entity.enabled)for(let t=0;t<e.length;t++){const s=this.system.app.scene.layers.getLayerById(e[t]);s&&s.addCamera(this)}}get layers(){return this._camera.layers}get layersSet(){return this._camera.layersSet}set jitter(e){this._camera.jitter=e}get jitter(){return this._camera.jitter}set nearClip(e){this._camera.nearClip=e}get nearClip(){return this._camera.nearClip}set orthoHeight(e){this._camera.orthoHeight=e}get orthoHeight(){return this._camera.orthoHeight}get postEffects(){return this._postEffects}get postEffectsEnabled(){return this._postEffects.enabled}set priority(e){this._priority=e,this.dirtyLayerCompositionCameras()}get priority(){return this._priority}set projection(e){this._camera.projection=e}get projection(){return this._camera.projection}get projectionMatrix(){return this._camera.projectionMatrix}set rect(e){this._camera.rect=e,this.fire("set:rect",this._camera.rect)}get rect(){return this._camera.rect}set renderSceneColorMap(e){e&&!this._sceneColorMapRequested?(this.requestSceneColorMap(!0),this._sceneColorMapRequested=!0):this._sceneColorMapRequested&&(this.requestSceneColorMap(!1),this._sceneColorMapRequested=!1)}get renderSceneColorMap(){return this._renderSceneColorMap>0}set renderSceneDepthMap(e){e&&!this._sceneDepthMapRequested?(this.requestSceneDepthMap(!0),this._sceneDepthMapRequested=!0):this._sceneDepthMapRequested&&(this.requestSceneDepthMap(!1),this._sceneDepthMapRequested=!1)}get renderSceneDepthMap(){return this._renderSceneDepthMap>0}set renderTarget(e){this._camera.renderTarget=e,this.dirtyLayerCompositionCameras()}get renderTarget(){return this._camera.renderTarget}set scissorRect(e){this._camera.scissorRect=e}get scissorRect(){return this._camera.scissorRect}set sensitivity(e){this._camera.sensitivity=e}get sensitivity(){return this._camera.sensitivity}set shutter(e){this._camera.shutter=e}get shutter(){return this._camera.shutter}get viewMatrix(){return this._camera.viewMatrix}_enableDepthLayer(e){if(this.layers.find((e=>1===e))){const t=this.system.app.scene.layers.getLayerById(1);e?null==t||t.incrementCounter():null==t||t.decrementCounter()}else if(e)return!1;return!0}requestSceneColorMap(e){this._renderSceneColorMap+=e?1:-1,this._enableDepthLayer(e),this.camera._enableRenderPassColorGrab(this.system.app.graphicsDevice,this.renderSceneColorMap)}requestSceneDepthMap(e){this._renderSceneDepthMap+=e?1:-1,this._enableDepthLayer(e),this.camera._enableRenderPassDepthGrab(this.system.app.graphicsDevice,this.system.app.renderer,this.renderSceneDepthMap)}dirtyLayerCompositionCameras(){this.system.app.scene.layers._dirty=!0}screenToWorld(e,t,s,i){const n=this.system.app.graphicsDevice,r=n.clientRect.width,a=n.clientRect.height;return this._camera.screenToWorld(e,t,s,r,a,i)}worldToScreen(e,t){const s=this.system.app.graphicsDevice,i=s.clientRect.width,n=s.clientRect.height;return this._camera.worldToScreen(e,i,n,t)}onAppPrerender(){this._camera._viewMatDirty=!0,this._camera._viewProjMatDirty=!0}addCameraToLayers(){const e=this.layers;for(let t=0;t<e.length;t++){const s=this.system.app.scene.layers.getLayerById(e[t]);s&&s.addCamera(this)}}removeCameraFromLayers(){const e=this.layers;for(let t=0;t<e.length;t++){const s=this.system.app.scene.layers.getLayerById(e[t]);s&&s.removeCamera(this)}}onLayersChanged(e,t){this.addCameraToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){this.layers.indexOf(e.id)<0||e.addCamera(this)}onLayerRemoved(e){this.layers.indexOf(e.id)<0||e.removeCamera(this)}onEnable(){var e;const t=this.system.app.scene,s=t.layers;var i,n;(this.system.addCamera(this),null==(e=this._evtLayersChanged)||e.off(),this._evtLayersChanged=t.on("set:layers",this.onLayersChanged,this),s)&&(null==(i=this._evtLayerAdded)||i.off(),this._evtLayerAdded=s.on("add",this.onLayerAdded,this),null==(n=this._evtLayerRemoved)||n.off(),this._evtLayerRemoved=s.on("remove",this.onLayerRemoved,this));this.enabled&&this.entity.enabled&&this.addCameraToLayers(),this.postEffects.enable()}onDisable(){var e;const t=this.system.app.scene.layers;var s,i;(this.postEffects.disable(),this.removeCameraFromLayers(),null==(e=this._evtLayersChanged)||e.off(),this._evtLayersChanged=null,t)&&(null==(s=this._evtLayerAdded)||s.off(),this._evtLayerAdded=null,null==(i=this._evtLayerRemoved)||i.off(),this._evtLayerRemoved=null);this.system.removeCamera(this)}onRemove(){this.onDisable(),this.off(),this.camera.destroy()}calculateAspectRatio(e){const t=this.system.app.graphicsDevice,s=e?e.width:t.width,i=e?e.height:t.height;return s*this.rect.z/(i*this.rect.w)}frameUpdate(e){0===this.aspectRatioMode&&(this.aspectRatio=this.calculateAspectRatio(e))}startXr(e,t,s){this.system.app.xr.start(this,e,t,s)}endXr(e){this._camera.xr?this._camera.xr.end(e):e&&e(new Error("Camera is not in XR"))}copy(e){this.aperture=e.aperture,this.aspectRatio=e.aspectRatio,this.aspectRatioMode=e.aspectRatioMode,this.calculateProjection=e.calculateProjection,this.calculateTransform=e.calculateTransform,this.clearColor=e.clearColor,this.clearColorBuffer=e.clearColorBuffer,this.clearDepthBuffer=e.clearDepthBuffer,this.clearStencilBuffer=e.clearStencilBuffer,this.cullFaces=e.cullFaces,this.disablePostEffectsLayer=e.disablePostEffectsLayer,this.farClip=e.farClip,this.flipFaces=e.flipFaces,this.fov=e.fov,this.frustumCulling=e.frustumCulling,this.horizontalFov=e.horizontalFov,this.layers=e.layers,this.nearClip=e.nearClip,this.orthoHeight=e.orthoHeight,this.priority=e.priority,this.projection=e.projection,this.rect=e.rect,this.renderTarget=e.renderTarget,this.scissorRect=e.scissorRect,this.sensitivity=e.sensitivity,this.shutter=e.shutter}}class jm{constructor(){this.enabled=!0}}const Wm=["enabled"];class $m extends Nf{constructor(e){super(e),this.cameras=[],this.id="camera",this.ComponentType=Hm,this.DataType=jm,this.schema=Wm,this.on("beforeremove",this.onBeforeRemove,this),this.app.on("prerender",this.onAppPrerender,this),this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(e,t,s){s=["aspectRatio","aspectRatioMode","calculateProjection","calculateTransform","clearColor","clearColorBuffer","clearDepthBuffer","clearStencilBuffer","renderSceneColorMap","renderSceneDepthMap","cullFaces","farClip","flipFaces","fov","frustumCulling","horizontalFov","layers","renderTarget","nearClip","orthoHeight","projection","priority","rect","scissorRect","aperture","shutter","sensitivity","gammaCorrection","toneMapping"];for(let i=0;i<s.length;i++){const n=s[i];if(t.hasOwnProperty(n)){const s=t[n];switch(n){case"rect":case"scissorRect":Array.isArray(s)?e[n]=new Ss(s[0],s[1],s[2],s[3]):e[n]=s;break;case"clearColor":Array.isArray(s)?e[n]=new os(s[0],s[1],s[2],s[3]):e[n]=s;break;default:e[n]=s}}}super.initializeComponentData(e,t,["enabled"])}cloneComponent(e,t){const s=e.camera;return this.addComponent(t,{aspectRatio:s.aspectRatio,aspectRatioMode:s.aspectRatioMode,calculateProjection:s.calculateProjection,calculateTransform:s.calculateTransform,clearColor:s.clearColor,clearColorBuffer:s.clearColorBuffer,clearDepthBuffer:s.clearDepthBuffer,clearStencilBuffer:s.clearStencilBuffer,renderSceneDepthMap:s.renderSceneDepthMap,renderSceneColorMap:s.renderSceneColorMap,cullFaces:s.cullFaces,enabled:s.enabled,farClip:s.farClip,flipFaces:s.flipFaces,fov:s.fov,frustumCulling:s.frustumCulling,horizontalFov:s.horizontalFov,layers:s.layers,renderTarget:s.renderTarget,nearClip:s.nearClip,orthoHeight:s.orthoHeight,projection:s.projection,priority:s.priority,rect:s.rect,scissorRect:s.scissorRect,aperture:s.aperture,sensitivity:s.sensitivity,shutter:s.shutter,gammaCorrection:s.gammaCorrection,toneMapping:s.toneMapping})}onBeforeRemove(e,t){this.removeCamera(t),t.onRemove()}onUpdate(e){}onAppPrerender(){for(let e=0,t=this.cameras.length;e<t;e++)this.cameras[e].onAppPrerender()}addCamera(e){this.cameras.push(e),fd(this.cameras)}removeCamera(e){const t=this.cameras.indexOf(e);t>=0&&(this.cameras.splice(t,1),fd(this.cameras))}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}zf._buildAccessors(Hm.prototype,Wm);class qm{constructor(){this.enabled=!0,this.light=void 0,this.type="directional",this.color=new os(1,1,1),this.intensity=1,this.luminance=0,this.shape=0,this.affectSpecularity=!0,this.castShadows=!1,this.shadowDistance=40,this.shadowIntensity=1,this.shadowResolution=1024,this.shadowBias=.05,this.numCascades=1,this.bakeNumSamples=1,this.bakeArea=0,this.cascadeDistribution=.5,this.normalOffsetBias=0,this.range=10,this.innerConeAngle=40,this.outerConeAngle=45,this.falloffMode=0,this.shadowType=0,this.vsmBlurSize=11,this.vsmBlurMode=1,this.vsmBias=.0025,this.cookieAsset=null,this.cookie=null,this.cookieIntensity=1,this.cookieFalloff=!0,this.cookieChannel="rgb",this.cookieAngle=0,this.cookieScale=null,this.cookieOffset=null,this.shadowUpdateMode=2,this.mask=1,this.affectDynamic=!0,this.affectLightmapped=!1,this.bake=!1,this.bakeDir=!0,this.isStatic=!1,this.layers=[0],this.penumbraSize=1}}const Xm=Object.keys(new qm);class Km extends zf{constructor(e,t){super(e,t),this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._cookieAsset=null,this._cookieAssetId=null,this._cookieAssetAdd=!1,this._cookieMatrix=null}get data(){const e=this.system.store[this.entity.getGuid()];return e?e.data:null}set enabled(e){this._setValue("enabled",e,(function(e,t){this.onSetEnabled(null,t,e)}))}get enabled(){return this.data.enabled}set light(e){this._setValue("light",e)}get light(){return this.data.light}set type(e){this._setValue("type",e,(function(e,t){this.system.changeType(this,t,e),this.refreshProperties()}))}get type(){return this.data.type}set color(e){this._setValue("color",e,(function(e,t){this.light.setColor(e)}),!0)}get color(){return this.data.color}set intensity(e){this._setValue("intensity",e,(function(e,t){this.light.intensity=e}))}get intensity(){return this.data.intensity}set luminance(e){this._setValue("luminance",e,(function(e,t){this.light.luminance=e}))}get luminance(){return this.data.luminance}set shape(e){this._setValue("shape",e,(function(e,t){this.light.shape=e}))}get shape(){return this.data.shape}set affectSpecularity(e){this._setValue("affectSpecularity",e,(function(e,t){this.light.affectSpecularity=e}))}get affectSpecularity(){return this.data.affectSpecularity}set castShadows(e){this._setValue("castShadows",e,(function(e,t){this.light.castShadows=e}))}get castShadows(){return this.data.castShadows}set shadowDistance(e){this._setValue("shadowDistance",e,(function(e,t){this.light.shadowDistance=e}))}get shadowDistance(){return this.data.shadowDistance}set shadowIntensity(e){this._setValue("shadowIntensity",e,(function(e,t){this.light.shadowIntensity=e}))}get shadowIntensity(){return this.data.shadowIntensity}set shadowResolution(e){this._setValue("shadowResolution",e,(function(e,t){this.light.shadowResolution=e}))}get shadowResolution(){return this.data.shadowResolution}set shadowBias(e){this._setValue("shadowBias",e,(function(e,t){this.light.shadowBias=-.01*rs.clamp(e,0,1)}))}get shadowBias(){return this.data.shadowBias}set numCascades(e){this._setValue("numCascades",e,(function(e,t){this.light.numCascades=rs.clamp(Math.floor(e),1,4)}))}get numCascades(){return this.data.numCascades}set bakeNumSamples(e){this._setValue("bakeNumSamples",e,(function(e,t){this.light.bakeNumSamples=rs.clamp(Math.floor(e),1,255)}))}get bakeNumSamples(){return this.data.bakeNumSamples}set bakeArea(e){this._setValue("bakeArea",e,(function(e,t){this.light.bakeArea=rs.clamp(e,0,180)}))}get bakeArea(){return this.data.bakeArea}set cascadeDistribution(e){this._setValue("cascadeDistribution",e,(function(e,t){this.light.cascadeDistribution=rs.clamp(e,0,1)}))}get cascadeDistribution(){return this.data.cascadeDistribution}set normalOffsetBias(e){this._setValue("normalOffsetBias",e,(function(e,t){this.light.normalOffsetBias=rs.clamp(e,0,1)}))}get normalOffsetBias(){return this.data.normalOffsetBias}set range(e){this._setValue("range",e,(function(e,t){this.light.attenuationEnd=e}))}get range(){return this.data.range}set innerConeAngle(e){this._setValue("innerConeAngle",e,(function(e,t){this.light.innerConeAngle=e}))}get innerConeAngle(){return this.data.innerConeAngle}set outerConeAngle(e){this._setValue("outerConeAngle",e,(function(e,t){this.light.outerConeAngle=e}))}get outerConeAngle(){return this.data.outerConeAngle}set falloffMode(e){this._setValue("falloffMode",e,(function(e,t){this.light.falloffMode=e}))}get falloffMode(){return this.data.falloffMode}set shadowType(e){this._setValue("shadowType",e,(function(e,t){this.light.shadowType=e}))}get shadowType(){return this.data.shadowType}set vsmBlurSize(e){this._setValue("vsmBlurSize",e,(function(e,t){this.light.vsmBlurSize=e}))}get vsmBlurSize(){return this.data.vsmBlurSize}set vsmBlurMode(e){this._setValue("vsmBlurMode",e,(function(e,t){this.light.vsmBlurMode=e}))}get vsmBlurMode(){return this.data.vsmBlurMode}set vsmBias(e){this._setValue("vsmBias",e,(function(e,t){this.light.vsmBias=rs.clamp(e,0,1)}))}get vsmBias(){return this.data.vsmBias}set cookieAsset(e){this._setValue("cookieAsset",e,(function(e,t){if(!this._cookieAssetId||!(e instanceof ef&&e.id===this._cookieAssetId||e===this._cookieAssetId))if(this.onCookieAssetRemove(),this._cookieAssetId=null,e instanceof ef)this.data.cookieAsset=e.id,this._cookieAssetId=e.id,this.onCookieAssetAdd(e);else if("number"==typeof e){this._cookieAssetId=e;const t=this.system.app.assets.get(e);t?this.onCookieAssetAdd(t):(this._cookieAssetAdd=!0,this.system.app.assets.on(`add:${this._cookieAssetId}`,this.onCookieAssetAdd,this))}}))}get cookieAsset(){return this.data.cookieAsset}set cookie(e){this._setValue("cookie",e,(function(e,t){this.light.cookie=e}))}get cookie(){return this.data.cookie}set cookieIntensity(e){this._setValue("cookieIntensity",e,(function(e,t){this.light.cookieIntensity=rs.clamp(e,0,1)}))}get cookieIntensity(){return this.data.cookieIntensity}set cookieFalloff(e){this._setValue("cookieFalloff",e,(function(e,t){this.light.cookieFalloff=e}))}get cookieFalloff(){return this.data.cookieFalloff}set cookieChannel(e){this._setValue("cookieChannel",e,(function(e,t){this.light.cookieChannel=e}))}get cookieChannel(){return this.data.cookieChannel}set cookieAngle(e){this._setValue("cookieAngle",e,(function(e,t){if(0!==e||null!==this.cookieScale){this._cookieMatrix||(this._cookieMatrix=new Ss);let t=1,s=1;this.cookieScale&&(t=this.cookieScale.x,s=this.cookieScale.y);const i=Math.cos(e*rs.DEG_TO_RAD),n=Math.sin(e*rs.DEG_TO_RAD);this._cookieMatrix.set(i/t,-n/t,n/s,i/s),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null}))}get cookieAngle(){return this.data.cookieAngle}set cookieScale(e){this._setValue("cookieScale",e,(function(e,t){if(null!==e||0!==this.cookieAngle){this._cookieMatrix||(this._cookieMatrix=new Ss);const t=e.x,s=e.y,i=Math.cos(this.cookieAngle*rs.DEG_TO_RAD),n=Math.sin(this.cookieAngle*rs.DEG_TO_RAD);this._cookieMatrix.set(i/t,-n/t,n/s,i/s),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null}),!0)}get cookieScale(){return this.data.cookieScale}set cookieOffset(e){this._setValue("cookieOffset",e,(function(e,t){this.light.cookieOffset=e}),!0)}get cookieOffset(){return this.data.cookieOffset}set shadowUpdateMode(e){this._setValue("shadowUpdateMode",e,(function(e,t){this.light.shadowUpdateMode=e}),!0)}get shadowUpdateMode(){return this.data.shadowUpdateMode}set mask(e){this._setValue("mask",e,(function(e,t){this.light.mask=e}))}get mask(){return this.data.mask}set affectDynamic(e){this._setValue("affectDynamic",e,(function(e,t){e?this.light.mask|=1:this.light.mask&=-2,this.light.layersDirty()}))}get affectDynamic(){return this.data.affectDynamic}set affectLightmapped(e){this._setValue("affectLightmapped",e,(function(e,t){e?(this.light.mask|=2,this.bake&&(this.light.mask&=-5)):(this.light.mask&=-3,this.bake&&(this.light.mask|=4))}))}get affectLightmapped(){return this.data.affectLightmapped}set bake(e){this._setValue("bake",e,(function(e,t){e?(this.light.mask|=4,this.affectLightmapped&&(this.light.mask&=-3)):(this.light.mask&=-5,this.affectLightmapped&&(this.light.mask|=2)),this.light.layersDirty()}))}get bake(){return this.data.bake}set bakeDir(e){this._setValue("bakeDir",e,(function(e,t){this.light.bakeDir=e}))}get bakeDir(){return this.data.bakeDir}set isStatic(e){this._setValue("isStatic",e,(function(e,t){this.light.isStatic=e}))}get isStatic(){return this.data.isStatic}set layers(e){this._setValue("layers",e,(function(e,t){for(let e=0;e<t.length;e++){const s=this.system.app.scene.layers.getLayerById(t[e]);s&&(s.removeLight(this),this.light.removeLayer(s))}for(let t=0;t<e.length;t++){const s=this.system.app.scene.layers.getLayerById(e[t]);s&&(this.enabled&&this.entity.enabled&&(s.addLight(this),this.light.addLayer(s)))}}))}get layers(){return this.data.layers}set shadowUpdateOverrides(e){this.light.shadowUpdateOverrides=e}get shadowUpdateOverrides(){return this.light.shadowUpdateOverrides}set penumbraSize(e){this.light.penumbraSize=e}get penumbraSize(){return this.light.penumbraSize}_setValue(e,t,s,i){const n=this.data,r=n[e];(i||r!==t)&&(n[e]=t,s&&s.call(this,t,r))}addLightToLayers(){for(let e=0;e<this.layers.length;e++){const t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&(t.addLight(this),this.light.addLayer(t))}}removeLightFromLayers(){for(let e=0;e<this.layers.length;e++){const t=this.system.app.scene.layers.getLayerById(this.layers[e]);t&&(t.removeLight(this),this.light.removeLayer(t))}}onLayersChanged(e,t){this.enabled&&this.entity.enabled&&this.addLightToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){this.layers.indexOf(e.id)>=0&&this.enabled&&this.entity.enabled&&(e.addLight(this),this.light.addLayer(e))}onLayerRemoved(e){this.layers.indexOf(e.id)>=0&&(e.removeLight(this),this.light.removeLayer(e))}refreshProperties(){for(let e=0;e<Xm.length;e++){const t=Xm[e];this[t]=this[t]}this.enabled&&this.entity.enabled&&this.onEnable()}onCookieAssetSet(){let e=!1;"cubemap"!==this._cookieAsset.type||this._cookieAsset.loadFaces||(this._cookieAsset.loadFaces=!0,e=!0),this._cookieAsset.resource&&!e||this.system.app.assets.load(this._cookieAsset),this._cookieAsset.resource&&this.onCookieAssetLoad()}onCookieAssetAdd(e){this._cookieAssetId===e.id&&(this._cookieAsset=e,this.light.enabled&&this.onCookieAssetSet(),this._cookieAsset.on("load",this.onCookieAssetLoad,this),this._cookieAsset.on("remove",this.onCookieAssetRemove,this))}onCookieAssetLoad(){this._cookieAsset&&this._cookieAsset.resource&&(this.cookie=this._cookieAsset.resource)}onCookieAssetRemove(){this._cookieAssetId&&(this._cookieAssetAdd&&(this.system.app.assets.off(`add:${this._cookieAssetId}`,this.onCookieAssetAdd,this),this._cookieAssetAdd=!1),this._cookieAsset&&(this._cookieAsset.off("load",this.onCookieAssetLoad,this),this._cookieAsset.off("remove",this.onCookieAssetRemove,this),this._cookieAsset=null),this.cookie=null)}onEnable(){const e=this.system.app.scene,t=e.layers;this.light.enabled=!0,this._evtLayersChanged=e.on("set:layers",this.onLayersChanged,this),t&&(this._evtLayerAdded=t.on("add",this.onLayerAdded,this),this._evtLayerRemoved=t.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&this.addLightToLayers(),this._cookieAsset&&!this.cookie&&this.onCookieAssetSet()}onDisable(){var e;const t=this.system.app.scene.layers;var s,i;(this.light.enabled=!1,null==(e=this._evtLayersChanged)||e.off(),this._evtLayersChanged=null,t)&&(null==(s=this._evtLayerAdded)||s.off(),this._evtLayerAdded=null,null==(i=this._evtLayerRemoved)||i.off(),this._evtLayerRemoved=null);this.removeLightFromLayers()}onRemove(){this.onDisable(),this.light.destroy(),this.cookieAsset=null}}class Ym extends Nf{constructor(e){super(e),this.id="light",this.ComponentType=Km,this.DataType=qm,this.on("beforeremove",this._onRemoveComponent,this)}initializeComponentData(e,t){const s=kn({},t);s.type||(s.type=e.data.type),e.data.type=s.type,s.layers&&Array.isArray(s.layers)&&(s.layers=s.layers.slice(0)),s.color&&Array.isArray(s.color)&&(s.color=new os(s.color[0],s.color[1],s.color[2])),s.cookieOffset&&s.cookieOffset instanceof Array&&(s.cookieOffset=new ws(s.cookieOffset[0],s.cookieOffset[1])),s.cookieScale&&s.cookieScale instanceof Array&&(s.cookieScale=new ws(s.cookieScale[0],s.cookieScale[1])),s.enable&&(console.warn("WARNING: enable: Property is deprecated. Set enabled property instead."),s.enabled=s.enable),s.shape||(s.shape=0);const i=new Cd(this.app.graphicsDevice,this.app.scene.clusteredLightingEnabled);i.type=yd[s.type],i._node=e.entity,e.data.light=i,super.initializeComponentData(e,s,Xm)}_onRemoveComponent(e,t){t.onRemove()}cloneComponent(e,t){const s=e.light,i=[];let n;for(let e=0;e<Xm.length;e++)n=Xm[e],"light"!==n&&(s[n]&&s[n].clone?i[n]=s[n].clone():i[n]=s[n]);return this.addComponent(t,i)}changeType(e,t,s){t!==s&&(e.light.type=yd[s])}}const Qm=["x","y","z","w"],Jm=[void 0,void 0,ws,ys,Ss];function Zm(e,t,s,i){switch(t.type){case"boolean":return!!s;case"number":if("number"==typeof s)return s;if("string"==typeof s){const e=parseInt(s,10);return isNaN(e)?null:e}return"boolean"==typeof s?0+s:null;case"json":{const i={};if(Array.isArray(t.schema)){s&&"object"==typeof s||(s={});for(let n=0;n<t.schema.length;n++){const r=t.schema[n];if(r.name)if(r.array){i[r.name]=[];const t=Array.isArray(s[r.name])?s[r.name]:[];for(let s=0;s<t.length;s++)i[r.name].push(Zm(e,r,t[s]))}else{const t=s.hasOwnProperty(r.name)?s[r.name]:r.default;i[r.name]=Zm(e,r,t)}}}return i}case"asset":return s instanceof ef?s:"number"==typeof s?e.assets.get(s)||null:"string"==typeof s&&e.assets.get(parseInt(s,10))||null;case"entity":return s instanceof vh?s:"string"==typeof s?e.getEntityFromIndex(s):null;case"rgb":case"rgba":if(s instanceof os)return i instanceof os?(i.copy(s),i):s.clone();if(s instanceof Array&&s.length>=3&&s.length<=4){for(let e=0;e<s.length;e++)if("number"!=typeof s[e])return null;return i||(i=new os),i.r=s[0],i.g=s[1],i.b=s[2],i.a=3===s.length?1:s[3],i}return"string"==typeof s&&/#(?:[0-9a-f]{2}){3,4}/i.test(s)?(i||(i=new os),i.fromString(s),i):null;case"vec2":case"vec3":case"vec4":{const e=parseInt(t.type.slice(3),10),n=Jm[e];if(s instanceof n)return i instanceof n?(i.copy(s),i):s.clone();if(s instanceof Array&&s.length===e){for(let e=0;e<s.length;e++)if("number"!=typeof s[e])return null;i||(i=new n);for(let t=0;t<e;t++)i[Qm[t]]=s[t];return i}return null}case"curve":if(s){let e;if(s instanceof hs||s instanceof cs)e=s.clone();else{e=new(s.keys[0]instanceof Array?cs:hs)(s.keys),e.type=s.type}return e}}return s}function eg(e,t,s,i){return t.array?s.map(((s,n)=>Zm(e,t,s,i?i[n]:null))):Zm(e,t,s,i)}function tg(e,t,s,i){if(s)for(const n in t){const r=t[n],a=s[n];void 0!==a&&(i[n]=eg(e,r,a,i[n]))}}class sg{constructor(e){this.scriptType=e,this.index={}}add(e,t){this.index[e]||sg.reservedNames.has(e)||(this.index[e]=t,Object.defineProperty(this.scriptType.prototype,e,{get:function(){return this.__attributes[e]},set:function(s){const i="attr",n=`attr:${e}`,r=this.__attributes[e];let a=r;if(r&&"json"!==t.type&&"entity"!==t.type&&r.clone&&(this.hasEvent(i)||this.hasEvent(n))&&(a=r.clone()),t.array){if(this.__attributes[e]=[],s)for(let i=0,n=s.length;i<n;i++)this.__attributes[e].push(Zm(this.app,t,s[i],r?r[i]:null))}else this.__attributes[e]=Zm(this.app,t,s,r);this.fire(i,e,this.__attributes[e],a),this.fire(n,this.__attributes[e],a)}}))}remove(e){return!!this.index[e]&&(delete this.index[e],delete this.scriptType.prototype[e],!0)}has(e){return!!this.index[e]}get(e){return this.index[e]||null}}sg.assignAttributesToScript=tg,sg.attributeToValue=eg,sg.reservedNames=new Set(["app","entity","enabled","_enabled","_enabledOld","_destroyed","__attributes","__attributesRaw","__scriptType","__executionOrder","_callbacks","_callbackActive","has","get","on","off","fire","once","hasEvent"]);const ig="initialize",ng="postInitialize";class rg extends Kt{constructor(e){super(),this.app=void 0,this.entity=void 0,this._enabled=void 0,this._enabledOld=void 0,this._initialized=void 0,this._postInitialized=void 0,this.__destroyed=void 0,this.__scriptType=void 0,this.__executionOrder=void 0,this.initScript(e)}set enabled(e){this._enabled=!!e,this.enabled!==this._enabledOld&&(this._enabledOld=this.enabled,this.fire(this.enabled?"enable":"disable"),this.fire("state",this.enabled),!this._initialized&&this.enabled&&(this._initialized=!0,this.fire("preInitialize"),this.initialize&&this.entity.script._scriptMethod(this,ig)),this._initialized&&!this._postInitialized&&this.enabled&&!this.entity.script._beingEnabled&&(this._postInitialized=!0,this.postInitialize&&this.entity.script._scriptMethod(this,ng)))}get enabled(){return this._enabled&&!this._destroyed&&this.entity.script.enabled&&this.entity.enabled}initScript(e){const t=this.constructor;this.app=e.app,this.entity=e.entity,this._enabled="boolean"!=typeof e.enabled||e.enabled,this._enabledOld=this.enabled,this.__destroyed=!1,this.__scriptType=t,this.__executionOrder=-1}static get scriptName(){return this.__name}}rg.EVENT_ENABLE="enable",rg.EVENT_DISABLE="disable",rg.EVENT_STATE="state",rg.EVENT_DESTROY="destroy",rg.EVENT_ATTR="attr",rg.EVENT_ERROR="error",rg.__name=null,rg.__getScriptName=og;const ag=/^\s*function(?:\s|\s*\/\*.*\*\/\s*)+([^(\s\/]*)\s*/;function og(e){if("function"!=typeof e)return;if("name"in Function.prototype)return e.name;if(e===Function||e===Function.prototype.constructor)return"Function";const t=`${e}`.match(ag);return t?t[1]:void 0}class lg extends rg{constructor(e){super(e),this.__attributes=void 0,this.__attributesRaw=void 0,this.initScriptType(e)}static get attributes(){return this.hasOwnProperty("__attributes")||(this.__attributes=new sg(this)),this.__attributes}initScript(e){rg.prototype.initScript.call(this,e),this.__attributes={},this.__attributesRaw=e.attributes||{}}initScriptType(e){this.initScript(e)}__initializeAttributes(e){if(e||this.__attributesRaw){for(const e in this.__scriptType.attributes.index)this.__attributesRaw&&this.__attributesRaw.hasOwnProperty(e)?this[e]=this.__attributesRaw[e]:this.__attributes.hasOwnProperty(e)||(this.__scriptType.attributes.index[e].hasOwnProperty("default")?this[e]=this.__scriptType.attributes.index[e].default:this[e]=null);this.__attributesRaw=null}}static extend(e){for(const t in e)e.hasOwnProperty(t)&&(this.prototype[t]=e[t])}}class hg extends zf{constructor(e,t){super(e,t),this._attributeDataMap=new Map,this._scripts=[],this._updateList=new Zt({sortBy:"__executionOrder"}),this._postUpdateList=new Zt({sortBy:"__executionOrder"}),this._scriptsIndex={},this._destroyedScripts=[],this._destroyed=!1,this._scriptsData=null,this._oldState=!0,this._enabled=!0,this._beingEnabled=!1,this._isLoopingThroughScripts=!1,this._executionOrder=-1,this.on("set_enabled",this._onSetEnabled,this)}set scripts(e){this._scriptsData=e;for(const t in e){if(!e.hasOwnProperty(t))continue;const s=this._scriptsIndex[t];if(s){if("boolean"==typeof e[t].enabled&&(s.once("preInitialize",(()=>{this.initializeAttributes(s)})),s.enabled=!!e[t].enabled),"object"==typeof e[t].attributes)for(const i in e[t].attributes)if(!sg.reservedNames.has(i)){if(!s.__attributes.hasOwnProperty(i)){const e=this.system.app.scripts.get(t);e&&e.attributes.add(i,{})}s[i]=e[t].attributes[i]}}else console.log(this.order)}}get scripts(){return this._scripts}set enabled(e){const t=this._enabled;this._enabled=e,this.fire("set","enabled",t,e)}get enabled(){return this._enabled}onEnable(){this._beingEnabled=!0,this._checkState(),this.entity._beingEnabled||this.onPostStateChange(),this._beingEnabled=!1}onDisable(){this._checkState()}onPostStateChange(){const e=this._beginLooping();for(let e=0,t=this.scripts.length;e<t;e++){const t=this.scripts[e];t._initialized&&!t._postInitialized&&t.enabled&&(t._postInitialized=!0,t.postInitialize&&this._scriptMethod(t,ng))}this._endLooping(e)}_beginLooping(){const e=this._isLoopingThroughScripts;return this._isLoopingThroughScripts=!0,e}_endLooping(e){this._isLoopingThroughScripts=e,this._isLoopingThroughScripts||this._removeDestroyedScripts()}_onSetEnabled(e,t,s){this._beingEnabled=!0,this._checkState(),this._beingEnabled=!1}_checkState(){const e=this.enabled&&this.entity.enabled;if(e===this._oldState)return;this._oldState=e,this.fire(e?"enable":"disable"),this.fire("state",e),e?this.system._addComponentToEnabled(this):this.system._removeComponentFromEnabled(this);const t=this._beginLooping();for(let e=0,t=this.scripts.length;e<t;e++){const t=this.scripts[e];t.once("preInitialize",(()=>{this.initializeAttributes(t)})),t.enabled=t._enabled}this._endLooping(t)}_onBeforeRemove(){this.fire("remove");const e=this._beginLooping();for(let e=0;e<this.scripts.length;e++){const t=this.scripts[e];t&&this.destroy(t.__scriptType.__name)}this._endLooping(e)}_removeDestroyedScripts(){const e=this._destroyedScripts.length;if(e){for(let t=0;t<e;t++){const e=this._destroyedScripts[t];this._removeScriptInstance(e)}this._destroyedScripts.length=0,this._resetExecutionOrder(0,this._scripts.length)}}_onInitializeAttributes(){for(let e=0,t=this.scripts.length;e<t;e++){const t=this.scripts[e];this.initializeAttributes(t)}}initializeAttributes(e){if(e instanceof lg)e.__initializeAttributes();else{var t;const s=e.__scriptType.__name,i=this._attributeDataMap.get(s);if(!i)return;const n=null==(t=this.system.app.scripts)?void 0:t.getSchema(s);tg(this.system.app,n.attributes,i,e)}}_scriptMethod(e,t,s){e[t](s)}_onInitialize(){const e=this._scripts,t=this._beginLooping();for(let t=0,s=e.length;t<s;t++){const s=e[t];!s._initialized&&s.enabled&&(s._initialized=!0,s.initialize&&this._scriptMethod(s,ig))}this._endLooping(t)}_onPostInitialize(){this.onPostStateChange()}_onUpdate(e){const t=this._updateList;if(!t.length)return;const s=this._beginLooping();for(t.loopIndex=0;t.loopIndex<t.length;t.loopIndex++){const s=t.items[t.loopIndex];s.enabled&&this._scriptMethod(s,"update",e)}this._endLooping(s)}_onPostUpdate(e){const t=this._postUpdateList;if(!t.length)return;const s=this._beginLooping();for(t.loopIndex=0;t.loopIndex<t.length;t.loopIndex++){const s=t.items[t.loopIndex];s.enabled&&this._scriptMethod(s,"postUpdate",e)}this._endLooping(s)}_insertScriptInstance(e,t,s){-1===t?(this._scripts.push(e),e.__executionOrder=s,e.update&&this._updateList.append(e),e.postUpdate&&this._postUpdateList.append(e)):(this._scripts.splice(t,0,e),e.__executionOrder=t,this._resetExecutionOrder(t+1,s+1),e.update&&this._updateList.insert(e),e.postUpdate&&this._postUpdateList.insert(e))}_removeScriptInstance(e){const t=this._scripts.indexOf(e);return-1===t||(this._scripts.splice(t,1),e.update&&this._updateList.remove(e),e.postUpdate&&this._postUpdateList.remove(e)),t}_resetExecutionOrder(e,t){for(let s=e;s<t;s++)this._scripts[s].__executionOrder=s}_resolveEntityScriptAttribute(e,t,s,i,n,r){if(e.array){const e=s.length;if(!e)return;const a=s.slice();for(let t=0;t<e;t++){const e=a[t]instanceof vf?a[t].getGuid():a[t];r[e]&&(a[t]=i?r[e].getGuid():r[e])}n[t]=a}else{if(s instanceof vf)s=s.getGuid();else if("string"!=typeof s)return;r[s]&&(n[t]=r[s])}}has(e){if("string"==typeof e)return!!this._scriptsIndex[e];if(!e)return!1;const t=e,s=t.__name,i=this._scriptsIndex[s];return(i&&i.instance)instanceof t}get(e){if("string"==typeof e){const t=this._scriptsIndex[e];return t?t.instance:null}if(!e)return null;const t=e,s=t.__name,i=this._scriptsIndex[s],n=i&&i.instance;return n instanceof t?n:null}create(e,t={}){const s=this;let i=e,n=e;if("string"==typeof i)i=this.system.app.scripts.get(i);else if(i){var r;n=null!=(r=i.__name)?r:(a=og(i))[0].toLowerCase()+a.substring(1)}var a;if(i){if(!this._scriptsIndex[n]||!this._scriptsIndex[n].instance){const e=new i({app:this.system.app,entity:this.entity,enabled:!t.hasOwnProperty("enabled")||t.enabled,attributes:t.attributes||{}});t.properties&&"object"==typeof t.properties&&Object.assign(e,t.properties),e instanceof lg||this._attributeDataMap.set(n,t.attributes);const r=this._scripts.length;let a=-1;return"number"==typeof t.ind&&-1!==t.ind&&r>t.ind&&(a=t.ind),this._insertScriptInstance(e,a,r),this._scriptsIndex[n]={instance:e,onSwap:function(){s.swap(n)}},this[n]=e,t.preloading||this.initializeAttributes(e),this.fire("create",n,e),this.fire(`create:${n}`,e),this.system.app.scripts.on(`swap:${n}`,this._scriptsIndex[n].onSwap),t.preloading||(e.enabled&&!e._initialized&&(e._initialized=!0,e.initialize&&this._scriptMethod(e,ig)),e.enabled&&!e._postInitialized&&(e._postInitialized=!0,e.postInitialize&&this._scriptMethod(e,ng))),e}}else this._scriptsIndex[n]={awaiting:!0,ind:this._scripts.length};return null}destroy(e){let t=e,s=e;"string"==typeof s?s=this.system.app.scripts.get(s):s&&(t=s.__name);const i=this._scriptsIndex[t];if(delete this._scriptsIndex[t],!i)return!1;this._attributeDataMap.delete(t);const n=i.instance;if(n&&!n._destroyed)if(n.enabled=!1,n._destroyed=!0,this._isLoopingThroughScripts)this._destroyedScripts.push(n);else{const e=this._removeScriptInstance(n);e>=0&&this._resetExecutionOrder(e,this._scripts.length)}return this.system.app.scripts.off(`swap:${t}`,i.onSwap),delete this[t],this.fire("destroy",t,n||null),this.fire(`destroy:${t}`,n||null),n&&n.fire("destroy"),!0}swap(e){let t=e,s=e;"string"==typeof s?s=this.system.app.scripts.get(s):s&&(t=s.__name);const i=this._scriptsIndex[t];if(!i||!i.instance)return!1;const n=i.instance,r=this._scripts.indexOf(n),a=new s({app:this.system.app,entity:this.entity,enabled:n.enabled,attributes:n.__attributes});return!!a.swap&&(this.initializeAttributes(a),this._scripts[r]=a,this._scriptsIndex[t].instance=a,this[t]=a,a.__executionOrder=r,n.update&&this._updateList.remove(n),n.postUpdate&&this._postUpdateList.remove(n),a.update&&this._updateList.insert(a),a.postUpdate&&this._postUpdateList.insert(a),this._scriptMethod(a,"swap",n),this.fire("swap",t,a),this.fire(`swap:${t}`,a),!0)}resolveDuplicatedEntityReferenceProperties(e,t){const s=this.entity.script;for(const i in e._scriptsIndex){const n=this.system.app.scripts.get(i);if(!n)continue;const r=e._scriptsIndex[i];if(!r||!r.instance)continue;const a=s[i].__attributesRaw,o=s[i].__attributes;if(!a&&!o)continue;const l=!!a,h=r.instance.__attributes;for(const e in h){if(!h[e])continue;const s=n.attributes.get(e);if(s)if("entity"===s.type)this._resolveEntityScriptAttribute(s,e,h[e],l,a||o,t);else if("json"===s.type&&Array.isArray(s.schema)){const i=h[e],n=a?a[e]:o[e];for(let e=0;e<s.schema.length;e++){const r=s.schema[e];if("entity"===r.type)if(s.array)for(let e=0;e<i.length;e++)this._resolveEntityScriptAttribute(r,r.name,i[e][r.name],l,n[e],t);else this._resolveEntityScriptAttribute(r,r.name,i[r.name],l,n,t)}}}}}move(e,t){const s=this._scripts.length;if(t>=s||t<0)return!1;let i=e,n=e;"string"!=typeof n?n=e.__name:i=null;const r=this._scriptsIndex[n];if(!r||!r.instance)return!1;const a=r.instance;if(i&&!(a instanceof i))return!1;const o=this._scripts.indexOf(a);return-1!==o&&o!==t&&(this._scripts.splice(t,0,this._scripts.splice(o,1)[0]),this._resetExecutionOrder(0,s),this._updateList.sort(),this._postUpdateList.sort(),this.fire("move",n,a,t,o),this.fire(`move:${n}`,a,t,o),!0)}}hg.EVENT_CREATE="create",hg.EVENT_DESTROY="destroy",hg.EVENT_ENABLE="enable",hg.EVENT_DISABLE="disable",hg.EVENT_REMOVE="remove",hg.EVENT_STATE="state",hg.EVENT_MOVE="move",hg.EVENT_ERROR="error";class cg{constructor(){this.enabled=!0}}let dg=0;class ug extends Nf{constructor(e){super(e),this.id="script",this.ComponentType=hg,this.DataType=cg,this._components=new Zt({sortBy:"_executionOrder"}),this._enabledComponents=new Zt({sortBy:"_executionOrder"}),this.preloading=!0,this.on("beforeremove",this._onBeforeRemove,this),this.app.systems.on("initialize",this._onInitialize,this),this.app.systems.on("postInitialize",this._onPostInitialize,this),this.app.systems.on("update",this._onUpdate,this),this.app.systems.on("postUpdate",this._onPostUpdate,this)}initializeComponentData(e,t){if(e._executionOrder=dg++,this._components.append(e),dg>Number.MAX_SAFE_INTEGER&&this._resetExecutionOrder(),e.enabled=!t.hasOwnProperty("enabled")||!!t.enabled,e.enabled&&e.entity.enabled&&this._enabledComponents.append(e),t.hasOwnProperty("order")&&t.hasOwnProperty("scripts")){e._scriptsData=t.scripts;for(let s=0;s<t.order.length;s++)e.create(t.order[s],{enabled:t.scripts[t.order[s]].enabled,attributes:t.scripts[t.order[s]].attributes,preloading:this.preloading})}}cloneComponent(e,t){const s=[],i={};for(let t=0;t<e.script._scripts.length;t++){const n=e.script._scripts[t],r=n.__scriptType.__name;s.push(r);const a={};for(const e in n.__attributes)a[e]=n.__attributes[e];i[r]={enabled:n._enabled,attributes:a}}for(const t in e.script._scriptsIndex)t.awaiting&&s.splice(t.ind,0,t);const n={enabled:e.script.enabled,order:s,scripts:i};return this.addComponent(t,n)}_resetExecutionOrder(){dg=0;for(let e=0,t=this._components.length;e<t;e++)this._components.items[e]._executionOrder=dg++}_callComponentMethod(e,t,s){for(e.loopIndex=0;e.loopIndex<e.length;e.loopIndex++)e.items[e.loopIndex][t](s)}_onInitialize(){this.preloading=!1,this._callComponentMethod(this._components,"_onInitializeAttributes"),this._callComponentMethod(this._enabledComponents,"_onInitialize")}_onPostInitialize(){this._callComponentMethod(this._enabledComponents,"_onPostInitialize")}_onUpdate(e){this._callComponentMethod(this._enabledComponents,"_onUpdate",e)}_onPostUpdate(e){this._callComponentMethod(this._enabledComponents,"_onPostUpdate",e)}_addComponentToEnabled(e){this._enabledComponents.insert(e)}_removeComponentFromEnabled(e){this._enabledComponents.remove(e)}_onBeforeRemove(e,t){this._components.items.indexOf(t)>=0&&t._onBeforeRemove(),this._removeComponentFromEnabled(t),this._components.remove(t)}destroy(){super.destroy(),this.app.systems.off("initialize",this._onInitialize,this),this.app.systems.off("postInitialize",this._onPostInitialize,this),this.app.systems.off("update",this._onUpdate,this),this.app.systems.off("postUpdate",this._onPostUpdate,this)}}class pg extends zf{constructor(e,t){super(e,t),this._layers=[0],this._instance=null,this._customAabb=null,this._assetReference=void 0,this._materialOptions=null,this._evtLayersChanged=null,this._evtLayerAdded=null,this._evtLayerRemoved=null,this._assetReference=new Fm("asset",this,e.app.assets,{add:this._onGSplatAssetAdded,load:this._onGSplatAssetLoad,remove:this._onGSplatAssetRemove,unload:this._onGSplatAssetUnload},this),t.on("remove",this.onRemoveChild,this),t.on("removehierarchy",this.onRemoveChild,this),t.on("insert",this.onInsertChild,this),t.on("inserthierarchy",this.onInsertChild,this)}set customAabb(e){var t;this._customAabb=e,null==(t=this._instance)||null==(t=t.meshInstance)||t.setCustomAabb(this._customAabb)}get customAabb(){return this._customAabb}set instance(e){var t;if(this.destroyInstance(),this._instance=e,null!=(t=this._instance)&&t.meshInstance){const e=this._instance.meshInstance;e.node||(e.node=this.entity),e.setCustomAabb(this._customAabb),this._materialOptions&&this._instance.createMaterial(this._materialOptions),this.enabled&&this.entity.enabled&&this.addToLayers()}}get instance(){return this._instance}set materialOptions(e){this._materialOptions=Object.assign({},e),this._instance&&this._instance.createMaterial(this._materialOptions)}get materialOptions(){return this._materialOptions}get material(){var e;return null==(e=this._instance)?void 0:e.material}set layers(e){this.removeFromLayers(),this._layers.length=0;for(let t=0;t<e.length;t++)this._layers[t]=e[t];this.enabled&&this.entity.enabled&&this.addToLayers()}get layers(){return this._layers}set asset(e){const t=e instanceof ef?e.id:e;this._assetReference.id!==t&&(this._assetReference.asset&&this._assetReference.asset.resource&&this._onGSplatAssetRemove(),this._assetReference.id=t,this._assetReference.asset&&this._onGSplatAssetAdded())}get asset(){return this._assetReference.id}assignAsset(e){const t=e instanceof ef?e.id:e;this._assetReference.id=t}destroyInstance(){var e;this._instance&&(this.removeFromLayers(),null==(e=this._instance)||e.destroy(),this._instance=null)}addToLayers(){var e;const t=null==(e=this.instance)?void 0:e.meshInstance;if(t){const e=this.system.app.scene.layers;for(let i=0;i<this._layers.length;i++){var s;null==(s=e.getLayerById(this._layers[i]))||s.addMeshInstances([t])}}}removeFromLayers(){var e;const t=null==(e=this.instance)?void 0:e.meshInstance;if(t){const e=this.system.app.scene.layers;for(let i=0;i<this._layers.length;i++){var s;null==(s=e.getLayerById(this._layers[i]))||s.removeMeshInstances([t])}}}onRemoveChild(){this.removeFromLayers()}onInsertChild(){this._instance&&this.enabled&&this.entity.enabled&&this.addToLayers()}onRemove(){this.destroyInstance(),this.asset=null,this._assetReference.id=null,this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)}onLayersChanged(e,t){this.addToLayers(),e.off("add",this.onLayerAdded,this),e.off("remove",this.onLayerRemoved,this),t.on("add",this.onLayerAdded,this),t.on("remove",this.onLayerRemoved,this)}onLayerAdded(e){this.layers.indexOf(e.id)<0||this._instance&&e.addMeshInstances(this._instance.meshInstance)}onLayerRemoved(e){this.layers.indexOf(e.id)<0||this._instance&&e.removeMeshInstances(this._instance.meshInstance)}onEnable(){const e=this.system.app.scene,t=e.layers;this._evtLayersChanged=e.on("set:layers",this.onLayersChanged,this),t&&(this._evtLayerAdded=t.on("add",this.onLayerAdded,this),this._evtLayerRemoved=t.on("remove",this.onLayerRemoved,this)),this._instance?this.addToLayers():this.asset&&this._onGSplatAssetAdded()}onDisable(){var e;const t=this.system.app.scene.layers;var s,i;(null==(e=this._evtLayersChanged)||e.off(),this._evtLayersChanged=null,t)&&(null==(s=this._evtLayerAdded)||s.off(),this._evtLayerAdded=null,null==(i=this._evtLayerRemoved)||i.off(),this._evtLayerRemoved=null);this.removeFromLayers()}hide(){this._instance&&(this._instance.meshInstance.visible=!1)}show(){this._instance&&(this._instance.meshInstance.visible=!0)}_onGSplatAssetAdded(){this._assetReference.asset&&(this._assetReference.asset.resource?this._onGSplatAssetLoad():this.enabled&&this.entity.enabled&&this.system.app.assets.load(this._assetReference.asset))}_onGSplatAssetLoad(){this.destroyInstance();const e=this._assetReference.asset;e&&(this.instance=e.resource.createInstance())}_onGSplatAssetUnload(){this.destroyInstance()}_onGSplatAssetRemove(){this._onGSplatAssetUnload()}}class fg{constructor(){this.enabled=!0}}const mg=["enabled"],gg=["instance","asset","layers"];class _g extends Nf{constructor(e){super(e),this.id="gsplat",this.ComponentType=pg,this.DataType=fg,this.schema=mg,this.on("beforeremove",this.onRemove,this)}initializeComponentData(e,t,s){t.layers&&t.layers.length&&(t.layers=t.layers.slice(0));for(let s=0;s<gg.length;s++)t.hasOwnProperty(gg[s])&&(e[gg[s]]=t[gg[s]]);t.aabbCenter&&t.aabbHalfExtents&&(e.customAabb=new Bs(new ys(t.aabbCenter),new ys(t.aabbHalfExtents))),super.initializeComponentData(e,t,mg)}cloneComponent(e,t){const s=e.gsplat,i={};for(let e=0;e<gg.length;e++)i[gg[e]]=s[gg[e]];i.enabled=s.enabled,delete i.instance;const n=this.addComponent(t,i);return n.instance=s.instance.clone(),s.customAabb&&(n.customAabb=s.customAabb.clone()),n}onRemove(e,t){t.onRemove()}}zf._buildAccessors(pg.prototype,mg);class vg extends Kt{constructor(...e){super(...e),this._meshes=null}set meshes(e){this.decRefMeshes(),this._meshes=e,this.incRefMeshes(),this.fire("set:meshes",e)}get meshes(){return this._meshes}destroy(){this.meshes=null}decRefMeshes(){var e;null==(e=this._meshes)||e.forEach(((e,t)=>{e&&(e.decRefCount(),e.refCount<1&&(e.destroy(),this._meshes[t]=null))}))}incRefMeshes(){var e;null==(e=this._meshes)||e.forEach((e=>{null==e||e.incRefCount()}))}}function bg(e){const t=this;if(!t.resource)return;const s=e.resource,i=s.renders&&s.renders[t.data.renderIndex];i&&(t.resource.meshes=i.resource.meshes)}function yg(e){const t=this;t.registry.off(`load:${e.id}`,bg,t),t.registry.on(`load:${e.id}`,bg,t),t.registry.off(`remove:${e.id}`,xg,t),t.registry.once(`remove:${e.id}`,xg,t),e.resource?bg.call(t,e):t.registry.load(e)}function xg(e){const t=this;t.registry.off(`load:${e.id}`,bg,t),t.resource&&t.resource.destroy()}vg.EVENT_SETMESHES="set:meshes";class wg extends lf{constructor(e){super(e,"render"),this._registry=e.assets}open(e,t){return new vg}patch(e,t){if(!e.data.containerAsset)return;const s=t.get(e.data.containerAsset);s?yg.call(e,s):t.once(`add:${e.data.containerAsset}`,yg,e)}}class Sg{constructor(e,t,s,i){this._paths=e,this._input=t,this._output=s,this._interpolation=i}get paths(){return this._paths}get input(){return this._input}get output(){return this._output}get interpolation(){return this._interpolation}}class Cg{constructor(e,t){this._components=e,this._data=t}get components(){return this._components}get data(){return this._data}}function Tg(e,t){let s;const i=(e,t)=>{switch(t){case s.DT_INT8:return new Int8Array(e.buffer,e.byteOffset,e.byteLength);case s.DT_INT16:return new Int16Array(e.buffer,e.byteOffset,e.byteLength/2);case s.DT_INT32:return new Int32Array(e.buffer,e.byteOffset,e.byteLength/4);case s.DT_UINT8:return new Uint8Array(e.buffer,e.byteOffset,e.byteLength);case s.DT_UINT16:return new Uint16Array(e.buffer,e.byteOffset,e.byteLength/2);case s.DT_UINT32:return new Uint32Array(e.buffer,e.byteOffset,e.byteLength/4);case s.DT_FLOAT32:return new Float32Array(e.buffer,e.byteOffset,e.byteLength/4)}return null},n=e=>e.num_components()*(e=>{switch(e){case s.DT_INT8:return 1;case s.DT_INT16:return 2;case s.DT_INT32:return 4;case s.DT_UINT8:return 1;case s.DT_UINT16:return 2;case s.DT_UINT32:case s.DT_FLOAT32:return 4}return 1})(e.data_type()),r={0:0,1:1,5:2,2:3,7:4,8:5,4:6,3:7},a=(e,t)=>{const s=(e,t,s)=>{e[0]=t[0]-s[0],e[1]=t[1]-s[1],e[2]=t[2]-s[2]},i=(e,t,s)=>{e[0]=t[1]*s[2]-s[1]*t[2],e[1]=t[2]*s[0]-s[2]*t[0],e[2]=t[0]*s[1]-s[0]*t[1]},n=(e,t)=>{const s=e[t+0],i=e[t+1],n=e[t+2],r=1/Math.sqrt(s*s+i*i+n*n);e[t+0]*=r,e[t+1]*=r,e[t+2]*=r},r=(e,t,s)=>{for(let i=0;i<3;++i)e[i]=t[s+i]},a=t.length/3,o=e.length/3,l=new Float32Array(e.length),h=[0,0,0],c=[0,0,0],d=[0,0,0],u=[0,0,0],p=[0,0,0],f=[0,0,0];for(let o=0;o<a;++o){const a=3*t[3*o+0],m=3*t[3*o+1],g=3*t[3*o+2];r(h,e,a),r(c,e,m),r(d,e,g),s(u,c,h),s(p,d,h),i(f,u,p),n(f,0);for(let e=0;e<3;++e)l[a+e]+=f[e],l[m+e]+=f[e],l[g+e]+=f[e]}for(let e=0;e<o;++e)n(l,3*e);return new Uint8Array(l.buffer)},o=e=>{const t=(e=>{const t={},o=new s.DecoderBuffer;o.Init(e,e.length);const l=new s.Decoder;if(l.GetEncodedGeometryType(o)!==s.TRIANGULAR_MESH)return t.error="Failed to decode draco mesh: not a mesh",t;const h=new s.Mesh,c=l.DecodeBufferToMesh(o,h);if(!c||!c.ok()||0===s.getPointer(h))return t.error="Failed to decode draco asset",t;const d=3*h.num_faces(),u=h.num_points()<=65535,p=d*(u?2:4),f=s._malloc(p);u?(l.GetTrianglesUInt16Array(h,p,f),t.indices=new Uint16Array(s.HEAPU16.buffer,f,d).slice().buffer):(l.GetTrianglesUInt32Array(h,p,f),t.indices=new Uint32Array(s.HEAPU32.buffer,f,d).slice().buffer),s._free(f);const m=[];for(let e=0;e<h.num_attributes();++e)m.push(l.GetAttribute(h,e));m.sort(((e,t)=>{var s,i;return(null!=(s=r[e.attribute_type()])?s:r.length)-(null!=(i=r[t.attribute_type()])?i:r.length)})),t.attributes=m.map((e=>e.unique_id()));let g=0;const _=m.map((e=>{const t=g;return g+=4*Math.ceil(n(e)/4),t})),v=m.some((e=>1===e.attribute_type())),b=_[1];if(!v){for(let e=1;e<_.length;++e)_[e]+=12;g+=12}t.vertices=new ArrayBuffer(h.num_points()*g);const y=new Uint8Array(t.vertices);for(let e=0;e<h.num_attributes();++e){const r=m[e],o=n(r),c=h.num_points()*o,d=s._malloc(c);l.GetAttributeDataArrayForAllPoints(h,r,r.data_type(),c,d);const p=new Uint8Array(s.HEAPU8.buffer,d,c);for(let t=0;t<h.num_points();++t)for(let s=0;s<o;++s)y[t*g+_[e]+s]=p[t*o+s];if(!v&&0===r.attribute_type()){const e=a(i(p,r.data_type()),u?new Uint16Array(t.indices):new Uint32Array(t.indices));for(let t=0;t<h.num_points();++t)for(let s=0;s<12;++s)y[t*g+b+s]=e[12*t+s]}s._free(d)}return s.destroy(h),s.destroy(l),s.destroy(o),t})(new Uint8Array(e.buffer));self.postMessage({jobId:e.jobId,error:t.error,indices:t.indices,vertices:t.vertices,attributes:t.attributes},[t.indices,t.vertices].filter((e=>null!=e)))},l=[];self.onmessage=e=>{const t=e.data;switch(t.type){case"init":self.DracoDecoderModule({instantiateWasm:(e,s)=>(WebAssembly.instantiate(t.module,e).then((e=>s(e))).catch((e=>console.error(`instantiate failed + ${e}`))),{})}).then((e=>{s=e,l.forEach((e=>o(e)))}));break;case"decodeMesh":s?o(t):l.push(t)}}}class Eg{constructor(){this.workers=[[],[],[]],this.jobId=0,this.jobQueue=[],this.jobCallbacks=new Map,this.run=(e,t)=>{e.postMessage({type:"decodeMesh",jobId:t.jobId,buffer:t.buffer},[t.buffer])}}init(e){for(e.forEach((e=>{e.addEventListener("message",(t=>{const s=t.data,i=this.jobCallbacks.get(s.jobId);if(i&&i(s.error,{indices:s.indices,vertices:s.vertices,attributes:s.attributes}),this.jobCallbacks.delete(s.jobId),this.jobQueue.length>0){const t=this.jobQueue.shift();this.run(e,t)}else{const t=this.workers[2].indexOf(e);if(-1!==t)this.workers[2].splice(t,1),this.workers[1].push(e);else{const t=this.workers[1].indexOf(e);-1!==t&&(this.workers[1].splice(t,1),this.workers[0].push(e))}}}))})),this.workers[0]=e;this.jobQueue.length&&(this.workers[0].length||this.workers[1].length);){const e=this.jobQueue.shift();if(this.workers[0].length>0){const t=this.workers[0].shift();this.workers[1].push(t),this.run(t,e)}else{const t=this.workers[1].shift();this.workers[2].push(t),this.run(t,e)}}}enqueueJob(e,t){const s={jobId:this.jobId++,buffer:e};if(this.jobCallbacks.set(s.jobId,t),this.workers[0].length>0){const e=this.workers[0].shift();this.workers[1].push(e),this.run(e,s)}else if(this.workers[1].length>0){const e=this.workers[1].shift();this.workers[2].push(e),this.run(e,s)}else this.jobQueue.push(s)}}const Pg=e=>{const t=()=>fetch(e).then((e=>e.arrayBuffer())).then((e=>WebAssembly.compile(e)));return WebAssembly.compileStreaming?WebAssembly.compileStreaming(fetch(e)).catch((e=>t())):t()};let kg;const Ag=(e,t)=>!!(e=>{if(kg)return!0;if(!e){const t=Qt.getConfig("DracoDecoderModule");e=t?{jsUrl:t.glueUrl,wasmUrl:t.wasmUrl,numWorkers:t.numWorkers}:{jsUrl:"draco.wasm.js",wasmUrl:"draco.wasm.wasm",numWorkers:1}}return!(!e.jsUrl||!e.wasmUrl||(kg=new Eg,Promise.all([(t=e.jsUrl,new Promise(((e,s)=>{const i={cache:!0,responseType:"text",retry:!0,maxRetries:3};Ho.get(t,i,((t,i)=>{t?s(t):e(i)}))}))),Pg(e.wasmUrl)]).then((([t,s])=>{const i=["/* draco */",t,"/* worker */",`(\n${Tg.toString()}\n)()\n\n`].join("\n"),n=new Blob([i],{type:"application/javascript"}),r=URL.createObjectURL(n),a=Math.max(1,Math.min(16,e.numWorkers||1)),o=[];for(let e=0;e<a;++e){const e=new Worker(r);e.postMessage({type:"init",module:s}),o.push(e)}kg.init(o)})),0));var t})()&&(kg.enqueueJob(e,t),!0);class Mg{constructor(){this.gltf=void 0,this.nodes=void 0,this.scenes=void 0,this.animations=void 0,this.textures=void 0,this.materials=void 0,this.variants=void 0,this.meshVariants=void 0,this.meshDefaultMaterials=void 0,this.renders=void 0,this.skins=void 0,this.lights=void 0,this.cameras=void 0,this.nodeInstancingMap=void 0}destroy(){this.renders&&this.renders.forEach((e=>{e.meshes=null}))}}const Dg=e=>/^data:[^\n\r,\u2028\u2029]*,.*$/i.test(e),Rg=e=>{switch(e){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":default:return 3;case"VEC4":case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16}},Lg=e=>{switch(e){case 5120:default:return 0;case 5121:return 1;case 5122:return 2;case 5123:return 3;case 5124:return 4;case 5125:return 5;case 5126:return 6}},Ig=e=>{switch(e){case 5120:case 5121:return 1;case 5122:case 5123:return 2;case 5124:case 5125:case 5126:return 4;default:return 0}},Fg={POSITION:li,NORMAL:hi,TANGENT:ci,COLOR_0:pi,JOINTS_0:ui,WEIGHTS_0:di,TEXCOORD_0:mi,TEXCOORD_1:gi,TEXCOORD_2:_i,TEXCOORD_3:vi,TEXCOORD_4:bi,TEXCOORD_5:yi,TEXCOORD_6:xi,TEXCOORD_7:wi},Og={[li]:0,[hi]:1,[ci]:2,[pi]:3,[ui]:4,[di]:5,[mi]:6,[gi]:7,[_i]:8,[vi]:9,[bi]:10,[yi]:11,[xi]:12,[wi]:13},Bg=(e,t,s)=>{const i=(e=>{switch(e){case 0:return e=>Math.max(e/127,-1);case 1:return e=>e/255;case 2:return e=>Math.max(e/32767,-1);case 3:return e=>e/65535;default:return e=>e}})(s),n=t.length;for(let s=0;s<n;++s)e[s]=i(t[s]);return e},zg=(e,t,s=!1)=>{const i=Rg(e.type),n=(e=>{switch(e){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5124:return Int32Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:return null}})(e.componentType);if(!n)return null;let r;if(e.sparse){const s=e.sparse,a={count:s.count,type:"SCALAR"},o=zg(Object.assign(a,s.indices),t,!0),l={count:s.count,type:e.type,componentType:e.componentType},h=zg(Object.assign(l,s.values),t,!0);if(e.hasOwnProperty("bufferView")){const s={bufferView:e.bufferView,byteOffset:e.byteOffset,componentType:e.componentType,count:e.count,type:e.type};r=zg(s,t,!0).slice()}else r=new n(e.count*i);for(let e=0;e<s.count;++e){const t=o[e];for(let s=0;s<i;++s)r[t*i+s]=h[e*i+s]}}else if(e.hasOwnProperty("bufferView")){const a=t[e.bufferView];if(s&&a.hasOwnProperty("byteStride")){const t=i*n.BYTES_PER_ELEMENT,s=new ArrayBuffer(e.count*t),o=new Uint8Array(s);let l=0;for(let s=0;s<e.count;++s){let i=(e.byteOffset||0)+s*a.byteStride;for(let e=0;e<t;++e)o[l++]=a[i++]}r=new n(s)}else r=new n(a.buffer,a.byteOffset+(e.byteOffset||0),e.count*i)}else r=new n(e.count*i);return r},Ng=(e,t)=>{const s=zg(e,t,!0);if(s instanceof Float32Array||!e.normalized)return s;const i=new Float32Array(s.length);return Bg(i,s,Lg(e.componentType)),i},Ug=e=>{let t=e.min,s=e.max;if(!t||!s)return null;if(e.normalized){const i=Lg(e.componentType);t=Bg([],t,i),s=Bg([],s,i)}return new Bs(new ys(.5*(s[0]+t[0]),.5*(s[1]+t[1]),.5*(s[2]+t[2])),new ys(.5*(s[0]-t[0]),.5*(s[1]-t[1]),.5*(s[2]-t[2])))},Vg=e=>{if(!e.hasOwnProperty("mode"))return 4;switch(e.mode){case 0:return 0;case 1:return 1;case 2:return 2;case 3:return 3;case 4:default:return 4;case 5:return 5;case 6:return 6}},Gg=(e,t)=>{const s=e[li];if(!s||3!==s.components)return;let i;if(s.size!==s.stride){const e=s.stride/nn[s.type],t=new sn[s.type](s.buffer,s.offset,s.count*e);i=new sn[s.type](3*s.count);for(let n=0;n<s.count;++n)i[3*n+0]=t[n*e+0],i[3*n+1]=t[n*e+1],i[3*n+2]=t[n*e+2]}else i=new sn[s.type](s.buffer,s.offset,3*s.count);const n=s.count;t||(t=(e=>{const t=new Uint16Array(e);for(let s=0;s<e;s++)t[s]=s;return t})(n));const r=Bd(i,t),a=new Float32Array(r.length);a.set(r),e[hi]={buffer:a.buffer,size:12,offset:0,stride:12,count:n,components:3,type:6}},Hg=e=>{const t=new ef(`${e.name}_clone`,e.type,e.file,e.data,e.options);return t.loaded=!0,t.resource=(e=>{const t=new yn(e.device,e);return t._levels=(e=>{const t=[];for(let s=0;s<e._levels.length;++s){let i=[];if(e.cubemap)for(let t=0;t<6;++t)i.push(e._levels[s][t]);else i=e._levels[s];t.push(i)}return t})(e),t})(e.resource),e.registry.add(t),t},jg=(e,t,s,i,n,r)=>{const a={},o=[];for(const e in t)t.hasOwnProperty(e)&&Fg.hasOwnProperty(e)&&(a[e]=t[e],o.push(`${e}:${t[e]}`));o.sort();const l=o.join();let h=r[l];if(!h){const o={};for(const e in a){const s=i[t[e]],r=zg(s,n),a=n[s.bufferView],l=Fg[e],h=Rg(s.type)*Ig(s.componentType),c=a&&a.hasOwnProperty("byteStride")?a.byteStride:h;o[l]={buffer:r.buffer,size:h,offset:r.byteOffset,stride:c,count:s.count,components:Rg(s.type),type:Lg(s.componentType),normalize:s.normalized}}o.hasOwnProperty(hi)||Gg(o,s),h=((e,t)=>{const s=t[li];if(!s)return null;const i=s.count,n=[];for(const s in t)if(t.hasOwnProperty(s)){const i={semantic:s,components:t[s].components,type:t[s].type,normalize:!!t[s].normalize};Kn.isElementValid(e,i)||i.components++,n.push(i)}let r,a,o,l,h,c;n.sort(((e,t)=>Og[e.semantic]-Og[t.semantic]));const d=new Kn(e,n);let u=!0;for(r=0;r<d.elements.length;++r)if(h=d.elements[r],l=t[h.name],c=l.offset-s.offset,l.buffer!==s.buffer||l.stride!==h.stride||l.size!==h.size||c!==h.offset){u=!1;break}const p=new Hn(e,d,i),f=p.lock(),m=new Uint32Array(f);let g;if(u)g=new Uint32Array(s.buffer,s.offset,i*p.format.size/4),m.set(g);else{let e,s;for(r=0;r<p.format.elements.length;++r){h=p.format.elements[r],e=h.stride/4,l=t[h.name],s=l.stride/4,g=new Uint32Array(l.buffer,l.offset,(l.count-1)*s+(l.size+3)/4);let n=0,c=h.offset/4;const d=Math.floor((l.size+3)/4);for(a=0;a<i;++a){for(o=0;o<d;++o)m[c+o]=g[n+o];n+=s,c+=e}}}return p.unlock(),p})(e,o),r[l]=h}return h},Wg=(e,t,s,i,n,r,a,o,l)=>{const h=[];return t.primitives.forEach((c=>{var d;if(null!=(d=c.extensions)&&d.KHR_draco_mesh_compression)h.push(((e,t,s,i,n,r,a)=>{var o;const l=new Dl(e);l.aabb=Ug(s[t.attributes.POSITION]);const h=[];for(const[e,i]of Object.entries(t.attributes)){var c;const t=s[i],n=Fg[e],r=Lg(t.componentType);h.push({semantic:n,components:Rg(t.type),type:r,normalize:null!=(c=t.normalized)?c:n===pi&&(1===r||3===r)})}if(a.push(new Promise(((s,n)=>{const r=t.extensions.KHR_draco_mesh_compression;Ag(i[r.bufferView].slice().buffer,((i,a)=>{if(i)console.log(i),n(i);else{var o;const i={};for(const[e,t]of Object.entries(r.attributes))i[Fg[e]]=a.attributes.indexOf(t);h.sort(((e,t)=>i[e.semantic]-i[t.semantic])),null!=(o=t.attributes)&&o.NORMAL||h.splice(1,0,{semantic:"NORMAL",components:3,type:6});const n=new Kn(e,h),c=a.vertices.byteLength/n.size,d=c<=65535?1:2,u=a.indices.byteLength/(c<=65535?2:4),p=new Hn(e,n,c,{data:a.vertices}),f=new lo(e,d,u,0,a.indices);l.vertexBuffer=p,l.indexBuffer[0]=f,l.primitive[0].type=Vg(t),l.primitive[0].base=0,l.primitive[0].count=f?u:c,l.primitive[0].indexed=!!f,s()}}))}))),null!=t&&null!=(o=t.extensions)&&o.KHR_materials_variants){const e=t.extensions.KHR_materials_variants,s={};e.mappings.forEach((e=>{e.variants.forEach((t=>{s[t]=e.material}))})),n[l.id]=s}return r[l.id]=t.material,l})(e,c,s,i,r,a,l));else{let l=c.hasOwnProperty("indices")?zg(s[c.indices],i,!0):null;const d=jg(e,c.attributes,l,s,i,n),u=Vg(c),p=new Dl(e);if(p.vertexBuffer=d,p.primitive[0].type=u,p.primitive[0].base=0,p.primitive[0].indexed=null!==l,null!==l){let t;t=l instanceof Uint8Array?0:l instanceof Uint16Array?1:2,0===t&&e.isWebGPU&&(t=1,l=new Uint16Array(l));const s=new lo(e,t,l.length,0,l);p.indexBuffer[0]=s,p.primitive[0].count=l.length}else p.primitive[0].count=d.numVertices;if(c.hasOwnProperty("extensions")&&c.extensions.hasOwnProperty("KHR_materials_variants")){const e=c.extensions.KHR_materials_variants,t={};e.mappings.forEach((e=>{e.variants.forEach((s=>{t[s]=e.material}))})),r[p.id]=t}a[p.id]=c.material;let f=s[c.attributes.POSITION];if(p.aabb=Ug(f),c.hasOwnProperty("targets")){const n=[];c.targets.forEach(((e,r)=>{const a={};e.hasOwnProperty("POSITION")&&(f=s[e.POSITION],a.deltaPositions=Ng(f,i),a.aabb=Ug(f)),e.hasOwnProperty("NORMAL")&&(f=s[e.NORMAL],a.deltaNormals=Ng(f,i)),t.hasOwnProperty("extras")&&t.extras.hasOwnProperty("targetNames")?a.name=t.extras.targetNames[r]:a.name=r.toString(10),t.hasOwnProperty("weights")&&(a.defaultWeight=t.weights[r]),a.preserveData=o.morphPreserveData,n.push(new Md(a))})),p.morph=new Ad(n,e,{preferHighPrecision:o.morphPreferHighPrecision})}h.push(p)}})),h},$g=(e,t,s)=>{var i;let n;const r=e.texCoord;if(r)for(n=0;n<s.length;++n)t[`${s[n]}MapUv`]=r;const a=[0,0],o=[1,1],l=null==(i=e.extensions)?void 0:i.KHR_texture_transform;if(l){const e=l.offset||a,i=l.scale||o,r=l.rotation?-l.rotation*rs.RAD_TO_DEG:0,h=new ws(i[0],i[1]),c=new ws(e[0],1-i[1]-e[1]);for(n=0;n<s.length;++n)t[`${s[n]}MapTiling`]=h,t[`${s[n]}MapOffset`]=c,t[`${s[n]}MapRotation`]=r}},qg=(e,t,s)=>{let i,n;if(e.hasOwnProperty("diffuseFactor")?(i=e.diffuseFactor,t.diffuse.set(Math.pow(i[0],1/2.2),Math.pow(i[1],1/2.2),Math.pow(i[2],1/2.2)),t.opacity=i[3]):(t.diffuse.set(1,1,1),t.opacity=1),e.hasOwnProperty("diffuseTexture")){const i=e.diffuseTexture;n=s[i.index],t.diffuseMap=n,t.diffuseMapChannel="rgb",t.opacityMap=n,t.opacityMapChannel="a",$g(i,t,["diffuse","opacity"])}if(t.useMetalness=!1,e.hasOwnProperty("specularFactor")?(i=e.specularFactor,t.specular.set(Math.pow(i[0],1/2.2),Math.pow(i[1],1/2.2),Math.pow(i[2],1/2.2))):t.specular.set(1,1,1),e.hasOwnProperty("glossinessFactor")?t.gloss=e.glossinessFactor:t.gloss=1,e.hasOwnProperty("specularGlossinessTexture")){const i=e.specularGlossinessTexture;t.specularEncoding="srgb",t.specularMap=t.glossMap=s[i.index],t.specularMapChannel="rgb",t.glossMapChannel="a",$g(i,t,["gloss","metalness"])}},Xg=(e,t,s)=>{if(e.hasOwnProperty("clearcoatFactor")?t.clearCoat=.25*e.clearcoatFactor:t.clearCoat=0,e.hasOwnProperty("clearcoatTexture")){const i=e.clearcoatTexture;t.clearCoatMap=s[i.index],t.clearCoatMapChannel="r",$g(i,t,["clearCoat"])}if(e.hasOwnProperty("clearcoatRoughnessFactor")?t.clearCoatGloss=e.clearcoatRoughnessFactor:t.clearCoatGloss=0,e.hasOwnProperty("clearcoatRoughnessTexture")){const i=e.clearcoatRoughnessTexture;t.clearCoatGlossMap=s[i.index],t.clearCoatGlossMapChannel="g",$g(i,t,["clearCoatGloss"])}if(e.hasOwnProperty("clearcoatNormalTexture")){const i=e.clearcoatNormalTexture;t.clearCoatNormalMap=s[i.index],$g(i,t,["clearCoatNormal"]),i.hasOwnProperty("scale")&&(t.clearCoatBumpiness=i.scale)}t.clearCoatGlossInvert=!0},Kg=(e,t,s)=>{t.useLighting=!1,t.emissive.copy(t.diffuse),t.emissiveMap=t.diffuseMap,t.emissiveMapUv=t.diffuseMapUv,t.emissiveMapTiling.copy(t.diffuseMapTiling),t.emissiveMapOffset.copy(t.diffuseMapOffset),t.emissiveMapRotation=t.diffuseMapRotation,t.emissiveMapChannel=t.diffuseMapChannel,t.emissiveVertexColor=t.diffuseVertexColor,t.emissiveVertexColorChannel=t.diffuseVertexColorChannel,t.useLighting=!1,t.useSkybox=!1,t.diffuse.set(1,1,1),t.diffuseMap=null,t.diffuseVertexColor=!1},Yg=(e,t,s)=>{if(t.useMetalnessSpecularColor=!0,e.hasOwnProperty("specularColorTexture")&&(t.specularEncoding="srgb",t.specularMap=s[e.specularColorTexture.index],t.specularMapChannel="rgb",$g(e.specularColorTexture,t,["specular"])),e.hasOwnProperty("specularColorFactor")){const s=e.specularColorFactor;t.specular.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2))}else t.specular.set(1,1,1);e.hasOwnProperty("specularFactor")?t.specularityFactor=e.specularFactor:t.specularityFactor=1,e.hasOwnProperty("specularTexture")&&(t.specularityFactorMapChannel="a",t.specularityFactorMap=s[e.specularTexture.index],$g(e.specularTexture,t,["specularityFactor"]))},Qg=(e,t,s)=>{e.hasOwnProperty("ior")&&(t.refractionIndex=1/e.ior)},Jg=(e,t,s)=>{e.hasOwnProperty("dispersion")&&(t.dispersion=e.dispersion)},Zg=(e,t,s)=>{t.blendType=2,t.useDynamicRefraction=!0,e.hasOwnProperty("transmissionFactor")&&(t.refraction=e.transmissionFactor),e.hasOwnProperty("transmissionTexture")&&(t.refractionMapChannel="r",t.refractionMap=s[e.transmissionTexture.index],$g(e.transmissionTexture,t,["refraction"]))},e_=(e,t,s)=>{if(t.useSheen=!0,e.hasOwnProperty("sheenColorFactor")){const s=e.sheenColorFactor;t.sheen.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2))}else t.sheen.set(1,1,1);e.hasOwnProperty("sheenColorTexture")&&(t.sheenMap=s[e.sheenColorTexture.index],t.sheenEncoding="srgb",$g(e.sheenColorTexture,t,["sheen"])),t.sheenGloss=e.hasOwnProperty("sheenRoughnessFactor")?e.sheenRoughnessFactor:0,e.hasOwnProperty("sheenRoughnessTexture")&&(t.sheenGlossMap=s[e.sheenRoughnessTexture.index],t.sheenGlossMapChannel="a",$g(e.sheenRoughnessTexture,t,["sheenGloss"])),t.sheenGlossInvert=!0},t_=(e,t,s)=>{if(t.blendType=2,t.useDynamicRefraction=!0,e.hasOwnProperty("thicknessFactor")&&(t.thickness=e.thicknessFactor),e.hasOwnProperty("thicknessTexture")&&(t.thicknessMap=s[e.thicknessTexture.index],t.thicknessMapChannel="g",$g(e.thicknessTexture,t,["thickness"])),e.hasOwnProperty("attenuationDistance")&&(t.attenuationDistance=e.attenuationDistance),e.hasOwnProperty("attenuationColor")){const s=e.attenuationColor;t.attenuation.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2))}},s_=(e,t,s)=>{e.hasOwnProperty("emissiveStrength")&&(t.emissiveIntensity=e.emissiveStrength)},i_=(e,t,s)=>{t.useIridescence=!0,e.hasOwnProperty("iridescenceFactor")&&(t.iridescence=e.iridescenceFactor),e.hasOwnProperty("iridescenceTexture")&&(t.iridescenceMapChannel="r",t.iridescenceMap=s[e.iridescenceTexture.index],$g(e.iridescenceTexture,t,["iridescence"])),e.hasOwnProperty("iridescenceIor")&&(t.iridescenceRefractionIndex=e.iridescenceIor),e.hasOwnProperty("iridescenceThicknessMinimum")&&(t.iridescenceThicknessMin=e.iridescenceThicknessMinimum),e.hasOwnProperty("iridescenceThicknessMaximum")&&(t.iridescenceThicknessMax=e.iridescenceThicknessMaximum),e.hasOwnProperty("iridescenceThicknessTexture")&&(t.iridescenceThicknessMapChannel="g",t.iridescenceThicknessMap=s[e.iridescenceThicknessTexture.index],$g(e.iridescenceThicknessTexture,t,["iridescenceThickness"]))},n_=(e,t)=>{const s=new ju;let i,n;if(s.occludeSpecular=1,s.diffuseVertexColor=!0,s.specularTint=!0,s.specularVertexColor=!0,e.hasOwnProperty("name")&&(s.name=e.name),e.hasOwnProperty("pbrMetallicRoughness")){const r=e.pbrMetallicRoughness;if(r.hasOwnProperty("baseColorFactor")?(i=r.baseColorFactor,s.diffuse.set(Math.pow(i[0],1/2.2),Math.pow(i[1],1/2.2),Math.pow(i[2],1/2.2)),s.opacity=i[3]):(s.diffuse.set(1,1,1),s.opacity=1),r.hasOwnProperty("baseColorTexture")){const e=r.baseColorTexture;n=t[e.index],s.diffuseMap=n,s.diffuseMapChannel="rgb",s.opacityMap=n,s.opacityMapChannel="a",$g(e,s,["diffuse","opacity"])}if(s.useMetalness=!0,s.specular.set(1,1,1),r.hasOwnProperty("metallicFactor")?s.metalness=r.metallicFactor:s.metalness=1,r.hasOwnProperty("roughnessFactor")?s.gloss=r.roughnessFactor:s.gloss=1,s.glossInvert=!0,r.hasOwnProperty("metallicRoughnessTexture")){const e=r.metallicRoughnessTexture;s.metalnessMap=s.glossMap=t[e.index],s.metalnessMapChannel="b",s.glossMapChannel="g",$g(e,s,["gloss","metalness"])}}if(e.hasOwnProperty("normalTexture")){const i=e.normalTexture;s.normalMap=t[i.index],$g(i,s,["normal"]),i.hasOwnProperty("scale")&&(s.bumpiness=i.scale)}if(e.hasOwnProperty("occlusionTexture")){const i=e.occlusionTexture;s.aoMap=t[i.index],s.aoMapChannel="r",$g(i,s,["ao"])}if(e.hasOwnProperty("emissiveFactor")?(i=e.emissiveFactor,s.emissive.set(Math.pow(i[0],1/2.2),Math.pow(i[1],1/2.2),Math.pow(i[2],1/2.2))):s.emissive.set(0,0,0),e.hasOwnProperty("emissiveTexture")){const i=e.emissiveTexture;s.emissiveMap=t[i.index],$g(i,s,["emissive"])}if(e.hasOwnProperty("alphaMode"))switch(e.alphaMode){case"MASK":s.blendType=3,e.hasOwnProperty("alphaCutoff")?s.alphaTest=e.alphaCutoff:s.alphaTest=.5;break;case"BLEND":s.blendType=2,s.depthWrite=!1;break;default:s.blendType=3}else s.blendType=3;e.hasOwnProperty("doubleSided")?(s.twoSidedLighting=e.doubleSided,s.cull=e.doubleSided?0:1):(s.twoSidedLighting=!1,s.cull=1);const r={KHR_materials_clearcoat:Xg,KHR_materials_emissive_strength:s_,KHR_materials_ior:Qg,KHR_materials_dispersion:Jg,KHR_materials_iridescence:i_,KHR_materials_pbrSpecularGlossiness:qg,KHR_materials_sheen:e_,KHR_materials_specular:Yg,KHR_materials_transmission:Zg,KHR_materials_unlit:Kg,KHR_materials_volume:t_};if(e.hasOwnProperty("extensions"))for(const i in e.extensions){const n=r[i];void 0!==n&&n(e.extensions[i],s,t)}return s.update(),s},r_=new As,a_=new ys,o_=(e,t,s)=>{const i=new vh;if(e.hasOwnProperty("name")&&e.name.length>0?i.name=e.name:i.name=`node_${t}`,e.hasOwnProperty("matrix")&&(r_.data.set(e.matrix),r_.getTranslation(a_),i.setLocalPosition(a_),r_.getEulerAngles(a_),i.setLocalEulerAngles(a_),r_.getScale(a_),i.setLocalScale(a_)),e.hasOwnProperty("rotation")){const t=e.rotation;i.setLocalRotation(t[0],t[1],t[2],t[3])}if(e.hasOwnProperty("translation")){const t=e.translation;i.setLocalPosition(t[0],t[1],t[2])}if(e.hasOwnProperty("scale")){const t=e.scale;i.setLocalScale(t[0],t[1],t[2])}return e.hasOwnProperty("extensions")&&e.extensions.EXT_mesh_gpu_instancing&&s.set(e,{ext:e.extensions.EXT_mesh_gpu_instancing}),i},l_=(e,t)=>{const s="orthographic"===e.type?1:0,i=1===s?e.orthographic:e.perspective,n={enabled:!1,projection:s,nearClip:i.znear,aspectRatioMode:0};i.zfar&&(n.farClip=i.zfar),1===s?(n.orthoHeight=.5*i.ymag,i.ymag&&(n.aspectRatioMode=1,n.aspectRatio=i.xmag/i.ymag)):(n.fov=i.yfov*rs.RAD_TO_DEG,i.aspectRatio&&(n.aspectRatioMode=1,n.aspectRatio=i.aspectRatio));const r=new vf(e.name);return r.addComponent("camera",n),r},h_=(e,t)=>{const s={enabled:!1,type:"point"===e.type?"omni":e.type,color:e.hasOwnProperty("color")?new os(e.color):os.WHITE,range:e.hasOwnProperty("range")?e.range:9999,falloffMode:1,intensity:e.hasOwnProperty("intensity")?rs.clamp(e.intensity,0,2):1};e.hasOwnProperty("spot")&&(s.innerConeAngle=e.spot.hasOwnProperty("innerConeAngle")?e.spot.innerConeAngle*rs.RAD_TO_DEG:0,s.outerConeAngle=e.spot.hasOwnProperty("outerConeAngle")?e.spot.outerConeAngle*rs.RAD_TO_DEG:Math.PI/4),e.hasOwnProperty("intensity")&&(s.luminance=e.intensity*Cd.getLightUnitConversion(yd[s.type],s.outerConeAngle,s.innerConeAngle));const i=new vf(t.name);return i.rotateLocal(90,0,0),i.addComponent("light",s),i},c_=(e,t,s,i)=>{if(!t.hasOwnProperty("skins")||0===t.skins.length)return[];const n=new Map;return t.skins.map((r=>((e,t,s,i,n,r)=>{let a,o,l;const h=t.joints,c=h.length,d=[];if(t.hasOwnProperty("inverseBindMatrices")){const e=t.inverseBindMatrices,n=zg(s[e],i,!0),r=[];for(a=0;a<c;a++){for(o=0;o<16;o++)r[o]=n[16*a+o];l=new As,l.set(r),d.push(l)}}else for(a=0;a<c;a++)l=new As,d.push(l);const u=[];for(a=0;a<c;a++)u[a]=n[h[a]].name;const p=u.join("#");let f=r.get(p);return f||(f=new wu(e,d,u),r.set(p,f)),f})(e,r,t.accessors,i,s,n)))},d_=(e,t,s,i)=>{var n,r;if(!e.hasOwnProperty("animations")||0===e.animations.length)return[];const a=null==i||null==(n=i.animation)?void 0:n.preprocess,o=null==i||null==(r=i.animation)?void 0:r.postprocess;return e.animations.map(((i,n)=>{a&&a(i);const r=((e,t,s,i,n,r,a)=>{const o=e=>new Cg(Rg(e.type),Ng(e,i)),l={STEP:0,LINEAR:1,CUBICSPLINE:2},h={},c={},d={};let u,p=1;for(u=0;u<e.samplers.length;++u){const t=e.samplers[u];h.hasOwnProperty(t.input)||(h[t.input]=o(s[t.input])),c.hasOwnProperty(t.output)||(c[t.output]=o(s[t.output]));const i=t.hasOwnProperty("interpolation")&&l.hasOwnProperty(t.interpolation)?l[t.interpolation]:1,n={paths:[],input:t.input,output:t.output,interpolation:i};d[u]=n}const f=[],m={translation:"localPosition",rotation:"localRotation",scale:"localScale"},g=e=>{const t=[];for(;e;)t.unshift(e.name),e=e.parent;return t},_=(e,t,s)=>{const i=c[e.output];if(!i)return;let n;if(r&&r[t.mesh]){const e=r[t.mesh];e.hasOwnProperty("extras")&&e.extras.hasOwnProperty("targetNames")&&(n=e.extras.targetNames)}const a=i.data,o=a.length/h[e.input].data.length,l=a.length/o,f=4*l,m=new ArrayBuffer(f*o);for(let t=0;t<o;t++){var g;const i=new Float32Array(m,f*t,l);for(let e=0;e<l;e++)i[e]=a[e*o+t];const r=new Cg(1,i),h=null!=(g=n)&&g[t]?`name.${n[t]}`:t;c[-p]=r;const _={paths:[{entityPath:s,component:"graph",propertyPath:[`weight.${h}`]}],input:e.input,output:-p,interpolation:e.interpolation};p++,d[`morphCurve-${u}-${t}`]=_}};for(u=0;u<e.channels.length;++u){const t=e.channels[u],s=t.target,i=d[t.sampler],r=n[s.node],o=a[s.node],l=g(r);s.path.startsWith("weights")?(_(i,o,l),d[t.sampler].morphCurve=!0):i.paths.push({entityPath:l,component:"graph",propertyPath:[m[s.path]]})}const v=[],b=[],y=[];for(const e in h)v.push(h[e]),h[e]=v.length-1;for(const e in c)b.push(c[e]),c[e]=b.length-1;for(const e in d){const t=d[e];t.morphCurve||(y.push(new Sg(t.paths,h[t.input],c[t.output],t.interpolation)),t.paths.length>0&&"localRotation"===t.paths[0].propertyPath[0]&&2!==t.interpolation&&f.push(y[y.length-1].output))}f.sort();let x,w=null;for(u=0;u<f.length;++u){const e=f[u];if(0===u||e!==w){if(x=b[e],4===x.components){const e=x.data,t=e.length-4;for(let s=0;s<t;s+=4)e[s+0]*e[s+4]+e[s+1]*e[s+5]+e[s+2]*e[s+6]+e[s+3]*e[s+7]<0&&(e[s+4]*=-1,e[s+5]*=-1,e[s+6]*=-1,e[s+7]*=-1)}w=e}}let S=0;for(u=0;u<v.length;u++)x=v[u]._data,S=Math.max(S,0===x.length?0:x[x.length-1]);return new rm(e.hasOwnProperty("name")?e.name:`animation_${t}`,S,v,b,y)})(i,n,e.accessors,s,t,e.meshes,e.nodes);return o&&o(i,r),r}))},u_=async(e,t,s,i,n)=>{var r,a;const o=null==n||null==(r=n.global)?void 0:r.preprocess,l=null==n||null==(a=n.global)?void 0:a.postprocess;o&&o(t);const h=new Map,c=((e,t,s)=>{var i,n,r,a;if(!e.hasOwnProperty("nodes")||0===e.nodes.length)return[];const o=null==t||null==(i=t.node)?void 0:i.preprocess,l=null!=(n=null==t||null==(r=t.node)?void 0:r.process)?n:o_,h=null==t||null==(a=t.node)?void 0:a.postprocess,c=e.nodes.map(((e,t)=>{o&&o(e);const i=l(e,t,s);return h&&h(e,i),i}));for(let t=0;t<e.nodes.length;++t){const s=e.nodes[t];if(s.hasOwnProperty("children")){const e=c[t],i={};for(let t=0;t<s.children.length;++t){const n=c[s.children[t]];n.parent||(i.hasOwnProperty(n.name)?n.name+=i[n.name]++:i[n.name]=1,e.addChild(n))}}}return c})(t,n,h),d=((e,t)=>{var s;const i=[],n=e.scenes.length;if(1===n&&1===(null==(s=e.scenes[0].nodes)?void 0:s.length)){const s=e.scenes[0].nodes[0];i.push(t[s])}else for(let s=0;s<n;s++){const n=e.scenes[s];if(n.nodes){const e=new vh(n.name);for(let s=0;s<n.nodes.length;s++){const i=t[n.nodes[s]];e.addChild(i)}i.push(e)}}return i})(t,c),u=((e,t,s)=>{let i=null;if(e.hasOwnProperty("nodes")&&e.hasOwnProperty("extensions")&&e.extensions.hasOwnProperty("KHR_lights_punctual")&&e.extensions.KHR_lights_punctual.hasOwnProperty("lights")){const l=e.extensions.KHR_lights_punctual.lights;if(l.length){var n,r,a,o;const h=null==s||null==(n=s.light)?void 0:n.preprocess,c=null!=(r=null==s||null==(a=s.light)?void 0:a.process)?r:h_,d=null==s||null==(o=s.light)?void 0:o.postprocess;e.nodes.forEach(((e,s)=>{if(e.hasOwnProperty("extensions")&&e.extensions.hasOwnProperty("KHR_lights_punctual")&&e.extensions.KHR_lights_punctual.hasOwnProperty("light")){const n=e.extensions.KHR_lights_punctual.light,r=l[n];if(r){h&&h(r);const n=c(r,t[s]);d&&d(r,n),n&&(i||(i=new Map),i.set(e,n))}}}))}}return i})(t,c,n),p=((e,t,s)=>{let i=null;if(e.hasOwnProperty("nodes")&&e.hasOwnProperty("cameras")&&e.cameras.length>0){var n,r,a,o;const l=null==s||null==(n=s.camera)?void 0:n.preprocess,h=null!=(r=null==s||null==(a=s.camera)?void 0:a.process)?r:l_,c=null==s||null==(o=s.camera)?void 0:o.postprocess;e.nodes.forEach(((s,n)=>{if(s.hasOwnProperty("camera")){const r=e.cameras[s.camera];if(r){l&&l(r);const e=h(r,t[n]);c&&c(r,e),e&&(i||(i=new Map),i.set(s,e))}}}))}return i})(t,c,n),f=(e=>{if(!e.hasOwnProperty("extensions")||!e.extensions.hasOwnProperty("KHR_materials_variants"))return null;const t=e.extensions.KHR_materials_variants.variants,s={};for(let e=0;e<t.length;e++)s[t[e].name]=e;return s})(t),m=await Promise.all(s),{meshes:g,meshVariants:_,meshDefaultMaterials:v,promises:b}=((e,t,s,i)=>{var n,r,a;const o={},l={},h={},c=[];return{meshes:!i.skipMeshes&&(null==t||null==(n=t.meshes)?void 0:n.length)&&(null==t||null==(r=t.accessors)?void 0:r.length)&&(null==t||null==(a=t.bufferViews)?void 0:a.length)?t.meshes.map((n=>Wg(e,n,t.accessors,s,o,l,h,i,c))):[],meshVariants:l,meshDefaultMaterials:h,promises:c}})(e,t,m,n),y=d_(t,c,m,n);((e,t,s,i)=>{const n=t.accessors;s.forEach(((e,t)=>{const s=e.ext.attributes;let r,a,o;if(s.hasOwnProperty("TRANSLATION")){const e=n[s.TRANSLATION];r=Ng(e,i)}if(s.hasOwnProperty("ROTATION")){const e=n[s.ROTATION];a=Ng(e,i)}if(s.hasOwnProperty("SCALE")){const e=n[s.SCALE];o=Ng(e,i)}const l=(r?r.length/3:0)||(a?a.length/4:0)||(o?o.length/3:0);if(l){const t=new Float32Array(16*l),s=new ys,i=new Ds,n=new ys(1,1,1),h=new As;let c=0;for(let e=0;e<l;e++){const l=3*e;if(r&&s.set(r[l],r[l+1],r[l+2]),a){const t=4*e;i.set(a[t],a[t+1],a[t+2],a[t+3])}o&&n.set(o[l],o[l+1],o[l+2]),h.setTRS(s,i,n);for(let e=0;e<16;e++)t[c++]=h.data[e]}e.matrices=t}}))})(0,t,h,m);const x=await Promise.all(i),w=((e,t,s)=>{var i,n,r,a;if(!e.hasOwnProperty("materials")||0===e.materials.length)return[];const o=null==s||null==(i=s.material)?void 0:i.preprocess,l=null!=(n=null==s||null==(r=s.material)?void 0:r.process)?n:n_,h=null==s||null==(a=s.material)?void 0:a.postprocess;return e.materials.map((e=>{o&&o(e);const s=l(e,t);return h&&h(e,s),s}))})(t,x.map((e=>e.resource)),n),S=c_(e,t,c,m),C=[];for(let e=0;e<g.length;e++)C[e]=new vg,C[e].meshes=g[e];((e,t,s)=>{e.nodes.forEach((e=>{e.hasOwnProperty("mesh")&&e.hasOwnProperty("skin")&&t[e.mesh].meshes.forEach((t=>{t.skin=s[e.skin]}))}))})(t,C,S);const T=new Mg;return T.gltf=t,T.nodes=c,T.scenes=d,T.animations=y,T.textures=x,T.materials=w,T.variants=f,T.meshVariants=_,T.meshDefaultMaterials=v,T.renders=C,T.skins=S,T.lights=u,T.cameras=p,T.nodeInstancingMap=h,l&&l(t,T),await Promise.all(b),T};let p_=0;const f_=e=>{var t,s,i,n;return null!=(t=null!=(s=null==(i=e.extensions)||null==(i=i.KHR_texture_basisu)?void 0:i.source)?s:null==(n=e.extensions)||null==(n=n.EXT_texture_webp)?void 0:n.source)?t:e.source},m_=(e,t,s)=>{e&&e.toLowerCase().endsWith(".glb")||(()=>{const e=new Uint8Array(t);return 103===e[0]&&108===e[1]&&84===e[2]&&70===e[3]})()?((e,t)=>{const s=e instanceof ArrayBuffer?new DataView(e):new DataView(e.buffer,e.byteOffset,e.byteLength),i=s.getUint32(0,!0),n=s.getUint32(4,!0),r=s.getUint32(8,!0);if(1179937895!==i)return void t(`Invalid magic number found in glb header. Expected 0x46546C67, found 0x${i.toString(16)}`);if(2!==n)return void t(`Invalid version number found in glb header. Expected 2, found ${n}`);if(r<=0||r>s.byteLength)return void t(`Invalid length found in glb header. Found ${r}`);const a=[];let o=12;for(;o<r;){const e=s.getUint32(o,!0);o+e+8>s.byteLength&&t(`Invalid chunk length found in glb. Found ${e}`);const i=s.getUint32(o+4,!0),n=new Uint8Array(s.buffer,s.byteOffset+o+8,e);a.push({length:e,type:i,data:n}),o+=e+8}1===a.length||2===a.length?1313821514===a[0].type?a.length>1&&5130562!==a[1].type?t(`Invalid chunk type found in glb file. Expected 0x004E4942, found 0x${a[1].type.toString(16)}`):t(null,{gltfChunk:a[0].data,binaryChunk:2===a.length?a[1].data:null}):t(`Invalid chunk type found in glb file. Expected 0x4E4F534A, found 0x${a[0].type.toString(16)}`):t("Invalid number of chunks found in glb file.")})(t,s):s(null,{gltfChunk:t,binaryChunk:null})};class g_{static parse(e,t,s,i,n,r,a){m_(e,s,((e,s)=>{e?a(e):((e,t)=>{const s=JSON.parse((e=>{if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);let t="";for(let s=0;s<e.length;s++)t+=String.fromCharCode(e[s]);return decodeURIComponent(escape(t))})(e));s.asset&&s.asset.version&&parseFloat(s.asset.version)<2?t(`Invalid gltf version. Expected version 2.0 or above but found version '${s.asset.version}'.`):t(null,s)})(s.gltfChunk,((e,o)=>{if(e)return void a(e);const l=((e,t,s,i)=>{var n,r,a;if(!e.buffers||0===e.buffers.length)return[];const o=null==i||null==(n=i.buffer)?void 0:n.preprocess,l=null==i||null==(r=i.buffer)?void 0:r.processAsync,h=null==i||null==(a=i.buffer)?void 0:a.postprocess;return e.buffers.map(((i,n)=>{let r;return o&&o(i),r=new Promise(l?(e,t)=>{l(i,((s,i)=>{s?t(s):e(i)}))}:e=>{e(null)}),r=r.then((e=>{if(e)return e;if(i.hasOwnProperty("uri")){if(Dg(i.uri)){const e=atob(i.uri.split(",")[1]),t=new Uint8Array(e.length);for(let s=0;s<e.length;s++)t[s]=e.charCodeAt(s);return t}return new Promise(((e,t)=>{Ho.get(Kp.test(i.uri)?i.uri:It.join(s,i.uri),{cache:!0,responseType:"arraybuffer",retry:!1},((s,i)=>{s?t(s):e(new Uint8Array(i))}))}))}return t})),h&&(r=r.then((t=>(h(e.buffers[n],t),t)))),r}))})(o,s.binaryChunk,t,r),h=((e,t,s)=>{var i,n,r,a;const o=[],l=null==s||null==(i=s.bufferView)?void 0:i.preprocess,h=null==s||null==(n=s.bufferView)?void 0:n.processAsync,c=null==s||null==(r=s.bufferView)?void 0:r.postprocess;if(null==(a=e.bufferViews)||!a.length)return o;for(let s=0;s<e.bufferViews.length;++s){const i=e.bufferViews[s];let n;l&&l(i),n=new Promise(h?(e,s)=>{h(i,t,((t,i)=>{t?s(t):e(i)}))}:e=>{e(null)}),n=n.then((e=>e||t[i.buffer].then((e=>new Uint8Array(e.buffer,e.byteOffset+(i.byteOffset||0),i.byteLength))))),i.hasOwnProperty("byteStride")&&(n=n.then((e=>(e.byteStride=i.byteStride,e)))),c&&(n=n.then((e=>(c(i,e),e)))),o.push(n)}return o})(o,l,r),c=((e,t,s,i,n)=>{var r,a,o;if(!e.images||0===e.images.length)return[];const l=null==n||null==(r=n.image)?void 0:r.preprocess,h=null==n||null==(a=n.image)?void 0:a.processAsync,c=null==n||null==(o=n.image)?void 0:o.postprocess,d={"image/png":"png","image/jpeg":"jpg","image/basis":"basis","image/ktx":"ktx","image/ktx2":"ktx2","image/vnd-ms.dds":"dds"},u=(e,t,s,n,r,a)=>new Promise(((o,l)=>{const h=s=>{const h=`${e.name||"gltf-texture"}-${p_++}`,c={url:t||h};if(s&&(c.contents=s.slice(0).buffer),n){const e=d[n];e&&(c.filename=`${c.url}.${e}`)}const u=new ef(h,"texture",c,{srgb:a},r);u.on("load",(e=>o(e))),u.on("error",(e=>l(e))),i.add(u),i.load(u)};s?s.then((e=>h(e))):h(null)})),p=(e=>{const t=new Set;return e.hasOwnProperty("materials")&&e.materials.forEach((s=>{if(s.hasOwnProperty("pbrMetallicRoughness")){const i=s.pbrMetallicRoughness;if(i.hasOwnProperty("baseColorTexture")){const s=e.textures[i.baseColorTexture.index];t.add(f_(s))}}if(s.hasOwnProperty("emissiveTexture")){const i=e.textures[s.emissiveTexture.index];t.add(f_(i))}})),t})(e);return e.images.map(((e,i)=>{let n;return l&&l(e),n=new Promise(h?(t,s)=>{h(e,((e,i)=>{e?s(e):t(i)}))}:e=>{e(null)}),n=n.then((n=>{const r=p.has(i);return n||(e.hasOwnProperty("uri")?Dg(e.uri)?u(e,e.uri,null,(a=e.uri).substring(a.indexOf(":")+1,a.indexOf(";")),null,r):u(e,Kp.test(e.uri)?e.uri:It.join(s,e.uri),null,null,{crossOrigin:"anonymous"},r):e.hasOwnProperty("bufferView")&&e.hasOwnProperty("mimeType")?u(e,null,t[e.bufferView],e.mimeType,null,r):Promise.reject(new Error(`Invalid image found in gltf (neither uri or bufferView found). index=${i}`)));var a})),c&&(n=n.then((t=>(c(e,t),t)))),n}))})(o,h,t,n,r),d=((e,t,s)=>{var i,n,r,a,o;if(null==e||null==(i=e.images)||!i.length||null==e||null==(n=e.textures)||!n.length)return[];const l=null==s||null==(r=s.texture)?void 0:r.preprocess,h=null==s||null==(a=s.texture)?void 0:a.processAsync,c=null==s||null==(o=s.texture)?void 0:o.postprocess,d=new Set;return e.textures.map((s=>{let i;return l&&l(s),i=new Promise(h?(t,i)=>{h(s,e.images,((e,s)=>{e?i(e):t(s)}))}:e=>{e(null)}),i=i.then((i=>{var n;i=null!=(n=i)?n:f_(s);const r=d.has(i);return d.add(i),t[i].then((t=>{var i;const n=r?Hg(t):t;return((e,t)=>{const s=(e,t)=>{switch(e){case 9728:return 0;case 9729:return 1;case 9984:return 2;case 9985:return 4;case 9986:return 3;case 9987:return 5;default:return t}},i=(e,t)=>{switch(e){case 33071:return 1;case 33648:return 2;case 10497:return 0;default:return t}};var n;e&&(t=null!=(n=t)?n:{},e.minFilter=s(t.minFilter,5),e.magFilter=s(t.magFilter,1),e.addressU=i(t.wrapS,0),e.addressV=i(t.wrapT,0))})(n.resource,(null!=(i=e.samplers)?i:[])[s.sampler]),n}))})),c&&(i=i.then((e=>(c(s,e),e)))),i}))})(o,c,r);u_(i,o,h,d,r).then((e=>a(null,e))).catch((e=>a(e)))}))}))}static createDefaultMaterial(){return n_({name:"defaultGlbMaterial"},[])}}class __ extends lf{constructor(e){super(e,"animclip")}load(e,t){"string"==typeof e&&(e={load:e,original:e});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};e.load.startsWith("blob:")&&(s.responseType=Go.ResponseType.JSON),Ho.get(e.load,s,((s,i)=>{s?t(`Error loading animation clip resource: ${e.original} [${s}]`):t(null,i)}))}open(e,t){const s=t.name,i=t.duration,n=t.inputs.map((e=>new Cg(1,e))),r=t.outputs.map((e=>new Cg(e.components,e.data))),a=t.curves.map((e=>new Sg([e.path],e.inputIndex,e.outputIndex,e.interpolation)));return new rm(s,i,n,r,a)}}class v_ extends lf{constructor(e){super(e,"animstategraph")}load(e,t){"string"==typeof e&&(e={load:e,original:e});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};e.load.startsWith("blob:")&&(s.responseType=Go.ResponseType.JSON),Ho.get(e.load,s,((s,i)=>{s?t(`Error loading animation state graph resource: ${e.original} [${s}]`):t(null,i)}))}open(e,t){return new Tm(t)}}class b_ extends lf{constructor(e){super(e,"binary")}load(e,t){"string"==typeof e&&(e={load:e,original:e}),Ho.get(e.load,{responseType:Go.ResponseType.ARRAY_BUFFER,retry:this.maxRetries>0,maxRetries:this.maxRetries},((s,i)=>{s?t(`Error loading binary resource: ${e.original} [${s}]`):t(null,i)}))}openBinary(e){return e.buffer}}class y_{constructor(e,t,s,i){const n=function(e,i,n){const r=y_.createAsset(t.name,e,i,n);return s.add(r),r},r=[];for(let t=0;t<e.renders.length;++t)r.push(n("render",e.renders[t],t));const a=[];for(let t=0;t<e.materials.length;++t)a.push(n("material",e.materials[t],t));const o=[];for(let t=0;t<e.animations.length;++t)o.push(n("animation",e.animations[t],t));this.data=e,this._model=null,this._assetName=t.name,this._assets=s,this._defaultMaterial=i,this.renders=r,this.materials=a,this.textures=e.textures,this.animations=o}get model(){if(!this._model){const e=y_.createModel(this.data,this._defaultMaterial),t=y_.createAsset(this._assetName,"model",e,0);this._assets.add(t),this._model=t}return this._model}static createAsset(e,t,s,i){const n=new ef(`${e}/${t}/${i}`,t,{url:""});return n.resource=s,n.loaded=!0,n}instantiateModelEntity(e){const t=new vf;return t.addComponent("model",Object.assign({type:"asset",asset:this.model},e)),t}instantiateRenderEntity(e){const t=this._defaultMaterial,s=[],i=function(e,i,n,r,a,o,l,h){const c=a[n.id],d=void 0===c?t:r[c],u=new Hl(n,d);n.morph&&(u.morphInstance=new Pd(n.morph)),l.hasOwnProperty("skin")&&s.push({meshInstance:u,rootBone:e,entity:i});const p=h.get(l);if(p){const e=p.matrices,t=Kn.getDefaultInstancingFormat(n.device),s=new Hn(n.device,t,e.length/16,{data:e});u.setInstancing(s),u.instancingData._destroyVertexBuffer=!0}return u},n=(t,s,r)=>{const a=new vf;s._cloneInternal(a),t||(t=a);let o=null,l=null;for(let e=0;e<r.nodes.length;e++){if(r.nodes[e]===s){const s=r.gltf.nodes[e];if(s.hasOwnProperty("mesh")){const e=r.renders[s.mesh].meshes;l=this.renders[s.mesh];for(let n=0;n<e.length;n++){const l=e[n];if(l){const e=i(t,a,l,r.materials,r.meshDefaultMaterials,r.skins,s,r.nodeInstancingMap);o||(o=[]),o.push(e)}}}if(r.lights){const e=r.lights.get(s);e&&a.addChild(e.clone())}if(r.cameras){const e=r.cameras.get(s);e&&e.camera.system.cloneComponent(e,a)}}}o&&(a.addComponent("render",Object.assign({type:"asset",meshInstances:o,rootBone:t},e)),a.render.assignAsset(l));const h=s.children;for(let e=0;e<h.length;e++){const s=n(t,h[e],r);a.addChild(s)}return a},r=[];for(const e of this.data.scenes)r.push(n(null,e,this.data));return s.forEach((e=>{e.meshInstance.skinInstance=Im.createCachedSkinInstance(e.meshInstance.mesh.skin,e.rootBone,e.entity)})),y_.createSceneHierarchy(r,vf)}getMaterialVariants(){return this.data.variants?Object.keys(this.data.variants):[]}applyMaterialVariant(e,t){const s=t?this.data.variants[t]:null;if(void 0===s)return;const i=e.findComponents("render");for(let e=0;e<i.length;e++){const t=i[e];this._applyMaterialVariant(s,t.meshInstances)}}applyMaterialVariantInstances(e,t){const s=t?this.data.variants[t]:null;void 0!==s&&this._applyMaterialVariant(s,e)}_applyMaterialVariant(e,t){t.forEach((t=>{if(null===e)t.material=this._defaultMaterial;else{const s=this.data.meshVariants[t.mesh.id];s&&(t.material=this.data.materials[s[e]])}}))}static createSceneHierarchy(e,t){let s=null;if(1===e.length)s=e[0];else{s=new t("SceneGroup");for(const t of e)s.addChild(t)}return s}static createModel(e,t){const s=function(s,i,n,r,a,o,l){const h=e.meshDefaultMaterials[i.id],c=void 0===h?t:a[h],d=new Hl(i,c,o);if(i.morph){const e=new Pd(i.morph);d.morphInstance=e,s.morphInstances.push(e)}if(l.hasOwnProperty("skin")){const e=l.skin,t=n[e];i.skin=t;const a=r[e];d.skinInstance=a,s.skinInstances.push(a)}s.meshInstances.push(d)},i=new kd,n=[];for(const t of e.skins){const e=new Pl(t);e.bones=t.bones,n.push(e)}i.graph=y_.createSceneHierarchy(e.scenes,vh);for(let t=0;t<e.nodes.length;t++){const r=e.nodes[t];if(r.root===i.graph){const a=e.gltf.nodes[t];if(a.hasOwnProperty("mesh")){const t=e.renders[a.mesh].meshes;for(let o=0;o<t.length;o++){const l=t[o];l&&s(i,l,e.skins,n,e.materials,r,a)}}}}return i}destroy(){const e=this._assets,t=function(t){e.remove(t),t.unload()},s=function(e){e.forEach((e=>{t(e)}))};this.animations&&(s(this.animations),this.animations=null),this.textures&&(s(this.textures),this.textures=null),this.materials&&(s(this.materials),this.materials=null),this.renders&&(s(this.renders),this.renders=null),this._model&&(t(this._model),this._model=null),this.data=null,this.assets=null}}class x_{constructor(e,t,s){this._device=e,this._assets=t,this._defaultMaterial=g_.createDefaultMaterial(),this.maxRetries=s}_getUrlWithoutParams(e){return e.indexOf("?")>=0?e.split("?")[0]:e}load(e,t,s){ef.fetchArrayBuffer(e.load,((i,n)=>{i?t(i):g_.parse(this._getUrlWithoutParams(e.original),It.extractPath(e.load),n,this._device,s.registry,s.options,((e,i)=>{e?t(e):t(null,new y_(i,s,this._assets,this._defaultMaterial))}))}),s,this.maxRetries)}open(e,t,s){return t}patch(e,t){}}class w_ extends lf{constructor(e){super(e,"container"),this.glbContainerParser=new x_(e.graphicsDevice,e.assets,0),this.parsers={}}set maxRetries(e){this.glbContainerParser.maxRetries=e;for(const t in this.parsers)this.parsers.hasOwnProperty(t)&&(this.parsers[t].maxRetries=e)}get maxRetries(){return this.glbContainerParser.maxRetries}_getUrlWithoutParams(e){return e.indexOf("?")>=0?e.split("?")[0]:e}_getParser(e){const t=e?It.getExtension(this._getUrlWithoutParams(e)).toLowerCase().replace(".",""):null;return this.parsers[t]||this.glbContainerParser}load(e,t,s){"string"==typeof e&&(e={load:e,original:e}),this._getParser(e.original).load(e,t,s)}open(e,t,s){return this._getParser(e).open(e,t,s)}}class S_ extends lf{constructor(e){super(e,"cubemap"),this._device=e.graphicsDevice,this._registry=e.assets,this._loader=e.loader}load(e,t,s){this.loadAssets(s,t)}open(e,t,s){return s?s.resource:null}patch(e,t){this.loadAssets(e,((s,i)=>{s&&(t.fire("error",e),t.fire(`error:${e.id}`,s,e),e.fire("error",e))}))}getAssetIds(e){const t=[];if(t[0]=e.file,(e.loadFaces||!e.file)&&e.data&&e.data.textures)for(let s=0;s<6;++s)t[s+1]=e.data.textures[s];else t[1]=t[2]=t[3]=t[4]=t[5]=t[6]=null;return t}compareAssetIds(e,t){return e&&t?parseInt(e,10)===e||"string"==typeof e?e===t:e.url===t.url:null!==e==(null!==t)}update(e,t,s){const i=e.data||{},n=e._handlerState.assets,r=e._resources;let a,o,l;const h=[null,null,null,null,null,null,null],c=function(){return i.hasOwnProperty("type")?i.type:i.hasOwnProperty("rgbm")?i.rgbm?Mi:Ai:null};if(e.loaded&&s[0]===n[0])h[1]=r[1]||null,h[2]=r[2]||null,h[3]=r[3]||null,h[4]=r[4]||null,h[5]=r[5]||null,h[6]=r[6]||null;else if(s[0])if(a=s[0].resource,a.cubemap)for(l=0;l<6;++l)h[l+1]=new yn(this._device,{name:`${e.name}_prelitCubemap${a.width>>l}`,cubemap:!0,type:c()||a.type,width:a.width>>l,height:a.height>>l,format:a.format,levels:[a._levels[l]],addressU:1,addressV:1,mipmaps:0===l});else h[1]=a;const d=s.slice(1);if(e.loaded&&this.cmpArrays(d,n.slice(1)))h[0]=r[0]||null;else if(-1===d.indexOf(null)){var u;const t=d.map((e=>e.resource)),s=[];for(o=0;o<t[0]._levels.length;++o)s.push(t.map((e=>e._levels[o])));const n=t[0].format,r=new yn(this._device,{name:`${e.name}_faces`,cubemap:!0,type:c()||t[0].type,width:t[0].width,height:t[0].height,format:6===n?7:n,mipmaps:null==(u=i.mipmaps)||u,levels:s,minFilter:i.hasOwnProperty("minFilter")?i.minFilter:t[0].minFilter,magFilter:i.hasOwnProperty("magFilter")?i.magFilter:t[0].magFilter,anisotropy:i.hasOwnProperty("anisotropy")?i.anisotropy:1,addressU:1,addressV:1});h[0]=r}if(!this.cmpArrays(h,r))for(e.resources=h,e._handlerState.assetIds=t,e._handlerState.assets=s,l=0;l<r.length;++l)null!==r[l]&&-1===h.indexOf(r[l])&&r[l].destroy();for(l=0;l<n.length;++l)null!==n[l]&&-1===s.indexOf(n[l])&&n[l].unload()}cmpArrays(e,t){if(e.length!==t.length)return!1;for(let s=0;s<e.length;++s)if(e[s]!==t[s])return!1;return!0}resolveId(e){const t=parseInt(e,10);return t===e||t.toString()===e?t:e}loadAssets(e,t){e.hasOwnProperty("_handlerState")||(e._handlerState={assetIds:[null,null,null,null,null,null,null],assets:[null,null,null,null,null,null,null]});const s=this,i=s.getAssetIds(e),n=[null,null,null,null,null,null,null],r=e._handlerState.assetIds,a=e._handlerState.assets,o=s._registry;let l=7;const h=function(r,a){n[r]=a,l--,0===l&&(s.update(e,i,n),t(null,e.resources))},c=function(e,s,i){t(s)},d=function(e,t){t.loaded?h(e,t):(o.once(`load:${t.id}`,h.bind(s,e)),o.once(`error:${t.id}`,c.bind(s,e)),t.loading||o.load(t))};let u;for(let t=0;t<7;++t){const n=this.resolveId(i[t]);if(n)if(s.compareAssetIds(n,r[t]))d(t,a[t]);else if(parseInt(n,10)===n)u=o.get(n),u?d(t,u):setTimeout(((e,t)=>{const s=o.get(t);s?d(e,s):c(0,`failed to find dependent cubemap asset=${t}`)}).bind(null,t,n));else{const s="string"==typeof n?{url:n,filename:n}:n,i=-1===s.url.search(".dds")?{type:"rgbp",addressu:"clamp",addressv:"clamp",mipmaps:!1}:null;u=new ef(`${e.name}_part_${t}`,"texture",s,i),o.add(u),d(t,u)}else h(t,null)}}}const C_=.28209479177387814;class T_{constructor(e,t,s,i,n,r){const a=(e,t)=>{const s=(1<<t)-1;return(e&s)/s},o=(e,t)=>{e.x=a(t>>>21,11),e.y=a(t>>>11,10),e.z=a(t,11)},l=(e,t,s)=>e*(1-s)+t*s,{chunkData:h,chunkSize:c,vertexData:d,shData:u,shBands:p}=e,f=[3,8,15][p-1];this.read=e=>{const m=Math.floor(e/256)*c;var g,_;if(t&&(o(t,d[4*e+0]),t.x=l(h[m+0],h[m+3],t.x),t.y=l(h[m+1],h[m+4],t.y),t.z=l(h[m+2],h[m+5],t.z)),s&&((e,t)=>{const s=1/(.5*Math.sqrt(2)),i=(a(t>>>20,10)-.5)*s,n=(a(t>>>10,10)-.5)*s,r=(a(t,10)-.5)*s,o=Math.sqrt(1-(i*i+n*n+r*r));switch(t>>>30){case 0:e.set(i,n,r,o);break;case 1:e.set(o,n,r,i);break;case 2:e.set(n,o,r,i);break;case 3:e.set(n,r,o,i)}})(s,d[4*e+1]),i&&(o(i,d[4*e+2]),i.x=l(h[m+6],h[m+9],i.x),i.y=l(h[m+7],h[m+10],i.y),i.z=l(h[m+8],h[m+11],i.z)),n&&(g=n,_=d[4*e+3],g.x=a(_>>>24,8),g.y=a(_>>>16,8),g.z=a(_>>>8,8),g.w=a(_,8),c>12&&(n.x=l(h[m+12],h[m+15],n.x),n.y=l(h[m+13],h[m+16],n.y),n.z=l(h[m+14],h[m+17],n.z))),r&&p>0)for(let t=0;t<3;++t)for(let s=0;s<15;++s)r[15*t+s]=s<f?u[(3*e+t)*f+s]*(8/255)-4:0}}}class E_{constructor(){this.numSplats=void 0,this.chunkData=void 0,this.vertexData=void 0,this.shData=void 0}createIter(e,t,s,i,n){return new T_(this,e,t,s,i,n)}calcAabb(e){const{chunkData:t,numChunks:s,chunkSize:i}=this;let n=Math.exp(Math.max(t[9],t[10],t[11])),r=t[0]-n,a=t[1]-n,o=t[2]-n,l=t[3]+n,h=t[4]+n,c=t[5]+n;for(let e=1;e<s;++e){const s=e*i;n=Math.exp(Math.max(t[s+9],t[s+10],t[s+11])),r=Math.min(r,t[s+0]-n),a=Math.min(a,t[s+1]-n),o=Math.min(o,t[s+2]-n),l=Math.max(l,t[s+3]+n),h=Math.max(h,t[s+4]+n),c=Math.max(c,t[s+5]+n)}return e.center.set(.5*(r+l),.5*(a+h),.5*(o+c)),e.halfExtents.set(.5*(l-r),.5*(h-a),.5*(c-o)),!0}getCenters(e){const{vertexData:t,chunkData:s,numChunks:i,chunkSize:n}=this;let r,a,o,l,h,c;for(let d=0;d<i;++d){const i=d*n;r=s[i+0],a=s[i+1],o=s[i+2],l=s[i+3],h=s[i+4],c=s[i+5];const u=Math.min(this.numSplats,256*(d+1));for(let s=256*d;s<u;++s){const i=t[4*s],n=(i>>>21)/2047,d=(i>>>11&1023)/1023,u=(2047&i)/2047;e[3*s+0]=(1-n)*r+n*l,e[3*s+1]=(1-d)*a+d*h,e[3*s+2]=(1-u)*o+u*c}}}calcFocalPoint(e){const{chunkData:t,numChunks:s,chunkSize:i}=this;e.x=0,e.y=0,e.z=0;for(let n=0;n<s;++n){const s=n*i;e.x+=t[s+0]+t[s+3],e.y+=t[s+1]+t[s+4],e.z+=t[s+2]+t[s+5]}e.mulScalar(.5/s)}get isCompressed(){return!0}get numChunks(){return Math.ceil(this.numSplats/256)}get chunkSize(){return this.chunkData.length/this.numChunks}get shBands(){var e,t;return null!=(e={3:1,8:2,15:3}[(null==(t=this.shData)?void 0:t.length)/this.numSplats/3])?e:0}decompress(){const e=["x","y","z","f_dc_0","f_dc_1","f_dc_2","opacity","scale_0","scale_1","scale_2","rot_0","rot_1","rot_2","rot_3"],{shBands:t}=this;if(t>0){const t=[];for(let e=0;e<45;++e)t.push(`f_rest_${e}`);e.splice(e.indexOf("f_dc_0")+1,0,...t)}const s={};e.forEach((e=>{s[e]=new Float32Array(this.numSplats)}));const i=new ys,n=new Ds,r=new ys,a=new Ss,o=t>0?new Float32Array(45):null,l=this.createIter(i,n,r,a,o);for(let e=0;e<this.numSplats;++e)if(l.read(e),s.x[e]=i.x,s.y[e]=i.y,s.z[e]=i.z,s.rot_1[e]=n.x,s.rot_2[e]=n.y,s.rot_3[e]=n.z,s.rot_0[e]=n.w,s.scale_0[e]=r.x,s.scale_1[e]=r.y,s.scale_2[e]=r.z,s.f_dc_0[e]=(a.x-.5)/C_,s.f_dc_1[e]=(a.y-.5)/C_,s.f_dc_2[e]=(a.z-.5)/C_,s.opacity[e]=a.w<=0?-40:a.w>=1?40:-Math.log(1/a.w-1),o)for(let t=0;t<45;++t)s[`f_rest_${t}`][e]=o[t];return new bp([{name:"vertex",count:this.numSplats,properties:e.map((e=>({name:e,type:"float",byteSize:4,storage:s[e]})))}])}}class P_{constructor(e,t){this.device=void 0,this.numSplats=void 0,this.numSplatsVisible=void 0,this.aabb=void 0,this.centers=void 0,this.packedTexture=void 0,this.chunkTexture=void 0,this.shTexture0=void 0,this.shTexture1=void 0,this.shTexture2=void 0;const{chunkData:s,chunkSize:i,numChunks:n,numSplats:r,vertexData:a,shBands:o}=t;this.device=e,this.numSplats=r,this.numVisibleSplats=r,this.aabb=new Bs,t.calcAabb(this.aabb),this.centers=new Float32Array(3*r),t.getCenters(this.centers),this.packedTexture=this.createTexture("packedData",ei,this.evalTextureSize(r),a);const l=this.evalTextureSize(n);l.x*=5,this.chunkTexture=this.createTexture("chunkData",$s,l);const h=this.chunkTexture.lock();if(((e,t,s,i,n)=>{for(let r=0;r<n;++r)for(let n=0;n<i;++n)e[r*t+n]=s[r*i+n]})(h,20,s,i,n),12===i)for(let e=0;e<n;++e)h[20*e+15]=1,h[20*e+16]=1,h[20*e+17]=1;if(this.chunkTexture.unlock(),o>0){const{shData:e}=t,s=this.evalTextureSize(r),i=this.createTexture("shTexture0",ei,s),n=this.createTexture("shTexture1",ei,s),a=this.createTexture("shTexture2",ei,s),l=i.lock(),h=n.lock(),c=a.lock(),d=new Uint8Array(l.buffer),u=new Uint8Array(h.buffer),p=new Uint8Array(c.buffer),f=[3,8,15][o-1];for(let t=0;t<r;++t)for(let s=0;s<15;++s)d[16*t+s]=s<f?e[(3*t+0)*f+s]:127,u[16*t+s]=s<f?e[(3*t+1)*f+s]:127,p[16*t+s]=s<f?e[(3*t+2)*f+s]:127;i.unlock(),n.unlock(),a.unlock(),this.shTexture0=i,this.shTexture1=n,this.shTexture2=a}else this.shTexture0=null,this.shTexture1=null,this.shTexture2=null}destroy(){var e,t,s,i,n;null==(e=this.packedTexture)||e.destroy(),null==(t=this.chunkTexture)||t.destroy(),null==(s=this.shTexture0)||s.destroy(),null==(i=this.shTexture1)||i.destroy(),null==(n=this.shTexture2)||n.destroy()}createMaterial(e){const t=Sp(e);return t.setDefine("GSPLAT_COMPRESSED_DATA",!0),t.setParameter("packedTexture",this.packedTexture),t.setParameter("chunkTexture",this.chunkTexture),t.setParameter("numSplats",this.numSplatsVisible),this.shTexture0?(t.setDefine("SH_BANDS",3),t.setParameter("shTexture0",this.shTexture0),t.setParameter("shTexture1",this.shTexture1),t.setParameter("shTexture2",this.shTexture2)):t.setDefine("SH_BANDS",0),t}evalTextureSize(e){const t=Math.ceil(Math.sqrt(e)),s=Math.ceil(e/t);return new ws(t,s)}createTexture(e,t,s,i){return new yn(this.device,kn({name:e,width:s.x,height:s.y,format:t,cubemap:!1,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1},i?{levels:[i]}:{}))}}class k_{constructor(e,t){this.device=void 0,this.splatData=void 0,this.splat=null,this.device=e,this.splatData=t}destroy(){var e;this.device=null,this.splatData=null,null==(e=this.splat)||e.destroy(),this.splat=null}createSplat(){return this.splat||(this.splat=this.splatData.isCompressed?new P_(this.device,this.splatData):new Cp(this.device,this.splatData)),this.splat}instantiate(e={}){const t=this.createInstance(e),s=new vf,i=s.addComponent("gsplat",{instance:t});return s.setLocalEulerAngles(0,0,180),i.customAabb=t.splat.aabb.clone(),s}createInstance(e={}){const t=this.createSplat();return new Dp(t,e)}}const A_=new Uint8Array([112,108,121,10]),M_=new Uint8Array([10,101,110,100,95,104,101,97,100,101,114,10]),D_=new Map([["char",Int8Array],["uchar",Uint8Array],["short",Int16Array],["ushort",Uint16Array],["int",Int32Array],["uint",Uint32Array],["float",Float32Array],["double",Float64Array]]);class R_{constructor(e){this.reader=void 0,this.data=void 0,this.view=void 0,this.head=0,this.tail=0,this.reader=e}async read(){const{value:e,done:t}=await this.reader.read();if(t)throw new Error("Stream finished before end of header");this.push(e)}push(e){if(this.data){const t=this.tail-this.head,s=t+e.length;if(this.data.length>=s)this.head>0?(this.data.copyWithin(0,this.head,this.tail),this.data.set(e,t),this.head=0,this.tail=s):(this.data.set(e,this.tail),this.tail+=e.length);else{const i=new Uint8Array(s);this.head>0||this.tail<this.data.length?i.set(this.data.subarray(this.head,this.tail),0):i.set(this.data,0),i.set(e,t),this.data=i,this.view=new DataView(this.data.buffer),this.head=0,this.tail=s}}else this.data=e,this.view=new DataView(this.data.buffer),this.tail=e.length}compact(){this.head>0&&(this.data.copyWithin(0,this.head,this.tail),this.tail-=this.head,this.head=0)}get remaining(){return this.tail-this.head}getInt8(){const e=this.view.getInt8(this.head);return this.head++,e}getUint8(){const e=this.view.getUint8(this.head);return this.head++,e}getInt16(){const e=this.view.getInt16(this.head,!0);return this.head+=2,e}getUint16(){const e=this.view.getUint16(this.head,!0);return this.head+=2,e}getInt32(){const e=this.view.getInt32(this.head,!0);return this.head+=4,e}getUint32(){const e=this.view.getUint32(this.head,!0);return this.head+=4,e}getFloat32(){const e=this.view.getFloat32(this.head,!0);return this.head+=4,e}getFloat64(){const e=this.view.getFloat64(this.head,!0);return this.head+=8,e}}const L_=async(e,t=null)=>{const s=(e,t)=>{const s=e.length-t.length;let i,n;for(i=0;i<=s;++i){for(n=0;n<t.length&&e[i+n]===t[n];++n);if(n===t.length)return i}return-1},i=(e,t)=>{if(e.length<t.length)return!1;for(let s=0;s<t.length;++s)if(e[s]!==t[s])return!1;return!0},n=new R_(e);let r;for(;;){if(await n.read(),n.tail>=A_.length&&!i(n.data,A_))throw new Error("Invalid ply header");if(r=s(n.data,M_),-1!==r)break}const a=new TextDecoder("ascii").decode(n.data.subarray(0,r)).split("\n").filter((e=>!e.startsWith("comment "))),{elements:o,format:l}=(e=>{const t=[];let s;for(let i=1;i<e.length;++i){const n=e[i].split(" ");switch(n[0]){case"format":s=n[1];break;case"element":t.push({name:n[1],count:parseInt(n[2],10),properties:[]});break;case"property":if(!D_.has(n[1]))throw new Error(`Unrecognized property data type '${n[1]}' in ply header`);t[t.length-1].properties.push({type:n[1],name:n[2],storage:null,byteSize:D_.get(n[1]).BYTES_PER_ELEMENT});break;default:throw new Error(`Unrecognized header value '${n[0]}' in ply header`)}}return{elements:t,format:s}})(a);if("binary_little_endian"!==l&&"binary_big_endian"!==l)throw new Error("Unsupported ply format");return n.head=r+M_.length,n.compact(),(e=>{const t=["min_x","min_y","min_z","max_x","max_y","max_z","min_scale_x","min_scale_y","min_scale_z","max_scale_x","max_scale_y","max_scale_z","min_r","min_g","min_b","max_r","max_g","max_b"],s=["packed_position","packed_rotation","packed_scale","packed_color"],i=new Array(45).fill("").map(((e,t)=>`f_rest_${t}`)),n=()=>"chunk"===e[0].name&&e[0].properties.every(((e,s)=>e.name===t[s]&&"float"===e.type))&&"vertex"===e[1].name&&e[1].properties.every(((e,t)=>e.name===s[t]&&"uint"===e.type));return 2===e.length&&n()||3===e.length&&n()&&"sh"===e[2].name&&-1!==[9,24,45].indexOf(e[2].properties.length)&&e[2].properties.every(((e,t)=>e.name===i[t]&&"uchar"===e.type))})(o)?await(async(e,t)=>{const s=new E_,i=t[0].count,n=t[0].properties.length,r=t[1].count;s.numSplats=r,s.chunkData=new Float32Array(i*n),s.vertexData=new Uint32Array(4*(e=>{const t=Math.ceil(Math.sqrt(e));return t*Math.ceil(e/t)})(r));const a=async(t,s)=>{const i=new Uint8Array(t);let n=0;for(;n<s;){for(;0===e.remaining;)await e.read();const t=Math.min(s-n,e.remaining),r=e.data;for(let s=0;s<t;++s)i[n++]=r[e.head++]}};return await a(s.chunkData.buffer,i*n*4),await a(s.vertexData.buffer,4*r*4),3===t.length&&(s.shData=new Uint8Array(t[2].count*t[2].properties.length),await a(s.shData.buffer,s.shData.byteLength)),s})(n,o):(o.forEach((e=>{e.properties.forEach((s=>{const i=D_.get(s.type);if(i){const n=!t||t(s.name)?new i(e.count):null;s.storage=n}}))})),(e=>1===e.length&&"vertex"===e[0].name&&e[0].properties.every((e=>"float"===e.type)))(o)?await(async(e,t)=>{const s=t[0],i=s.properties,n=i.length,r=i.map((e=>e.storage)),a=i.reduce(((e,t)=>e+t.byteSize),0);let o,l=0;const h=()=>{var t;const s=e.data.buffer;(null==(t=o)?void 0:t.buffer)!==s&&(o=new Float32Array(s,0,s.byteLength/4))};for(h();l<s.count;){for(;e.remaining<a;)await e.read(),h();const t=Math.min(s.count-l,Math.floor(e.remaining/a));for(let e=0;e<n;++e){const s=r[e];for(let i=0;i<t;++i)s[i+l]=o[i*n+e]}l+=t,e.head+=t*a}return new bp(t)})(n,o):await(async(e,t)=>{for(let s=0;s<t.length;++s){const i=t[s],n=i.properties.reduce(((e,t)=>e+t.byteSize),0),r=i.properties.map((e=>{if(!e.storage)return t=>{t.head+=e.byteSize};switch(e.type){case"char":return(t,s)=>{e.storage[s]=t.getInt8()};case"uchar":return(t,s)=>{e.storage[s]=t.getUint8()};case"short":return(t,s)=>{e.storage[s]=t.getInt16()};case"ushort":return(t,s)=>{e.storage[s]=t.getUint16()};case"int":return(t,s)=>{e.storage[s]=t.getInt32()};case"uint":return(t,s)=>{e.storage[s]=t.getUint32()};case"float":return(t,s)=>{e.storage[s]=t.getFloat32()};case"double":return(t,s)=>{e.storage[s]=t.getFloat64()};default:throw new Error(`Unsupported property data type '${e.type}' in ply header`)}}));let a=0;for(;a<i.count;){for(;e.remaining<n;)await e.read();const t=Math.min(i.count-a,Math.floor(e.remaining/n));for(let s=0;s<t;++s){for(let t=0;t<i.properties.length;++t)r[t](e,a);a++}}}return new bp(t)})(n,o))},I_=e=>!0;class F_{constructor(e,t,s){this.device=void 0,this.assets=void 0,this.maxRetries=void 0,this.device=e,this.assets=t,this.maxRetries=s}async load(e,t,s){try{const r=await fetch(e.load);if(r&&r.body){var i;const e=await L_(r.body.getReader(),null!=(i=s.data.elementFilter)?i:I_);var n;if(!e.isCompressed)(null==(n=s.data.reorder)||n)&&e.reorderData();t(null,new k_(this.device,e.isCompressed&&s.data.decompress?e.decompress():e))}else t("Error loading resource",null)}catch(e){t(e,null)}}open(e,t){return t}}class O_ extends lf{constructor(e){super(e,"gsplat"),this.parser=new F_(e.graphicsDevice,e.assets,3)}load(e,t,s){"string"==typeof e&&(e={load:e,original:e}),this.parser.load(e,t,s)}open(e,t,s){return this.parser.open(e,t,s)}}function B_(){const e=0,t=1,s=2,i=3,n=8,r=9,a=10,o=11,l=12,h=13,c=14,d=16,u={astc:a,dxt:s,etc1:e,etc2:e,pvr:n,atc:o,none:c},p={astc:a,dxt:i,etc1:d,etc2:t,pvr:r,atc:l,none:d},f=21,m=22,g=23,_=8,v=10,b=26,y=27,x=28,w=29,S=30,C=7,T=3,E=5,P=(u,p)=>{switch(u){case e:return p.formats.etc1?f:m;case t:return g;case s:return _;case i:return v;case n:return b;case r:return y;case a:return x;case o:return w;case l:return S;case h:return C;case c:return T;case d:return E}},k=e=>{const t=function(e,t){const s=e*(2/255)-1,i=t*(2/255)-1,n=Math.sqrt(1-Math.min(1,s*s+i*i));return Math.max(0,Math.min(255,Math.floor(.5*(n+1)*255)))};for(let s=0;s<e.length;s+=4){const i=e[s+3],n=e[s+1];e[s+0]=i,e[s+2]=t(i,n),e[s+3]=255}return e},A=e=>{const t=new Uint16Array(e.length/4);for(let s=0;s<e.length;s+=4){const i=e[s+0],n=e[s+1],r=e[s+2];t[s/4]=(248&i)<<8|(252&n)<<3|r>>3}return t},M=()=>"undefined"!=typeof performance?performance.now():0;let D,R,L;const I=(e,t,s)=>{if(s){if(e.formats.astc)return"astc"}else if(t){if(e.formats.etc2)return"etc2"}else if(e.formats.etc1||e.formats.etc2)return"etc1";return(t=>{for(let s=0;s<t.length;++s){const i=t[s];if(e.formats[i])return i}return"none"})(t?L:R)},F=(h,c,d)=>{switch(d){case e:case t:return!0;case s:case i:return!(3&h||3&c);case n:case r:return((e,t)=>!(e&e-1||t&t-1))(h,c);case a:case o:case l:return!0}return!1},O=(e,t,s)=>s.isKTX2?((e,t,s)=>{if(!D.KTX2File)throw new Error("Basis transcoder module does not include support for KTX2.");const i=M(),n=new D.KTX2File(new Uint8Array(t)),r=n.getWidth(),a=n.getHeight(),o=n.getLevels(),l=!!n.getHasAlpha(),f=n.isUASTC&&n.isUASTC();if(!r||!a||!o)throw n.close(),n.delete(),new Error(`Invalid image dimensions url=${e} width=${r} height=${a} levels=${o}`);const m=I(s.deviceDetails,l,f),g=!!s.isGGGR&&"pvr"===m;let _,v;if(g?_=h:(_=l?p[m]:u[m],F(r,a,_)||(_=l?h:c)),!n.startTranscoding())throw n.close(),n.delete(),new Error(`Failed to start transcoding url=${e}`);const b=[];for(let t=0;t<o;++t){const s=n.getImageTranscodedSizeInBytes(t,0,0,_),i=new Uint8Array(s);if(!n.transcodeImage(i,t,0,0,_,0,-1,-1))throw n.close(),n.delete(),new Error(`Failed to transcode image url=${e}`);const r=_===c||_===d;b.push(r?new Uint16Array(i.buffer):i)}if(n.close(),n.delete(),g)for(_=c,v=0;v<b.length;++v)b[v]=A(k(b[v]));return{format:P(_,s.deviceDetails),width:r,height:a,levels:b,cubemap:!1,transcodeTime:M()-i,url:e,unswizzledGGGR:g}})(e,t,s):((e,t,s)=>{const i=M(),n=new D.BasisFile(new Uint8Array(t)),r=n.getImageWidth(0,0),a=n.getImageHeight(0,0),o=n.getNumImages(),l=n.getNumLevels(0),f=!!n.getHasAlpha(),m=n.isUASTC&&n.isUASTC();if(!(r&&a&&o&&l))throw n.close(),n.delete(),new Error(`Invalid image dimensions url=${e} width=${r} height=${a} images=${o} levels=${l}`);const g=I(s.deviceDetails,f,m),_=!!s.isGGGR&&"pvr"===g;let v,b;if(_?v=h:(v=f?p[g]:u[g],F(r,a,v)||(v=f?h:c)),!n.startTranscoding())throw n.close(),n.delete(),new Error(`Failed to start transcoding url=${e}`);const y=[];for(let t=0;t<l;++t){const s=n.getImageTranscodedSizeInBytes(0,t,v),i=new Uint8Array(s);if(!n.transcodeImage(i,0,t,v,0,0)){if(t!==l-1||s!==y[t-1].buffer.byteLength)throw n.close(),n.delete(),new Error(`Failed to transcode image url=${e}`);i.set(new Uint8Array(y[t-1].buffer)),console.warn(`Failed to transcode last mipmap level, using previous level instead url=${e}`)}const r=v===c||v===d;y.push(r?new Uint16Array(i.buffer):i)}if(n.close(),n.delete(),_)for(v=c,b=0;b<y.length;++b)y[b]=A(k(y[b]));return{format:P(v,s.deviceDetails),width:r,height:a,levels:y,cubemap:!1,transcodeTime:M()-i,url:e,unswizzledGGGR:_}})(e,t,s),B=(e,t,s)=>{try{const i=O(e,t,s);i.levels=i.levels.map((e=>e.buffer)),self.postMessage({url:e,data:i},i.levels)}catch(t){self.postMessage({url:e,err:t},null)}},z=[];self.onmessage=e=>{const t=e.data;switch(t.type){case"init":s=t.config,i=()=>{for(let e=0;e<z.length;++e)B(z[e].url,z[e].data,z[e].options);z.length=0},self.BASIS(s.module?{instantiateWasm:(e,t)=>(WebAssembly.instantiate(s.module,e).then((e=>{t(e)})).catch((e=>{console.error(`instantiate failed + ${e}`)})),{})}:null).then((e=>{e.initializeBasis(),D=e,R=s.rgbPriority,L=s.rgbaPriority,i(null)}));break;case"transcode":D?B(t.url,t.data,t.options):z.push(t)}var s,i}}const z_=e=>({astc:!!e.extCompressedTextureASTC,atc:!!e.extCompressedTextureATC,dxt:!!e.extCompressedTextureS3TC,etc1:!!e.extCompressedTextureETC1,etc2:!!e.extCompressedTextureETC,pvr:!!e.extCompressedTexturePVRTC});class N_{constructor(e,t,s){this.queue=e,this.worker=new Worker(t.workerUrl),this.worker.addEventListener("message",(e=>{const t=e.data;this.queue.handleResponse(t.url,t.err,t.data),this.eager||this.queue.enqueueClient(this)})),this.worker.postMessage({type:"init",config:t}),this.eager=s}run(e){const t=[];e.data instanceof ArrayBuffer&&t.push(e.data),this.worker.postMessage({type:"transcode",url:e.url,format:e.format,data:e.data,options:e.options},t),this.eager&&this.queue.enqueueClient(this)}}const U_=["etc1","etc2","astc","dxt","pvr","atc"],V_=["astc","dxt","etc2","pvr","atc"],G_=new class{constructor(){this.callbacks={},this.queue=[],this.clients=[]}enqueueJob(e,t,s,i){if(this.callbacks.hasOwnProperty(e))this.callbacks[e].push(s);else{this.callbacks[e]=[s];const n={url:e,data:t,options:i};this.clients.length>0?this.clients.shift().run(n):this.queue.push(n)}}enqueueClient(e){this.queue.length>0?e.run(this.queue.shift()):this.clients.push(e)}handleResponse(e,t,s){const i=this.callbacks[e];if(t)for(let e=0;e<i.length;++e)i[e](t);else{3===s.format||5===s.format?s.levels=s.levels.map((e=>new Uint16Array(e))):s.levels=s.levels.map((e=>new Uint8Array(e)));for(let e=0;e<i.length;++e)i[e](null,s)}delete this.callbacks[e]}};let H_=null,j_=!1;function W_(e){if(!j_){if(e){if(e.lazyInit)return void(H_=e)}else e=H_||{};if(!e.glueUrl||!e.wasmUrl||!e.fallbackUrl){const t=Qt.getConfig("BASIS");t&&(e={glueUrl:t.glueUrl,wasmUrl:t.wasmUrl,fallbackUrl:t.fallbackUrl,numWorkers:t.numWorkers})}if(e.glueUrl||e.wasmUrl||e.fallbackUrl){j_=!0;const t=Math.max(1,Math.min(16,e.numWorkers||1)),s=1===e.numWorkers||!e.hasOwnProperty("eagerWorkers")||e.eagerWorkers;e.rgbPriority=e.rgbPriority||U_,e.rgbaPriority=e.rgbaPriority||V_,e.maxRetries=e.hasOwnProperty("maxRetries")?e.maxRetries:5,((e,t)=>{const s=e=>{const t=["/* basis */",e,"",`(${B_.toString()})()\n\n`].join("\n");return new Blob([t],{type:"application/javascript"})},i=(i,n)=>{t(null,{workerUrl:URL.createObjectURL(s(i)),module:n,rgbPriority:e.rgbPriority,rgbaPriority:e.rgbaPriority})},n={cache:!0,responseType:"text",retry:e.maxRetries>0,maxRetries:e.maxRetries};if(e.glueUrl&&e.wasmUrl&&(()=>{try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){const e=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(e instanceof WebAssembly.Module)return new WebAssembly.Instance(e)instanceof WebAssembly.Instance}}catch(e){}return!1})()){let s=null,r=null;Ho.get(e.glueUrl,n,((e,n)=>{e?t(e):r?i(n,r):s=n}));const a=fetch(e.wasmUrl),o=()=>{a.then((e=>e.arrayBuffer())).then((e=>WebAssembly.compile(e))).then((e=>{s?i(s,e):r=e})).catch((e=>{t(e,null)}))};WebAssembly.compileStreaming?WebAssembly.compileStreaming(a).then((e=>{s?i(s,e):r=e})).catch((e=>{o()})):o()}else Ho.get(e.fallbackUrl,n,((e,s)=>{e?t(e,null):i(s,null)}))})(e,((e,i)=>{if(e)console.error(`failed to initialize basis worker: ${e}`);else for(let e=0;e<t;++e)G_.enqueueClient(new N_(G_,i,s))}))}}}let $_=null;function q_(e,t,s,i,n){return W_(),$_||($_={formats:z_(e)}),G_.enqueueJob(t,s,i,{deviceDetails:$_,isGGGR:!(null==n||!n.isGGGR),isKTX2:!(null==n||!n.isKTX2)}),j_}class X_{load(e,t,s){throw new Error("not implemented")}open(e,t,s){throw new Error("not implemented")}}class K_ extends X_{constructor(e,t){super(),this.device=t,this.maxRetries=0}load(e,t,s){const i=this.device;ef.fetchArrayBuffer(e.load,((n,r)=>{n?t(n):(n=>{var r;q_(i,e.load,n,t,{isGGGR:!!(8&(null==s||null==(r=s.file)||null==(r=r.variants)||null==(r=r.basis)?void 0:r.opt))})||t(`Basis module not found. Asset [${s.name}](${s.getFileUrl()}) basis texture variant will not be loaded.`)})(r)}),s,this.maxRetries)}open(e,t,s,i={}){const n=i.srgb?ai(t.format):t.format,r=new yn(s,kn({name:e,addressU:t.cubemap?1:0,addressV:t.cubemap?1:0,width:t.width,height:t.height,format:n,cubemap:t.cubemap,levels:t.levels},i));return r.upload(),r}}class Y_ extends X_{constructor(e,t){super(),this.crossOrigin=e.prefix?"anonymous":null,this.maxRetries=0,this.device=t}load(e,t,s){var i;const n=!(null==s||null==(i=s.file)||!i.contents);if(n){if(this.device.supportsImageBitmap)return void this._loadImageBitmapFromBlob(new Blob([s.file.contents]),t);e={load:URL.createObjectURL(new Blob([s.file.contents])),original:e.original}}const r=(s,i)=>{n&&URL.revokeObjectURL(e.load),t(s,i)};let a;s&&s.options&&s.options.hasOwnProperty("crossOrigin")?a=s.options.crossOrigin:Kp.test(e.load)&&(a=this.crossOrigin),this.device.supportsImageBitmap?this._loadImageBitmap(e.load,e.original,a,r):this._loadImage(e.load,e.original,a,r)}open(e,t,s,i={}){const n=new yn(s,kn({name:e,width:t.width,height:t.height,format:i.srgb?Qs:7},i));return n.setSource(t),n}_loadImage(e,t,s,i){const n=new Image;s&&(n.crossOrigin=s);let r=0;const a=this.maxRetries;let o;n.onload=function(){i(null,n)},n.onerror=function(){if(!o)if(a>0&&++r<=a){const s=100*Math.pow(2,r);console.log(`Error loading Texture from: '${t}' - Retrying in ${s}ms...`);const i=e.indexOf("?")>=0?"&":"?";o=setTimeout((()=>{n.src=`${e+i}retry=${Date.now()}`,o=null}),s)}else i(`Error loading Texture from: '${t}'`)},n.src=e}_loadImageBitmap(e,t,s,i){const n={cache:!0,responseType:"blob",retry:this.maxRetries>0,maxRetries:this.maxRetries};Ho.get(e,n,((e,t)=>{e?i(e):this._loadImageBitmapFromBlob(t,i)}))}_loadImageBitmapFromBlob(e,t){createImageBitmap(e,{premultiplyAlpha:"none",colorSpaceConversion:"none"}).then((e=>t(null,e))).catch((e=>t(e)))}}const Q_=[1481919403,3140563232,169478669],J_={33776:8,33778:9,33779:js,36196:21,37492:22,37496:23,35840:26,35841:Js,35842:27,35843:Zs,32849:6,32856:7,35905:19,35907:Qs,35898:Ys,34843:11,34842:Ws};class Z_ extends X_{constructor(e){super(),this.maxRetries=0}load(e,t,s){ef.fetchArrayBuffer(e.load,t,s,this.maxRetries)}open(e,t,s,i={}){const n=this.parse(t);if(!n)return null;const r=i.srgb?ai(n.format):n.format,a=new yn(s,kn({name:e,addressU:n.cubemap?1:0,addressV:n.cubemap?1:0,width:n.width,height:n.height,format:r,cubemap:n.cubemap,levels:n.levels},i));return a.upload(),a}parse(e){const t=new Uint32Array(e);if(Q_[0]!==t[0]||Q_[1]!==t[1]||Q_[2]!==t[2])return null;const s={endianness:t[3],glType:t[4],glTypeSize:t[5],glFormat:t[6],glInternalFormat:t[7],glBaseInternalFormat:t[8],pixelWidth:t[9],pixelHeight:t[10],pixelDepth:t[11],numberOfArrayElements:t[12],numberOfFaces:t[13],numberOfMipmapLevels:t[14],bytesOfKeyValueData:t[15]};if(s.pixelDepth>1)return null;if(0!==s.numberOfArrayElements)return null;const i=J_[s.glInternalFormat];if(void 0===i)return null;let n=16+s.bytesOfKeyValueData/4;const r=s.numberOfFaces>1,a=[];for(let c=0;c<(s.numberOfMipmapLevels||1);c++){const s=t[n++];r&&a.push([]);const d=r?a[c]:a;for(let t=0;t<(r?6:1);++t)d.push((o=e,l=4*n,h=s,i===Ys?new Uint32Array(o,l,h/4):new Uint8Array(o,l,h))),n+=s+3>>2}var o,l,h;return{format:i,width:s.pixelWidth,height:s.pixelHeight,levels:a,cubemap:r}}}const ev=166;class tv extends X_{constructor(e,t){super(),this.maxRetries=0,this.device=t}load(e,t,s){ef.fetchArrayBuffer(e.load,((i,n)=>{i?t(i,n):this.parse(n,e,t,s)}),s,this.maxRetries)}open(e,t,s,i={}){const n=i.srgb?ai(t.format):t.format,r=new yn(s,kn({name:e,addressU:t.cubemap?1:0,addressV:t.cubemap?1:0,width:t.width,height:t.height,format:n,cubemap:t.cubemap,levels:t.levels},i));return r.upload(),r}parse(e,t,s,i){const n=new Jt(e),r=[n.readU32be(),n.readU32be(),n.readU32be()];if(2873840728!==r[0]||540160187!==r[1]||218765834!==r[2])return null;const a={vkFormat:n.readU32(),typeSize:n.readU32(),pixelWidth:n.readU32(),pixelHeight:n.readU32(),pixelDepth:n.readU32(),layerCount:n.readU32(),faceCount:n.readU32(),levelCount:n.readU32(),supercompressionScheme:n.readU32()},o={dfdByteOffset:n.readU32(),dfdByteLength:n.readU32(),kvdByteOffset:n.readU32(),kvdByteLength:n.readU32(),sgdByteOffset:n.readU64(),sgdByteLength:n.readU64()},l=[];for(let e=0;e<Math.max(1,a.levelCount);++e)l.push({byteOffset:n.readU64(),byteLength:n.readU64(),uncompressedByteLength:n.readU64()});if(n.readU32()!==o.kvdByteOffset-o.dfdByteOffset)return null;n.skip(8);const h=n.readU8();if(n.skip(o.dfdByteLength-9),n.skip(o.kvdByteLength),1===a.supercompressionScheme||h===ev){var c;q_(this.device,t.load,e,s,{isGGGR:!!(8&(null==i||null==(c=i.file)||null==(c=c.variants)||null==(c=c.basis)?void 0:c.opt)),isKTX2:!0})||s(`Basis module not found. Asset [${i.name}](${i.getFileUrl()}) basis texture variant will not be loaded.`)}else s("unsupported KTX2 pixel format")}}class sv extends X_{constructor(e){super(),this.maxRetries=0}load(e,t,s){ef.fetchArrayBuffer(e.load,t,s,this.maxRetries)}open(e,t,s,i={}){const n=new Uint32Array(t,0,32),r=n[4],a=n[3],o=Math.max(n[7],1),l=4===n[20],h=n[21],c=n[22],d=65024===n[28],u=827611204,p=825438800,f=825439312;let m,g=!1,_=!1,v=!1,b=!1,y=null,x=1;if(l?h===u?(y=8,g=!0):894720068===h?(y=js,g=!0):113===h?(y=Ws,x=2):116===h?(y=$s,x=4):826496069===h?(y=21,g=!0,_=!0):h===p||825504336===h?(y=h===p?Js:Zs,g=!0,v=!0):h!==f&&825504848!==h||(y=h===f?26:27,g=!0,b=!0):32===c&&(y=7),!y)return m=new yn(s,{width:4,height:4,format:6,name:"dds-legacy-empty"}),m;m=new yn(s,kn({name:e,addressU:d?1:0,addressV:d?1:0,width:r,height:a,format:y,cubemap:d,mipmaps:o>1},i));let w=128;const S=d?6:1;let C;const T=h===u?8:16;let E,P,k;for(let e=0;e<S;e++){let s=r,i=a;for(let n=0;n<o;n++){g?_?C=Math.floor((s+3)/4)*Math.floor((i+3)/4)*8:v?C=Math.max(s,16)*Math.max(i,8)/4:b?C=Math.max(s,8)*Math.max(i,8)/2:(E=Math.floor((s+4-1)/4),P=Math.floor((i+4-1)/4),k=E*P,C=k*T):C=s*i*4;const r=y===$s?new Float32Array(t,w,C):y===Ws?new Uint16Array(t,w,C):new Uint8Array(t,w,C);d?(m._levels[n]||(m._levels[n]=[]),m._levels[n][e]=r):m._levels[n]=r,w+=C*x,s=Math.max(.5*s,1),i=Math.max(.5*i,1)}}return m.upload(),m}}class iv extends X_{constructor(e){super(),this.maxRetries=0}load(e,t,s){ef.fetchArrayBuffer(e.load,t,s,this.maxRetries)}open(e,t,s,i={}){const n=this.parse(t);if(!n)return null;const r=new yn(s,kn({name:e,addressU:0,addressV:1,minFilter:0,magFilter:0,width:n.width,height:n.height,levels:n.levels,format:7,type:Di,mipmaps:!1},i));return r.upload(),r}parse(e){const t=new Jt(e);if(!t.readLine().startsWith("#?RADIANCE"))return null;const s={};for(;;){const e=t.readLine();if(0===e.length)break;{const t=e.split("=");2===t.length&&(s[t[0]]=t[1])}}if(!s.hasOwnProperty("FORMAT"))return null;const i=t.readLine().split(" ");if(4!==i.length)return null;const n=parseInt(i[1],10),r=parseInt(i[3],10),a=this._readPixels(t,r,n,"-Y"===i[0]);return a?{width:r,height:n,levels:[a]}:null}_readPixels(e,t,s,i){if(t<8||t>32767)return this._readPixelsFlat(e,t,s);const n=[0,0,0,0];if(e.readArray(n),2!==n[0]||2!==n[1]||128&n[2])return e.skip(-4),this._readPixelsFlat(e,t,s);const r=new ArrayBuffer(t*s*4),a=new Uint8Array(r);let o,l,h,c,d,u,p=i?0:4*t*(s-1);for(l=0;l<s;++l){if(l&&e.readArray(n),(n[2]<<8)+n[3]!==t)return null;for(c=0;c<4;++c)for(o=0;o<t;)if(d=e.readU8(),d>128){if(d-=128,o+d>t)return null;for(u=e.readU8(),h=0;h<d;++h)a[p+c+4*o++]=u}else{if(0===d||o+d>t)return null;for(h=0;h<d;++h)a[p+c+4*o++]=e.readU8()}p+=4*t*(i?1:-1)}return a}_readPixelsFlat(e,t,s){return e.remainingBytes===t*s*4?new Uint8Array(e.arraybuffer,e.offset):null}}const nv={repeat:0,clamp:1,mirror:2},rv={nearest:0,linear:1,nearest_mip_nearest:2,linear_mip_nearest:4,nearest_mip_linear:3,linear_mip_linear:5},av={default:Ai,rgbm:Mi,rgbe:Di,rgbp:Ri,swizzleGGGR:Li};class ov extends lf{constructor(e){super(e,"texture");const t=e.assets,s=e.graphicsDevice;this._device=s,this._assets=t,this.imgParser=new Y_(t,s),this.parsers={dds:new sv(t),ktx:new Z_(t),ktx2:new tv(t,s),basis:new K_(t,s),hdr:new iv(t)}}set crossOrigin(e){this.imgParser.crossOrigin=e}get crossOrigin(){return this.imgParser.crossOrigin}set maxRetries(e){this.imgParser.maxRetries=e;for(const t in this.parsers)this.parsers.hasOwnProperty(t)&&(this.parsers[t].maxRetries=e)}get maxRetries(){return this.imgParser.maxRetries}_getUrlWithoutParams(e){return e.indexOf("?")>=0?e.split("?")[0]:e}_getParser(e){const t=It.getExtension(this._getUrlWithoutParams(e)).toLowerCase().replace(".","");return this.parsers[t]||this.imgParser}_getTextureOptions(e){const t={};if(e){var s;(null==(s=e.name)?void 0:s.length)>0&&(t.name=e.name);const i=e.data;i.hasOwnProperty("minfilter")&&(t.minFilter=rv[i.minfilter]),i.hasOwnProperty("magfilter")&&(t.magFilter=rv[i.magfilter]),i.hasOwnProperty("addressu")&&(t.addressU=nv[i.addressu]),i.hasOwnProperty("addressv")&&(t.addressV=nv[i.addressv]),i.hasOwnProperty("mipmaps")&&(t.mipmaps=i.mipmaps),i.hasOwnProperty("anisotropy")&&(t.anisotropy=i.anisotropy),i.hasOwnProperty("flipY")&&(t.flipY=!!i.flipY),i.hasOwnProperty("srgb")&&(t.srgb=!!i.srgb),i.hasOwnProperty("type")?t.type=av[i.type]:i.hasOwnProperty("rgbm")&&i.rgbm?t.type=Mi:e.file&&8&e.file.opt&&(t.type=Li)}return t}load(e,t,s){"string"==typeof e&&(e={load:e,original:e}),this._getParser(e.original).load(e,t,s)}open(e,t,s){if(!e)return;const i=this._getTextureOptions(s);let n=this._getParser(e).open(e,t,this._device,i);return null===n?n=new yn(this._device,{width:4,height:4,format:6}):(!function(e){const t=vn.calcMipLevelsCount(e._width,e._height);if(7!==e._format&&e._format!==$s||e._volume||e._compressed||1===e._levels.length||e._levels.length===t||(s=e._cubemap?e._levels[0][0]:e._levels[0])instanceof HTMLCanvasElement||s instanceof HTMLImageElement||s instanceof HTMLVideoElement)return;var s;const i=function(e,t,s){const i=Math.max(1,e>>1),n=Math.max(1,t>>1),r=new s.constructor(i*n*4),a=Math.floor(e/i),o=Math.floor(t/n),l=a*o;for(let t=0;t<n;++t)for(let n=0;n<i;++n)for(let h=0;h<4;++h){let c=0;for(let i=0;i<o;++i)for(let r=0;r<a;++r)c+=s[4*(n*a+r+(t*o+i)*e)+h];r[4*(n+t*i)+h]=c/l}return r};for(let s=e._levels.length;s<t;++s){const t=Math.max(1,e._width>>s-1),n=Math.max(1,e._height>>s-1);if(e._cubemap){const r=[];for(let a=0;a<6;++a)r.push(i(t,n,e._levels[s-1][a]));e._levels.push(r)}else e._levels.push(i(t,n,e._levels[s-1]))}e._levelsUpdated=e._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0]}(n),t.unswizzledGGGR&&(s.file.variants.basis.opt&=-9)),n}patch(e,t){const s=e.resource;if(!s)return;const i=this._getTextureOptions(e);for(const e of Object.keys(i))s[e]=i[e]}}const lv="immersive-ar",hv="viewer",cv="point",dv="plane",uv="mesh",pv="gpu-optimized",fv="luminance-alpha",mv="unsigned-short",gv="float32";class _v{constructor(e){this._manager=void 0,this._supported=qt.browser&&!!window.XRDOMOverlayState,this._root=null,this._manager=e}get supported(){return this._supported}get available(){return this._supported&&this._manager.active&&null!==this._manager._session.domOverlayState}get state(){return this._supported&&this._manager.active&&this._manager._session.domOverlayState?this._manager._session.domOverlayState.type:null}set root(e){this._supported&&!this._manager.active&&(this._root=e)}get root(){return this._root}}const vv=[],bv=[];class yv extends Kt{constructor(e,t,s,i=null){super(),this.manager=void 0,this._xrHitTestSource=void 0,this._transient=void 0,this._inputSource=void 0,this.manager=e,this._xrHitTestSource=t,this._transient=s,this._inputSource=i}remove(){if(!this._xrHitTestSource)return;const e=this.manager.hitTest.sources,t=e.indexOf(this);-1!==t&&e.splice(t,1),this.onStop()}onStop(){this._xrHitTestSource.cancel(),this._xrHitTestSource=null,this.fire("remove"),this.manager.hitTest.fire("remove",this)}update(e){if(this._transient){const t=e.getHitTestResultsForTransientInput(this._xrHitTestSource);for(let e=0;e<t.length;e++){const s=t[e];if(!s.results.length)continue;let i;s.inputSource&&(i=this.manager.input._getByInputSource(s.inputSource)),this.updateHitResults(s.results,i)}}else{const t=e.getHitTestResults(this._xrHitTestSource);if(!t.length)return;this.updateHitResults(t)}}updateHitResults(e,t){var s,i,n;if(this._inputSource&&this._inputSource!==t)return;const r=null!=(s=vv.pop())?s:new ys;t?r.copy(t.getOrigin()):r.copy(this.manager.camera.getPosition());let a=1/0,o=null;const l=null!=(i=vv.pop())?i:new ys,h=null!=(n=bv.pop())?n:new Ds;for(let t=0;t<e.length;t++){const s=e[t].getPose(this.manager._referenceSpace),i=r.distance(s.transform.position);i>=a||(a=i,o=e[t],l.copy(s.transform.position),h.copy(s.transform.orientation))}this.fire("result",l,h,t||this._inputSource,o),this.manager.hitTest.fire("result",this,l,h,t||this._inputSource,o),vv.push(r),vv.push(l),bv.push(h)}}yv.EVENT_REMOVE="remove",yv.EVENT_RESULT="result";class xv extends Kt{constructor(e){super(),this.manager=void 0,this._supported=qt.browser&&!(!window.XRSession||!window.XRSession.prototype.requestHitTestSource),this._available=!1,this._checkingAvailability=!1,this.sources=[],this.manager=e,this._supported&&(this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this))}_onSessionStart(){if(this.manager.session.enabledFeatures){const e=-1!==this.manager.session.enabledFeatures.indexOf("hit-test");if(!e)return;this._available=e,this.fire("available")}else this._checkingAvailability||(this._checkingAvailability=!0,this.manager.session.requestReferenceSpace(hv).then((e=>{this.manager.session.requestHitTestSource({space:e}).then((e=>{e.cancel(),this.manager.active&&(this._available=!0,this.fire("available"))})).catch((()=>{}))})).catch((()=>{})))}_onSessionEnd(){if(this._available){this._available=!1;for(let e=0;e<this.sources.length;e++)this.sources[e].onStop();this.sources=[],this.fire("unavailable")}}start(e={}){if(!this._supported)return void(null==e.callback||e.callback(new Error("XR HitTest is not supported"),null));if(!this._available)return void(null==e.callback||e.callback(new Error("XR HitTest is not available"),null));let t;e.profile||e.spaceType||(e.spaceType=hv);const s=e.offsetRay;if(s){const e=new DOMPoint(s.origin.x,s.origin.y,s.origin.z,1),i=new DOMPoint(s.direction.x,s.direction.y,s.direction.z,0);t=new XRRay(e,i)}const i=e.callback;e.spaceType?this.manager.session.requestReferenceSpace(e.spaceType).then((s=>{if(!this.manager.session){const e=new Error("XR Session is not started (2)");return i&&i(e),void this.fire("error",e)}this.manager.session.requestHitTestSource({space:s,entityTypes:e.entityTypes||void 0,offsetRay:t}).then((t=>{this._onHitTestSource(t,!1,e.inputSource,i)})).catch((e=>{i&&i(e),this.fire("error",e)}))})).catch((e=>{i&&i(e),this.fire("error",e)})):this.manager.session.requestHitTestSourceForTransientInput({profile:e.profile,entityTypes:e.entityTypes||void 0,offsetRay:t}).then((t=>{this._onHitTestSource(t,!0,e.inputSource,i)})).catch((e=>{i&&i(e),this.fire("error",e)}))}_onHitTestSource(e,t,s,i){if(!this.manager.session){e.cancel();const t=new Error("XR Session is not started (3)");return i&&i(t),void this.fire("error",t)}const n=new yv(this.manager,e,t,null!=s?s:null);this.sources.push(n),i&&i(null,n),this.fire("add",n)}update(e){if(this._available)for(let t=0;t<this.sources.length;t++)this.sources[t].update(e)}get supported(){return this._supported}get available(){return this._available}}xv.EVENT_AVAILABLE="available",xv.EVENT_UNAVAILABLE="unavailable",xv.EVENT_ADD="add",xv.EVENT_REMOVE="remove",xv.EVENT_RESULT="result",xv.EVENT_ERROR="error";class wv extends Kt{constructor(e,t){super(),this._image=void 0,this._width=void 0,this._bitmap=null,this._measuredWidth=0,this._trackable=!1,this._tracking=!1,this._emulated=!1,this._pose=null,this._position=new ys,this._rotation=new Ds,this._image=e,this._width=t}get image(){return this._image}set width(e){this._width=e}get width(){return this._width}get trackable(){return this._trackable}get tracking(){return this._tracking}get emulated(){return this._emulated}prepare(){return this._bitmap?{image:this._bitmap,widthInMeters:this._width}:createImageBitmap(this._image).then((e=>(this._bitmap=e,{image:this._bitmap,widthInMeters:this._width})))}destroy(){this._image=null,this._pose=null,this._bitmap&&(this._bitmap.close(),this._bitmap=null)}getPosition(){return this._pose&&this._position.copy(this._pose.transform.position),this._position}getRotation(){return this._pose&&this._rotation.copy(this._pose.transform.orientation),this._rotation}}wv.EVENT_TRACKED="tracked",wv.EVENT_UNTRACKED="untracked";class Sv extends Kt{constructor(e){super(),this._manager=void 0,this._supported=qt.browser&&!!window.XRImageTrackingResult,this._available=!1,this._images=[],this._manager=e,this._supported&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this))}add(e,t){if(!this._supported||this._manager.active)return null;const s=new wv(e,t);return this._images.push(s),s}remove(e){if(this._manager.active)return;const t=this._images.indexOf(e);-1!==t&&(e.destroy(),this._images.splice(t,1))}_onSessionStart(){this._manager.session.getTrackedImageScores().then((e=>{this._available=!0;for(let t=0;t<e.length;t++)this._images[t]._trackable="trackable"===e[t]})).catch((e=>{this._available=!1,this.fire("error",e)}))}_onSessionEnd(){this._available=!1;for(let e=0;e<this._images.length;e++){const t=this._images[e];t._pose=null,t._measuredWidth=0,t._tracking&&(t._tracking=!1,t.fire("untracked"))}}prepareImages(e){this._images.length?Promise.all(this._images.map((e=>e.prepare()))).then((t=>{e(null,t)})).catch((t=>{e(t,null)})):e(null,null)}update(e){if(!this._available)return;const t=e.getImageTrackingResults(),s={};for(let i=0;i<t.length;i++){s[t[i].index]=t[i];const n=this._images[t[i].index];n._emulated="emulated"===t[i].trackingState,n._measuredWidth=t[i].measuredWidthInMeters,n._pose=e.getPose(t[i].imageSpace,this._manager._referenceSpace)}for(let e=0;e<this._images.length;e++)this._images[e]._tracking&&!s[e]?(this._images[e]._tracking=!1,this._images[e].fire("untracked")):!this._images[e]._tracking&&s[e]&&(this._images[e]._tracking=!0,this._images[e].fire("tracked"))}get supported(){return this._supported}get available(){return this._available}get images(){return this._images}}Sv.EVENT_ERROR="error";class Cv{constructor(e,t){this._index=void 0,this._hand=void 0,this._joints=[],this._tip=null,this._index=e,this._hand=t,this._hand._fingers.push(this)}get index(){return this._index}get hand(){return this._hand}get joints(){return this._joints}get tip(){return this._tip}}const Tv=qt.browser&&window.XRHand?["thumb-tip","index-finger-tip","middle-finger-tip","ring-finger-tip","pinky-finger-tip"]:[],Ev={};for(let e=0;e<Tv.length;e++)Ev[Tv[e]]=!0;class Pv{constructor(e,t,s,i=null){this._index=void 0,this._id=void 0,this._hand=void 0,this._finger=void 0,this._wrist=void 0,this._tip=void 0,this._radius=null,this._localTransform=new As,this._worldTransform=new As,this._localPosition=new ys,this._localRotation=new Ds,this._position=new ys,this._rotation=new Ds,this._dirtyLocal=!0,this._index=e,this._id=t,this._hand=s,this._finger=i,this._wrist="wrist"===t,this._tip=this._finger&&!!Ev[t]}update(e){this._dirtyLocal=!0,this._radius=e.radius,this._localPosition.copy(e.transform.position),this._localRotation.copy(e.transform.orientation)}_updateTransforms(){this._dirtyLocal&&(this._dirtyLocal=!1,this._localTransform.setTRS(this._localPosition,this._localRotation,ys.ONE));const e=this._hand._manager.camera.parent;e?this._worldTransform.mul2(e.getWorldTransform(),this._localTransform):this._worldTransform.copy(this._localTransform)}getPosition(){return this._updateTransforms(),this._worldTransform.getTranslation(this._position),this._position}getRotation(){return this._updateTransforms(),this._rotation.setFromMat4(this._worldTransform),this._rotation}get id(){return this._id}get index(){return this._index}get hand(){return this._hand}get finger(){return this._finger}get wrist(){return this._wrist}get tip(){return this._tip}get radius(){return this._radius||.005}}let kv=[];const Av=new ys,Mv=new ys,Dv=new ys;qt.browser&&window.XRHand&&(kv=[["thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip"],["index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip"],["middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip"],["ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip"],["pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"]]);class Rv extends Kt{constructor(e){super(),this._manager=void 0,this._inputSource=void 0,this._tracking=!1,this._fingers=[],this._joints=[],this._jointsById={},this._tips=[],this._wrist=null;const t=e._xrInputSource.hand;if(this._manager=e._manager,this._inputSource=e,t.get("wrist")){const e=new Pv(0,"wrist",this,null);this._wrist=e,this._joints.push(e),this._jointsById.wrist=e}for(let e=0;e<kv.length;e++){const s=new Cv(e,this);for(let i=0;i<kv[e].length;i++){const n=kv[e][i];if(!t.get(n))continue;const r=new Pv(i,n,this,s);this._joints.push(r),this._jointsById[n]=r,r.tip&&(this._tips.push(r),s._tip=r),s._joints.push(r)}}}update(e){const t=this._inputSource._xrInputSource;for(let s=0;s<this._joints.length;s++){const i=this._joints[s],n=t.hand.get(i._id);if(n){let t;if("hidden"!==e.session.visibilityState&&(t=e.getJointPose(n,this._manager._referenceSpace)),t)i.update(t),i.wrist&&!this._tracking&&(this._tracking=!0,this.fire("tracking"));else if(i.wrist){this._tracking&&(this._tracking=!1,this.fire("trackinglost"));break}}}const s=this._jointsById["thumb-metacarpal"],i=this._jointsById["thumb-tip"],n=this._jointsById["index-finger-phalanx-proximal"],r=this._jointsById["index-finger-tip"],a=this._jointsById["ring-finger-phalanx-proximal"],o=this._jointsById["pinky-finger-phalanx-proximal"];if(s&&i&&n&&r&&a&&o){this._inputSource._dirtyRay=!0,this._inputSource._rayLocal.origin.lerp(i._localPosition,r._localPosition,.5);let e=s,t=o;if("left"===this._inputSource.handedness){const s=e;e=t,t=s}Av.sub2(e._localPosition,this._wrist._localPosition),Mv.sub2(t._localPosition,this._wrist._localPosition),Dv.cross(Av,Mv).normalize(),Av.lerp(n._localPosition,a._localPosition,.5),Av.sub(this._wrist._localPosition).normalize(),this._inputSource._rayLocal.direction.lerp(Dv,Av,.5).normalize()}this._fingerIsClosed(1)&&this._fingerIsClosed(2)&&this._fingerIsClosed(3)&&this._fingerIsClosed(4)?this._inputSource._squeezing||(this._inputSource._squeezing=!0,this._inputSource.fire("squeezestart"),this._manager.input.fire("squeezestart",this._inputSource)):this._inputSource._squeezing&&(this._inputSource._squeezing=!1,this._inputSource.fire("squeeze"),this._manager.input.fire("squeeze",this._inputSource),this._inputSource.fire("squeezeend"),this._manager.input.fire("squeezeend",this._inputSource))}_fingerIsClosed(e){const t=this._fingers[e];return Av.sub2(t.joints[0]._localPosition,t.joints[1]._localPosition).normalize(),Mv.sub2(t.joints[2]._localPosition,t.joints[3]._localPosition).normalize(),Av.dot(Mv)<-.8}getJointById(e){return this._jointsById[e]||null}get fingers(){return this._fingers}get joints(){return this._joints}get tips(){return this._tips}get wrist(){return this._wrist}get tracking(){return this._tracking}}Rv.EVENT_TRACKING="tracking",Rv.EVENT_TRACKINGLOST="trackinglost";const Lv=new ys,Iv=new Ds;let Fv=0;class Ov extends Kt{constructor(e,t){super(),this._id=void 0,this._manager=void 0,this._xrInputSource=void 0,this._ray=new Hs,this._rayLocal=new Hs,this._grip=!1,this._hand=null,this._velocitiesAvailable=!1,this._velocitiesTimestamp=ts(),this._localTransform=null,this._worldTransform=null,this._position=new ys,this._rotation=new Ds,this._localPosition=null,this._localPositionLast=null,this._localRotation=null,this._linearVelocity=null,this._dirtyLocal=!0,this._dirtyRay=!1,this._selecting=!1,this._squeezing=!1,this._elementInput=!0,this._elementEntity=null,this._hitTestSources=[],this._id=++Fv,this._manager=e,this._xrInputSource=t,t.hand&&(this._hand=new Rv(this))}get id(){return this._id}get inputSource(){return this._xrInputSource}get targetRayMode(){return this._xrInputSource.targetRayMode}get handedness(){return this._xrInputSource.handedness}get profiles(){return this._xrInputSource.profiles}get grip(){return this._grip}get hand(){return this._hand}get gamepad(){return this._xrInputSource.gamepad||null}get selecting(){return this._selecting}get squeezing(){return this._squeezing}set elementInput(e){this._elementInput!==e&&(this._elementInput=e,this._elementInput||(this._elementEntity=null))}get elementInput(){return this._elementInput}get elementEntity(){return this._elementEntity}get hitTestSources(){return this._hitTestSources}update(e){if(this._hand)this._hand.update(e);else{const t=this._xrInputSource.gripSpace;if(t){const s=e.getPose(t,this._manager._referenceSpace);if(s){this._grip||(this._grip=!0,this._localTransform=new As,this._worldTransform=new As,this._localPositionLast=new ys,this._localPosition=new ys,this._localRotation=new Ds,this._linearVelocity=new ys);const e=ts(),t=(e-this._velocitiesTimestamp)/1e3;this._velocitiesTimestamp=e,this._dirtyLocal=!0,this._localPositionLast.copy(this._localPosition),this._localPosition.copy(s.transform.position),this._localRotation.copy(s.transform.orientation),this._velocitiesAvailable=!0,this._manager.input.velocitiesSupported&&s.linearVelocity?this._linearVelocity.copy(s.linearVelocity):t>0&&(Lv.sub2(this._localPosition,this._localPositionLast).divScalar(t),this._linearVelocity.lerp(this._linearVelocity,Lv,.15))}else this._velocitiesAvailable=!1}const s=e.getPose(this._xrInputSource.targetRaySpace,this._manager._referenceSpace);s&&(this._dirtyRay=!0,this._rayLocal.origin.copy(s.transform.position),this._rayLocal.direction.set(0,0,-1),Iv.copy(s.transform.orientation),Iv.transformVector(this._rayLocal.direction,this._rayLocal.direction))}}_updateTransforms(){this._dirtyLocal&&(this._dirtyLocal=!1,this._localTransform.setTRS(this._localPosition,this._localRotation,ys.ONE));const e=this._manager.camera.parent;e?this._worldTransform.mul2(e.getWorldTransform(),this._localTransform):this._worldTransform.copy(this._localTransform)}_updateRayTransforms(){const e=this._dirtyRay;this._dirtyRay=!1;if(this._manager.camera.parent){const e=this._manager.camera.parent.getWorldTransform();e.getTranslation(this._position),this._rotation.setFromMat4(e),this._rotation.transformVector(this._rayLocal.origin,this._ray.origin),this._ray.origin.add(this._position),this._rotation.transformVector(this._rayLocal.direction,this._ray.direction)}else e&&(this._ray.origin.copy(this._rayLocal.origin),this._ray.direction.copy(this._rayLocal.direction))}getPosition(){return this._position?(this._updateTransforms(),this._worldTransform.getTranslation(this._position),this._position):null}getLocalPosition(){return this._localPosition}getRotation(){return this._rotation?(this._updateTransforms(),this._rotation.setFromMat4(this._worldTransform),this._rotation):null}getLocalRotation(){return this._localRotation}getLinearVelocity(){return this._velocitiesAvailable?this._linearVelocity:null}getOrigin(){return this._updateRayTransforms(),this._ray.origin}getDirection(){return this._updateRayTransforms(),this._ray.direction}hitTestStart(e={}){e.inputSource=this,e.profile=this._xrInputSource.profiles[0];const t=e.callback;e.callback=(e,s)=>{s&&this.onHitTestSourceAdd(s),t&&t(e,s)},this._manager.hitTest.start(e)}onHitTestSourceAdd(e){this._hitTestSources.push(e),this.fire("hittest:add",e),e.on("result",((t,s,i,n)=>{i===this&&this.fire("hittest:result",e,t,s,n)})),e.once("remove",(()=>{this.onHitTestSourceRemove(e),this.fire("hittest:remove",e)}))}onHitTestSourceRemove(e){const t=this._hitTestSources.indexOf(e);-1!==t&&this._hitTestSources.splice(t,1)}}Ov.EVENT_REMOVE="remove",Ov.EVENT_SELECT="select",Ov.EVENT_SELECTSTART="selectstart",Ov.EVENT_SELECTEND="selectend",Ov.EVENT_SQUEEZE="squeeze",Ov.EVENT_SQUEEZESTART="squeezestart",Ov.EVENT_SQUEEZEEND="squeezeend",Ov.EVENT_HITTESTADD="hittest:add",Ov.EVENT_HITTESTREMOVE="hittest:remove",Ov.EVENT_HITTESTRESULT="hittest:result";class Bv extends Kt{constructor(e){var t;super(),this.manager=void 0,this._inputSources=[],this._onInputSourcesChangeEvt=void 0,this.velocitiesSupported=!1,this.manager=e,this.velocitiesSupported=!(!qt.browser||null==(t=window.XRPose)||null==(t=t.prototype)||!t.hasOwnProperty("linearVelocity")),this._onInputSourcesChangeEvt=e=>{this._onInputSourcesChange(e)},this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this)}_onSessionStart(){const e=this.manager.session;e.addEventListener("inputsourceschange",this._onInputSourcesChangeEvt),e.addEventListener("select",(e=>{const t=this._getByInputSource(e.inputSource);t.update(e.frame),t.fire("select",e),this.fire("select",t,e)})),e.addEventListener("selectstart",(e=>{const t=this._getByInputSource(e.inputSource);t.update(e.frame),t._selecting=!0,t.fire("selectstart",e),this.fire("selectstart",t,e)})),e.addEventListener("selectend",(e=>{const t=this._getByInputSource(e.inputSource);t.update(e.frame),t._selecting=!1,t.fire("selectend",e),this.fire("selectend",t,e)})),e.addEventListener("squeeze",(e=>{const t=this._getByInputSource(e.inputSource);t.update(e.frame),t.fire("squeeze",e),this.fire("squeeze",t,e)})),e.addEventListener("squeezestart",(e=>{const t=this._getByInputSource(e.inputSource);t.update(e.frame),t._squeezing=!0,t.fire("squeezestart",e),this.fire("squeezestart",t,e)})),e.addEventListener("squeezeend",(e=>{const t=this._getByInputSource(e.inputSource);t.update(e.frame),t._squeezing=!1,t.fire("squeezeend",e),this.fire("squeezeend",t,e)}));const t=e.inputSources;for(let e=0;e<t.length;e++)this._addInputSource(t[e])}_onSessionEnd(){let e=this._inputSources.length;for(;e--;){const t=this._inputSources[e];this._inputSources.splice(e,1),t.fire("remove"),this.fire("remove",t)}this.manager.session.removeEventListener("inputsourceschange",this._onInputSourcesChangeEvt)}_onInputSourcesChange(e){for(let t=0;t<e.removed.length;t++)this._removeInputSource(e.removed[t]);for(let t=0;t<e.added.length;t++)this._addInputSource(e.added[t])}_getByInputSource(e){for(let t=0;t<this._inputSources.length;t++)if(this._inputSources[t].inputSource===e)return this._inputSources[t];return null}_addInputSource(e){if(this._getByInputSource(e))return;const t=new Ov(this.manager,e);this._inputSources.push(t),this.fire("add",t)}_removeInputSource(e){for(let t=0;t<this._inputSources.length;t++){if(this._inputSources[t].inputSource!==e)continue;const s=this._inputSources[t];this._inputSources.splice(t,1);let i=s.hitTestSources.length;for(;i--;)s.hitTestSources[i].remove();return s.fire("remove"),void this.fire("remove",s)}}update(e){for(let t=0;t<this._inputSources.length;t++)this._inputSources[t].update(e)}get inputSources(){return this._inputSources}}Bv.EVENT_ADD="add",Bv.EVENT_REMOVE="remove",Bv.EVENT_SELECT="select",Bv.EVENT_SELECTSTART="selectstart",Bv.EVENT_SELECTEND="selectend",Bv.EVENT_SQUEEZE="squeeze",Bv.EVENT_SQUEEZESTART="squeezestart",Bv.EVENT_SQUEEZEEND="squeezeend";const zv=new ys,Nv=new ys,Uv=new As,Vv=new As;class Gv extends Kt{constructor(e){super(),this._manager=void 0,this._supported=!1,this._available=!1,this._lightProbeRequested=!1,this._lightProbe=null,this._intensity=0,this._rotation=new Ds,this._color=new os,this._sphericalHarmonics=new Float32Array(27),this._manager=e,this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this)}_onSessionStart(){!!this._manager.session.requestLightProbe&&(this._supported=!0)}_onSessionEnd(){this._supported=!1,this._available=!1,this._lightProbeRequested=!1,this._lightProbe=null}start(){let e;this._manager.session||(e=new Error("XR session is not running")),e||this._manager.type===lv||(e=new Error("XR session type is not AR")),e||this._supported||(e=new Error("light-estimation is not supported")),(!e&&this._lightProbe||this._lightProbeRequested)&&(e=new Error("light estimation is already requested")),e?this.fire("error",e):(this._lightProbeRequested=!0,this._manager.session.requestLightProbe().then((e=>{const t=this._lightProbeRequested;this._lightProbeRequested=!1,this._manager.active?t&&(this._lightProbe=e):this.fire("error",new Error("XR session is not active"))})).catch((e=>{this._lightProbeRequested=!1,this.fire("error",e)})))}end(){this._lightProbeRequested=!1,this._lightProbe=null,this._available=!1}update(e){if(!this._lightProbe)return;const t=e.getLightEstimate(this._lightProbe);if(!t)return;this._available||(this._available=!0,this.fire("available"));const s=t.primaryLightIntensity;this._intensity=Math.max(1,Math.max(s.x,Math.max(s.y,s.z))),zv.copy(s).mulScalar(1/this._intensity),this._color.set(zv.x,zv.y,zv.z),zv.set(0,0,0),Nv.copy(t.primaryLightDirection),Uv.setLookAt(Nv,zv,ys.UP),Vv.setFromAxisAngle(ys.RIGHT,90),Uv.mul(Vv),this._rotation.setFromMat4(Uv),this._sphericalHarmonics.set(t.sphericalHarmonicsCoefficients)}get supported(){return this._supported}get available(){return this._available}get intensity(){return this._available?this._intensity:null}get color(){return this._available?this._color:null}get rotation(){return this._available?this._rotation:null}get sphericalHarmonics(){return this._available?this._sphericalHarmonics:null}}Gv.EVENT_AVAILABLE="available",Gv.EVENT_ERROR="error";let Hv=0;class jv extends Kt{constructor(e,t){super(),this._id=void 0,this._planeDetection=void 0,this._xrPlane=void 0,this._lastChangedTime=void 0,this._orientation=void 0,this._position=new ys,this._rotation=new Ds,this._id=++Hv,this._planeDetection=e,this._xrPlane=t,this._lastChangedTime=t.lastChangedTime,this._orientation=t.orientation}destroy(){this._xrPlane&&(this._xrPlane=null,this.fire("remove"))}update(e){const t=this._planeDetection._manager,s=e.getPose(this._xrPlane.planeSpace,t._referenceSpace);s&&(this._position.copy(s.transform.position),this._rotation.copy(s.transform.orientation)),this._lastChangedTime!==this._xrPlane.lastChangedTime&&(this._lastChangedTime=this._xrPlane.lastChangedTime,this.fire("change"))}getPosition(){return this._position}getRotation(){return this._rotation}get id(){return this._id}get orientation(){return this._orientation}get points(){return this._xrPlane.polygon}get label(){return this._xrPlane.semanticLabel||""}}jv.EVENT_REMOVE="remove",jv.EVENT_CHANGE="change";class Wv extends Kt{constructor(e){super(),this._manager=void 0,this._supported=qt.browser&&!!window.XRPlane,this._available=!1,this._planesIndex=new Map,this._planes=[],this._manager=e,this._supported&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this))}_onSessionStart(){if(this._manager.session.enabledFeatures){-1!==this._manager.session.enabledFeatures.indexOf("plane-detection")&&(this._available=!0,this.fire("available"))}}_onSessionEnd(){for(let e=0;e<this._planes.length;e++)this._planes[e].destroy(),this.fire("remove",this._planes[e]);this._planesIndex.clear(),this._planes.length=0,this._available&&(this._available=!1,this.fire("unavailable"))}update(e){if(!this._available){if(this._manager.session.enabledFeatures||!e.detectedPlanes.size)return;this._available=!0,this.fire("available")}const t=e.detectedPlanes;for(const[e,s]of this._planesIndex)t.has(e)||(this._planesIndex.delete(e),this._planes.splice(this._planes.indexOf(s),1),s.destroy(),this.fire("remove",s));for(const s of t){let t=this._planesIndex.get(s);t?t.update(e):(t=new jv(this,s),this._planesIndex.set(s,t),this._planes.push(t),t.update(e),this.fire("add",t))}}get supported(){return this._supported}get available(){return this._available}get planes(){return this._planes}}Wv.EVENT_AVAILABLE="available",Wv.EVENT_UNAVAILABLE="unavailable",Wv.EVENT_ADD="add",Wv.EVENT_REMOVE="remove";class $v extends Kt{constructor(e,t,s=null){super(),this._position=new ys,this._rotation=new Ds,this._uuid=null,this._uuidRequests=null,this._anchors=e,this._xrAnchor=t,this._uuid=s}destroy(){if(!this._xrAnchor)return;const e=this._xrAnchor;this._xrAnchor.delete(),this._xrAnchor=null,this.fire("destroy",e,this)}update(e){if(!this._xrAnchor)return;const t=e.getPose(this._xrAnchor.anchorSpace,this._anchors.manager._referenceSpace);if(t){if(this._position.equals(t.transform.position)&&this._rotation.equals(t.transform.orientation))return;this._position.copy(t.transform.position),this._rotation.copy(t.transform.orientation),this.fire("change")}}getPosition(){return this._position}getRotation(){return this._rotation}persist(e){this._anchors.persistence?this._uuid?null==e||e(null,this._uuid):this._uuidRequests?e&&this._uuidRequests.push(e):(this._uuidRequests=[],this._xrAnchor.requestPersistentHandle().then((t=>{this._uuid=t,this._anchors._indexByUuid.set(this._uuid,this),null==e||e(null,t);for(const e of this._uuidRequests)e(null,t);this._uuidRequests=null,this.fire("persist",t)})).catch((t=>{null==e||e(t,null);for(const e of this._uuidRequests)e(t,null);this._uuidRequests=null}))):null==e||e(new Error("Persistent Anchors are not supported"),null)}forget(e){this._uuid?this._anchors.forget(this._uuid,(t=>{this._uuid=null,null==e||e(t),this.fire("forget")})):null==e||e(new Error("Anchor is not persistent"))}get uuid(){return this._uuid}get persistent(){return!!this._uuid}}$v.EVENT_DESTROY="destroy",$v.EVENT_CHANGE="change",$v.EVENT_PERSIST="persist",$v.EVENT_FORGET="forget";class qv extends Kt{constructor(e){var t;super(),this.manager=void 0,this._supported=qt.browser&&!!window.XRAnchor,this._available=!1,this._checkingAvailability=!1,this._persistence=qt.browser&&!(null==(t=window)||null==(t=t.XRSession)||!t.prototype.restorePersistentAnchor),this._creationQueue=[],this._index=new Map,this._indexByUuid=new Map,this._list=[],this._callbacksAnchors=new Map,this.manager=e,this._supported&&(this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this))}_onSessionStart(){const e=-1!==this.manager.session.enabledFeatures.indexOf("anchors");e&&(this._available=e,this.fire("available"))}_onSessionEnd(){if(!this._available)return;this._available=!1;for(let e=0;e<this._creationQueue.length;e++)this._creationQueue[e].callback&&this._creationQueue[e].callback(new Error("session ended"),null);this._creationQueue.length=0,this._index.clear(),this._indexByUuid.clear();let e=this._list.length;for(;e--;)this._list[e].destroy();this._list.length=0,this.fire("unavailable")}_createAnchor(e,t=null){const s=new $v(this,e,t);return this._index.set(e,s),t&&this._indexByUuid.set(t,s),this._list.push(s),s.once("destroy",this._onAnchorDestroy,this),s}_onAnchorDestroy(e,t){this._index.delete(e),t.uuid&&this._indexByUuid.delete(t.uuid);const s=this._list.indexOf(t);-1!==s&&this._list.splice(s,1),this.fire("destroy",t)}create(e,t,s){if(this._available)if(window.XRHitTestResult&&e instanceof XRHitTestResult){const i=e;if(s=t,!this._supported)return void(null==s||s(new Error("Anchors API is not supported"),null));if(!i.createAnchor)return void(null==s||s(new Error("Creating Anchor from Hit Test is not supported"),null));i.createAnchor().then((e=>{const t=this._createAnchor(e);null==s||s(null,t),this.fire("add",t)})).catch((e=>{null==s||s(e,null),this.fire("error",e)}))}else this._creationQueue.push({transform:new XRRigidTransform(e,t),callback:s});else null==s||s(new Error("Anchors API is not available"),null)}restore(e,t){this._available?this._persistence?this.manager.active?this.manager.session.restorePersistentAnchor(e).then((s=>{const i=this._createAnchor(s,e);null==t||t(null,i),this.fire("add",i)})).catch((e=>{null==t||t(e,null),this.fire("error",e)})):null==t||t(new Error("WebXR session is not active"),null):null==t||t(new Error("Anchor Persistence is not supported"),null):null==t||t(new Error("Anchors API is not available"),null)}forget(e,t){this._available?this._persistence?this.manager.active?this.manager.session.deletePersistentAnchor(e).then((()=>{null==t||t(null)})).catch((e=>{null==t||t(e),this.fire("error",e)})):null==t||t(new Error("WebXR session is not active")):null==t||t(new Error("Anchor Persistence is not supported")):null==t||t(new Error("Anchors API is not available"))}update(e){if(this._available){if(this._creationQueue.length){for(let t=0;t<this._creationQueue.length;t++){const s=this._creationQueue[t];e.createAnchor(s.transform,this.manager._referenceSpace).then((e=>{s.callback&&this._callbacksAnchors.set(e,s.callback)})).catch((e=>{s.callback&&s.callback(e,null),this.fire("error",e)}))}this._creationQueue.length=0}for(const[t,s]of this._index)e.trackedAnchors.has(t)||(this._index.delete(t),s.destroy());for(let t=0;t<this._list.length;t++)this._list[t].update(e);for(const t of e.trackedAnchors){if(this._index.has(t))continue;const s=this._createAnchor(t);s.update(e);const i=this._callbacksAnchors.get(t);i&&(this._callbacksAnchors.delete(t),i(null,s)),this.fire("add",s)}}else this.manager.session.enabledFeatures||this._checkingAvailability||(this._checkingAvailability=!0,e.createAnchor(new XRRigidTransform,this.manager._referenceSpace).then((e=>{e.delete(),this.manager.active&&(this._available=!0,this.fire("available"))})).catch((()=>{})))}get supported(){return this._supported}get available(){return this._available}get persistence(){return this._persistence}get uuids(){return this._available&&this._persistence&&this.manager.active?this.manager.session.persistentAnchors:null}get list(){return this._list}}qv.EVENT_AVAILABLE="available",qv.EVENT_UNAVAILABLE="unavailable",qv.EVENT_ERROR="error",qv.EVENT_ADD="add",qv.EVENT_DESTROY="destroy";class Xv extends Kt{constructor(e,t){super(),this._meshDetection=void 0,this._xrMesh=void 0,this._lastChanged=0,this._position=new ys,this._rotation=new Ds,this._meshDetection=e,this._xrMesh=t,this._lastChanged=this._xrMesh.lastChangedTime}get xrMesh(){return this._xrMesh}get label(){return this._xrMesh.semanticLabel||""}get vertices(){return this._xrMesh.vertices}get indices(){return this._xrMesh.indices}destroy(){this._xrMesh&&(this._xrMesh=null,this.fire("remove"))}update(e){const t=this._meshDetection._manager,s=e.getPose(this._xrMesh.meshSpace,t._referenceSpace);s&&(this._position.copy(s.transform.position),this._rotation.copy(s.transform.orientation)),this._lastChanged!==this._xrMesh.lastChangedTime&&(this._lastChanged=this._xrMesh.lastChangedTime,this.fire("change"))}getPosition(){return this._position}getRotation(){return this._rotation}}Xv.EVENT_REMOVE="remove",Xv.EVENT_CHANGE="change";class Kv extends Kt{constructor(e){super(),this._manager=void 0,this._supported=qt.browser&&!!window.XRMesh,this._available=!1,this._index=new Map,this._list=[],this._manager=e,this._supported&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this))}update(e){if(!this._available){if(this._manager.session.enabledFeatures||!e.detectedMeshes.size)return;this._available=!0,this.fire("available")}for(const t of e.detectedMeshes){let s=this._index.get(t);s?s.update(e):(s=new Xv(this,t),this._index.set(t,s),this._list.push(s),s.update(e),this.fire("add",s))}for(const t of this._index.values())e.detectedMeshes.has(t.xrMesh)||this._removeMesh(t)}_removeMesh(e){this._index.delete(e.xrMesh),this._list.splice(this._list.indexOf(e),1),e.destroy(),this.fire("remove",e)}_onSessionStart(){if(this._manager.session.enabledFeatures){const e=-1!==this._manager.session.enabledFeatures.indexOf("mesh-detection");if(!e)return;this._available=e,this.fire("available")}}_onSessionEnd(){if(this._available){this._available=!1;for(const e of this._index.values())this._removeMesh(e);this.fire("unavailable")}}get supported(){return this._supported}get available(){return this._available}get meshes(){return this._list}}Kv.EVENT_AVAILABLE="available",Kv.EVENT_UNAVAILABLE="unavailable",Kv.EVENT_ADD="add",Kv.EVENT_REMOVE="remove";class Yv extends Kt{constructor(e,t,s){super(),this._manager=void 0,this._xrView=void 0,this._positionData=new Float32Array(3),this._viewport=new Ss,this._projMat=new As,this._projViewOffMat=new As,this._viewMat=new As,this._viewOffMat=new As,this._viewMat3=new xs,this._viewInvMat=new As,this._viewInvOffMat=new As,this._xrCamera=null,this._textureColor=null,this._textureDepth=null,this._depthInfo=null,this._emptyDepthBuffer=new Uint8Array(32),this._depthMatrix=new As,this._manager=e,this._xrView=t;const i=this._manager.app.graphicsDevice;if(this._manager.views.supportedColor&&(this._xrCamera=this._xrView.camera,this._manager.views.availableColor&&this._xrCamera&&(this._textureColor=new yn(i,{format:6,mipmaps:!1,addressU:1,addressV:1,minFilter:1,magFilter:1,width:this._xrCamera.width,height:this._xrCamera.height,name:`XrView-${this._xrView.eye}-Color`}))),this._manager.views.supportedDepth&&this._manager.views.availableDepth){const e=this._manager.views.depthGpuOptimized?0:1;this._textureDepth=new yn(i,{format:this._manager.views.depthPixelFormat,arrayLength:1===s?0:s,mipmaps:!1,addressU:1,addressV:1,minFilter:e,magFilter:e,width:4,height:4,name:`XrView-${this._xrView.eye}-Depth`});for(let e=0;e<this._textureDepth._levels.length;e++)this._textureDepth._levels[e]=this._emptyDepthBuffer;this._textureDepth.upload()}(this._textureColor||this._textureDepth)&&i.on("devicelost",this._onDeviceLost,this)}get textureColor(){return this._textureColor}get textureDepth(){return this._textureDepth}get depthUvMatrix(){return this._depthMatrix}get depthValueToMeters(){var e;return(null==(e=this._depthInfo)?void 0:e.rawValueToMeters)||0}get eye(){return this._xrView.eye}get viewport(){return this._viewport}get projMat(){return this._projMat}get projViewOffMat(){return this._projViewOffMat}get viewOffMat(){return this._viewOffMat}get viewInvOffMat(){return this._viewInvOffMat}get viewMat3(){return this._viewMat3}get positionData(){return this._positionData}update(e,t){this._xrView=t,this._manager.views.availableColor&&(this._xrCamera=this._xrView.camera);const s=e.session.renderState.baseLayer.getViewport(this._xrView);this._viewport.x=s.x,this._viewport.y=s.y,this._viewport.z=s.width,this._viewport.w=s.height,this._projMat.set(this._xrView.projectionMatrix),this._viewMat.set(this._xrView.transform.inverse.matrix),this._viewInvMat.set(this._xrView.transform.matrix),this._updateTextureColor(),this._updateDepth(e)}_updateTextureColor(){if(!this._manager.views.availableColor||!this._xrCamera||!this._textureColor)return;const e=this._manager.webglBinding;if(!e)return;const t=e.getCameraImage(this._xrCamera);if(!t)return;const s=this._manager.app.graphicsDevice,i=s.gl;if(this._frameBufferSource){const e=i.COLOR_ATTACHMENT0,n=this._xrCamera.width,r=this._xrCamera.height;s.setFramebuffer(this._frameBufferSource),i.framebufferTexture2D(i.FRAMEBUFFER,e,i.TEXTURE_2D,t,0),s.setFramebuffer(this._frameBuffer),i.framebufferTexture2D(i.FRAMEBUFFER,e,i.TEXTURE_2D,this._textureColor.impl._glTexture,0),i.bindFramebuffer(i.READ_FRAMEBUFFER,this._frameBufferSource),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,this._frameBuffer),i.blitFramebuffer(0,r,n,0,0,0,n,r,i.COLOR_BUFFER_BIT,i.NEAREST)}else this._frameBufferSource=i.createFramebuffer(),this._frameBuffer=i.createFramebuffer()}_updateDepth(e){var t,s;if(!this._manager.views.availableDepth||!this._textureDepth)return;const i=this._manager.views.depthGpuOptimized,n=i?this._manager.webglBinding:e;if(!n)return void(this._depthInfo=null);const r=n.getDepthInformation(this._xrView);if(!r)return void(this._depthInfo=null);let a=!this._depthInfo!=!r;this._depthInfo=r;const o=(null==(t=this._depthInfo)?void 0:t.width)||4,l=(null==(s=this._depthInfo)?void 0:s.height)||4;let h=!1;if(this._textureDepth.width===o&&this._textureDepth.height===l||(this._textureDepth._width=o,this._textureDepth._height=l,a=!0,h=!0),a&&(this._depthInfo?this._depthMatrix.data.set(this._depthInfo.normDepthBufferFromNormView.matrix):this._depthMatrix.setIdentity()),this._depthInfo)if(i){if(this._depthInfo.texture){const e=this._manager.app.graphicsDevice.gl;switch(this._textureDepth.impl._glTexture=this._depthInfo.texture,"texture-array"===this._depthInfo.textureType?this._textureDepth.impl._glTarget=e.TEXTURE_2D_ARRAY:this._textureDepth.impl._glTarget=e.TEXTURE_2D,this._manager.views.depthPixelFormat){case qs:this._textureDepth.impl._glInternalFormat=e.R32F,this._textureDepth.impl._glPixelType=e.FLOAT,this._textureDepth.impl._glFormat=e.RED;break;case Xs:this._textureDepth.impl._glInternalFormat=e.DEPTH_COMPONENT16,this._textureDepth.impl._glPixelType=e.UNSIGNED_SHORT,this._textureDepth.impl._glFormat=e.DEPTH_COMPONENT}this._textureDepth.impl._glCreated=!0}}else this._textureDepth._levels[0]=new Uint8Array(this._depthInfo.data),this._textureDepth.upload();else this._textureDepth._levels[0]=this._emptyDepthBuffer,this._textureDepth.upload();h&&this.fire("depth:resize",o,l)}updateTransforms(e){e?(this._viewInvOffMat.mul2(e,this._viewInvMat),this.viewOffMat.copy(this._viewInvOffMat).invert()):(this._viewInvOffMat.copy(this._viewInvMat),this.viewOffMat.copy(this._viewMat)),this._viewMat3.setFromMat4(this._viewOffMat),this._projViewOffMat.mul2(this._projMat,this._viewOffMat),this._positionData[0]=this._viewInvOffMat.data[12],this._positionData[1]=this._viewInvOffMat.data[13],this._positionData[2]=this._viewInvOffMat.data[14]}_onDeviceLost(){this._frameBufferSource=null,this._frameBuffer=null,this._depthInfo=null}getDepth(e,t){var s,i;return this._manager.views.depthGpuOptimized?null:null!=(s=null==(i=this._depthInfo)?void 0:i.getDepthInMeters(e,t))?s:null}destroy(){if(this._depthInfo=null,this._textureColor&&(this._textureColor.destroy(),this._textureColor=null),this._textureDepth&&(this._textureDepth.destroy(),this._textureDepth=null),this._frameBufferSource){const e=this._manager.app.graphicsDevice.gl;e.deleteFramebuffer(this._frameBufferSource),this._frameBufferSource=null,e.deleteFramebuffer(this._frameBuffer),this._frameBuffer=null}}}Yv.EVENT_DEPTHRESIZE="depth:resize";class Qv extends Kt{constructor(e){super(),this._manager=void 0,this._index=new Map,this._indexTmp=new Map,this._list=[],this._supportedColor=qt.browser&&!!window.XRCamera&&!!window.XRWebGLBinding,this._supportedDepth=qt.browser&&!!window.XRDepthInformation,this._availableColor=!1,this._availableDepth=!1,this._depthUsage="",this._depthFormat="",this._depthFormats={[fv]:2,[mv]:Xs,[gv]:qs},this._manager=e,this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this)}get list(){return this._list}get supportedColor(){return this._supportedColor}get supportedDepth(){return this._supportedDepth}get availableColor(){return this._availableColor}get availableDepth(){return this._availableDepth}get depthUsage(){return this._depthUsage}get depthGpuOptimized(){return this._depthUsage===pv}get depthFormat(){return this._depthFormat}get depthPixelFormat(){var e;return null!=(e=this._depthFormats[this._depthFormat])?e:null}update(e,t){for(let e=0;e<t.length;e++)this._indexTmp.set(t[e].eye,t[e]);for(const[s,i]of this._indexTmp){let n=this._index.get(s);n?n.update(e,i):(n=new Yv(this._manager,i,t.length),this._index.set(s,n),this._list.push(n),n.update(e,i),this.fire("add",n))}for(const[e,t]of this._index){if(this._indexTmp.has(e))continue;t.destroy(),this._index.delete(e);const s=this._list.indexOf(t);-1!==s&&this._list.splice(s,1),this.fire("remove",t)}this._indexTmp.clear()}get(e){return this._index.get(e)||null}_onSessionStart(){if(this._manager.type===lv&&this._manager.session.enabledFeatures&&(this._availableColor=-1!==this._manager.session.enabledFeatures.indexOf("camera-access"),this._availableDepth=-1!==this._manager.session.enabledFeatures.indexOf("depth-sensing"),this._availableDepth)){const e=this._manager.session;this._depthUsage=e.depthUsage,this._depthFormat=e.depthDataFormat}}_onSessionEnd(){for(const e of this._index.values())e.destroy();this._index.clear(),this._availableColor=!1,this._availableDepth=!1,this._depthUsage="",this._depthFormat="",this._list.length=0}}Qv.EVENT_ADD="add",Qv.EVENT_REMOVE="remove";class Jv extends Kt{constructor(e){super(),this.app=void 0,this._supported=qt.browser&&!!navigator.xr,this._available={},this._type=null,this._spaceType=null,this._session=null,this._baseLayer=null,this.webglBinding=null,this._referenceSpace=null,this.domOverlay=void 0,this.hitTest=void 0,this.imageTracking=void 0,this.planeDetection=void 0,this.meshDetection=void 0,this.input=void 0,this.lightEstimation=void 0,this.views=void 0,this.anchors=void 0,this._camera=null,this._localPosition=new ys,this._localRotation=new Ds,this._depthNear=.1,this._depthFar=1e3,this._supportedFrameRates=null,this._width=0,this._height=0,this._framebufferScaleFactor=1,this.app=e,this._available.inline=!1,this._available["immersive-vr"]=!1,this._available[lv]=!1,this.views=new Qv(this),this.domOverlay=new _v(this),this.hitTest=new xv(this),this.imageTracking=new Sv(this),this.planeDetection=new Wv(this),this.meshDetection=new Kv(this),this.input=new Bv(this),this.lightEstimation=new Gv(this),this.anchors=new qv(this),this.views=new Qv(this),this._supported&&(navigator.xr.addEventListener("devicechange",(()=>{this._deviceAvailabilityCheck()})),this._deviceAvailabilityCheck(),this.app.graphicsDevice.on("devicelost",this._onDeviceLost,this),this.app.graphicsDevice.on("devicerestored",this._onDeviceRestored,this))}destroy(){}start(e,t,s,i){var n,r;let a=i;if("object"==typeof i&&(a=i.callback),!this._available[t])return void(a&&a(new Error("XR is not available")));if(this._session)return void(a&&a(new Error("XR session is already started")));this._camera=e,this._camera.camera.xr=this,this._type=t,this._spaceType=s,this._framebufferScaleFactor=null!=(n=null==i?void 0:i.framebufferScaleFactor)?n:1,this._setClipPlanes(e.nearClip,e.farClip);const o={requiredFeatures:[s],optionalFeatures:[]},l=null==(r=this.app.graphicsDevice)?void 0:r.isWebGL2;if(t===lv){if(o.optionalFeatures.push("light-estimation"),o.optionalFeatures.push("hit-test"),i&&(i.imageTracking&&this.imageTracking.supported&&o.optionalFeatures.push("image-tracking"),i.planeDetection&&o.optionalFeatures.push("plane-detection"),i.meshDetection&&o.optionalFeatures.push("mesh-detection")),this.domOverlay.supported&&this.domOverlay.root&&(o.optionalFeatures.push("dom-overlay"),o.domOverlay={root:this.domOverlay.root}),i&&i.anchors&&this.anchors.supported&&o.optionalFeatures.push("anchors"),i&&i.depthSensing&&this.views.supportedDepth){o.optionalFeatures.push("depth-sensing");const e=[],t=[];if(e.push(pv,"cpu-optimized"),t.push(gv,fv,mv),i.depthSensing.usagePreference){const t=e.indexOf(i.depthSensing.usagePreference);-1!==t&&e.splice(t,1),e.unshift(i.depthSensing.usagePreference)}if(i.depthSensing.dataFormatPreference){const e=t.indexOf(i.depthSensing.dataFormatPreference);-1!==e&&t.splice(e,1),t.unshift(i.depthSensing.dataFormatPreference)}o.depthSensing={usagePreference:e,dataFormatPreference:t}}l&&i&&i.cameraColor&&this.views.supportedColor&&o.optionalFeatures.push("camera-access")}o.optionalFeatures.push("hand-tracking"),i&&i.optionalFeatures&&(o.optionalFeatures=o.optionalFeatures.concat(i.optionalFeatures)),this.imageTracking.supported&&this.imageTracking.images.length?this.imageTracking.prepareImages(((e,i)=>{if(e)return a&&a(e),void this.fire("error",e);null!==i&&(o.trackedImages=i),this._onStartOptionsReady(t,s,o,a)})):this._onStartOptionsReady(t,s,o,a)}_onStartOptionsReady(e,t,s,i){navigator.xr.requestSession(e,s).then((e=>{this._onSessionStart(e,t,i)})).catch((e=>{this._camera.camera.xr=null,this._camera=null,this._type=null,this._spaceType=null,i&&i(e),this.fire("error",e)}))}end(e){this._session?(this.webglBinding=null,e&&this.once("end",e),this._session.end()):e&&e(new Error("XR Session is not initialized"))}isAvailable(e){return this._available[e]}_deviceAvailabilityCheck(){for(const e in this._available)this._sessionSupportCheck(e)}initiateRoomCapture(e){this._session?this._session.initiateRoomCapture?this._session.initiateRoomCapture().then((()=>{e&&e(null)})).catch((t=>{e&&e(t)})):e(new Error("Session does not support manual room capture")):e(new Error("Session is not active"))}updateTargetFrameRate(e,t){var s;null!=(s=this._session)&&s.updateTargetFrameRate?this._session.updateTargetFrameRate(e).then((()=>{null==t||t()})).catch((e=>{null==t||t(e)})):null==t||t(new Error("unable to update frameRate"))}_sessionSupportCheck(e){navigator.xr.isSessionSupported(e).then((t=>{this._available[e]!==t&&(this._available[e]=t,this.fire("available",e,t),this.fire(`available:${e}`,t))})).catch((e=>{this.fire("error",e)}))}_onSessionStart(e,t,s){let i=!1;this._session=e;const n=()=>{this.fire("visibility:change",e.visibilityState)},r=()=>{this._setClipPlanes(this._camera.nearClip,this._camera.farClip)},a=()=>{this._camera&&(this._camera.off("set_nearClip",r),this._camera.off("set_farClip",r),this._camera.camera.xr=null,this._camera=null),e.removeEventListener("end",a),e.removeEventListener("visibilitychange",n),i||this.fire("end"),this._session=null,this._referenceSpace=null,this._width=0,this._height=0,this._type=null,this._spaceType=null,this.app.systems&&this.app.tick()};e.addEventListener("end",a),e.addEventListener("visibilitychange",n),this._camera.on("set_nearClip",r),this._camera.on("set_farClip",r),this._createBaseLayer(),this.session.supportedFrameRates?this._supportedFrameRates=Array.from(this.session.supportedFrameRates):this._supportedFrameRates=null,this._session.addEventListener("frameratechange",(()=>{var e;this.fire("frameratechange",null==(e=this._session)?void 0:e.frameRate)})),e.requestReferenceSpace(t).then((e=>{this._referenceSpace=e,this.app.tick(),s&&s(null),this.fire("start")})).catch((t=>{i=!0,e.end(),s&&s(t),this.fire("error",t)}))}_setClipPlanes(e,t){this._depthNear===e&&this._depthFar===t||(this._depthNear=e,this._depthFar=t,this._session&&this._session.updateRenderState({depthNear:this._depthNear,depthFar:this._depthFar}))}_createBaseLayer(){const e=this.app.graphicsDevice,t=e.maxPixelRatio/window.devicePixelRatio*this._framebufferScaleFactor;if(this._baseLayer=new XRWebGLLayer(this._session,e.gl,{alpha:!0,depth:!0,stencil:!0,framebufferScaleFactor:t,antialias:!1}),null!=e&&e.isWebGL2&&window.XRWebGLBinding)try{this.webglBinding=new XRWebGLBinding(this._session,e.gl)}catch(e){this.fire("error",e)}this._session.updateRenderState({baseLayer:this._baseLayer,depthNear:this._depthNear,depthFar:this._depthFar})}_onDeviceLost(){this._session&&(this.webglBinding&&(this.webglBinding=null),this._baseLayer=null,this._session.updateRenderState({baseLayer:this._baseLayer,depthNear:this._depthNear,depthFar:this._depthFar}))}_onDeviceRestored(){this._session&&setTimeout((()=>{this.app.graphicsDevice.gl.makeXRCompatible().then((()=>{this._createBaseLayer()})).catch((e=>{this.fire("error",e)}))}),0)}update(e){if(!this._session)return!1;const t=e.session.renderState.baseLayer.framebufferWidth,s=e.session.renderState.baseLayer.framebufferHeight;this._width===t&&this._height===s||(this._width=t,this._height=s,this.app.graphicsDevice.setResolution(t,s));const i=e.getViewerPose(this._referenceSpace);if(!i)return!1;const n=this.views.list.length;this.views.update(e,i.views);const r=i.transform.position,a=i.transform.orientation;if(this._localPosition.set(r.x,r.y,r.z),this._localRotation.set(a.x,a.y,a.z,a.w),0===n&&this.views.list.length>0){const e=new As,t=this.views.list[0];e.copy(t.projMat);const s=e.data,i=2*Math.atan(1/s[5])*180/Math.PI,n=s[5]/s[0],r=s[14]/(s[10]+1),a=s[14]/(s[10]-1),o=!1;this._camera.camera.setXrProperties({aspectRatio:n,farClip:r,fov:i,horizontalFov:o,nearClip:a})}return this._camera.camera._node.setLocalPosition(this._localPosition),this._camera.camera._node.setLocalRotation(this._localRotation),this.input.update(e),this._type===lv&&(this.hitTest.supported&&this.hitTest.update(e),this.lightEstimation.supported&&this.lightEstimation.update(e),this.imageTracking.supported&&this.imageTracking.update(e),this.anchors.supported&&this.anchors.update(e),this.planeDetection.supported&&this.planeDetection.update(e),this.meshDetection.supported&&this.meshDetection.update(e)),this.fire("update",e),!0}get supported(){return this._supported}get active(){return!!this._session}get type(){return this._type}get spaceType(){return this._spaceType}get session(){return this._session}get frameRate(){var e,t;return null!=(e=null==(t=this._session)?void 0:t.frameRate)?e:null}get supportedFrameRates(){return this._supportedFrameRates}get framebufferScaleFactor(){return this._framebufferScaleFactor}set fixedFoveation(e){var t,s;null!==(null!=(t=null==(s=this._baseLayer)?void 0:s.fixedFoveation)?t:null)&&(this._baseLayer.fixedFoveation=e)}get fixedFoveation(){var e,t;return null!=(e=null==(t=this._baseLayer)?void 0:t.fixedFoveation)?e:null}get camera(){return this._camera?this._camera.entity:null}get visibilityState(){return this._session?this._session.visibilityState:null}}Jv.EVENT_AVAILABLE="available",Jv.EVENT_START="start",Jv.EVENT_END="end",Jv.EVENT_UPDATE="update",Jv.EVENT_ERROR="error";class Zv{constructor(e){this._frameIndex=0,this._frameTimings=[],this._timings=[],this._prevTimings=[],this.unitsName="ms",this.decimalPlaces=1,this.enabled=!0,e.on("frameupdate",this.begin.bind(this,"update")),e.on("framerender",this.mark.bind(this,"render")),e.on("frameend",this.mark.bind(this,"other"))}begin(e){if(!this.enabled)return;this._frameIndex<this._frameTimings.length&&this._frameTimings.splice(this._frameIndex);const t=this._prevTimings;this._prevTimings=this._timings,this._timings=this._frameTimings,this._frameTimings=t,this._frameIndex=0,this.mark(e)}mark(e){if(!this.enabled)return;const t=ts();if(this._frameIndex>0){const e=this._frameTimings[this._frameIndex-1];e[1]=t-e[1]}else if(this._timings.length>0){const e=this._timings[this._timings.length-1];e[1]=t-e[1]}if(this._frameIndex>=this._frameTimings.length)this._frameTimings.push([e,t]);else{const s=this._frameTimings[this._frameIndex];s[0]=e,s[1]=t}this._frameIndex++}get timings(){return this._timings.slice(0,-1).map((e=>e[1]))}}class eb{constructor(e){this.device=e,e.gpuProfiler.enabled=!0,this.enabled=!0,this.unitsName="ms",this.decimalPlaces=1,this._timings=[]}get timings(){return this._timings[0]=this.device.gpuProfiler._frameTime,this._timings}}class tb{constructor(e,t,s,i,n){this.app=e,this.values=[],this.statNames=t,this.statNames.length>3&&(this.statNames.length=3),this.unitsName=i,this.decimalPlaces=s,this.multiplier=n||1;const r=(e,t)=>e.split(".").reduce(((e,t)=>e?e[t]:null),t||this);e.on("frameupdate",(e=>{for(let e=0;e<this.statNames.length;e++)this.values[e]=r(this.statNames[e],this.app.stats)*this.multiplier}))}get timings(){return this.values}}class sb{constructor(e,t,s,i,n){this.app=t,this.name=e,this.device=t.graphicsDevice,this.timer=n,this.watermark=s,this.enabled=!1,this.textRefreshRate=i,this.avgTotal=0,this.avgTimer=0,this.avgCount=0,this.timingText="",this.texture=null,this.yOffset=0,this.cursor=0,this.sample=new Uint8ClampedArray(4),this.sample.set([0,0,0,255]),this.counter=0,this.app.on("frameupdate",this.update,this)}destroy(){this.app.off("frameupdate",this.update,this)}loseContext(){this.timer&&"function"==typeof this.timer.loseContext&&this.timer.loseContext()}update(e){const t=this.timer.timings,s=t.reduce(((e,t)=>e+t),0);if(this.avgTotal+=s,this.avgTimer+=e,this.avgCount++,this.avgTimer>this.textRefreshRate&&(this.timingText=(this.avgTotal/this.avgCount).toFixed(this.timer.decimalPlaces),this.avgTimer=0,this.avgTotal=0,this.avgCount=0),this.enabled){let e=0;const s=1.5*this.watermark;for(let i=0;i<t.length;++i)e+=Math.floor(t[i]/s*255),this.sample[i]=e;this.sample[3]=this.watermark/s*255;this.texture.lock().set(this.sample,4*(this.cursor+this.yOffset*this.texture.width)),this.texture.unlock(),this.cursor++,this.cursor===this.texture.width&&(this.cursor=0)}}render(e,t,s,i,n){e.quad(t+i,s,-i,n,this.enabled?this.cursor:0,this.enabled?.5+this.yOffset:this.texture.height-1,-i,0,this.texture,0)}}class ib{constructor(e,t){const s=e=>{e.font='10px "Lucida Console", Monaco, monospace',e.textAlign="left",e.textBaseline="alphabetic"},i=document.createElement("canvas"),n=i.getContext("2d",{alpha:!0});s(n);const r=new Map;let a=5,o=5;t.forEach((e=>{const t=n.measureText(e),s=Math.ceil(-t.actualBoundingBoxLeft),i=Math.ceil(t.actualBoundingBoxRight),l=Math.ceil(t.actualBoundingBoxAscent),h=Math.ceil(t.actualBoundingBoxDescent),c=s+i,d=l+h;a+c+5>=512&&(a=5,o+=16),r.set(e,{l:s,r:i,a:l,d:h,w:c,h:d,x:a,y:o}),a+=c+5})),i.width=512,i.height=rs.nextPowerOfTwo(o+16+5),s(n),n.fillStyle="rgb(0, 0, 0)",n.fillRect(0,0,i.width,i.height),r.forEach(((e,t)=>{n.fillStyle=(e=>"."===e||1===e.length&&e.charCodeAt(0)>=48&&e.charCodeAt(0)<=57)(t)?"rgb(255, 255, 255)":"rgb(170, 170, 170)",n.fillText(t,e.x-e.l,e.y+e.a)})),this.placements=r;const l=n.getImageData(0,0,i.width,i.height).data;for(let e=0;e<l.length;e+=4)l[e+3]=l[e+0],l[e+0]=255,l[e+1]=255,l[e+2]=255;this.texture=new yn(e,{name:"mini-stats-word-atlas",width:i.width,height:i.height,mipmaps:!1,minFilter:0,magFilter:0,levels:[l]})}destroy(){this.texture.destroy(),this.texture=null}render(e,t,s,i){const n=this.placements.get(t);if(n){const t=1;return e.quad(s+n.l-t,i-n.d+t,n.w+2*t,n.h+2*t,n.x-t,this.texture.height-n.y-n.h-t,void 0,void 0,this.texture,1),n.w}return 0}}class nb{constructor(e,t=512){const s=new Kn(e,[{semantic:li,components:3,type:6},{semantic:mi,components:4,type:6}]),i=new Uint16Array(6*t);for(let e=0;e<t;++e)i[6*e+0]=4*e,i[6*e+1]=4*e+1,i[6*e+2]=4*e+2,i[6*e+3]=4*e,i[6*e+4]=4*e+2,i[6*e+5]=4*e+3;this.device=e,this.buffer=new Hn(e,s,4*t,{usage:2}),this.data=new Float32Array(this.buffer.numBytes/4),this.indexBuffer=new lo(e,1,6*t,0,i),this.prim={type:4,indexed:!0,base:0,count:0},this.quads=0,this.mesh=new Dl(e),this.mesh.vertexBuffer=this.buffer,this.mesh.indexBuffer[0]=this.indexBuffer,this.mesh.primitive=[this.prim];const n=new Rd({uniqueName:"MiniStats",vertexCode:"\nattribute vec3 vertex_position;\nattribute vec4 vertex_texCoord0;\nvarying vec4 uv0;\nvarying float wordFlag;\nvoid main(void) {\n\tgl_Position = vec4(vertex_position.xy * 2.0 - 1.0, 0.5, 1.0);\n\tuv0 = vertex_texCoord0;\n\twordFlag = vertex_position.z;\n}",fragmentCode:"\nvarying vec4 uv0;\nvarying float wordFlag;\nuniform vec4 clr;\nuniform sampler2D graphTex;\nuniform sampler2D wordsTex;\nvoid main (void) {\n\tvec4 graphSample = texture2D(graphTex, uv0.xy);\n\tvec4 graph;\n\tif (uv0.w < graphSample.r)\n\t\tgraph = vec4(0.7, 0.2, 0.2, 1.0);\n\telse if (uv0.w < graphSample.g)\n\t\tgraph = vec4(0.2, 0.7, 0.2, 1.0);\n\telse if (uv0.w < graphSample.b)\n\t\tgraph = vec4(0.2, 0.2, 0.7, 1.0);\n\telse\n\t\tgraph = vec4(0.0, 0.0, 0.0, 1.0 - 0.25 * sin(uv0.w * 3.14159));\n\tvec4 words = texture2D(wordsTex, vec2(uv0.x, 1.0 - uv0.y));\n\tgl_FragColor = mix(graph, words, wordFlag) * clr;\n}"});this.material=n,n.cull=0,n.depthState=On.NODEPTH,n.blendState=new Rn(!0,0,6,8,0,1,1),n.update(),this.meshInstance=new Hl(this.mesh,n,new vh("MiniStatsMesh")),this.uniforms={clr:new Float32Array(4)},this.targetSize={width:e.width,height:e.height}}quad(e,t,s,i,n,r,a,o,l,h=0){const c=this.targetSize.width,d=this.targetSize.height,u=e/c,p=t/d,f=(e+s)/c,m=(t+i)/d,g=l.width,_=l.height,v=n/g,b=r/_,y=(n+(null!=a?a:s))/g,x=(r+(null!=o?o:i))/_;this.data.set([u,p,h,v,b,0,0,f,p,h,y,b,1,0,f,m,h,y,x,1,1,u,m,h,v,x,0,1],28*this.quads),this.quads++,this.prim.count+=6}startFrame(){this.quads=0,this.prim.count=0,this.targetSize.width=this.device.canvas.scrollWidth,this.targetSize.height=this.device.canvas.scrollHeight}render(e,t,s,i,n,r){this.buffer.setData(this.data.buffer),this.uniforms.clr.set(n,0),this.material.setParameter("clr",this.uniforms.clr),this.material.setParameter("graphTex",s),this.material.setParameter("wordsTex",i),e.drawMeshInstance(this.meshInstance,t)}}class rb{constructor(e,t){const s=e.graphicsDevice;t=t||rb.getDefaultOptions(),this.initGraphs(e,s,t);const i=new Set(["","ms","0","1","2","3","4","5","6","7","8","9","."].concat(this.graphs.map((e=>e.name))).concat(t.stats?t.stats.map((e=>e.unitsName)):[]).filter((e=>!!e)));this.wordAtlas=new ib(s,i),this.sizes=t.sizes,this._activeSizeIndex=t.startSizeIndex;const n=document.createElement("div");n.setAttribute("id","mini-stats"),n.style.cssText="position:fixed;bottom:0;left:0;background:transparent;",document.body.appendChild(n),n.addEventListener("mouseenter",(e=>{this.opacity=1})),n.addEventListener("mouseleave",(e=>{this.opacity=.7})),n.addEventListener("click",(e=>{e.preventDefault(),this._enabled&&(this.activeSizeIndex=(this.activeSizeIndex+1)%this.sizes.length,this.resize(this.sizes[this.activeSizeIndex].width,this.sizes[this.activeSizeIndex].height,this.sizes[this.activeSizeIndex].graphs))})),s.on("resizecanvas",this.updateDiv,this),s.on("losecontext",this.loseContext,this),e.on("postrender",this.postRender,this),this.app=e,this.drawLayer=e.scene.layers.getLayerById(4),this.device=s,this.render2d=new nb(s),this.div=n,this.width=0,this.height=0,this.gspacing=2,this.clr=[1,1,1,.5],this._enabled=!0,this.activeSizeIndex=this._activeSizeIndex}destroy(){this.device.off("resizecanvas",this.updateDiv,this),this.device.off("losecontext",this.loseContext,this),this.app.off("postrender",this.postRender,this),this.graphs.forEach((e=>e.destroy())),this.wordAtlas.destroy(),this.texture.destroy()}static getDefaultOptions(){return{sizes:[{width:100,height:16,spacing:0,graphs:!1},{width:128,height:32,spacing:2,graphs:!0},{width:256,height:64,spacing:2,graphs:!0}],startSizeIndex:0,textRefreshRate:500,cpu:{enabled:!0,watermark:33},gpu:{enabled:!0,watermark:33},stats:[{name:"Frame",stats:["frame.ms"],decimalPlaces:1,unitsName:"ms",watermark:33},{name:"DrawCalls",stats:["drawCalls.total"],watermark:1e3}]}}set activeSizeIndex(e){this._activeSizeIndex=e,this.gspacing=this.sizes[e].spacing,this.resize(this.sizes[e].width,this.sizes[e].height,this.sizes[e].graphs)}get activeSizeIndex(){return this._activeSizeIndex}set opacity(e){this.clr[3]=e}get opacity(){return this.clr[3]}get overallHeight(){const e=this.graphs,t=this.gspacing;return this.height*e.length+t*(e.length-1)}set enabled(e){if(e!==this._enabled){this._enabled=e;for(let t=0;t<this.graphs.length;++t)this.graphs[t].enabled=e,this.graphs[t].timer.enabled=e}}get enabled(){return this._enabled}initGraphs(e,t,s){if(this.graphs=[],s.cpu.enabled){const t=new Zv(e),i=new sb("CPU",e,s.cpu.watermark,s.textRefreshRate,t);this.graphs.push(i)}if(s.gpu.enabled){const i=new eb(t),n=new sb("GPU",e,s.gpu.watermark,s.textRefreshRate,i);this.graphs.push(n)}s.stats&&s.stats.forEach((t=>{const i=new tb(e,t.stats,t.decimalPlaces,t.unitsName,t.multiplier),n=new sb(t.name,e,t.watermark,s.textRefreshRate,i);this.graphs.push(n)}));const i=s.sizes.reduce(((e,t)=>t.width>e?t.width:e),0);this.texture=new yn(t,{name:"mini-stats-graph-texture",width:rs.nextPowerOfTwo(i),height:rs.nextPowerOfTwo(this.graphs.length),mipmaps:!1,minFilter:0,magFilter:0,addressU:0,addressV:0}),this.graphs.forEach(((e,t)=>{e.texture=this.texture,e.yOffset=t}))}render(){const e=this.graphs,t=this.wordAtlas,s=this.render2d,i=this.width,n=this.height,r=this.gspacing;s.startFrame();for(let a=0;a<e.length;++a){const o=e[a];let l=a*(n+r);o.render(s,0,l,i,n);let h=1;l+=n-13,h+=t.render(s,o.name,h,l)+10;const c=o.timingText;for(let e=0;e<c.length;++e)h+=t.render(s,c[e],h,l);o.timer.unitsName&&(h+=3,t.render(s,o.timer.unitsName,h,l))}s.render(this.app,this.drawLayer,this.texture,this.wordAtlas.texture,this.clr,n)}resize(e,t,s){const i=this.graphs;for(let e=0;e<i.length;++e)i[e].enabled=s;this.width=e,this.height=t,this.updateDiv()}updateDiv(){const e=this.device.canvas.getBoundingClientRect();this.div.style.left=`${e.left}px`,this.div.style.bottom=window.innerHeight-e.bottom+"px",this.div.style.width=`${this.width}px`,this.div.style.height=`${this.overallHeight}px`}loseContext(){this.graphs.forEach((e=>e.loseContext()))}postRender(){this._enabled&&this.render()}}class ab{constructor(){}textureToCanvas(e,t={}){const s=e.getSource();if("undefined"!=typeof HTMLImageElement&&s instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&s instanceof HTMLCanvasElement||"undefined"!=typeof OffscreenCanvas&&s instanceof OffscreenCanvas||"undefined"!=typeof ImageBitmap&&s instanceof ImageBitmap){const{width:e,height:i}=this.calcTextureSize(s.width,s.height,t.maxTextureSize),n=document.createElement("canvas");n.width=e,n.height=i;const r=n.getContext("2d");if(null===r)return Promise.resolve(void 0);if(r.drawImage(s,0,0,n.width,n.height),t.color){const{r:s,g:n,b:a}=t.color,o=r.getImageData(0,0,e,i),l=o.data;for(let e=0;e<l.length;e+=4)l[e+0]=l[e+0]*s,l[e+1]=l[e+1]*n,l[e+2]=l[e+2]*a;r.putImageData(o,0,0)}return Promise.resolve(n)}const i=e.device,{width:n,height:r}=this.calcTextureSize(e.width,e.height,t.maxTextureSize),a=ii(e.format)?7:e.format,o=new yn(i,{name:"ExtractedTexture",width:n,height:r,format:a,cubemap:!1,mipmaps:!1,minFilter:1,magFilter:1,addressU:1,addressV:1}),l=new tr({colorBuffer:o,depth:!1}),h=fl(i,"\n\tattribute vec2 vertex_position;\n\tvarying vec2 uv0;\n\tvoid main(void) {\n\t\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\t\tuv0 = vertex_position.xy * 0.5 + 0.5;\n\t}","\n\tvarying vec2 uv0;\n\tuniform sampler2D blitTexture;\n\tvoid main(void) {\n\t\tgl_FragColor = texture2D(blitTexture, uv0);\n\t}","ShaderCoreExporterBlit");return i.scope.resolve("blitTexture").setValue(e),i.setBlendState(Rn.NOBLEND),Cl(i,l,h),o.read(0,0,n,r,{renderTarget:l,immediate:!0}).then((e=>{o.destroy(),l.destroy();const t=new Uint8ClampedArray(n*r*4);t.set(e);const s=new ImageData(t,n,r),i=document.createElement("canvas");i.width=n,i.height=r;const a=i.getContext("2d");return a?(a.putImageData(s,0,0),Promise.resolve(i)):Promise.resolve(void 0)}))}calcTextureSize(e,t,s){if(s){const i=Math.min(s/Math.max(e,t),1);e=Math.round(e*i),t=Math.round(t*i)}return{width:e,height:t}}}var ob=Uint8Array,lb=Uint16Array,hb=Int32Array,cb=new ob([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),db=new ob([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),ub=new ob([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),pb=function(e,t){for(var s=new lb(31),i=0;i<31;++i)s[i]=t+=1<<e[i-1];var n=new hb(s[30]);for(i=1;i<30;++i)for(var r=s[i];r<s[i+1];++r)n[r]=r-s[i]<<5|i;return{b:s,r:n}},fb=pb(cb,2),mb=fb.b,gb=fb.r;mb[28]=258,gb[258]=28;for(var _b=pb(db,0).r,vb=new lb(32768),bb=0;bb<32768;++bb){var yb=(43690&bb)>>1|(21845&bb)<<1;yb=(61680&(yb=(52428&yb)>>2|(13107&yb)<<2))>>4|(3855&yb)<<4,vb[bb]=((65280&yb)>>8|(255&yb)<<8)>>1}var xb=function(e,t,s){for(var i=e.length,n=0,r=new lb(t);n<i;++n)e[n]&&++r[e[n]-1];var a,o=new lb(t);for(n=1;n<t;++n)o[n]=o[n-1]+r[n-1]<<1;if(s){a=new lb(1<<t);var l=15-t;for(n=0;n<i;++n)if(e[n])for(var h=n<<4|e[n],c=t-e[n],d=o[e[n]-1]++<<c,u=d|(1<<c)-1;d<=u;++d)a[vb[d]>>l]=h}else for(a=new lb(i),n=0;n<i;++n)e[n]&&(a[n]=vb[o[e[n]-1]++]>>15-e[n]);return a},wb=new ob(288);for(bb=0;bb<144;++bb)wb[bb]=8;for(bb=144;bb<256;++bb)wb[bb]=9;for(bb=256;bb<280;++bb)wb[bb]=7;for(bb=280;bb<288;++bb)wb[bb]=8;var Sb=new ob(32);for(bb=0;bb<32;++bb)Sb[bb]=5;var Cb=xb(wb,9,0);xb(wb,9,1);var Tb=xb(Sb,5,0);xb(Sb,5,1);var Eb=function(e){return(e+7)/8|0},Pb=function(e,t,s){return(null==s||s>e.length)&&(s=e.length),new ob(e.subarray(t,s))},kb=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],Ab=function e(t,s,i){var n=new Error(s||kb[t]);if(n.code=t,Error.captureStackTrace&&Error.captureStackTrace(n,e),!i)throw n;return n},Mb=function(e,t,s){s<<=7&t;var i=t/8|0;e[i]|=s,e[i+1]|=s>>8},Db=function(e,t,s){s<<=7&t;var i=t/8|0;e[i]|=s,e[i+1]|=s>>8,e[i+2]|=s>>16},Rb=function(e,t){for(var s=[],i=0;i<e.length;++i)e[i]&&s.push({s:i,f:e[i]});var n=s.length,r=s.slice();if(!n)return{t:Nb,l:0};if(1==n){var a=new ob(s[0].s+1);return a[s[0].s]=1,{t:a,l:1}}s.sort((function(e,t){return e.f-t.f})),s.push({s:-1,f:25001});var o=s[0],l=s[1],h=0,c=1,d=2;for(s[0]={s:-1,f:o.f+l.f,l:o,r:l};c!=n-1;)o=s[s[h].f<s[d].f?h++:d++],l=s[h!=c&&s[h].f<s[d].f?h++:d++],s[c++]={s:-1,f:o.f+l.f,l:o,r:l};var u=r[0].s;for(i=1;i<n;++i)r[i].s>u&&(u=r[i].s);var p=new lb(u+1),f=Lb(s[c-1],p,0);if(f>t){i=0;var m=0,g=f-t,_=1<<g;for(r.sort((function(e,t){return p[t.s]-p[e.s]||e.f-t.f}));i<n;++i){var v=r[i].s;if(!(p[v]>t))break;m+=_-(1<<f-p[v]),p[v]=t}for(m>>=g;m>0;){var b=r[i].s;p[b]<t?m-=1<<t-p[b]++-1:++i}for(;i>=0&&m;--i){var y=r[i].s;p[y]==t&&(--p[y],++m)}f=t}return{t:new ob(p),l:f}},Lb=function e(t,s,i){return-1==t.s?Math.max(e(t.l,s,i+1),e(t.r,s,i+1)):s[t.s]=i},Ib=function(e){for(var t=e.length;t&&!e[--t];);for(var s=new lb(++t),i=0,n=e[0],r=1,a=function(e){s[i++]=e},o=1;o<=t;++o)if(e[o]==n&&o!=t)++r;else{if(!n&&r>2){for(;r>138;r-=138)a(32754);r>2&&(a(r>10?r-11<<5|28690:r-3<<5|12305),r=0)}else if(r>3){for(a(n),--r;r>6;r-=6)a(8304);r>2&&(a(r-3<<5|8208),r=0)}for(;r--;)a(n);r=1,n=e[o]}return{c:s.subarray(0,i),n:t}},Fb=function(e,t){for(var s=0,i=0;i<t.length;++i)s+=e[i]*t[i];return s},Ob=function(e,t,s){var i=s.length,n=Eb(t+2);e[n]=255&i,e[n+1]=i>>8,e[n+2]=255^e[n],e[n+3]=255^e[n+1];for(var r=0;r<i;++r)e[n+r+4]=s[r];return 8*(n+4+i)},Bb=function(e,t,s,i,n,r,a,o,l,h,c){Mb(t,c++,s),++n[256];for(var d=Rb(n,15),u=d.t,p=d.l,f=Rb(r,15),m=f.t,g=f.l,_=Ib(u),v=_.c,b=_.n,y=Ib(m),x=y.c,w=y.n,S=new lb(19),C=0;C<v.length;++C)++S[31&v[C]];for(C=0;C<x.length;++C)++S[31&x[C]];for(var T=Rb(S,7),E=T.t,P=T.l,k=19;k>4&&!E[ub[k-1]];--k);var A,M,D,R,L=h+5<<3,I=Fb(n,wb)+Fb(r,Sb)+a,F=Fb(n,u)+Fb(r,m)+a+14+3*k+Fb(S,E)+2*S[16]+3*S[17]+7*S[18];if(l>=0&&L<=I&&L<=F)return Ob(t,c,e.subarray(l,l+h));if(Mb(t,c,1+(F<I)),c+=2,F<I){A=xb(u,p,0),M=u,D=xb(m,g,0),R=m;var O=xb(E,P,0);Mb(t,c,b-257),Mb(t,c+5,w-1),Mb(t,c+10,k-4),c+=14;for(C=0;C<k;++C)Mb(t,c+3*C,E[ub[C]]);c+=3*k;for(var B=[v,x],z=0;z<2;++z){var N=B[z];for(C=0;C<N.length;++C){var U=31&N[C];Mb(t,c,O[U]),c+=E[U],U>15&&(Mb(t,c,N[C]>>5&127),c+=N[C]>>12)}}}else A=Cb,M=wb,D=Tb,R=Sb;for(C=0;C<o;++C){var V=i[C];if(V>255){Db(t,c,A[(U=V>>18&31)+257]),c+=M[U+257],U>7&&(Mb(t,c,V>>23&31),c+=cb[U]);var G=31&V;Db(t,c,D[G]),c+=R[G],G>3&&(Db(t,c,V>>5&8191),c+=db[G])}else Db(t,c,A[V]),c+=M[V]}return Db(t,c,A[256]),c+M[256]},zb=new hb([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),Nb=new ob(0),Ub=function(){for(var e=new Int32Array(256),t=0;t<256;++t){for(var s=t,i=9;--i;)s=(1&s&&-306674912)^s>>>1;e[t]=s}return e}(),Vb=function(){var e=-1;return{p:function(t){for(var s=e,i=0;i<t.length;++i)s=Ub[255&s^t[i]]^s>>>8;e=s},d:function(){return~e}}},Gb=function(e,t,s,i,n){if(!n&&(n={l:1},t.dictionary)){var r=t.dictionary.subarray(-32768),a=new ob(r.length+e.length);a.set(r),a.set(e,r.length),e=a,n.w=r.length}return function(e,t,s,i,n,r){var a=r.z||e.length,o=new ob(i+a+5*(1+Math.ceil(a/7e3))+n),l=o.subarray(i,o.length-n),h=r.l,c=7&(r.r||0);if(t){c&&(l[0]=r.r>>3);for(var d=zb[t-1],u=d>>13,p=8191&d,f=(1<<s)-1,m=r.p||new lb(32768),g=r.h||new lb(f+1),_=Math.ceil(s/3),v=2*_,b=function(t){return(e[t]^e[t+1]<<_^e[t+2]<<v)&f},y=new hb(25e3),x=new lb(288),w=new lb(32),S=0,C=0,T=r.i||0,E=0,P=r.w||0,k=0;T+2<a;++T){var A=b(T),M=32767&T,D=g[A];if(m[M]=D,g[A]=M,P<=T){var R=a-T;if((S>7e3||E>24576)&&(R>423||!h)){c=Bb(e,l,0,y,x,w,C,E,k,T-k,c),E=S=C=0,k=T;for(var L=0;L<286;++L)x[L]=0;for(L=0;L<30;++L)w[L]=0}var I=2,F=0,O=p,B=M-D&32767;if(R>2&&A==b(T-B))for(var z=Math.min(u,R)-1,N=Math.min(32767,T),U=Math.min(258,R);B<=N&&--O&&M!=D;){if(e[T+I]==e[T+I-B]){for(var V=0;V<U&&e[T+V]==e[T+V-B];++V);if(V>I){if(I=V,F=B,V>z)break;var G=Math.min(B,V-2),H=0;for(L=0;L<G;++L){var j=T-B+L&32767,W=j-m[j]&32767;W>H&&(H=W,D=j)}}}B+=(M=D)-(D=m[M])&32767}if(F){y[E++]=268435456|gb[I]<<18|_b[F];var $=31&gb[I],q=31&_b[F];C+=cb[$]+db[q],++x[257+$],++w[q],P=T+I,++S}else y[E++]=e[T],++x[e[T]]}}for(T=Math.max(T,P);T<a;++T)y[E++]=e[T],++x[e[T]];c=Bb(e,l,h,y,x,w,C,E,k,T-k,c),h||(r.r=7&c|l[c/8|0]<<3,c-=7,r.h=g,r.p=m,r.i=T,r.w=P)}else{for(T=r.w||0;T<a+h;T+=65535){var X=T+65535;X>=a&&(l[c/8|0]=h,X=a),c=Ob(l,c+1,e.subarray(T,X))}r.i=a}return Pb(o,0,i+Eb(c)+n)}(e,null==t.level?6:t.level,null==t.mem?n.l?Math.ceil(1.5*Math.max(8,Math.min(13,Math.log(e.length)))):20:12+t.mem,s,i,n)},Hb=function(e,t){var s={};for(var i in e)s[i]=e[i];for(var i in t)s[i]=t[i];return s},jb=function(e,t,s){for(;s;++t)e[t]=s,s>>>=8};function Wb(e,t){return Gb(e,t||{},0,0)}var $b=function e(t,s,i,n){for(var r in t){var a=t[r],o=s+r,l=n;Array.isArray(a)&&(l=Hb(n,a[1]),a=a[0]),a instanceof ob?i[o]=[a,l]:(i[o+="/"]=[new ob(0),l],e(a,o,i,n))}},qb="undefined"!=typeof TextEncoder&&new TextEncoder,Xb="undefined"!=typeof TextDecoder&&new TextDecoder;try{Xb.decode(Nb,{stream:!0})}catch(e){}function Kb(e,t){if(qb)return qb.encode(e);for(var s=e.length,i=new ob(e.length+(e.length>>1)),n=0,r=function(e){i[n++]=e},a=0;a<s;++a){if(n+5>i.length){var o=new ob(n+8+(s-a<<1));o.set(i),i=o}var l=e.charCodeAt(a);l<128||t?r(l):l<2048?(r(192|l>>6),r(128|63&l)):l>55295&&l<57344?(r(240|(l=65536+(1047552&l)|1023&e.charCodeAt(++a))>>18),r(128|l>>12&63),r(128|l>>6&63),r(128|63&l)):(r(224|l>>12),r(128|l>>6&63),r(128|63&l))}return Pb(i,0,n)}var Yb=function(e){var t=0;if(e)for(var s in e){var i=e[s].length;i>65535&&Ab(9),t+=i+4}return t},Qb=function(e,t,s,i,n,r,a,o){var l=i.length,h=s.extra,c=o&&o.length,d=Yb(h);jb(e,t,null!=a?33639248:67324752),t+=4,null!=a&&(e[t++]=20,e[t++]=s.os),e[t]=20,t+=2,e[t++]=s.flag<<1|(r<0&&8),e[t++]=n&&8,e[t++]=255&s.compression,e[t++]=s.compression>>8;var u=new Date(null==s.mtime?Date.now():s.mtime),p=u.getFullYear()-1980;if((p<0||p>119)&&Ab(10),jb(e,t,p<<25|u.getMonth()+1<<21|u.getDate()<<16|u.getHours()<<11|u.getMinutes()<<5|u.getSeconds()>>1),t+=4,-1!=r&&(jb(e,t,s.crc),jb(e,t+4,r<0?-r-2:r),jb(e,t+8,s.size)),jb(e,t+12,l),jb(e,t+14,d),t+=16,null!=a&&(jb(e,t,c),jb(e,t+6,s.attrs),jb(e,t+10,a),t+=14),e.set(i,t),t+=l,d)for(var f in h){var m=h[f],g=m.length;jb(e,t,+f),jb(e,t+2,g),e.set(m,t+4),t+=4+g}return c&&(e.set(o,t),t+=c),t};function Jb(e,t){t||(t={});var s={},i=[];$b(e,"",s,t);var n=0,r=0;for(var a in s){var o=s[a],l=o[0],h=o[1],c=0==h.level?0:8,d=(S=Kb(a)).length,u=h.comment,p=u&&Kb(u),f=p&&p.length,m=Yb(h.extra);d>65535&&Ab(11);var g=c?Wb(l,h):l,_=g.length,v=Vb();v.p(l),i.push(Hb(h,{size:l.length,crc:v.d(),c:g,f:S,m:p,u:d!=a.length||p&&u.length!=f,o:n,compression:c})),n+=30+d+m+_,r+=76+2*(d+m)+(f||0)+_}for(var b=new ob(r+22),y=n,x=r-n,w=0;w<i.length;++w){var S=i[w];Qb(b,S.o,S,S.f,S.u,S.c.length);var C=30+S.f.length+Yb(S.extra);b.set(S.c,S.o+C),Qb(b,n,S,S.f,S.u,S.c.length,S.o,S.m),n+=16+C+(S.m?S.m.length:0)}return function(e,t,s,i,n){jb(e,t,101010256),jb(e,t+8,s),jb(e,t+10,s),jb(e,t+12,i),jb(e,t+16,n)}(b,n,i.length,x,y),b}const Zb="root",ey=(e,t,s)=>`                    ${e} inputs:${t} = ${s}`;class ty extends ab{constructor(...e){super(...e),this.meshMap=void 0,this.materialMap=void 0,this.materials=void 0,this.textureMap=void 0,this.nodeNames=void 0,this.files=void 0}init(){this.meshMap=new Map,this.textureMap=new Map,this.materialMap=new Map,this.materials=[],this.files={},this.nodeNames=new Set}done(){this.meshMap=null,this.textureMap=null,this.materialMap=null,this.materials=null,this.files=null,this.nodeNames=null}build(e,t={}){this.init(),this.addFile(null,Zb);const s=[];if(e){e.findComponents("render").forEach((e=>{s.push(...e.meshInstances)}))}let i="";s.forEach((e=>{i+=this.buildMeshInstance(e)})),i+=`\ndef "Materials"\n{\n\t\t${this.materials.join("\n")}\n}\n`,this.addFile(null,Zb,"",i);const n={maxTextureSize:t.maxTextureSize},r=Array.from(this.textureMap.keys()),a=[];for(let e=0;e<r.length;e++){const t="image/png",s=r[e],i=this.textureToCanvas(s,n).then((e=>e?new Promise((s=>e.toBlob(s,t,1))).then((e=>e.arrayBuffer())):(console.warn(`Export of texture ${s.name} is not currently supported.`),new Promise((e=>e(null))))));a.push(i)}const o=Promise.all(a).then((e=>{e.forEach(((e,t)=>{const s=r[t],i=this.getTextureFileIds(s);this.files[i.fileName]=new Uint8Array(e)})),this.alignFiles();const t=Jb(this.files,{level:0});return this.done(),t}));return o}alignFiles(){let e=0;for(const t in this.files){const s=this.files[t];e+=34+t.length;const i=63&e;if(4!==i){const e=new Uint8Array(64-i);this.files[t]=[s,{extra:{12345:e}}]}e=s.length}}getFileIds(e,t,s,i="usda"){const n=`${e?`${e}/`:""}${t}.${i}`;return{name:t,fileName:n,refName:`@./${n}@</${s}>`}}getTextureFileIds(e){return this.getFileIds("texture",`Texture_${e.id}`,"Texture","png")}addFile(e,t,s="",i=""){let n=null;i&&(n=Kb(i=`#usda 1.0\n(\n\t\tcustomLayerData = {\n\t\t\t\tstring creator = "PlayCanvas UsdzExporter"\n\t\t}\n\t\tmetersPerUnit = 1\n\t\tupAxis = "Y"\n)\n\n${i}`));const r=this.getFileIds(e,t,s);return this.files[r.fileName]=n,r.refName}getMaterialRef(e){let t=this.materialMap.get(e);return t||(t=this.buildMaterial(e),this.materialMap.set(e,t)),t}getMeshRef(e){let t=this.meshMap.get(e);return t||(t=this.buildMesh(e),this.meshMap.set(e,t)),t}buildArray2(e){const t=[],s=e.length;for(let i=0;i<s;i+=2)t.push(`(${e[i]}, ${1-e[i+1]})`);return t.join(", ")}buildArray3(e){const t=[],s=e.length;for(let i=0;i<s;i+=3)t.push(`(${e[i]}, ${e[i+1]}, ${e[i+2]})`);return t.join(", ")}buildMat4(e){const t=e.data,s=[];for(let e=0;e<16;e+=4)s.push(`(${t[e]}, ${t[e+1]}, ${t[e+2]}, ${t[e+3]})`);return`( ${s.join(", ")} )`}buildMaterial(e){const t=`Material_${e.id}`,s=`/Materials/${t}`,i=e=>`<${s}${e}>`,n=[],r=[],a=(t,s,a,o,l,h=!1,c=!1)=>{const d=e[t];if(d){const h=this.getTextureFileIds(d);this.textureMap.set(d,h.refName);const u=e[`${t}Channel`]||"rgb",p=i(`/${h.name}_${l}.outputs:${u}`);n.push(ey(a,`${o}.connect`,p));const f=e[`${t}Tiling`],m=e[`${t}Offset`],g=e[`${t}Rotation`],_=1===e[`${t}Uv`]?"st1":"st",v=c&&s?s:os.WHITE;r.push(((e,t,s,n,r,a,o,l)=>`\n\t\t\t\t\t\t\t\tdef Shader "Transform2d_${s}" (\n\t\t\t\t\t\t\t\t\t\tsdrMetadata = {\n\t\t\t\t\t\t\t\t\t\t\t\tstring role = "math"\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tuniform token info:id = "UsdTransform2d"\n\t\t\t\t\t\t\t\t\t\tfloat2 inputs:in.connect = ${i(`/uvReader_${n}.outputs:result`)}\n\t\t\t\t\t\t\t\t\t\tfloat inputs:rotation = ${o}\n\t\t\t\t\t\t\t\t\t\tfloat2 inputs:scale = (${r.x}, ${r.y})\n\t\t\t\t\t\t\t\t\t\tfloat2 inputs:translation = (${a.x}, ${a.y})\n\t\t\t\t\t\t\t\t\t\tfloat2 outputs:result\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tdef Shader "Texture_${e.id}_${s}"\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tuniform token info:id = "UsdUVTexture"\n\t\t\t\t\t\t\t\t\t\tasset inputs:file = @${t.fileName}@\n\t\t\t\t\t\t\t\t\t\tfloat2 inputs:st.connect = ${i(`/Transform2d_${s}.outputs:result`)}\n\t\t\t\t\t\t\t\t\t\ttoken inputs:wrapS = "repeat"\n\t\t\t\t\t\t\t\t\t\ttoken inputs:wrapT = "repeat"\n\t\t\t\t\t\t\t\t\t\tfloat4 inputs:scale = (${l.r}, ${l.g}, ${l.b}, ${l.a})\n\t\t\t\t\t\t\t\t\t\tfloat outputs:r\n\t\t\t\t\t\t\t\t\t\tfloat outputs:g\n\t\t\t\t\t\t\t\t\t\tfloat outputs:b\n\t\t\t\t\t\t\t\t\t\tfloat3 outputs:rgb\n\t\t\t\t\t\t\t\t\t\tfloat outputs:a\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t`)(d,h,l,_,f,m,g,v))}else if(s){const e="float"===a?`${s}`:`(${s.r}, ${s.g}, ${s.b})`;n.push(ey(a,o,e))}};a("diffuseMap",e.diffuse,"color3f","diffuseColor","diffuse",!1,!0),(e.transparent||e.alphaTest>0)&&a("opacityMap",e.opacity,"float","opacity","opacity",!0),a("normalMap",null,"normal3f","normal","normal"),a("emissiveMap",e.emissive,"color3f","emissiveColor","emissive",!1,!0),a("aoMap",null,"float","occlusion","occlusion"),a("metalnessMap",e.metalness,"float","metallic","metallic"),a("glossMap",e.gloss,"float","roughness","roughness");const o=`\n\t\t\t\t\t\tdef Material "${t}"\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tdef Shader "PreviewSurface"\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tuniform token info:id = "UsdPreviewSurface"\n${n.join("\n")}\n\t\t\t\t\t\t\t\t\t\tint inputs:useSpecularWorkflow = 0\n\t\t\t\t\t\t\t\t\t\ttoken outputs:surface\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\ttoken outputs:surface.connect = ${i("/PreviewSurface.outputs:surface")}\n\n\t\t\t\t\t\t\t\tdef Shader "uvReader_st"\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tuniform token info:id = "UsdPrimvarReader_float2"\n\t\t\t\t\t\t\t\t\t\ttoken inputs:varname = "st"\n\t\t\t\t\t\t\t\t\t\tfloat2 inputs:fallback = (0.0, 0.0)\n\t\t\t\t\t\t\t\t\t\tfloat2 outputs:result\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tdef Shader "uvReader_st1"\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tuniform token info:id = "UsdPrimvarReader_float2"\n\t\t\t\t\t\t\t\t\t\ttoken inputs:varname = "st1"\n\t\t\t\t\t\t\t\t\t\tfloat2 inputs:fallback = (0.0, 0.0)\n\t\t\t\t\t\t\t\t\t\tfloat2 outputs:result\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t${r.join("\n")}\n\t\t\t\t\t\t}\n\t\t\t\t`;return this.materials.push(o),i("")}buildMesh(e){let t=[];const s=[];let i=[],n=[],r=[];e.getVertexStream(li,t),e.getVertexStream(hi,i),e.getVertexStream(mi,n),e.getVertexStream(gi,r),e.getIndices(s);const a=s.length||t.length,o=Array(a/3).fill(3).join(", ");if(!s.length)for(let e=0;e<a;e++)s[e]=e;const l=t.length/3;i=i.length?i:Array(3*l).fill(0),n=n.length?n:Array(2*l).fill(0),r=r.length?r:Array(2*l).fill(0),t=this.buildArray3(t),i=this.buildArray3(i),n=this.buildArray2(n),r=this.buildArray2(r);const h=((e,t,s,i,n,r)=>`\ndef "Mesh"\n{\n\t\tdef Mesh "Mesh"\n\t\t{\n\t\t\t\tint[] faceVertexCounts = [${e}]\n\t\t\t\tint[] faceVertexIndices = [${t}]\n\t\t\t\tnormal3f[] normals = [${s}] (\n\t\t\t\t\t\tinterpolation = "vertex"\n\t\t\t\t)\n\t\t\t\tpoint3f[] points = [${i}]\n\t\t\t\ttexCoord2f[] primvars:st = [${n}] (\n\t\t\t\t\t\tinterpolation = "vertex"\n\t\t\t\t)\n\t\t\t\ttexCoord2f[] primvars:st1 = [${r}] (\n\t\t\t\t\t\tinterpolation = "vertex"\n\t\t\t\t)\n\t\t\t\tuniform token subdivisionScheme = "none"\n\t\t}\n}\n`)(o,s,i,t,n,r);return this.addFile("mesh",`Mesh_${e.id}`,"Mesh",h)}buildMeshInstance(e){const t=this.getMeshRef(e.mesh),s=this.getMaterialRef(e.material),i=this.buildMat4(e.node.getWorldTransform()),n=e.node.name.replace(/[^a-z0-9]/gi,"_");let r=n;for(;this.nodeNames.has(r);)r=`${n}_${Math.random().toString(36).slice(2,7)}`;return this.nodeNames.add(r),((e,t,s,i)=>`\ndef Xform "${e}" (\n\t\tprepend references = ${t}\n)\n{\n\t\tmatrix4d xformOp:transform = ${s}\n\t\tuniform token[] xformOpOrder = ["xformOp:transform"]\n\n\t\trel material:binding = ${i}\n}\n`)(r,t,i,s)}}let sy;function iy(e){if(sy.call(this,e),3===e);else this._blendState.setAlphaBlend(0,1,8)}const ny=()=>{const e=Object.getOwnPropertyDescriptor(tc.prototype,"blendType");sy=e.set,Object.defineProperty(tc.prototype,"blendType",{set(e){iy.call(this,e)},get(){return e.get.call(this)}})};var ry,ay,oy,ly,hy={exports:{}},cy={},dy={exports:{}},uy={};function py(){return ry||(ry=1,function(e){function t(e,t){var s=e.length;e.push(t);e:for(;0<s;){var i=s-1>>>1,r=e[i];if(!(0<n(r,t)))break e;e[i]=t,e[s]=r,s=i}}function s(e){return 0===e.length?null:e[0]}function i(e){if(0===e.length)return null;var t=e[0],s=e.pop();if(s!==t){e[0]=s;e:for(var i=0,r=e.length,a=r>>>1;i<a;){var o=2*(i+1)-1,l=e[o],h=o+1,c=e[h];if(0>n(l,s))h<r&&0>n(c,l)?(e[i]=c,e[h]=s,i=h):(e[i]=l,e[o]=s,i=o);else{if(!(h<r&&0>n(c,s)))break e;e[i]=c,e[h]=s,i=h}}}return t}function n(e,t){var s=e.sortIndex-t.sortIndex;return 0!==s?s:e.id-t.id}if("object"==typeof performance&&"function"==typeof performance.now){var r=performance;e.unstable_now=function(){return r.now()}}else{var a=Date,o=a.now();e.unstable_now=function(){return a.now()-o}}var l=[],h=[],c=1,d=null,u=3,p=!1,f=!1,m=!1,g="function"==typeof setTimeout?setTimeout:null,_="function"==typeof clearTimeout?clearTimeout:null,v="undefined"!=typeof setImmediate?setImmediate:null;function b(e){for(var n=s(h);null!==n;){if(null===n.callback)i(h);else{if(!(n.startTime<=e))break;i(h),n.sortIndex=n.expirationTime,t(l,n)}n=s(h)}}function y(e){if(m=!1,b(e),!f)if(null!==s(l))f=!0,R(x);else{var t=s(h);null!==t&&L(y,t.startTime-e)}}function x(t,n){f=!1,m&&(m=!1,_(T),T=-1),p=!0;var r=u;try{for(b(n),d=s(l);null!==d&&(!(d.expirationTime>n)||t&&!k());){var a=d.callback;if("function"==typeof a){d.callback=null,u=d.priorityLevel;var o=a(d.expirationTime<=n);n=e.unstable_now(),"function"==typeof o?d.callback=o:d===s(l)&&i(l),b(n)}else i(l);d=s(l)}if(null!==d)var c=!0;else{var g=s(h);null!==g&&L(y,g.startTime-n),c=!1}return c}finally{d=null,u=r,p=!1}}"undefined"!=typeof navigator&&void 0!==navigator.scheduling&&void 0!==navigator.scheduling.isInputPending&&navigator.scheduling.isInputPending.bind(navigator.scheduling);var w,S=!1,C=null,T=-1,E=5,P=-1;function k(){return!(e.unstable_now()-P<E)}function A(){if(null!==C){var t=e.unstable_now();P=t;var s=!0;try{s=C(!0,t)}finally{s?w():(S=!1,C=null)}}else S=!1}if("function"==typeof v)w=function(){v(A)};else if("undefined"!=typeof MessageChannel){var M=new MessageChannel,D=M.port2;M.port1.onmessage=A,w=function(){D.postMessage(null)}}else w=function(){g(A,0)};function R(e){C=e,S||(S=!0,w())}function L(t,s){T=g((function(){t(e.unstable_now())}),s)}e.unstable_IdlePriority=5,e.unstable_ImmediatePriority=1,e.unstable_LowPriority=4,e.unstable_NormalPriority=3,e.unstable_Profiling=null,e.unstable_UserBlockingPriority=2,e.unstable_cancelCallback=function(e){e.callback=null},e.unstable_continueExecution=function(){f||p||(f=!0,R(x))},e.unstable_forceFrameRate=function(e){0>e||125<e?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):E=0<e?Math.floor(1e3/e):5},e.unstable_getCurrentPriorityLevel=function(){return u},e.unstable_getFirstCallbackNode=function(){return s(l)},e.unstable_next=function(e){switch(u){case 1:case 2:case 3:var t=3;break;default:t=u}var s=u;u=t;try{return e()}finally{u=s}},e.unstable_pauseExecution=function(){},e.unstable_requestPaint=function(){},e.unstable_runWithPriority=function(e,t){switch(e){case 1:case 2:case 3:case 4:case 5:break;default:e=3}var s=u;u=e;try{return t()}finally{u=s}},e.unstable_scheduleCallback=function(i,n,r){var a=e.unstable_now();switch("object"==typeof r&&null!==r?r="number"==typeof(r=r.delay)&&0<r?a+r:a:r=a,i){case 1:var o=-1;break;case 2:o=250;break;case 5:o=1073741823;break;case 4:o=1e4;break;default:o=5e3}return i={id:c++,callback:n,priorityLevel:i,startTime:r,expirationTime:o=r+o,sortIndex:-1},r>a?(i.sortIndex=r,t(h,i),null===s(l)&&i===s(h)&&(m?(_(T),T=-1):m=!0,L(y,r-a))):(i.sortIndex=o,t(l,i),f||p||(f=!0,R(x))),i},e.unstable_shouldYield=k,e.unstable_wrapCallback=function(e){var t=u;return function(){var s=u;u=t;try{return e.apply(this,arguments)}finally{u=s}}}}(uy)),uy}function fy(){return ay||(ay=1,dy.exports=py()),dy.exports}
/**
 * @license React
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */function my(){if(oy)return cy;oy=1;var e=c(),t=fy();function s(e){for(var t="https://reactjs.org/docs/error-decoder.html?invariant="+e,s=1;s<arguments.length;s++)t+="&args[]="+encodeURIComponent(arguments[s]);return"Minified React error #"+e+"; visit "+t+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}var i=new Set,n={};function r(e,t){a(e,t),a(e+"Capture",t)}function a(e,t){for(n[e]=t,e=0;e<t.length;e++)i.add(t[e])}var o=!("undefined"==typeof window||void 0===window.document||void 0===window.document.createElement),l=Object.prototype.hasOwnProperty,h=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,d={},u={};function p(e,t,s,i,n,r,a){this.acceptsBooleans=2===t||3===t||4===t,this.attributeName=i,this.attributeNamespace=n,this.mustUseProperty=s,this.propertyName=e,this.type=t,this.sanitizeURL=r,this.removeEmptyString=a}var f={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach((function(e){f[e]=new p(e,0,!1,e,null,!1,!1)})),[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach((function(e){var t=e[0];f[t]=new p(t,1,!1,e[1],null,!1,!1)})),["contentEditable","draggable","spellCheck","value"].forEach((function(e){f[e]=new p(e,2,!1,e.toLowerCase(),null,!1,!1)})),["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach((function(e){f[e]=new p(e,2,!1,e,null,!1,!1)})),"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture disableRemotePlayback formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach((function(e){f[e]=new p(e,3,!1,e.toLowerCase(),null,!1,!1)})),["checked","multiple","muted","selected"].forEach((function(e){f[e]=new p(e,3,!0,e,null,!1,!1)})),["capture","download"].forEach((function(e){f[e]=new p(e,4,!1,e,null,!1,!1)})),["cols","rows","size","span"].forEach((function(e){f[e]=new p(e,6,!1,e,null,!1,!1)})),["rowSpan","start"].forEach((function(e){f[e]=new p(e,5,!1,e.toLowerCase(),null,!1,!1)}));var m=/[\-:]([a-z])/g;function g(e){return e[1].toUpperCase()}function _(e,t,s,i){var n=f.hasOwnProperty(t)?f[t]:null;(null!==n?0!==n.type:i||!(2<t.length)||"o"!==t[0]&&"O"!==t[0]||"n"!==t[1]&&"N"!==t[1])&&(function(e,t,s,i){if(null==t||function(e,t,s,i){if(null!==s&&0===s.type)return!1;switch(typeof t){case"function":case"symbol":return!0;case"boolean":return!i&&(null!==s?!s.acceptsBooleans:"data-"!==(e=e.toLowerCase().slice(0,5))&&"aria-"!==e);default:return!1}}(e,t,s,i))return!0;if(i)return!1;if(null!==s)switch(s.type){case 3:return!t;case 4:return!1===t;case 5:return isNaN(t);case 6:return isNaN(t)||1>t}return!1}(t,s,n,i)&&(s=null),i||null===n?function(e){return!!l.call(u,e)||!l.call(d,e)&&(h.test(e)?u[e]=!0:(d[e]=!0,!1))}(t)&&(null===s?e.removeAttribute(t):e.setAttribute(t,""+s)):n.mustUseProperty?e[n.propertyName]=null===s?3!==n.type&&"":s:(t=n.attributeName,i=n.attributeNamespace,null===s?e.removeAttribute(t):(s=3===(n=n.type)||4===n&&!0===s?"":""+s,i?e.setAttributeNS(i,t,s):e.setAttribute(t,s))))}"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach((function(e){var t=e.replace(m,g);f[t]=new p(t,1,!1,e,null,!1,!1)})),"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach((function(e){var t=e.replace(m,g);f[t]=new p(t,1,!1,e,"http://www.w3.org/1999/xlink",!1,!1)})),["xml:base","xml:lang","xml:space"].forEach((function(e){var t=e.replace(m,g);f[t]=new p(t,1,!1,e,"http://www.w3.org/XML/1998/namespace",!1,!1)})),["tabIndex","crossOrigin"].forEach((function(e){f[e]=new p(e,1,!1,e.toLowerCase(),null,!1,!1)})),f.xlinkHref=new p("xlinkHref",1,!1,"xlink:href","http://www.w3.org/1999/xlink",!0,!1),["src","href","action","formAction"].forEach((function(e){f[e]=new p(e,1,!1,e.toLowerCase(),null,!0,!0)}));var v=e.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED,b=Symbol.for("react.element"),y=Symbol.for("react.portal"),x=Symbol.for("react.fragment"),w=Symbol.for("react.strict_mode"),S=Symbol.for("react.profiler"),C=Symbol.for("react.provider"),T=Symbol.for("react.context"),E=Symbol.for("react.forward_ref"),P=Symbol.for("react.suspense"),k=Symbol.for("react.suspense_list"),A=Symbol.for("react.memo"),M=Symbol.for("react.lazy"),D=Symbol.for("react.offscreen"),R=Symbol.iterator;function L(e){return null===e||"object"!=typeof e?null:"function"==typeof(e=R&&e[R]||e["@@iterator"])?e:null}var I,F=Object.assign;function O(e){if(void 0===I)try{throw Error()}catch(e){var t=e.stack.trim().match(/\n( *(at )?)/);I=t&&t[1]||""}return"\n"+I+e}var B=!1;function z(e,t){if(!e||B)return"";B=!0;var s=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{if(t)if(t=function(){throw Error()},Object.defineProperty(t.prototype,"props",{set:function(){throw Error()}}),"object"==typeof Reflect&&Reflect.construct){try{Reflect.construct(t,[])}catch(e){var i=e}Reflect.construct(e,[],t)}else{try{t.call()}catch(e){i=e}e.call(t.prototype)}else{try{throw Error()}catch(e){i=e}e()}}catch(t){if(t&&i&&"string"==typeof t.stack){for(var n=t.stack.split("\n"),r=i.stack.split("\n"),a=n.length-1,o=r.length-1;1<=a&&0<=o&&n[a]!==r[o];)o--;for(;1<=a&&0<=o;a--,o--)if(n[a]!==r[o]){if(1!==a||1!==o)do{if(a--,0>--o||n[a]!==r[o]){var l="\n"+n[a].replace(" at new "," at ");return e.displayName&&l.includes("<anonymous>")&&(l=l.replace("<anonymous>",e.displayName)),l}}while(1<=a&&0<=o);break}}}finally{B=!1,Error.prepareStackTrace=s}return(e=e?e.displayName||e.name:"")?O(e):""}function N(e){switch(e.tag){case 5:return O(e.type);case 16:return O("Lazy");case 13:return O("Suspense");case 19:return O("SuspenseList");case 0:case 2:case 15:return e=z(e.type,!1);case 11:return e=z(e.type.render,!1);case 1:return e=z(e.type,!0);default:return""}}function U(e){if(null==e)return null;if("function"==typeof e)return e.displayName||e.name||null;if("string"==typeof e)return e;switch(e){case x:return"Fragment";case y:return"Portal";case S:return"Profiler";case w:return"StrictMode";case P:return"Suspense";case k:return"SuspenseList"}if("object"==typeof e)switch(e.$$typeof){case T:return(e.displayName||"Context")+".Consumer";case C:return(e._context.displayName||"Context")+".Provider";case E:var t=e.render;return(e=e.displayName)||(e=""!==(e=t.displayName||t.name||"")?"ForwardRef("+e+")":"ForwardRef"),e;case A:return null!==(t=e.displayName||null)?t:U(e.type)||"Memo";case M:t=e._payload,e=e._init;try{return U(e(t))}catch(e){}}return null}function V(e){var t=e.type;switch(e.tag){case 24:return"Cache";case 9:return(t.displayName||"Context")+".Consumer";case 10:return(t._context.displayName||"Context")+".Provider";case 18:return"DehydratedFragment";case 11:return e=(e=t.render).displayName||e.name||"",t.displayName||(""!==e?"ForwardRef("+e+")":"ForwardRef");case 7:return"Fragment";case 5:return t;case 4:return"Portal";case 3:return"Root";case 6:return"Text";case 16:return U(t);case 8:return t===w?"StrictMode":"Mode";case 22:return"Offscreen";case 12:return"Profiler";case 21:return"Scope";case 13:return"Suspense";case 19:return"SuspenseList";case 25:return"TracingMarker";case 1:case 0:case 17:case 2:case 14:case 15:if("function"==typeof t)return t.displayName||t.name||null;if("string"==typeof t)return t}return null}function G(e){switch(typeof e){case"boolean":case"number":case"string":case"undefined":case"object":return e;default:return""}}function H(e){var t=e.type;return(e=e.nodeName)&&"input"===e.toLowerCase()&&("checkbox"===t||"radio"===t)}function j(e){e._valueTracker||(e._valueTracker=function(e){var t=H(e)?"checked":"value",s=Object.getOwnPropertyDescriptor(e.constructor.prototype,t),i=""+e[t];if(!e.hasOwnProperty(t)&&void 0!==s&&"function"==typeof s.get&&"function"==typeof s.set){var n=s.get,r=s.set;return Object.defineProperty(e,t,{configurable:!0,get:function(){return n.call(this)},set:function(e){i=""+e,r.call(this,e)}}),Object.defineProperty(e,t,{enumerable:s.enumerable}),{getValue:function(){return i},setValue:function(e){i=""+e},stopTracking:function(){e._valueTracker=null,delete e[t]}}}}(e))}function W(e){if(!e)return!1;var t=e._valueTracker;if(!t)return!0;var s=t.getValue(),i="";return e&&(i=H(e)?e.checked?"true":"false":e.value),(e=i)!==s&&(t.setValue(e),!0)}function $(e){if(void 0===(e=e||("undefined"!=typeof document?document:void 0)))return null;try{return e.activeElement||e.body}catch(t){return e.body}}function q(e,t){var s=t.checked;return F({},t,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:null!=s?s:e._wrapperState.initialChecked})}function X(e,t){var s=null==t.defaultValue?"":t.defaultValue,i=null!=t.checked?t.checked:t.defaultChecked;s=G(null!=t.value?t.value:s),e._wrapperState={initialChecked:i,initialValue:s,controlled:"checkbox"===t.type||"radio"===t.type?null!=t.checked:null!=t.value}}function K(e,t){null!=(t=t.checked)&&_(e,"checked",t,!1)}function Y(e,t){K(e,t);var s=G(t.value),i=t.type;if(null!=s)"number"===i?(0===s&&""===e.value||e.value!=s)&&(e.value=""+s):e.value!==""+s&&(e.value=""+s);else if("submit"===i||"reset"===i)return void e.removeAttribute("value");t.hasOwnProperty("value")?J(e,t.type,s):t.hasOwnProperty("defaultValue")&&J(e,t.type,G(t.defaultValue)),null==t.checked&&null!=t.defaultChecked&&(e.defaultChecked=!!t.defaultChecked)}function Q(e,t,s){if(t.hasOwnProperty("value")||t.hasOwnProperty("defaultValue")){var i=t.type;if(!("submit"!==i&&"reset"!==i||void 0!==t.value&&null!==t.value))return;t=""+e._wrapperState.initialValue,s||t===e.value||(e.value=t),e.defaultValue=t}""!==(s=e.name)&&(e.name=""),e.defaultChecked=!!e._wrapperState.initialChecked,""!==s&&(e.name=s)}function J(e,t,s){"number"===t&&$(e.ownerDocument)===e||(null==s?e.defaultValue=""+e._wrapperState.initialValue:e.defaultValue!==""+s&&(e.defaultValue=""+s))}var Z=Array.isArray;function ee(e,t,s,i){if(e=e.options,t){t={};for(var n=0;n<s.length;n++)t["$"+s[n]]=!0;for(s=0;s<e.length;s++)n=t.hasOwnProperty("$"+e[s].value),e[s].selected!==n&&(e[s].selected=n),n&&i&&(e[s].defaultSelected=!0)}else{for(s=""+G(s),t=null,n=0;n<e.length;n++){if(e[n].value===s)return e[n].selected=!0,void(i&&(e[n].defaultSelected=!0));null!==t||e[n].disabled||(t=e[n])}null!==t&&(t.selected=!0)}}function te(e,t){if(null!=t.dangerouslySetInnerHTML)throw Error(s(91));return F({},t,{value:void 0,defaultValue:void 0,children:""+e._wrapperState.initialValue})}function se(e,t){var i=t.value;if(null==i){if(i=t.children,t=t.defaultValue,null!=i){if(null!=t)throw Error(s(92));if(Z(i)){if(1<i.length)throw Error(s(93));i=i[0]}t=i}null==t&&(t=""),i=t}e._wrapperState={initialValue:G(i)}}function ie(e,t){var s=G(t.value),i=G(t.defaultValue);null!=s&&((s=""+s)!==e.value&&(e.value=s),null==t.defaultValue&&e.defaultValue!==s&&(e.defaultValue=s)),null!=i&&(e.defaultValue=""+i)}function ne(e){var t=e.textContent;t===e._wrapperState.initialValue&&""!==t&&null!==t&&(e.value=t)}function re(e){switch(e){case"svg":return"http://www.w3.org/2000/svg";case"math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function ae(e,t){return null==e||"http://www.w3.org/1999/xhtml"===e?re(t):"http://www.w3.org/2000/svg"===e&&"foreignObject"===t?"http://www.w3.org/1999/xhtml":e}var oe,le,he=(le=function(e,t){if("http://www.w3.org/2000/svg"!==e.namespaceURI||"innerHTML"in e)e.innerHTML=t;else{for((oe=oe||document.createElement("div")).innerHTML="<svg>"+t.valueOf().toString()+"</svg>",t=oe.firstChild;e.firstChild;)e.removeChild(e.firstChild);for(;t.firstChild;)e.appendChild(t.firstChild)}},"undefined"!=typeof MSApp&&MSApp.execUnsafeLocalFunction?function(e,t,s,i){MSApp.execUnsafeLocalFunction((function(){return le(e,t)}))}:le);function ce(e,t){if(t){var s=e.firstChild;if(s&&s===e.lastChild&&3===s.nodeType)return void(s.nodeValue=t)}e.textContent=t}var de={animationIterationCount:!0,aspectRatio:!0,borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},ue=["Webkit","ms","Moz","O"];function pe(e,t,s){return null==t||"boolean"==typeof t||""===t?"":s||"number"!=typeof t||0===t||de.hasOwnProperty(e)&&de[e]?(""+t).trim():t+"px"}function fe(e,t){for(var s in e=e.style,t)if(t.hasOwnProperty(s)){var i=0===s.indexOf("--"),n=pe(s,t[s],i);"float"===s&&(s="cssFloat"),i?e.setProperty(s,n):e[s]=n}}Object.keys(de).forEach((function(e){ue.forEach((function(t){t=t+e.charAt(0).toUpperCase()+e.substring(1),de[t]=de[e]}))}));var me=F({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0});function ge(e,t){if(t){if(me[e]&&(null!=t.children||null!=t.dangerouslySetInnerHTML))throw Error(s(137,e));if(null!=t.dangerouslySetInnerHTML){if(null!=t.children)throw Error(s(60));if("object"!=typeof t.dangerouslySetInnerHTML||!("__html"in t.dangerouslySetInnerHTML))throw Error(s(61))}if(null!=t.style&&"object"!=typeof t.style)throw Error(s(62))}}function _e(e,t){if(-1===e.indexOf("-"))return"string"==typeof t.is;switch(e){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}var ve=null;function be(e){return(e=e.target||e.srcElement||window).correspondingUseElement&&(e=e.correspondingUseElement),3===e.nodeType?e.parentNode:e}var ye=null,xe=null,we=null;function Se(e){if(e=_n(e)){if("function"!=typeof ye)throw Error(s(280));var t=e.stateNode;t&&(t=bn(t),ye(e.stateNode,e.type,t))}}function Ce(e){xe?we?we.push(e):we=[e]:xe=e}function Te(){if(xe){var e=xe,t=we;if(we=xe=null,Se(e),t)for(e=0;e<t.length;e++)Se(t[e])}}function Ee(e,t){return e(t)}function Pe(){}var ke=!1;function Ae(e,t,s){if(ke)return e(t,s);ke=!0;try{return Ee(e,t,s)}finally{ke=!1,(null!==xe||null!==we)&&(Pe(),Te())}}function Me(e,t){var i=e.stateNode;if(null===i)return null;var n=bn(i);if(null===n)return null;i=n[t];e:switch(t){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":case"onMouseEnter":(n=!n.disabled)||(n=!("button"===(e=e.type)||"input"===e||"select"===e||"textarea"===e)),e=!n;break e;default:e=!1}if(e)return null;if(i&&"function"!=typeof i)throw Error(s(231,t,typeof i));return i}var De=!1;if(o)try{var Re={};Object.defineProperty(Re,"passive",{get:function(){De=!0}}),window.addEventListener("test",Re,Re),window.removeEventListener("test",Re,Re)}catch(le){De=!1}function Le(e,t,s,i,n,r,a,o,l){var h=Array.prototype.slice.call(arguments,3);try{t.apply(s,h)}catch(e){this.onError(e)}}var Ie=!1,Fe=null,Oe=!1,Be=null,ze={onError:function(e){Ie=!0,Fe=e}};function Ne(e,t,s,i,n,r,a,o,l){Ie=!1,Fe=null,Le.apply(ze,arguments)}function Ue(e){var t=e,s=e;if(e.alternate)for(;t.return;)t=t.return;else{e=t;do{!!(4098&(t=e).flags)&&(s=t.return),e=t.return}while(e)}return 3===t.tag?s:null}function Ve(e){if(13===e.tag){var t=e.memoizedState;if(null===t&&(null!==(e=e.alternate)&&(t=e.memoizedState)),null!==t)return t.dehydrated}return null}function Ge(e){if(Ue(e)!==e)throw Error(s(188))}function He(e){return e=function(e){var t=e.alternate;if(!t){if(null===(t=Ue(e)))throw Error(s(188));return t!==e?null:e}for(var i=e,n=t;;){var r=i.return;if(null===r)break;var a=r.alternate;if(null===a){if(null!==(n=r.return)){i=n;continue}break}if(r.child===a.child){for(a=r.child;a;){if(a===i)return Ge(r),e;if(a===n)return Ge(r),t;a=a.sibling}throw Error(s(188))}if(i.return!==n.return)i=r,n=a;else{for(var o=!1,l=r.child;l;){if(l===i){o=!0,i=r,n=a;break}if(l===n){o=!0,n=r,i=a;break}l=l.sibling}if(!o){for(l=a.child;l;){if(l===i){o=!0,i=a,n=r;break}if(l===n){o=!0,n=a,i=r;break}l=l.sibling}if(!o)throw Error(s(189))}}if(i.alternate!==n)throw Error(s(190))}if(3!==i.tag)throw Error(s(188));return i.stateNode.current===i?e:t}(e),null!==e?je(e):null}function je(e){if(5===e.tag||6===e.tag)return e;for(e=e.child;null!==e;){var t=je(e);if(null!==t)return t;e=e.sibling}return null}var We=t.unstable_scheduleCallback,$e=t.unstable_cancelCallback,qe=t.unstable_shouldYield,Xe=t.unstable_requestPaint,Ke=t.unstable_now,Ye=t.unstable_getCurrentPriorityLevel,Qe=t.unstable_ImmediatePriority,Je=t.unstable_UserBlockingPriority,Ze=t.unstable_NormalPriority,et=t.unstable_LowPriority,tt=t.unstable_IdlePriority,st=null,it=null;var nt=Math.clz32?Math.clz32:function(e){return e>>>=0,0===e?32:31-(rt(e)/at|0)|0},rt=Math.log,at=Math.LN2;var ot=64,lt=4194304;function ht(e){switch(e&-e){case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return 4194240&e;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return 130023424&e;case 134217728:return 134217728;case 268435456:return 268435456;case 536870912:return 536870912;case 1073741824:return 1073741824;default:return e}}function ct(e,t){var s=e.pendingLanes;if(0===s)return 0;var i=0,n=e.suspendedLanes,r=e.pingedLanes,a=268435455&s;if(0!==a){var o=a&~n;0!==o?i=ht(o):0!==(r&=a)&&(i=ht(r))}else 0!==(a=s&~n)?i=ht(a):0!==r&&(i=ht(r));if(0===i)return 0;if(0!==t&&t!==i&&!(t&n)&&((n=i&-i)>=(r=t&-t)||16===n&&4194240&r))return t;if(4&i&&(i|=16&s),0!==(t=e.entangledLanes))for(e=e.entanglements,t&=i;0<t;)n=1<<(s=31-nt(t)),i|=e[s],t&=~n;return i}function dt(e,t){switch(e){case 1:case 2:case 4:return t+250;case 8:case 16:case 32:case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return t+5e3;default:return-1}}function ut(e){return 0!==(e=-1073741825&e.pendingLanes)?e:1073741824&e?1073741824:0}function pt(){var e=ot;return!(4194240&(ot<<=1))&&(ot=64),e}function ft(e){for(var t=[],s=0;31>s;s++)t.push(e);return t}function mt(e,t,s){e.pendingLanes|=t,536870912!==t&&(e.suspendedLanes=0,e.pingedLanes=0),(e=e.eventTimes)[t=31-nt(t)]=s}function gt(e,t){var s=e.entangledLanes|=t;for(e=e.entanglements;s;){var i=31-nt(s),n=1<<i;n&t|e[i]&t&&(e[i]|=t),s&=~n}}var _t=0;function vt(e){return 1<(e&=-e)?4<e?268435455&e?16:536870912:4:1}var bt,yt,xt,wt,St,Ct=!1,Tt=[],Et=null,Pt=null,kt=null,At=new Map,Mt=new Map,Dt=[],Rt="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput copy cut paste click change contextmenu reset submit".split(" ");function Lt(e,t){switch(e){case"focusin":case"focusout":Et=null;break;case"dragenter":case"dragleave":Pt=null;break;case"mouseover":case"mouseout":kt=null;break;case"pointerover":case"pointerout":At.delete(t.pointerId);break;case"gotpointercapture":case"lostpointercapture":Mt.delete(t.pointerId)}}function It(e,t,s,i,n,r){return null===e||e.nativeEvent!==r?(e={blockedOn:t,domEventName:s,eventSystemFlags:i,nativeEvent:r,targetContainers:[n]},null!==t&&(null!==(t=_n(t))&&yt(t)),e):(e.eventSystemFlags|=i,t=e.targetContainers,null!==n&&-1===t.indexOf(n)&&t.push(n),e)}function Ft(e){var t=gn(e.target);if(null!==t){var s=Ue(t);if(null!==s)if(13===(t=s.tag)){if(null!==(t=Ve(s)))return e.blockedOn=t,void St(e.priority,(function(){xt(s)}))}else if(3===t&&s.stateNode.current.memoizedState.isDehydrated)return void(e.blockedOn=3===s.tag?s.stateNode.containerInfo:null)}e.blockedOn=null}function Ot(e){if(null!==e.blockedOn)return!1;for(var t=e.targetContainers;0<t.length;){var s=qt(e.domEventName,e.eventSystemFlags,t[0],e.nativeEvent);if(null!==s)return null!==(t=_n(s))&&yt(t),e.blockedOn=s,!1;var i=new(s=e.nativeEvent).constructor(s.type,s);ve=i,s.target.dispatchEvent(i),ve=null,t.shift()}return!0}function Bt(e,t,s){Ot(e)&&s.delete(t)}function zt(){Ct=!1,null!==Et&&Ot(Et)&&(Et=null),null!==Pt&&Ot(Pt)&&(Pt=null),null!==kt&&Ot(kt)&&(kt=null),At.forEach(Bt),Mt.forEach(Bt)}function Nt(e,s){e.blockedOn===s&&(e.blockedOn=null,Ct||(Ct=!0,t.unstable_scheduleCallback(t.unstable_NormalPriority,zt)))}function Ut(e){function t(t){return Nt(t,e)}if(0<Tt.length){Nt(Tt[0],e);for(var s=1;s<Tt.length;s++){var i=Tt[s];i.blockedOn===e&&(i.blockedOn=null)}}for(null!==Et&&Nt(Et,e),null!==Pt&&Nt(Pt,e),null!==kt&&Nt(kt,e),At.forEach(t),Mt.forEach(t),s=0;s<Dt.length;s++)(i=Dt[s]).blockedOn===e&&(i.blockedOn=null);for(;0<Dt.length&&null===(s=Dt[0]).blockedOn;)Ft(s),null===s.blockedOn&&Dt.shift()}var Vt=v.ReactCurrentBatchConfig,Gt=!0;function Ht(e,t,s,i){var n=_t,r=Vt.transition;Vt.transition=null;try{_t=1,Wt(e,t,s,i)}finally{_t=n,Vt.transition=r}}function jt(e,t,s,i){var n=_t,r=Vt.transition;Vt.transition=null;try{_t=4,Wt(e,t,s,i)}finally{_t=n,Vt.transition=r}}function Wt(e,t,s,i){if(Gt){var n=qt(e,t,s,i);if(null===n)Vi(e,t,i,$t,s),Lt(e,i);else if(function(e,t,s,i,n){switch(t){case"focusin":return Et=It(Et,e,t,s,i,n),!0;case"dragenter":return Pt=It(Pt,e,t,s,i,n),!0;case"mouseover":return kt=It(kt,e,t,s,i,n),!0;case"pointerover":var r=n.pointerId;return At.set(r,It(At.get(r)||null,e,t,s,i,n)),!0;case"gotpointercapture":return r=n.pointerId,Mt.set(r,It(Mt.get(r)||null,e,t,s,i,n)),!0}return!1}(n,e,t,s,i))i.stopPropagation();else if(Lt(e,i),4&t&&-1<Rt.indexOf(e)){for(;null!==n;){var r=_n(n);if(null!==r&&bt(r),null===(r=qt(e,t,s,i))&&Vi(e,t,i,$t,s),r===n)break;n=r}null!==n&&i.stopPropagation()}else Vi(e,t,i,null,s)}}var $t=null;function qt(e,t,s,i){if($t=null,null!==(e=gn(e=be(i))))if(null===(t=Ue(e)))e=null;else if(13===(s=t.tag)){if(null!==(e=Ve(t)))return e;e=null}else if(3===s){if(t.stateNode.current.memoizedState.isDehydrated)return 3===t.tag?t.stateNode.containerInfo:null;e=null}else t!==e&&(e=null);return $t=e,null}function Xt(e){switch(e){case"cancel":case"click":case"close":case"contextmenu":case"copy":case"cut":case"auxclick":case"dblclick":case"dragend":case"dragstart":case"drop":case"focusin":case"focusout":case"input":case"invalid":case"keydown":case"keypress":case"keyup":case"mousedown":case"mouseup":case"paste":case"pause":case"play":case"pointercancel":case"pointerdown":case"pointerup":case"ratechange":case"reset":case"resize":case"seeked":case"submit":case"touchcancel":case"touchend":case"touchstart":case"volumechange":case"change":case"selectionchange":case"textInput":case"compositionstart":case"compositionend":case"compositionupdate":case"beforeblur":case"afterblur":case"beforeinput":case"blur":case"fullscreenchange":case"focus":case"hashchange":case"popstate":case"select":case"selectstart":return 1;case"drag":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"mousemove":case"mouseout":case"mouseover":case"pointermove":case"pointerout":case"pointerover":case"scroll":case"toggle":case"touchmove":case"wheel":case"mouseenter":case"mouseleave":case"pointerenter":case"pointerleave":return 4;case"message":switch(Ye()){case Qe:return 1;case Je:return 4;case Ze:case et:return 16;case tt:return 536870912;default:return 16}default:return 16}}var Kt=null,Yt=null,Qt=null;function Jt(){if(Qt)return Qt;var e,t,s=Yt,i=s.length,n="value"in Kt?Kt.value:Kt.textContent,r=n.length;for(e=0;e<i&&s[e]===n[e];e++);var a=i-e;for(t=1;t<=a&&s[i-t]===n[r-t];t++);return Qt=n.slice(e,1<t?1-t:void 0)}function Zt(e){var t=e.keyCode;return"charCode"in e?0===(e=e.charCode)&&13===t&&(e=13):e=t,10===e&&(e=13),32<=e||13===e?e:0}function es(){return!0}function ts(){return!1}function ss(e){function t(t,s,i,n,r){for(var a in this._reactName=t,this._targetInst=i,this.type=s,this.nativeEvent=n,this.target=r,this.currentTarget=null,e)e.hasOwnProperty(a)&&(t=e[a],this[a]=t?t(n):n[a]);return this.isDefaultPrevented=(null!=n.defaultPrevented?n.defaultPrevented:!1===n.returnValue)?es:ts,this.isPropagationStopped=ts,this}return F(t.prototype,{preventDefault:function(){this.defaultPrevented=!0;var e=this.nativeEvent;e&&(e.preventDefault?e.preventDefault():"unknown"!=typeof e.returnValue&&(e.returnValue=!1),this.isDefaultPrevented=es)},stopPropagation:function(){var e=this.nativeEvent;e&&(e.stopPropagation?e.stopPropagation():"unknown"!=typeof e.cancelBubble&&(e.cancelBubble=!0),this.isPropagationStopped=es)},persist:function(){},isPersistent:es}),t}var is,ns,rs,as={eventPhase:0,bubbles:0,cancelable:0,timeStamp:function(e){return e.timeStamp||Date.now()},defaultPrevented:0,isTrusted:0},os=ss(as),ls=F({},as,{view:0,detail:0}),hs=ss(ls),cs=F({},ls,{screenX:0,screenY:0,clientX:0,clientY:0,pageX:0,pageY:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,getModifierState:ws,button:0,buttons:0,relatedTarget:function(e){return void 0===e.relatedTarget?e.fromElement===e.srcElement?e.toElement:e.fromElement:e.relatedTarget},movementX:function(e){return"movementX"in e?e.movementX:(e!==rs&&(rs&&"mousemove"===e.type?(is=e.screenX-rs.screenX,ns=e.screenY-rs.screenY):ns=is=0,rs=e),is)},movementY:function(e){return"movementY"in e?e.movementY:ns}}),ds=ss(cs),us=ss(F({},cs,{dataTransfer:0})),ps=ss(F({},ls,{relatedTarget:0})),fs=ss(F({},as,{animationName:0,elapsedTime:0,pseudoElement:0})),ms=F({},as,{clipboardData:function(e){return"clipboardData"in e?e.clipboardData:window.clipboardData}}),gs=ss(ms),_s=ss(F({},as,{data:0})),vs={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},bs={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"},ys={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function xs(e){var t=this.nativeEvent;return t.getModifierState?t.getModifierState(e):!!(e=ys[e])&&!!t[e]}function ws(){return xs}var Ss=F({},ls,{key:function(e){if(e.key){var t=vs[e.key]||e.key;if("Unidentified"!==t)return t}return"keypress"===e.type?13===(e=Zt(e))?"Enter":String.fromCharCode(e):"keydown"===e.type||"keyup"===e.type?bs[e.keyCode]||"Unidentified":""},code:0,location:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,repeat:0,locale:0,getModifierState:ws,charCode:function(e){return"keypress"===e.type?Zt(e):0},keyCode:function(e){return"keydown"===e.type||"keyup"===e.type?e.keyCode:0},which:function(e){return"keypress"===e.type?Zt(e):"keydown"===e.type||"keyup"===e.type?e.keyCode:0}}),Cs=ss(Ss),Ts=ss(F({},cs,{pointerId:0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,pointerType:0,isPrimary:0})),Es=ss(F({},ls,{touches:0,targetTouches:0,changedTouches:0,altKey:0,metaKey:0,ctrlKey:0,shiftKey:0,getModifierState:ws})),Ps=ss(F({},as,{propertyName:0,elapsedTime:0,pseudoElement:0})),ks=F({},cs,{deltaX:function(e){return"deltaX"in e?e.deltaX:"wheelDeltaX"in e?-e.wheelDeltaX:0},deltaY:function(e){return"deltaY"in e?e.deltaY:"wheelDeltaY"in e?-e.wheelDeltaY:"wheelDelta"in e?-e.wheelDelta:0},deltaZ:0,deltaMode:0}),As=ss(ks),Ms=[9,13,27,32],Ds=o&&"CompositionEvent"in window,Rs=null;o&&"documentMode"in document&&(Rs=document.documentMode);var Ls=o&&"TextEvent"in window&&!Rs,Is=o&&(!Ds||Rs&&8<Rs&&11>=Rs),Fs=String.fromCharCode(32),Os=!1;function Bs(e,t){switch(e){case"keyup":return-1!==Ms.indexOf(t.keyCode);case"keydown":return 229!==t.keyCode;case"keypress":case"mousedown":case"focusout":return!0;default:return!1}}function zs(e){return"object"==typeof(e=e.detail)&&"data"in e?e.data:null}var Ns=!1;var Us={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function Vs(e){var t=e&&e.nodeName&&e.nodeName.toLowerCase();return"input"===t?!!Us[e.type]:"textarea"===t}function Gs(e,t,s,i){Ce(i),0<(t=Hi(t,"onChange")).length&&(s=new os("onChange","change",null,s,i),e.push({event:s,listeners:t}))}var Hs=null,js=null;function Ws(e){Fi(e,0)}function $s(e){if(W(vn(e)))return e}function qs(e,t){if("change"===e)return t}var Xs=!1;if(o){var Ks;if(o){var Ys="oninput"in document;if(!Ys){var Qs=document.createElement("div");Qs.setAttribute("oninput","return;"),Ys="function"==typeof Qs.oninput}Ks=Ys}else Ks=!1;Xs=Ks&&(!document.documentMode||9<document.documentMode)}function Js(){Hs&&(Hs.detachEvent("onpropertychange",Zs),js=Hs=null)}function Zs(e){if("value"===e.propertyName&&$s(js)){var t=[];Gs(t,js,e,be(e)),Ae(Ws,t)}}function ei(e,t,s){"focusin"===e?(Js(),js=s,(Hs=t).attachEvent("onpropertychange",Zs)):"focusout"===e&&Js()}function ti(e){if("selectionchange"===e||"keyup"===e||"keydown"===e)return $s(js)}function si(e,t){if("click"===e)return $s(t)}function ii(e,t){if("input"===e||"change"===e)return $s(t)}var ni="function"==typeof Object.is?Object.is:function(e,t){return e===t&&(0!==e||1/e==1/t)||e!=e&&t!=t};function ri(e,t){if(ni(e,t))return!0;if("object"!=typeof e||null===e||"object"!=typeof t||null===t)return!1;var s=Object.keys(e),i=Object.keys(t);if(s.length!==i.length)return!1;for(i=0;i<s.length;i++){var n=s[i];if(!l.call(t,n)||!ni(e[n],t[n]))return!1}return!0}function ai(e){for(;e&&e.firstChild;)e=e.firstChild;return e}function oi(e,t){var s,i=ai(e);for(e=0;i;){if(3===i.nodeType){if(s=e+i.textContent.length,e<=t&&s>=t)return{node:i,offset:t-e};e=s}e:{for(;i;){if(i.nextSibling){i=i.nextSibling;break e}i=i.parentNode}i=void 0}i=ai(i)}}function li(e,t){return!(!e||!t)&&(e===t||(!e||3!==e.nodeType)&&(t&&3===t.nodeType?li(e,t.parentNode):"contains"in e?e.contains(t):!!e.compareDocumentPosition&&!!(16&e.compareDocumentPosition(t))))}function hi(){for(var e=window,t=$();t instanceof e.HTMLIFrameElement;){try{var s="string"==typeof t.contentWindow.location.href}catch(e){s=!1}if(!s)break;t=$((e=t.contentWindow).document)}return t}function ci(e){var t=e&&e.nodeName&&e.nodeName.toLowerCase();return t&&("input"===t&&("text"===e.type||"search"===e.type||"tel"===e.type||"url"===e.type||"password"===e.type)||"textarea"===t||"true"===e.contentEditable)}function di(e){var t=hi(),s=e.focusedElem,i=e.selectionRange;if(t!==s&&s&&s.ownerDocument&&li(s.ownerDocument.documentElement,s)){if(null!==i&&ci(s))if(t=i.start,void 0===(e=i.end)&&(e=t),"selectionStart"in s)s.selectionStart=t,s.selectionEnd=Math.min(e,s.value.length);else if((e=(t=s.ownerDocument||document)&&t.defaultView||window).getSelection){e=e.getSelection();var n=s.textContent.length,r=Math.min(i.start,n);i=void 0===i.end?r:Math.min(i.end,n),!e.extend&&r>i&&(n=i,i=r,r=n),n=oi(s,r);var a=oi(s,i);n&&a&&(1!==e.rangeCount||e.anchorNode!==n.node||e.anchorOffset!==n.offset||e.focusNode!==a.node||e.focusOffset!==a.offset)&&((t=t.createRange()).setStart(n.node,n.offset),e.removeAllRanges(),r>i?(e.addRange(t),e.extend(a.node,a.offset)):(t.setEnd(a.node,a.offset),e.addRange(t)))}for(t=[],e=s;e=e.parentNode;)1===e.nodeType&&t.push({element:e,left:e.scrollLeft,top:e.scrollTop});for("function"==typeof s.focus&&s.focus(),s=0;s<t.length;s++)(e=t[s]).element.scrollLeft=e.left,e.element.scrollTop=e.top}}var ui=o&&"documentMode"in document&&11>=document.documentMode,pi=null,fi=null,mi=null,gi=!1;function _i(e,t,s){var i=s.window===s?s.document:9===s.nodeType?s:s.ownerDocument;gi||null==pi||pi!==$(i)||("selectionStart"in(i=pi)&&ci(i)?i={start:i.selectionStart,end:i.selectionEnd}:i={anchorNode:(i=(i.ownerDocument&&i.ownerDocument.defaultView||window).getSelection()).anchorNode,anchorOffset:i.anchorOffset,focusNode:i.focusNode,focusOffset:i.focusOffset},mi&&ri(mi,i)||(mi=i,0<(i=Hi(fi,"onSelect")).length&&(t=new os("onSelect","select",null,t,s),e.push({event:t,listeners:i}),t.target=pi)))}function vi(e,t){var s={};return s[e.toLowerCase()]=t.toLowerCase(),s["Webkit"+e]="webkit"+t,s["Moz"+e]="moz"+t,s}var bi={animationend:vi("Animation","AnimationEnd"),animationiteration:vi("Animation","AnimationIteration"),animationstart:vi("Animation","AnimationStart"),transitionend:vi("Transition","TransitionEnd")},yi={},xi={};function wi(e){if(yi[e])return yi[e];if(!bi[e])return e;var t,s=bi[e];for(t in s)if(s.hasOwnProperty(t)&&t in xi)return yi[e]=s[t];return e}o&&(xi=document.createElement("div").style,"AnimationEvent"in window||(delete bi.animationend.animation,delete bi.animationiteration.animation,delete bi.animationstart.animation),"TransitionEvent"in window||delete bi.transitionend.transition);var Si=wi("animationend"),Ci=wi("animationiteration"),Ti=wi("animationstart"),Ei=wi("transitionend"),Pi=new Map,ki="abort auxClick cancel canPlay canPlayThrough click close contextMenu copy cut drag dragEnd dragEnter dragExit dragLeave dragOver dragStart drop durationChange emptied encrypted ended error gotPointerCapture input invalid keyDown keyPress keyUp load loadedData loadedMetadata loadStart lostPointerCapture mouseDown mouseMove mouseOut mouseOver mouseUp paste pause play playing pointerCancel pointerDown pointerMove pointerOut pointerOver pointerUp progress rateChange reset resize seeked seeking stalled submit suspend timeUpdate touchCancel touchEnd touchStart volumeChange scroll toggle touchMove waiting wheel".split(" ");function Ai(e,t){Pi.set(e,t),r(t,[e])}for(var Mi=0;Mi<ki.length;Mi++){var Di=ki[Mi];Ai(Di.toLowerCase(),"on"+(Di[0].toUpperCase()+Di.slice(1)))}Ai(Si,"onAnimationEnd"),Ai(Ci,"onAnimationIteration"),Ai(Ti,"onAnimationStart"),Ai("dblclick","onDoubleClick"),Ai("focusin","onFocus"),Ai("focusout","onBlur"),Ai(Ei,"onTransitionEnd"),a("onMouseEnter",["mouseout","mouseover"]),a("onMouseLeave",["mouseout","mouseover"]),a("onPointerEnter",["pointerout","pointerover"]),a("onPointerLeave",["pointerout","pointerover"]),r("onChange","change click focusin focusout input keydown keyup selectionchange".split(" ")),r("onSelect","focusout contextmenu dragend focusin keydown keyup mousedown mouseup selectionchange".split(" ")),r("onBeforeInput",["compositionend","keypress","textInput","paste"]),r("onCompositionEnd","compositionend focusout keydown keypress keyup mousedown".split(" ")),r("onCompositionStart","compositionstart focusout keydown keypress keyup mousedown".split(" ")),r("onCompositionUpdate","compositionupdate focusout keydown keypress keyup mousedown".split(" "));var Ri="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange resize seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),Li=new Set("cancel close invalid load scroll toggle".split(" ").concat(Ri));function Ii(e,t,i){var n=e.type||"unknown-event";e.currentTarget=i,function(e,t,i,n,r,a,o,l,h){if(Ne.apply(this,arguments),Ie){if(!Ie)throw Error(s(198));var c=Fe;Ie=!1,Fe=null,Oe||(Oe=!0,Be=c)}}(n,t,void 0,e),e.currentTarget=null}function Fi(e,t){t=!!(4&t);for(var s=0;s<e.length;s++){var i=e[s],n=i.event;i=i.listeners;e:{var r=void 0;if(t)for(var a=i.length-1;0<=a;a--){var o=i[a],l=o.instance,h=o.currentTarget;if(o=o.listener,l!==r&&n.isPropagationStopped())break e;Ii(n,o,h),r=l}else for(a=0;a<i.length;a++){if(l=(o=i[a]).instance,h=o.currentTarget,o=o.listener,l!==r&&n.isPropagationStopped())break e;Ii(n,o,h),r=l}}}if(Oe)throw e=Be,Oe=!1,Be=null,e}function Oi(e,t){var s=t[pn];void 0===s&&(s=t[pn]=new Set);var i=e+"__bubble";s.has(i)||(Ui(t,e,2,!1),s.add(i))}function Bi(e,t,s){var i=0;t&&(i|=4),Ui(s,e,i,t)}var zi="_reactListening"+Math.random().toString(36).slice(2);function Ni(e){if(!e[zi]){e[zi]=!0,i.forEach((function(t){"selectionchange"!==t&&(Li.has(t)||Bi(t,!1,e),Bi(t,!0,e))}));var t=9===e.nodeType?e:e.ownerDocument;null===t||t[zi]||(t[zi]=!0,Bi("selectionchange",!1,t))}}function Ui(e,t,s,i){switch(Xt(t)){case 1:var n=Ht;break;case 4:n=jt;break;default:n=Wt}s=n.bind(null,t,s,e),n=void 0,!De||"touchstart"!==t&&"touchmove"!==t&&"wheel"!==t||(n=!0),i?void 0!==n?e.addEventListener(t,s,{capture:!0,passive:n}):e.addEventListener(t,s,!0):void 0!==n?e.addEventListener(t,s,{passive:n}):e.addEventListener(t,s,!1)}function Vi(e,t,s,i,n){var r=i;if(!(1&t||2&t||null===i))e:for(;;){if(null===i)return;var a=i.tag;if(3===a||4===a){var o=i.stateNode.containerInfo;if(o===n||8===o.nodeType&&o.parentNode===n)break;if(4===a)for(a=i.return;null!==a;){var l=a.tag;if((3===l||4===l)&&((l=a.stateNode.containerInfo)===n||8===l.nodeType&&l.parentNode===n))return;a=a.return}for(;null!==o;){if(null===(a=gn(o)))return;if(5===(l=a.tag)||6===l){i=r=a;continue e}o=o.parentNode}}i=i.return}Ae((function(){var i=r,n=be(s),a=[];e:{var o=Pi.get(e);if(void 0!==o){var l=os,h=e;switch(e){case"keypress":if(0===Zt(s))break e;case"keydown":case"keyup":l=Cs;break;case"focusin":h="focus",l=ps;break;case"focusout":h="blur",l=ps;break;case"beforeblur":case"afterblur":l=ps;break;case"click":if(2===s.button)break e;case"auxclick":case"dblclick":case"mousedown":case"mousemove":case"mouseup":case"mouseout":case"mouseover":case"contextmenu":l=ds;break;case"drag":case"dragend":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"dragstart":case"drop":l=us;break;case"touchcancel":case"touchend":case"touchmove":case"touchstart":l=Es;break;case Si:case Ci:case Ti:l=fs;break;case Ei:l=Ps;break;case"scroll":l=hs;break;case"wheel":l=As;break;case"copy":case"cut":case"paste":l=gs;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":case"pointerdown":case"pointermove":case"pointerout":case"pointerover":case"pointerup":l=Ts}var c=!!(4&t),d=!c&&"scroll"===e,u=c?null!==o?o+"Capture":null:o;c=[];for(var p,f=i;null!==f;){var m=(p=f).stateNode;if(5===p.tag&&null!==m&&(p=m,null!==u&&(null!=(m=Me(f,u))&&c.push(Gi(f,m,p)))),d)break;f=f.return}0<c.length&&(o=new l(o,h,null,s,n),a.push({event:o,listeners:c}))}}if(!(7&t)){if(l="mouseout"===e||"pointerout"===e,(!(o="mouseover"===e||"pointerover"===e)||s===ve||!(h=s.relatedTarget||s.fromElement)||!gn(h)&&!h[un])&&(l||o)&&(o=n.window===n?n:(o=n.ownerDocument)?o.defaultView||o.parentWindow:window,l?(l=i,null!==(h=(h=s.relatedTarget||s.toElement)?gn(h):null)&&(h!==(d=Ue(h))||5!==h.tag&&6!==h.tag)&&(h=null)):(l=null,h=i),l!==h)){if(c=ds,m="onMouseLeave",u="onMouseEnter",f="mouse","pointerout"!==e&&"pointerover"!==e||(c=Ts,m="onPointerLeave",u="onPointerEnter",f="pointer"),d=null==l?o:vn(l),p=null==h?o:vn(h),(o=new c(m,f+"leave",l,s,n)).target=d,o.relatedTarget=p,m=null,gn(n)===i&&((c=new c(u,f+"enter",h,s,n)).target=p,c.relatedTarget=d,m=c),d=m,l&&h)e:{for(u=h,f=0,p=c=l;p;p=ji(p))f++;for(p=0,m=u;m;m=ji(m))p++;for(;0<f-p;)c=ji(c),f--;for(;0<p-f;)u=ji(u),p--;for(;f--;){if(c===u||null!==u&&c===u.alternate)break e;c=ji(c),u=ji(u)}c=null}else c=null;null!==l&&Wi(a,o,l,c,!1),null!==h&&null!==d&&Wi(a,d,h,c,!0)}if("select"===(l=(o=i?vn(i):window).nodeName&&o.nodeName.toLowerCase())||"input"===l&&"file"===o.type)var g=qs;else if(Vs(o))if(Xs)g=ii;else{g=ti;var _=ei}else(l=o.nodeName)&&"input"===l.toLowerCase()&&("checkbox"===o.type||"radio"===o.type)&&(g=si);switch(g&&(g=g(e,i))?Gs(a,g,s,n):(_&&_(e,o,i),"focusout"===e&&(_=o._wrapperState)&&_.controlled&&"number"===o.type&&J(o,"number",o.value)),_=i?vn(i):window,e){case"focusin":(Vs(_)||"true"===_.contentEditable)&&(pi=_,fi=i,mi=null);break;case"focusout":mi=fi=pi=null;break;case"mousedown":gi=!0;break;case"contextmenu":case"mouseup":case"dragend":gi=!1,_i(a,s,n);break;case"selectionchange":if(ui)break;case"keydown":case"keyup":_i(a,s,n)}var v;if(Ds)e:{switch(e){case"compositionstart":var b="onCompositionStart";break e;case"compositionend":b="onCompositionEnd";break e;case"compositionupdate":b="onCompositionUpdate";break e}b=void 0}else Ns?Bs(e,s)&&(b="onCompositionEnd"):"keydown"===e&&229===s.keyCode&&(b="onCompositionStart");b&&(Is&&"ko"!==s.locale&&(Ns||"onCompositionStart"!==b?"onCompositionEnd"===b&&Ns&&(v=Jt()):(Yt="value"in(Kt=n)?Kt.value:Kt.textContent,Ns=!0)),0<(_=Hi(i,b)).length&&(b=new _s(b,e,null,s,n),a.push({event:b,listeners:_}),v?b.data=v:null!==(v=zs(s))&&(b.data=v))),(v=Ls?function(e,t){switch(e){case"compositionend":return zs(t);case"keypress":return 32!==t.which?null:(Os=!0,Fs);case"textInput":return(e=t.data)===Fs&&Os?null:e;default:return null}}(e,s):function(e,t){if(Ns)return"compositionend"===e||!Ds&&Bs(e,t)?(e=Jt(),Qt=Yt=Kt=null,Ns=!1,e):null;switch(e){case"paste":default:return null;case"keypress":if(!(t.ctrlKey||t.altKey||t.metaKey)||t.ctrlKey&&t.altKey){if(t.char&&1<t.char.length)return t.char;if(t.which)return String.fromCharCode(t.which)}return null;case"compositionend":return Is&&"ko"!==t.locale?null:t.data}}(e,s))&&(0<(i=Hi(i,"onBeforeInput")).length&&(n=new _s("onBeforeInput","beforeinput",null,s,n),a.push({event:n,listeners:i}),n.data=v))}Fi(a,t)}))}function Gi(e,t,s){return{instance:e,listener:t,currentTarget:s}}function Hi(e,t){for(var s=t+"Capture",i=[];null!==e;){var n=e,r=n.stateNode;5===n.tag&&null!==r&&(n=r,null!=(r=Me(e,s))&&i.unshift(Gi(e,r,n)),null!=(r=Me(e,t))&&i.push(Gi(e,r,n))),e=e.return}return i}function ji(e){if(null===e)return null;do{e=e.return}while(e&&5!==e.tag);return e||null}function Wi(e,t,s,i,n){for(var r=t._reactName,a=[];null!==s&&s!==i;){var o=s,l=o.alternate,h=o.stateNode;if(null!==l&&l===i)break;5===o.tag&&null!==h&&(o=h,n?null!=(l=Me(s,r))&&a.unshift(Gi(s,l,o)):n||null!=(l=Me(s,r))&&a.push(Gi(s,l,o))),s=s.return}0!==a.length&&e.push({event:t,listeners:a})}var $i=/\r\n?/g,qi=/\u0000|\uFFFD/g;function Xi(e){return("string"==typeof e?e:""+e).replace($i,"\n").replace(qi,"")}function Ki(e,t,i){if(t=Xi(t),Xi(e)!==t&&i)throw Error(s(425))}function Yi(){}var Qi=null,Ji=null;function Zi(e,t){return"textarea"===e||"noscript"===e||"string"==typeof t.children||"number"==typeof t.children||"object"==typeof t.dangerouslySetInnerHTML&&null!==t.dangerouslySetInnerHTML&&null!=t.dangerouslySetInnerHTML.__html}var en="function"==typeof setTimeout?setTimeout:void 0,tn="function"==typeof clearTimeout?clearTimeout:void 0,sn="function"==typeof Promise?Promise:void 0,nn="function"==typeof queueMicrotask?queueMicrotask:void 0!==sn?function(e){return sn.resolve(null).then(e).catch(rn)}:en;function rn(e){setTimeout((function(){throw e}))}function an(e,t){var s=t,i=0;do{var n=s.nextSibling;if(e.removeChild(s),n&&8===n.nodeType)if("/$"===(s=n.data)){if(0===i)return e.removeChild(n),void Ut(t);i--}else"$"!==s&&"$?"!==s&&"$!"!==s||i++;s=n}while(s);Ut(t)}function on(e){for(;null!=e;e=e.nextSibling){var t=e.nodeType;if(1===t||3===t)break;if(8===t){if("$"===(t=e.data)||"$!"===t||"$?"===t)break;if("/$"===t)return null}}return e}function ln(e){e=e.previousSibling;for(var t=0;e;){if(8===e.nodeType){var s=e.data;if("$"===s||"$!"===s||"$?"===s){if(0===t)return e;t--}else"/$"===s&&t++}e=e.previousSibling}return null}var hn=Math.random().toString(36).slice(2),cn="__reactFiber$"+hn,dn="__reactProps$"+hn,un="__reactContainer$"+hn,pn="__reactEvents$"+hn,fn="__reactListeners$"+hn,mn="__reactHandles$"+hn;function gn(e){var t=e[cn];if(t)return t;for(var s=e.parentNode;s;){if(t=s[un]||s[cn]){if(s=t.alternate,null!==t.child||null!==s&&null!==s.child)for(e=ln(e);null!==e;){if(s=e[cn])return s;e=ln(e)}return t}s=(e=s).parentNode}return null}function _n(e){return!(e=e[cn]||e[un])||5!==e.tag&&6!==e.tag&&13!==e.tag&&3!==e.tag?null:e}function vn(e){if(5===e.tag||6===e.tag)return e.stateNode;throw Error(s(33))}function bn(e){return e[dn]||null}var yn=[],xn=-1;function wn(e){return{current:e}}function Sn(e){0>xn||(e.current=yn[xn],yn[xn]=null,xn--)}function Cn(e,t){xn++,yn[xn]=e.current,e.current=t}var Tn={},En=wn(Tn),Pn=wn(!1),kn=Tn;function An(e,t){var s=e.type.contextTypes;if(!s)return Tn;var i=e.stateNode;if(i&&i.__reactInternalMemoizedUnmaskedChildContext===t)return i.__reactInternalMemoizedMaskedChildContext;var n,r={};for(n in s)r[n]=t[n];return i&&((e=e.stateNode).__reactInternalMemoizedUnmaskedChildContext=t,e.__reactInternalMemoizedMaskedChildContext=r),r}function Mn(e){return null!=(e=e.childContextTypes)}function Dn(){Sn(Pn),Sn(En)}function Rn(e,t,i){if(En.current!==Tn)throw Error(s(168));Cn(En,t),Cn(Pn,i)}function Ln(e,t,i){var n=e.stateNode;if(t=t.childContextTypes,"function"!=typeof n.getChildContext)return i;for(var r in n=n.getChildContext())if(!(r in t))throw Error(s(108,V(e)||"Unknown",r));return F({},i,n)}function In(e){return e=(e=e.stateNode)&&e.__reactInternalMemoizedMergedChildContext||Tn,kn=En.current,Cn(En,e),Cn(Pn,Pn.current),!0}function Fn(e,t,i){var n=e.stateNode;if(!n)throw Error(s(169));i?(e=Ln(e,t,kn),n.__reactInternalMemoizedMergedChildContext=e,Sn(Pn),Sn(En),Cn(En,e)):Sn(Pn),Cn(Pn,i)}var On=null,Bn=!1,zn=!1;function Nn(e){null===On?On=[e]:On.push(e)}function Un(){if(!zn&&null!==On){zn=!0;var e=0,t=_t;try{var s=On;for(_t=1;e<s.length;e++){var i=s[e];do{i=i(!0)}while(null!==i)}On=null,Bn=!1}catch(t){throw null!==On&&(On=On.slice(e+1)),We(Qe,Un),t}finally{_t=t,zn=!1}}return null}var Vn=[],Gn=0,Hn=null,jn=0,Wn=[],$n=0,qn=null,Xn=1,Kn="";function Yn(e,t){Vn[Gn++]=jn,Vn[Gn++]=Hn,Hn=e,jn=t}function Qn(e,t,s){Wn[$n++]=Xn,Wn[$n++]=Kn,Wn[$n++]=qn,qn=e;var i=Xn;e=Kn;var n=32-nt(i)-1;i&=~(1<<n),s+=1;var r=32-nt(t)+n;if(30<r){var a=n-n%5;r=(i&(1<<a)-1).toString(32),i>>=a,n-=a,Xn=1<<32-nt(t)+n|s<<n|i,Kn=r+e}else Xn=1<<r|s<<n|i,Kn=e}function Jn(e){null!==e.return&&(Yn(e,1),Qn(e,1,0))}function Zn(e){for(;e===Hn;)Hn=Vn[--Gn],Vn[Gn]=null,jn=Vn[--Gn],Vn[Gn]=null;for(;e===qn;)qn=Wn[--$n],Wn[$n]=null,Kn=Wn[--$n],Wn[$n]=null,Xn=Wn[--$n],Wn[$n]=null}var er=null,tr=null,sr=!1,ir=null;function nr(e,t){var s=Ah(5,null,null,0);s.elementType="DELETED",s.stateNode=t,s.return=e,null===(t=e.deletions)?(e.deletions=[s],e.flags|=16):t.push(s)}function rr(e,t){switch(e.tag){case 5:var s=e.type;return null!==(t=1!==t.nodeType||s.toLowerCase()!==t.nodeName.toLowerCase()?null:t)&&(e.stateNode=t,er=e,tr=on(t.firstChild),!0);case 6:return null!==(t=""===e.pendingProps||3!==t.nodeType?null:t)&&(e.stateNode=t,er=e,tr=null,!0);case 13:return null!==(t=8!==t.nodeType?null:t)&&(s=null!==qn?{id:Xn,overflow:Kn}:null,e.memoizedState={dehydrated:t,treeContext:s,retryLane:1073741824},(s=Ah(18,null,null,0)).stateNode=t,s.return=e,e.child=s,er=e,tr=null,!0);default:return!1}}function ar(e){return!(!(1&e.mode)||128&e.flags)}function or(e){if(sr){var t=tr;if(t){var i=t;if(!rr(e,t)){if(ar(e))throw Error(s(418));t=on(i.nextSibling);var n=er;t&&rr(e,t)?nr(n,i):(e.flags=-4097&e.flags|2,sr=!1,er=e)}}else{if(ar(e))throw Error(s(418));e.flags=-4097&e.flags|2,sr=!1,er=e}}}function lr(e){for(e=e.return;null!==e&&5!==e.tag&&3!==e.tag&&13!==e.tag;)e=e.return;er=e}function hr(e){if(e!==er)return!1;if(!sr)return lr(e),sr=!0,!1;var t;if((t=3!==e.tag)&&!(t=5!==e.tag)&&(t="head"!==(t=e.type)&&"body"!==t&&!Zi(e.type,e.memoizedProps)),t&&(t=tr)){if(ar(e))throw cr(),Error(s(418));for(;t;)nr(e,t),t=on(t.nextSibling)}if(lr(e),13===e.tag){if(!(e=null!==(e=e.memoizedState)?e.dehydrated:null))throw Error(s(317));e:{for(e=e.nextSibling,t=0;e;){if(8===e.nodeType){var i=e.data;if("/$"===i){if(0===t){tr=on(e.nextSibling);break e}t--}else"$"!==i&&"$!"!==i&&"$?"!==i||t++}e=e.nextSibling}tr=null}}else tr=er?on(e.stateNode.nextSibling):null;return!0}function cr(){for(var e=tr;e;)e=on(e.nextSibling)}function dr(){tr=er=null,sr=!1}function ur(e){null===ir?ir=[e]:ir.push(e)}var pr=v.ReactCurrentBatchConfig;function fr(e,t,i){if(null!==(e=i.ref)&&"function"!=typeof e&&"object"!=typeof e){if(i._owner){if(i=i._owner){if(1!==i.tag)throw Error(s(309));var n=i.stateNode}if(!n)throw Error(s(147,e));var r=n,a=""+e;return null!==t&&null!==t.ref&&"function"==typeof t.ref&&t.ref._stringRef===a?t.ref:(t=function(e){var t=r.refs;null===e?delete t[a]:t[a]=e},t._stringRef=a,t)}if("string"!=typeof e)throw Error(s(284));if(!i._owner)throw Error(s(290,e))}return e}function mr(e,t){throw e=Object.prototype.toString.call(t),Error(s(31,"[object Object]"===e?"object with keys {"+Object.keys(t).join(", ")+"}":e))}function gr(e){return(0,e._init)(e._payload)}function _r(e){function t(t,s){if(e){var i=t.deletions;null===i?(t.deletions=[s],t.flags|=16):i.push(s)}}function i(s,i){if(!e)return null;for(;null!==i;)t(s,i),i=i.sibling;return null}function n(e,t){for(e=new Map;null!==t;)null!==t.key?e.set(t.key,t):e.set(t.index,t),t=t.sibling;return e}function r(e,t){return(e=Dh(e,t)).index=0,e.sibling=null,e}function a(t,s,i){return t.index=i,e?null!==(i=t.alternate)?(i=i.index)<s?(t.flags|=2,s):i:(t.flags|=2,s):(t.flags|=1048576,s)}function o(t){return e&&null===t.alternate&&(t.flags|=2),t}function l(e,t,s,i){return null===t||6!==t.tag?((t=Fh(s,e.mode,i)).return=e,t):((t=r(t,s)).return=e,t)}function h(e,t,s,i){var n=s.type;return n===x?d(e,t,s.props.children,i,s.key):null!==t&&(t.elementType===n||"object"==typeof n&&null!==n&&n.$$typeof===M&&gr(n)===t.type)?((i=r(t,s.props)).ref=fr(e,t,s),i.return=e,i):((i=Rh(s.type,s.key,s.props,null,e.mode,i)).ref=fr(e,t,s),i.return=e,i)}function c(e,t,s,i){return null===t||4!==t.tag||t.stateNode.containerInfo!==s.containerInfo||t.stateNode.implementation!==s.implementation?((t=Oh(s,e.mode,i)).return=e,t):((t=r(t,s.children||[])).return=e,t)}function d(e,t,s,i,n){return null===t||7!==t.tag?((t=Lh(s,e.mode,i,n)).return=e,t):((t=r(t,s)).return=e,t)}function u(e,t,s){if("string"==typeof t&&""!==t||"number"==typeof t)return(t=Fh(""+t,e.mode,s)).return=e,t;if("object"==typeof t&&null!==t){switch(t.$$typeof){case b:return(s=Rh(t.type,t.key,t.props,null,e.mode,s)).ref=fr(e,null,t),s.return=e,s;case y:return(t=Oh(t,e.mode,s)).return=e,t;case M:return u(e,(0,t._init)(t._payload),s)}if(Z(t)||L(t))return(t=Lh(t,e.mode,s,null)).return=e,t;mr(e,t)}return null}function p(e,t,s,i){var n=null!==t?t.key:null;if("string"==typeof s&&""!==s||"number"==typeof s)return null!==n?null:l(e,t,""+s,i);if("object"==typeof s&&null!==s){switch(s.$$typeof){case b:return s.key===n?h(e,t,s,i):null;case y:return s.key===n?c(e,t,s,i):null;case M:return p(e,t,(n=s._init)(s._payload),i)}if(Z(s)||L(s))return null!==n?null:d(e,t,s,i,null);mr(e,s)}return null}function f(e,t,s,i,n){if("string"==typeof i&&""!==i||"number"==typeof i)return l(t,e=e.get(s)||null,""+i,n);if("object"==typeof i&&null!==i){switch(i.$$typeof){case b:return h(t,e=e.get(null===i.key?s:i.key)||null,i,n);case y:return c(t,e=e.get(null===i.key?s:i.key)||null,i,n);case M:return f(e,t,s,(0,i._init)(i._payload),n)}if(Z(i)||L(i))return d(t,e=e.get(s)||null,i,n,null);mr(t,i)}return null}function m(s,r,o,l){for(var h=null,c=null,d=r,m=r=0,g=null;null!==d&&m<o.length;m++){d.index>m?(g=d,d=null):g=d.sibling;var _=p(s,d,o[m],l);if(null===_){null===d&&(d=g);break}e&&d&&null===_.alternate&&t(s,d),r=a(_,r,m),null===c?h=_:c.sibling=_,c=_,d=g}if(m===o.length)return i(s,d),sr&&Yn(s,m),h;if(null===d){for(;m<o.length;m++)null!==(d=u(s,o[m],l))&&(r=a(d,r,m),null===c?h=d:c.sibling=d,c=d);return sr&&Yn(s,m),h}for(d=n(s,d);m<o.length;m++)null!==(g=f(d,s,m,o[m],l))&&(e&&null!==g.alternate&&d.delete(null===g.key?m:g.key),r=a(g,r,m),null===c?h=g:c.sibling=g,c=g);return e&&d.forEach((function(e){return t(s,e)})),sr&&Yn(s,m),h}function g(r,o,l,h){var c=L(l);if("function"!=typeof c)throw Error(s(150));if(null==(l=c.call(l)))throw Error(s(151));for(var d=c=null,m=o,g=o=0,_=null,v=l.next();null!==m&&!v.done;g++,v=l.next()){m.index>g?(_=m,m=null):_=m.sibling;var b=p(r,m,v.value,h);if(null===b){null===m&&(m=_);break}e&&m&&null===b.alternate&&t(r,m),o=a(b,o,g),null===d?c=b:d.sibling=b,d=b,m=_}if(v.done)return i(r,m),sr&&Yn(r,g),c;if(null===m){for(;!v.done;g++,v=l.next())null!==(v=u(r,v.value,h))&&(o=a(v,o,g),null===d?c=v:d.sibling=v,d=v);return sr&&Yn(r,g),c}for(m=n(r,m);!v.done;g++,v=l.next())null!==(v=f(m,r,g,v.value,h))&&(e&&null!==v.alternate&&m.delete(null===v.key?g:v.key),o=a(v,o,g),null===d?c=v:d.sibling=v,d=v);return e&&m.forEach((function(e){return t(r,e)})),sr&&Yn(r,g),c}return function e(s,n,a,l){if("object"==typeof a&&null!==a&&a.type===x&&null===a.key&&(a=a.props.children),"object"==typeof a&&null!==a){switch(a.$$typeof){case b:e:{for(var h=a.key,c=n;null!==c;){if(c.key===h){if((h=a.type)===x){if(7===c.tag){i(s,c.sibling),(n=r(c,a.props.children)).return=s,s=n;break e}}else if(c.elementType===h||"object"==typeof h&&null!==h&&h.$$typeof===M&&gr(h)===c.type){i(s,c.sibling),(n=r(c,a.props)).ref=fr(s,c,a),n.return=s,s=n;break e}i(s,c);break}t(s,c),c=c.sibling}a.type===x?((n=Lh(a.props.children,s.mode,l,a.key)).return=s,s=n):((l=Rh(a.type,a.key,a.props,null,s.mode,l)).ref=fr(s,n,a),l.return=s,s=l)}return o(s);case y:e:{for(c=a.key;null!==n;){if(n.key===c){if(4===n.tag&&n.stateNode.containerInfo===a.containerInfo&&n.stateNode.implementation===a.implementation){i(s,n.sibling),(n=r(n,a.children||[])).return=s,s=n;break e}i(s,n);break}t(s,n),n=n.sibling}(n=Oh(a,s.mode,l)).return=s,s=n}return o(s);case M:return e(s,n,(c=a._init)(a._payload),l)}if(Z(a))return m(s,n,a,l);if(L(a))return g(s,n,a,l);mr(s,a)}return"string"==typeof a&&""!==a||"number"==typeof a?(a=""+a,null!==n&&6===n.tag?(i(s,n.sibling),(n=r(n,a)).return=s,s=n):(i(s,n),(n=Fh(a,s.mode,l)).return=s,s=n),o(s)):i(s,n)}}var vr=_r(!0),br=_r(!1),yr=wn(null),xr=null,wr=null,Sr=null;function Cr(){Sr=wr=xr=null}function Tr(e){var t=yr.current;Sn(yr),e._currentValue=t}function Er(e,t,s){for(;null!==e;){var i=e.alternate;if((e.childLanes&t)!==t?(e.childLanes|=t,null!==i&&(i.childLanes|=t)):null!==i&&(i.childLanes&t)!==t&&(i.childLanes|=t),e===s)break;e=e.return}}function Pr(e,t){xr=e,Sr=wr=null,null!==(e=e.dependencies)&&null!==e.firstContext&&(!!(e.lanes&t)&&(_o=!0),e.firstContext=null)}function kr(e){var t=e._currentValue;if(Sr!==e)if(e={context:e,memoizedValue:t,next:null},null===wr){if(null===xr)throw Error(s(308));wr=e,xr.dependencies={lanes:0,firstContext:e}}else wr=wr.next=e;return t}var Ar=null;function Mr(e){null===Ar?Ar=[e]:Ar.push(e)}function Dr(e,t,s,i){var n=t.interleaved;return null===n?(s.next=s,Mr(t)):(s.next=n.next,n.next=s),t.interleaved=s,Rr(e,i)}function Rr(e,t){e.lanes|=t;var s=e.alternate;for(null!==s&&(s.lanes|=t),s=e,e=e.return;null!==e;)e.childLanes|=t,null!==(s=e.alternate)&&(s.childLanes|=t),s=e,e=e.return;return 3===s.tag?s.stateNode:null}var Lr=!1;function Ir(e){e.updateQueue={baseState:e.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null,interleaved:null,lanes:0},effects:null}}function Fr(e,t){e=e.updateQueue,t.updateQueue===e&&(t.updateQueue={baseState:e.baseState,firstBaseUpdate:e.firstBaseUpdate,lastBaseUpdate:e.lastBaseUpdate,shared:e.shared,effects:e.effects})}function Or(e,t){return{eventTime:e,lane:t,tag:0,payload:null,callback:null,next:null}}function Br(e,t,s){var i=e.updateQueue;if(null===i)return null;if(i=i.shared,2&El){var n=i.pending;return null===n?t.next=t:(t.next=n.next,n.next=t),i.pending=t,Rr(e,s)}return null===(n=i.interleaved)?(t.next=t,Mr(i)):(t.next=n.next,n.next=t),i.interleaved=t,Rr(e,s)}function zr(e,t,s){if(null!==(t=t.updateQueue)&&(t=t.shared,4194240&s)){var i=t.lanes;s|=i&=e.pendingLanes,t.lanes=s,gt(e,s)}}function Nr(e,t){var s=e.updateQueue,i=e.alternate;if(null!==i&&s===(i=i.updateQueue)){var n=null,r=null;if(null!==(s=s.firstBaseUpdate)){do{var a={eventTime:s.eventTime,lane:s.lane,tag:s.tag,payload:s.payload,callback:s.callback,next:null};null===r?n=r=a:r=r.next=a,s=s.next}while(null!==s);null===r?n=r=t:r=r.next=t}else n=r=t;return s={baseState:i.baseState,firstBaseUpdate:n,lastBaseUpdate:r,shared:i.shared,effects:i.effects},void(e.updateQueue=s)}null===(e=s.lastBaseUpdate)?s.firstBaseUpdate=t:e.next=t,s.lastBaseUpdate=t}function Ur(e,t,s,i){var n=e.updateQueue;Lr=!1;var r=n.firstBaseUpdate,a=n.lastBaseUpdate,o=n.shared.pending;if(null!==o){n.shared.pending=null;var l=o,h=l.next;l.next=null,null===a?r=h:a.next=h,a=l;var c=e.alternate;null!==c&&((o=(c=c.updateQueue).lastBaseUpdate)!==a&&(null===o?c.firstBaseUpdate=h:o.next=h,c.lastBaseUpdate=l))}if(null!==r){var d=n.baseState;for(a=0,c=h=l=null,o=r;;){var u=o.lane,p=o.eventTime;if((i&u)===u){null!==c&&(c=c.next={eventTime:p,lane:0,tag:o.tag,payload:o.payload,callback:o.callback,next:null});e:{var f=e,m=o;switch(u=t,p=s,m.tag){case 1:if("function"==typeof(f=m.payload)){d=f.call(p,d,u);break e}d=f;break e;case 3:f.flags=-65537&f.flags|128;case 0:if(null==(u="function"==typeof(f=m.payload)?f.call(p,d,u):f))break e;d=F({},d,u);break e;case 2:Lr=!0}}null!==o.callback&&0!==o.lane&&(e.flags|=64,null===(u=n.effects)?n.effects=[o]:u.push(o))}else p={eventTime:p,lane:u,tag:o.tag,payload:o.payload,callback:o.callback,next:null},null===c?(h=c=p,l=d):c=c.next=p,a|=u;if(null===(o=o.next)){if(null===(o=n.shared.pending))break;o=(u=o).next,u.next=null,n.lastBaseUpdate=u,n.shared.pending=null}}if(null===c&&(l=d),n.baseState=l,n.firstBaseUpdate=h,n.lastBaseUpdate=c,null!==(t=n.shared.interleaved)){n=t;do{a|=n.lane,n=n.next}while(n!==t)}else null===r&&(n.shared.lanes=0);Il|=a,e.lanes=a,e.memoizedState=d}}function Vr(e,t,i){if(e=t.effects,t.effects=null,null!==e)for(t=0;t<e.length;t++){var n=e[t],r=n.callback;if(null!==r){if(n.callback=null,n=i,"function"!=typeof r)throw Error(s(191,r));r.call(n)}}}var Gr={},Hr=wn(Gr),jr=wn(Gr),Wr=wn(Gr);function $r(e){if(e===Gr)throw Error(s(174));return e}function qr(e,t){switch(Cn(Wr,t),Cn(jr,e),Cn(Hr,Gr),e=t.nodeType){case 9:case 11:t=(t=t.documentElement)?t.namespaceURI:ae(null,"");break;default:t=ae(t=(e=8===e?t.parentNode:t).namespaceURI||null,e=e.tagName)}Sn(Hr),Cn(Hr,t)}function Xr(){Sn(Hr),Sn(jr),Sn(Wr)}function Kr(e){$r(Wr.current);var t=$r(Hr.current),s=ae(t,e.type);t!==s&&(Cn(jr,e),Cn(Hr,s))}function Yr(e){jr.current===e&&(Sn(Hr),Sn(jr))}var Qr=wn(0);function Jr(e){for(var t=e;null!==t;){if(13===t.tag){var s=t.memoizedState;if(null!==s&&(null===(s=s.dehydrated)||"$?"===s.data||"$!"===s.data))return t}else if(19===t.tag&&void 0!==t.memoizedProps.revealOrder){if(128&t.flags)return t}else if(null!==t.child){t.child.return=t,t=t.child;continue}if(t===e)break;for(;null===t.sibling;){if(null===t.return||t.return===e)return null;t=t.return}t.sibling.return=t.return,t=t.sibling}return null}var Zr=[];function ea(){for(var e=0;e<Zr.length;e++)Zr[e]._workInProgressVersionPrimary=null;Zr.length=0}var ta=v.ReactCurrentDispatcher,sa=v.ReactCurrentBatchConfig,ia=0,na=null,ra=null,aa=null,oa=!1,la=!1,ha=0,ca=0;function da(){throw Error(s(321))}function ua(e,t){if(null===t)return!1;for(var s=0;s<t.length&&s<e.length;s++)if(!ni(e[s],t[s]))return!1;return!0}function pa(e,t,i,n,r,a){if(ia=a,na=t,t.memoizedState=null,t.updateQueue=null,t.lanes=0,ta.current=null===e||null===e.memoizedState?Ya:Qa,e=i(n,r),la){a=0;do{if(la=!1,ha=0,25<=a)throw Error(s(301));a+=1,aa=ra=null,t.updateQueue=null,ta.current=Ja,e=i(n,r)}while(la)}if(ta.current=Ka,t=null!==ra&&null!==ra.next,ia=0,aa=ra=na=null,oa=!1,t)throw Error(s(300));return e}function fa(){var e=0!==ha;return ha=0,e}function ma(){var e={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return null===aa?na.memoizedState=aa=e:aa=aa.next=e,aa}function ga(){if(null===ra){var e=na.alternate;e=null!==e?e.memoizedState:null}else e=ra.next;var t=null===aa?na.memoizedState:aa.next;if(null!==t)aa=t,ra=e;else{if(null===e)throw Error(s(310));e={memoizedState:(ra=e).memoizedState,baseState:ra.baseState,baseQueue:ra.baseQueue,queue:ra.queue,next:null},null===aa?na.memoizedState=aa=e:aa=aa.next=e}return aa}function _a(e,t){return"function"==typeof t?t(e):t}function va(e){var t=ga(),i=t.queue;if(null===i)throw Error(s(311));i.lastRenderedReducer=e;var n=ra,r=n.baseQueue,a=i.pending;if(null!==a){if(null!==r){var o=r.next;r.next=a.next,a.next=o}n.baseQueue=r=a,i.pending=null}if(null!==r){a=r.next,n=n.baseState;var l=o=null,h=null,c=a;do{var d=c.lane;if((ia&d)===d)null!==h&&(h=h.next={lane:0,action:c.action,hasEagerState:c.hasEagerState,eagerState:c.eagerState,next:null}),n=c.hasEagerState?c.eagerState:e(n,c.action);else{var u={lane:d,action:c.action,hasEagerState:c.hasEagerState,eagerState:c.eagerState,next:null};null===h?(l=h=u,o=n):h=h.next=u,na.lanes|=d,Il|=d}c=c.next}while(null!==c&&c!==a);null===h?o=n:h.next=l,ni(n,t.memoizedState)||(_o=!0),t.memoizedState=n,t.baseState=o,t.baseQueue=h,i.lastRenderedState=n}if(null!==(e=i.interleaved)){r=e;do{a=r.lane,na.lanes|=a,Il|=a,r=r.next}while(r!==e)}else null===r&&(i.lanes=0);return[t.memoizedState,i.dispatch]}function ba(e){var t=ga(),i=t.queue;if(null===i)throw Error(s(311));i.lastRenderedReducer=e;var n=i.dispatch,r=i.pending,a=t.memoizedState;if(null!==r){i.pending=null;var o=r=r.next;do{a=e(a,o.action),o=o.next}while(o!==r);ni(a,t.memoizedState)||(_o=!0),t.memoizedState=a,null===t.baseQueue&&(t.baseState=a),i.lastRenderedState=a}return[a,n]}function ya(){}function xa(e,t){var i=na,n=ga(),r=t(),a=!ni(n.memoizedState,r);if(a&&(n.memoizedState=r,_o=!0),n=n.queue,La(Ca.bind(null,i,n,e),[e]),n.getSnapshot!==t||a||null!==aa&&1&aa.memoizedState.tag){if(i.flags|=2048,ka(9,Sa.bind(null,i,n,r,t),void 0,null),null===Pl)throw Error(s(349));30&ia||wa(i,t,r)}return r}function wa(e,t,s){e.flags|=16384,e={getSnapshot:t,value:s},null===(t=na.updateQueue)?(t={lastEffect:null,stores:null},na.updateQueue=t,t.stores=[e]):null===(s=t.stores)?t.stores=[e]:s.push(e)}function Sa(e,t,s,i){t.value=s,t.getSnapshot=i,Ta(t)&&Ea(e)}function Ca(e,t,s){return s((function(){Ta(t)&&Ea(e)}))}function Ta(e){var t=e.getSnapshot;e=e.value;try{var s=t();return!ni(e,s)}catch(e){return!0}}function Ea(e){var t=Rr(e,1);null!==t&&eh(t,e,1,-1)}function Pa(e){var t=ma();return"function"==typeof e&&(e=e()),t.memoizedState=t.baseState=e,e={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:_a,lastRenderedState:e},t.queue=e,e=e.dispatch=Wa.bind(null,na,e),[t.memoizedState,e]}function ka(e,t,s,i){return e={tag:e,create:t,destroy:s,deps:i,next:null},null===(t=na.updateQueue)?(t={lastEffect:null,stores:null},na.updateQueue=t,t.lastEffect=e.next=e):null===(s=t.lastEffect)?t.lastEffect=e.next=e:(i=s.next,s.next=e,e.next=i,t.lastEffect=e),e}function Aa(){return ga().memoizedState}function Ma(e,t,s,i){var n=ma();na.flags|=e,n.memoizedState=ka(1|t,s,void 0,void 0===i?null:i)}function Da(e,t,s,i){var n=ga();i=void 0===i?null:i;var r=void 0;if(null!==ra){var a=ra.memoizedState;if(r=a.destroy,null!==i&&ua(i,a.deps))return void(n.memoizedState=ka(t,s,r,i))}na.flags|=e,n.memoizedState=ka(1|t,s,r,i)}function Ra(e,t){return Ma(8390656,8,e,t)}function La(e,t){return Da(2048,8,e,t)}function Ia(e,t){return Da(4,2,e,t)}function Fa(e,t){return Da(4,4,e,t)}function Oa(e,t){return"function"==typeof t?(e=e(),t(e),function(){t(null)}):null!=t?(e=e(),t.current=e,function(){t.current=null}):void 0}function Ba(e,t,s){return s=null!=s?s.concat([e]):null,Da(4,4,Oa.bind(null,t,e),s)}function za(){}function Na(e,t){var s=ga();t=void 0===t?null:t;var i=s.memoizedState;return null!==i&&null!==t&&ua(t,i[1])?i[0]:(s.memoizedState=[e,t],e)}function Ua(e,t){var s=ga();t=void 0===t?null:t;var i=s.memoizedState;return null!==i&&null!==t&&ua(t,i[1])?i[0]:(e=e(),s.memoizedState=[e,t],e)}function Va(e,t,s){return 21&ia?(ni(s,t)||(s=pt(),na.lanes|=s,Il|=s,e.baseState=!0),t):(e.baseState&&(e.baseState=!1,_o=!0),e.memoizedState=s)}function Ga(e,t){var s=_t;_t=0!==s&&4>s?s:4,e(!0);var i=sa.transition;sa.transition={};try{e(!1),t()}finally{_t=s,sa.transition=i}}function Ha(){return ga().memoizedState}function ja(e,t,s){var i=Zl(e);if(s={lane:i,action:s,hasEagerState:!1,eagerState:null,next:null},$a(e))qa(t,s);else if(null!==(s=Dr(e,t,s,i))){eh(s,e,i,Jl()),Xa(s,t,i)}}function Wa(e,t,s){var i=Zl(e),n={lane:i,action:s,hasEagerState:!1,eagerState:null,next:null};if($a(e))qa(t,n);else{var r=e.alternate;if(0===e.lanes&&(null===r||0===r.lanes)&&null!==(r=t.lastRenderedReducer))try{var a=t.lastRenderedState,o=r(a,s);if(n.hasEagerState=!0,n.eagerState=o,ni(o,a)){var l=t.interleaved;return null===l?(n.next=n,Mr(t)):(n.next=l.next,l.next=n),void(t.interleaved=n)}}catch(e){}null!==(s=Dr(e,t,n,i))&&(eh(s,e,i,n=Jl()),Xa(s,t,i))}}function $a(e){var t=e.alternate;return e===na||null!==t&&t===na}function qa(e,t){la=oa=!0;var s=e.pending;null===s?t.next=t:(t.next=s.next,s.next=t),e.pending=t}function Xa(e,t,s){if(4194240&s){var i=t.lanes;s|=i&=e.pendingLanes,t.lanes=s,gt(e,s)}}var Ka={readContext:kr,useCallback:da,useContext:da,useEffect:da,useImperativeHandle:da,useInsertionEffect:da,useLayoutEffect:da,useMemo:da,useReducer:da,useRef:da,useState:da,useDebugValue:da,useDeferredValue:da,useTransition:da,useMutableSource:da,useSyncExternalStore:da,useId:da,unstable_isNewReconciler:!1},Ya={readContext:kr,useCallback:function(e,t){return ma().memoizedState=[e,void 0===t?null:t],e},useContext:kr,useEffect:Ra,useImperativeHandle:function(e,t,s){return s=null!=s?s.concat([e]):null,Ma(4194308,4,Oa.bind(null,t,e),s)},useLayoutEffect:function(e,t){return Ma(4194308,4,e,t)},useInsertionEffect:function(e,t){return Ma(4,2,e,t)},useMemo:function(e,t){var s=ma();return t=void 0===t?null:t,e=e(),s.memoizedState=[e,t],e},useReducer:function(e,t,s){var i=ma();return t=void 0!==s?s(t):t,i.memoizedState=i.baseState=t,e={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:e,lastRenderedState:t},i.queue=e,e=e.dispatch=ja.bind(null,na,e),[i.memoizedState,e]},useRef:function(e){return e={current:e},ma().memoizedState=e},useState:Pa,useDebugValue:za,useDeferredValue:function(e){return ma().memoizedState=e},useTransition:function(){var e=Pa(!1),t=e[0];return e=Ga.bind(null,e[1]),ma().memoizedState=e,[t,e]},useMutableSource:function(){},useSyncExternalStore:function(e,t,i){var n=na,r=ma();if(sr){if(void 0===i)throw Error(s(407));i=i()}else{if(i=t(),null===Pl)throw Error(s(349));30&ia||wa(n,t,i)}r.memoizedState=i;var a={value:i,getSnapshot:t};return r.queue=a,Ra(Ca.bind(null,n,a,e),[e]),n.flags|=2048,ka(9,Sa.bind(null,n,a,i,t),void 0,null),i},useId:function(){var e=ma(),t=Pl.identifierPrefix;if(sr){var s=Kn;t=":"+t+"R"+(s=(Xn&~(1<<32-nt(Xn)-1)).toString(32)+s),0<(s=ha++)&&(t+="H"+s.toString(32)),t+=":"}else t=":"+t+"r"+(s=ca++).toString(32)+":";return e.memoizedState=t},unstable_isNewReconciler:!1},Qa={readContext:kr,useCallback:Na,useContext:kr,useEffect:La,useImperativeHandle:Ba,useInsertionEffect:Ia,useLayoutEffect:Fa,useMemo:Ua,useReducer:va,useRef:Aa,useState:function(){return va(_a)},useDebugValue:za,useDeferredValue:function(e){return Va(ga(),ra.memoizedState,e)},useTransition:function(){return[va(_a)[0],ga().memoizedState]},useMutableSource:ya,useSyncExternalStore:xa,useId:Ha,unstable_isNewReconciler:!1},Ja={readContext:kr,useCallback:Na,useContext:kr,useEffect:La,useImperativeHandle:Ba,useInsertionEffect:Ia,useLayoutEffect:Fa,useMemo:Ua,useReducer:ba,useRef:Aa,useState:function(){return ba(_a)},useDebugValue:za,useDeferredValue:function(e){var t=ga();return null===ra?t.memoizedState=e:Va(t,ra.memoizedState,e)},useTransition:function(){return[ba(_a)[0],ga().memoizedState]},useMutableSource:ya,useSyncExternalStore:xa,useId:Ha,unstable_isNewReconciler:!1};function Za(e,t){if(e&&e.defaultProps){for(var s in t=F({},t),e=e.defaultProps)void 0===t[s]&&(t[s]=e[s]);return t}return t}function eo(e,t,s,i){s=null==(s=s(i,t=e.memoizedState))?t:F({},t,s),e.memoizedState=s,0===e.lanes&&(e.updateQueue.baseState=s)}var to={isMounted:function(e){return!!(e=e._reactInternals)&&Ue(e)===e},enqueueSetState:function(e,t,s){e=e._reactInternals;var i=Jl(),n=Zl(e),r=Or(i,n);r.payload=t,null!=s&&(r.callback=s),null!==(t=Br(e,r,n))&&(eh(t,e,n,i),zr(t,e,n))},enqueueReplaceState:function(e,t,s){e=e._reactInternals;var i=Jl(),n=Zl(e),r=Or(i,n);r.tag=1,r.payload=t,null!=s&&(r.callback=s),null!==(t=Br(e,r,n))&&(eh(t,e,n,i),zr(t,e,n))},enqueueForceUpdate:function(e,t){e=e._reactInternals;var s=Jl(),i=Zl(e),n=Or(s,i);n.tag=2,null!=t&&(n.callback=t),null!==(t=Br(e,n,i))&&(eh(t,e,i,s),zr(t,e,i))}};function so(e,t,s,i,n,r,a){return"function"==typeof(e=e.stateNode).shouldComponentUpdate?e.shouldComponentUpdate(i,r,a):!t.prototype||!t.prototype.isPureReactComponent||(!ri(s,i)||!ri(n,r))}function io(e,t,s){var i=!1,n=Tn,r=t.contextType;return"object"==typeof r&&null!==r?r=kr(r):(n=Mn(t)?kn:En.current,r=(i=null!=(i=t.contextTypes))?An(e,n):Tn),t=new t(s,r),e.memoizedState=null!==t.state&&void 0!==t.state?t.state:null,t.updater=to,e.stateNode=t,t._reactInternals=e,i&&((e=e.stateNode).__reactInternalMemoizedUnmaskedChildContext=n,e.__reactInternalMemoizedMaskedChildContext=r),t}function no(e,t,s,i){e=t.state,"function"==typeof t.componentWillReceiveProps&&t.componentWillReceiveProps(s,i),"function"==typeof t.UNSAFE_componentWillReceiveProps&&t.UNSAFE_componentWillReceiveProps(s,i),t.state!==e&&to.enqueueReplaceState(t,t.state,null)}function ro(e,t,s,i){var n=e.stateNode;n.props=s,n.state=e.memoizedState,n.refs={},Ir(e);var r=t.contextType;"object"==typeof r&&null!==r?n.context=kr(r):(r=Mn(t)?kn:En.current,n.context=An(e,r)),n.state=e.memoizedState,"function"==typeof(r=t.getDerivedStateFromProps)&&(eo(e,t,r,s),n.state=e.memoizedState),"function"==typeof t.getDerivedStateFromProps||"function"==typeof n.getSnapshotBeforeUpdate||"function"!=typeof n.UNSAFE_componentWillMount&&"function"!=typeof n.componentWillMount||(t=n.state,"function"==typeof n.componentWillMount&&n.componentWillMount(),"function"==typeof n.UNSAFE_componentWillMount&&n.UNSAFE_componentWillMount(),t!==n.state&&to.enqueueReplaceState(n,n.state,null),Ur(e,s,n,i),n.state=e.memoizedState),"function"==typeof n.componentDidMount&&(e.flags|=4194308)}function ao(e,t){try{var s="",i=t;do{s+=N(i),i=i.return}while(i);var n=s}catch(e){n="\nError generating stack: "+e.message+"\n"+e.stack}return{value:e,source:t,stack:n,digest:null}}function oo(e,t,s){return{value:e,source:null,stack:null!=s?s:null,digest:null!=t?t:null}}function lo(e,t){try{console.error(t.value)}catch(e){setTimeout((function(){throw e}))}}var ho="function"==typeof WeakMap?WeakMap:Map;function co(e,t,s){(s=Or(-1,s)).tag=3,s.payload={element:null};var i=t.value;return s.callback=function(){Gl||(Gl=!0,Hl=i),lo(0,t)},s}function uo(e,t,s){(s=Or(-1,s)).tag=3;var i=e.type.getDerivedStateFromError;if("function"==typeof i){var n=t.value;s.payload=function(){return i(n)},s.callback=function(){lo(0,t)}}var r=e.stateNode;return null!==r&&"function"==typeof r.componentDidCatch&&(s.callback=function(){lo(0,t),"function"!=typeof i&&(null===jl?jl=new Set([this]):jl.add(this));var e=t.stack;this.componentDidCatch(t.value,{componentStack:null!==e?e:""})}),s}function po(e,t,s){var i=e.pingCache;if(null===i){i=e.pingCache=new ho;var n=new Set;i.set(t,n)}else void 0===(n=i.get(t))&&(n=new Set,i.set(t,n));n.has(s)||(n.add(s),e=Sh.bind(null,e,t,s),t.then(e,e))}function fo(e){do{var t;if((t=13===e.tag)&&(t=null===(t=e.memoizedState)||null!==t.dehydrated),t)return e;e=e.return}while(null!==e);return null}function mo(e,t,s,i,n){return 1&e.mode?(e.flags|=65536,e.lanes=n,e):(e===t?e.flags|=65536:(e.flags|=128,s.flags|=131072,s.flags&=-52805,1===s.tag&&(null===s.alternate?s.tag=17:((t=Or(-1,1)).tag=2,Br(s,t,1))),s.lanes|=1),e)}var go=v.ReactCurrentOwner,_o=!1;function vo(e,t,s,i){t.child=null===e?br(t,null,s,i):vr(t,e.child,s,i)}function bo(e,t,s,i,n){s=s.render;var r=t.ref;return Pr(t,n),i=pa(e,t,s,i,r,n),s=fa(),null===e||_o?(sr&&s&&Jn(t),t.flags|=1,vo(e,t,i,n),t.child):(t.updateQueue=e.updateQueue,t.flags&=-2053,e.lanes&=~n,Go(e,t,n))}function yo(e,t,s,i,n){if(null===e){var r=s.type;return"function"!=typeof r||Mh(r)||void 0!==r.defaultProps||null!==s.compare||void 0!==s.defaultProps?((e=Rh(s.type,null,i,t,t.mode,n)).ref=t.ref,e.return=t,t.child=e):(t.tag=15,t.type=r,xo(e,t,r,i,n))}if(r=e.child,!(e.lanes&n)){var a=r.memoizedProps;if((s=null!==(s=s.compare)?s:ri)(a,i)&&e.ref===t.ref)return Go(e,t,n)}return t.flags|=1,(e=Dh(r,i)).ref=t.ref,e.return=t,t.child=e}function xo(e,t,s,i,n){if(null!==e){var r=e.memoizedProps;if(ri(r,i)&&e.ref===t.ref){if(_o=!1,t.pendingProps=i=r,!(e.lanes&n))return t.lanes=e.lanes,Go(e,t,n);131072&e.flags&&(_o=!0)}}return Co(e,t,s,i,n)}function wo(e,t,s){var i=t.pendingProps,n=i.children,r=null!==e?e.memoizedState:null;if("hidden"===i.mode)if(1&t.mode){if(!(1073741824&s))return e=null!==r?r.baseLanes|s:s,t.lanes=t.childLanes=1073741824,t.memoizedState={baseLanes:e,cachePool:null,transitions:null},t.updateQueue=null,Cn(Dl,Ml),Ml|=e,null;t.memoizedState={baseLanes:0,cachePool:null,transitions:null},i=null!==r?r.baseLanes:s,Cn(Dl,Ml),Ml|=i}else t.memoizedState={baseLanes:0,cachePool:null,transitions:null},Cn(Dl,Ml),Ml|=s;else null!==r?(i=r.baseLanes|s,t.memoizedState=null):i=s,Cn(Dl,Ml),Ml|=i;return vo(e,t,n,s),t.child}function So(e,t){var s=t.ref;(null===e&&null!==s||null!==e&&e.ref!==s)&&(t.flags|=512,t.flags|=2097152)}function Co(e,t,s,i,n){var r=Mn(s)?kn:En.current;return r=An(t,r),Pr(t,n),s=pa(e,t,s,i,r,n),i=fa(),null===e||_o?(sr&&i&&Jn(t),t.flags|=1,vo(e,t,s,n),t.child):(t.updateQueue=e.updateQueue,t.flags&=-2053,e.lanes&=~n,Go(e,t,n))}function To(e,t,s,i,n){if(Mn(s)){var r=!0;In(t)}else r=!1;if(Pr(t,n),null===t.stateNode)Vo(e,t),io(t,s,i),ro(t,s,i,n),i=!0;else if(null===e){var a=t.stateNode,o=t.memoizedProps;a.props=o;var l=a.context,h=s.contextType;"object"==typeof h&&null!==h?h=kr(h):h=An(t,h=Mn(s)?kn:En.current);var c=s.getDerivedStateFromProps,d="function"==typeof c||"function"==typeof a.getSnapshotBeforeUpdate;d||"function"!=typeof a.UNSAFE_componentWillReceiveProps&&"function"!=typeof a.componentWillReceiveProps||(o!==i||l!==h)&&no(t,a,i,h),Lr=!1;var u=t.memoizedState;a.state=u,Ur(t,i,a,n),l=t.memoizedState,o!==i||u!==l||Pn.current||Lr?("function"==typeof c&&(eo(t,s,c,i),l=t.memoizedState),(o=Lr||so(t,s,o,i,u,l,h))?(d||"function"!=typeof a.UNSAFE_componentWillMount&&"function"!=typeof a.componentWillMount||("function"==typeof a.componentWillMount&&a.componentWillMount(),"function"==typeof a.UNSAFE_componentWillMount&&a.UNSAFE_componentWillMount()),"function"==typeof a.componentDidMount&&(t.flags|=4194308)):("function"==typeof a.componentDidMount&&(t.flags|=4194308),t.memoizedProps=i,t.memoizedState=l),a.props=i,a.state=l,a.context=h,i=o):("function"==typeof a.componentDidMount&&(t.flags|=4194308),i=!1)}else{a=t.stateNode,Fr(e,t),o=t.memoizedProps,h=t.type===t.elementType?o:Za(t.type,o),a.props=h,d=t.pendingProps,u=a.context,"object"==typeof(l=s.contextType)&&null!==l?l=kr(l):l=An(t,l=Mn(s)?kn:En.current);var p=s.getDerivedStateFromProps;(c="function"==typeof p||"function"==typeof a.getSnapshotBeforeUpdate)||"function"!=typeof a.UNSAFE_componentWillReceiveProps&&"function"!=typeof a.componentWillReceiveProps||(o!==d||u!==l)&&no(t,a,i,l),Lr=!1,u=t.memoizedState,a.state=u,Ur(t,i,a,n);var f=t.memoizedState;o!==d||u!==f||Pn.current||Lr?("function"==typeof p&&(eo(t,s,p,i),f=t.memoizedState),(h=Lr||so(t,s,h,i,u,f,l)||!1)?(c||"function"!=typeof a.UNSAFE_componentWillUpdate&&"function"!=typeof a.componentWillUpdate||("function"==typeof a.componentWillUpdate&&a.componentWillUpdate(i,f,l),"function"==typeof a.UNSAFE_componentWillUpdate&&a.UNSAFE_componentWillUpdate(i,f,l)),"function"==typeof a.componentDidUpdate&&(t.flags|=4),"function"==typeof a.getSnapshotBeforeUpdate&&(t.flags|=1024)):("function"!=typeof a.componentDidUpdate||o===e.memoizedProps&&u===e.memoizedState||(t.flags|=4),"function"!=typeof a.getSnapshotBeforeUpdate||o===e.memoizedProps&&u===e.memoizedState||(t.flags|=1024),t.memoizedProps=i,t.memoizedState=f),a.props=i,a.state=f,a.context=l,i=h):("function"!=typeof a.componentDidUpdate||o===e.memoizedProps&&u===e.memoizedState||(t.flags|=4),"function"!=typeof a.getSnapshotBeforeUpdate||o===e.memoizedProps&&u===e.memoizedState||(t.flags|=1024),i=!1)}return Eo(e,t,s,i,r,n)}function Eo(e,t,s,i,n,r){So(e,t);var a=!!(128&t.flags);if(!i&&!a)return n&&Fn(t,s,!1),Go(e,t,r);i=t.stateNode,go.current=t;var o=a&&"function"!=typeof s.getDerivedStateFromError?null:i.render();return t.flags|=1,null!==e&&a?(t.child=vr(t,e.child,null,r),t.child=vr(t,null,o,r)):vo(e,t,o,r),t.memoizedState=i.state,n&&Fn(t,s,!0),t.child}function Po(e){var t=e.stateNode;t.pendingContext?Rn(0,t.pendingContext,t.pendingContext!==t.context):t.context&&Rn(0,t.context,!1),qr(e,t.containerInfo)}function ko(e,t,s,i,n){return dr(),ur(n),t.flags|=256,vo(e,t,s,i),t.child}var Ao,Mo,Do,Ro,Lo={dehydrated:null,treeContext:null,retryLane:0};function Io(e){return{baseLanes:e,cachePool:null,transitions:null}}function Fo(e,t,i){var n,r=t.pendingProps,a=Qr.current,o=!1,l=!!(128&t.flags);if((n=l)||(n=(null===e||null!==e.memoizedState)&&!!(2&a)),n?(o=!0,t.flags&=-129):null!==e&&null===e.memoizedState||(a|=1),Cn(Qr,1&a),null===e)return or(t),null!==(e=t.memoizedState)&&null!==(e=e.dehydrated)?(1&t.mode?"$!"===e.data?t.lanes=8:t.lanes=1073741824:t.lanes=1,null):(l=r.children,e=r.fallback,o?(r=t.mode,o=t.child,l={mode:"hidden",children:l},1&r||null===o?o=Ih(l,r,0,null):(o.childLanes=0,o.pendingProps=l),e=Lh(e,r,i,null),o.return=t,e.return=t,o.sibling=e,t.child=o,t.child.memoizedState=Io(i),t.memoizedState=Lo,e):Oo(t,l));if(null!==(a=e.memoizedState)&&null!==(n=a.dehydrated))return function(e,t,i,n,r,a,o){if(i)return 256&t.flags?(t.flags&=-257,Bo(e,t,o,n=oo(Error(s(422))))):null!==t.memoizedState?(t.child=e.child,t.flags|=128,null):(a=n.fallback,r=t.mode,n=Ih({mode:"visible",children:n.children},r,0,null),(a=Lh(a,r,o,null)).flags|=2,n.return=t,a.return=t,n.sibling=a,t.child=n,1&t.mode&&vr(t,e.child,null,o),t.child.memoizedState=Io(o),t.memoizedState=Lo,a);if(!(1&t.mode))return Bo(e,t,o,null);if("$!"===r.data){if(n=r.nextSibling&&r.nextSibling.dataset)var l=n.dgst;return n=l,Bo(e,t,o,n=oo(a=Error(s(419)),n,void 0))}if(l=!!(o&e.childLanes),_o||l){if(null!==(n=Pl)){switch(o&-o){case 4:r=2;break;case 16:r=8;break;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:r=32;break;case 536870912:r=268435456;break;default:r=0}0!==(r=r&(n.suspendedLanes|o)?0:r)&&r!==a.retryLane&&(a.retryLane=r,Rr(e,r),eh(n,e,r,-1))}return ph(),Bo(e,t,o,n=oo(Error(s(421))))}return"$?"===r.data?(t.flags|=128,t.child=e.child,t=Th.bind(null,e),r._reactRetry=t,null):(e=a.treeContext,tr=on(r.nextSibling),er=t,sr=!0,ir=null,null!==e&&(Wn[$n++]=Xn,Wn[$n++]=Kn,Wn[$n++]=qn,Xn=e.id,Kn=e.overflow,qn=t),t=Oo(t,n.children),t.flags|=4096,t)}(e,t,l,r,n,a,i);if(o){o=r.fallback,l=t.mode,n=(a=e.child).sibling;var h={mode:"hidden",children:r.children};return 1&l||t.child===a?(r=Dh(a,h)).subtreeFlags=14680064&a.subtreeFlags:((r=t.child).childLanes=0,r.pendingProps=h,t.deletions=null),null!==n?o=Dh(n,o):(o=Lh(o,l,i,null)).flags|=2,o.return=t,r.return=t,r.sibling=o,t.child=r,r=o,o=t.child,l=null===(l=e.child.memoizedState)?Io(i):{baseLanes:l.baseLanes|i,cachePool:null,transitions:l.transitions},o.memoizedState=l,o.childLanes=e.childLanes&~i,t.memoizedState=Lo,r}return e=(o=e.child).sibling,r=Dh(o,{mode:"visible",children:r.children}),!(1&t.mode)&&(r.lanes=i),r.return=t,r.sibling=null,null!==e&&(null===(i=t.deletions)?(t.deletions=[e],t.flags|=16):i.push(e)),t.child=r,t.memoizedState=null,r}function Oo(e,t){return(t=Ih({mode:"visible",children:t},e.mode,0,null)).return=e,e.child=t}function Bo(e,t,s,i){return null!==i&&ur(i),vr(t,e.child,null,s),(e=Oo(t,t.pendingProps.children)).flags|=2,t.memoizedState=null,e}function zo(e,t,s){e.lanes|=t;var i=e.alternate;null!==i&&(i.lanes|=t),Er(e.return,t,s)}function No(e,t,s,i,n){var r=e.memoizedState;null===r?e.memoizedState={isBackwards:t,rendering:null,renderingStartTime:0,last:i,tail:s,tailMode:n}:(r.isBackwards=t,r.rendering=null,r.renderingStartTime=0,r.last=i,r.tail=s,r.tailMode=n)}function Uo(e,t,s){var i=t.pendingProps,n=i.revealOrder,r=i.tail;if(vo(e,t,i.children,s),2&(i=Qr.current))i=1&i|2,t.flags|=128;else{if(null!==e&&128&e.flags)e:for(e=t.child;null!==e;){if(13===e.tag)null!==e.memoizedState&&zo(e,s,t);else if(19===e.tag)zo(e,s,t);else if(null!==e.child){e.child.return=e,e=e.child;continue}if(e===t)break e;for(;null===e.sibling;){if(null===e.return||e.return===t)break e;e=e.return}e.sibling.return=e.return,e=e.sibling}i&=1}if(Cn(Qr,i),1&t.mode)switch(n){case"forwards":for(s=t.child,n=null;null!==s;)null!==(e=s.alternate)&&null===Jr(e)&&(n=s),s=s.sibling;null===(s=n)?(n=t.child,t.child=null):(n=s.sibling,s.sibling=null),No(t,!1,n,s,r);break;case"backwards":for(s=null,n=t.child,t.child=null;null!==n;){if(null!==(e=n.alternate)&&null===Jr(e)){t.child=n;break}e=n.sibling,n.sibling=s,s=n,n=e}No(t,!0,s,null,r);break;case"together":No(t,!1,null,null,void 0);break;default:t.memoizedState=null}else t.memoizedState=null;return t.child}function Vo(e,t){!(1&t.mode)&&null!==e&&(e.alternate=null,t.alternate=null,t.flags|=2)}function Go(e,t,i){if(null!==e&&(t.dependencies=e.dependencies),Il|=t.lanes,!(i&t.childLanes))return null;if(null!==e&&t.child!==e.child)throw Error(s(153));if(null!==t.child){for(i=Dh(e=t.child,e.pendingProps),t.child=i,i.return=t;null!==e.sibling;)e=e.sibling,(i=i.sibling=Dh(e,e.pendingProps)).return=t;i.sibling=null}return t.child}function Ho(e,t){if(!sr)switch(e.tailMode){case"hidden":t=e.tail;for(var s=null;null!==t;)null!==t.alternate&&(s=t),t=t.sibling;null===s?e.tail=null:s.sibling=null;break;case"collapsed":s=e.tail;for(var i=null;null!==s;)null!==s.alternate&&(i=s),s=s.sibling;null===i?t||null===e.tail?e.tail=null:e.tail.sibling=null:i.sibling=null}}function jo(e){var t=null!==e.alternate&&e.alternate.child===e.child,s=0,i=0;if(t)for(var n=e.child;null!==n;)s|=n.lanes|n.childLanes,i|=14680064&n.subtreeFlags,i|=14680064&n.flags,n.return=e,n=n.sibling;else for(n=e.child;null!==n;)s|=n.lanes|n.childLanes,i|=n.subtreeFlags,i|=n.flags,n.return=e,n=n.sibling;return e.subtreeFlags|=i,e.childLanes=s,t}function Wo(e,t,i){var r=t.pendingProps;switch(Zn(t),t.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return jo(t),null;case 1:case 17:return Mn(t.type)&&Dn(),jo(t),null;case 3:return r=t.stateNode,Xr(),Sn(Pn),Sn(En),ea(),r.pendingContext&&(r.context=r.pendingContext,r.pendingContext=null),null!==e&&null!==e.child||(hr(t)?t.flags|=4:null===e||e.memoizedState.isDehydrated&&!(256&t.flags)||(t.flags|=1024,null!==ir&&(nh(ir),ir=null))),Mo(e,t),jo(t),null;case 5:Yr(t);var a=$r(Wr.current);if(i=t.type,null!==e&&null!=t.stateNode)Do(e,t,i,r,a),e.ref!==t.ref&&(t.flags|=512,t.flags|=2097152);else{if(!r){if(null===t.stateNode)throw Error(s(166));return jo(t),null}if(e=$r(Hr.current),hr(t)){r=t.stateNode,i=t.type;var o=t.memoizedProps;switch(r[cn]=t,r[dn]=o,e=!!(1&t.mode),i){case"dialog":Oi("cancel",r),Oi("close",r);break;case"iframe":case"object":case"embed":Oi("load",r);break;case"video":case"audio":for(a=0;a<Ri.length;a++)Oi(Ri[a],r);break;case"source":Oi("error",r);break;case"img":case"image":case"link":Oi("error",r),Oi("load",r);break;case"details":Oi("toggle",r);break;case"input":X(r,o),Oi("invalid",r);break;case"select":r._wrapperState={wasMultiple:!!o.multiple},Oi("invalid",r);break;case"textarea":se(r,o),Oi("invalid",r)}for(var l in ge(i,o),a=null,o)if(o.hasOwnProperty(l)){var h=o[l];"children"===l?"string"==typeof h?r.textContent!==h&&(!0!==o.suppressHydrationWarning&&Ki(r.textContent,h,e),a=["children",h]):"number"==typeof h&&r.textContent!==""+h&&(!0!==o.suppressHydrationWarning&&Ki(r.textContent,h,e),a=["children",""+h]):n.hasOwnProperty(l)&&null!=h&&"onScroll"===l&&Oi("scroll",r)}switch(i){case"input":j(r),Q(r,o,!0);break;case"textarea":j(r),ne(r);break;case"select":case"option":break;default:"function"==typeof o.onClick&&(r.onclick=Yi)}r=a,t.updateQueue=r,null!==r&&(t.flags|=4)}else{l=9===a.nodeType?a:a.ownerDocument,"http://www.w3.org/1999/xhtml"===e&&(e=re(i)),"http://www.w3.org/1999/xhtml"===e?"script"===i?((e=l.createElement("div")).innerHTML="<script><\/script>",e=e.removeChild(e.firstChild)):"string"==typeof r.is?e=l.createElement(i,{is:r.is}):(e=l.createElement(i),"select"===i&&(l=e,r.multiple?l.multiple=!0:r.size&&(l.size=r.size))):e=l.createElementNS(e,i),e[cn]=t,e[dn]=r,Ao(e,t,!1,!1),t.stateNode=e;e:{switch(l=_e(i,r),i){case"dialog":Oi("cancel",e),Oi("close",e),a=r;break;case"iframe":case"object":case"embed":Oi("load",e),a=r;break;case"video":case"audio":for(a=0;a<Ri.length;a++)Oi(Ri[a],e);a=r;break;case"source":Oi("error",e),a=r;break;case"img":case"image":case"link":Oi("error",e),Oi("load",e),a=r;break;case"details":Oi("toggle",e),a=r;break;case"input":X(e,r),a=q(e,r),Oi("invalid",e);break;case"option":default:a=r;break;case"select":e._wrapperState={wasMultiple:!!r.multiple},a=F({},r,{value:void 0}),Oi("invalid",e);break;case"textarea":se(e,r),a=te(e,r),Oi("invalid",e)}for(o in ge(i,a),h=a)if(h.hasOwnProperty(o)){var c=h[o];"style"===o?fe(e,c):"dangerouslySetInnerHTML"===o?null!=(c=c?c.__html:void 0)&&he(e,c):"children"===o?"string"==typeof c?("textarea"!==i||""!==c)&&ce(e,c):"number"==typeof c&&ce(e,""+c):"suppressContentEditableWarning"!==o&&"suppressHydrationWarning"!==o&&"autoFocus"!==o&&(n.hasOwnProperty(o)?null!=c&&"onScroll"===o&&Oi("scroll",e):null!=c&&_(e,o,c,l))}switch(i){case"input":j(e),Q(e,r,!1);break;case"textarea":j(e),ne(e);break;case"option":null!=r.value&&e.setAttribute("value",""+G(r.value));break;case"select":e.multiple=!!r.multiple,null!=(o=r.value)?ee(e,!!r.multiple,o,!1):null!=r.defaultValue&&ee(e,!!r.multiple,r.defaultValue,!0);break;default:"function"==typeof a.onClick&&(e.onclick=Yi)}switch(i){case"button":case"input":case"select":case"textarea":r=!!r.autoFocus;break e;case"img":r=!0;break e;default:r=!1}}r&&(t.flags|=4)}null!==t.ref&&(t.flags|=512,t.flags|=2097152)}return jo(t),null;case 6:if(e&&null!=t.stateNode)Ro(e,t,e.memoizedProps,r);else{if("string"!=typeof r&&null===t.stateNode)throw Error(s(166));if(i=$r(Wr.current),$r(Hr.current),hr(t)){if(r=t.stateNode,i=t.memoizedProps,r[cn]=t,(o=r.nodeValue!==i)&&null!==(e=er))switch(e.tag){case 3:Ki(r.nodeValue,i,!!(1&e.mode));break;case 5:!0!==e.memoizedProps.suppressHydrationWarning&&Ki(r.nodeValue,i,!!(1&e.mode))}o&&(t.flags|=4)}else(r=(9===i.nodeType?i:i.ownerDocument).createTextNode(r))[cn]=t,t.stateNode=r}return jo(t),null;case 13:if(Sn(Qr),r=t.memoizedState,null===e||null!==e.memoizedState&&null!==e.memoizedState.dehydrated){if(sr&&null!==tr&&1&t.mode&&!(128&t.flags))cr(),dr(),t.flags|=98560,o=!1;else if(o=hr(t),null!==r&&null!==r.dehydrated){if(null===e){if(!o)throw Error(s(318));if(!(o=null!==(o=t.memoizedState)?o.dehydrated:null))throw Error(s(317));o[cn]=t}else dr(),!(128&t.flags)&&(t.memoizedState=null),t.flags|=4;jo(t),o=!1}else null!==ir&&(nh(ir),ir=null),o=!0;if(!o)return 65536&t.flags?t:null}return 128&t.flags?(t.lanes=i,t):((r=null!==r)!==(null!==e&&null!==e.memoizedState)&&r&&(t.child.flags|=8192,1&t.mode&&(null===e||1&Qr.current?0===Rl&&(Rl=3):ph())),null!==t.updateQueue&&(t.flags|=4),jo(t),null);case 4:return Xr(),Mo(e,t),null===e&&Ni(t.stateNode.containerInfo),jo(t),null;case 10:return Tr(t.type._context),jo(t),null;case 19:if(Sn(Qr),null===(o=t.memoizedState))return jo(t),null;if(r=!!(128&t.flags),null===(l=o.rendering))if(r)Ho(o,!1);else{if(0!==Rl||null!==e&&128&e.flags)for(e=t.child;null!==e;){if(null!==(l=Jr(e))){for(t.flags|=128,Ho(o,!1),null!==(r=l.updateQueue)&&(t.updateQueue=r,t.flags|=4),t.subtreeFlags=0,r=i,i=t.child;null!==i;)e=r,(o=i).flags&=14680066,null===(l=o.alternate)?(o.childLanes=0,o.lanes=e,o.child=null,o.subtreeFlags=0,o.memoizedProps=null,o.memoizedState=null,o.updateQueue=null,o.dependencies=null,o.stateNode=null):(o.childLanes=l.childLanes,o.lanes=l.lanes,o.child=l.child,o.subtreeFlags=0,o.deletions=null,o.memoizedProps=l.memoizedProps,o.memoizedState=l.memoizedState,o.updateQueue=l.updateQueue,o.type=l.type,e=l.dependencies,o.dependencies=null===e?null:{lanes:e.lanes,firstContext:e.firstContext}),i=i.sibling;return Cn(Qr,1&Qr.current|2),t.child}e=e.sibling}null!==o.tail&&Ke()>Ul&&(t.flags|=128,r=!0,Ho(o,!1),t.lanes=4194304)}else{if(!r)if(null!==(e=Jr(l))){if(t.flags|=128,r=!0,null!==(i=e.updateQueue)&&(t.updateQueue=i,t.flags|=4),Ho(o,!0),null===o.tail&&"hidden"===o.tailMode&&!l.alternate&&!sr)return jo(t),null}else 2*Ke()-o.renderingStartTime>Ul&&1073741824!==i&&(t.flags|=128,r=!0,Ho(o,!1),t.lanes=4194304);o.isBackwards?(l.sibling=t.child,t.child=l):(null!==(i=o.last)?i.sibling=l:t.child=l,o.last=l)}return null!==o.tail?(t=o.tail,o.rendering=t,o.tail=t.sibling,o.renderingStartTime=Ke(),t.sibling=null,i=Qr.current,Cn(Qr,r?1&i|2:1&i),t):(jo(t),null);case 22:case 23:return hh(),r=null!==t.memoizedState,null!==e&&null!==e.memoizedState!==r&&(t.flags|=8192),r&&1&t.mode?!!(1073741824&Ml)&&(jo(t),6&t.subtreeFlags&&(t.flags|=8192)):jo(t),null;case 24:case 25:return null}throw Error(s(156,t.tag))}function $o(e,t){switch(Zn(t),t.tag){case 1:return Mn(t.type)&&Dn(),65536&(e=t.flags)?(t.flags=-65537&e|128,t):null;case 3:return Xr(),Sn(Pn),Sn(En),ea(),65536&(e=t.flags)&&!(128&e)?(t.flags=-65537&e|128,t):null;case 5:return Yr(t),null;case 13:if(Sn(Qr),null!==(e=t.memoizedState)&&null!==e.dehydrated){if(null===t.alternate)throw Error(s(340));dr()}return 65536&(e=t.flags)?(t.flags=-65537&e|128,t):null;case 19:return Sn(Qr),null;case 4:return Xr(),null;case 10:return Tr(t.type._context),null;case 22:case 23:return hh(),null;default:return null}}Ao=function(e,t){for(var s=t.child;null!==s;){if(5===s.tag||6===s.tag)e.appendChild(s.stateNode);else if(4!==s.tag&&null!==s.child){s.child.return=s,s=s.child;continue}if(s===t)break;for(;null===s.sibling;){if(null===s.return||s.return===t)return;s=s.return}s.sibling.return=s.return,s=s.sibling}},Mo=function(){},Do=function(e,t,s,i){var r=e.memoizedProps;if(r!==i){e=t.stateNode,$r(Hr.current);var a,o=null;switch(s){case"input":r=q(e,r),i=q(e,i),o=[];break;case"select":r=F({},r,{value:void 0}),i=F({},i,{value:void 0}),o=[];break;case"textarea":r=te(e,r),i=te(e,i),o=[];break;default:"function"!=typeof r.onClick&&"function"==typeof i.onClick&&(e.onclick=Yi)}for(c in ge(s,i),s=null,r)if(!i.hasOwnProperty(c)&&r.hasOwnProperty(c)&&null!=r[c])if("style"===c){var l=r[c];for(a in l)l.hasOwnProperty(a)&&(s||(s={}),s[a]="")}else"dangerouslySetInnerHTML"!==c&&"children"!==c&&"suppressContentEditableWarning"!==c&&"suppressHydrationWarning"!==c&&"autoFocus"!==c&&(n.hasOwnProperty(c)?o||(o=[]):(o=o||[]).push(c,null));for(c in i){var h=i[c];if(l=null!=r?r[c]:void 0,i.hasOwnProperty(c)&&h!==l&&(null!=h||null!=l))if("style"===c)if(l){for(a in l)!l.hasOwnProperty(a)||h&&h.hasOwnProperty(a)||(s||(s={}),s[a]="");for(a in h)h.hasOwnProperty(a)&&l[a]!==h[a]&&(s||(s={}),s[a]=h[a])}else s||(o||(o=[]),o.push(c,s)),s=h;else"dangerouslySetInnerHTML"===c?(h=h?h.__html:void 0,l=l?l.__html:void 0,null!=h&&l!==h&&(o=o||[]).push(c,h)):"children"===c?"string"!=typeof h&&"number"!=typeof h||(o=o||[]).push(c,""+h):"suppressContentEditableWarning"!==c&&"suppressHydrationWarning"!==c&&(n.hasOwnProperty(c)?(null!=h&&"onScroll"===c&&Oi("scroll",e),o||l===h||(o=[])):(o=o||[]).push(c,h))}s&&(o=o||[]).push("style",s);var c=o;(t.updateQueue=c)&&(t.flags|=4)}},Ro=function(e,t,s,i){s!==i&&(t.flags|=4)};var qo=!1,Xo=!1,Ko="function"==typeof WeakSet?WeakSet:Set,Yo=null;function Qo(e,t){var s=e.ref;if(null!==s)if("function"==typeof s)try{s(null)}catch(s){wh(e,t,s)}else s.current=null}function Jo(e,t,s){try{s()}catch(s){wh(e,t,s)}}var Zo=!1;function el(e,t,s){var i=t.updateQueue;if(null!==(i=null!==i?i.lastEffect:null)){var n=i=i.next;do{if((n.tag&e)===e){var r=n.destroy;n.destroy=void 0,void 0!==r&&Jo(t,s,r)}n=n.next}while(n!==i)}}function tl(e,t){if(null!==(t=null!==(t=t.updateQueue)?t.lastEffect:null)){var s=t=t.next;do{if((s.tag&e)===e){var i=s.create;s.destroy=i()}s=s.next}while(s!==t)}}function sl(e){var t=e.ref;if(null!==t){var s=e.stateNode;e.tag,e=s,"function"==typeof t?t(e):t.current=e}}function il(e){var t=e.alternate;null!==t&&(e.alternate=null,il(t)),e.child=null,e.deletions=null,e.sibling=null,5===e.tag&&(null!==(t=e.stateNode)&&(delete t[cn],delete t[dn],delete t[pn],delete t[fn],delete t[mn])),e.stateNode=null,e.return=null,e.dependencies=null,e.memoizedProps=null,e.memoizedState=null,e.pendingProps=null,e.stateNode=null,e.updateQueue=null}function nl(e){return 5===e.tag||3===e.tag||4===e.tag}function rl(e){e:for(;;){for(;null===e.sibling;){if(null===e.return||nl(e.return))return null;e=e.return}for(e.sibling.return=e.return,e=e.sibling;5!==e.tag&&6!==e.tag&&18!==e.tag;){if(2&e.flags)continue e;if(null===e.child||4===e.tag)continue e;e.child.return=e,e=e.child}if(!(2&e.flags))return e.stateNode}}function al(e,t,s){var i=e.tag;if(5===i||6===i)e=e.stateNode,t?8===s.nodeType?s.parentNode.insertBefore(e,t):s.insertBefore(e,t):(8===s.nodeType?(t=s.parentNode).insertBefore(e,s):(t=s).appendChild(e),null!=(s=s._reactRootContainer)||null!==t.onclick||(t.onclick=Yi));else if(4!==i&&null!==(e=e.child))for(al(e,t,s),e=e.sibling;null!==e;)al(e,t,s),e=e.sibling}function ol(e,t,s){var i=e.tag;if(5===i||6===i)e=e.stateNode,t?s.insertBefore(e,t):s.appendChild(e);else if(4!==i&&null!==(e=e.child))for(ol(e,t,s),e=e.sibling;null!==e;)ol(e,t,s),e=e.sibling}var ll=null,hl=!1;function cl(e,t,s){for(s=s.child;null!==s;)dl(e,t,s),s=s.sibling}function dl(e,t,s){if(it&&"function"==typeof it.onCommitFiberUnmount)try{it.onCommitFiberUnmount(st,s)}catch(e){}switch(s.tag){case 5:Xo||Qo(s,t);case 6:var i=ll,n=hl;ll=null,cl(e,t,s),hl=n,null!==(ll=i)&&(hl?(e=ll,s=s.stateNode,8===e.nodeType?e.parentNode.removeChild(s):e.removeChild(s)):ll.removeChild(s.stateNode));break;case 18:null!==ll&&(hl?(e=ll,s=s.stateNode,8===e.nodeType?an(e.parentNode,s):1===e.nodeType&&an(e,s),Ut(e)):an(ll,s.stateNode));break;case 4:i=ll,n=hl,ll=s.stateNode.containerInfo,hl=!0,cl(e,t,s),ll=i,hl=n;break;case 0:case 11:case 14:case 15:if(!Xo&&(null!==(i=s.updateQueue)&&null!==(i=i.lastEffect))){n=i=i.next;do{var r=n,a=r.destroy;r=r.tag,void 0!==a&&(2&r||4&r)&&Jo(s,t,a),n=n.next}while(n!==i)}cl(e,t,s);break;case 1:if(!Xo&&(Qo(s,t),"function"==typeof(i=s.stateNode).componentWillUnmount))try{i.props=s.memoizedProps,i.state=s.memoizedState,i.componentWillUnmount()}catch(e){wh(s,t,e)}cl(e,t,s);break;case 21:cl(e,t,s);break;case 22:1&s.mode?(Xo=(i=Xo)||null!==s.memoizedState,cl(e,t,s),Xo=i):cl(e,t,s);break;default:cl(e,t,s)}}function ul(e){var t=e.updateQueue;if(null!==t){e.updateQueue=null;var s=e.stateNode;null===s&&(s=e.stateNode=new Ko),t.forEach((function(t){var i=Eh.bind(null,e,t);s.has(t)||(s.add(t),t.then(i,i))}))}}function pl(e,t){var i=t.deletions;if(null!==i)for(var n=0;n<i.length;n++){var r=i[n];try{var a=e,o=t,l=o;e:for(;null!==l;){switch(l.tag){case 5:ll=l.stateNode,hl=!1;break e;case 3:case 4:ll=l.stateNode.containerInfo,hl=!0;break e}l=l.return}if(null===ll)throw Error(s(160));dl(a,o,r),ll=null,hl=!1;var h=r.alternate;null!==h&&(h.return=null),r.return=null}catch(e){wh(r,t,e)}}if(12854&t.subtreeFlags)for(t=t.child;null!==t;)fl(t,e),t=t.sibling}function fl(e,t){var i=e.alternate,n=e.flags;switch(e.tag){case 0:case 11:case 14:case 15:if(pl(t,e),ml(e),4&n){try{el(3,e,e.return),tl(3,e)}catch(t){wh(e,e.return,t)}try{el(5,e,e.return)}catch(t){wh(e,e.return,t)}}break;case 1:pl(t,e),ml(e),512&n&&null!==i&&Qo(i,i.return);break;case 5:if(pl(t,e),ml(e),512&n&&null!==i&&Qo(i,i.return),32&e.flags){var r=e.stateNode;try{ce(r,"")}catch(t){wh(e,e.return,t)}}if(4&n&&null!=(r=e.stateNode)){var a=e.memoizedProps,o=null!==i?i.memoizedProps:a,l=e.type,h=e.updateQueue;if(e.updateQueue=null,null!==h)try{"input"===l&&"radio"===a.type&&null!=a.name&&K(r,a),_e(l,o);var c=_e(l,a);for(o=0;o<h.length;o+=2){var d=h[o],u=h[o+1];"style"===d?fe(r,u):"dangerouslySetInnerHTML"===d?he(r,u):"children"===d?ce(r,u):_(r,d,u,c)}switch(l){case"input":Y(r,a);break;case"textarea":ie(r,a);break;case"select":var p=r._wrapperState.wasMultiple;r._wrapperState.wasMultiple=!!a.multiple;var f=a.value;null!=f?ee(r,!!a.multiple,f,!1):p!==!!a.multiple&&(null!=a.defaultValue?ee(r,!!a.multiple,a.defaultValue,!0):ee(r,!!a.multiple,a.multiple?[]:"",!1))}r[dn]=a}catch(t){wh(e,e.return,t)}}break;case 6:if(pl(t,e),ml(e),4&n){if(null===e.stateNode)throw Error(s(162));r=e.stateNode,a=e.memoizedProps;try{r.nodeValue=a}catch(t){wh(e,e.return,t)}}break;case 3:if(pl(t,e),ml(e),4&n&&null!==i&&i.memoizedState.isDehydrated)try{Ut(t.containerInfo)}catch(t){wh(e,e.return,t)}break;case 4:default:pl(t,e),ml(e);break;case 13:pl(t,e),ml(e),8192&(r=e.child).flags&&(a=null!==r.memoizedState,r.stateNode.isHidden=a,!a||null!==r.alternate&&null!==r.alternate.memoizedState||(Nl=Ke())),4&n&&ul(e);break;case 22:if(d=null!==i&&null!==i.memoizedState,1&e.mode?(Xo=(c=Xo)||d,pl(t,e),Xo=c):pl(t,e),ml(e),8192&n){if(c=null!==e.memoizedState,(e.stateNode.isHidden=c)&&!d&&1&e.mode)for(Yo=e,d=e.child;null!==d;){for(u=Yo=d;null!==Yo;){switch(f=(p=Yo).child,p.tag){case 0:case 11:case 14:case 15:el(4,p,p.return);break;case 1:Qo(p,p.return);var m=p.stateNode;if("function"==typeof m.componentWillUnmount){n=p,i=p.return;try{t=n,m.props=t.memoizedProps,m.state=t.memoizedState,m.componentWillUnmount()}catch(e){wh(n,i,e)}}break;case 5:Qo(p,p.return);break;case 22:if(null!==p.memoizedState){bl(u);continue}}null!==f?(f.return=p,Yo=f):bl(u)}d=d.sibling}e:for(d=null,u=e;;){if(5===u.tag){if(null===d){d=u;try{r=u.stateNode,c?"function"==typeof(a=r.style).setProperty?a.setProperty("display","none","important"):a.display="none":(l=u.stateNode,o=null!=(h=u.memoizedProps.style)&&h.hasOwnProperty("display")?h.display:null,l.style.display=pe("display",o))}catch(t){wh(e,e.return,t)}}}else if(6===u.tag){if(null===d)try{u.stateNode.nodeValue=c?"":u.memoizedProps}catch(t){wh(e,e.return,t)}}else if((22!==u.tag&&23!==u.tag||null===u.memoizedState||u===e)&&null!==u.child){u.child.return=u,u=u.child;continue}if(u===e)break e;for(;null===u.sibling;){if(null===u.return||u.return===e)break e;d===u&&(d=null),u=u.return}d===u&&(d=null),u.sibling.return=u.return,u=u.sibling}}break;case 19:pl(t,e),ml(e),4&n&&ul(e);case 21:}}function ml(e){var t=e.flags;if(2&t){try{e:{for(var i=e.return;null!==i;){if(nl(i)){var n=i;break e}i=i.return}throw Error(s(160))}switch(n.tag){case 5:var r=n.stateNode;32&n.flags&&(ce(r,""),n.flags&=-33),ol(e,rl(e),r);break;case 3:case 4:var a=n.stateNode.containerInfo;al(e,rl(e),a);break;default:throw Error(s(161))}}catch(t){wh(e,e.return,t)}e.flags&=-3}4096&t&&(e.flags&=-4097)}function gl(e,t,s){Yo=e,_l(e)}function _l(e,t,s){for(var i=!!(1&e.mode);null!==Yo;){var n=Yo,r=n.child;if(22===n.tag&&i){var a=null!==n.memoizedState||qo;if(!a){var o=n.alternate,l=null!==o&&null!==o.memoizedState||Xo;o=qo;var h=Xo;if(qo=a,(Xo=l)&&!h)for(Yo=n;null!==Yo;)l=(a=Yo).child,22===a.tag&&null!==a.memoizedState?yl(n):null!==l?(l.return=a,Yo=l):yl(n);for(;null!==r;)Yo=r,_l(r),r=r.sibling;Yo=n,qo=o,Xo=h}vl(e)}else 8772&n.subtreeFlags&&null!==r?(r.return=n,Yo=r):vl(e)}}function vl(e){for(;null!==Yo;){var t=Yo;if(8772&t.flags){var i=t.alternate;try{if(8772&t.flags)switch(t.tag){case 0:case 11:case 15:Xo||tl(5,t);break;case 1:var n=t.stateNode;if(4&t.flags&&!Xo)if(null===i)n.componentDidMount();else{var r=t.elementType===t.type?i.memoizedProps:Za(t.type,i.memoizedProps);n.componentDidUpdate(r,i.memoizedState,n.__reactInternalSnapshotBeforeUpdate)}var a=t.updateQueue;null!==a&&Vr(t,a,n);break;case 3:var o=t.updateQueue;if(null!==o){if(i=null,null!==t.child)switch(t.child.tag){case 5:case 1:i=t.child.stateNode}Vr(t,o,i)}break;case 5:var l=t.stateNode;if(null===i&&4&t.flags){i=l;var h=t.memoizedProps;switch(t.type){case"button":case"input":case"select":case"textarea":h.autoFocus&&i.focus();break;case"img":h.src&&(i.src=h.src)}}break;case 6:case 4:case 12:case 19:case 17:case 21:case 22:case 23:case 25:break;case 13:if(null===t.memoizedState){var c=t.alternate;if(null!==c){var d=c.memoizedState;if(null!==d){var u=d.dehydrated;null!==u&&Ut(u)}}}break;default:throw Error(s(163))}Xo||512&t.flags&&sl(t)}catch(e){wh(t,t.return,e)}}if(t===e){Yo=null;break}if(null!==(i=t.sibling)){i.return=t.return,Yo=i;break}Yo=t.return}}function bl(e){for(;null!==Yo;){var t=Yo;if(t===e){Yo=null;break}var s=t.sibling;if(null!==s){s.return=t.return,Yo=s;break}Yo=t.return}}function yl(e){for(;null!==Yo;){var t=Yo;try{switch(t.tag){case 0:case 11:case 15:var s=t.return;try{tl(4,t)}catch(e){wh(t,s,e)}break;case 1:var i=t.stateNode;if("function"==typeof i.componentDidMount){var n=t.return;try{i.componentDidMount()}catch(e){wh(t,n,e)}}var r=t.return;try{sl(t)}catch(e){wh(t,r,e)}break;case 5:var a=t.return;try{sl(t)}catch(e){wh(t,a,e)}}}catch(e){wh(t,t.return,e)}if(t===e){Yo=null;break}var o=t.sibling;if(null!==o){o.return=t.return,Yo=o;break}Yo=t.return}}var xl,wl=Math.ceil,Sl=v.ReactCurrentDispatcher,Cl=v.ReactCurrentOwner,Tl=v.ReactCurrentBatchConfig,El=0,Pl=null,kl=null,Al=0,Ml=0,Dl=wn(0),Rl=0,Ll=null,Il=0,Fl=0,Ol=0,Bl=null,zl=null,Nl=0,Ul=1/0,Vl=null,Gl=!1,Hl=null,jl=null,Wl=!1,$l=null,ql=0,Xl=0,Kl=null,Yl=-1,Ql=0;function Jl(){return 6&El?Ke():-1!==Yl?Yl:Yl=Ke()}function Zl(e){return 1&e.mode?2&El&&0!==Al?Al&-Al:null!==pr.transition?(0===Ql&&(Ql=pt()),Ql):0!==(e=_t)?e:e=void 0===(e=window.event)?16:Xt(e.type):1}function eh(e,t,i,n){if(50<Xl)throw Xl=0,Kl=null,Error(s(185));mt(e,i,n),2&El&&e===Pl||(e===Pl&&(!(2&El)&&(Fl|=i),4===Rl&&rh(e,Al)),th(e,n),1===i&&0===El&&!(1&t.mode)&&(Ul=Ke()+500,Bn&&Un()))}function th(e,t){var s=e.callbackNode;!function(e,t){for(var s=e.suspendedLanes,i=e.pingedLanes,n=e.expirationTimes,r=e.pendingLanes;0<r;){var a=31-nt(r),o=1<<a,l=n[a];-1===l?o&s&&!(o&i)||(n[a]=dt(o,t)):l<=t&&(e.expiredLanes|=o),r&=~o}}(e,t);var i=ct(e,e===Pl?Al:0);if(0===i)null!==s&&$e(s),e.callbackNode=null,e.callbackPriority=0;else if(t=i&-i,e.callbackPriority!==t){if(null!=s&&$e(s),1===t)0===e.tag?function(e){Bn=!0,Nn(e)}(ah.bind(null,e)):Nn(ah.bind(null,e)),nn((function(){!(6&El)&&Un()})),s=null;else{switch(vt(i)){case 1:s=Qe;break;case 4:s=Je;break;case 16:default:s=Ze;break;case 536870912:s=tt}s=Ph(s,sh.bind(null,e))}e.callbackPriority=t,e.callbackNode=s}}function sh(e,t){if(Yl=-1,Ql=0,6&El)throw Error(s(327));var i=e.callbackNode;if(yh()&&e.callbackNode!==i)return null;var n=ct(e,e===Pl?Al:0);if(0===n)return null;if(30&n||n&e.expiredLanes||t)t=fh(e,n);else{t=n;var r=El;El|=2;var a=uh();for(Pl===e&&Al===t||(Vl=null,Ul=Ke()+500,ch(e,t));;)try{gh();break}catch(t){dh(e,t)}Cr(),Sl.current=a,El=r,null!==kl?t=0:(Pl=null,Al=0,t=Rl)}if(0!==t){if(2===t&&(0!==(r=ut(e))&&(n=r,t=ih(e,r))),1===t)throw i=Ll,ch(e,0),rh(e,n),th(e,Ke()),i;if(6===t)rh(e,n);else{if(r=e.current.alternate,!(30&n||function(e){for(var t=e;;){if(16384&t.flags){var s=t.updateQueue;if(null!==s&&null!==(s=s.stores))for(var i=0;i<s.length;i++){var n=s[i],r=n.getSnapshot;n=n.value;try{if(!ni(r(),n))return!1}catch(e){return!1}}}if(s=t.child,16384&t.subtreeFlags&&null!==s)s.return=t,t=s;else{if(t===e)break;for(;null===t.sibling;){if(null===t.return||t.return===e)return!0;t=t.return}t.sibling.return=t.return,t=t.sibling}}return!0}(r)||(t=fh(e,n),2===t&&(a=ut(e),0!==a&&(n=a,t=ih(e,a))),1!==t)))throw i=Ll,ch(e,0),rh(e,n),th(e,Ke()),i;switch(e.finishedWork=r,e.finishedLanes=n,t){case 0:case 1:throw Error(s(345));case 2:case 5:bh(e,zl,Vl);break;case 3:if(rh(e,n),(130023424&n)===n&&10<(t=Nl+500-Ke())){if(0!==ct(e,0))break;if(((r=e.suspendedLanes)&n)!==n){Jl(),e.pingedLanes|=e.suspendedLanes&r;break}e.timeoutHandle=en(bh.bind(null,e,zl,Vl),t);break}bh(e,zl,Vl);break;case 4:if(rh(e,n),(4194240&n)===n)break;for(t=e.eventTimes,r=-1;0<n;){var o=31-nt(n);a=1<<o,(o=t[o])>r&&(r=o),n&=~a}if(n=r,10<(n=(120>(n=Ke()-n)?120:480>n?480:1080>n?1080:1920>n?1920:3e3>n?3e3:4320>n?4320:1960*wl(n/1960))-n)){e.timeoutHandle=en(bh.bind(null,e,zl,Vl),n);break}bh(e,zl,Vl);break;default:throw Error(s(329))}}}return th(e,Ke()),e.callbackNode===i?sh.bind(null,e):null}function ih(e,t){var s=Bl;return e.current.memoizedState.isDehydrated&&(ch(e,t).flags|=256),2!==(e=fh(e,t))&&(t=zl,zl=s,null!==t&&nh(t)),e}function nh(e){null===zl?zl=e:zl.push.apply(zl,e)}function rh(e,t){for(t&=~Ol,t&=~Fl,e.suspendedLanes|=t,e.pingedLanes&=~t,e=e.expirationTimes;0<t;){var s=31-nt(t),i=1<<s;e[s]=-1,t&=~i}}function ah(e){if(6&El)throw Error(s(327));yh();var t=ct(e,0);if(!(1&t))return th(e,Ke()),null;var i=fh(e,t);if(0!==e.tag&&2===i){var n=ut(e);0!==n&&(t=n,i=ih(e,n))}if(1===i)throw i=Ll,ch(e,0),rh(e,t),th(e,Ke()),i;if(6===i)throw Error(s(345));return e.finishedWork=e.current.alternate,e.finishedLanes=t,bh(e,zl,Vl),th(e,Ke()),null}function oh(e,t){var s=El;El|=1;try{return e(t)}finally{0===(El=s)&&(Ul=Ke()+500,Bn&&Un())}}function lh(e){null!==$l&&0===$l.tag&&!(6&El)&&yh();var t=El;El|=1;var s=Tl.transition,i=_t;try{if(Tl.transition=null,_t=1,e)return e()}finally{_t=i,Tl.transition=s,!(6&(El=t))&&Un()}}function hh(){Ml=Dl.current,Sn(Dl)}function ch(e,t){e.finishedWork=null,e.finishedLanes=0;var s=e.timeoutHandle;if(-1!==s&&(e.timeoutHandle=-1,tn(s)),null!==kl)for(s=kl.return;null!==s;){var i=s;switch(Zn(i),i.tag){case 1:null!=(i=i.type.childContextTypes)&&Dn();break;case 3:Xr(),Sn(Pn),Sn(En),ea();break;case 5:Yr(i);break;case 4:Xr();break;case 13:case 19:Sn(Qr);break;case 10:Tr(i.type._context);break;case 22:case 23:hh()}s=s.return}if(Pl=e,kl=e=Dh(e.current,null),Al=Ml=t,Rl=0,Ll=null,Ol=Fl=Il=0,zl=Bl=null,null!==Ar){for(t=0;t<Ar.length;t++)if(null!==(i=(s=Ar[t]).interleaved)){s.interleaved=null;var n=i.next,r=s.pending;if(null!==r){var a=r.next;r.next=n,i.next=a}s.pending=i}Ar=null}return e}function dh(e,t){for(;;){var i=kl;try{if(Cr(),ta.current=Ka,oa){for(var n=na.memoizedState;null!==n;){var r=n.queue;null!==r&&(r.pending=null),n=n.next}oa=!1}if(ia=0,aa=ra=na=null,la=!1,ha=0,Cl.current=null,null===i||null===i.return){Rl=1,Ll=t,kl=null;break}e:{var a=e,o=i.return,l=i,h=t;if(t=Al,l.flags|=32768,null!==h&&"object"==typeof h&&"function"==typeof h.then){var c=h,d=l,u=d.tag;if(!(1&d.mode||0!==u&&11!==u&&15!==u)){var p=d.alternate;p?(d.updateQueue=p.updateQueue,d.memoizedState=p.memoizedState,d.lanes=p.lanes):(d.updateQueue=null,d.memoizedState=null)}var f=fo(o);if(null!==f){f.flags&=-257,mo(f,o,l,0,t),1&f.mode&&po(a,c,t),h=c;var m=(t=f).updateQueue;if(null===m){var g=new Set;g.add(h),t.updateQueue=g}else m.add(h);break e}if(!(1&t)){po(a,c,t),ph();break e}h=Error(s(426))}else if(sr&&1&l.mode){var _=fo(o);if(null!==_){!(65536&_.flags)&&(_.flags|=256),mo(_,o,l,0,t),ur(ao(h,l));break e}}a=h=ao(h,l),4!==Rl&&(Rl=2),null===Bl?Bl=[a]:Bl.push(a),a=o;do{switch(a.tag){case 3:a.flags|=65536,t&=-t,a.lanes|=t,Nr(a,co(0,h,t));break e;case 1:l=h;var v=a.type,b=a.stateNode;if(!(128&a.flags||"function"!=typeof v.getDerivedStateFromError&&(null===b||"function"!=typeof b.componentDidCatch||null!==jl&&jl.has(b)))){a.flags|=65536,t&=-t,a.lanes|=t,Nr(a,uo(a,l,t));break e}}a=a.return}while(null!==a)}vh(i)}catch(e){t=e,kl===i&&null!==i&&(kl=i=i.return);continue}break}}function uh(){var e=Sl.current;return Sl.current=Ka,null===e?Ka:e}function ph(){0!==Rl&&3!==Rl&&2!==Rl||(Rl=4),null===Pl||!(268435455&Il)&&!(268435455&Fl)||rh(Pl,Al)}function fh(e,t){var i=El;El|=2;var n=uh();for(Pl===e&&Al===t||(Vl=null,ch(e,t));;)try{mh();break}catch(t){dh(e,t)}if(Cr(),El=i,Sl.current=n,null!==kl)throw Error(s(261));return Pl=null,Al=0,Rl}function mh(){for(;null!==kl;)_h(kl)}function gh(){for(;null!==kl&&!qe();)_h(kl)}function _h(e){var t=xl(e.alternate,e,Ml);e.memoizedProps=e.pendingProps,null===t?vh(e):kl=t,Cl.current=null}function vh(e){var t=e;do{var s=t.alternate;if(e=t.return,32768&t.flags){if(null!==(s=$o(s,t)))return s.flags&=32767,void(kl=s);if(null===e)return Rl=6,void(kl=null);e.flags|=32768,e.subtreeFlags=0,e.deletions=null}else if(null!==(s=Wo(s,t,Ml)))return void(kl=s);if(null!==(t=t.sibling))return void(kl=t);kl=t=e}while(null!==t);0===Rl&&(Rl=5)}function bh(e,t,i){var n=_t,r=Tl.transition;try{Tl.transition=null,_t=1,function(e,t,i,n){do{yh()}while(null!==$l);if(6&El)throw Error(s(327));i=e.finishedWork;var r=e.finishedLanes;if(null===i)return null;if(e.finishedWork=null,e.finishedLanes=0,i===e.current)throw Error(s(177));e.callbackNode=null,e.callbackPriority=0;var a=i.lanes|i.childLanes;if(function(e,t){var s=e.pendingLanes&~t;e.pendingLanes=t,e.suspendedLanes=0,e.pingedLanes=0,e.expiredLanes&=t,e.mutableReadLanes&=t,e.entangledLanes&=t,t=e.entanglements;var i=e.eventTimes;for(e=e.expirationTimes;0<s;){var n=31-nt(s),r=1<<n;t[n]=0,i[n]=-1,e[n]=-1,s&=~r}}(e,a),e===Pl&&(kl=Pl=null,Al=0),!(2064&i.subtreeFlags)&&!(2064&i.flags)||Wl||(Wl=!0,Ph(Ze,(function(){return yh(),null}))),a=!!(15990&i.flags),!!(15990&i.subtreeFlags)||a){a=Tl.transition,Tl.transition=null;var o=_t;_t=1;var l=El;El|=4,Cl.current=null,function(e,t){if(Qi=Gt,ci(e=hi())){if("selectionStart"in e)var i={start:e.selectionStart,end:e.selectionEnd};else{var n=(i=(i=e.ownerDocument)&&i.defaultView||window).getSelection&&i.getSelection();if(n&&0!==n.rangeCount){i=n.anchorNode;var r=n.anchorOffset,a=n.focusNode;n=n.focusOffset;var o=0,l=-1,h=-1,c=0,d=0,u=e,p=null;e:for(;;){for(var f;u!==i||0!==r&&3!==u.nodeType||(l=o+r),u!==a||0!==n&&3!==u.nodeType||(h=o+n),3===u.nodeType&&(o+=u.nodeValue.length),null!==(f=u.firstChild);)p=u,u=f;for(;;){if(u===e)break e;if(p===i&&++c===r&&(l=o),p===a&&++d===n&&(h=o),null!==(f=u.nextSibling))break;p=(u=p).parentNode}u=f}i=-1===l||-1===h?null:{start:l,end:h}}else i=null}i=i||{start:0,end:0}}else i=null;for(Ji={focusedElem:e,selectionRange:i},Gt=!1,Yo=t;null!==Yo;)if(e=(t=Yo).child,1028&t.subtreeFlags&&null!==e)e.return=t,Yo=e;else for(;null!==Yo;){t=Yo;try{var m=t.alternate;if(1024&t.flags)switch(t.tag){case 0:case 11:case 15:case 5:case 6:case 4:case 17:break;case 1:if(null!==m){var g=m.memoizedProps,_=m.memoizedState,v=t.stateNode,b=v.getSnapshotBeforeUpdate(t.elementType===t.type?g:Za(t.type,g),_);v.__reactInternalSnapshotBeforeUpdate=b}break;case 3:var y=t.stateNode.containerInfo;1===y.nodeType?y.textContent="":9===y.nodeType&&y.documentElement&&y.removeChild(y.documentElement);break;default:throw Error(s(163))}}catch(e){wh(t,t.return,e)}if(null!==(e=t.sibling)){e.return=t.return,Yo=e;break}Yo=t.return}m=Zo,Zo=!1}(e,i),fl(i,e),di(Ji),Gt=!!Qi,Ji=Qi=null,e.current=i,gl(i),Xe(),El=l,_t=o,Tl.transition=a}else e.current=i;if(Wl&&(Wl=!1,$l=e,ql=r),a=e.pendingLanes,0===a&&(jl=null),function(e){if(it&&"function"==typeof it.onCommitFiberRoot)try{it.onCommitFiberRoot(st,e,void 0,!(128&~e.current.flags))}catch(e){}}(i.stateNode),th(e,Ke()),null!==t)for(n=e.onRecoverableError,i=0;i<t.length;i++)r=t[i],n(r.value,{componentStack:r.stack,digest:r.digest});if(Gl)throw Gl=!1,e=Hl,Hl=null,e;!!(1&ql)&&0!==e.tag&&yh(),a=e.pendingLanes,1&a?e===Kl?Xl++:(Xl=0,Kl=e):Xl=0,Un()}(e,t,i,n)}finally{Tl.transition=r,_t=n}return null}function yh(){if(null!==$l){var e=vt(ql),t=Tl.transition,i=_t;try{if(Tl.transition=null,_t=16>e?16:e,null===$l)var n=!1;else{if(e=$l,$l=null,ql=0,6&El)throw Error(s(331));var r=El;for(El|=4,Yo=e.current;null!==Yo;){var a=Yo,o=a.child;if(16&Yo.flags){var l=a.deletions;if(null!==l){for(var h=0;h<l.length;h++){var c=l[h];for(Yo=c;null!==Yo;){var d=Yo;switch(d.tag){case 0:case 11:case 15:el(8,d,a)}var u=d.child;if(null!==u)u.return=d,Yo=u;else for(;null!==Yo;){var p=(d=Yo).sibling,f=d.return;if(il(d),d===c){Yo=null;break}if(null!==p){p.return=f,Yo=p;break}Yo=f}}}var m=a.alternate;if(null!==m){var g=m.child;if(null!==g){m.child=null;do{var _=g.sibling;g.sibling=null,g=_}while(null!==g)}}Yo=a}}if(2064&a.subtreeFlags&&null!==o)o.return=a,Yo=o;else e:for(;null!==Yo;){if(2048&(a=Yo).flags)switch(a.tag){case 0:case 11:case 15:el(9,a,a.return)}var v=a.sibling;if(null!==v){v.return=a.return,Yo=v;break e}Yo=a.return}}var b=e.current;for(Yo=b;null!==Yo;){var y=(o=Yo).child;if(2064&o.subtreeFlags&&null!==y)y.return=o,Yo=y;else e:for(o=b;null!==Yo;){if(2048&(l=Yo).flags)try{switch(l.tag){case 0:case 11:case 15:tl(9,l)}}catch(e){wh(l,l.return,e)}if(l===o){Yo=null;break e}var x=l.sibling;if(null!==x){x.return=l.return,Yo=x;break e}Yo=l.return}}if(El=r,Un(),it&&"function"==typeof it.onPostCommitFiberRoot)try{it.onPostCommitFiberRoot(st,e)}catch(e){}n=!0}return n}finally{_t=i,Tl.transition=t}}return!1}function xh(e,t,s){e=Br(e,t=co(0,t=ao(s,t),1),1),t=Jl(),null!==e&&(mt(e,1,t),th(e,t))}function wh(e,t,s){if(3===e.tag)xh(e,e,s);else for(;null!==t;){if(3===t.tag){xh(t,e,s);break}if(1===t.tag){var i=t.stateNode;if("function"==typeof t.type.getDerivedStateFromError||"function"==typeof i.componentDidCatch&&(null===jl||!jl.has(i))){t=Br(t,e=uo(t,e=ao(s,e),1),1),e=Jl(),null!==t&&(mt(t,1,e),th(t,e));break}}t=t.return}}function Sh(e,t,s){var i=e.pingCache;null!==i&&i.delete(t),t=Jl(),e.pingedLanes|=e.suspendedLanes&s,Pl===e&&(Al&s)===s&&(4===Rl||3===Rl&&(130023424&Al)===Al&&500>Ke()-Nl?ch(e,0):Ol|=s),th(e,t)}function Ch(e,t){0===t&&(1&e.mode?(t=lt,!(130023424&(lt<<=1))&&(lt=4194304)):t=1);var s=Jl();null!==(e=Rr(e,t))&&(mt(e,t,s),th(e,s))}function Th(e){var t=e.memoizedState,s=0;null!==t&&(s=t.retryLane),Ch(e,s)}function Eh(e,t){var i=0;switch(e.tag){case 13:var n=e.stateNode,r=e.memoizedState;null!==r&&(i=r.retryLane);break;case 19:n=e.stateNode;break;default:throw Error(s(314))}null!==n&&n.delete(t),Ch(e,i)}function Ph(e,t){return We(e,t)}function kh(e,t,s,i){this.tag=e,this.key=s,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.ref=null,this.pendingProps=t,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=i,this.subtreeFlags=this.flags=0,this.deletions=null,this.childLanes=this.lanes=0,this.alternate=null}function Ah(e,t,s,i){return new kh(e,t,s,i)}function Mh(e){return!(!(e=e.prototype)||!e.isReactComponent)}function Dh(e,t){var s=e.alternate;return null===s?((s=Ah(e.tag,t,e.key,e.mode)).elementType=e.elementType,s.type=e.type,s.stateNode=e.stateNode,s.alternate=e,e.alternate=s):(s.pendingProps=t,s.type=e.type,s.flags=0,s.subtreeFlags=0,s.deletions=null),s.flags=14680064&e.flags,s.childLanes=e.childLanes,s.lanes=e.lanes,s.child=e.child,s.memoizedProps=e.memoizedProps,s.memoizedState=e.memoizedState,s.updateQueue=e.updateQueue,t=e.dependencies,s.dependencies=null===t?null:{lanes:t.lanes,firstContext:t.firstContext},s.sibling=e.sibling,s.index=e.index,s.ref=e.ref,s}function Rh(e,t,i,n,r,a){var o=2;if(n=e,"function"==typeof e)Mh(e)&&(o=1);else if("string"==typeof e)o=5;else e:switch(e){case x:return Lh(i.children,r,a,t);case w:o=8,r|=8;break;case S:return(e=Ah(12,i,t,2|r)).elementType=S,e.lanes=a,e;case P:return(e=Ah(13,i,t,r)).elementType=P,e.lanes=a,e;case k:return(e=Ah(19,i,t,r)).elementType=k,e.lanes=a,e;case D:return Ih(i,r,a,t);default:if("object"==typeof e&&null!==e)switch(e.$$typeof){case C:o=10;break e;case T:o=9;break e;case E:o=11;break e;case A:o=14;break e;case M:o=16,n=null;break e}throw Error(s(130,null==e?e:typeof e,""))}return(t=Ah(o,i,t,r)).elementType=e,t.type=n,t.lanes=a,t}function Lh(e,t,s,i){return(e=Ah(7,e,i,t)).lanes=s,e}function Ih(e,t,s,i){return(e=Ah(22,e,i,t)).elementType=D,e.lanes=s,e.stateNode={isHidden:!1},e}function Fh(e,t,s){return(e=Ah(6,e,null,t)).lanes=s,e}function Oh(e,t,s){return(t=Ah(4,null!==e.children?e.children:[],e.key,t)).lanes=s,t.stateNode={containerInfo:e.containerInfo,pendingChildren:null,implementation:e.implementation},t}function Bh(e,t,s,i,n){this.tag=t,this.containerInfo=e,this.finishedWork=this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=-1,this.callbackNode=this.pendingContext=this.context=null,this.callbackPriority=0,this.eventTimes=ft(0),this.expirationTimes=ft(-1),this.entangledLanes=this.finishedLanes=this.mutableReadLanes=this.expiredLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=ft(0),this.identifierPrefix=i,this.onRecoverableError=n,this.mutableSourceEagerHydrationData=null}function zh(e,t,s,i,n,r,a,o,l){return e=new Bh(e,t,s,o,l),1===t?(t=1,!0===r&&(t|=8)):t=0,r=Ah(3,null,null,t),e.current=r,r.stateNode=e,r.memoizedState={element:i,isDehydrated:s,cache:null,transitions:null,pendingSuspenseBoundaries:null},Ir(r),e}function Nh(e){if(!e)return Tn;e:{if(Ue(e=e._reactInternals)!==e||1!==e.tag)throw Error(s(170));var t=e;do{switch(t.tag){case 3:t=t.stateNode.context;break e;case 1:if(Mn(t.type)){t=t.stateNode.__reactInternalMemoizedMergedChildContext;break e}}t=t.return}while(null!==t);throw Error(s(171))}if(1===e.tag){var i=e.type;if(Mn(i))return Ln(e,i,t)}return t}function Uh(e,t,s,i,n,r,a,o,l){return(e=zh(s,i,!0,e,0,r,0,o,l)).context=Nh(null),s=e.current,(r=Or(i=Jl(),n=Zl(s))).callback=null!=t?t:null,Br(s,r,n),e.current.lanes=n,mt(e,n,i),th(e,i),e}function Vh(e,t,s,i){var n=t.current,r=Jl(),a=Zl(n);return s=Nh(s),null===t.context?t.context=s:t.pendingContext=s,(t=Or(r,a)).payload={element:e},null!==(i=void 0===i?null:i)&&(t.callback=i),null!==(e=Br(n,t,a))&&(eh(e,n,a,r),zr(e,n,a)),a}function Gh(e){return(e=e.current).child?(e.child.tag,e.child.stateNode):null}function Hh(e,t){if(null!==(e=e.memoizedState)&&null!==e.dehydrated){var s=e.retryLane;e.retryLane=0!==s&&s<t?s:t}}function jh(e,t){Hh(e,t),(e=e.alternate)&&Hh(e,t)}xl=function(e,t,i){if(null!==e)if(e.memoizedProps!==t.pendingProps||Pn.current)_o=!0;else{if(!(e.lanes&i||128&t.flags))return _o=!1,function(e,t,s){switch(t.tag){case 3:Po(t),dr();break;case 5:Kr(t);break;case 1:Mn(t.type)&&In(t);break;case 4:qr(t,t.stateNode.containerInfo);break;case 10:var i=t.type._context,n=t.memoizedProps.value;Cn(yr,i._currentValue),i._currentValue=n;break;case 13:if(null!==(i=t.memoizedState))return null!==i.dehydrated?(Cn(Qr,1&Qr.current),t.flags|=128,null):s&t.child.childLanes?Fo(e,t,s):(Cn(Qr,1&Qr.current),null!==(e=Go(e,t,s))?e.sibling:null);Cn(Qr,1&Qr.current);break;case 19:if(i=!!(s&t.childLanes),128&e.flags){if(i)return Uo(e,t,s);t.flags|=128}if(null!==(n=t.memoizedState)&&(n.rendering=null,n.tail=null,n.lastEffect=null),Cn(Qr,Qr.current),i)break;return null;case 22:case 23:return t.lanes=0,wo(e,t,s)}return Go(e,t,s)}(e,t,i);_o=!!(131072&e.flags)}else _o=!1,sr&&1048576&t.flags&&Qn(t,jn,t.index);switch(t.lanes=0,t.tag){case 2:var n=t.type;Vo(e,t),e=t.pendingProps;var r=An(t,En.current);Pr(t,i),r=pa(null,t,n,e,r,i);var a=fa();return t.flags|=1,"object"==typeof r&&null!==r&&"function"==typeof r.render&&void 0===r.$$typeof?(t.tag=1,t.memoizedState=null,t.updateQueue=null,Mn(n)?(a=!0,In(t)):a=!1,t.memoizedState=null!==r.state&&void 0!==r.state?r.state:null,Ir(t),r.updater=to,t.stateNode=r,r._reactInternals=t,ro(t,n,e,i),t=Eo(null,t,n,!0,a,i)):(t.tag=0,sr&&a&&Jn(t),vo(null,t,r,i),t=t.child),t;case 16:n=t.elementType;e:{switch(Vo(e,t),e=t.pendingProps,n=(r=n._init)(n._payload),t.type=n,r=t.tag=function(e){if("function"==typeof e)return Mh(e)?1:0;if(null!=e){if((e=e.$$typeof)===E)return 11;if(e===A)return 14}return 2}(n),e=Za(n,e),r){case 0:t=Co(null,t,n,e,i);break e;case 1:t=To(null,t,n,e,i);break e;case 11:t=bo(null,t,n,e,i);break e;case 14:t=yo(null,t,n,Za(n.type,e),i);break e}throw Error(s(306,n,""))}return t;case 0:return n=t.type,r=t.pendingProps,Co(e,t,n,r=t.elementType===n?r:Za(n,r),i);case 1:return n=t.type,r=t.pendingProps,To(e,t,n,r=t.elementType===n?r:Za(n,r),i);case 3:e:{if(Po(t),null===e)throw Error(s(387));n=t.pendingProps,r=(a=t.memoizedState).element,Fr(e,t),Ur(t,n,null,i);var o=t.memoizedState;if(n=o.element,a.isDehydrated){if(a={element:n,isDehydrated:!1,cache:o.cache,pendingSuspenseBoundaries:o.pendingSuspenseBoundaries,transitions:o.transitions},t.updateQueue.baseState=a,t.memoizedState=a,256&t.flags){t=ko(e,t,n,i,r=ao(Error(s(423)),t));break e}if(n!==r){t=ko(e,t,n,i,r=ao(Error(s(424)),t));break e}for(tr=on(t.stateNode.containerInfo.firstChild),er=t,sr=!0,ir=null,i=br(t,null,n,i),t.child=i;i;)i.flags=-3&i.flags|4096,i=i.sibling}else{if(dr(),n===r){t=Go(e,t,i);break e}vo(e,t,n,i)}t=t.child}return t;case 5:return Kr(t),null===e&&or(t),n=t.type,r=t.pendingProps,a=null!==e?e.memoizedProps:null,o=r.children,Zi(n,r)?o=null:null!==a&&Zi(n,a)&&(t.flags|=32),So(e,t),vo(e,t,o,i),t.child;case 6:return null===e&&or(t),null;case 13:return Fo(e,t,i);case 4:return qr(t,t.stateNode.containerInfo),n=t.pendingProps,null===e?t.child=vr(t,null,n,i):vo(e,t,n,i),t.child;case 11:return n=t.type,r=t.pendingProps,bo(e,t,n,r=t.elementType===n?r:Za(n,r),i);case 7:return vo(e,t,t.pendingProps,i),t.child;case 8:case 12:return vo(e,t,t.pendingProps.children,i),t.child;case 10:e:{if(n=t.type._context,r=t.pendingProps,a=t.memoizedProps,o=r.value,Cn(yr,n._currentValue),n._currentValue=o,null!==a)if(ni(a.value,o)){if(a.children===r.children&&!Pn.current){t=Go(e,t,i);break e}}else for(null!==(a=t.child)&&(a.return=t);null!==a;){var l=a.dependencies;if(null!==l){o=a.child;for(var h=l.firstContext;null!==h;){if(h.context===n){if(1===a.tag){(h=Or(-1,i&-i)).tag=2;var c=a.updateQueue;if(null!==c){var d=(c=c.shared).pending;null===d?h.next=h:(h.next=d.next,d.next=h),c.pending=h}}a.lanes|=i,null!==(h=a.alternate)&&(h.lanes|=i),Er(a.return,i,t),l.lanes|=i;break}h=h.next}}else if(10===a.tag)o=a.type===t.type?null:a.child;else if(18===a.tag){if(null===(o=a.return))throw Error(s(341));o.lanes|=i,null!==(l=o.alternate)&&(l.lanes|=i),Er(o,i,t),o=a.sibling}else o=a.child;if(null!==o)o.return=a;else for(o=a;null!==o;){if(o===t){o=null;break}if(null!==(a=o.sibling)){a.return=o.return,o=a;break}o=o.return}a=o}vo(e,t,r.children,i),t=t.child}return t;case 9:return r=t.type,n=t.pendingProps.children,Pr(t,i),n=n(r=kr(r)),t.flags|=1,vo(e,t,n,i),t.child;case 14:return r=Za(n=t.type,t.pendingProps),yo(e,t,n,r=Za(n.type,r),i);case 15:return xo(e,t,t.type,t.pendingProps,i);case 17:return n=t.type,r=t.pendingProps,r=t.elementType===n?r:Za(n,r),Vo(e,t),t.tag=1,Mn(n)?(e=!0,In(t)):e=!1,Pr(t,i),io(t,n,r),ro(t,n,r,i),Eo(null,t,n,!0,e,i);case 19:return Uo(e,t,i);case 22:return wo(e,t,i)}throw Error(s(156,t.tag))};var Wh="function"==typeof reportError?reportError:function(e){console.error(e)};function $h(e){this._internalRoot=e}function qh(e){this._internalRoot=e}function Xh(e){return!(!e||1!==e.nodeType&&9!==e.nodeType&&11!==e.nodeType)}function Kh(e){return!(!e||1!==e.nodeType&&9!==e.nodeType&&11!==e.nodeType&&(8!==e.nodeType||" react-mount-point-unstable "!==e.nodeValue))}function Yh(){}function Qh(e,t,s,i,n){var r=s._reactRootContainer;if(r){var a=r;if("function"==typeof n){var o=n;n=function(){var e=Gh(a);o.call(e)}}Vh(t,a,e,n)}else a=function(e,t,s,i,n){if(n){if("function"==typeof i){var r=i;i=function(){var e=Gh(a);r.call(e)}}var a=Uh(t,i,e,0,null,!1,0,"",Yh);return e._reactRootContainer=a,e[un]=a.current,Ni(8===e.nodeType?e.parentNode:e),lh(),a}for(;n=e.lastChild;)e.removeChild(n);if("function"==typeof i){var o=i;i=function(){var e=Gh(l);o.call(e)}}var l=zh(e,0,!1,null,0,!1,0,"",Yh);return e._reactRootContainer=l,e[un]=l.current,Ni(8===e.nodeType?e.parentNode:e),lh((function(){Vh(t,l,s,i)})),l}(s,t,e,n,i);return Gh(a)}qh.prototype.render=$h.prototype.render=function(e){var t=this._internalRoot;if(null===t)throw Error(s(409));Vh(e,t,null,null)},qh.prototype.unmount=$h.prototype.unmount=function(){var e=this._internalRoot;if(null!==e){this._internalRoot=null;var t=e.containerInfo;lh((function(){Vh(null,e,null,null)})),t[un]=null}},qh.prototype.unstable_scheduleHydration=function(e){if(e){var t=wt();e={blockedOn:null,target:e,priority:t};for(var s=0;s<Dt.length&&0!==t&&t<Dt[s].priority;s++);Dt.splice(s,0,e),0===s&&Ft(e)}},bt=function(e){switch(e.tag){case 3:var t=e.stateNode;if(t.current.memoizedState.isDehydrated){var s=ht(t.pendingLanes);0!==s&&(gt(t,1|s),th(t,Ke()),!(6&El)&&(Ul=Ke()+500,Un()))}break;case 13:lh((function(){var t=Rr(e,1);if(null!==t){var s=Jl();eh(t,e,1,s)}})),jh(e,1)}},yt=function(e){if(13===e.tag){var t=Rr(e,134217728);if(null!==t)eh(t,e,134217728,Jl());jh(e,134217728)}},xt=function(e){if(13===e.tag){var t=Zl(e),s=Rr(e,t);if(null!==s)eh(s,e,t,Jl());jh(e,t)}},wt=function(){return _t},St=function(e,t){var s=_t;try{return _t=e,t()}finally{_t=s}},ye=function(e,t,i){switch(t){case"input":if(Y(e,i),t=i.name,"radio"===i.type&&null!=t){for(i=e;i.parentNode;)i=i.parentNode;for(i=i.querySelectorAll("input[name="+JSON.stringify(""+t)+'][type="radio"]'),t=0;t<i.length;t++){var n=i[t];if(n!==e&&n.form===e.form){var r=bn(n);if(!r)throw Error(s(90));W(n),Y(n,r)}}}break;case"textarea":ie(e,i);break;case"select":null!=(t=i.value)&&ee(e,!!i.multiple,t,!1)}},Ee=oh,Pe=lh;var Jh={usingClientEntryPoint:!1,Events:[_n,vn,bn,Ce,Te,oh]},Zh={findFiberByHostInstance:gn,bundleType:0,version:"18.3.1",rendererPackageName:"react-dom"},ec={bundleType:Zh.bundleType,version:Zh.version,rendererPackageName:Zh.rendererPackageName,rendererConfig:Zh.rendererConfig,overrideHookState:null,overrideHookStateDeletePath:null,overrideHookStateRenamePath:null,overrideProps:null,overridePropsDeletePath:null,overridePropsRenamePath:null,setErrorHandler:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:v.ReactCurrentDispatcher,findHostInstanceByFiber:function(e){return null===(e=He(e))?null:e.stateNode},findFiberByHostInstance:Zh.findFiberByHostInstance,findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null,reconcilerVersion:"18.3.1-next-f1338f8080-20240426"};if("undefined"!=typeof __REACT_DEVTOOLS_GLOBAL_HOOK__){var tc=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!tc.isDisabled&&tc.supportsFiber)try{st=tc.inject(ec),it=tc}catch(le){}}return cy.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=Jh,cy.createPortal=function(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;if(!Xh(t))throw Error(s(200));return function(e,t,s){var i=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;return{$$typeof:y,key:null==i?null:""+i,children:e,containerInfo:t,implementation:s}}(e,t,null,i)},cy.createRoot=function(e,t){if(!Xh(e))throw Error(s(299));var i=!1,n="",r=Wh;return null!=t&&(!0===t.unstable_strictMode&&(i=!0),void 0!==t.identifierPrefix&&(n=t.identifierPrefix),void 0!==t.onRecoverableError&&(r=t.onRecoverableError)),t=zh(e,1,!1,null,0,i,0,n,r),e[un]=t.current,Ni(8===e.nodeType?e.parentNode:e),new $h(t)},cy.findDOMNode=function(e){if(null==e)return null;if(1===e.nodeType)return e;var t=e._reactInternals;if(void 0===t){if("function"==typeof e.render)throw Error(s(188));throw e=Object.keys(e).join(","),Error(s(268,e))}return e=null===(e=He(t))?null:e.stateNode},cy.flushSync=function(e){return lh(e)},cy.hydrate=function(e,t,i){if(!Kh(t))throw Error(s(200));return Qh(null,e,t,!0,i)},cy.hydrateRoot=function(e,t,i){if(!Xh(e))throw Error(s(405));var n=null!=i&&i.hydratedSources||null,r=!1,a="",o=Wh;if(null!=i&&(!0===i.unstable_strictMode&&(r=!0),void 0!==i.identifierPrefix&&(a=i.identifierPrefix),void 0!==i.onRecoverableError&&(o=i.onRecoverableError)),t=Uh(t,null,e,1,null!=i?i:null,r,0,a,o),e[un]=t.current,Ni(e),n)for(e=0;e<n.length;e++)r=(r=(i=n[e])._getVersion)(i._source),null==t.mutableSourceEagerHydrationData?t.mutableSourceEagerHydrationData=[i,r]:t.mutableSourceEagerHydrationData.push(i,r);return new qh(t)},cy.render=function(e,t,i){if(!Kh(t))throw Error(s(200));return Qh(null,e,t,!1,i)},cy.unmountComponentAtNode=function(e){if(!Kh(e))throw Error(s(40));return!!e._reactRootContainer&&(lh((function(){Qh(null,null,e,!1,(function(){e._reactRootContainer=null,e[un]=null}))})),!0)},cy.unstable_batchedUpdates=oh,cy.unstable_renderSubtreeIntoContainer=function(e,t,i,n){if(!Kh(i))throw Error(s(200));if(null==e||void 0===e._reactInternals)throw Error(s(38));return Qh(e,t,i,!1,n)},cy.version="18.3.1-next-f1338f8080-20240426",cy}function gy(){if(ly)return hy.exports;return ly=1,function e(){if("undefined"!=typeof __REACT_DEVTOOLS_GLOBAL_HOOK__&&"function"==typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE)try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(e)}catch(e){console.error(e)}}(),hy.exports=my(),hy.exports}var _y=n(gy());const vy=e=>u.createElement(We,{class:"pcui-error",title:"Error",hidden:!e.observerData.ui.error,text:e.observerData.ui.error,icon:"E218"}),by=(e,t,s=2)=>{let i,n;const r=e=>{i=e.pageX,n=e.pageY};e.addEventListener("mousedown",r);const a=e=>{const r=Math.abs(e.pageX-i),a=Math.abs(e.pageY-n);r<s&&a<s&&t(e)};return e.addEventListener("mouseup",a),()=>{e.removeEventListener("mousedown",r),e.removeEventListener("mouseup",a)}},yy=(e,t)=>{const s=(e,t)=>{for(const s of t){if(!e.hasOwnProperty(s))return null;e=e[s]}return e},i={};for(const n of t){const t=n.split("."),r=s(e,t);let a=i;for(let e=0;e<t.length;++e){const s=t[e];e<t.length-1?(a.hasOwnProperty(s)||(a[s]={}),a=a[s]):a[s]=r}}return i},xy=e=>u.createElement(ve,{class:"panel-option"},u.createElement($e,{class:"panel-label",text:e.label}),u.createElement($e,{class:"panel-value",text:String(e.value)})),wy=e=>u.createElement(ve,{class:"panel-option",enabled:e.enabled??!0},u.createElement($e,{class:"panel-label",text:e.label}),u.createElement(At,{class:"panel-value",dimensions:e.dimensions,value:e.value,precision:7})),Sy=e=>u.createElement(ve,{class:"panel-option",enabled:e.enabled??!0},u.createElement($e,{class:"panel-label",text:e.label}),u.createElement(re,{class:"panel-value-boolean",type:"toggle",value:e.value,onChange:t=>e.setProperty(t)})),Cy=e=>u.createElement(ve,{class:"panel-option"},u.createElement($e,{class:"panel-label",text:e.label}),u.createElement(ve,{class:"panel-value"},u.createElement(re,{type:"toggle",value:e.booleanValue,onChange:t=>e.setBooleanProperty(t)}),u.createElement(_e,{class:"panel-value-toggle-color",value:e.colorValue,onChange:t=>e.setColorProperty(t)}))),Ty=e=>u.createElement(ve,{class:"panel-option",enabled:e.enabled??!0},u.createElement($e,{class:"panel-label",text:e.label}),u.createElement(nt,{class:"panel-value",min:e.min,max:e.max,sliderMin:e.min,sliderMax:e.max,precision:e.precision,step:e.step??.01,onChange:t=>{e.setProperty(t)},value:e.value})),Ey=e=>u.createElement(ve,{class:"panel-option",enabled:e.enabled??!0},u.createElement($e,{class:"panel-label",text:e.label}),u.createElement(qe,{class:"panel-value",min:e.min,max:e.max,onChange:t=>{e.setProperty(t)},value:e.value})),Py=e=>u.createElement(ve,{class:"panel-option",hidden:e.hidden,enabled:e.enabled??!0},u.createElement($e,{class:"panel-label",text:e.label}),u.createElement(_e,{class:"panel-value",value:e.value,onChange:t=>e.setProperty(t)})),ky=e=>u.createElement(ve,{class:"panel-option",enabled:e.enabled??!0},u.createElement($e,{class:"morph-label",flexGrow:"1",flexShrink:"1",text:e.label?e.label:e.name.substring(0,1).toUpperCase()+e.name.substring(1,e.name.length),flex:!0}),u.createElement(nt,{class:"morph-value",flexGrow:"0",flexShrink:"0",min:e.min,max:e.max,sliderMin:e.min,sliderMax:e.max,precision:e.precision,step:.01,onChange:t=>{e.setProperty(t)},value:e.value})),Ay=e=>u.createElement(ve,{class:"panel-option",enabled:e.enabled??!0},u.createElement($e,{class:"panel-label",text:e.label}),u.createElement(Ke,{class:"panel-value",type:e.type,options:e.options,value:e.value,onChange:t=>{e.setProperty(t)}})),My=e=>u.createElement(Ke,{id:e.id,class:e.class,width:e.width,type:e.type,options:e.options,enabled:e.enabled??!0,value:e.value,onChange:t=>{e.setProperty(t)}}),Dy=e=>u.createElement(nt,{id:e.id,class:e.class,width:e.width,min:e.min,max:e.max,sliderMin:e.min,sliderMax:e.max,precision:e.precision,step:.01,enabled:e.enabled??!0,value:e.value,onChange:t=>{e.setProperty(t)}});var Ry,Ly={exports:{}};function Iy(){return Ry?Ly.exports:(Ry=1,e=function(e,t){return function(e){var t={};function s(i){if(t[i])return t[i].exports;var n=t[i]={i:i,l:!1,exports:{}};return e[i].call(n.exports,n,n.exports,s),n.l=!0,n.exports}return s.m=e,s.c=t,s.d=function(e,t,i){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)s.d(i,n,function(t){return e[t]}.bind(null,n));return i},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=4)}([function(e,t,s){e.exports=s(5)()},function(t,s){t.exports=e},function(e,s){e.exports=t},function(e,t){e.exports=function(e,t,s){var i=e.direction,n=e.value;switch(i){case"top":return s.top+n<t.top&&s.bottom>t.bottom&&s.left<t.left&&s.right>t.right;case"left":return s.left+n<t.left&&s.bottom>t.bottom&&s.top<t.top&&s.right>t.right;case"bottom":return s.bottom-n>t.bottom&&s.left<t.left&&s.right>t.right&&s.top<t.top;case"right":return s.right-n>t.right&&s.left<t.left&&s.top<t.top&&s.bottom>t.bottom}}},function(e,t,s){s.r(t),s.d(t,"default",(function(){return _}));var i=s(1),n=s.n(i),r=s(2),a=s.n(r),o=s(0),l=s.n(o),h=s(3),c=s.n(h);function d(e){return d="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},d(e)}function u(e,t,s){return function(e,t){for(var s=0;s<t.length;s++){var i=t[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}(e.prototype,t),e}function p(e){return p=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},p(e)}function f(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function m(e,t){return m=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},m(e,t)}function g(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}var _=function(e){function t(e){var s;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),s=function(e,t){return!t||"object"!==d(t)&&"function"!=typeof t?f(e):t}(this,p(t).call(this,e)),g(f(s),"getContainer",(function(){return s.props.containment||window})),g(f(s),"addEventListener",(function(e,t,i,n){var r;s.debounceCheck||(s.debounceCheck={});var a=function(){r=null,s.check()},o={target:e,fn:n>-1?function(){r||(r=setTimeout(a,n||0))}:function(){clearTimeout(r),r=setTimeout(a,i||0)},getLastTimeout:function(){return r}};e.addEventListener(t,o.fn),s.debounceCheck[t]=o})),g(f(s),"startWatching",(function(){s.debounceCheck||s.interval||(s.props.intervalCheck&&(s.interval=setInterval(s.check,s.props.intervalDelay)),s.props.scrollCheck&&s.addEventListener(s.getContainer(),"scroll",s.props.scrollDelay,s.props.scrollThrottle),s.props.resizeCheck&&s.addEventListener(window,"resize",s.props.resizeDelay,s.props.resizeThrottle),!s.props.delayedCall&&s.check())})),g(f(s),"stopWatching",(function(){if(s.debounceCheck)for(var e in s.debounceCheck)if(s.debounceCheck.hasOwnProperty(e)){var t=s.debounceCheck[e];clearTimeout(t.getLastTimeout()),t.target.removeEventListener(e,t.fn),s.debounceCheck[e]=null}s.debounceCheck=null,s.interval&&(s.interval=clearInterval(s.interval))})),g(f(s),"check",(function(){var e,t,i=s.node;if(!i)return s.state;if(e=function(e){return void 0===e.width&&(e.width=e.right-e.left),void 0===e.height&&(e.height=e.bottom-e.top),e}(s.roundRectDown(i.getBoundingClientRect())),s.props.containment){var n=s.props.containment.getBoundingClientRect();t={top:n.top,left:n.left,bottom:n.bottom,right:n.right}}else t={top:0,left:0,bottom:window.innerHeight||document.documentElement.clientHeight,right:window.innerWidth||document.documentElement.clientWidth};var r=s.props.offset||{};"object"===d(r)&&(t.top+=r.top||0,t.left+=r.left||0,t.bottom-=r.bottom||0,t.right-=r.right||0);var a={top:e.top>=t.top,left:e.left>=t.left,bottom:e.bottom<=t.bottom,right:e.right<=t.right},o=e.height>0&&e.width>0,l=o&&a.top&&a.left&&a.bottom&&a.right;if(o&&s.props.partialVisibility){var h=e.top<=t.bottom&&e.bottom>=t.top&&e.left<=t.right&&e.right>=t.left;"string"==typeof s.props.partialVisibility&&(h=a[s.props.partialVisibility]),l=s.props.minTopValue?h&&e.top<=t.bottom-s.props.minTopValue:h}"string"==typeof r.direction&&"number"==typeof r.value&&(console.warn("[notice] offset.direction and offset.value have been deprecated. They still work for now, but will be removed in next major version. Please upgrade to the new syntax: { %s: %d }",r.direction,r.value),l=c()(r,e,t));var u=s.state;return s.state.isVisible!==l&&(u={isVisible:l,visibilityRect:a},s.setState(u),s.props.onChange&&s.props.onChange(l)),u})),s.state={isVisible:null,visibilityRect:{}},s}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&m(e,t)}(t,e),u(t,[{key:"componentDidMount",value:function(){this.node=a.a.findDOMNode(this),this.props.active&&this.startWatching()}},{key:"componentWillUnmount",value:function(){this.stopWatching()}},{key:"componentDidUpdate",value:function(e){this.node=a.a.findDOMNode(this),this.props.active&&!e.active?(this.setState({isVisible:null,visibilityRect:{}}),this.startWatching()):this.props.active||this.stopWatching()}},{key:"roundRectDown",value:function(e){return{top:Math.floor(e.top),left:Math.floor(e.left),bottom:Math.floor(e.bottom),right:Math.floor(e.right)}}},{key:"render",value:function(){return this.props.children instanceof Function?this.props.children({isVisible:this.state.isVisible,visibilityRect:this.state.visibilityRect}):n.a.Children.only(this.props.children)}}]),t}(n.a.Component);g(_,"defaultProps",{active:!0,partialVisibility:!1,minTopValue:0,scrollCheck:!1,scrollDelay:250,scrollThrottle:-1,resizeCheck:!1,resizeDelay:250,resizeThrottle:-1,intervalCheck:!0,intervalDelay:100,delayedCall:!1,offset:{},containment:null,children:n.a.createElement("span",null)}),g(_,"propTypes",{onChange:l.a.func,active:l.a.bool,partialVisibility:l.a.oneOfType([l.a.bool,l.a.oneOf(["top","right","bottom","left"])]),delayedCall:l.a.bool,offset:l.a.oneOfType([l.a.shape({top:l.a.number,left:l.a.number,bottom:l.a.number,right:l.a.number}),l.a.shape({direction:l.a.oneOf(["top","right","bottom","left"]),value:l.a.number})]),scrollCheck:l.a.bool,scrollDelay:l.a.number,scrollThrottle:l.a.number,resizeCheck:l.a.bool,resizeDelay:l.a.number,resizeThrottle:l.a.number,intervalCheck:l.a.bool,intervalDelay:l.a.number,containment:"undefined"!=typeof window?l.a.instanceOf(window.Element):l.a.any,children:l.a.oneOfType([l.a.element,l.a.func]),minTopValue:l.a.number})},function(e,t,s){var i=s(6);function n(){}function r(){}r.resetWarningCache=n,e.exports=function(){function e(e,t,s,n,r,a){if(a!==i){var o=new Error("Calling PropTypes validators directly is not supported by the `prop-types` package. Use PropTypes.checkPropTypes() to call them. Read more at http://fb.me/use-check-prop-types");throw o.name="Invariant Violation",o}}function t(){return e}e.isRequired=e;var s={array:e,bool:e,func:e,number:e,object:e,string:e,symbol:e,any:e,arrayOf:t,element:e,elementType:e,instanceOf:t,node:e,objectOf:t,oneOf:t,oneOfType:t,shape:t,exact:t,checkPropTypes:r,resetWarningCache:n};return s.PropTypes=s,s}},function(e,t,s){e.exports="SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED"}])},Ly.exports=e(c(),gy()));var e}var Fy=n(Iy());class Oy extends u.Component{shouldComponentUpdate(e){return JSON.stringify(e.morphs)!==JSON.stringify(this.props.morphs)}render(){const e=this.props.morphs;return e?u.createElement(Xe,{headerText:"MORPH TARGETS",class:"scene-morph-panel",collapsible:!1},Object.keys(e).map((t=>{const s=e[t];return u.createElement("div",{key:`${t}.${s.name}`},u.createElement(Xe,{headerText:s.name,collapsible:!0,class:"morph-target-panel"},Object.keys(s.targets).map((e=>{const i=s.targets[e];return u.createElement("div",{key:e},u.createElement(Fy,{offset:{top:-750,bottom:-750}},(({isVisible:s})=>u.createElement("div",null,s?u.createElement(ky,{name:`${i.name}`,precision:2,min:0,max:1,value:i.weight,setProperty:s=>this.props.setProperty(`morphs.${t}.targets.${e}.weight`,s)}):u.createElement("div",{style:{width:30,height:30}})))))}))))}))):null}}const By=()=>{const e=document.getElementById("panel-left");e&&e.classList.toggle("collapsed")};let zy;const Ny=e=>{const t=["Bytes","KB","MB","GB","TB"];if(0===e)return"n/a";const s=Math.min(Math.floor(Math.log(e)/Math.log(1024)),t.length-1);return 0===s?`${e} ${t[s]}`:`${(e/1024**s).toFixed(1)} ${t[s]}`};class Uy extends u.Component{shouldComponentUpdate(e){return JSON.stringify(e.sceneData.filenames)!==JSON.stringify(this.props.sceneData.filenames)||e.sceneData.loadTime!==this.props.sceneData.loadTime||e.sceneData.meshCount!==this.props.sceneData.meshCount||e.sceneData.vertexCount!==this.props.sceneData.vertexCount||e.sceneData.primitiveCount!==this.props.sceneData.primitiveCount||e.sceneData.materialCount!==this.props.sceneData.materialCount||e.sceneData.textureVRAM!==this.props.sceneData.textureVRAM||e.sceneData.meshVRAM!==this.props.sceneData.meshVRAM||e.sceneData.bounds!==this.props.sceneData.bounds||e.sceneData.variant.selected!==this.props.sceneData.variant.selected||e.sceneData.variants.list!==this.props.sceneData.variants.list}render(){const e=this.props.sceneData,t=JSON.parse(e.variants.list).map((e=>({v:e,t:e})));return u.createElement(Xe,{headerText:"SCENE",id:"scene-panel",flexShrink:"0",flexGrow:"0",collapsible:!1},u.createElement(xy,{label:"Filename",value:e.filenames.join(", ")}),u.createElement(xy,{label:"Meshes",value:e.meshCount}),u.createElement(xy,{label:"Materials",value:e.materialCount}),u.createElement(xy,{label:"Textures",value:e.textureCount}),u.createElement(xy,{label:"Primitives",value:e.primitiveCount}),u.createElement(xy,{label:"Verts",value:e.vertexCount}),u.createElement(xy,{label:"Mesh VRAM",value:Ny(e.meshVRAM)}),u.createElement(xy,{label:"Texture VRAM",value:Ny(e.textureVRAM)}),u.createElement(xy,{label:"Load time",value:e.loadTime}),u.createElement(wy,{label:"Bounds",dimensions:3,value:e.bounds,enabled:!1}),u.createElement(Ay,{label:"Variant",type:"string",options:t,value:e.variant.selected,setProperty:e=>{this.props.setProperty("scene.variant.selected",e)},enabled:t.length>0}))}}class Vy extends u.Component{shouldComponentUpdate(e){return e.sceneData.nodes!==this.props.sceneData.nodes}render(){const e=this.props.sceneData,t=JSON.parse(e.nodes),s=e=>e.map((e=>u.createElement(Pt,{text:`${e.name}`,key:e.path,onSelect:t=>{this.props.setProperty("scene.selectedNode.path",e.path);const s=by(document.body,(()=>{t.selected=!1,s()}),4)},onDeselect:()=>this.props.setProperty("scene.selectedNode.path","")},s(e.children))));return u.createElement(Xe,{headerText:"HIERARCHY",class:"scene-hierarchy-panel",enabled:t.length>0,collapsible:!1},t.length>0&&u.createElement(Et,{allowReordering:!1,allowDrag:!1},s(t)))}}class Gy extends u.Component{shouldComponentUpdate(e){return JSON.stringify(e.observerData.runtime)!==JSON.stringify(this.props.observerData.runtime)||e.observerData.enableWebGPU!==this.props.observerData.enableWebGPU}render(){const e=this.props.observerData.runtime;return u.createElement(Xe,{headerText:"DEVICE",id:"device-panel",collapsible:!1},u.createElement(Sy,{label:"Use WebGPU",value:this.props.observerData.enableWebGPU,enabled:void 0!==navigator.gpu,setProperty:e=>this.props.setProperty("enableWebGPU",e)}),u.createElement(xy,{label:"Active Device",value:"webgpu"===e.activeDeviceType?"webgpu (beta)":e.activeDeviceType}),u.createElement(xy,{label:"Viewport",value:`${e.viewportWidth} x ${e.viewportHeight}`}))}}class Hy extends u.Component{isMobile;constructor(e){super(e),this.isMobile=/Android|webOS|iPhone|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}shouldComponentUpdate(e){return JSON.stringify(e.observerData.scene)!==JSON.stringify(this.props.observerData.scene)||JSON.stringify(e.observerData.runtime)!==JSON.stringify(this.props.observerData.runtime)}componentDidMount(){document.getElementById("panel-toggle").addEventListener("click",(()=>{By()})),document.getElementById("title").addEventListener("click",(()=>{By()})),setTimeout((()=>By()))}componentDidUpdate(e){this.isMobile||this.props.observerData.ui.fullscreen||"[]"===this.props.observerData.scene.nodes||"[]"!==e.observerData.scene.nodes||(zy||(zy=document.getElementById("panel-left")),zy&&zy.classList.contains("collapsed")&&zy.classList.remove("collapsed"))}render(){const e=this.props.observerData.scene,t=this.props.observerData.morphs;return u.createElement(ve,{id:"scene-container",flex:!0},u.createElement(Uy,{sceneData:e,setProperty:this.props.setProperty}),u.createElement("div",{id:"scene-scrolly-bits"},u.createElement(Vy,{sceneData:e,setProperty:this.props.setProperty}),u.createElement(Oy,{progress:this.props.observerData.animation.progress,morphs:t,setProperty:this.props.setProperty})),u.createElement(Gy,{observerData:this.props.observerData,setProperty:this.props.setProperty}))}}var jy="5.2.0";const Wy=e=>{const[t,s]=d.useState(!1),i=d.useRef(null);return u.createElement("div",{id:"load-controls"},u.createElement(ve,{class:"load-button-panel",enabled:!0,flex:!0},u.createElement("div",{className:"header"},u.createElement("img",{src:"static/playcanvas-logo.png"}),u.createElement("div",null,u.createElement($e,{text:`MODEL VIEWER v${jy}`})),u.createElement(ae,{onClick:()=>{window.open("https://github.com/playcanvas/model-viewer","_blank").focus()},icon:"E259"})),u.createElement("input",{type:"file",id:"file",accept:".glb,.gltf,.ply",multiple:!0,onChange:e=>{const t=window.viewer,s=e.target.files;if(t&&s.length){const e=[];for(let t=0;t<s.length;++t){const i=s[t];e.push({url:URL.createObjectURL(i),filename:i.name})}t.loadFiles(e)}},ref:i,style:{display:"none"}}),u.createElement("div",{id:"drag-drop",onClick:()=>{i.current.click()}},u.createElement(ae,{id:"drag-drop-search-icon",icon:"E129"}),u.createElement($e,{class:"desktop",text:"Drag & drop .glb, .gltf, or .ply files, or click to open files"}),u.createElement($e,{class:"mobile",text:"Click to open files"})),u.createElement($e,{id:"or-text",text:"OR",class:"centered-label"}),u.createElement(ot,{class:"secondary",id:"glb-url-input",placeholder:"Enter .glb, .gltf, or .ply URL",keyChange:!0,onValidate:e=>{const t=(e=>{try{return new URL(e),!0}catch{return!1}})(e);return s(t),t}}),u.createElement(ae,{class:"secondary",id:"glb-url-button",text:"LOAD MODEL FROM URL",onClick:()=>{const e=window.viewer,t=document.getElementById("glb-url-input").ui.value,s=new URL(t).pathname.split("/").pop(),i=!!s.split(".").splice(1).pop();e.loadFiles([{url:t,filename:s+(i?"":".glb")}])},enabled:t})))};class $y extends u.Component{shouldComponentUpdate(e){return e.animationData.list!==this.props.animationData.list||e.animationData.playing!==this.props.animationData.playing||e.animationData.selectedTrack!==this.props.animationData.selectedTrack}render(){const e=this.props,t=JSON.parse(e.animationData.list).map((e=>({v:e,t:e})));return u.createElement(My,{id:"anim-track-select",width:160,type:"string",options:t,setProperty:t=>e.setProperty("animation.selectedTrack",t),value:e.animationData.selectedTrack})}}class qy extends u.Component{shouldComponentUpdate(e){return e.animationData.speed!==this.props.animationData.speed}render(){const e=this.props;return u.createElement(My,{id:"anim-speed-select",width:60,type:"string",setProperty:t=>e.setProperty("animation.speed",t),value:e.animationData.speed,options:[{v:"0.25",t:"0.25x"},{v:"0.5",t:"0.5x"},{v:"1",t:"1x"},{v:"1.5",t:"1.5x"},{v:"2",t:"2x"}]})}}class Xy extends u.Component{animationState;shouldComponentUpdate(e){return JSON.stringify(e.animationData)!==JSON.stringify(this.props.animationData)}componentDidUpdate(){this.animationState=this.props.animationData}render(){const e=this.props;return JSON.parse(e.animationData.list).length>0?u.createElement("div",{className:"animation-controls-panel-parent"},u.createElement(ae,{class:"anim-control-button",width:30,height:30,icon:e.animationData.playing?"E376":"E286",text:"",onClick:()=>{e.setProperty("animation.playing",!this.animationState.playing)}}),u.createElement($y,{animationData:this.props.animationData,setProperty:this.props.setProperty}),u.createElement(Dy,{id:"anim-scrub-slider",width:240,precision:2,min:0,max:1,setProperty:t=>{const s=this.animationState;s.playing=!1,s.progress=t,e.setProperty("animation",s)},value:e.animationData.progress}),u.createElement(qy,{animationData:this.props.animationData,setProperty:this.props.setProperty})):u.createElement("div",null)}}var Ky,Yy={exports:{}};function Qy(){return Ky||(Ky=1,Yy.exports=function(){var e=function(){},t=Object.prototype.hasOwnProperty,s=Array.prototype.slice;function i(t,s){var i;return"function"==typeof Object.create?i=Object.create(t):(e.prototype=t,i=new e,e.prototype=null),s&&r(!0,i,s),i}function n(e,t,s,n){var a=this;return"string"!=typeof e&&(n=s,s=t,t=e,e=null),"function"!=typeof t&&(n=s,s=t,t=function(){return a.apply(this,arguments)}),r(!1,t,a,n),t.prototype=i(a.prototype,s),t.prototype.constructor=t,t.class_=e||a.class_,t.super_=a,t}function r(e,i,n){for(var r,a,o=0,l=(n=s.call(arguments,2)).length;o<l;o++)for(r in a=n[o])e&&!t.call(a,r)||(i[r]=a[r])}var a=n;function o(){}o.class_="Nevis",o.super_=Object,o.extend=a;var l=o,h=l.extend((function(e,t,s){this.qrious=e,this.element=t,this.element.qrious=e,this.enabled=Boolean(s)}),{draw:function(e){},getElement:function(){return this.enabled||(this.enabled=!0,this.render()),this.element},getModuleSize:function(e){var t=this.qrious,s=t.padding||0,i=Math.floor((t.size-2*s)/e.width);return Math.max(1,i)},getOffset:function(e){var t=this.qrious,s=t.padding;if(null!=s)return s;var i=this.getModuleSize(e),n=Math.floor((t.size-i*e.width)/2);return Math.max(0,n)},render:function(e){this.enabled&&(this.resize(),this.reset(),this.draw(e))},reset:function(){},resize:function(){}}),c=h,d=c.extend({draw:function(e){var t,s,i=this.qrious,n=this.getModuleSize(e),r=this.getOffset(e),a=this.element.getContext("2d");for(a.fillStyle=i.foreground,a.globalAlpha=i.foregroundAlpha,t=0;t<e.width;t++)for(s=0;s<e.width;s++)e.buffer[s*e.width+t]&&a.fillRect(n*t+r,n*s+r,n,n)},reset:function(){var e=this.qrious,t=this.element.getContext("2d"),s=e.size;t.lineWidth=1,t.clearRect(0,0,s,s),t.fillStyle=e.background,t.globalAlpha=e.backgroundAlpha,t.fillRect(0,0,s,s)},resize:function(){var e=this.element;e.width=e.height=this.qrious.size}}),u=d,p=l.extend(null,{BLOCK:[0,11,15,19,23,27,31,16,18,20,22,24,26,28,20,22,24,24,26,28,28,22,24,24,26,26,28,28,24,24,26,26,26,28,28,24,26,26,26,28,28]}),f=l.extend(null,{BLOCKS:[1,0,19,7,1,0,16,10,1,0,13,13,1,0,9,17,1,0,34,10,1,0,28,16,1,0,22,22,1,0,16,28,1,0,55,15,1,0,44,26,2,0,17,18,2,0,13,22,1,0,80,20,2,0,32,18,2,0,24,26,4,0,9,16,1,0,108,26,2,0,43,24,2,2,15,18,2,2,11,22,2,0,68,18,4,0,27,16,4,0,19,24,4,0,15,28,2,0,78,20,4,0,31,18,2,4,14,18,4,1,13,26,2,0,97,24,2,2,38,22,4,2,18,22,4,2,14,26,2,0,116,30,3,2,36,22,4,4,16,20,4,4,12,24,2,2,68,18,4,1,43,26,6,2,19,24,6,2,15,28,4,0,81,20,1,4,50,30,4,4,22,28,3,8,12,24,2,2,92,24,6,2,36,22,4,6,20,26,7,4,14,28,4,0,107,26,8,1,37,22,8,4,20,24,12,4,11,22,3,1,115,30,4,5,40,24,11,5,16,20,11,5,12,24,5,1,87,22,5,5,41,24,5,7,24,30,11,7,12,24,5,1,98,24,7,3,45,28,15,2,19,24,3,13,15,30,1,5,107,28,10,1,46,28,1,15,22,28,2,17,14,28,5,1,120,30,9,4,43,26,17,1,22,28,2,19,14,28,3,4,113,28,3,11,44,26,17,4,21,26,9,16,13,26,3,5,107,28,3,13,41,26,15,5,24,30,15,10,15,28,4,4,116,28,17,0,42,26,17,6,22,28,19,6,16,30,2,7,111,28,17,0,46,28,7,16,24,30,34,0,13,24,4,5,121,30,4,14,47,28,11,14,24,30,16,14,15,30,6,4,117,30,6,14,45,28,11,16,24,30,30,2,16,30,8,4,106,26,8,13,47,28,7,22,24,30,22,13,15,30,10,2,114,28,19,4,46,28,28,6,22,28,33,4,16,30,8,4,122,30,22,3,45,28,8,26,23,30,12,28,15,30,3,10,117,30,3,23,45,28,4,31,24,30,11,31,15,30,7,7,116,30,21,7,45,28,1,37,23,30,19,26,15,30,5,10,115,30,19,10,47,28,15,25,24,30,23,25,15,30,13,3,115,30,2,29,46,28,42,1,24,30,23,28,15,30,17,0,115,30,10,23,46,28,10,35,24,30,19,35,15,30,17,1,115,30,14,21,46,28,29,19,24,30,11,46,15,30,13,6,115,30,14,23,46,28,44,7,24,30,59,1,16,30,12,7,121,30,12,26,47,28,39,14,24,30,22,41,15,30,6,14,121,30,6,34,47,28,46,10,24,30,2,64,15,30,17,4,122,30,29,14,46,28,49,10,24,30,24,46,15,30,4,18,122,30,13,32,46,28,48,14,24,30,42,32,15,30,20,4,117,30,40,7,47,28,43,22,24,30,10,67,15,30,19,6,118,30,18,31,47,28,34,34,24,30,20,61,15,30],FINAL_FORMAT:[30660,29427,32170,30877,26159,25368,27713,26998,21522,20773,24188,23371,17913,16590,20375,19104,13663,12392,16177,14854,9396,8579,11994,11245,5769,5054,7399,6608,1890,597,3340,2107],LEVELS:{L:1,M:2,Q:3,H:4}}),m=l.extend(null,{EXPONENT:[1,2,4,8,16,32,64,128,29,58,116,232,205,135,19,38,76,152,45,90,180,117,234,201,143,3,6,12,24,48,96,192,157,39,78,156,37,74,148,53,106,212,181,119,238,193,159,35,70,140,5,10,20,40,80,160,93,186,105,210,185,111,222,161,95,190,97,194,153,47,94,188,101,202,137,15,30,60,120,240,253,231,211,187,107,214,177,127,254,225,223,163,91,182,113,226,217,175,67,134,17,34,68,136,13,26,52,104,208,189,103,206,129,31,62,124,248,237,199,147,59,118,236,197,151,51,102,204,133,23,46,92,184,109,218,169,79,158,33,66,132,21,42,84,168,77,154,41,82,164,85,170,73,146,57,114,228,213,183,115,230,209,191,99,198,145,63,126,252,229,215,179,123,246,241,255,227,219,171,75,150,49,98,196,149,55,110,220,165,87,174,65,130,25,50,100,200,141,7,14,28,56,112,224,221,167,83,166,81,162,89,178,121,242,249,239,195,155,43,86,172,69,138,9,18,36,72,144,61,122,244,245,247,243,251,235,203,139,11,22,44,88,176,125,250,233,207,131,27,54,108,216,173,71,142,0],LOG:[255,0,1,25,2,50,26,198,3,223,51,238,27,104,199,75,4,100,224,14,52,141,239,129,28,193,105,248,200,8,76,113,5,138,101,47,225,36,15,33,53,147,142,218,240,18,130,69,29,181,194,125,106,39,249,185,201,154,9,120,77,228,114,166,6,191,139,98,102,221,48,253,226,152,37,179,16,145,34,136,54,208,148,206,143,150,219,189,241,210,19,92,131,56,70,64,30,66,182,163,195,72,126,110,107,58,40,84,250,133,186,61,202,94,155,159,10,21,121,43,78,212,229,172,115,243,167,87,7,112,192,247,140,128,99,13,103,74,222,237,49,197,254,24,227,165,153,119,38,184,180,124,17,68,146,217,35,32,137,46,55,63,209,91,149,188,207,205,144,135,151,178,220,252,190,97,242,86,211,171,20,42,93,158,132,60,57,83,71,109,65,162,31,45,67,216,183,123,164,118,196,23,73,236,127,12,111,246,108,161,59,82,41,157,85,170,251,96,134,177,187,204,62,90,203,89,95,176,156,169,160,81,11,245,22,235,122,117,44,215,79,174,213,233,230,231,173,232,116,214,244,234,168,80,88,175]}),g=l.extend(null,{BLOCK:[3220,1468,2713,1235,3062,1890,2119,1549,2344,2936,1117,2583,1330,2470,1667,2249,2028,3780,481,4011,142,3098,831,3445,592,2517,1776,2234,1951,2827,1070,2660,1345,3177]}),_=g,v=l.extend((function(e){var t,s,i,n,r,a=e.value.length;for(this._badness=[],this._level=f.LEVELS[e.level],this._polynomial=[],this._value=e.value,this._version=0,this._stringBuffer=[];this._version<40&&(this._version++,i=4*(this._level-1)+16*(this._version-1),n=f.BLOCKS[i++],r=f.BLOCKS[i++],t=f.BLOCKS[i++],s=f.BLOCKS[i],!(a<=(i=t*(n+r)+r-3+(this._version<=9)))););this._dataBlock=t,this._eccBlock=s,this._neccBlock1=n,this._neccBlock2=r;var o=this.width=17+4*this._version;this.buffer=v._createArray(o*o),this._ecc=v._createArray(t+(t+s)*(n+r)+r),this._mask=v._createArray((o*(o+1)+1)/2),this._insertFinders(),this._insertAlignments(),this.buffer[8+o*(o-8)]=1,this._insertTimingGap(),this._reverseMask(),this._insertTimingRowAndColumn(),this._insertVersion(),this._syncMask(),this._convertBitStream(a),this._calculatePolynomial(),this._appendEccToData(),this._interleaveBlocks(),this._pack(),this._finish()}),{_addAlignment:function(e,t){var s,i=this.buffer,n=this.width;for(i[e+n*t]=1,s=-2;s<2;s++)i[e+s+n*(t-2)]=1,i[e-2+n*(t+s+1)]=1,i[e+2+n*(t+s)]=1,i[e+s+1+n*(t+2)]=1;for(s=0;s<2;s++)this._setMask(e-1,t+s),this._setMask(e+1,t-s),this._setMask(e-s,t-1),this._setMask(e+s,t+1)},_appendData:function(e,t,s,i){var n,r,a,o=this._polynomial,l=this._stringBuffer;for(r=0;r<i;r++)l[s+r]=0;for(r=0;r<t;r++){if(255!==(n=m.LOG[l[e+r]^l[s]]))for(a=1;a<i;a++)l[s+a-1]=l[s+a]^m.EXPONENT[v._modN(n+o[i-a])];else for(a=s;a<s+i;a++)l[a]=l[a+1];l[s+i-1]=255===n?0:m.EXPONENT[v._modN(n+o[0])]}},_appendEccToData:function(){var e,t=0,s=this._dataBlock,i=this._calculateMaxLength(),n=this._eccBlock;for(e=0;e<this._neccBlock1;e++)this._appendData(t,s,i,n),t+=s,i+=n;for(e=0;e<this._neccBlock2;e++)this._appendData(t,s+1,i,n),t+=s+1,i+=n},_applyMask:function(e){var t,s,i,n,r=this.buffer,a=this.width;switch(e){case 0:for(n=0;n<a;n++)for(i=0;i<a;i++)i+n&1||this._isMasked(i,n)||(r[i+n*a]^=1);break;case 1:for(n=0;n<a;n++)for(i=0;i<a;i++)1&n||this._isMasked(i,n)||(r[i+n*a]^=1);break;case 2:for(n=0;n<a;n++)for(t=0,i=0;i<a;i++,t++)3===t&&(t=0),t||this._isMasked(i,n)||(r[i+n*a]^=1);break;case 3:for(s=0,n=0;n<a;n++,s++)for(3===s&&(s=0),t=s,i=0;i<a;i++,t++)3===t&&(t=0),t||this._isMasked(i,n)||(r[i+n*a]^=1);break;case 4:for(n=0;n<a;n++)for(t=0,s=n>>1&1,i=0;i<a;i++,t++)3===t&&(t=0,s=!s),s||this._isMasked(i,n)||(r[i+n*a]^=1);break;case 5:for(s=0,n=0;n<a;n++,s++)for(3===s&&(s=0),t=0,i=0;i<a;i++,t++)3===t&&(t=0),(i&n&1)+!(!t|!s)||this._isMasked(i,n)||(r[i+n*a]^=1);break;case 6:for(s=0,n=0;n<a;n++,s++)for(3===s&&(s=0),t=0,i=0;i<a;i++,t++)3===t&&(t=0),(i&n&1)+(t&&t===s)&1||this._isMasked(i,n)||(r[i+n*a]^=1);break;case 7:for(s=0,n=0;n<a;n++,s++)for(3===s&&(s=0),t=0,i=0;i<a;i++,t++)3===t&&(t=0),(t&&t===s)+(i+n&1)&1||this._isMasked(i,n)||(r[i+n*a]^=1)}},_calculateMaxLength:function(){return this._dataBlock*(this._neccBlock1+this._neccBlock2)+this._neccBlock2},_calculatePolynomial:function(){var e,t,s=this._eccBlock,i=this._polynomial;for(i[0]=1,e=0;e<s;e++){for(i[e+1]=1,t=e;t>0;t--)i[t]=i[t]?i[t-1]^m.EXPONENT[v._modN(m.LOG[i[t]]+e)]:i[t-1];i[0]=m.EXPONENT[v._modN(m.LOG[i[0]]+e)]}for(e=0;e<=s;e++)i[e]=m.LOG[i[e]]},_checkBadness:function(){var e,t,s,i,n,r=0,a=this._badness,o=this.buffer,l=this.width;for(n=0;n<l-1;n++)for(i=0;i<l-1;i++)(o[i+l*n]&&o[i+1+l*n]&&o[i+l*(n+1)]&&o[i+1+l*(n+1)]||!(o[i+l*n]||o[i+1+l*n]||o[i+l*(n+1)]||o[i+1+l*(n+1)]))&&(r+=v.N2);var h=0;for(n=0;n<l;n++){for(s=0,a[0]=0,e=0,i=0;i<l;i++)e===(t=o[i+l*n])?a[s]++:a[++s]=1,h+=(e=t)?1:-1;r+=this._getBadness(s)}h<0&&(h=-h);var c=0,d=h;for(d+=d<<2,d<<=1;d>l*l;)d-=l*l,c++;for(r+=c*v.N4,i=0;i<l;i++){for(s=0,a[0]=0,e=0,n=0;n<l;n++)e===(t=o[i+l*n])?a[s]++:a[++s]=1,e=t;r+=this._getBadness(s)}return r},_convertBitStream:function(e){var t,s,i=this._ecc,n=this._version;for(s=0;s<e;s++)i[s]=this._value.charCodeAt(s);var r=this._stringBuffer=i.slice(),a=this._calculateMaxLength();e>=a-2&&(e=a-2,n>9&&e--);var o=e;if(n>9){for(r[o+2]=0,r[o+3]=0;o--;)t=r[o],r[o+3]|=255&t<<4,r[o+2]=t>>4;r[2]|=255&e<<4,r[1]=e>>4,r[0]=64|e>>12}else{for(r[o+1]=0,r[o+2]=0;o--;)t=r[o],r[o+2]|=255&t<<4,r[o+1]=t>>4;r[1]|=255&e<<4,r[0]=64|e>>4}for(o=e+3-(n<10);o<a;)r[o++]=236,r[o++]=17},_getBadness:function(e){var t,s=0,i=this._badness;for(t=0;t<=e;t++)i[t]>=5&&(s+=v.N1+i[t]-5);for(t=3;t<e-1;t+=2)i[t-2]===i[t+2]&&i[t+2]===i[t-1]&&i[t-1]===i[t+1]&&3*i[t-1]===i[t]&&(0===i[t-3]||t+3>e||3*i[t-3]>=4*i[t]||3*i[t+3]>=4*i[t])&&(s+=v.N3);return s},_finish:function(){var e,t;this._stringBuffer=this.buffer.slice();var s=0,i=3e4;for(t=0;t<8&&(this._applyMask(t),(e=this._checkBadness())<i&&(i=e,s=t),7!==s);t++)this.buffer=this._stringBuffer.slice();s!==t&&this._applyMask(s),i=f.FINAL_FORMAT[s+(this._level-1<<3)];var n=this.buffer,r=this.width;for(t=0;t<8;t++,i>>=1)1&i&&(n[r-1-t+8*r]=1,t<6?n[8+r*t]=1:n[8+r*(t+1)]=1);for(t=0;t<7;t++,i>>=1)1&i&&(n[8+r*(r-7+t)]=1,t?n[6-t+8*r]=1:n[7+8*r]=1)},_interleaveBlocks:function(){var e,t,s=this._dataBlock,i=this._ecc,n=this._eccBlock,r=0,a=this._calculateMaxLength(),o=this._neccBlock1,l=this._neccBlock2,h=this._stringBuffer;for(e=0;e<s;e++){for(t=0;t<o;t++)i[r++]=h[e+t*s];for(t=0;t<l;t++)i[r++]=h[o*s+e+t*(s+1)]}for(t=0;t<l;t++)i[r++]=h[o*s+e+t*(s+1)];for(e=0;e<n;e++)for(t=0;t<o+l;t++)i[r++]=h[a+e+t*n];this._stringBuffer=i},_insertAlignments:function(){var e,t,s,i=this._version,n=this.width;if(i>1)for(e=p.BLOCK[i],s=n-7;;){for(t=n-7;t>e-3&&(this._addAlignment(t,s),!(t<e));)t-=e;if(s<=e+9)break;s-=e,this._addAlignment(6,s),this._addAlignment(s,6)}},_insertFinders:function(){var e,t,s,i,n=this.buffer,r=this.width;for(e=0;e<3;e++){for(t=0,i=0,1===e&&(t=r-7),2===e&&(i=r-7),n[i+3+r*(t+3)]=1,s=0;s<6;s++)n[i+s+r*t]=1,n[i+r*(t+s+1)]=1,n[i+6+r*(t+s)]=1,n[i+s+1+r*(t+6)]=1;for(s=1;s<5;s++)this._setMask(i+s,t+1),this._setMask(i+1,t+s+1),this._setMask(i+5,t+s),this._setMask(i+s+1,t+5);for(s=2;s<4;s++)n[i+s+r*(t+2)]=1,n[i+2+r*(t+s+1)]=1,n[i+4+r*(t+s)]=1,n[i+s+1+r*(t+4)]=1}},_insertTimingGap:function(){var e,t,s=this.width;for(t=0;t<7;t++)this._setMask(7,t),this._setMask(s-8,t),this._setMask(7,t+s-7);for(e=0;e<8;e++)this._setMask(e,7),this._setMask(e+s-8,7),this._setMask(e,s-8)},_insertTimingRowAndColumn:function(){var e,t=this.buffer,s=this.width;for(e=0;e<s-14;e++)1&e?(this._setMask(8+e,6),this._setMask(6,8+e)):(t[8+e+6*s]=1,t[6+s*(8+e)]=1)},_insertVersion:function(){var e,t,s,i,n=this.buffer,r=this._version,a=this.width;if(r>6)for(e=_.BLOCK[r-7],t=17,s=0;s<6;s++)for(i=0;i<3;i++,t--)1&(t>11?r>>t-12:e>>t)?(n[5-s+a*(2-i+a-11)]=1,n[2-i+a-11+a*(5-s)]=1):(this._setMask(5-s,2-i+a-11),this._setMask(2-i+a-11,5-s))},_isMasked:function(e,t){var s=v._getMaskBit(e,t);return 1===this._mask[s]},_pack:function(){var e,t,s,i=1,n=1,r=this.width,a=r-1,o=r-1,l=(this._dataBlock+this._eccBlock)*(this._neccBlock1+this._neccBlock2)+this._neccBlock2;for(t=0;t<l;t++)for(e=this._stringBuffer[t],s=0;s<8;s++,e<<=1){128&e&&(this.buffer[a+r*o]=1);do{n?a--:(a++,i?0!==o?o--:(i=!i,6==(a-=2)&&(a--,o=9)):o!==r-1?o++:(i=!i,6==(a-=2)&&(a--,o-=8))),n=!n}while(this._isMasked(a,o))}},_reverseMask:function(){var e,t,s=this.width;for(e=0;e<9;e++)this._setMask(e,8);for(e=0;e<8;e++)this._setMask(e+s-8,8),this._setMask(8,e);for(t=0;t<7;t++)this._setMask(8,t+s-7)},_setMask:function(e,t){var s=v._getMaskBit(e,t);this._mask[s]=1},_syncMask:function(){var e,t,s=this.width;for(t=0;t<s;t++)for(e=0;e<=t;e++)this.buffer[e+s*t]&&this._setMask(e,t)}},{_createArray:function(e){var t,s=[];for(t=0;t<e;t++)s[t]=0;return s},_getMaskBit:function(e,t){var s;return e>t&&(s=e,e=t,t=s),s=t,s+=t*t,s>>=1,s+=e},_modN:function(e){for(;e>=255;)e=((e-=255)>>8)+(255&e);return e},N1:3,N2:3,N3:40,N4:10}),b=v,y=c.extend({draw:function(){this.element.src=this.qrious.toDataURL()},reset:function(){this.element.src=""},resize:function(){var e=this.element;e.width=e.height=this.qrious.size}}),x=l.extend((function(e,t,s,i){this.name=e,this.modifiable=Boolean(t),this.defaultValue=s,this._valueTransformer=i}),{transform:function(e){var t=this._valueTransformer;return"function"==typeof t?t(e,this):e}}),w=l.extend(null,{abs:function(e){return null!=e?Math.abs(e):null},hasOwn:function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},noop:function(){},toUpperCase:function(e){return null!=e?e.toUpperCase():null}}),S=l.extend((function(e){this.options={},e.forEach((function(e){this.options[e.name]=e}),this)}),{exists:function(e){return null!=this.options[e]},get:function(e,t){return S._get(this.options[e],t)},getAll:function(e){var t,s=this.options,i={};for(t in s)w.hasOwn(s,t)&&(i[t]=S._get(s[t],e));return i},init:function(e,t,s){var i,n;for(i in"function"!=typeof s&&(s=w.noop),this.options)w.hasOwn(this.options,i)&&(n=this.options[i],S._set(n,n.defaultValue,t),S._createAccessor(n,t,s));this._setAll(e,t,!0)},set:function(e,t,s){return this._set(e,t,s)},setAll:function(e,t){return this._setAll(e,t)},_set:function(e,t,s,i){var n=this.options[e];if(!n)throw new Error("Invalid option: "+e);if(!n.modifiable&&!i)throw new Error("Option cannot be modified: "+e);return S._set(n,t,s)},_setAll:function(e,t,s){if(!e)return!1;var i,n=!1;for(i in e)w.hasOwn(e,i)&&this._set(i,e[i],t,s)&&(n=!0);return n}},{_createAccessor:function(e,t,s){var i={get:function(){return S._get(e,t)}};e.modifiable&&(i.set=function(i){S._set(e,i,t)&&s(i,e)}),Object.defineProperty(t,e.name,i)},_get:function(e,t){return t["_"+e.name]},_set:function(e,t,s){var i="_"+e.name,n=s[i],r=e.transform(null!=t?t:e.defaultValue);return s[i]=r,r!==n}}),C=S,T=l.extend((function(){this._services={}}),{getService:function(e){var t=this._services[e];if(!t)throw new Error("Service is not being managed with name: "+e);return t},setService:function(e,t){if(this._services[e])throw new Error("Service is already managed with name: "+e);t&&(this._services[e]=t)}}),E=new C([new x("background",!0,"white"),new x("backgroundAlpha",!0,1,w.abs),new x("element"),new x("foreground",!0,"black"),new x("foregroundAlpha",!0,1,w.abs),new x("level",!0,"L",w.toUpperCase),new x("mime",!0,"image/png"),new x("padding",!0,null,w.abs),new x("size",!0,100,w.abs),new x("value",!0,"")]),P=new T,k=l.extend((function(e){E.init(e,this,this.update.bind(this));var t=E.get("element",this),s=P.getService("element"),i=t&&s.isCanvas(t)?t:s.createCanvas(),n=t&&s.isImage(t)?t:s.createImage();this._canvasRenderer=new u(this,i,!0),this._imageRenderer=new y(this,n,n===t),this.update()}),{get:function(){return E.getAll(this)},set:function(e){E.setAll(e,this)&&this.update()},toDataURL:function(e){return this.canvas.toDataURL(e||this.mime)},update:function(){var e=new b({level:this.level,value:this.value});this._canvasRenderer.render(e),this._imageRenderer.render(e)}},{use:function(e){P.setService(e.getName(),e)}});Object.defineProperties(k.prototype,{canvas:{get:function(){return this._canvasRenderer.getElement()}},image:{get:function(){return this._imageRenderer.getElement()}}});var A=k,M=A,D=l.extend({getName:function(){}}).extend({createCanvas:function(){},createImage:function(){},getName:function(){return"element"},isCanvas:function(e){},isImage:function(e){}}).extend({createCanvas:function(){return document.createElement("canvas")},createImage:function(){return document.createElement("img")},isCanvas:function(e){return e instanceof HTMLCanvasElement},isImage:function(e){return e instanceof HTMLImageElement}});return M.use(new D),M}()),Yy.exports}var Jy=n(Qy());const Zy=e=>[e.r,e.g,e.b,1],ex=e=>({r:e[0],g:e[1],b:e[2]});class tx extends u.Component{shouldComponentUpdate(e){const t=["ui","debug","animation.playing"],s=yy(e.observerData,t),i=yy(this.props.observerData,t);return JSON.stringify(s)!==JSON.stringify(i)}render(){const e=this.props;return u.createElement("div",{className:"popup-panel-parent"},u.createElement(ve,{class:"popup-panel",flex:!0,hidden:"camera"!==e.observerData.ui.active},u.createElement($e,{text:"Camera",class:"popup-panel-heading"}),u.createElement(Ty,{label:"Fov",precision:0,min:35,max:150,value:e.observerData.camera.fov,setProperty:t=>e.setProperty("camera.fov",t)}),u.createElement(Ay,{label:"Tonemap",type:"string",options:["None","Linear","Neutral","Filmic","Hejl","ACES","ACES2"].map((e=>({v:e,t:e}))),value:e.observerData.camera.tonemapping,setProperty:t=>e.setProperty("camera.tonemapping",t)}),u.createElement(Ay,{label:"Pixel Scale",value:e.observerData.camera.pixelScale,type:"number",options:[1,2,4,8,16].map((e=>({v:e,t:Number(e).toString()}))),setProperty:t=>e.setProperty("camera.pixelScale",t)}),u.createElement(Sy,{label:"Multisample",value:e.observerData.camera.multisample,enabled:e.observerData.camera.multisampleSupported,setProperty:t=>e.setProperty("camera.multisample",t)}),u.createElement(Sy,{label:"High Quality",value:e.observerData.camera.hq,enabled:!e.observerData.animation.playing&&!e.observerData.debug.stats&&"webgpu"!==e.observerData.runtime.activeDeviceType,setProperty:t=>e.setProperty("camera.hq",t)})))}}class sx extends u.Component{shouldComponentUpdate(e){return JSON.stringify(e.skyboxData)!==JSON.stringify(this.props.skyboxData)||JSON.stringify(e.uiData)!==JSON.stringify(this.props.uiData)}render(){const e=this.props;return u.createElement("div",{className:"popup-panel-parent"},u.createElement(ve,{class:"popup-panel",flex:!0,hidden:"skybox"!==e.uiData.active},u.createElement($e,{text:"Sky",class:"popup-panel-heading"}),u.createElement(Ay,{label:"Environment",type:"string",options:JSON.parse(e.skyboxData.options),value:e.skyboxData.value,setProperty:t=>e.setProperty("skybox.value",t)}),u.createElement(Ty,{label:"Exposure",value:e.skyboxData.exposure,setProperty:t=>e.setProperty("skybox.exposure",t),precision:2,min:-6,max:6,enabled:"None"!==e.skyboxData.value}),u.createElement(Ty,{label:"Rotation",precision:0,min:-180,max:180,value:e.skyboxData.rotation,setProperty:t=>e.setProperty("skybox.rotation",t),enabled:"None"!==e.skyboxData.value}),u.createElement(Ay,{label:"Background",type:"string",options:["Solid Color","Infinite Sphere","Projective Dome","Projective Box"].map((e=>({v:e,t:e}))),value:e.skyboxData.background,setProperty:t=>e.setProperty("skybox.background",t),enabled:"None"!==e.skyboxData.value}),u.createElement(Py,{label:"Background Color",value:Zy(e.skyboxData.backgroundColor),setProperty:t=>e.setProperty("skybox.backgroundColor",ex(t)),enabled:"None"===e.skyboxData.value||"Solid Color"===e.skyboxData.background}),u.createElement(Ty,{label:"Blur",value:e.skyboxData.blur,setProperty:t=>e.setProperty("skybox.blur",t),enabled:"None"!==e.skyboxData.value&&"Infinite Sphere"===e.skyboxData.background,min:0,max:5,precision:0,step:1}),u.createElement(Ey,{label:"Scale",value:e.skyboxData.domeProjection.domeRadius,setProperty:t=>e.setProperty("skybox.domeProjection.domeRadius",t),min:0,max:1e3,enabled:"None"!==e.skyboxData.value&&-1!==["Projective Dome","Projective Box"].indexOf(e.skyboxData.background)}),u.createElement(Ty,{label:"Tripod Offset",value:e.skyboxData.domeProjection.tripodOffset,setProperty:t=>e.setProperty("skybox.domeProjection.tripodOffset",t),min:0,max:1,precision:2,enabled:"None"!==e.skyboxData.value&&-1!==["Projective Dome","Projective Box"].indexOf(e.skyboxData.background)})))}}class ix extends u.Component{shouldComponentUpdate(e){return JSON.stringify(e.lightData)!==JSON.stringify(this.props.lightData)||JSON.stringify(e.uiData)!==JSON.stringify(this.props.uiData)}render(){const e=this.props;return u.createElement("div",{className:"popup-panel-parent"},u.createElement(ve,{class:"popup-panel",flex:!0,hidden:"light"!==e.uiData.active},u.createElement($e,{text:"Light",class:"popup-panel-heading"}),u.createElement(Sy,{label:"Enabled",value:e.lightData.enabled,setProperty:t=>e.setProperty("light.enabled",t)}),u.createElement(Sy,{label:"Follow Camera",value:e.lightData.follow,setProperty:t=>e.setProperty("light.follow",t)}),u.createElement(Py,{label:"Color",value:Zy(e.lightData.color),setProperty:t=>e.setProperty("light.color",ex(t))}),u.createElement(Ty,{label:"Intensity",precision:2,min:0,max:6,value:e.lightData.intensity,setProperty:t=>e.setProperty("light.intensity",t)}),u.createElement(Sy,{label:"Cast Shadow",value:e.lightData.shadow,setProperty:t=>e.setProperty("light.shadow",t)}),u.createElement(Sy,{label:"Shadow Catcher",value:e.shadowCatcherData.enabled,setProperty:t=>e.setProperty("shadowCatcher.enabled",t)}),u.createElement(Ty,{label:"Catcher Intensity",precision:2,min:0,max:1,value:e.shadowCatcherData.intensity,setProperty:t=>e.setProperty("shadowCatcher.intensity",t)})))}}class nx extends u.Component{shouldComponentUpdate(e){return JSON.stringify(e.debugData)!==JSON.stringify(this.props.debugData)||JSON.stringify(e.uiData)!==JSON.stringify(this.props.uiData)}render(){const e=this.props;return u.createElement("div",{className:"popup-panel-parent"},u.createElement(ve,{class:"popup-panel",flex:!0,hidden:"debug"!==e.uiData.active},u.createElement($e,{text:"Debug",class:"popup-panel-heading"}),u.createElement(Ay,{label:"Render Mode",type:"string",options:[{t:"Default",v:"default"},{t:"Lighting",v:"lighting"},{t:"Albedo",v:"albedo"},{t:"Emissive",v:"emission"},{t:"WorldNormal",v:"world_normal"},{t:"Metalness",v:"metalness"},{t:"Gloss",v:"gloss"},{t:"Ao",v:"ao"},{t:"Specularity",v:"specularity"},{t:"Opacity",v:"opacity"},{t:"Uv0",v:"uv0"}],value:e.debugData.renderMode,setProperty:t=>e.setProperty("debug.renderMode",t)}),u.createElement(Cy,{label:"Wireframe",booleanValue:e.debugData.wireframe,setBooleanProperty:t=>e.setProperty("debug.wireframe",t),colorValue:Zy(e.debugData.wireframeColor),setColorProperty:t=>e.setProperty("debug.wireframeColor",ex(t))}),u.createElement(Sy,{label:"Grid",value:e.debugData.grid,setProperty:t=>e.setProperty("debug.grid",t)}),u.createElement(Sy,{label:"Axes",value:e.debugData.axes,setProperty:t=>e.setProperty("debug.axes",t)}),u.createElement(Sy,{label:"Skeleton",value:e.debugData.skeleton,setProperty:t=>e.setProperty("debug.skeleton",t)}),u.createElement(Sy,{label:"Bounds",value:e.debugData.bounds,setProperty:t=>e.setProperty("debug.bounds",t)}),u.createElement(Ty,{label:"Normals",precision:2,min:0,max:1,setProperty:t=>e.setProperty("debug.normals",t),value:e.debugData.normals}),u.createElement(Sy,{label:"Stats",value:e.debugData.stats,setProperty:t=>e.setProperty("debug.stats",t)})))}}class rx extends u.Component{isMobile;get shareUrl(){return`${location.origin}${location.pathname}?${this.props.sceneData.urls.map((e=>`load=${e}`)).join("&")}`}constructor(e){super(e),this.isMobile=/Android|webOS|iPhone|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}shouldComponentUpdate(e){return JSON.stringify(e.sceneData)!==JSON.stringify(this.props.sceneData)||JSON.stringify(e.uiData)!==JSON.stringify(this.props.uiData)}get hasQRCode(){return this.props.sceneData.urls.length>0&&!this.isMobile}updateQRCode(){const e=document.getElementById("share-qr");new Jy({element:e,value:this.shareUrl,size:e.getBoundingClientRect().width*window.devicePixelRatio})}componentDidMount(){this.hasQRCode&&this.updateQRCode()}componentDidUpdate(){this.hasQRCode&&this.updateQRCode()}render(){const e=this.props;return u.createElement("div",{className:"popup-panel-parent"},u.createElement(ve,{id:"view-panel",class:"popup-panel",flex:!0,hidden:"view"!==e.uiData.active},this.hasQRCode?u.createElement(u.Fragment,null,u.createElement($e,{text:"View and share on mobile with QR code"}),u.createElement("div",{id:"qr-wrapper"},u.createElement("canvas",{id:"share-qr"})),u.createElement($e,{text:"View and share on mobile with URL"}),u.createElement("div",{id:"share-url-wrapper"},u.createElement(ot,{class:"secondary",value:this.shareUrl,enabled:!1}),u.createElement(ae,{id:"copy-button",icon:"E126",onClick:()=>{navigator.clipboard&&window.isSecureContext&&navigator.clipboard.writeText(this.shareUrl)}}))):null,u.createElement(ae,{class:"secondary",text:"TAKE A SNAPSHOT AS PNG",onClick:()=>{window.viewer&&window.viewer.downloadPngScreenshot()}})))}}const ax=e=>u.createElement(u.Fragment,null,u.createElement(tx,{setProperty:e.setProperty,observerData:e.observerData}),u.createElement(sx,{setProperty:e.setProperty,skyboxData:e.observerData.skybox,uiData:e.observerData.ui}),u.createElement(ix,{setProperty:e.setProperty,lightData:e.observerData.light,uiData:e.observerData.ui,shadowCatcherData:e.observerData.shadowCatcher}),u.createElement(nx,{setProperty:e.setProperty,debugData:e.observerData.debug,uiData:e.observerData.ui}),u.createElement(rx,{setProperty:e.setProperty,sceneData:e.observerData.scene,uiData:e.observerData.ui,runtimeData:e.observerData.runtime}));class ox extends u.Component{popupPanelElement;render(){let e;const t=t=>{this.props.setProperty("ui.active",this.props.observerData.ui.active===t?null:t),this.popupPanelElement||(this.popupPanelElement=document.getElementById("popup")),setTimeout((()=>{e&&e();e=by(document.body,(t=>{this.popupPanelElement.contains(t.target)||(this.props.setProperty("ui.active",null),e(),e=null)}),4)}))},s=e=>this.props.observerData.ui.active===e?["popup-button","selected"]:["popup-button"];return u.createElement("div",{id:"popup-buttons-parent"},u.createElement(Xy,{animationData:this.props.observerData.animation,setProperty:this.props.setProperty}),u.createElement(ae,{class:s("camera"),icon:"E212",width:40,height:40,onClick:()=>t("camera")}),u.createElement(ae,{class:s("skybox"),icon:"E200",width:40,height:40,onClick:()=>t("skybox")}),u.createElement(ae,{class:s("light"),icon:"E194",width:40,height:40,onClick:()=>t("light")}),u.createElement(ae,{class:s("debug"),icon:"E134",width:40,height:40,onClick:()=>t("debug")}),u.createElement(ae,{class:s("view"),icon:"E301",width:40,height:40,onClick:()=>t("view")}))}}class lx extends u.Component{link;usdzExporter;get hasArSupport(){return this.props.observerData.runtime.xrSupported||this.usdzExporter}constructor(e){super(e),this.link=document.getElementById("ar-link"),(this.link.relList.supports("ar")||Boolean(window.webkit?.messageHandlers)&&Boolean(/CriOS\/|EdgiOS\/|FxiOS\/|GSA\/|DuckDuckGo\//.test(navigator.userAgent)))&&(this.usdzExporter=new ty)}render(){return u.createElement("div",{id:"popup",className:"[]"===this.props.observerData.scene.nodes?"empty":null},u.createElement(ax,{observerData:this.props.observerData,setProperty:this.props.setProperty}),u.createElement(ox,{observerData:this.props.observerData,setProperty:this.props.setProperty}),u.createElement(ae,{class:"popup-button",id:"launch-ar-button",icon:"E189",hidden:!this.hasArSupport||"[]"===this.props.observerData.scene.nodes,width:40,height:40,onClick:()=>{if(this.usdzExporter){const e=window.viewer.app.root.findByName("sceneRoot");this.usdzExporter.build(e).then((e=>{const t=new Blob([e],{type:"application/octet-stream"});this.link.href=URL.createObjectURL(t),this.link.click()})).catch(console.error)}else window.viewer&&window.viewer.xrMode.start()}}),u.createElement("div",{id:"floating-buttons-parent"},u.createElement(ae,{class:"popup-button",id:"fullscreen-button",icon:"E127",width:40,height:40,onClick:()=>{document.getElementById("panel-left").classList.toggle("collapsed")}})))}}class hx extends u.Component{shouldComponentUpdate(e){return e.sceneData.nodes!==this.props.sceneData.nodes||e.sceneData.selectedNode.path!==this.props.sceneData.selectedNode.path||e.sceneData.selectedNode.name!==this.props.sceneData.selectedNode.name||e.sceneData.selectedNode.position!==this.props.sceneData.selectedNode.position||e.sceneData.selectedNode.rotation!==this.props.sceneData.selectedNode.rotation||e.sceneData.selectedNode.scale!==this.props.sceneData.selectedNode.scale}render(){const e=this.props.sceneData,t="[]"!==e.nodes,s=e.selectedNode.path;return t&&s?u.createElement("div",{className:"selected-node-panel-parent"},u.createElement(ve,{class:"selected-node-panel",flex:!0},u.createElement(xy,{label:"Name",value:e.selectedNode.name}),u.createElement(wy,{label:"Position",dimensions:3,value:e.selectedNode.position,enabled:!1}),u.createElement(wy,{label:"Rotation",dimensions:3,value:e.selectedNode.rotation,enabled:!1}),u.createElement(wy,{label:"Scale",dimensions:3,value:e.selectedNode.scale,enabled:!1}))):null}}let cx=class extends u.Component{state=null;canvasRef;constructor(e){super(e),this.canvasRef=u.createRef(),this.state=this._retrieveState(),e.observer.on("*:set",(()=>{this.setState(this._retrieveState())}))}_retrieveState=()=>{const e={};return this.props.observer._keys.forEach((t=>{e[t]=this.props.observer.get(t)})),e};_setStateProperty=(e,t)=>{this.props.observer.set(e,t)};render(){return u.createElement("div",{id:"application-container"},u.createElement(ve,{id:"panel-left",flex:!0,resizable:"right",resizeMin:220,resizeMax:800},u.createElement("div",{className:"header",style:{display:"none"}},u.createElement("div",{id:"title"},u.createElement("img",{src:"static/playcanvas-logo.png"}),u.createElement("div",null,`MODEL VIEWER v${jy}`))),u.createElement("div",{id:"panel-toggle"},u.createElement("img",{src:"static/playcanvas-logo.png"})),u.createElement(Hy,{observerData:this.state,setProperty:this._setStateProperty})),u.createElement("div",{id:"canvas-wrapper"},u.createElement("canvas",{id:"application-canvas",ref:this.canvasRef}),u.createElement(Wy,{setProperty:this._setStateProperty}),u.createElement(hx,{sceneData:this.state.scene}),u.createElement(lx,{observerData:this.state,setProperty:this._setStateProperty}),u.createElement(vy,{observerData:this.state}),u.createElement(at,{id:"spinner",size:30,hidden:!0})))}};const dx=new ws,ux=new ys,px=new ys,fx=new As,mx=new Ds,gx=new Hs,_x=new Vs,vx={passive:!1},bx=(e,t)=>1-Math.pow(e,1e3*t);class yx extends rg{_camera=null;_origin=new ys;_position=new ys;_dir=new ws;_angles=new ys;_pitchRange=new ws(-360,360);_zoomMin=0;_zoomMax=0;_zoomDist=0;_cameraDist=0;_pointerEvents=new Map;_lastPinchDist=-1;_lastPosition=new ws;_orbiting=!1;_panning=!1;_flying=!1;_key={forward:!1,backward:!1,left:!1,right:!1,up:!1,down:!1,sprint:!1,crouch:!1};_element;_cameraTransform=new As;_baseTransform=new As;sceneSize=100;lookSensitivity=.2;lookDamping=.97;moveDamping=.98;enableOrbit=!0;enablePan=!0;enableFly=!0;pinchSpeed=5;wheelSpeed=.005;zoomScaleMin=0;moveSpeed=2;sprintSpeed=4;crouchSpeed=1;constructor(e){super(e);const{element:t,enableOrbit:s,enablePan:i,enableFly:n,focusPoint:r,sceneSize:a,lookSensitivity:o,lookDamping:l,moveDamping:h,pitchRange:c,pinchSpeed:d,wheelSpeed:u,zoomMin:p,zoomMax:f,moveSpeed:m,sprintSpeed:g,crouchSpeed:_}=e.attributes;if(this._element=t??this.app.graphicsDevice.canvas,this.enableOrbit=s??this.enableOrbit,this.enablePan=i??this.enablePan,this.enableFly=n??this.enableFly,this.sceneSize=a??this.sceneSize,this.lookSensitivity=o??this.lookSensitivity,this.lookDamping=l??this.lookDamping,this.moveDamping=h??this.moveDamping,this.pinchSpeed=d??this.pinchSpeed,this.wheelSpeed=u??this.wheelSpeed,this.moveSpeed=m??this.moveSpeed,this.sprintSpeed=g??this.sprintSpeed,this.crouchSpeed=_??this.crouchSpeed,this._onWheel=this._onWheel.bind(this),this._onKeyDown=this._onKeyDown.bind(this),this._onKeyUp=this._onKeyUp.bind(this),this._onPointerDown=this._onPointerDown.bind(this),this._onPointerMove=this._onPointerMove.bind(this),this._onPointerUp=this._onPointerUp.bind(this),this._onContextMenu=this._onContextMenu.bind(this),!this.entity.camera)throw new Error("CameraControls script requires a camera component");this.attach(this.entity.camera),this.focusPoint=r??this.focusPoint,this.pitchRange=c??this.pitchRange,this.zoomMin=p??this.zoomMin,this.zoomMax=f??this.zoomMax}set element(e){this._element=e;const t=this._camera;this.detach(),this.attach(t)}get element(){return this._element}set focusPoint(e){this._camera&&this.focus(e,this._camera.entity.getPosition(),!1)}get focusPoint(){return this._origin}set pitchRange(e){this._pitchRange.copy(e),this._dir.x=this._clampPitch(this._dir.x),this._smoothTransform(-1)}get pitchRange(){return this._pitchRange}set zoomMin(e){this._zoomMin=e,this._zoomDist=this._clampZoom(this._zoomDist),this._smoothZoom(-1)}get zoomMin(){return this._zoomMin}set zoomMax(e){this._zoomMax=e,this._zoomDist=this._clampZoom(this._zoomDist),this._smoothZoom(-1)}get zoomMax(){return this._zoomMax}_clampPitch(e){const t=-360===this._pitchRange.x?-1/0:this._pitchRange.x,s=360===this._pitchRange.y?1/0:this._pitchRange.y;return rs.clamp(e,t,s)}_clampZoom(e){const t=(this._camera?.nearClip??0)+this.zoomMin*this.sceneSize,s=this.zoomMax<=this.zoomMin?1/0:this.zoomMax*this.sceneSize;return rs.clamp(e,t,s)}_onContextMenu(e){e.preventDefault()}_isStartMousePan(e){return!!this.enablePan&&(!!e.shiftKey||(this.enableOrbit||this.enableFly?this.enableOrbit&&this.enableFly?1===e.button:1===e.button||2===e.button:0===e.button||1===e.button||2===e.button))}_isStartFly(e){return!!this.enableFly&&(this.enableOrbit||this.enablePan?this.enableOrbit?2===e.button:0===e.button:0===e.button||1===e.button||2===e.button)}_isStartOrbit(e){return!!this.enableOrbit&&(this.enableFly||this.enablePan?0===e.button:0===e.button||1===e.button||2===e.button)}_onPointerDown(e){if(!this._camera)return;this._element.setPointerCapture(e.pointerId),this._pointerEvents.set(e.pointerId,e);const t=this.enablePan&&2===this._pointerEvents.size,s=this._isStartMousePan(e),i=this._isStartFly(e),n=this._isStartOrbit(e);t&&(this._lastPinchDist=this._getPinchDist(),this._getMidPoint(this._lastPosition),this._panning=!0),s&&(this._lastPosition.set(e.clientX,e.clientY),this._panning=!0),i&&(this._zoomDist=this._cameraDist,this._origin.copy(this._camera.entity.getPosition()),this._position.copy(this._origin),this._cameraTransform.setTranslate(0,0,0),this._flying=!0),n&&(this._orbiting=!0)}_onPointerMove(e){if(0!==this._pointerEvents.size)if(this._pointerEvents.set(e.pointerId,e),1!==this._pointerEvents.size){if(2===this._pointerEvents.size){this._panning&&this._pan(this._getMidPoint(dx));const e=this._getPinchDist();this._lastPinchDist>0&&this._zoom((this._lastPinchDist-e)*this.pinchSpeed),this._lastPinchDist=e}}else this._panning?this._pan(dx.set(e.clientX,e.clientY)):(this._orbiting||this._flying)&&this._look(e)}_onPointerUp(e){this._element.releasePointerCapture(e.pointerId),this._pointerEvents.delete(e.pointerId),this._pointerEvents.size<2&&(this._lastPinchDist=-1,this._panning=!1),this._orbiting&&(this._orbiting=!1),this._panning&&(this._panning=!1),this._flying&&(ux.copy(this._camera.entity.forward).mulScalar(this._zoomDist),this._origin.add(ux),this._position.add(ux),this._flying=!1)}_onWheel(e){e.preventDefault(),this._zoom(e.deltaY)}_onKeyDown(e){switch(e.stopPropagation(),e.key.toLowerCase()){case"w":this._key.forward=!0;break;case"s":this._key.backward=!0;break;case"a":this._key.left=!0;break;case"d":this._key.right=!0;break;case"q":this._key.up=!0;break;case"e":this._key.down=!0;break;case"shift":this._key.sprint=!0;break;case"control":this._key.crouch=!0}}_onKeyUp(e){switch(e.stopPropagation(),e.key.toLowerCase()){case"w":this._key.forward=!1;break;case"s":this._key.backward=!1;break;case"a":this._key.left=!1;break;case"d":this._key.right=!1;break;case"q":this._key.up=!1;break;case"e":this._key.down=!1;break;case"shift":this._key.sprint=!1;break;case"control":this._key.crouch=!1}}_look(e){if(e.target!==this.app.graphicsDevice.canvas)return;const t=e.movementX||0,s=e.movementY||0;this._dir.x=this._clampPitch(this._dir.x-s*this.lookSensitivity),this._dir.y-=t*this.lookSensitivity}_move(e){if(!this.enableFly)return;ux.set(0,0,0),this._key.forward&&ux.add(this._camera.entity.forward),this._key.backward&&ux.sub(this._camera.entity.forward),this._key.left&&ux.sub(this._camera.entity.right),this._key.right&&ux.add(this._camera.entity.right),this._key.up&&ux.add(this._camera.entity.up),this._key.down&&ux.sub(this._camera.entity.up),ux.normalize();const t=this._key.crouch?this.crouchSpeed:this._key.sprint?this.sprintSpeed:this.moveSpeed;ux.mulScalar(this.sceneSize*t*e),this._origin.add(ux)}_getMidPoint(e){const[t,s]=this._pointerEvents.values(),i=t.clientX-s.clientX,n=t.clientY-s.clientY;return e.set(s.clientX+.5*i,s.clientY+.5*n)}_getPinchDist(){const[e,t]=this._pointerEvents.values(),s=e.clientX-t.clientX,i=e.clientY-t.clientY;return Math.sqrt(s*s+i*i)}_screenToWorldPan(e,t){const s=this._camera.screenToWorld(e.x,e.y,1),i=this._camera.entity.getPosition(),n=ux.copy(this._camera.entity.forward).mulScalar(this._zoomDist),r=px.add2(i,n),a=n.mulScalar(-1).normalize(),o=_x.setFromPointNormal(r,a),l=gx.set(i,s.sub(i).normalize());o.intersectsRay(l,t)}_pan(e){if(!this.enablePan)return;const t=new ys,s=new ys;this._screenToWorldPan(this._lastPosition,t),this._screenToWorldPan(e,s),ux.sub2(t,s),this._origin.add(ux),this._lastPosition.copy(e)}_zoom(e){if(!this.enableOrbit&&!this.enablePan)return;if(!this._camera)return;const t=this._zoomDist/(10*this.sceneSize),s=rs.clamp(t,this.zoomScaleMin,1);this._zoomDist+=e*this.wheelSpeed*this.sceneSize*s,this._zoomDist=this._clampZoom(this._zoomDist)}_smoothZoom(e){const t=-1===e?1:bx(this.moveDamping,e);this._cameraDist=rs.lerp(this._cameraDist,this._zoomDist,t),this._cameraTransform.setTranslate(0,0,this._cameraDist)}_smoothTransform(e){const t=-1===e?1:bx(this.lookDamping,e);this._angles.x=rs.lerp(this._angles.x,this._dir.x,t),this._angles.y=rs.lerp(this._angles.y,this._dir.y,t),this._position.lerp(this._position,this._origin,t),this._baseTransform.setTRS(this._position,mx.setFromEulerAngles(this._angles),ys.ONE)}_updateTransform(){fx.copy(this._baseTransform).mul(this._cameraTransform),this._camera.entity.setPosition(fx.getTranslation()),this._camera.entity.setEulerAngles(fx.getEulerAngles())}focus(e,t,s=!0){if(!this._camera)return;if(this._flying)return;if(!t)return this._origin.copy(e),void(s||this._position.copy(e));ux.sub2(t,e);const i=Math.atan2(ux.y,Math.sqrt(ux.x*ux.x+ux.z*ux.z))*rs.RAD_TO_DEG,n=Math.atan2(ux.x,ux.z)*rs.RAD_TO_DEG;this._dir.set(this._clampPitch(-i),n),this._origin.copy(e),this._cameraTransform.setTranslate(0,0,0);const r=this._camera.entity.getPosition(),a=this._camera.entity.getRotation();this._baseTransform.setTRS(r,a,ys.ONE),this._zoomDist=this._clampZoom(ux.length()),s||(this._smoothZoom(-1),this._smoothTransform(-1)),this._updateTransform()}resetZoom(e=0,t=!0){this._zoomDist=e,t||(this._cameraDist=e)}refocus(e,t=null,s,i=!0){"number"==typeof s&&this.resetZoom(s,i),this.focus(e,t,i)}attach(e){this._camera=e,this._element.addEventListener("wheel",this._onWheel,vx),this._element.addEventListener("pointerdown",this._onPointerDown),this._element.addEventListener("pointermove",this._onPointerMove),this._element.addEventListener("pointerup",this._onPointerUp),this._element.addEventListener("contextmenu",this._onContextMenu),window.addEventListener("keydown",this._onKeyDown,!1),window.addEventListener("keyup",this._onKeyUp,!1)}detach(){this._element.removeEventListener("wheel",this._onWheel,vx),this._element.removeEventListener("pointermove",this._onPointerMove),this._element.removeEventListener("pointerdown",this._onPointerDown),this._element.removeEventListener("pointerup",this._onPointerUp),this._element.removeEventListener("contextmenu",this._onContextMenu),window.removeEventListener("keydown",this._onKeyDown,!1),window.removeEventListener("keyup",this._onKeyUp,!1),this._camera=null,this._dir.x=this._angles.x,this._dir.y=this._angles.y,this._origin.copy(this._position),this._pointerEvents.clear(),this._lastPinchDist=-1,this._panning=!1,this._key={forward:!1,backward:!1,left:!1,right:!1,up:!1,down:!1,sprint:!1,crouch:!1}}update(e){this.app.xr?.active||this._camera&&(this._move(e),this._flying||this._smoothZoom(e),this._smoothTransform(e),this._updateTransform())}destroy(){this.detach()}}class xx extends Sf{constructor(e,t){super(e);const s=new Ef;s.graphicsDevice=t.graphicsDevice,this.addComponentSystems(s),this.addResourceHandles(s),s.elementInput=t.elementInput,s.keyboard=t.keyboard,s.mouse=t.mouse,s.touch=t.touch,s.gamepads=t.gamepads,s.scriptPrefix=t.scriptPrefix,s.assetPrefix=t.assetPrefix,s.scriptsOrder=t.scriptsOrder,s.lightmapper=Bf,s.xr=Jv,this.init(s)}addComponentSystems(e){e.componentSystems=[Am,Um,$m,Ym,_g,ug]}addResourceHandles(e){e.resourceHandlers=[wg,__,v_,ov,S_,b_,w_,O_]}}let wx=null,Sx=null;const Cx=new ys,Tx=new ys,Ex=new ys,Px=new ys(0,1,0),kx=new As,Ax=[[[0,0,0],[-.5,0,.3]],[[0,0,0],[.5,0,.3]],[[0,0,0],[0,-.5,.3]],[[0,0,0],[0,.5,.3]],[[0,0,1],[-.5,0,.3]],[[0,0,1],[.5,0,.3]],[[0,0,1],[0,-.5,.3]],[[0,0,1],[0,.5,.3]],[[0,-.5,.3],[.5,0,.3]],[[.5,0,.3],[0,.5,.3]],[[0,.5,.3],[-.5,0,.3]],[[-.5,0,.3],[0,-.5,.3]]];class Mx{app;mesh;meshInstances;vertexFormat;vertexCursor;vertexData;colorData;depthState=new On;constructor(e,t,s=!0){const i=e.graphicsDevice;if(!wx){Sx=new ud({enabled:!0,name:"Debug Layer Behind",opaqueSortMode:0,transparentSortMode:0,passThrough:!0,overrideClear:!0}),wx=new ud({enabled:!0,name:"Debug Layer",opaqueSortMode:0,transparentSortMode:0,passThrough:!0,overrideClear:!0});const s=e.scene.layers,i=s.getLayerByName("World"),n=s.getTransparentIndex(i);s.insert(Sx,n),s.insert(wx,n+1),t.camera.layers=t.camera.layers.concat([Sx.id,wx.id])}const n=new Kn(i,[{semantic:li,components:3,type:6},{semantic:pi,components:4,type:1,normalize:!0}]),r=new Dl(i);r.vertexBuffer=new Hn(i,n,8192,{usage:1}),r.primitive[0].type=1,r.primitive[0].base=0,r.primitive[0].indexed=!1,r.primitive[0].count=0;const a={uniqueName:"debug-lines",attributes:{vertex_position:li,vertex_color:pi},vertexCode:"\nattribute vec3 vertex_position;\nattribute vec4 vertex_color;\n\nvarying vec2 zw;\nvarying vec4 vColor;\n\nuniform mat4 matrix_model;\nuniform mat4 matrix_viewProjection;\n\nvoid main(void) {\n    vColor = vertex_color;\n\n    gl_Position = matrix_viewProjection * matrix_model * vec4(vertex_position, 1.0);\n\n    // store z/w for later use in fragment shader\n    zw = gl_Position.zw;\n\n    // disable depth clipping\n    gl_Position.z = 0.0;\n}",fragmentCode:"\nprecision highp float;\n\nvarying vec2 zw;\nvarying vec4 vColor;\nuniform vec4 uColor;\n\nvoid main(void) {\n    gl_FragColor = vColor * uColor;\n\n    // clamp depth in Z to [0, 1] range\n    gl_FragDepth = max(0.0, min(1.0, (zw.x / zw.y + 1.0) * 0.5));\n}"},o=new Rd(a);o.setParameter("uColor",[1,1,1,.7]),o.blendType=2,o.update();const l=new Hl(r,o,new vh);if(l.cull=!1,l.visible=!1,wx.addMeshInstances([l],!0),this.meshInstances=[l],s){const e=new Rd(a);e.setParameter("uColor",[.5,.5,.5,.5]),e.blendType=2,e.depthState.func=4,e.depthState.write=!1,e.update();const t=new Hl(r,e,new vh);t.cull=!1,t.visible=!1,Sx.addMeshInstances([t],!0),this.meshInstances.push(t)}this.app=e,this.mesh=r,this.vertexFormat=n,this.vertexCursor=0,this.vertexData=new Float32Array(this.mesh.vertexBuffer.lock()),this.colorData=new Uint32Array(this.mesh.vertexBuffer.lock())}static matrixMad(e,t,s){if(s>0)for(let i=0;i<16;++i)e.data[i]+=t.data[i]*s}clear(){this.vertexCursor=0}box(e,t){this.line(new ys(e.x,e.y,e.z),new ys(t.x,e.y,e.z)),this.line(new ys(t.x,e.y,e.z),new ys(t.x,e.y,t.z)),this.line(new ys(t.x,e.y,t.z),new ys(e.x,e.y,t.z)),this.line(new ys(e.x,e.y,t.z),new ys(e.x,e.y,e.z)),this.line(new ys(e.x,t.y,e.z),new ys(t.x,t.y,e.z)),this.line(new ys(t.x,t.y,e.z),new ys(t.x,t.y,t.z)),this.line(new ys(t.x,t.y,t.z),new ys(e.x,t.y,t.z)),this.line(new ys(e.x,t.y,t.z),new ys(e.x,t.y,e.z)),this.line(new ys(e.x,e.y,e.z),new ys(e.x,t.y,e.z)),this.line(new ys(t.x,e.y,e.z),new ys(t.x,t.y,e.z)),this.line(new ys(t.x,e.y,t.z),new ys(t.x,t.y,t.z)),this.line(new ys(e.x,e.y,t.z),new ys(e.x,t.y,t.z))}line(e,t,s=4294967295){if(this.vertexCursor>=this.vertexData.length/8){const e=this.mesh.vertexBuffer,t=2*e.lock().byteLength,s=new ArrayBuffer(t);this.mesh.vertexBuffer=new Hn(this.app.graphicsDevice,e.getFormat(),2*e.getNumVertices(),{usage:1,data:s}),this.vertexData=new Float32Array(s),this.colorData=new Uint32Array(s),this.colorData.set(new Uint32Array(e.lock()))}const i=this.vertexCursor,n=this.vertexData,r=this.colorData;n[8*i+0]=e.x,n[8*i+1]=e.y,n[8*i+2]=e.z,r[8*i+3]=s,n[8*i+4]=t.x,n[8*i+5]=t.y,n[8*i+6]=t.z,r[8*i+7]=s,this.vertexCursor++}generateNormals(e,t,s,i){const n=new Eo(e),r=n.element[li],a=n.element[hi],o=n.element[ui],l=n.element[di];if(!r||!a)return;const h=e.getNumVertices(),c=new ys,d=new ys,u=new As;for(let e=0;e<h;++e){if(c.set(r.get(0),r.get(1),r.get(2)),d.set(a.get(0),a.get(1),a.get(2)),o&&l&&i){u.copy(As.ZERO);for(let e=0;e<4;++e)Mx.matrixMad(u,i[o.get(e)],l.get(e));u.mul2(t,u),u.transformPoint(c,c),u.transformVector(d,d)}else t.transformPoint(c,c),t.transformVector(d,d);d.normalize().mulScalar(s).add(c),this.line(c,d),n.next()}}bone(e,t,s=4294967295){kx.setLookAt(e,t,Px),Cx.sub2(t,e);const i=Cx.length(),n=(e,t)=>{Cx.set(t[0]*i*.3,t[1]*i*.3,t[2]*-i),kx.transformPoint(Cx,e)};Ax.forEach((e=>{n(Tx,e[0]),n(Ex,e[1]),this.line(Tx,Ex,s)}))}axis(e,t=1){e.getTranslation(Cx),e.getScale(Ex),Ex.set(t/Ex.x,t/Ex.y,t/Ex.z),e.getX(Tx).mul(Ex).add(Cx),this.line(Cx,Tx,4278190335),e.getY(Tx).mul(Ex).add(Cx),this.line(Cx,Tx,4278255360),e.getZ(Tx).mul(Ex).add(Cx),this.line(Cx,Tx,4294901760)}generateSkeleton(e,t,s,i){const n=(r,a)=>{if(r.enabled){a||=r===i;for(let e=0;e<r.children.length;++e){const s=r.children[e];t&&this.bone(r.getPosition(),s.getPosition(),a?4294967040:4294967295),n(s,a)}if(s){const t=e.parent;t&&(Cx.sub2(r.getPosition(),t.getPosition()),this.axis(r.getWorldTransform(),.05*Cx.length()))}}};n(e,!1)}update(){0===this.vertexCursor?this.meshInstances.forEach((e=>{e.visible=!1})):(this.meshInstances.forEach((e=>{e.visible=!0})),this.mesh.vertexBuffer.unlock(),this.mesh.primitive[0].count=2*this.vertexCursor,this.vertexCursor=0)}}const Dx=e=>{const t=[],s=[];return e.forEach((e=>{e.isFile?s.push(e):e.isDirectory&&t.push(new Promise((t=>{const s=e.createReader(),i=[],n=()=>{s.readEntries((e=>{e.length>0?(i.push(Dx(e)),n()):Promise.all(i).then((e=>{t(e.flat())}))}))};n()})))})),Promise.all(t).then((e=>s.concat(...e)))},Rx=(e,t)=>{e.addEventListener("dragstart",(e=>{e.preventDefault(),e.stopPropagation(),e.dataTransfer.effectAllowed="all"}),!1),e.addEventListener("dragover",(e=>{e.preventDefault(),e.stopPropagation(),e.dataTransfer.effectAllowed="all"}),!1),e.addEventListener("drop",(e=>{e.preventDefault();const s=Array.from(e.dataTransfer.items).map((e=>e.webkitGetAsEntry()));Dx(s).then((e=>Promise.all(e.map((e=>new Promise((t=>{e.file((s=>{t({url:URL.createObjectURL(s),filename:e.fullPath.substring(1)})}))}))))))).then((s=>{s.length>1&&(e=>{const t=e=>{const t=e.split(It.delimiter);return[t[0],t.slice(1).join(It.delimiter)]};for(;;){const s=t(e[0].filename);if(0===s[1].length)return;for(let i=1;i<e.length;++i){const n=t(e[i].filename);if(s[0]!==n[0])return}for(let s=0;s<e.length;++s)e[s].filename=t(e[s].filename)[1]}})(s),t(s,!e.shiftKey)}))}),!1)},Lx=(e,t)=>1/(Math.sqrt(2*Math.PI)*t)*Math.exp(-e*e/(2*t*t)),Ix=new Rn(!0,0,11,12),Fx=new Rn(!1);class Ox{device;camera;textureBias;shader=null;pixelFormat;texcoordModUniform=null;multiframeTexUniform=null;powerUniform=null;textureBiasUniform=null;accumTexture=null;accumRenderTarget=null;sampleArray=[];sampleId=0;sampleAccum=0;enabled=!0;blend=1;constructor(e,t,s){this.device=e,this.camera=t,this.samples=s||Ox.generateSamples(5,!1,2,0),this.camera.system.app.scene.on(rl,(e=>{if(e!==this.camera)return;const t=this.camera.camera,s=t.projectionMatrix;if(this.enabled&&this.accumTexture){const e=this.sampleArray[this.sampleId];s.data[8]=e.x/this.accumTexture.width,s.data[9]=e.y/this.accumTexture.height,this.textureBiasUniform.setValue(0===this.sampleId?0:this.textureBias)}else s.data[8]=0,s.data[9]=0,this.textureBiasUniform.setValue(0);t._viewProjMatDirty=!0})),this.camera.system.app.scene.on(al,(e=>{if(e!==this.camera)return;const s=t.projectionMatrix;s.data[8]=0,s.data[9]=0})),this.shader=fl(e,"\nattribute vec2 vertex_position;\nvarying vec2 texcoord;\nuniform vec4 texcoordMod;\nvoid main(void) {\n    gl_Position = vec4(vertex_position, 0.5, 1.0);\n    texcoord = (vertex_position.xy * 0.5 + 0.5) * texcoordMod.xy + texcoordMod.zw;\n}\n","\nvarying vec2 texcoord;\nuniform sampler2D multiframeTex;\nuniform float power;\nvoid main(void) {\n    vec4 t = texture2D(multiframeTex, texcoord);\n    gl_FragColor = pow(t, vec4(power));\n}\n","multiframe",{vertex_position:li}),this.pixelFormat=(e=>(e=>e.textureHalfFloatRenderable)(e)?Ws:(e=>e.textureFloatRenderable)(e)?$s:7)(e),this.texcoordModUniform=e.scope.resolve("texcoordMod"),this.multiframeTexUniform=e.scope.resolve("multiframeTex"),this.powerUniform=e.scope.resolve("power"),this.textureBiasUniform=e.scope.resolve("textureBias");const i=()=>{this.destroy()};e.once("destroy",i),e.on("devicelost",i)}set samples(e){this.sampleArray=e,this.textureBias=-Math.log2(Math.sqrt(e.length)),this.sampleId=0}get samples(){return this.sampleArray}static generateSamples(e,t=!1,s=1,i=0){const n=[],r=Math.ceil(3*i)+1,a=.5*s;let o,l,h,c=0;for(let s=0;s<e;++s)for(let d=0;d<e;++d)t?(o=(s+Math.random())/e*2-1,l=(d+Math.random())/e*2-1):(o=s/(e-1)*2-1,l=d/(e-1)*2-1),h=i<=0?1:Lx(o*r,i)*Lx(l*r,i),c+=h,n.push(new ys(o*a,l*a,h));return n.forEach((e=>{e.z/=c})),n.sort(((e,t)=>{const s=e.length(),i=t.length();return s<i?-1:i<s?1:0})),n}destroy(){this.accumRenderTarget&&(this.accumRenderTarget.destroy(),this.accumRenderTarget=null),this.accumTexture&&(this.accumTexture.destroy(),this.accumTexture=null)}create(){const e=this.camera.renderTarget.colorBuffer;this.accumTexture=new yn(this.device,{name:"multiframe-texture",width:e.width,height:e.height,format:this.pixelFormat,mipmaps:!1,minFilter:0,magFilter:0}),this.accumRenderTarget=new tr({name:"multiframe-target",colorBuffer:this.accumTexture,depth:!1})}activateBackbuffer(){const e=this.device;e.isWebGPU||(e.setRenderTarget(null),e.updateBegin(),e.setViewport(0,0,e.width,e.height),e.setScissor(0,0,e.width,e.height))}moved(){this.sampleId=0,this.sampleAccum=0}update(){const e=this.device,t=this.sampleArray.length,s=this.camera.renderTarget.colorBuffer;if(!this.enabled)return this.copyFinal(),!1;if(!this.accumTexture||this.accumTexture.width===s.width&&this.accumTexture.height===s.height||this.destroy(),this.accumTexture||this.create(),this.sampleId<t){const t=this.sampleArray[this.sampleId].z,i=t/(this.sampleAccum+t);e.setBlendState(Ix),e.setBlendColor(i,i,i,i),this.texcoordModUniform.setValue([1,1,0,0]),this.multiframeTexUniform.setValue(s),this.powerUniform.setValue(2.2),Cl(e,this.accumRenderTarget,this.shader,null,null),this.sampleAccum+=t}return this.copyFinal(),this.sampleId<t&&this.sampleId++,this.sampleId<t}copyFinal(){const e=this.device;1!==this.blend?(e.setBlendState(Ix),e.setBlendColor(this.blend,this.blend,this.blend,this.blend)):e.setBlendState(Fx),this.texcoordModUniform.setValue(e.isWebGPU?[1,-1,0,1]:[1,1,0,0]),this.enabled&&0!==this.sampleId?(this.multiframeTexUniform.setValue(this.accumTexture),this.powerUniform.setValue(1/2.2)):(this.multiframeTexUniform.setValue(this.camera.renderTarget.colorBuffer),this.powerUniform.setValue(1)),Cl(e,null,this.shader),this.activateBackbuffer()}}class Bx{static WORKER_STR=function(e){(async()=>{const t=await new Promise((t=>{self.importScripts(`${e}static/lib/lodepng/lodepng.js`),t(self.lodepng({locateFile:()=>`${e}static/lib/lodepng/lodepng.wasm`}))}));self.onmessage=e=>{const s=e.data,i=((e,t,s,i)=>{const n=e._malloc(4),r=e._malloc(4),a=e._malloc(s*i*4);for(let n=0;n<i;++n){let r=n*s,o=a/4+(i-1-n)*s;for(let i=0;i<s;++i)e.HEAPU32[o++]=t[r++]}e._lodepng_encode32(n,r,a,s,i);const o=e.HEAPU8.slice(e.HEAPU32[n/4],e.HEAPU32[n/4]+e.HEAPU32[r/4]);return e._free(n),e._free(r),e._free(a),o})(t,s.words,s.width,s.height);self.postMessage({result:i},void 0,[i.buffer])}})()}.toString();worker;receiveCallback;constructor(){let e=null;const t=new Blob([`(${Bx.WORKER_STR})('${window.location.href.split("?")[0]}')\n\n`],{type:"application/javascript"});this.worker=new Worker(URL.createObjectURL(t)),this.worker.addEventListener("message",(t=>{e(t)})),this.receiveCallback=t=>{e=s=>{t(s.data.result),e=null}}}_downloadFile(e,t){const s=new Blob([t],{type:"octet/stream"}),i=window.URL.createObjectURL(s),n=document.createElement("a");n.download=e,n.href=i,n.click(),window.URL.revokeObjectURL(i)}async export(e,t,s,i){this.worker.postMessage({words:t,width:s,height:i},[t.buffer]),this._downloadFile(e,await new Promise(this.receiveCallback))}}const zx=new Rn(!1);class Nx{device;shader;depthTexUniform;texcoordRangeUniform;pixels=new Uint8Array(4);texture=null;renderTarget=null;constructor(e){this.device=e,this.shader=fl(e,"\nattribute vec2 vertex_position;\nvarying vec2 texcoord;\nvoid main(void) {\n    gl_Position = vec4(vertex_position, 0.5, 1.0);\n    texcoord = vertex_position * 0.5 + 0.5;\n}\n","\nuniform highp sampler2D depthTex;\nuniform vec4 texcoordRange;\nvarying vec2 texcoord;\n\nvec4 packFloat(float depth) {\n    const vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n    const vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n\n    // combination of mod and multiplication and division works better\n    vec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n    res -= res.xxyz * bit_mask;\n    return res;\n}\n\nvoid main(void) {\n    vec2 t = mix(texcoordRange.xy, texcoordRange.zw, texcoord);\n    gl_FragColor = packFloat(texelFetch(depthTex, ivec2(t * vec2(textureSize(depthTex, 0))), 0).x);\n}\n","read-depth",{vertex_position:li}),this.depthTexUniform=e.scope.resolve("depthTex"),this.texcoordRangeUniform=e.scope.resolve("texcoordRange");const t=()=>{this.destroy()};e.once("destroy",t),e.on("devicelost",t)}destroy(){this.renderTarget&&(this.renderTarget.destroy(),this.renderTarget=null),this.texture&&(this.texture.destroy(),this.texture=null)}create(){this.texture=new yn(this.device,{width:1,height:1,format:7,mipmaps:!1,minFilter:0,magFilter:0}),this.renderTarget=new tr({colorBuffer:this.texture,depth:!1})}async read(e,t,s){this.texture||this.create(),console.log(`tex=${this.texture.width}x${this.texture.height} depth=${e.width}x${e.height}`);const i=this.device,n=t+.5/e.width,r=s+.5/e.height;this.depthTexUniform.setValue(e),this.texcoordRangeUniform.setValue([n,r,n,r]),i.setBlendState(zx),Cl(this.device,this.renderTarget,this.shader);const a=await this.texture.read(0,0,1,1);return a[0]/4278190080+a[1]/16711680+a[2]/65280+a[3]/255}}class Ux{layer;material;plane;light;sceneRoot;camera;constructor(e,t,s,i){this.layer=new ud({name:"Shadow Layer"});const n=e.scene.layers,r=n.getLayerByName("World"),a=n.getTransparentIndex(r);n.insert(this.layer,a+1),this.material=new ju,this.material.useSkybox=!1,this.material.blendType=2,this.material.depthWrite=!1,this.material.diffuse.set(0,0,0),this.material.specular.set(0,0,0),this.material.chunks={APIVersion:ln,endPS:"\n    litArgs_opacity = mix(light0_shadowIntensity, 0.0, shadow0);\n    gl_FragColor.rgb = vec3(0.0);\n"},this.material.update(),this.plane=new vf("ShadowPlane"),this.plane.addComponent("render",{type:"plane",castShadows:!1,material:this.material}),this.light=new vf("ShadowLight"),this.light.addComponent("light",{type:"directional",castShadows:!0,normalOffsetBias:0,shadowBias:0,shadowResolution:1024,shadowType:2,shadowUpdateMode:2,vsmBlurSize:64,enabled:!0,shadowIntensity:.4}),s.addChild(this.plane),s.addChild(this.light),this.plane.render.layers=[this.layer.id],this.light.light.layers=[this.layer.id],t.layers=t.layers.concat([this.layer.id]),this.sceneRoot=i,this.camera=t}onEntityAdded(e){e.findComponents("render").forEach((e=>{this.layer.shadowCasters=this.layer.shadowCasters.concat(e.meshInstances)}))}onEntityRemoved(e){e.findComponents("render").forEach((e=>{this.layer.shadowCasters=this.layer.shadowCasters.filter((t=>-1===e.meshInstances.indexOf(t)))}))}onUpdate(e){const t=e,s=t.center,i=Math.sqrt(t.halfExtents.x*t.halfExtents.x+t.halfExtents.z*t.halfExtents.z);this.plane.setLocalScale(4*i,1,4*i),this.plane.setPosition(s.x,t.getMin().y,s.z),this.light.light.shadowDistance=this.camera.camera._farClip}set enabled(e){this.layer.enabled=e,this.light.enabled=e}get enabled(){return this.layer.enabled}set intensity(e){this.light.light.shadowIntensity=e}get intensity(){return this.light.light.shadowIntensity}}var Vx=new Image;Vx.src="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' xmlns:svg='http://www.w3.org/2000/svg' width='1010' height='1000' version='1.1' style='background-color:rgba(32%2c32%2c32%2c.4)'%3e%3cg class='layer'%3e%3cpath id='svg_1' fill='white' d='m363%2c300l126%2c126l-58%2c58l-126%2c-126l-126%2c126l-58%2c-58l126%2c-126l-126%2c-126l58%2c-58l126%2c126l126%2c-126l58%2c58l-126%2c126z' transform='translate(205%2c 200)'/%3e%3c/g%3e%3c/svg%3e";var Gx=new Image;Gx.src="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' xmlns:svg='http://www.w3.org/2000/svg' width='1010' height='1000' version='1.1' style='background-color:rgba(32%2c32%2c32%2c.4)'%3e%3cg class='layer'%3e%3cpath id='svg_1' fill='white' d='m402.87%2c60.55l-15.2%2c28.51l-83.62%2c-47.51l-81.72%2c47.51l-15.2%2c-28.51l96.92%2c-58.91l98.82%2c58.91zm-239.45%2c62.71l-64.61%2c38.01l58.91%2c34.21l-19%2c26.61l-57.01%2c-30.41l0%2c72.21l-34.21%2c0l0%2c-110.22l98.82%2c-58.91l17.1%2c28.51zm399.08%2c140.63l-34.21%2c0l0%2c-72.21l-55.11%2c30.41l-19%2c-26.61l58.91%2c-34.21l-66.51%2c-38.01l17.1%2c-28.51l98.82%2c58.91l0%2c110.22zm-271.75%2c43.71l-72.21%2c-41.81l13.3%2c-26.61l74.11%2c41.81l74.11%2c-41.81l15.2%2c26.61l-72.21%2c41.81l0%2c81.72l-32.31%2c0l0%2c-81.72zm-127.32%2c171.03l-17.1%2c28.51l-98.82%2c-58.91l0%2c-112.12l34.21%2c0l0%2c93.12l81.72%2c49.41zm399.08%2c-142.53l0%2c112.12l-98.82%2c58.91l-17.1%2c-28.51l81.72%2c-49.41l0%2c-93.12l34.21%2c0zm-159.63%2c203.34l-98.82%2c58.91l-96.92%2c-58.91l15.2%2c-28.51l68.41%2c39.91l0%2c-70.31l32.31%2c0l0%2c68.41l64.61%2c-38.01l15.2%2c28.51z' transform='translate(205%2c 200)'/%3e%3c/g%3e%3c/svg%3e";const Hx=new ys,jx=new ys,Wx=new ys,$x=new ys,qx=new As,Xx=(e,t)=>(e%t+t)%t;class Kx{value;source;target;timer=0;transitionTime=0;constructor(e){this.value=e,this.source={...e},this.target={...e}}goto(e,t=.25){0===t&&Kx.copy(this.value,e),Kx.copy(this.source,this.value),Kx.copy(this.target,e),this.timer=0,this.transitionTime=t}update(e){this.timer<this.transitionTime?(this.timer=Math.min(this.timer+e,this.transitionTime),Kx.lerp(this.value,this.source,this.target,Kx.quintic(this.timer/this.transitionTime))):Kx.copy(this.value,this.target)}static quintic(e){return Math.pow(e-1,5)+1}static copy(e,t){Object.keys(e).forEach((s=>{e[s]=t[s]}))}static lerp(e,t,s,i){Object.keys(e).forEach((n=>{e[n]=t[n]+i*(s[n]-t[n])}))}}class Yx{options;dom;events=new Kt;active=!1;rotating=!1;constructor(e){this.options=e;const t=e.xr;t.domOverlay.root=this._createRotateInput(),this.options.showUI&&this._createUI(),this._createModelHandler();t.on(`available: ${lv}`,(e=>{this.events.fire("xr:available",e)})),t.on("start",(()=>{var e;this.active=!0,this.events.fire("xr:started"),e=e=>{this.events.fire("xr:initial-place",e),navigator?.vibrate(10),t.hitTest.start({profile:"generic-touchscreen",entityTypes:[cv,dv,uv],callback:(e,t)=>{e?console.log(e):t.on("result",(e=>{this.rotating||this.events.fire("xr:place",e)}))}})},t.hitTest.start({spaceType:hv,entityTypes:[cv,dv,uv],callback:(t,s)=>{t?console.log(t):s.on("result",(t=>{e(t),s.remove()}))}})})),t.on("end",(()=>{this.active=!1,this.events.fire("xr:ended")}))}get available(){return this.options.xr.isAvailable(lv)}_createRotateInput(){const e=new Map;let t=0,s=0;const i=e=>{e.preventDefault(),e.stopPropagation()},n=t=>{i(t),e.set(t.pointerId,{start:{x:t.clientX,y:t.clientY},previous:{x:t.clientX,y:t.clientY},current:{x:t.clientX,y:t.clientY}}),this.rotating?1===e.size&&(this.rotating=!1):this.rotating=e.size>1},r=n=>{i(n);const r=e.get(n.pointerId);if(r&&(r.previous.x=r.current.x,r.previous.y=r.current.y,r.current.x=n.clientX,r.current.y=n.clientY),2===e.size){const i=Array.from(e.keys()),n=e.get(i[0]),r=e.get(i[1]),a=Math.atan2(r.start.y-n.start.y,r.start.x-n.start.x),o=Math.atan2(r.current.y-n.current.y,r.current.x-n.current.x);s=o-a,this.events.fire("xr:rotate",-180*(t+s)/Math.PI)}},a=n=>{i(n),2===e.size&&(t+=s),e.delete(n.pointerId)},o=document.createElement("div");return o.style.position="fixed",o.style.top="0",o.style.left="0",o.style.width="100%",o.style.height="100%",o.style.touchAction="none",o.style.display="none",document.body.appendChild(o),this.events.on("xr:started",(()=>{o.style.display="block",o.addEventListener("pointerdown",n),o.addEventListener("pointermove",r),o.addEventListener("pointerup",a)})),this.events.on("xr:ended",(()=>{o.style.display="none",o.removeEventListener("pointerdown",n),o.removeEventListener("pointermove",r),o.removeEventListener("pointerup",a)})),o}_createUI(){const e=document.createElement("img");e.src=this.options.startArImgSrc,e.style.position="fixed",e.style.right="20px",e.style.top="20px",e.style.width="36px",e.style.height="36px",e.style.opacity="100%",e.style.display="none",document.body.appendChild(e);let t=!0;this.events.on("xr:available",(t=>{e.style.display=t?"block":"none"})),this.events.on("xr:started",(()=>{t=!0,e.src=this.options.stopArImgSrc,this.options.xr.domOverlay.root.appendChild(e)})),this.events.on("xr:ended",(()=>{t=!0,e.src=this.options.startArImgSrc,document.body.appendChild(e)})),e.addEventListener("click",(()=>{t&&(t=!1,this.active?this.end():this.start())}))}_createModelHandler(){const e=this.options.xr,t=this.events,s=new Kx({x:0,y:0,z:0}),i=new Kx({x:0,y:0,z:0}),n=new Kx({scale:1}),r=.25;let a=!0;const o=new ys,l=new Bs;let h;const c=()=>{if(h.length){l.copy(h[0].aabb);for(let e=1;e<h.length;++e)l.add(h[e].aabb)}};t.on("xr:start",(()=>{a=!0,h=this.options.content.findComponents("render").map((e=>e.meshInstances)).flat().concat(this.options.content.findComponents("gsplat").map((e=>e.instance.meshInstance))),c();const e=l.halfExtents;o.set(0,-e.y,4*-e.length())})),t.on("xr:initial-place",(t=>{qx.copy(e.camera.camera.viewMatrix).invert(),qx.transformPoint(o,Hx),qx.getEulerAngles(jx),s.goto({x:Hx.x,y:Hx.y,z:Hx.z},0),i.goto({x:jx.x,y:jx.y,z:jx.z},0),n.goto({scale:.55},0),i.goto({x:0,y:0,z:0},r),s.goto({x:t.x,y:t.y,z:t.z},r),a=!1})),t.on("xr:place",(e=>{s.goto({x:e.x,y:e.y,z:e.z},r)})),t.on("xr:rotate",(e=>{e=Xx(e,360),i.goto({x:0,y:e,z:0},r),i.source.y=e-180+Xx(i.source.y-e+180,360)})),t.on("xr:ended",(()=>{this.options.content.setLocalPosition(0,0,0),this.options.content.setLocalEulerAngles(0,0,0)})),e.app.on("frameupdate",(e=>{const t=e/1e3;s.update(t),i.update(t),n.update(t)})),e.on("update",(()=>{const e=this.options.xr;if(!e.views.list.length)return;qx.copy(e.camera.camera.viewMatrix).invert();const t=this.options.content;a?(qx.transformPoint(o,Hx),qx.getEulerAngles(jx),t.setLocalPosition(Hx.x,Hx.y,Hx.z),t.setLocalEulerAngles(jx.x,jx.y,jx.z),t.setLocalScale(1,1,1)):(t.setLocalPosition(s.value.x,s.value.y,s.value.z),t.setLocalEulerAngles(i.value.x,i.value.y,i.value.z),t.setLocalScale(n.value.scale,n.value.scale,n.value.scale)),c();const r=l.center,h=l.halfExtents.length();qx.getZ($x),qx.getTranslation(Wx),Hx.sub2(r,Wx);const d=-Hx.dot($x),u=d+h,p=Math.max(1e-4,d<h?u/1024:d-h);e._setClipPlanes(p/1.5,1.5*u),this.events.fire("xr:update")}))}start(){this.available&&!this.active&&(this.events.fire("xr:start"),this.options.xr.start(this.options.camera.camera,lv,"local",{callback:e=>{e&&console.log(e)}}))}end(){this.options.xr.end()}}var Qx=function(){var e=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]),t=new Uint8Array([32,0,65,2,1,106,34,33,3,128,11,4,13,64,6,253,10,7,15,116,127,5,8,12,40,16,19,54,20,9,27,255,113,17,42,67,24,23,146,148,18,14,22,45,70,69,56,114,101,21,25,63,75,136,108,28,118,29,73,115]);if("object"!=typeof WebAssembly)return{supported:!1};var s,i=WebAssembly.validate(e)?"b9H79TebbbeKl9Gbb9Gvuuuuueu9Giuuub9Geueuikqbbebeedddilve9Weeeviebeoweuec:q;Aekr;leDo9TW9T9VV95dbH9F9F939H79T9F9J9H229F9Jt9VV7bb8A9TW79O9V9Wt9F9KW9J9V9KW9wWVtW949c919M9MWVbdY9TW79O9V9Wt9F9KW9J9V9KW69U9KW949c919M9MWVblE9TW79O9V9Wt9F9KW9J9V9KW69U9KW949tWG91W9U9JWbvL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9p9JtboK9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9r919HtbrL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWVT949Wbwl79IV9RbDq;t9tqlbzik9:evu8Jjjjjbcz9Rhbcbheincbhdcbhiinabcwfadfaicjuaead4ceGglE86bbaialfhiadcefgdcw9hmbkaec:q:yjjbfai86bbaecitc:q1jjbfab8Piw83ibaecefgecjd9hmbkk;h8JlHud97euo978Jjjjjbcj;kb9Rgv8Kjjjjbc9:hodnadcefal0mbcuhoaiRbbc:Ge9hmbavaialfgrad9Rad;8qbbcj;abad9UhoaicefhldnadTmbaoc;WFbGgocjdaocjd6EhwcbhDinaDae9pmeawaeaD9RaDawfae6Egqcsfgoc9WGgkci2hxakcethmaocl4cifcd4hPabaDad2fhscbhzdnincehHalhOcbhAdninaraO9RaP6miavcj;cbfaAak2fhCaOaPfhlcbhidnakc;ab6mbaral9Rc;Gb6mbcbhoinaCaofhidndndndndnaOaoco4fRbbgXciGPlbedibkaipxbbbbbbbbbbbbbbbbpklbxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaialpbbbpklbalczfhlkdndndndndnaXcd4ciGPlbedibkaipxbbbbbbbbbbbbbbbbpklzxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklzalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklzalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaialpbbbpklzalczfhlkdndndndndnaXcl4ciGPlbedibkaipxbbbbbbbbbbbbbbbbpklaxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklaalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklaalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaialpbbbpklaalczfhlkdndndndndnaXco4Plbedibkaipxbbbbbbbbbbbbbbbbpkl8WxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibaXc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spkl8WalclfaYpQbfaXc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibaXc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spkl8WalcwfaYpQbfaXc:q:yjjbfRbbfhlxekaialpbbbpkl8Walczfhlkaoc;abfhiaocjefak0meaihoaral9Rc;Fb0mbkkdndnaiak9pmbaici4hoinaral9RcK6mdaCaifhXdndndndndnaOaico4fRbbaocoG4ciGPlbedibkaXpxbbbbbbbbbbbbbbbbpklbxikaXalpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaXalpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaXalpbbbpklbalczfhlkaocdfhoaiczfgiak6mbkkalTmbaAci6hHalhOaAcefgohAaoclSmdxekkcbhlaHceGmdkdnakTmbavcjdfazfhiavazfpbdbhYcbhXinaiavcj;cbfaXfgopblbgLcep9TaLpxeeeeeeeeeeeeeeeegQp9op9Hp9rgLaoakfpblbg8Acep9Ta8AaQp9op9Hp9rg8ApmbzeHdOiAlCvXoQrLgEaoamfpblbg3cep9Ta3aQp9op9Hp9rg3aoaxfpblbg5cep9Ta5aQp9op9Hp9rg5pmbzeHdOiAlCvXoQrLg8EpmbezHdiOAlvCXorQLgQaQpmbedibedibedibediaYp9UgYp9AdbbaiadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfgoaYaEa8EpmwDKYqk8AExm35Ps8E8FgQaQpmbedibedibedibedip9UgYp9AdbbaoadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfgoaYaLa8ApmwKDYq8AkEx3m5P8Es8FgLa3a5pmwKDYq8AkEx3m5P8Es8Fg8ApmbezHdiOAlvCXorQLgQaQpmbedibedibedibedip9UgYp9AdbbaoadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfgoaYaLa8ApmwDKYqk8AExm35Ps8E8FgQaQpmbedibedibedibedip9UgYp9AdbbaoadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfhiaXczfgXak6mbkkazclfgzad6mbkasavcjdfaqad2;8qbbavavcjdfaqcufad2fad;8qbbaqaDfhDc9:hoalmexikkc9:hoxekcbc99aral9Radcaadca0ESEhokavcj;kbf8Kjjjjbaokwbz:bjjjbk;uzeHu8Jjjjjbc;ae9Rgv8Kjjjjbc9:hodnaeci9UgrcHfal0mbcuhoaiRbbgwc;WeGc;Ge9hmbawcsGgDce0mbavc;abfcFecje;8kbavcUf9cu83ibavc8Wf9cu83ibavcyf9cu83ibavcaf9cu83ibavcKf9cu83ibavczf9cu83ibav9cu83iwav9cu83ibaialfc9WfhqaicefgwarfhodnaeTmbcmcsaDceSEhkcbhxcbhmcbhDcbhicbhlindnaoaq9nmbc9:hoxikdndnawRbbgrc;Ve0mbavc;abfalarcl4cu7fcsGcitfgPydlhsaPydbhzdnarcsGgPak9pmbavaiarcu7fcsGcdtfydbaxaPEhraPThPdndnadcd9hmbabaDcetfgHaz87ebaHcdfas87ebaHclfar87ebxekabaDcdtfgHazBdbaHclfasBdbaHcwfarBdbkaxaPfhxavc;abfalcitfgHarBdbaHasBdlavaicdtfarBdbavc;abfalcefcsGglcitfgHazBdbaHarBdlaiaPfhialcefhlxdkdndnaPcsSmbamaPfaPc987fcefhmxekaocefhrao8SbbgPcFeGhHdndnaPcu9mmbarhoxekaocvfhoaHcFbGhHcrhPdninar8SbbgOcFbGaPtaHVhHaOcu9kmearcefhraPcrfgPc8J9hmbxdkkarcefhokaHce4cbaHceG9R7amfhmkdndnadcd9hmbabaDcetfgraz87ebarcdfas87ebarclfam87ebxekabaDcdtfgrazBdbarclfasBdbarcwfamBdbkavc;abfalcitfgramBdbarasBdlavaicdtfamBdbavc;abfalcefcsGglcitfgrazBdbaramBdlaicefhialcefhlxekdnarcpe0mbaxcefgOavaiaqarcsGfRbbgPcl49RcsGcdtfydbaPcz6gHEhravaiaP9RcsGcdtfydbaOaHfgsaPcsGgOEhPaOThOdndnadcd9hmbabaDcetfgzax87ebazcdfar87ebazclfaP87ebxekabaDcdtfgzaxBdbazclfarBdbazcwfaPBdbkavaicdtfaxBdbavc;abfalcitfgzarBdbazaxBdlavaicefgicsGcdtfarBdbavc;abfalcefcsGcitfgzaPBdbazarBdlavaiaHfcsGgicdtfaPBdbavc;abfalcdfcsGglcitfgraxBdbaraPBdlalcefhlaiaOfhiasaOfhxxekaxcbaoRbbgzEgAarc;:eSgrfhsazcsGhCazcl4hXdndnazcs0mbascefhOxekashOavaiaX9RcsGcdtfydbhskdndnaCmbaOcefhxxekaOhxavaiaz9RcsGcdtfydbhOkdndnarTmbaocefhrxekaocdfhrao8SbegHcFeGhPdnaHcu9kmbaocofhAaPcFbGhPcrhodninar8SbbgHcFbGaotaPVhPaHcu9kmearcefhraocrfgoc8J9hmbkaAhrxekarcefhrkaPce4cbaPceG9R7amfgmhAkdndnaXcsSmbarhPxekarcefhPar8SbbgocFeGhHdnaocu9kmbarcvfhsaHcFbGhHcrhodninaP8SbbgrcFbGaotaHVhHarcu9kmeaPcefhPaocrfgoc8J9hmbkashPxekaPcefhPkaHce4cbaHceG9R7amfgmhskdndnaCcsSmbaPhoxekaPcefhoaP8SbbgrcFeGhHdnarcu9kmbaPcvfhOaHcFbGhHcrhrdninao8SbbgPcFbGartaHVhHaPcu9kmeaocefhoarcrfgrc8J9hmbkaOhoxekaocefhokaHce4cbaHceG9R7amfgmhOkdndnadcd9hmbabaDcetfgraA87ebarcdfas87ebarclfaO87ebxekabaDcdtfgraABdbarclfasBdbarcwfaOBdbkavc;abfalcitfgrasBdbaraABdlavaicdtfaABdbavc;abfalcefcsGcitfgraOBdbarasBdlavaicefgicsGcdtfasBdbavc;abfalcdfcsGcitfgraABdbaraOBdlavaiazcz6aXcsSVfgicsGcdtfaOBdbaiaCTaCcsSVfhialcifhlkawcefhwalcsGhlaicsGhiaDcifgDae6mbkkcbc99aoaqSEhokavc;aef8Kjjjjbaok:llevu8Jjjjjbcz9Rhvc9:hodnaecvfal0mbcuhoaiRbbc;:eGc;qe9hmbav9cb83iwaicefhraialfc98fhwdnaeTmbdnadcdSmbcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcdtfaicd4cbaice4ceG9R7avcwfaiceGcdtVgoydbfglBdbaoalBdbaDcefgDae9hmbxdkkcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcetfaicd4cbaice4ceG9R7avcwfaiceGcdtVgoydbfgl87ebaoalBdbaDcefgDae9hmbkkcbc99arawSEhokaok:EPliuo97eue978Jjjjjbca9Rhidndnadcl9hmbdnaec98GglTmbcbhvabhdinadadpbbbgocKp:RecKp:Sep;6egraocwp:RecKp:Sep;6earp;Geaoczp:RecKp:Sep;6egwp;Gep;Kep;LegDpxbbbbbbbbbbbbbbbbp:2egqarpxbbbjbbbjbbbjbbbjgkp9op9rp;Kegrpxbb;:9cbb;:9cbb;:9cbb;:9cararp;MeaDaDp;Meawaqawakp9op9rp;Kegrarp;Mep;Kep;Kep;Jep;Negwp;Mepxbbn0bbn0bbn0bbn0gqp;KepxFbbbFbbbFbbbFbbbp9oaopxbbbFbbbFbbbFbbbFp9op9qarawp;Meaqp;Kecwp:RepxbFbbbFbbbFbbbFbbp9op9qaDawp;Meaqp;Keczp:RepxbbFbbbFbbbFbbbFbp9op9qpkbbadczfhdavclfgval6mbkkalae9pmeaiaeciGgvcdtgdVcbczad9R;8kbaiabalcdtfglad;8qbbdnavTmbaiaipblbgocKp:RecKp:Sep;6egraocwp:RecKp:Sep;6earp;Geaoczp:RecKp:Sep;6egwp;Gep;Kep;LegDpxbbbbbbbbbbbbbbbbp:2egqarpxbbbjbbbjbbbjbbbjgkp9op9rp;Kegrpxbb;:9cbb;:9cbb;:9cbb;:9cararp;MeaDaDp;Meawaqawakp9op9rp;Kegrarp;Mep;Kep;Kep;Jep;Negwp;Mepxbbn0bbn0bbn0bbn0gqp;KepxFbbbFbbbFbbbFbbbp9oaopxbbbFbbbFbbbFbbbFp9op9qarawp;Meaqp;Kecwp:RepxbFbbbFbbbFbbbFbbp9op9qaDawp;Meaqp;Keczp:RepxbbFbbbFbbbFbbbFbp9op9qpklbkalaiad;8qbbskdnaec98GgxTmbcbhvabhdinadczfglalpbbbgopxbbbbbbFFbbbbbbFFgkp9oadpbbbgDaopmlvorxmPsCXQL358E8FpxFubbFubbFubbFubbp9op;6eaDaopmbediwDqkzHOAKY8AEgoczp:Sep;6egrp;Geaoczp:Reczp:Sep;6egwp;Gep;Kep;Legopxb;:FSb;:FSb;:FSb;:FSawaopxbbbbbbbbbbbbbbbbp:2egqawpxbbbjbbbjbbbjbbbjgmp9op9rp;Kegwawp;Meaoaop;Mearaqaramp9op9rp;Kegoaop;Mep;Kep;Kep;Jep;Negrp;Mepxbbn0bbn0bbn0bbn0gqp;Keczp:Reawarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9op9qgwaoarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9ogopmwDKYqk8AExm35Ps8E8Fp9qpkbbadaDakp9oawaopmbezHdiOAlvCXorQLp9qpkbbadcafhdavclfgvax6mbkkaxae9pmbaiaeciGgvcitgdfcbcaad9R;8kbaiabaxcitfglad;8qbbdnavTmbaiaipblzgopxbbbbbbFFbbbbbbFFgkp9oaipblbgDaopmlvorxmPsCXQL358E8FpxFubbFubbFubbFubbp9op;6eaDaopmbediwDqkzHOAKY8AEgoczp:Sep;6egrp;Geaoczp:Reczp:Sep;6egwp;Gep;Kep;Legopxb;:FSb;:FSb;:FSb;:FSawaopxbbbbbbbbbbbbbbbbp:2egqawpxbbbjbbbjbbbjbbbjgmp9op9rp;Kegwawp;Meaoaop;Mearaqaramp9op9rp;Kegoaop;Mep;Kep;Kep;Jep;Negrp;Mepxbbn0bbn0bbn0bbn0gqp;Keczp:Reawarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9op9qgwaoarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9ogopmwDKYqk8AExm35Ps8E8Fp9qpklzaiaDakp9oawaopmbezHdiOAlvCXorQLp9qpklbkalaiad;8qbbkk;4wllue97euv978Jjjjjbc8W9Rhidnaec98GglTmbcbhvabhoinaiaopbbbgraoczfgwpbbbgDpmlvorxmPsCXQL358E8Fgqczp:Segkclp:RepklbaopxbbjZbbjZbbjZbbjZpx;Zl81Z;Zl81Z;Zl81Z;Zl81Zakpxibbbibbbibbbibbbp9qp;6ep;NegkaraDpmbediwDqkzHOAKY8AEgrczp:Reczp:Sep;6ep;MegDaDp;Meakarczp:Sep;6ep;Megxaxp;Meakaqczp:Reczp:Sep;6ep;Megqaqp;Mep;Kep;Kep;Lepxbbbbbbbbbbbbbbbbp:4ep;Jepxb;:FSb;:FSb;:FSb;:FSgkp;Mepxbbn0bbn0bbn0bbn0grp;KepxFFbbFFbbFFbbFFbbgmp9oaxakp;Mearp;Keczp:Rep9qgxaqakp;Mearp;Keczp:ReaDakp;Mearp;Keamp9op9qgkpmbezHdiOAlvCXorQLgrp5baipblbpEb:T:j83ibaocwfarp5eaipblbpEe:T:j83ibawaxakpmwDKYqk8AExm35Ps8E8Fgkp5baipblbpEd:T:j83ibaocKfakp5eaipblbpEi:T:j83ibaocafhoavclfgval6mbkkdnalae9pmbaiaeciGgvcitgofcbcaao9R;8kbaiabalcitfgwao;8qbbdnavTmbaiaipblbgraipblzgDpmlvorxmPsCXQL358E8Fgqczp:Segkclp:RepklaaipxbbjZbbjZbbjZbbjZpx;Zl81Z;Zl81Z;Zl81Z;Zl81Zakpxibbbibbbibbbibbbp9qp;6ep;NegkaraDpmbediwDqkzHOAKY8AEgrczp:Reczp:Sep;6ep;MegDaDp;Meakarczp:Sep;6ep;Megxaxp;Meakaqczp:Reczp:Sep;6ep;Megqaqp;Mep;Kep;Kep;Lepxbbbbbbbbbbbbbbbbp:4ep;Jepxb;:FSb;:FSb;:FSb;:FSgkp;Mepxbbn0bbn0bbn0bbn0grp;KepxFFbbFFbbFFbbFFbbgmp9oaxakp;Mearp;Keczp:Rep9qgxaqakp;Mearp;Keczp:ReaDakp;Mearp;Keamp9op9qgkpmbezHdiOAlvCXorQLgrp5baipblapEb:T:j83ibaiarp5eaipblapEe:T:j83iwaiaxakpmwDKYqk8AExm35Ps8E8Fgkp5baipblapEd:T:j83izaiakp5eaipblapEi:T:j83iKkawaiao;8qbbkk:Pddiue978Jjjjjbc;ab9Rhidnadcd4ae2glc98GgvTmbcbhdabheinaeaepbbbgocwp:Recwp:Sep;6eaocep:SepxbbjZbbjZbbjZbbjZp:UepxbbjFbbjFbbjFbbjFp9op;Mepkbbaeczfheadclfgdav6mbkkdnaval9pmbaialciGgdcdtgeVcbc;abae9R;8kbaiabavcdtfgvae;8qbbdnadTmbaiaipblbgocwp:Recwp:Sep;6eaocep:SepxbbjZbbjZbbjZbbjZp:UepxbbjFbbjFbbjFbbjFp9op;Mepklbkavaiae;8qbbkk9teiucbcbydj1jjbgeabcifc98GfgbBdj1jjbdndnabZbcztgd9nmbcuhiabad9RcFFifcz4nbcuSmekaehikaikkkebcjwklz9Tbb":"b9H79Tebbbe8Fv9Gbb9Gvuuuuueu9Giuuub9Geueu9Giuuueuikqbeeedddillviebeoweuec:q;iekr;leDo9TW9T9VV95dbH9F9F939H79T9F9J9H229F9Jt9VV7bb8A9TW79O9V9Wt9F9KW9J9V9KW9wWVtW949c919M9MWVbeY9TW79O9V9Wt9F9KW9J9V9KW69U9KW949c919M9MWVbdE9TW79O9V9Wt9F9KW9J9V9KW69U9KW949tWG91W9U9JWbiL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9p9JtblK9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9r919HtbvL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWVT949Wbol79IV9Rbrq:P8Yqdbk;3sezu8Jjjjjbcj;eb9Rgv8Kjjjjbc9:hodnadcefal0mbcuhoaiRbbc:Ge9hmbavaialfgrad9Radz1jjjbhwcj;abad9UhoaicefhldnadTmbaoc;WFbGgocjdaocjd6EhDcbhqinaqae9pmeaDaeaq9RaqaDfae6Egkcsfgocl4cifcd4hxdndndndnaoc9WGgmTmbcbhPcehsawcjdfhzalhHinaraH9Rax6midnaraHaxfgl9RcK6mbczhoinawcj;cbfaogifgoc9WfhOdndndndndnaHaic9WfgAco4fRbbaAci4coG4ciGPlbedibkaO9cb83ibaOcwf9cb83ibxikaOalRblalRbbgAco4gCaCciSgCE86bbaocGfalclfaCfgORbbaAcl4ciGgCaCciSgCE86bbaocVfaOaCfgORbbaAcd4ciGgCaCciSgCE86bbaoc7faOaCfgORbbaAciGgAaAciSgAE86bbaoctfaOaAfgARbbalRbegOco4gCaCciSgCE86bbaoc91faAaCfgARbbaOcl4ciGgCaCciSgCE86bbaoc4faAaCfgARbbaOcd4ciGgCaCciSgCE86bbaoc93faAaCfgARbbaOciGgOaOciSgOE86bbaoc94faAaOfgARbbalRbdgOco4gCaCciSgCE86bbaoc95faAaCfgARbbaOcl4ciGgCaCciSgCE86bbaoc96faAaCfgARbbaOcd4ciGgCaCciSgCE86bbaoc97faAaCfgARbbaOciGgOaOciSgOE86bbaoc98faAaOfgORbbalRbiglco4gAaAciSgAE86bbaoc99faOaAfgORbbalcl4ciGgAaAciSgAE86bbaoc9:faOaAfgORbbalcd4ciGgAaAciSgAE86bbaocufaOaAfgoRbbalciGglalciSglE86bbaoalfhlxdkaOalRbwalRbbgAcl4gCaCcsSgCE86bbaocGfalcwfaCfgORbbaAcsGgAaAcsSgAE86bbaocVfaOaAfgORbbalRbegAcl4gCaCcsSgCE86bbaoc7faOaCfgORbbaAcsGgAaAcsSgAE86bbaoctfaOaAfgORbbalRbdgAcl4gCaCcsSgCE86bbaoc91faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc4faOaAfgORbbalRbigAcl4gCaCcsSgCE86bbaoc93faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc94faOaAfgORbbalRblgAcl4gCaCcsSgCE86bbaoc95faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc96faOaAfgORbbalRbvgAcl4gCaCcsSgCE86bbaoc97faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc98faOaAfgORbbalRbogAcl4gCaCcsSgCE86bbaoc99faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc9:faOaAfgORbbalRbrglcl4gAaAcsSgAE86bbaocufaOaAfgoRbbalcsGglalcsSglE86bbaoalfhlxekaOal8Pbb83bbaOcwfalcwf8Pbb83bbalczfhlkdnaiam9pmbaiczfhoaral9RcL0mekkaiam6mialTmidnakTmbawaPfRbbhOcbhoazhiinaiawcj;cbfaofRbbgAce4cbaAceG9R7aOfgO86bbaiadfhiaocefgoak9hmbkkazcefhzaPcefgPad6hsalhHaPad9hmexvkkcbhlasceGmdxikalaxad2fhCdnakTmbcbhHcehsawcjdfhminaral9Rax6mialTmdalaxfhlawaHfRbbhOcbhoamhiinaiawcj;cbfaofRbbgAce4cbaAceG9R7aOfgO86bbaiadfhiaocefgoak9hmbkamcefhmaHcefgHad6hsaHad9hmbkaChlxikcbhocehsinaral9Rax6mdalTmealaxfhlaocefgoad6hsadao9hmbkaChlxdkcbhlasceGTmekc9:hoxikabaqad2fawcjdfakad2z1jjjb8Aawawcjdfakcufad2fadz1jjjb8Aakaqfhqalmbkc9:hoxekcbc99aral9Radcaadca0ESEhokavcj;ebf8Kjjjjbaok;yzeHu8Jjjjjbc;ae9Rgv8Kjjjjbc9:hodnaeci9UgrcHfal0mbcuhoaiRbbgwc;WeGc;Ge9hmbawcsGgDce0mbavc;abfcFecjez:jjjjb8AavcUf9cu83ibavc8Wf9cu83ibavcyf9cu83ibavcaf9cu83ibavcKf9cu83ibavczf9cu83ibav9cu83iwav9cu83ibaialfc9WfhqaicefgwarfhodnaeTmbcmcsaDceSEhkcbhxcbhmcbhDcbhicbhlindnaoaq9nmbc9:hoxikdndnawRbbgrc;Ve0mbavc;abfalarcl4cu7fcsGcitfgPydlhsaPydbhzdnarcsGgPak9pmbavaiarcu7fcsGcdtfydbaxaPEhraPThPdndnadcd9hmbabaDcetfgHaz87ebaHcdfas87ebaHclfar87ebxekabaDcdtfgHazBdbaHclfasBdbaHcwfarBdbkaxaPfhxavc;abfalcitfgHarBdbaHasBdlavaicdtfarBdbavc;abfalcefcsGglcitfgHazBdbaHarBdlaiaPfhialcefhlxdkdndnaPcsSmbamaPfaPc987fcefhmxekaocefhrao8SbbgPcFeGhHdndnaPcu9mmbarhoxekaocvfhoaHcFbGhHcrhPdninar8SbbgOcFbGaPtaHVhHaOcu9kmearcefhraPcrfgPc8J9hmbxdkkarcefhokaHce4cbaHceG9R7amfhmkdndnadcd9hmbabaDcetfgraz87ebarcdfas87ebarclfam87ebxekabaDcdtfgrazBdbarclfasBdbarcwfamBdbkavc;abfalcitfgramBdbarasBdlavaicdtfamBdbavc;abfalcefcsGglcitfgrazBdbaramBdlaicefhialcefhlxekdnarcpe0mbaxcefgOavaiaqarcsGfRbbgPcl49RcsGcdtfydbaPcz6gHEhravaiaP9RcsGcdtfydbaOaHfgsaPcsGgOEhPaOThOdndnadcd9hmbabaDcetfgzax87ebazcdfar87ebazclfaP87ebxekabaDcdtfgzaxBdbazclfarBdbazcwfaPBdbkavaicdtfaxBdbavc;abfalcitfgzarBdbazaxBdlavaicefgicsGcdtfarBdbavc;abfalcefcsGcitfgzaPBdbazarBdlavaiaHfcsGgicdtfaPBdbavc;abfalcdfcsGglcitfgraxBdbaraPBdlalcefhlaiaOfhiasaOfhxxekaxcbaoRbbgzEgAarc;:eSgrfhsazcsGhCazcl4hXdndnazcs0mbascefhOxekashOavaiaX9RcsGcdtfydbhskdndnaCmbaOcefhxxekaOhxavaiaz9RcsGcdtfydbhOkdndnarTmbaocefhrxekaocdfhrao8SbegHcFeGhPdnaHcu9kmbaocofhAaPcFbGhPcrhodninar8SbbgHcFbGaotaPVhPaHcu9kmearcefhraocrfgoc8J9hmbkaAhrxekarcefhrkaPce4cbaPceG9R7amfgmhAkdndnaXcsSmbarhPxekarcefhPar8SbbgocFeGhHdnaocu9kmbarcvfhsaHcFbGhHcrhodninaP8SbbgrcFbGaotaHVhHarcu9kmeaPcefhPaocrfgoc8J9hmbkashPxekaPcefhPkaHce4cbaHceG9R7amfgmhskdndnaCcsSmbaPhoxekaPcefhoaP8SbbgrcFeGhHdnarcu9kmbaPcvfhOaHcFbGhHcrhrdninao8SbbgPcFbGartaHVhHaPcu9kmeaocefhoarcrfgrc8J9hmbkaOhoxekaocefhokaHce4cbaHceG9R7amfgmhOkdndnadcd9hmbabaDcetfgraA87ebarcdfas87ebarclfaO87ebxekabaDcdtfgraABdbarclfasBdbarcwfaOBdbkavc;abfalcitfgrasBdbaraABdlavaicdtfaABdbavc;abfalcefcsGcitfgraOBdbarasBdlavaicefgicsGcdtfasBdbavc;abfalcdfcsGcitfgraABdbaraOBdlavaiazcz6aXcsSVfgicsGcdtfaOBdbaiaCTaCcsSVfhialcifhlkawcefhwalcsGhlaicsGhiaDcifgDae6mbkkcbc99aoaqSEhokavc;aef8Kjjjjbaok:llevu8Jjjjjbcz9Rhvc9:hodnaecvfal0mbcuhoaiRbbc;:eGc;qe9hmbav9cb83iwaicefhraialfc98fhwdnaeTmbdnadcdSmbcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcdtfaicd4cbaice4ceG9R7avcwfaiceGcdtVgoydbfglBdbaoalBdbaDcefgDae9hmbxdkkcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcetfaicd4cbaice4ceG9R7avcwfaiceGcdtVgoydbfgl87ebaoalBdbaDcefgDae9hmbkkcbc99arawSEhokaok:Lvoeue99dud99eud99dndnadcl9hmbaeTmeindndnabcdfgd8Sbb:Yab8Sbbgi:Ygl:l:tabcefgv8Sbbgo:Ygr:l:tgwJbb;:9cawawNJbbbbawawJbbbb9GgDEgq:mgkaqaicb9iEalMgwawNakaqaocb9iEarMgqaqNMM:r:vglNJbbbZJbbb:;aDEMgr:lJbbb9p9DTmbar:Ohixekcjjjj94hikadai86bbdndnaqalNJbbbZJbbb:;aqJbbbb9GEMgq:lJbbb9p9DTmbaq:Ohdxekcjjjj94hdkavad86bbdndnawalNJbbbZJbbb:;awJbbbb9GEMgw:lJbbb9p9DTmbaw:Ohdxekcjjjj94hdkabad86bbabclfhbaecufgembxdkkaeTmbindndnabclfgd8Ueb:Yab8Uebgi:Ygl:l:tabcdfgv8Uebgo:Ygr:l:tgwJb;:FSawawNJbbbbawawJbbbb9GgDEgq:mgkaqaicb9iEalMgwawNakaqaocb9iEarMgqaqNMM:r:vglNJbbbZJbbb:;aDEMgr:lJbbb9p9DTmbar:Ohixekcjjjj94hikadai87ebdndnaqalNJbbbZJbbb:;aqJbbbb9GEMgq:lJbbb9p9DTmbaq:Ohdxekcjjjj94hdkavad87ebdndnawalNJbbbZJbbb:;awJbbbb9GEMgw:lJbbb9p9DTmbaw:Ohdxekcjjjj94hdkabad87ebabcwfhbaecufgembkkk;siliui99iue99dnaeTmbcbhiabhlindndnJ;Zl81Zalcof8UebgvciV:Y:vgoal8Ueb:YNgrJb;:FSNJbbbZJbbb:;arJbbbb9GEMgw:lJbbb9p9DTmbaw:OhDxekcjjjj94hDkalclf8Uebhqalcdf8UebhkabavcefciGaiVcetfaD87ebdndnaoak:YNgwJb;:FSNJbbbZJbbb:;awJbbbb9GEMgx:lJbbb9p9DTmbax:Ohkxekcjjjj94hkkabavcdfciGaiVcetfak87ebdndnaoaq:YNgoJb;:FSNJbbbZJbbb:;aoJbbbb9GEMgx:lJbbb9p9DTmbax:Ohqxekcjjjj94hqkabavcufciGaiVcetfaq87ebdndnJbbjZararN:tawawN:taoaoN:tgrJbbbbarJbbbb9GE:rJb;:FSNJbbbZMgr:lJbbb9p9DTmbar:Ohqxekcjjjj94hqkabavciGaiVcetfaq87ebalcwfhlaiclfhiaecufgembkkk9mbdnadcd4ae2geTmbinababydbgdcwtcw91:Yadce91cjjj;8ifcjjj98G::NUdbabclfhbaecufgembkkk9teiucbcbydj1jjbgeabcifc98GfgbBdj1jjbdndnabZbcztgd9nmbcuhiabad9RcFFifcz4nbcuSmekaehikaik;LeeeudndnaeabVciGTmbabhixekdndnadcz9pmbabhixekabhiinaiaeydbBdbaiclfaeclfydbBdbaicwfaecwfydbBdbaicxfaecxfydbBdbaiczfhiaeczfheadc9Wfgdcs0mbkkadcl6mbinaiaeydbBdbaeclfheaiclfhiadc98fgdci0mbkkdnadTmbinaiaeRbb86bbaicefhiaecefheadcufgdmbkkabk;aeedudndnabciGTmbabhixekaecFeGc:b:c:ew2hldndnadcz9pmbabhixekabhiinaialBdbaicxfalBdbaicwfalBdbaiclfalBdbaiczfhiadc9Wfgdcs0mbkkadcl6mbinaialBdbaiclfhiadc98fgdci0mbkkdnadTmbinaiae86bbaicefhiadcufgdmbkkabkkkebcjwklz9Kbb",n=WebAssembly.instantiate(r(i),{}).then((function(e){(s=e.instance).exports.__wasm_call_ctors()}));function r(e){for(var s=new Uint8Array(e.length),i=0;i<e.length;++i){var n=e.charCodeAt(i);s[i]=n>96?n-97:n>64?n-39:n+4}var r=0;for(i=0;i<e.length;++i)s[r++]=s[i]<60?t[s[i]]:64*(s[i]-60)+s[++i];return s.buffer.slice(0,r)}function a(e,t,i,n,r,a){var o=s.exports.sbrk,l=i+3&-4,h=o(l*n),c=o(r.length),d=new Uint8Array(s.exports.memory.buffer);d.set(r,c);var u=e(h,i,n,c,r.length);if(0==u&&a&&a(h,l,n),t.set(d.subarray(h,h+i*n)),o(h-o(0)),0!=u)throw new Error("Malformed buffer data: "+u)}var o={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},l={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"},h=[],c=0;function d(e){var t={object:new Worker(e),pending:0,requests:{}};return t.object.onmessage=function(e){var s=e.data;t.pending-=s.count,t.requests[s.id][s.action](s.value),delete t.requests[s.id]},t}function u(e){for(var t="var instance; var ready = WebAssembly.instantiate(new Uint8Array(["+new Uint8Array(r(i))+"]), {}).then(function(result) { instance = result.instance; instance.exports.__wasm_call_ctors(); });self.onmessage = workerProcess;"+a.toString()+p.toString(),s=new Blob([t],{type:"text/javascript"}),n=URL.createObjectURL(s),o=0;o<e;++o)h[o]=d(n);URL.revokeObjectURL(n)}function p(e){n.then((function(){var t=e.data;try{var i=new Uint8Array(t.count*t.size);a(s.exports[t.mode],i,t.count,t.size,t.source,s.exports[t.filter]),self.postMessage({id:t.id,count:t.count,action:"resolve",value:i},[i.buffer])}catch(e){self.postMessage({id:t.id,count:t.count,action:"reject",value:e})}}))}return{ready:n,supported:!0,useWorkers:function(e){u(e)},decodeVertexBuffer:function(e,t,i,n,r){a(s.exports.meshopt_decodeVertexBuffer,e,t,i,n,s.exports[o[r]])},decodeIndexBuffer:function(e,t,i,n){a(s.exports.meshopt_decodeIndexBuffer,e,t,i,n)},decodeIndexSequence:function(e,t,i,n){a(s.exports.meshopt_decodeIndexSequence,e,t,i,n)},decodeGltfBuffer:function(e,t,i,n,r,h){a(s.exports[l[r]],e,t,i,n,s.exports[o[h]])},decodeGltfBufferAsync:function(e,t,i,r,d){return h.length>0?function(e,t,s,i,n){for(var r=h[0],a=1;a<h.length;++a)h[a].pending<r.pending&&(r=h[a]);return new Promise((function(a,o){var l=new Uint8Array(s),h=c++;r.pending+=e,r.requests[h]={resolve:a,reject:o},r.object.postMessage({id:h,count:e,size:t,source:l,mode:i,filter:n},[l.buffer])}))}(e,t,i,l[r],o[d]):n.then((function(){var n=new Uint8Array(e*t);return a(s.exports[l[r]],n,e,t,i,s.exports[o[d]]),n}))}}}();const Jx=["gltf","glb","vox"],Zx=new Bs(new ys(0,1,0),new ys(1,1,1)),ew=new ys,tw=new Bs;class sw{canvas;app;skyboxUrls;controlEventKeys=null;pngExporter=null;prevCameraMat;camera;initialCameraPosition;initialCameraFocus;light;sceneRoot;debugRoot;entities;entityAssets;assets;meshInstances;wireframeMeshInstances;wireframeMaterial;animTracks;animationMap;firstFrame;skyboxLoaded;animSpeed;animTransition;animLoops;showWireframe;showBounds;showSkeleton;showAxes;showGrid;normalLength;dirtyWireframe;dirtyBounds;dirtySkeleton;dirtyGrid;dirtyNormals;sceneBounds;dynamicSceneBounds;debugBounds;debugSkeleton;debugGrid;debugNormals;miniStats;observer;suppressAnimationProgressUpdate;selectedNode;multiframe;multiframeBusy=!1;readDepth=null;cursorWorld=new ys;loadTimestamp=null;shadowCatcher=null;xrMode;canvasResize=!0;cameraControls;constructor(e,t,s,i){this.canvas=e;const n=new xx(e,{mouse:new zo(e),touch:new Vo(e),keyboard:new Fo(window),graphicsDevice:t});this.app=n,this.skyboxUrls=i,this.app.scene.clusteredLightingEnabled=!1;const r=n.mouse._moveHandler;n.mouse.detach(),n.mouse._moveHandler=t=>{t.target===e&&r(t)},n.mouse.attach(e);const a=n.touch._moveHandler;n.touch.detach(),n.touch._moveHandler=t=>{t.target===e&&a(t)},n.touch.attach(e);const o=n.graphicsDevice.maxSamples>1;s.set("camera.multisampleSupported",o),s.set("camera.multisample",o&&s.get("camera.multisample")),this.pngExporter=new Bx,Rx(document.getElementById("app"),((e,t)=>{this.loadFiles(e,t)})),new ResizeObserver((()=>{this.xrMode&&!this.xrMode.active&&(this.canvasResize=!0,this.renderNextFrame())})).observe(window.document.getElementById("canvas-wrapper"));const l=n.scene.layers.getLayerById(1);n.scene.layers.remove(l),n.scene.layers.insertOpaque(l,2);const h=new vf("Camera");h.setPosition(0,1,10),this.app.root.addChild(h),h.addComponent("camera",{fov:75,frustumCulling:!0,clearColor:new os(0,0,0,0)}),h.addComponent("script"),this.cameraControls=h.script.create(yx,{attributes:{zoomMin:.001,zoomMax:10,pitchRange:new ws(-90,90)}}),h.camera.requestSceneColorMap(!0),n.keyboard.on("keydown",(e=>{if(70===e.key)this.focusSelection(!1),this.cameraControls.resetZoom(this.getZoomDist())}));const c=new vf;c.addComponent("light",{type:"directional",shadowBias:.2,shadowResolution:2048}),n.root.addChild(c),n.autoRender=!1,this.prevCameraMat=new As,n.on("update",this.update,this),n.on("framerender",this.onFrameRender,this),n.on("prerender",this.onPrerender,this),n.on("postrender",this.onPostrender,this),n.on("frameend",this.onFrameend,this);const d=new vf("sceneRoot",n);n.root.addChild(d);const u=new vf("debugRoot",n);n.root.addChild(u),this.camera=h,this.initialCameraPosition=null,this.initialCameraFocus=null,this.light=c,this.sceneRoot=d,this.debugRoot=u,this.entities=[],this.entityAssets=[],this.assets=[],this.meshInstances=[],this.wireframeMeshInstances=[];const p=new ju;p.blendState=new Rn(!0,0,1,0,0,0,1),p.useLighting=!1,p.useSkybox=!1,p.ambient=new os(0,0,0),p.diffuse=new os(0,0,0),p.specular=new os(0,0,0),p.emissive=new os(1,1,1),p.update(),this.wireframeMaterial=p,this.animTracks=[],this.animationMap={},this.firstFrame=!1,this.skyboxLoaded=!1,this.animSpeed=s.get("animation.speed"),this.animTransition=s.get("animation.transition"),this.animLoops=s.get("animation.loops"),this.showWireframe=s.get("debug.wireframe"),this.showBounds=s.get("debug.bounds"),this.showSkeleton=s.get("debug.skeleton"),this.showAxes=s.get("debug.axes"),this.normalLength=s.get("debug.normals"),this.setTonemapping(s.get("camera.tonemapping")),this.setBackgroundColor(s.get("skybox.backgroundColor")),this.setLightColor(s.get("light.color")),this.setWireframeColor(s.get("debug.wireframeColor")),this.dirtyWireframe=!1,this.dirtyBounds=!1,this.dirtySkeleton=!1,this.dirtyGrid=!1,this.dirtyNormals=!1,this.sceneBounds=new Bs,this.dynamicSceneBounds=new Bs,this.debugBounds=new Mx(n,h),this.debugSkeleton=new Mx(n,h),this.debugGrid=new Mx(n,h,!1),this.debugNormals=new Mx(n,h,!1),this.miniStats=new rb(n),this.miniStats.enabled=s.get("debug.stats"),this.observer=s;const f=this.app.graphicsDevice;f.on("devicerestored",(()=>{this.renderNextFrame()})),this.multiframe=new Ox(f,this.camera.camera),this.shadowCatcher=new Ux(n,this.camera.camera,this.debugRoot,this.sceneRoot),this.initXrMode(),this.bindControlEvents(),this.reloadSettings(),this.readDepth=new Nx(f),this.cursorWorld=new ys,e.addEventListener("dblclick",(t=>{const s=this.camera.camera,i=t.offsetX/e.clientWidth,n=1-t.offsetY/e.clientHeight;this.readDepth.read(s.renderTarget.depthBuffer,i,n).then((e=>{if(e<1){const t=new Ss(i,n,e,1).mulScalar(2).subScalar(1);s.projectionMatrix.clone().invert().transformVec4(t,t),t.mulScalar(1/t.w),this.cursorWorld.set(t.x,t.y,t.z),this.camera.getWorldTransform().transformPoint(this.cursorWorld,this.cursorWorld),this.cameraControls.focus(this.cursorWorld)}}))})),this.app.scene.layers.getLayerByName("World").transparentSortMode=3,n.start()}initXrMode(){const e=this.app.xr;this.xrMode=new Yx({xr:e,camera:this.camera,content:this.sceneRoot,showUI:!0,startArImgSrc:Gx.src,stopArImgSrc:Vx.src});const t=this.xrMode.events;t.on("xr:started",(()=>{this.setShadowCatcherEnabled(!0),this.setShadowCatcherIntensity(.4),this.setDebugGrid(!1),this.setDebugBounds(!1),this.setLightEnabled(!0),this.setLightShadow(!0),this.setLightFollow(!1),this.setCenterScene(!0),this.setSkyboxBackground("None"),this.setSkyboxExposure(0),this.setBackgroundColor(os.BLACK),this.app.scene.layers.getLayerById(2).enabled=!1,this.multiframe.blend=.5,this.cameraControls.detach()})),t.on("xr:initial-place",(()=>{this.multiframe.blend=1})),t.on("xr:ended",(()=>{this.reloadSettings(),this.setBackgroundColor(this.observer.get("skybox.backgroundColor")),this.cameraControls.attach(this.camera),this.multiframe.blend=1}))}getSelectedMeshInstances(){return this.selectedNode?this.collectMeshInstances(this.selectedNode):this.meshInstances}collectMeshInstances(e){const t=[];if(e){const s=e.findComponents("render");for(let e=0;e<s.length;e++){const i=s[e];if(i.meshInstances)for(let e=0;e<i.meshInstances.length;e++){const s=i.meshInstances[e];t.push(s)}}const i=e.findComponents("gsplat");for(let e=0;e<i.length;e++){const s=i[e];s.instance&&t.push(s.instance.meshInstance)}}return t}static calcMeshBoundingBox(e,t){if(t.length>0){e.copy(t[0].aabb);for(let s=1;s<t.length;++s)e.add(t[s].aabb)}}static calcHierBoundingBox(e,t){const s=t.getPosition();let i=s.x,n=s.y,r=s.z,a=s.x,o=s.y,l=s.z;const h=e=>{const t=e.getPosition();i=Math.min(i,t.x),n=Math.min(n,t.y),r=Math.min(r,t.z),a=Math.max(a,t.x),o=Math.max(o,t.y),l=Math.max(l,t.z);for(let t=0;t<e.children.length;++t)h(e.children[t])};h(t),e.setMinMax(new ys(i,n,r),new ys(a,o,l))}bindControlEvents(){const e={"camera.fov":this.setFov.bind(this),"camera.tonemapping":this.setTonemapping.bind(this),"camera.pixelScale":()=>{this.canvasResize=!0,this.renderNextFrame()},"camera.multisample":()=>{this.destroyRenderTargets(),this.renderNextFrame()},"camera.hq":e=>{this.multiframe.enabled=!this.app.graphicsDevice.isWebGPU&&e,this.renderNextFrame()},"skybox.value":e=>{if(this.skyboxUrls.has(e)){const t=this.skyboxUrls.get(e);this.loadFiles([{url:t,filename:t}])}else"None"===e?this.clearSkybox():this.loadFiles([{url:e,filename:e}])},"skybox.blur":this.setSkyboxBlur.bind(this),"skybox.exposure":this.setSkyboxExposure.bind(this),"skybox.rotation":this.setSkyboxRotation.bind(this),"skybox.background":this.setSkyboxBackground.bind(this),"skybox.backgroundColor":this.setBackgroundColor.bind(this),"skybox.domeProjection.domeRadius":this.setSkyboxDomeRadius.bind(this),"skybox.domeProjection.tripodOffset":this.setSkyboxTripodOffset.bind(this),"light.enabled":this.setLightEnabled.bind(this),"light.intensity":this.setLightIntensity.bind(this),"light.color":this.setLightColor.bind(this),"light.follow":this.setLightFollow.bind(this),"light.shadow":this.setLightShadow.bind(this),"shadowCatcher.enabled":this.setShadowCatcherEnabled.bind(this),"shadowCatcher.intensity":this.setShadowCatcherIntensity.bind(this),"debug.stats":this.setDebugStats.bind(this),"debug.wireframe":this.setDebugWireframe.bind(this),"debug.wireframeColor":this.setWireframeColor.bind(this),"debug.bounds":this.setDebugBounds.bind(this),"debug.skeleton":this.setDebugSkeleton.bind(this),"debug.axes":this.setDebugAxes.bind(this),"debug.grid":this.setDebugGrid.bind(this),"debug.normals":this.setNormalLength.bind(this),"debug.renderMode":this.setRenderMode.bind(this),"animation.playing":e=>{e?this.play():this.stop()},"animation.selectedTrack":this.setSelectedTrack.bind(this),"animation.speed":this.setSpeed.bind(this),"animation.transition":this.setTransition.bind(this),"animation.loops":this.setLoops.bind(this),"animation.progress":this.setAnimationProgress.bind(this),"scene.selectedNode.path":this.setSelectedNode.bind(this),"scene.variant.selected":this.setSelectedVariant.bind(this),centerScene:this.setCenterScene.bind(this)};this.controlEventKeys=Object.keys(e),this.controlEventKeys.forEach((t=>{this.observer.on(`${t}:set`,e[t])}))}reloadSettings(){this.controlEventKeys.forEach((e=>{this.observer.set(e,this.observer.get(e),!1,!1,!0)}))}clearSkybox(){this.app.scene.envAtlas=null,this.app.scene.setSkybox(null),this.renderNextFrame(),this.skyboxLoaded=!1}initSkybox(e){const t=bu.generateSkyboxCubemap(e),s=bu.generateLightingSource(e),i=bu.generateAtlas(s,{});s.destroy(),this.app.scene.envAtlas=i,this.app.scene.skybox=t,this.renderNextFrame()}loadSkybox(e){const t=this.app;if(6!==e.length){const s=new ef("skybox_equi","texture",{url:e[0].url,filename:e[0].filename});s.ready((()=>{const e=s.resource;e.type===Ai&&7===e.format&&(e.type=Mi),this.initSkybox(e)})),t.assets.add(s),t.assets.load(s)}else{const s=[["posx","negx","posy","negy","posz","negz"],["px","nx","py","ny","pz","nz"],["right","left","up","down","front","back"],["right","left","top","bottom","forward","backward"],["0","1","2","3","4","5"]],i=e=>{const t=e.toLowerCase();for(let e=0;e<s.length;++e){const i=s[e];for(let e=0;e<i.length;++e)if(-1!==t.indexOf(`${i[e]}.`))return e}return 0},n=(e,t)=>{const s=i(e.filename),n=i(t.filename);return s<n?-1:n<s?1:0};e.sort(n);const r=e.map(((e,s)=>{const i=new ef(`skybox_face${s}`,"texture",e);return t.assets.add(i),t.assets.load(i),i})),a=new ef("skybox_cubemap","cubemap",null,{textures:r.map((e=>e.id))});a.loadFaces=!0,a.on("load",(()=>{this.initSkybox(a.resource)})),t.assets.add(a),t.assets.load(a)}this.skyboxLoaded=!0}getCanvasSize(){const e=this.canvas.getBoundingClientRect();return{width:e.width,height:e.height}}getFocusPosition(e){const t=new ys;if(this.initialCameraFocus)t.copy(this.initialCameraFocus),this.initialCameraFocus=null;else{const s=this.entityAssets[0],i=s?.asset?.resource?.splatData;i?(i.calcFocalPoint(t),s.entity.getWorldTransform().transformPoint(t,t)):t.copy(e.center)}return t}getZoomDist(){const e=this.camera.camera;return Math.tan(37.5*rs.DEG_TO_RAD)/Math.tan(.5*e.fov*rs.DEG_TO_RAD)*(1/e.aspectRatio)*this.cameraControls.sceneSize+this.cameraControls.sceneSize}focusSelection(e=!0){this.calcSceneBounds(tw,this.selectedNode),this.cameraControls.sceneSize=tw.halfExtents.length();const t=this.getFocusPosition(tw);let s=null;e&&(s=new ys,this.initialCameraPosition?(s.copy(this.initialCameraPosition),this.initialCameraPosition=null):(s.copy(t),s.z+=this.getZoomDist()),this.camera.setPosition(s),this.fitCameraClipPlanes()),this.cameraControls.focus(t,s)}destroyRenderTargets(){const e=this.camera.camera.renderTarget;e&&(e.colorBuffer?.destroy(),e.depthBuffer?.destroy(),e.destroy(),this.camera.camera.renderTarget=null)}rebuildRenderTargets(){const e=this.app.graphicsDevice,t=e.width,s=e.height,i=this.camera.camera.renderTarget;if(i&&i.width===t&&i.height===s)return;this.destroyRenderTargets();const n=(t,s,i)=>new yn(e,{name:"viewer-rt-texture",width:t,height:s,format:i,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1}),r=e.maxSamples,a=n(t,s,7),o=n(t,s,Xs),l=new tr({name:"viewer-rt",colorBuffer:a,depthBuffer:o,flipY:!1,samples:this.observer.get("camera.multisample")?r:1,autoResolve:!1});this.camera.camera.renderTarget=l}resetScene(){const e=this.app;this.entities.forEach((e=>{this.sceneRoot.removeChild(e),this.shadowCatcher.onEntityRemoved(e),e.destroy()})),this.entities=[],this.entityAssets=[],this.assets.forEach((t=>{e.assets.remove(t),t.unload()})),this.assets=[],this.meshInstances=[],this.resetWireframeMeshes(),this.animTracks=[],this.animationMap={}}updateSceneStats(){let e=0,t=0,s=0,i=0,n=0,r=0,a=0,o=[];this.assets.forEach((l=>{const h=l.resource;h.splatData?(e++,n++,i+=h.splatData.numSplats,s+=4*h.splatData.numSplats,t+=64*h.splatData.numSplats):(o=o.concat(h.getMaterialVariants()??[]),h.renders.forEach((n=>{e+=n.resource.meshes.length,n.resource.meshes.forEach((e=>{s+=e.vertexBuffer.getNumVertices();const n=e.primitive[0];switch(n.type){case 0:case 2:i+=n.count;break;case 1:i+=n.count/2;break;case 3:i+=n.count-1;break;case 4:i+=n.count/3;break;case 5:case 6:i+=n.count-2}t+=e.vertexBuffer.numBytes+(e.indexBuffer?.[0]?.numBytes??0)}))})),n+=h.materials.length??0,r+=h.textures.length??0,(h.textures??[]).forEach((e=>{a+=e.resource.gpuSize})))}));const l=function(e){return e.children.map((e=>({name:e.name,path:e.path,children:l(e)})))},h=this.entities.map((e=>({name:e.name,path:e.path,children:l(e)})));this.observer.set("scene.nodes",JSON.stringify(h)),this.observer.set("scene.meshCount",e),this.observer.set("scene.materialCount",n),this.observer.set("scene.textureCount",r),this.observer.set("scene.vertexCount",s),this.observer.set("scene.primitiveCount",i),this.observer.set("scene.textureVRAM",a),this.observer.set("scene.meshVRAM",t),this.observer.set("scene.variants.list",JSON.stringify(o)),this.observer.set("scene.variant.selected",o[0])}downloadPngScreenshot(){const e=this.camera.camera.renderTarget.colorBuffer;e.read(0,0,e.width,e.height).then((t=>{this.pngExporter.export("model-viewer.png",new Uint32Array(t.buffer.slice(0)),e.width,e.height)}))}fitCameraClipPlanes(){if(this.xrMode?.active)return;const e=this.camera.getWorldTransform(),t=e.getTranslation(),s=e.getZ(),i=this.dynamicSceneBounds,n=i.center,r=2*i.halfExtents.length();ew.sub2(n,t);const a=-ew.dot(s),o=a+r,l=Math.max(.001,a<r?o/1024:a-r);this.camera.camera.nearClip=l,this.camera.camera.farClip=o,this.light.light.shadowDistance=o,this.light.light.normalOffsetBias=o/1024}loadGltf(e,t){return new Promise(((s,i)=>{const n=new ef(e.filename,"container",e,null,{bufferView:{processAsync:function(e,t,s){if(e.extensions&&e.extensions.EXT_meshopt_compression){const i=e.extensions.EXT_meshopt_compression;Promise.all([Qx.ready,t[i.buffer]]).then((e=>{const t=e[1],n=i.byteOffset||0,r=i.byteLength||0,a=i.count,o=i.byteStride,l=new Uint8Array(a*o),h=new Uint8Array(t.buffer,t.byteOffset+n,r);Qx.decodeGltfBuffer(l,a,o,h,i.mode,i.filter),s(null,l)}))}else s(null,null)}.bind(this)},image:{processAsync:function(e,s){const i=t.find((t=>t.filename===decodeURIComponent(It.normalize(e.uri||""))));if(i){const e=new ef(i.filename,"texture",{url:i.url,filename:i.filename});e.on("load",(()=>{s(null,e)})),this.app.assets.add(e),this.app.assets.load(e)}else s(null,null)}.bind(this),postprocess:(e,t)=>{t.resource.anisotropy=this.app.graphicsDevice.maxAnisotropy}},buffer:{processAsync:function(e,s){const i=t.find((t=>t.filename===decodeURIComponent(It.normalize(e.uri||""))));if(i){const e=new ef(i.filename,"binary",{url:i.url,filename:i.filename});e.on("load",(()=>{s(null,new Uint8Array(e.resource))})),this.app.assets.add(e),this.app.assets.load(e)}else s(null,null)}.bind(this)}});n.on("load",(()=>s(n))),n.on("error",(e=>i(e))),this.app.assets.add(n),this.app.assets.load(n)}))}loadPly(e){return new Promise(((t,s)=>{const i=new ef(e.filename,"gsplat",e);i.on("load",(()=>t(i))),i.on("error",(e=>s(e))),this.app.assets.add(i),this.app.assets.load(i)}))}isModelFilename(e){const t=e.split("?")[0].split("/").pop().split(".");return 1===t.length||Jx.includes(t.pop().toLowerCase())}isGSplatFilename(e){const t=e.split("?")[0].split("/").pop().split(".");return t.length>0&&"ply"===t.pop().toLowerCase()}loadFiles(e,t=!1){Array.isArray(e)||(e=[e]);const s=e.reduce(((e,t)=>e||this.isModelFilename(t.filename)||this.isGSplatFilename(t.filename)),!1);if(s){t&&this.resetScene();const s=Date.now();this.observer.set("ui.spinner",!0),this.observer.set("ui.error",null),this.clearCta();const i=e.map((t=>this.isModelFilename(t.filename)?this.loadGltf(t,e):this.isGSplatFilename(t.filename)?this.loadPly(t):null));Promise.all(i).then((i=>{this.loadTimestamp=s,i.forEach((e=>{e&&this.addToScene(e)})),this.postSceneLoad();const n=e.map((e=>e.url)),r=e.map((e=>e.filename.split("/").pop()));t?(this.observer.set("scene.urls",n),this.observer.set("scene.filenames",r)):(this.observer.set("scene.urls",this.observer.get("scene.urls").concat(n)),this.observer.set("scene.filenames",this.observer.get("scene.filenames").concat(r)))})).catch((e=>{console.log(e),this.observer.set("ui.error",e?.toString()||e)})).finally((()=>{this.observer.set("ui.spinner",!1)}))}else this.loadSkybox(e);return s}setSelectedTrack(e){if("ALL_TRACKS"!==e){const t=this.animationMap[e];this.entities.forEach((e=>{e.anim?.baseLayer?.transition(t)}))}}play(){this.entities.forEach((e=>{e.anim&&(e.anim.playing=!0,e.anim.baseLayer?.play())}))}stop(){this.entities.forEach((e=>{e.anim&&(e.anim.playing=!1,e.anim.baseLayer?.pause())}))}setSpeed(e){this.animSpeed=e,this.entities.forEach((t=>{const s=t.anim;s&&(s.speed=e)}))}setTransition(e){this.animTransition=e,this.animTracks.length>0&&this.rebuildAnimTracks()}setLoops(e){this.animLoops=e,this.animTracks.length>0&&this.rebuildAnimTracks()}setAnimationProgress(e){this.suppressAnimationProgressUpdate||(this.entities.forEach((t=>{const s=t.anim,i=s?.baseLayer;i&&(this.play(),i.activeStateCurrentTime=i.activeStateDuration*e,s.update(0),s.playing=!1)})),this.renderNextFrame())}setSelectedNode(e){const t=this.app.root.findByPath(e);t&&this.observer.set("scene.selectedNode",{name:t.name,path:e,position:t.getLocalPosition().toString(),rotation:t.getLocalEulerAngles().toString(),scale:t.getLocalScale().toString()}),this.selectedNode=t,this.dirtyWireframe=!0,this.dirtyBounds=!0,this.dirtySkeleton=!0,this.renderNextFrame()}setSelectedVariant(e){e&&(this.entityAssets.forEach((t=>{-1!==t.asset.resource.getMaterialVariants().indexOf(e)&&t.asset.resource.applyMaterialVariant(t.entity,e)})),this.renderNextFrame())}setCenterScene(e){this.sceneRoot.setLocalPosition(0,0,0),this.calcSceneBounds(this.sceneBounds),e&&this.sceneRoot.setLocalPosition(-this.sceneBounds.center.x,-this.sceneBounds.getMin().y,-this.sceneBounds.center.z),this.dirtyBounds=!0,this.renderNextFrame()}setDebugStats(e){this.miniStats.enabled=e,this.renderNextFrame()}setDebugWireframe(e){this.showWireframe=e,this.dirtyWireframe=!0,this.renderNextFrame()}setWireframeColor(e){this.wireframeMaterial.emissive=new os(e.r,e.g,e.b),this.wireframeMaterial.update(),this.renderNextFrame()}setDebugBounds(e){this.showBounds=e,this.dirtyBounds=!0,this.renderNextFrame()}setDebugSkeleton(e){this.showSkeleton=e,this.dirtySkeleton=!0,this.renderNextFrame()}setDebugAxes(e){this.showAxes=e,this.dirtySkeleton=!0,this.renderNextFrame()}setDebugGrid(e){this.showGrid=e,this.dirtyGrid=!0,this.renderNextFrame()}setNormalLength(e){this.normalLength=e,this.dirtyNormals=!0,this.renderNextFrame()}setFov(e){this.camera.camera.fov=e,this.renderNextFrame()}setRenderMode(e){this.camera.camera.setShaderPass("default"!==e?`debug_${e}`:"forward"),this.renderNextFrame()}setLightEnabled(e){this.light.enabled=e,this.renderNextFrame()}setLightIntensity(e){this.light.light.intensity=e,this.renderNextFrame()}setLightColor(e){this.light.light.color=new os(e.r,e.g,e.b),this.renderNextFrame()}setLightFollow(e){this.light.reparent(e?this.camera:this.app.root),e?this.light.setLocalEulerAngles(90,0,0):this.light.setLocalEulerAngles(45,30,0),this.renderNextFrame()}setLightShadow(e){this.light.light.castShadows=e,this.renderNextFrame()}setShadowCatcherEnabled(e){this.shadowCatcher.enabled=e,this.renderNextFrame()}setShadowCatcherIntensity(e){this.shadowCatcher.intensity=e,this.renderNextFrame()}setSkyboxExposure(e){this.app.scene.skyboxIntensity=Math.pow(2,e),this.renderNextFrame()}setSkyboxRotation(e){const t=new Ds;t.setFromEulerAngles(0,e,0),this.app.scene.skyboxRotation=t,this.renderNextFrame()}setSkyboxBackground(e){const{scene:t}=this.app;switch(this.app.scene.layers.getLayerById(2).enabled="Solid Color"!==e,e){case"Solid Color":break;case"Infinite Sphere":t.sky.type=tl;break;case"Projective Dome":t.sky.type=sl;break;case"Projective Box":t.sky.type="box"}this.app.scene.skyboxMip="Infinite Sphere"===e?this.observer.get("skybox.blur"):0,this.renderNextFrame()}setSkyboxBlur(e){this.app.scene.skyboxMip="Infinite Sphere"===this.observer.get("skybox.background")?e:0,this.renderNextFrame()}setSkyboxDomeRadius(e){const t=(this.sceneBounds?.halfExtents.length()??1)*e;this.app.scene.sky.node.setLocalScale(t,t,t),this.renderNextFrame()}setSkyboxTripodOffset(e){this.app.scene.sky.center=new ys(0,e,0),this.renderNextFrame()}setTonemapping(e){const t={None:6,Linear:0,Neutral:5,Filmic:1,Hejl:2,ACES:3,ACES2:4};this.camera.camera.toneMapping=t.hasOwnProperty(e)?t[e]:3,this.renderNextFrame()}setBackgroundColor(e){const t=e=>Math.max(0,Math.min(255,Math.floor(255*e)));document.getElementById("canvas-wrapper").style.backgroundColor=`rgb(${t(e.r)}, ${t(e.g)}, ${t(e.b)})`}update(e){this.xrMode?.active||this.cameraControls.update(e);const t=this.camera.getWorldTransform();((e,t)=>{let s=0;for(let i=0;i<16;++i)s=Math.max(s,Math.abs(e.data[i]-t.data[i]));return s})(t,this.prevCameraMat)>1e-4&&(this.prevCameraMat.copy(t),this.renderNextFrame()),this.xrMode?.active&&this.renderNextFrame();let s=!1;for(let e=0;e<this.entities.length;++e){const t=this.entities[e].anim;if(t&&t.baseLayer&&t.baseLayer.playing){s=!0;break}}s&&(this.dirtyBounds=!0,this.dirtySkeleton=!0,this.dirtyNormals=!0,this.renderNextFrame(),this.observer.emit("animationUpdate")),this.miniStats.enabled&&this.renderNextFrame()}renderNextFrame(){this.app.renderNextFrame=!0,this.multiframe&&this.multiframe.moved()}clearCta(){document.querySelector("#panel-left").classList.add("no-cta"),document.querySelector("#application-canvas").classList.add("no-cta"),document.querySelector(".load-button-panel").classList.add("hide")}addToScene(e){const t=e.resource,s=t.renders&&t.renders.length>0,i=t.animations&&t.animations.length>0,n=0===this.entities.length?null:this.entities[this.entities.length-1];let r;!s&&n&&n.findComponent("render")?r=n:("container"===e.type?r=e.resource.instantiateRenderEntity():(r=e.resource.instantiate(),r.gsplat.instance.sorter.on("updated",(()=>{this.renderNextFrame()}))),this.entities.push(r),this.entityAssets.push({entity:r,asset:e}),this.sceneRoot.addChild(r),this.shadowCatcher.onEntityAdded(r)),i&&t.animations.forEach((e=>{this.animTracks.push(e.resource)})),this.assets.push(e)}postSceneLoad(){this.meshInstances=this.entities.map((e=>this.collectMeshInstances(e))).flat(),0===this.meshInstances.length&&this.observer.set("debug.skeleton",!0),this.updateSceneStats(),this.animTracks.length>0&&this.rebuildAnimTracks();const e={},t={};this.meshInstances.forEach(((s,i)=>{if(s.morphInstance){const n=s.morphInstance;t[i]=n;const r=s&&s.node&&s.node.name||`Mesh ${i}`;e[i]={name:r,targets:{}},n.morph.targets.forEach(((s,n)=>{e[i].targets[n]={name:s.name,targetIndex:n},this.observer.on(`morphs.${i}.targets.${n}.weight:set`,(e=>{t[i].setWeight(n,e),this.dirtyNormals=!0,this.renderNextFrame()}))}))}})),this.observer.suspendEvents=!0,this.observer.set("morphs",e),this.observer.suspendEvents=!1;const s=this.observer;s.on("animationUpdate",(()=>{for(let e=0;e<this.entities.length;++e){const t=this.entities[e];if(t&&t.anim){const e=t.anim.baseLayer,i=e.activeStateCurrentTime/e.activeStateDuration;this.suppressAnimationProgressUpdate=!0,s.set("animation.progress",1===i?i:i%1),this.suppressAnimationProgressUpdate=!1;break}}})),this.dirtyWireframe=this.dirtyBounds=this.dirtySkeleton=this.dirtyGrid=this.dirtyNormals=!0,this.renderNextFrame(),this.firstFrame=!0}initSceneBounds(){this.setCenterScene(this.observer.get("centerScene")),this.setSkyboxDomeRadius(this.observer.get("skybox.domeProjection.domeRadius")),this.focusSelection()}rebuildAnimTracks(){this.entities.forEach((e=>{e.anim?e.anim.removeStateGraph():(e.addComponent("anim",{activate:!0,speed:this.animSpeed}),e.anim.rootBone=e),this.animTracks.forEach(((t,s)=>{t.events=new im([{name:"transition",time:t.duration,nextTrack:`track_${s===this.animTracks.length-1?0:s+1}`}]);const i=`track_${s}`;e.anim.assignAnimation(i,t),this.animationMap[t.name]=i})),e.anim.on("transition",(t=>{"ALL_TRACKS"===this.observer.get("animation.selectedTrack")&&e.anim.baseLayer.activeStateProgress>=this.animLoops&&e.anim.baseLayer.transition(t.nextTrack,this.animTransition)}))}));const e=this.observer.get("animation"),t=Object.keys(this.animationMap);e.list=JSON.stringify(t),e.selectedTrack=t[0],e.playing=!0,this.observer.set("animation",e)}calcSceneBounds(e,t=null){const s=t?this.collectMeshInstances(t):this.meshInstances;s.length?sw.calcMeshBoundingBox(e,s):(t=t??this.sceneRoot).children.length?sw.calcHierBoundingBox(e,t):e.copy(Zx)}resetWireframeMeshes(){this.app.scene.layers.getLayerByName("World").removeMeshInstances(this.wireframeMeshInstances),this.wireframeMeshInstances.forEach((e=>{e.clearShaders()})),this.wireframeMeshInstances=[]}buildWireframeMeshes(){this.wireframeMeshInstances=this.getSelectedMeshInstances().map((e=>{const t=new Hl(e.mesh,this.wireframeMaterial,e.node);return t.renderStyle=1,t.skinInstance=e.skinInstance,t.morphInstance=e.morphInstance,t})),this.app.scene.layers.getLayerByName("World").addMeshInstances(this.wireframeMeshInstances)}onFrameRender(){if(this.canvasResize){const{width:e,height:t}=this.getCanvasSize(),s=this.observer.get("camera.pixelScale"),i=Math.floor(e*window.devicePixelRatio/s),n=Math.floor(t*window.devicePixelRatio/s);this.app.graphicsDevice.setResolution(i,n),this.observer.set("runtime.viewportWidth",i),this.observer.set("runtime.viewportHeight",n),this.canvasResize=!1}this.rebuildRenderTargets()}onPrerender(){if(!this.firstFrame){if(this.dirtyWireframe&&(this.dirtyWireframe=!1,this.resetWireframeMeshes(),this.showWireframe&&this.buildWireframeMeshes(),this.getSelectedMeshInstances().forEach((e=>{e.material.depthBias=this.showWireframe?-1:0,e.material.slopeDepthBias=this.showWireframe?1:0}))),this.dirtyBounds||this.xrMode?.active){this.dirtyBounds=!1,this.calcSceneBounds(this.dynamicSceneBounds),this.debugBounds.clear(),this.showBounds&&(this.calcSceneBounds(tw,this.selectedNode),this.debugBounds.box(tw.getMin(),tw.getMax())),this.debugBounds.update();const e=new ys(2*this.dynamicSceneBounds.halfExtents.x,2*this.dynamicSceneBounds.halfExtents.y,2*this.dynamicSceneBounds.halfExtents.z);this.observer.set("scene.bounds",e.toString())}if(this.dirtyNormals){if(this.dirtyNormals=!1,this.debugNormals.clear(),this.normalLength>0)for(let e=0;e<this.meshInstances.length;++e){const t=this.meshInstances[e],s=t.morphInstance?t.morphInstance._vertexBuffer:t.mesh.vertexBuffer;if(s){const e=t.skinInstance?t.skinInstance.matrices:null;e&&t.skinInstance.updateMatrices(t.node),this.debugNormals.generateNormals(s,t.node.getWorldTransform(),this.normalLength,e)}}this.debugNormals.update()}if(this.dirtySkeleton&&(this.dirtySkeleton=!1,this.debugSkeleton.clear(),(this.showSkeleton||this.showAxes)&&this.entities.forEach((e=>{(0===this.meshInstances.length||e.findComponent("render"))&&this.debugSkeleton.generateSkeleton(e,this.showSkeleton,this.showAxes,this.selectedNode)})),this.debugSkeleton.update()),this.sceneBounds&&this.dirtyGrid){if(this.dirtyGrid=!1,this.debugGrid.clear(),this.showGrid){const e=Math.pow(10,Math.floor(Math.log10(this.sceneBounds.halfExtents.length()))),t=new ys(0,0,0),s=new ys(0,0,0),i=0,n=10,r=n*e;for(let a=-n;a<n+1;++a){const n=a*e;t.set(-r,i,n),s.set(r,i,n),this.debugGrid.line(t,s,0===n?2147483648:2164260863),t.set(n,i,-r),s.set(n,i,r),this.debugGrid.line(t,s,0===n?2147483648:2164260863)}}this.debugGrid.update()}this.fitCameraClipPlanes(),this.shadowCatcher.onUpdate(this.dynamicSceneBounds)}}onPostrender(){this.firstFrame&&(this.firstFrame=!1,this.initSceneBounds());const e=this.camera.camera.renderTarget;!this.app.graphicsDevice.isWebGPU&&e.samples>1&&e.resolve(),this.multiframeBusy=this.multiframe.update()}onFrameend(){null!==this.loadTimestamp&&(this.observer.set("scene.loadTime",Date.now()-this.loadTimestamp+"ms"),this.loadTimestamp=null),this.multiframeBusy&&(this.app.renderNextFrame=!0)}}class iw{constructor(e){if(e.graphicsDevice.isWebGPU)return void console.log("WebGPU is already created, skipping dummy WebGPU creation");if(!navigator.gpu)return void console.log("WebGPU is not supported, skipping dummy WebGPU creation");const t=document.createElement("canvas");t.width=20,t.height=20,t.style.position="absolute",t.style.top="20px",t.style.left="20px",document.body.appendChild(t),(async()=>{const s=await navigator.gpu.requestAdapter(),i=await s.requestDevice();console.log("Created WebGPU device used for profiling");const n=t.getContext("webgpu");n.configure({device:i,format:"bgra8unorm"}),e.on("frameend",(()=>{const e=n.getCurrentTexture().createView(),t=i.createCommandEncoder(),s={colorAttachments:[{view:e,clearValue:{r:1,g:0,b:0,a:1},loadOp:"clear",storeOp:"store"}]};t.beginRenderPass(s).end(),i.queue.submit([t.finish()])}))})()}}const nw=[{label:"Abandoned Tank Farm",url:"./skybox/abandoned_tank_farm_01_2k.hdr"},{label:"Adam's Place Bridge",url:"./skybox/adams_place_bridge_2k.hdr"},{label:"Artist Workshop",url:"./skybox/artist_workshop_2k.hdr"},{label:"Ballroom",url:"./skybox/ballroom_2k.hdr"},{label:"Circus Arena",url:"./skybox/circus_arena_2k.hdr"},{label:"Colorful Studio",url:"./skybox/colorful_studio.hdr"},{label:"Golf Course Sunrise",url:"./skybox/golf_course_sunrise_2k.hdr"},{label:"Helipad",url:"./skybox/Helipad_equi.png"},{label:"Kloppenheim",url:"./skybox/kloppenheim_02_2k.hdr"},{label:"Lebombo",url:"./skybox/lebombo_2k.hdr"},{label:"Outdoor Umbrellas",url:"./skybox/outdoor_umbrellas_2k.hdr"},{label:"Paul Lobe Haus",url:"./skybox/paul_lobe_haus_2k.hdr"},{label:"Reinforced Concrete",url:"./skybox/reinforced_concrete_01_2k.hdr"},{label:"Rural Asphalt Road",url:"./skybox/rural_asphalt_road_2k.hdr"},{label:"Spruit Sunrise",url:"./skybox/spruit_sunrise_2k.hdr"},{label:"Studio Small",url:"./skybox/studio_small_03_2k.hdr"},{label:"Venice Sunset",url:"./skybox/venice_sunset_1k.hdr"},{label:"Vignaioli Night",url:"./skybox/vignaioli_night_2k.hdr"},{label:"Wooden Motel",url:"./skybox/wooden_motel_2k.hdr"}],rw={ui:{fullscreen:!1,active:null,spinner:!1,error:null},camera:{fov:40,tonemapping:"Linear",pixelScale:1,multisampleSupported:!0,multisample:!0,hq:!0},skybox:{value:"Paul Lobe Haus",options:JSON.stringify(["None"].concat(nw.map((e=>e.label))).map((e=>({v:e,t:e})))),exposure:0,rotation:0,background:"Infinite Sphere",backgroundColor:{r:.4,g:.45,b:.5},blur:1,domeProjection:{domeRadius:20,tripodOffset:.1}},light:{enabled:!1,color:{r:1,g:1,b:1},intensity:1,follow:!1,shadow:!1},shadowCatcher:{enabled:!1,intensity:.4},debug:{renderMode:"default",stats:!1,wireframe:!1,wireframeColor:{r:0,g:0,b:0},bounds:!1,skeleton:!1,axes:!1,grid:!0,normals:0},animation:{playing:!1,speed:1,transition:.1,loops:1,list:"[]",progress:0,selectedTrack:"ALL_TRACKS"},scene:{urls:[],filenames:[],nodes:"[]",selectedNode:{path:"",name:null,position:{0:0,1:0,2:0},rotation:{0:0,1:0,2:0,3:0},scale:{0:0,1:0,2:0}},meshCount:null,materialCount:null,textureCount:null,vertexCount:null,primitiveCount:null,textureVRAM:null,meshVRAM:null,bounds:null,variant:{selected:0},variants:{list:"[]"},loadTime:null},runtime:{activeDeviceType:"",viewportWidth:0,viewportHeight:0,xrSupported:!1,xrActive:!1},morphs:null,enableWebGPU:!1,centerScene:!1};console.log(`Model Viewer v${jy} | PCUI v5.1.0 (96320ad) | PlayCanvas Engine v${Mt} (${Dt})`);(()=>{const e=new i(rw),t=new URL(window.location.href);ny(),W_({glueUrl:"static/lib/basis/basis.wasm.js",wasmUrl:"static/lib/basis/basis.wasm.wasm",fallbackUrl:"static/lib/basis/basis.js",lazyInit:!0}),Qt.setConfig("DracoDecoderModule",{glueUrl:"static/lib/draco/draco.wasm.js",wasmUrl:"static/lib/draco/draco.wasm.wasm",fallbackUrl:"static/lib/draco/draco.js"});const s=new Map(nw.map((e=>[e.label,`static/${e.url}`])));e.on("ui.spinner:set",(e=>{const t=document.getElementById("spinner");e?t.classList.remove("pcui-hidden"):t.classList.add("pcui-hidden")})),t.searchParams.has("default")||(((e,t,s)=>{const i=["skybox.options","debug.renderMode"],n=(t,r)=>{-1===i.indexOf(t)&&("object"==typeof r?Object.keys(r).forEach((e=>{n(t?`${t}.${e}`:e,r[e])})):("skybox.value"!==t||"None"===r||s.has(r))&&e.set(t,r))},r=window.localStorage.getItem(`model-viewer-${t}`);if(r)try{n("",JSON.parse(r))}catch{}})(e,"uistate",s),e.on("*:set",(()=>{((e,t)=>{const s=e.json();window.localStorage.setItem(`model-viewer-${t}`,JSON.stringify({camera:s.camera,skybox:s.skybox,light:s.light,debug:s.debug,shadowCatcher:s.shadowCatcher,enableWebGPU:s.enableWebGPU}))})(e,"uistate")}))),(e=>{_y.render(u.createElement(cx,{observer:e}),document.getElementById("app"))})(e);const n=document.getElementById("application-canvas"),r=e=>new URL(e,document.baseURI).toString();(function(e,t={}){var s;const i=null!=(s=t.deviceTypes)?s:[];i.includes(Yi)||i.push(Yi),i.includes(Ji)||i.push(Ji),qt.browser&&navigator.xr&&(null!=t.xrCompatible||(t.xrCompatible=!0));const n=[];for(let s=0;s<i.length;s++){var r;const a=i[s];a===Qi&&null!=(r=window)&&null!=(r=r.navigator)&&r.gpu&&n.push((()=>new Ba(e,t).initWebGpu(t.glslangUrl,t.twgslUrl))),a===Yi&&n.push((()=>new eo(e,t))),a===Ji&&n.push((()=>new ao(e,t)))}return new Promise(((e,t)=>{let s=0;const i=()=>{s>=n.length?t(new Error("Failed to create a graphics device")):Promise.resolve(n[s++]()).then((t=>{t?e(t):i()})).catch((e=>{console.log(e),i()}))};i()}))})(n,{deviceTypes:t.searchParams.has("webgpu")||e.get("enableWebGPU")?["webgpu"]:[],glslangUrl:r("static/lib/glslang/glslang.js"),twgslUrl:r("static/lib/twgsl/twgsl.js"),antialias:!1,depth:!1,stencil:!1,xrCompatible:!0,powerPreference:"high-performance"}).then((i=>{e.set("runtime.activeDeviceType",i.deviceType);const r=new sw(n,i,e,s);window.viewer=r;const a=[],o=[];"launchQueue"in window&&window.launchQueue.setConsumer((e=>{for(const t of e.files)o.push(t.getFile().then((e=>{a.push({url:URL.createObjectURL(e),filename:e.name})})))}));for(const[s,i]of t.searchParams)switch(s){case"load":case"assetUrl":{const e=decodeURIComponent(i);a.push({url:e,filename:e});break}case"cameraPosition":{const e=i.split(",").map(Number);3===e.length&&(r.initialCameraPosition=new ys(e));break}case"cameraFocus":{const e=i.split(",").map(Number);3===e.length&&(r.initialCameraFocus=new ys(e));break}case"dummyWebGPU":new iw(r.app);break;default:if(e.has(s))switch(typeof e.get(s)){case"boolean":e.set(s,"true"===i.toLowerCase());break;case"number":e.set(s,Number(i));break;default:e.set(s,decodeURIComponent(i))}}Promise.all(o).then((()=>{a.length>0&&r.loadFiles(a)}))}))})();
//# sourceMappingURL=index.js.map
